!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/icesheet/comp_bc_ice_sheet.F90 $
!---------------------------------------------------------------------
!********************************************************************!


    subroutine comp_bc_ice_sheet

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens
      use m_ice_sheet
      use chem, only : nc, rho_w
#ifdef USG
      use usg_ice_sheet
#endif
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

implicit none

#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif


#ifdef PETSC
      PetscErrorCode :: ierrcode
#endif

      integer :: ibheat, ibvs, ivol

      real*8 :: val, val_pp

      real*8, parameter :: tiny = 1.d-5, r0=0.0d0
      character(len=32) btypezn,typebc
      logical  iserror

      external :: updtbcice, updtice_scalfac

!cprovi-----------------------------------------------------------------
!cprovi Set the original boundary conditions 
!cdsu   Set this will reset all the boundary condition to initial
!cdsu   causing transient boundary not work here. DSU, 2017-07-30.
!cprovi-----------------------------------------------------------------
      !nbvs=nbvs0
      !nbrt=nbrt0
      !iabvs=iabvs0
      !jabrt=jabrt0
      bcondrt_a=bcondrt_a0

      if (ice_sheet_type == 0) then
        if(nbvs>0) then
          call get_new_bc_(ice_sheet,iabvs,nbvs,b_iabvs_ice,xg,zg,nngl,&
                           time_io,iserror)
        end if
      else if (ice_sheet_type == 1) then
#ifdef USG
        !cdsu Ice sheet with unstructured grid should be called by all subdomains.
        !cdsu Do not put it inside nbvs condition since some subdomains may have zero boundary.

        if (update_ice_scalfac) then
          call updtice_scalfac
        end if

        if (update_bcice) then
          call updtbcice
        end if
        if(nbvs>0) then
          call usg_ice_get_new_bc(nbvs,iabvs,b_iabvs_ice)
          iserror = .false.
        end if  
#endif
      end if

      if(nbvs>0) then
        if (iserror) then
         if(rank == 0) then 
           write(*,*) 'Error when update BC for flow'     
           write(ilog,*) 'Error when update BC for flow'
           close(ilog)
         end if
#ifdef PETSC
         call petsc_mpi_finalize
#endif
         stop
        end if
      end if

      if (nbrt>0) then
        if (ice_sheet_type == 0) then
          call get_new_bc_(ice_sheet,jabrt,nbrt,b_jabrt_ice,xg,zg,nngl,&
                           time_io,iserror,bcondrt_a(1:nc,1:nbrt))
        else if (ice_sheet_type == 1) then
#ifdef USG          
          call usg_ice_get_new_bc(nbrt,jabrt,b_jabrt_ice,bcondrt_a)
          iserror = .false.
#endif
        end if
        if (iserror) then
          if (rank == 0) then  
            write(*,*) 'Error when update BC for transport'
            write(ilog,*) 'Error when update BC for transport'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
      end if
!cprovi-------------------------------------------------------------------------
!cprovi If energy balance is solved modify their boundary conditions
!cprovi-------------------------------------------------------------------------
      if (heat_transport) then
        nbheat=nbheat0
        iabheat=iabheat0        
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nbheat > numofloops_thred_comp_bc_ice_1)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibheat, ivol, iserror)
#endif

#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic)
#elif SCHEDULE_STATIC
    !$omp do schedule(static)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
#endif
        do ibheat=1,nbheat
          !c When bcondheat is used as both input and output parameters, bcondheat = bcondheat0
          !c must be moved inside the loop since bcondheat is updated here.          
          bcondheat(ibheat) = bcondheat0(ibheat)
          
          if (btypeheat(ibheat)=='first') then
            ivol = iabheat(ibheat)
            if (ivol < 0) then
              cycle  
            end if

            if (ice_sheet_type == 0) then
              call modify_for_permafrost_ (ice_sheet,bcondheat(ibheat),&
                              xg(ivol),zg(ivol),time_io,iserror)
            else if (ice_sheet_type == 1) then
#ifdef USG              
              call usg_ice_modify_permafrost_temp(ivol,bcondheat(ibheat))
              iserror = .false.
#endif
            end if
            tempnew(ivol)=bcondheat(ibheat) 

            if (iserror) then
              if (rank == 0) then         
                write(*,*) 'Error when update BC for heat transport'
                write(ilog,*) 'Error when update BC for heat transport'
                if (b_enable_output_gen) then
                  write(igen,*) 'Error when update BC for heat transport'
                end if
                close(ilog)
                close(igen)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
            end if
          end if
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  
      end if
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
!cprovi-----------------------------------------------------------------
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nbvs > numofloops_thred_comp_bc_ice_2)                  &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibvs, ivol, val, val_pp, iserror, btypezn)
#endif

#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic)
#elif SCHEDULE_STATIC
    !$omp do schedule(static)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
#endif
      do ibvs = 1,nbvs

        ivol=iabvs(ibvs)
          
        if (ivol < 0) then
          cycle
        end if

!c  assign pointer and 
        if (b_iabvs_ice(ibvs)) then
         
          btypezn=btypevs(ibvs)

          !c Assign initial values in uvsnew
          uvsnew(ivol) = bcondvs0(ibvs)

!c  first type boundary condition - constant pressure head
          if (btypevs(ibvs)=='first') then
          
            if (fluid_pressure) then
              if (ice_sheet_type == 0) then
                call compute_pw_ (ice_sheet,val,val_pp,time_io,        &
                                  xg(ivol),zg(ivol),                   &
                                  bcondvs1(ibvs),bcondvs0(ibvs),       &
                                  'head',iserror)
              else if (ice_sheet_type == 1) then
#ifdef USG                
                call usg_ice_compute_pw(ivol,rho_w,                    &
                                        bcondvs1(ibvs),bcondvs0(ibvs), &
                                        val,val_pp)
                iserror = .false.
#endif
              end if
              uvsnew(ivol) = val + val_pp
                  
            elseif (pressure_head) then
              if (ice_sheet_type == 0) then
                call compute_pw_ (ice_sheet,val,val_pp,time_io,        &
                                  xg(ivol),zg(ivol),                   &
                                  bcondvs1(ibvs),bcondvs0(ibvs),       &
                                  'head',iserror)
              else if (ice_sheet_type == 1) then
#ifdef USG
                call usg_ice_compute_pw(ivol,rho_w,                    &
                                        bcondvs1(ibvs),bcondvs0(ibvs), &
                                        val,val_pp)
                iserror = .false.
#endif
              end if
              uvsnew(ivol) = val*density(ivol)*gacc + val_pp

            elseif (fresh_head) then
              if (ice_sheet_type == 0) then
                call compute_pw_ (ice_sheet,val,val_pp,time_io,        &
                                  xg(ivol),zg(ivol),                   &
                                  bcondvs1(ibvs),bcondvs0(ibvs),       &
                                  'head',iserror)
              else if (ice_sheet_type == 1) then
#ifdef USG
                call usg_ice_compute_pw(ivol,rho_w,                    &
                                        bcondvs1(ibvs),bcondvs0(ibvs), &
                                        val,val_pp)
                iserror = .false.
#endif
              end if
              uvsnew(ivol) = val*gacc*ref_dens  + val_pp

            elseif (hydraulic_head) then

              if (ice_sheet_type == 0) then
                call compute_pw_ (ice_sheet,val,val_pp,time_io,        &
                                  xg(ivol),zg(ivol),                   &
                                  bcondvs1(ibvs),bcondvs0(ibvs),       &
                                  'pressure',iserror)
              else if (ice_sheet_type == 1) then
#ifdef USG
                call usg_ice_compute_pw(ivol,rho_w,                    &
                                        bcondvs1(ibvs),bcondvs0(ibvs), &
                                        val,val_pp,gacc)
                iserror = .false.
#endif
              end if
              uvsnew(ivol) = val + val_pp
            end if 
            bcondvs(ibvs) = uvsnew(ivol)
          end if
        else
          bcondvs1(ibvs) = uvsnew(ivol)
        end if
      end do 
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 

      return
    end subroutine 
