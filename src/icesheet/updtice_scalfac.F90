!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/icesheet/updtice_scalfac.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtice_scalfac
!c -------------------
!c
!c update scaling factor of pressure head, pore stress and boundary pore pressure 
!c due to ice sheet loading/unloading
!c
!c file format of prefix.bcisf (boundary condition due to ice sheet factors)
!c time_1 pw_grow pw_decay pice_grow pice_decay pp_grow pp_decay
!c time_2 pw_grow pw_decay pice_grow pice_decay pp_grow pp_decay
!c ...
!c time_n pw_grow pw_decay pice_grow pice_decay pp_grow pp_decay
!c
!c
!c written by:      Danyang Su - May 05, 2023
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c ----------------------------------------------------------------------
 
      subroutine updtice_scalfac
      


#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif 
      use gen
      use math_common
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

#ifdef USG
      use usg_ice_sheet
#endif

      implicit none

#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
     
      integer :: i, ierr, iflag
      logical :: b_updt_next_only, b_updtbc_back

      b_updt_next_only = .false.
      b_updtbc_back = .false.

      if ((.not. b_linear_ice_scalfac .and.                              &
          time_io >= time_ice_scalfac_prev .and.                       &
          time_io < time_ice_scalfac) .or.                             &
          time_ice_scalfac > tfinal/time_factor) then
        return
      end if

      !c check if the current timestep right after parameter update is failed
      if (.not. b_first_update_ice_scalfac .and.                       &
         (time_io < time_ice_scalfac_prev .or.                         &
          time_io > time_ice_scalfac)) then        
        b_updtbc_back = .true.
      end if
          
      !c check if the new parameters update is necessary
      if (time_io.ge.time_ice_scalfac .or.                             &
          b_restart_update_ice_scalfac .or.                            &
          b_first_update_ice_scalfac .or.                              &
          b_updtbc_recall .or. b_updtbc_back) then
          
        if(rank == 0 .and. b_enable_output)  then   
                                                                       
          write(*,*)
          write(*,*) 'update scaling factors - ice sheet loading/unloading'
          write(*,*) ('-',i=1,72)
          write(*,*)

          write(ilog,*)
          write(ilog,'(a)') 'update scaling factors - ice sheet loading/unloading'
          write(ilog,'(72a)')('-',i=1,72)
          write(ilog,*)
        
        end if

!c  assign new scaling factors due to ice sheet loading/unloading.
      
        if (b_first_update_ice_scalfac .and.                           &
            time_io.ge.time_ice_scalfac_prev .and.                     &
            time_io.le.time_ice_scalfac) then
          b_updt_next_only = b_first_update_ice_scalfac

          backspace(file_ice_scalfac)

          read(file_ice_scalfac,*,err=998,end=997)                     &
               time_ice_scalfac_prev,ice_scalfac_pre(1:6)

          do while (time_io < time_ice_scalfac_prev)
            backspace(file_ice_scalfac)
            backspace(file_ice_scalfac)
            read(file_ice_scalfac,*,err=998,end=997)                   &
                 time_ice_scalfac_prev,ice_scalfac_pre(1:6)
          end do
          
          do while (time_io > time_ice_scalfac)
            read(file_ice_scalfac,*,err=998,iostat=iflag)              &
                 time_ice_scalfac_prev,ice_scalfac_pre(1:6)
            !c end of file has reached
            if (iflag < 0) then
              time_ice_scalfac = (tfinal+delt)/time_factor
              ice_scalfac_next = ice_scalfac_pre
              exit
            else            
              if (time_io < time_ice_scalfac_prev) then
                backspace(file_ice_scalfac)
                backspace(file_ice_scalfac)
                read(file_ice_scalfac,*,err=998,end=997)               &
                     time_ice_scalfac_prev,ice_scalfac_pre(1:6)
                exit
              end if
            end if
          end do
          read(file_ice_scalfac,*,err=998,iostat=iflag)                &
               time_ice_scalfac,ice_scalfac_next(1:6)
          !c end of file has reached
          if (iflag < 0) then
            time_ice_scalfac = (tfinal+delt)/time_factor
            ice_scalfac_next = ice_scalfac_pre
          end if  

        else  
          backspace(file_ice_scalfac)
          read(file_ice_scalfac,*,err=998,end=997)                     &
               time_ice_scalfac_prev,ice_scalfac_pre(1:6)

          do while (time_io < time_ice_scalfac_prev)
            backspace(file_ice_scalfac)
            backspace(file_ice_scalfac)
            read(file_ice_scalfac,*,err=998,end=997)                   &
                 time_ice_scalfac_prev,ice_scalfac_pre(1:6)
          end do

          do while (time_io > time_ice_scalfac)
            read(file_ice_scalfac,*,err=998,iostat=iflag)              &
                 time_ice_scalfac_prev,ice_scalfac_pre(1:6)
            !c end of file has reached
            if (iflag < 0) then
              time_ice_scalfac = (tfinal+delt)/time_factor
              ice_scalfac_next = ice_scalfac_pre
              exit
            else
              if (time_io < time_ice_scalfac_prev) then
                backspace(file_ice_scalfac)
                backspace(file_ice_scalfac)
                read(file_ice_scalfac,*,err=998,end=997)               &
                     time_ice_scalfac_prev,ice_scalfac_pre(1:6)
                exit
              end if
            end if
          end do        
          
          if (b_linear_ice_scalfac) then

            read(file_ice_scalfac,*,err=998,iostat=iflag)              &
                 time_ice_scalfac,ice_scalfac_next(1:6)

            !c end of file has reached
            if (iflag < 0) then
              time_ice_scalfac = (tfinal+delt)/time_factor
              ice_scalfac_next = ice_scalfac_pre
            end if
            !c backspace, time_ice_scalfac will be read again later
            backspace(file_ice_scalfac)
          end if
        end if

#ifdef USG
        !c parameter of ice_scalfac_pre and ice_scalfac_next
        if (b_linear_ice_scalfac) then

          ice_scalfac_pw_grow = math_common_linear(                    &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(1),ice_scalfac_next(1),&
                                time_io)
          ice_scalfac_pw_decay = math_common_linear(                   &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(2),ice_scalfac_next(2),&
                                time_io)
          ice_scalfac_pice_grow = math_common_linear(                  &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(3),ice_scalfac_next(3),&
                                time_io)
          ice_scalfac_pice_decay = math_common_linear(                 &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(4),ice_scalfac_next(4),&
                                time_io)
          ice_scalfac_pp_grow = math_common_linear(                    &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(5),ice_scalfac_next(5),&
                                time_io)
          ice_scalfac_pp_decay = math_common_linear(                   &
                                time_ice_scalfac_prev,time_ice_scalfac,&
                                ice_scalfac_pre(6),ice_scalfac_next(6),&
                                time_io)
        else
          ice_scalfac_pw_grow = ice_scalfac_pre(1)
          ice_scalfac_pw_decay = ice_scalfac_pre(2) 
          ice_scalfac_pice_grow = ice_scalfac_pre(3)
          ice_scalfac_pice_decay = ice_scalfac_pre(4)
          ice_scalfac_pp_grow = ice_scalfac_pre(5)
          ice_scalfac_pp_decay = ice_scalfac_pre(6)
        end if
#endif

        b_first_update_ice_scalfac = .false.

!c  restore the reading position to previous record
        if (b_updt_next_only) then
          backspace(file_ice_scalfac)
        end if

!c  assign next read time
        if (time_ice_scalfac < tfinal/time_factor) then
          read(file_ice_scalfac,*,err=998,end=997) time_ice_scalfac
        end if

        return

!c  assign next read time greater than final solution time, if no more
!c  read times left and return
!cdsu replace 1.1*tfinal since tfinal can be negative

997     continue
        time_ice_scalfac = (tfinal+1.0d100)/time_factor
        return

998     continue
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED' 
          write(ilog,*) 'error reading file ', prefix(:l_prfx)//'.bcisf'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      else if (b_linear_ice_scalfac) then

#ifdef USG
        ice_scalfac_pw_grow = math_common_linear(                      &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(1),ice_scalfac_next(1),  &
                              time_io)
        ice_scalfac_pw_decay = math_common_linear(                     &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(2),ice_scalfac_next(2),  &
                              time_io)
        ice_scalfac_pice_grow = math_common_linear(                    &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(3),ice_scalfac_next(3),  &
                              time_io)
        ice_scalfac_pice_decay = math_common_linear(                   &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(4),ice_scalfac_next(4),  &
                              time_io)

        ice_scalfac_pp_grow = math_common_linear(                      &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(5),ice_scalfac_next(5),  &
                              time_io)
        ice_scalfac_pp_decay = math_common_linear(                     &
                              time_ice_scalfac_prev,time_ice_scalfac,  &
                              ice_scalfac_pre(6),ice_scalfac_next(6),  &
                              time_io)
#endif
      end if

      end
