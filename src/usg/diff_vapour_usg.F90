!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/diff_vapour_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

#ifdef USG

module diff_vapour_usg_mod

  implicit none

  interface diff_vapour_usg
      module procedure diff_vapour_usg1
      module procedure diff_vapour_usg2
  end interface diff_vapour_usg

  contains

  !c this function is weired, the parameter description here is not same as those actually used, DSU
  real*8 function diff_vapour_usg1(unk_ivol,unk_jvol,ndvol,ncell,      &
                       grad_mid,flux_corr,dens_ivol,dens_jvol,         &
                       por_ivol,por_jvol,                              &
                       sa_ivol,sa_jvol,cinf,cinf_cross,                &
                       coeff_ivol,coeff_jvol,heatcap,ups_fac,          &
                       isboussinesq)

    use geometry
    use mod_fluxdd_usg, only : fluxdd_usg

    implicit none

    real*8, intent(in)     :: unk_ivol
    real*8, intent(in)     :: unk_jvol
    integer, intent(in)    :: ndvol
    integer, intent(in)    :: ncell
    type(point), intent(in):: grad_mid(ndvol,ncell)          ! gradient of interfacial
    real*8, intent(in)     :: flux_corr(ndvol,ncell)         ! flux correction using high order taylor's expansion
    real*8, intent(in)     :: por_ivol
    real*8, intent(in)     :: por_jvol
    real*8, intent(in)     :: coeff_ivol
    real*8, intent(in)     :: coeff_jvol
    real*8, intent(in)     :: dens_ivol                      ! density ivol
    real*8, intent(in)     :: dens_jvol                      ! density jvol
    real*8, intent(in)     :: sa_ivol                        !
    real*8, intent(in)     :: sa_jvol
    real*8, intent(in)     :: ups_fac                        ! upstream factor
    real*8, intent(in)     :: cinf(ndvol,ncell)              ! influence coefficient
    type(point), intent(in):: cinf_cross(ndvol,ncell)        ! influence coefficient
    real*8, intent(in)     :: heatcap
    logical, intent(in)    :: isboussinesq


    real*8                 :: dunk,sa_av,coeff,por_av,coeff_av

    real*8, parameter      :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0

    dunk = unk_jvol - unk_ivol

    sa_av = rhalf*(sa_jvol+sa_ivol)
    por_av = rhalf*(por_jvol+por_ivol)
    coeff_av = rhalf*(coeff_jvol+coeff_ivol)

    if (isboussinesq) then
        coeff = por_av * sa_av
    else

      if (dunk > r0) then
        coeff = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
      else
        coeff = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
      end if

    end if
    coeff = coeff * sa_av * por_av * heatcap * coeff_av

    diff_vapour_usg1 = -fluxdd_usg(dunk,ndvol,ncell,grad_mid,          &
                                    flux_corr,cinf,cinf_cross,         &
                                    .false.,1,(/coeff/))
    return
  end function diff_vapour_usg1

  !c modification from diff_vapour_usg to apply to cell based relative permeability
  real*8 function diff_vapour_usg2(unk_ivol,unk_jvol,ndvol,ncell,      &
                       grad_mid,flux_corr,dens_ivol,dens_jvol,         &
                       por_ivol,por_jvol,                              &
                       bcellbased,nrelp,relps,cinf,cinf_cross,         &
                       coeff_ivol,coeff_jvol,heatcap,ups_fac,          &
                       isboussinesq)
  
    use geometry
    use mod_fluxdd_usg, only : fluxdd_usg

    implicit none

    real*8, intent(in)     :: unk_ivol
    real*8, intent(in)     :: unk_jvol
    integer, intent(in)    :: ndvol
    integer, intent(in)    :: ncell
    type(point), intent(in):: grad_mid(ndvol,ncell)          ! gradient of interfacial
    real*8, intent(in)     :: flux_corr(ndvol,ncell)         ! flux correction using high order taylor's expansion
    real*8, intent(in)     :: por_ivol
    real*8, intent(in)     :: por_jvol
    real*8, intent(in)     :: coeff_ivol
    real*8, intent(in)     :: coeff_jvol
    real*8, intent(in)     :: dens_ivol                      ! density ivol
    real*8, intent(in)     :: dens_jvol                      ! density jvol
    logical, intent(in)    :: bcellbased                     ! use cell based relative permeability
    integer, intent(in)    :: nrelp                          ! number of cell based relative permeability
    real*8, intent(in)     :: relps(nrelp)                   ! relative permeability
    real*8, intent(in)     :: ups_fac                        ! upstream factor
    real*8, intent(in)     :: cinf(ndvol,ncell)              ! influence coefficient
    type(point), intent(in):: cinf_cross(ndvol,ncell)        ! influence coefficient
    real*8, intent(in)     :: heatcap
    logical, intent(in)    :: isboussinesq


    real*8                 :: dunk,sa_av,coeff,por_av,coeff_av

    real*8, parameter      :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0

    dunk = unk_jvol - unk_ivol

    sa_av = r1

    por_av = rhalf*(por_jvol+por_ivol)
    coeff_av = rhalf*(coeff_jvol+coeff_ivol)

    if (isboussinesq) then
        coeff = por_av * sa_av
    else

      if (dunk > r0) then
        coeff = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
      else
        coeff = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
      end if

    end if
    coeff = coeff * sa_av * por_av * heatcap * coeff_av

    diff_vapour_usg2 = -fluxdd_usg(dunk,ndvol,ncell,grad_mid,          &
                                    flux_corr,cinf,cinf_cross,         &
                                    bcellbased,nrelp,relps(1:nrelp)*coeff)

    return
  end function diff_vapour_usg2

end module diff_vapour_usg_mod
#endif
