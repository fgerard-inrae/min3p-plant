!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/outputrt_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputrt_usg
!c -------------------
!c write contour data of reactive transport simulation to output file 
!c
!c modified for density dependent flow
!c
!c based on outputrt template
!c
!c written by:      Danyang Su- Aug. 8, 2016
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           ------- 
!c           area(nm,nn)        = specific reactive surface area of   + -
!c                                mineral (global system)
!c           cmnew(nm,nn)       = mineral concentrations              + -
!c                                - new time level [moles/l bulk]
!c           cnew(nc,nn)        = concentrations of free species      + -
!c                                - new time level [moles/l h2o]
!c           cx(nx,nn)          = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           cec_g(nn)          = cation exchange capacity (meq/100g) + -
!c                                - global system
!c           delt               = time step                           + -
!c           distcoff_rt(nc,nn) = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk]
!c                                - reactive transport
!c           elevmax            = max. elevation of solution domain   + -
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous    + +
!c                                species
!c           gnew(ng,nn)        = gas concentrations                  + -
!c                                - new time level [moles / l air]
!c           time_io            = solution time in I/O units          + -
!c           phi(nm,nn)         = volume fractions of minerals        + - 
!c           phiold(nm,nn)      = volume fractions of minerals        + - 
!c                                - old time level
!c           pornew(nn)         = porosity                            + -           
!c           ratemdp(nm,nn)     = absolute dissolution-precipitation  + -
!c                                rates of minerals
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                (new time level)
!c           sionnew(nn)        = ionic strength of solution          + -
!c                                - new time level
!c           time               = current solution time               + -
!c           tkel(nn)           = temperature [deg K]                 + -
!c           totcnew(n,nn)      = total aqueous component             + -
!c                                concentrations
!c                                - new time level [moles/l h2o]
!c           hhead(nn)          = hydraulic head                      + -
!c           xg(nn)             = spatial coordinates in x-direction  + - 
!c           yg(nn)             = spatial coordinates in y-direction  + - 
!c           zg(nn)             = spatial coordinates in z-direction  + - 
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + - 
!c           ifls               = unit number, file information       + -
!c           ilog               = unit number, logbook                + -
!c           igsa               = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_first         = unit number, molar fluxes           + -
!c                                             - contour
!c           igsa_last          = unit number, molar fluxes           + -
!c                                             - contour
!c           igsb               = unit number, sorbed species         + -
!c                                             concentrations
!c                                             - contour data
!c           igsc               = unit number, free species and       + -
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - contour data
!c           igsd               = unit number, reaction rates of      + -
!c                                             dissolution-
!c                                             precipitation 
!c                                             reactions
!c                                             - contour data
!c           igsf               = unit number, diffusion coefficients + -
!c                                             for each component
!c                                             - contour data
!c           igsf_first         = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsf_last          = unit number, diffusion coefficients + -
!c                                             - contour data
!c           igsg               = unit number, partial gas pressures  + -
!c                                             - contour data
!c           igsgr              = unit number, degassing rates        + -
!c                                             - contour data
!c           igsi               = unit number, rates of intra-aqueous + -
!c                                             kinetic reactions
!c                                             - contour data
!c           igsk               = unit number, adv & diff gradients   + -
!c                                             - contour data
!c           igsm               = unit number, master variables       + -
!c                                             - contour data
!c                                             - contour data
!c           igsr               = unit number, gas density            + -
!c           igss               = unit number, saturation indices     + -
!c                                             - contour data
!c           igst               = unit number, total aqueous          + -
!c                                             component
!c                                             concentrations
!c                                             - contour data
!c           igsre              = unit number, total concentration    + -
!c                                             of radioelement
!c                                             - contour data
!c           igstime            = pointer to next output time for     + -
!c                                contour data
!c           igsv               = unit number, mineral volume         + -
!c                                             fractions
!c                                             - contour data
!c           igsx               = unit number, saturation indices     + -
!c                                             excluded minerals
!c                                             - contour data
!c             igsy               = unit number, gas viscosity          + -
!c                                                - contour data 
!c             igsw               = unit number, water prod/consumption + -
!c                                                - contour data 
!c           igsac              = unit number, activity coefficient   + -
!c                                              - countour data
!c           icnv               = unit number, data conversion        + -
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_time_unit        = lebgth of time_unit for output      + -
!c           mtime              = current time step                   + -
!c           nn                 = total number of control volumes     + -
!c
!c           logical:
!c           --------
!c           extended_output_gs = .true.  -> extended output of       + -
!c                                           contour data for
!c                                           reaction-transport
!c                                           simulation
!c                                .false. -> basic output of
!c                                           contour data for
!c                                           for reaction-transport
!c                                           simulation
!c           initial_condition  = .true.  -> output of initial        + -
!c                                           condition for contour
!c                                           data
!c                                .false. -> output of contour data
!c                                           for steady state or
!c                                           transient solutions
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           update_porosity    = .true.  -> update porosity as       + -
!c                                           a result of dissolution-
!c                                           precipitation reactions
!c           logical:
!c           --------
!c           cum_molfrac        = .true.--> .gs2 results in terms of  + -
!c                                          cummulative molar fractions
!c           logical:
!c           --------
!c           cum_molfrac        = .true.--> .gs2 results in terms of  + -
!c                                          cummulative molar fractions
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = output time unit: -> 'years'        + -
!c                                                     'days'  
!c
!c chem.f:   real*8:    
!c           -------
!c           alkfacc(nc)        = alkalinity factors for components   + -
!c                                as species in solution
!c           alkfacx(nx)        = alkalinity factors for aqueous      + -
!c                                complexes
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of      + -
!c                                organic mixture
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)
!c                              = concentrations of sorbed species    * *
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level (surface-complex)
!c           densm(nm)          = densities of minerals               + -
!c           ehfac              = factor for calculating Eh from pe   + -
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  + -
!c                                minerals
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           gfwm(nm)           = gram formula weight of minerals     + -
!c           phimin(nm)         = volume fractions of minerals for    + -
!c                                nucleation
!c           phimin_out(nm)     = cutoff mineral volume fractions     + -
!c                                for output
!c           phi_out(nm)        = mineral volume fractions for output * *
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           rateg(ng,nthreads) = degassing rates                     * *
!c           ratemp(ndr*nm,nthreads)
!c                              = reaction rates for minerals         * *
!c                                including parallel reactions
!c           rateor(nr,nthreads)= oxidation-reduction rates for       * *
!c                                redox couples [moles/(l h2o*day)
!c           satm(nm,nthreads)  = IAP/K                               + -
!c           satm_log(nm)       = saturation indices                  + -
!c           satmx(nmx)         = saturation indices for excluded     + -
!c                                minerals
!c           tconv              = temperature correction factor       + -
!c           totan(nc,nthreads) = total sorbed component              + -
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c           xnumx(nmx*nc)      = stoichiometric coefficients of      + -
!c                                components in excluded mineral
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c
!c           integer*4:
!c           ---------- 
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamd(nm+1)         = pointer array to dissolution-       + -
!c                                precipitation reactions
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           iamx(nmx+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in excluded mineral
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in excluded mineral
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           l_nameanc(nc)      = length of names of sorbed           + -
!c                                components (non-competitive
!c                                sorption
!c           l_nameaq(naq)      = length of names of intra-aqueous    + -
!c                                kinetic reactions
!c           l_namec(nc)        = length of component names           + -
!c           l_nameg(ng)        = length of names of gases            + -
!c           l_namem(nm)        = length of mineral names             + -
!c           l_namemp(ndr*nm)   = length of names of parallel         + -
!c                                dissolution-precipitation reactions
!c           l_namemx(nmx)      = length of names of excluded         + -
!c                                minerals
!c           l_namer(nr)        = length of names of redox couples    + -
!c           l_namex(nx)        = length of names of secondary        + -
!c                                aqueous species
!c           nanc               = number of sorbed species            + -
!c                                non-com[petitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components                + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           ph_output          = .true.  -> output of pH             + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           temp_field         = .true.  -> nodal temperatures       + -
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namemp(ndr*nm)     = names for parallel                  + -
!c                                dissolution-precipitation reactions
!c           namemx(nmx)        = names of excluded minerals          + -
!c           namer(nr)          = names of redox couples              + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           output_unit_sb     = output unit for surface species     + -
!c           output_unit_sb_ion = output unit for sorption            + -
!c                                reactions of ion-exchange
!c           output_unit_sb_surf= output unit for sorption            + -
!c                                reactions of surface-complex
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c
!c dens.f:   logical:
!c           --------
!c          density_dependence = .true.  -> density-dependent flow   + -
!c
!c local:    real*8:
!c           -------
!c           alk_carb           = carbonate alkalinity [eq/L]
!c           alk_noncarb        = noncarbonate alkalinity [eq/L]
!c           alk_tot            = total alkalinity [eq/L]
!c           alk_carb_mg        = carbonate alkalinity [mg/L CaCO3]
!c           alk_noncarb_mg     = non-carbonate alkalinity
!c                                [mg/L CaCO3]
!c           alk_tot_mg         = total alkalinity [mg/L CaCO3]
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           eh                 = Eh of solution
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           pe                 = pe of solution
!c           ph                 = pH of solution
!c           por_out            = porosity for output
!c           pres_tot           = total gas pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           pg(ng)             = gas pressure
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive
!c                                         sorption reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           ireac              = counter
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           istart             = pointer
!c           istop              = pointer
!c           inode               = counter (control volumes)
!c           ix                 = counter (secondary aqueous species)
!c           l_sufx             = length of file suffix
!c           nxout              = number of secondary species for 
!c                                output
!c
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: alkcalc   = compute alkalinity
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions 
!c           molconc   = compute average molar concentration for
!c                       organic mixture
!c           modrate   = modify reaction rate
!c           phpe      = compute pH, pe and Eh
!c           rategas   = compute degassing rates
!c           rategasd  = compute degassing rates for density
!c                       dependent flow
!c           rateint   = compute rate for intra-aqueous kinetic
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic
!c                       reactions (new database format)
!c           ratemin   = compute absolute dissolution-precipitation
!c                       rates of minerals
!c           ratemin_new  = compute absolute dissolution-precipitation
!c                       rates of minerals (new database format)
!c           rateredx  = compute oxidation/reduction rates for
!c                       redox couples
!c           satindex  = compute saturation index
!c           sorbspc   = compute concentrations of sorbed species
!c           tcorr     = temperature correction for debye-huckel,
!c                       equilibrium and rate constants
!c           totcona   = compute total sorbed component
!c                       concentrations (non-competitive
!c                       sorption reactions)
!c           totconc   = compute total aqueous component
!c                       concentrations based on concentrations
!c                       of free species and secondary aqueous
!c                       species
!c           updtsvap  = update secondary variables in aqueous phase
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c
!c           velocityg = write 
!c ----------------------------------------------------------------------
#ifdef USG
      subroutine outputrt_usg

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
      use chem
      use dens
      use phys
      use writeversion
      use nobleGasIngrowth, only : b_use_ngi, ngre_i, conc_ngre,       &
                                   name_ngre_i
      use dgml, only : dgm, maxwell
      use file_unit, only : lun_get, lun_free
      use usg_mesh_data
      use biol, only : rld

#ifdef OPENMP
      use omp_lib 
#endif 

#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer :: ixmf
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif
      
      real*8 :: alk_carb, alk_noncarb, alk_tot, alk_tot_mg,            &
                alk_carb_mg, alk_noncarb_mg, zout, zoutput, zbal,      &
                zpos, zneg, ph, pe, eh, pres_tot, satindex, conc_mol,  &
                frac_mol, gammatemp, tottemp, convk, rootdens
      
      integer :: i, ianc, iaq, ic, ig, im, imx, iout_high, ir, ireac,  &
                 istart, istop, isites, isb, inode, ix, jg, l_sufx,    &
                 ingre, nxout, nvarsgsc, nvarsgsm, nvarsgsi, nvarsgsb, &
                 nvarsgsd, nvarsgsv, nvarsgsis, nvarsgsac, ierrcode
      
      integer :: i1, i2, i3, ic1, ic2, ii, icount, icur, imi, nmi,     &
                 istart2, istop2, izn_c, next 
      
      integer :: tid 
      
      real*8 :: dummy

      external alkcalc,comptotc,phpe,rateredx,satindex,sorbspc,        &
               totcona,totconc,zoutput,checkerr,                       &
               molconc,rategas,rategasd,rateint,rateint_new,           &
               ratemin,ratemin_new,tcorr,updtsvap,modrate

      real*8 :: pressure_melt_k
      external :: pressure_melt_k               

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r100 = 100.0d0

      character*3 :: suffix
      character*72, allocatable :: nametemp(:)
      integer (type_i4), allocatable :: l_nametemp(:)
      real*8, allocatable :: valuetemp(:)
      real*8, allocatable :: ph_vols(:), pe_vols(:), eh_vols(:),       &
                             alk_carb_vols(:), alk_noncarb_vols(:),    &
                             alk_tot_vols(:),alk_carb_mg_vols(:),      &
                             alk_noncarb_mg_vols(:),                   &
                             alk_tot_mg_vols(:),zbal_vols(:),          &
                             rateor_vols(:,:),rateaq_vols(:,:),        &
                             pres_tot_vols(:),pg_vols(:,:),            &
                             rateg_vols(:,:),totan_vols(:,:),          &
                             csb_ion_vols(:,:),csb_surf_vols(:,:),     &
                             satm_log_vols(:,:),phi_out_vols(:,:),     &
                             satmx_vols(:,:),valuetemp_vols(:,:),      &
                             totcflux_vols(:,:)
      
      real*8 :: pg(ng)
      real*8 :: totcsb_ion(nc-1), totcsb_surf(nc-1)
      character*2048 strbuffer
      character*72, allocatable :: tec_variables(:)
      character*256 :: strfilename, strfilename_result, strfilename_mesh

      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif


      nxout = 0
     
      if (iso_output) then
        allocate (nametemp(nip*8), stat = ierrcode)
        nametemp = ""
        call checkerr(ierrcode,'nametemp',ilog)
        call memory_monitor(sizeof(nametemp),'nametemp',.true.)
        
        allocate (l_nametemp(nip*8), stat = ierrcode)
        l_nametemp = 0
        call checkerr(ierrcode,'l_nametemp',ilog)
        call memory_monitor(sizeof(l_nametemp),'l_nametemp',.true.)
        
        allocate (valuetemp(nip*8), stat = ierrcode)
        valuetemp = 0.0d0
        call checkerr(ierrcode,'valuetemp',ilog)
        call memory_monitor(sizeof(valuetemp),'valuetemp',.true.)

        allocate (valuetemp_vols(nip*8,num_nodes), stat = ierrcode)
        valuetemp = 0.0d0
        call checkerr(ierrcode,'valuetemp',ilog)
        call memory_monitor(sizeof(valuetemp_vols),'valuetemp_vols',.true.)
      end if

!c     write(*,'(/a)') 'enter routine outputrt ...'

!c  assign file suffix for initial condition or current time step 
!c  works for up to 999 output times

!c high output precision option for inverse modeling
!c iout_high = 0 -> standard es15.7 output for *.gst files
!c iout_high = 1 -> e23.15 output for *.gst file component concentrations

      iout_high = 0 ! August 24, 2005 setting
       
      alk_carb=r0
      alk_noncarb=r0
      alk_tot=r0
      alk_tot_mg=r0
      alk_carb_mg=r0
      alk_noncarb_mg=r0
        
      !rewind(icnv)           !Deprecated, use internal convert instead. DSU
      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then
          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i1)') igstime
          l_sufx = 1
        elseif (igstime.ge.10.and.igstime.lt.100) then
          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          l_sufx = 2
        elseif (igstime.ge.100.and.igstime.lt.1000) then
          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          l_sufx = 3
        elseif (igstime.ge.1000) then
          if (rank == 0) then  
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputrt'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
      end if

      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))
      end if

!c  ---------------------------------------------------------------------  
!c  open files - water phase
!c  ---------------------------------------------------------------------  
      if (.not. b_output_binary) then
        if (combined_gst_gsb_output) then
          open(igst,file=prefix(:l_prfx)//'_'//                        &
               suffix(:l_sufx)//trim(adjustl(str_rank))//'.gstgsb.vtk',&
               status='unknown',form='formatted')
        else
          open(igst,file=prefix(:l_prfx)//'_'//                        &
               suffix(:l_sufx)//trim(adjustl(str_rank))//'.gst.vtk',   &
               status='unknown',form='formatted')
        end if
      end if

! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
      if (multi_diff) then
        if (.not. b_output_binary) then
          open(icbt,file=prefix(:l_prfx)//'_'//                        &
               suffix(:l_sufx)//trim(adjustl(str_rank))//'.cbt.vtk',   &
               status='unknown',form='formatted')
        end if
      end if

      if(flux_out)then
        if (.not. b_output_binary) then
          open(igmf,file=prefix(:l_prfx)//'_'//                        &
               suffix(:l_sufx)//trim(adjustl(str_rank))//'.gmf.vtk',   &
               status='unknown',form='formatted')
        end if
      end if

!cdsu ----------------------------------------------------------------
!cdsu concentration of radioelement related to noble gas ingrowth
!cdsu ----------------------------------------------------------------
      if (b_use_ngi .and. ngre_i > 0) then
        open(igsre,file=prefix(:l_prfx)//'_'//                        &
             suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsre.vtk',   &
             status='unknown',form='formatted')
      end if

! prc ----------------------------------------------------------------

      if (rank == 0 .and. b_enable_output) then
          
        if (initial_condition) then                                      
          write(ifls,'(/3a/72a)')'Total aqueous component ',           &
                                 'concentrations, initial ',           &
                                 'condition',('-',i=1,72)
        else                                                            
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Total aqueous component concentrations, T = ',        &
                time_io,time_unit(:l_time_unit),('-',i=1,72)
        end if
                   
        if (combined_gst_gsb_output) then
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gstgsb.vtk'
        else
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gst.vtk'
        end if
        
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'
        do ic = 1,nc-1
          if (ic.lt.7) then
            write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),'moles/l h2o'
          else
            write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),'moles/l h2o'
          end if
        end do
      
      end if

      if (extended_output_gs) then

        if (flux_out)then
          call velocity_a_usg
        endif

!c  species concentrations

        nxout = min(100-nc-1,nx)       !max. 100 species for output
        nvarsgsc = nc+nxout+2
        
        if (.not. b_output_binary) then
          open(igsc,file=prefix(:l_prfx)//'_'//                        &
               suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsc.vtk',   &
               status='unknown',form='formatted')
        end if
        
        if (rank == 0 .and. b_enable_output) then
                                                                       
          if (initial_condition) then                                    
            write(ifls,'(/2a,/72a)')'Species concentrations, initial ',&
                                    'condition',('-',i=1,72)
          else                                                          
            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
                  'Species concentrations, T = ',                      &
                  time_io,time_unit(:l_time_unit),('-',i=1,72)
          end if
                                                                        
          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                              suffix(:l_sufx)//'.gsc.vtk'
                                                                        
          write(ifls,'(2a)')                                           &
                'column   entry                           ','unit'
          write(ifls,'(2a)')                                           &
                '1        x                               ','m'
          write(ifls,'(2a)')                                           &
                '2        y                               ','m'
          write(ifls,'(2a)')                                           &
                '3        z                               ','m'
          do ic = 1,nc-1
            if (ic.lt.7) then
              write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),           &
                                             'moles/l h2o'
            else
              write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),           &
                                             'moles/l h2o'
            end if
          end do
          do ix = 1,nx
            if (ix+nc-1.lt.7) then
              write(ifls,'(i1,8x,a30,2x,a)') ix+nc+2,namex(ix),        &
                                            'moles/l h2o'
            elseif (ix+nc-1.ge.7.and.ix+nc-1.lt.97) then               
              write(ifls,'(i2,7x,a30,2x,a)') ix+nc+2,namex(ix),        &
                                            'moles/l h2o'
            else                                                       
              write(ifls,'(i3,6x,a30,2x,a)') ix+nc+2,namex(ix),        &
                                            'moles/l h2o'
            end if
          end do
        
        end if
        
!c  activity coefficients
        if (b_output_activity) then
          nvarsgsac = nc+nxout+2
        
          if (.not. b_output_binary) then
            open(igsac,file=prefix(:l_prfx)//'_'//                     &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsac.vtk',&
                 status='unknown',form='formatted')
          end if
          
          if (rank == 0 .and. b_enable_output) then
                                                                         
            if (initial_condition) then                                    
              write(ifls,'(/2a,/72a)')'Species activity coefficients, ',&
                                      'initial condition',('-',i=1,72)
            else                                                          
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Species activity coefficients, T = ',             &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsac.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do ic = 1,nc-1
              if (ic.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+3,namec(ic),         &
                                               '-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+3,namec(ic),         &
                                               '-'
              end if
            end do
            do ix = 1,nx
              if (ix+nc-1.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'
              elseif (ix+nc-1.ge.7.and.ix+nc-1.lt.97) then             
                write(ifls,'(i2,7x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'
              else                                                     
                write(ifls,'(i3,6x,a30,2x,a)') ix+nc+2,namex(ix),      &
                                              '-'
              end if
            end do
          
          end if
        end if    !c activity coefficients

!c  master variables
        if (ph_output .or. pe_output) then
          if (.not. b_output_binary) then
            open(igsm,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsm.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(ph_vols(num_nodes), stat = ierrcode)
          ph_vols = 0.0d0
          call checkerr(ierrcode,'ph_vols',ilog)
          call memory_monitor(sizeof(ph_vols),'ph_vols',.true.)

          allocate(pe_vols(num_nodes), stat = ierrcode)
          pe_vols = 0.0d0
          call checkerr(ierrcode,'pe_vols',ilog)
          call memory_monitor(sizeof(pe_vols),'pe_vols',.true.)

          allocate(eh_vols(num_nodes), stat = ierrcode)
          eh_vols = 0.0d0
          call checkerr(ierrcode,'eh_vols',ilog)
          call memory_monitor(sizeof(eh_vols),'eh_vols',.true.)

          allocate(alk_carb_vols(num_nodes), stat = ierrcode)
          alk_carb_vols = 0.0d0
          call checkerr(ierrcode,'alk_carb_vols',ilog)
          call memory_monitor(sizeof(alk_carb_vols),'alk_carb_vols',.true.)

          allocate(alk_noncarb_vols(num_nodes), stat = ierrcode)
          alk_noncarb_vols = 0.0d0
          call checkerr(ierrcode,'alk_noncarb_vols',ilog)
          call memory_monitor(sizeof(alk_noncarb_vols),'alk_noncarb_vols',.true.)

          allocate(alk_tot_vols(num_nodes), stat = ierrcode)
          alk_tot_vols = 0.0d0
          call checkerr(ierrcode,'alk_tot_vols',ilog)
          call memory_monitor(sizeof(alk_tot_vols),'alk_tot_vols',.true.)

          allocate(alk_carb_mg_vols(num_nodes), stat = ierrcode)
          alk_carb_mg_vols = 0.0d0
          call checkerr(ierrcode,'alk_carb_mg_vols',ilog)
          call memory_monitor(sizeof(alk_carb_mg_vols),'alk_carb_mg_vols',.true.)

          allocate(alk_noncarb_mg_vols(num_nodes), stat = ierrcode)
          alk_noncarb_mg_vols = 0.0d0
          call checkerr(ierrcode,'alk_noncarb_mg_vols',ilog)
          call memory_monitor(sizeof(alk_noncarb_mg_vols),'alk_noncarb_mg_vols',.true.)

          allocate(alk_tot_mg_vols(num_nodes), stat = ierrcode)
          alk_tot_mg_vols = 0.0d0
          call checkerr(ierrcode,'alk_tot_mg_vols',ilog)
          call memory_monitor(sizeof(alk_tot_mg_vols),'alk_tot_mg_vols',.true.)

          allocate(zbal_vols(num_nodes), stat = ierrcode)
          zbal_vols = 0.0d0
          call checkerr(ierrcode,'zbal_vols',ilog)
          call memory_monitor(sizeof(zbal_vols),'zbal_vols',.true.)
        
          if (rank == 0 .and. b_enable_output) then

            if (initial_condition) then
              write(ifls,'(/2a/72a)')'Master variables, initial ',     &
                                     'condition',('-',i=1,72)
            else
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Master variables, T = ',                          &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsm.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'

            if ((ph_output).and.(pe_output)) then
              write(ifls,'(a,30x,a)')  '4        pH','-'
              write(ifls,'(a,30x,a)')  '5        pe','-'
              write(ifls,'(a,30x,a)')  '6        Eh','mV'
              write(ifls,'(a,18x,a)')  '7        ionic strength','-'
              write(ifls,'(a,12x,a)')  '8        carbonate alkalinity',    &
                                       'eq/L'
              write(ifls,'(a,8x,a)')   '9        non-carbonate alkalinity',&
                                       'eq/L'
              write(ifls,'(a,22x,a)')  '10       alkalinity','eq/L'
              write(ifls,'(a,12x,a)')  '11       carbonate alkalinity',    &
                                       'mg/L CaCO3'
              write(ifls,'(a,8x,a)')   '12       non-carbonate alkalinity',&
                                       'mg/L CaCO3'
              write(ifls,'(a,22x,a)')  '13       alkalinity','mg/L CaCO3'
              write(ifls,'(a,21x,a)')  '14       temperature','C'
            elseif ((.not.ph_output).and.(pe_output)) then
              write(ifls,'(a,30x,a)')  '4        pe','-'
              write(ifls,'(a,30x,a)')  '5        Eh','mV'
              write(ifls,'(a,18x,a)')  '6        ionic strength','-'
              write(ifls,'(a,12x,a)')  '7        carbonate alkalinity',    &
                                       'eq/L'
              write(ifls,'(a,8x,a)')   '8        non-carbonate alkalinity',&
                                       'eq/L'
              write(ifls,'(a,22x,a)')  '9        alkalinity','eq/L'
              write(ifls,'(a,12x,a)')  '10       carbonate alkalinity',    &
                                       'mg/L CaCO3'
              write(ifls,'(a,8x,a)')   '11       non-carbonate alkalinity',&
                                       'mg/L CaCO3'
              write(ifls,'(a,22x,a)')  '12       alkalinity','mg/L CaCO3'
              write(ifls,'(a,21x,a)')  '13       temperature','C'
            elseif ((ph_output).and.(.not.pe_output)) then
              write(ifls,'(a,30x,a)')  '4        pH','-'
              write(ifls,'(a,18x,a)')  '5        ionic strength','-'
              write(ifls,'(a,12x,a)')  '6        carbonate alkalinity',    &
                                       'eq/L'
              write(ifls,'(a,8x,a)')   '7        non-carbonate alkalinity',&
                                       'eq/L'
              write(ifls,'(a,22x,a)')  '8        alkalinity','eq/L'
              write(ifls,'(a,12x,a)')  '9        carbonate alkalinity',    &
                                       'mg/L CaCO3'
              write(ifls,'(a,8x,a)')   '10       non-carbonate alkalinity',&
                                       'mg/L CaCO3'
              write(ifls,'(a,22x,a)')  '11       alkalinity','mg/L CaCO3'
              write(ifls,'(a,21x,a)')  '12       temperature','C'
            end if

          end if
          
        end if

!c  oxidation-reduction rates

        if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)              &
                     .and.(.not.initial_condition)) then
          if (.not. b_output_binary) then
            open(igsi,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsr.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(rateor_vols(nr,num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'rateor_vols',ilog)
          call memory_monitor(sizeof(rateor_vols),'rateor_vols',.true.)
        
          if (rank == 0 .and. b_enable_output) then

            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
                  'Oxidation-reduction rates, T = ',                   &
                  time_io,time_unit(:l_time_unit),('-',i=1,72)

            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsr.vtk'

            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do ir = 1,nr
              if (ir.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') ir+3,namer(ir),         &
                                             'moles/l h2o/day'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ir+3,namer(ir),         &
                                             'moles/l h2o/day'
              end if
            end do

          end if

        end if                         !((naq.eq.0.and.nr.gt.0).....)

!c  rates of intra-aqueous kinetic reactions

        if (naq.gt.0.and.(.not.initial_condition)) then
          if (.not. b_output_binary) then
            open(igsi,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsi.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(rateaq_vols(naq,num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'rateaq_vols',ilog)
          call memory_monitor(sizeof(rateaq_vols),'rateaq_vols',.true.)
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
                  'rates of intra-aqueous kinetic reactions, T = ',    &
                  time_io,time_unit(:l_time_unit),('-',i=1,72)
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsi.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do iaq = 1,naq                                              
              if (iaq.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') iaq+3,nameaq(iaq),      &
                                             'moles/l h2o/day'
              else                                                      
                write(ifls,'(i2,7x,a30,2x,a)') iaq+3,nameaq(iaq),      &
                                             'moles/l h2o/day'
              end if
            end do
          
          end if

        end if                         !(naq.gt.0.and......)

!c  ---------------------------------------------------------------------  
!c  open files - gas phase
!c  ---------------------------------------------------------------------  

!c  partial gas pressures

        if (ng.gt.0) then
          if (.not. b_output_binary) then
            open(igsg,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsg.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(pres_tot_vols(num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'pres_tot_vols',ilog)
          call memory_monitor(sizeof(pres_tot_vols),'pres_tot_vols',.true.)
          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Partial gas pressures, initial ',&
                                     'condition',('-',i=1,72)
            else                                                        
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                   &
                    'Partial gas pressures, ','T = ',                  &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsg.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do ig = 1,ng                                                
              if (ig.lt.7) then                                         
                write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),'atm'      
              else                                                      
                write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),'atm'      
              end if                                                    
            end do                                                      
            write(ifls,'(2a)')                                         &
                 '3+ng+1   total gas pressure              ','atm'
            
          end if

!c gas velocities, advection
          if (gas_advection .or. dgm .or. maxwell) then
            if (.not. b_output_binary) then
              open(igs2,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//   &
                   trim(adjustl(str_rank))//'.gs2.vtk',                &
                   status='unknown',form='formatted')
            end if

            allocate(rateg_vols(ng,num_nodes), stat = ierrcode)
            call checkerr(ierrcode,'rateg_vols',ilog)
            call memory_monitor(sizeof(rateg_vols),'rateg_vols',.true.)
            
            if (rank == 0 .and. b_enable_output) then
            
              if (initial_condition) then
                  write(ifls,'(/2a/72a)')'Mole fractions, initial ',   &
                                         'condition',('-',i=1,72)
              else
                  write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')               &
                        'Mole fractions, ','T = ',                     &
                        time_io,time_unit(:l_time_unit),('-',i=1,72)
              end if
              
              write(ifls,'(/a/)') prefix(:l_prfx)//'_'//               &
                    suffix(:l_sufx)//'.gs2.vtk'
              
              write(ifls,'(2a)')                                       &
                    'column   entry                           ','unit'
              write(ifls,'(2a)')                                       &
                    '1        x                               ','m'
              write(ifls,'(2a)')                                       &
                    '2        y                               ','m'
              write(ifls,'(2a)')                                       &
                    '3        z                               ','m'
              do ig = 1,ng
                if (ig.lt.7) then
                  write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),'[-]'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),'[-]'
                end if
              end do
            
            end if
            
            if (.not.initial_condition) then
              call velocity_g_usg
            end if
           
          end if
!c  degassing rates

          if (gas_removal) then
            if (.not. b_output_binary) then
              open(igsgr,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//  &
                   trim(adjustl(str_rank))//'.gsgr.vtk',               &
                   status='unknown',form='formatted')
            end if

            allocate(rateg_vols(ng,num_nodes), stat = ierrcode)
            call checkerr(ierrcode,'rateg_vols',ilog)
            call memory_monitor(sizeof(rateg_vols),'rateg_vols',.true.)
            
            if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                
              write(ifls,'(/2a/72a)')'Degassing rates, initial ',     &
                                     'condition',('-',i=1,72)
            else                                                       
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                  &
                    'Degassing rates, ','T = ',                       &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                       
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                &
                                suffix(:l_sufx)//'.gsgr.vtk'
                                                                       
            write(ifls,'(2a)')                                        &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                        &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                        &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                        &
                  '3        z                               ','m'
            do ig = 1,ng                                               
              if (ig.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') ig+3,nameg(ig),        &
                                              'mol L^-1 d^-1'
              else                                                     
                write(ifls,'(i2,7x,a30,2x,a)') ig+3,nameg(ig),        &
                                              'mol L^-1 d^-1'
              end if
            end do
            
            end if

          end if                       !(gas_removal)   

        end if                         !(ng.gt.0)

!c  ---------------------------------------------------------------------  
!c  open files - solid phase
!c  ---------------------------------------------------------------------  

!c  concentration of sorbed species

        if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.       &
            nsb_surf.gt.0.or.noncompetitive_sorption)) then
          if (.not. b_output_binary) then
            open(igsb,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsb.vtk', &
                 status='unknown',form='formatted')
          end if
          
          if (nanc > 0) then
            allocate(totan_vols(nanc,num_nodes), stat = ierrcode)
            call checkerr(ierrcode,'outputrt_usg-totan_vols',ilog)
            call memory_monitor(sizeof(totan_vols),'totan_vols',.true.)

          end if
          if (nsb_ion > 0) then
            allocate(csb_ion_vols(nsb_ion,num_nodes), stat = ierrcode)
            call checkerr(ierrcode,'outputrt_usg-csb_ion_vols',ilog)
            call memory_monitor(sizeof(csb_ion_vols),'csb_ion_vols',.true.)

          end if
          if (nsb_surf > 0) then
            allocate(csb_surf_vols(nsb_surf,num_nodes), stat = ierrcode)
            call checkerr(ierrcode,'outputrt_usg-csb_surf_vols',ilog)
            call memory_monitor(sizeof(csb_surf_vols),'csb_surf_vols',.true.)

          end if


          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Sorbed species concentrations, ',&
                                     'initial condition',('-',i=1,72)
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Sorbed species concentrations, T = ',             &
                     time_io,time_unit(:l_time_unit),                  &
                    ('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsb.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
          
          end if

!c  non-competitive sorption

          if (rank == 0 .and. b_enable_output) then

            if (noncompetitive_sorption) then
              ianc = 0
              do ic =1,nc
                if (isotherm_type(ic).ne.'none') then
                  ianc = ianc+1
                    if (ianc.lt.7) then
                      write(ifls,'(i1,8x,a30,2x,a)') ianc+3,namec(ic), &
                                                    'moles/l bulk'
                    else                                                
                      write(ifls,'(i2,7x,a30,2x,a)') ianc+3,namec(ic), &
                                                    'moles/l bulk'
                    end if
                  end if
              end do
            end if
          
          end if

!c  competitive sorption

          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
              
            if (rank == 0 .and. b_enable_output) then  

!cprovi------------------------------------------------------------           
!cprovi------------------------------------------------------------           
!cprovi------------------------------------------------------------           

!c  primary surface species

              do isites = 1,nsites
                ic = iaic(isites)
                if (isites+nanc.lt.7) then
                  write(ifls,'(i1,8x,a30,2x,a)')isites+nanc+3,namec(ic),&
                                                output_unit_sb_surf
                else
                  write(ifls,'(i2,7x,a30,2x,a)')isites+nanc+3,namec(ic),&
                                                output_unit_sb_surf
                end if
              end do

!c  secondary surface species

              do isb = 1,nsb_ion
                if (isb+nanc+nsites.lt.7) then
                  write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+3,     &
                                                namesb_ion(isb),        &
                                                output_unit_sb_ion
                else
                  write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+3,     &
                                                namesb_ion(isb),        &
                                                output_unit_sb_ion
                end if
              end do
            
              do isb = 1,nsb_surf
                if (isb+nanc+nsites.lt.7) then
                  write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+3,     &
                                                namesb_surf(isb),       &
                                                output_unit_sb_surf
                else
                  write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+3,     &
                                                namesb_surf(isb),       &
                                                output_unit_sb_surf
                end if
              end do
         
            end if          !nsb.gt.0
            
          end if  

        end if            !nsb.gt.0.or.noncompetitive_sorption

!c  mineral parameters

        if (nm.gt.0) then

!c  saturation indices for minerals
          if (.not. b_output_binary) then
            open(igss,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gss.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(satm_log_vols(nm,num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'outputrt_usg-satm_log_vols',ilog)
          call memory_monitor(sizeof(satm_log_vols),'satm_log_vols',.true.)

          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Mineral saturation indices, ',   &
                                     'initial condition',('-',i=1,72)
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Mineral saturation indices, T = ',                &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gss.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do im = 1,nm
              if (im.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') im+3,namem(im),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+3,namem(im),'-'
              end if
            end do
          
          end if

!c  reaction rates of minerals
          if (.not. b_output_binary) then
            open(igsd,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsd.vtk', &
                 status='unknown',form='formatted')
          end if

          if (rank == 0 .and. b_enable_output) then
                                                                        
            if (initial_condition) then                                   
              write(ifls,'(/2a/72a)')'Dissolution-precipitation rates, ',&
                                     'initial condition',('-',i=1,72)
            else                                                          
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                      &
                    'Dissolution-precipitation rates, T = ',             &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                          
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                                suffix(:l_sufx)//'.gsd.vtk'
                                                                          
            write(ifls,'(2a)')                                           &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                           &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                           &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                           &
                  '3        z                               ','m'
            istart = iamd(1)                                              
            istop = iamd(nm+1)-1                                          
            do ireac = istart,istop                                       
              if (ireac.lt.7) then                                        
                write(ifls,'(i1,8x,a30,2x,a)') ireac+3,namemp(ireac),   &
                                              'moles/l bulk/day'
              else                                                        
                write(ifls,'(i2,7x,a30,2x,a)') ireac+3,namemp(ireac),   &
                                              'moles/l bulk/day'
              end if
            end do
          
          end if

!c  mineral volume fractions
          if (.not. b_output_binary) then
            open(igsv,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsv.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(phi_out_vols(nm,num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'outputrt_usg-phi_out_vols',ilog)
          call memory_monitor(sizeof(phi_out_vols),'phi_out_vols',.true.)

          
          if (rank == 0 .and. b_enable_output) then
                                                                        
            if (initial_condition) then                                   
              write(ifls,'(/2a/72a)')'Mineral volume fractions, ',     &
                                     'initial condition ',('-',i=1,72)
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Mineral volume fractions, T = ',                  &
                    time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsv.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do im = 1,nm
              if (im.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') im+3,namem(im),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+3,namem(im),'-'
              end if
            end do
            if (nm.lt.6) then
              write(ifls,'(i1,8x,a,24x,a)') nm+4,'porosity','-'
            else
              write(ifls,'(i2,7x,a,24x,a)') nm+4,'porosity','-'
            end if
          
          end if

        end if                         !(nm.gt.0)

        if (nmx.gt.0) then

!c  saturation indices for excluded minerals
          if (.not. b_output_binary) then
            open(igsx,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsx.vtk', &
                 status='unknown',form='formatted')
          end if

          allocate(satmx_vols(nmx,num_nodes), stat = ierrcode)
          call checkerr(ierrcode,'outputrt_usg-satmx_vols',ilog)
          call memory_monitor(sizeof(satmx_vols),'satmx_vols',.true.)

          
          if (rank == 0 .and. b_enable_output) then
                                                                       
            if (initial_condition) then                                  
              write(ifls,'(/2a/72a)')'Saturation indices (excluded ',  &
                                     'minerals), initial condition',   &
                                    ('-',i=1,72)
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Saturation indices (excluded minerals), T = ',    &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsx.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            do imx = 1,nmx
              if (imx.lt.7) then
                write(ifls,'(i1,8x,a30,2x,a)') imx+3,namemx(imx),'-'
              else
                write(ifls,'(i2,7x,a30,2x,a)') imx+3,namemx(imx),'-'
              end if
            end do
          
          end if

        end if                         !(nmx.gt.0)
        
        if (iso_output) then
!c  isotope data
          if (.not. b_output_binary) then
            open(igsis,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                 trim(adjustl(str_rank))//'.gsis.vtk',                 &
                 status='unknown',form='formatted')
          end if

          if (rank == 0 .and. b_enable_output) then
            if (initial_condition) then                                   
              write(ifls,'(/a/72a)')'Isotope Data, initial condition', &
                                    ('-',i=1,72)                        
            else                                                        
              write(ifls,'(/a,1pe15.6e3,1x,a/72a)')                    &
                    'Isotope Data, T = ',                              &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)       
            end if
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsis.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'    
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'       
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'       
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            
            icount = 1
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i1 = istart, istop
                ic2 = jamdisoo(i1)
                icount = icount +1
                if (icount.le.9) then
                    write(ifls,'(i1,8x,a30,2x,a)') icount,namec(ic2),    &
                                       'moles/l h2o'                    
                else                                                    
                    write(ifls,'(i2,7x,a30,2x,a)') icount,namec(ic2),    &
                                       'moles/l h2o'                    
                end if                                                  
              end do                                                    
              icount = icount +1                                        
              ic2 = jamdisoo(istart)                                    
              if (icount.le.9) then                                     
                write(ifls,'(i1,8x,a4,a,4x,a)') icount, 'sum ',        &
                      namec(ic2), 'moles/l h2o'                         
              else                                                      
                write(ifls,'(i2,8x,a4,a,4x,a)') icount, 'sum ',        &
                      namec(ic2), 'moles/l h2o'                           
              end if                                                      
                                                                          
              istart = iamdisoo(i)                                        
              istop = iamdisoo(i+1)-1                                     
              do i1 = istart+1, istop                                     
                ic1 = jamdisoo(istart)                                    
                ic2 = jamdisoo(i1)                                        
                icount = icount +1                                        
                if (icount.le.9) then                                     
                  write(ifls,'(i1,8x,a6,a8,a2,a8,8x,a)') icount,       &
                    'delta ', namec(ic2),'/ ' , namec(ic1),'per mil'      
                else                                                      
                  write(ifls,'(i2,8x,a6,a8,a2,a8,8x,a)') icount,       &
                    'delta ', namec(ic2),'/ ' , namec(ic1),'per mil'
                end if
                
              end do 
            end do
          end if
        end if                         !(iso_output)
        
!c  ---------------------------------------------------------------------  
!c  open files - water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------  
        
        if (chemical_water) then
          if (.not. b_output_binary) then
            open(igsw,file=prefix(:l_prfx)//'_'//                      &
                 suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsw.vtk', &
                 status='unknown',form='formatted')
          end if

          if (rank == 0 .and. b_enable_output) then
            if (initial_condition) then
              
            write(ifls,'(/2a/72a)')'Water produced/consumed, initial', & 
                                     ' condition',('-',i=1,72)
            else                                                        
              write(ifls,'(/2a,1pe15.6e3,1x,a/72a)')                   &
                    'Water produced/consumed, ','T = ',                &
                     time_io,time_unit(:l_time_unit),('-',i=1,72)
            end if                                                      
                                                                        
            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'.gsw.vtk'
                                                                        
            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            write(ifls,'(2a)')                                         &
                  '4        water produced/consumed         ',         &
                  'l H2O d^-1'
          end if
        endif

      end if                           !(extended_output_gs)


!c  --------------------------------------------------------------------- 
!c  total aqueous component concentrations
!c  --------------------------------------------------------------------- 

!c  title and mesh variables
      if (.not. b_output_binary) then
        write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
              "gst variables, solution time = ",time_io,time_unit
        call write_mesh_data_vtk_ascii(igst,trim(adjustl(strbuffer)))

        if (multi_diff) then
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                     &
                "cbt variables, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(icbt,trim(adjustl(strbuffer)))
        end if

        if(flux_out)then
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                     &
                "gmf variables, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(igmf,trim(adjustl(strbuffer)))
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
                "gsre variables, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(igsre,trim(adjustl(strbuffer)))
        end if
      end if


!c  --------------------------------------------------------------------- 
!c  output for xmgr
!c  --------------------------------------------------------------------- 
      if(flux_out) then
        allocate(totcflux_vols(nc-1,num_nodes), stat = ierrcode)
        call checkerr(ierrcode,'outputrt_usg-totcflux_vols',ilog)
        call memory_monitor(sizeof(totcflux_vols),'totcflux_vols',.true.)
      end if

      do inode=1,num_nodes

!c  skip ghost nodes
#ifdef PETSC
        if(node_idx_lg2l(inode) < 0) then
            cycle
        end if
#endif

!c  recompute total aqueous component concentrations

        if (redox_equil.and.nr.gt.0) then
          call totconc(cnew(1,inode),cx(1,inode),totcnew(1,inode))
        end if

!c  write results

!c  assign depth coordinate in terms of depth or elevation
!c  this is currently not supported in USG
!c       zout = zoutput(depth_output,zg(inode),elevmax)

!c  calculate concentrations of sorbed species and convert the unit to mol/L H2O
!c  when 'combined output of aquous and sorbed concentrations' is specified
        totcsb_ion = 0.0d0 
        totcsb_surf = 0.0d0

        if (combined_gst_gsb_output) then
          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
            do isb = 1,nsb_ion 
              call sorbspc_m(csb_ion(isb,tid),dummy,cec_g(inode),    &
                   cec_fraction_g(idx_nsites_ion(isb),inode),        &
                   eqsb_ion(:,tid),eqsb_surf(:,tid),                &
                   gamma(1,inode),cnew(1,inode),xnusb_ion,xnusb_surf, &
                   iasb_ion,iasb_surf,jasb_ion,jasb_surf,           &
                   nsb_ion,nsb_surf,isb,0,                          &
                   sorption_type_ion,sorption_type_surf,            &
                   sorption_group,isactcexch)

!c  add up exchanged species and convert from [meq/100g] solid to 
!c  [mmol/100g solid]
              istart = iasb_ion(isb)
              istop = iasb_ion(isb+1)-1
              do i1 = istart,istop
                ic = jasb_ion(i1)
            
!c  skip h2o, since not a primary unknown    
!c  For the sorbed species it should be the species concentration of the sorbed species, 
!c  which reflects the amount of the ion on the surface site.         
                if (namec(ic).ne.'h2o') then
                  if (xnusb_ion(i1) > r0) then
                    totcsb_ion(ic) = totcsb_ion(ic)+xnusb_ion(i1)*     &
                                     csb_ion(isb,tid)/chargesb_ion(isb)
                  end if
                end if
              end do
            end do

!c  convert from [mmol/100g solid] to [mol/L H2O] 
            if (nsb_ion > 0) then
              do ic=1,nc-1
                totcsb_ion(ic) = rhobulk_g(inode)/r100*totcsb_ion(ic)/ &
                                 pornew(inode)/sanew(inode)
              end do
            end if
            
            do isb = 1,nsb_surf
              call sorbspc(dummy,csb_surf(isb,tid),cec_g(inode),      &
                   eqsb_ion(:,tid),eqsb_surf(:,tid),                  &
                   gamma(1,inode),cnew(1,inode),                      &
                   xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,           &
                   jasb_ion,jasb_surf,nsb_ion,                        &
                   nsb_surf,0,isb,sorption_type_ion,                  &
                   sorption_type_surf,sorption_group,isactcexch) 

!c  add up exchanged species and convert from [meq/100g] solid to 
!c  [mmol/100g solid]
              istart = iasb_surf(isb)
              istop = iasb_surf(isb+1)-1
              do i1 = istart,istop
                ic = jasb_surf(i1)
         
!c  skip h2o, since not a primary unknown 
!c  For the sorbed species it should be the species concentration of the sorbed species, 
!c  which reflects the amount of the ion on the surface site.           
                if (namec(ic).ne.'h2o') then
                  if (xnusb_surf(i1) > r0) then
                    totcsb_surf(ic) = totcsb_surf(ic)+xnusb_surf(i1)*  &
                                      csb_surf(isb,tid)
                  end if
                end if
              end do

            end do

!c  convert from [mmol/100g solid] to [mol/L H2O] 
            if (nsb_surf > 0) then
              do ic=1,nc-1
                totcsb_surf(ic) = rhobulk_g(inode)/r100*totcsb_surf(ic)/&
                                  pornew(inode)/sanew(inode)
              end do
            end if
        
          end if
        end if

! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
! cdsu Replace the MCD charge balance calculation with function cbalance.
! cdsu Previous code does not deal with zero charge problem.
! cdsu ---------------------------------------------------------------
        
        if (multi_diff) then
! prc ----------------------------------------------------------------
! prc Charge Balance distribution
! prc Pejman Rasouli
! prc ----------------------------------------------------------------
          !write(icbt,ascii_fmt) xg(inode),yg(inode),zout,               &
          !     (totcnew(ic,inode),ic=1,nc-1),                          &
          !      100*zc(inode)/zcabs(inode),zc(inode)
        end if

        if(flux_out)then
          call flux_calc(inode,tid)
          totcflux_vols(1:nc-1,inode) = totcflux(1:nc-1)
          !write(igmf,ascii_fmt) xg(inode),yg(inode),zout,               &
          !                        (totcflux(ic),ic=1,nc-1)
        end if

      end do

      !c buffer for hdf5 data write
      if (b_output_binary) then
        allocate(realbuffer(num_nodes), stat = ierrcode)
        call checkerr(ierrcode,'outputrt_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)

        allocate(realbuffer2(num_nodes), stat = ierrcode)
        call checkerr(ierrcode,'outputrt_usg-realbuffer2',ilog)
        call memory_monitor(sizeof(realbuffer2),'realbuffer2',.true.)
      end if
    
!c  output gst data
!c  write dataset head
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          if (combined_gst_gsb_output) then
            open(ixmf,file=trim(strfilename)//'.gstgsb.xmf',           &
                 status='unknown',form='formatted')
          else
            open(ixmf,file=trim(strfilename)//'.gst.xmf',              &
                 status='unknown',form='formatted')
          end if
        end if

        if (combined_gst_gsb_output) then
          strfilename_result = trim(strfilename)//'.gstgsb.h5'
        else
          strfilename_result = trim(strfilename)//'.gst.h5'
        end if

        if (b_output_separate_mesh_result) then
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_mesh = strfilename_result
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)
        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)

        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)

        do ic = 1, nc-1
          do inode = 1, num_nodes
            realbuffer(inode) = totcnew(ic,inode) +                    &
                               totcsb_ion(ic)+totcsb_surf(ic)
          end do
          call hdf5_usg_write_group_data_1d(group_id,trim(namec(ic)),  &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results",trim(namec(ic)),"Scalar","Node",       &
                      num_nodes_gbl,1)
          end if
        end do

        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        write(igst,'(a,1x,i12)') "POINT_DATA",num_nodes
        do ic=1,nc-1
          write(igst,'(3a)') "SCALARS ",trim(namec(ic)(:l_namec(ic)))," double"
          write(igst,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igst,ascii_fmt) totcnew(ic,inode) +                   &
                                      totcsb_ion(ic)+totcsb_surf(ic)
          end do
        end do
      end if

!c  output cbt data
!c  write dataset head
      if (multi_diff) then
        if (b_output_binary) then
#ifdef PETSC_HDF
          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.cbt.xmf',              &
                 status='unknown',form='formatted')
          end if

          strfilename_result = trim(strfilename)//'.cbt.h5'
          if (b_output_separate_mesh_result) then
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_mesh = strfilename_result
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)
          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                  MPI_INFO_NULL, hdf5_ierr)

          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                           hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)

          do ic = 1, nc-1
            do inode = 1, num_nodes
              realbuffer(inode) = totcnew(ic,inode) +                  &
                                 totcsb_ion(ic)+totcsb_surf(ic)
            end do
            call hdf5_usg_write_group_data_1d(group_id,trim(namec(ic)),&
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results",trim(namec(ic)),  &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
          end do

          do inode = 1, num_nodes
            call cbalance(cnew(:,inode),cx(:,inode),zbal,zpos,zneg)

            realbuffer(inode) = zbal
            realbuffer2(inode) = zpos-zneg
          end do
          call hdf5_usg_write_group_data_1d(group_id,                  &
                    "Charge_Balance_Error_%",num_nodes_loc,            &
                    num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","Charge_Balance_Error_%","Scalar",     &
                      "Node",num_nodes_gbl,1)
          end if

          call hdf5_usg_write_group_data_1d(group_id,                  &
                    "Charge_Balance",num_nodes_loc,                    &
                    num_nodes_gbl,offset_nodes,realbuffer2)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","Charge_Balance","Scalar",             &
                      "Node",num_nodes_gbl,1)
          end if

          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          write(icbt,'(a,1x,i12)') "POINT_DATA",num_nodes
          do ic=1,nc-1
            write(icbt,'(3a)') "SCALARS ",trim(namec(ic)(:l_namec(ic)))," double"
            write(icbt,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(icbt,ascii_fmt) totcnew(ic,inode)
            end do
          end do

          write(icbt,'(a)') "SCALARS Charge_Balance_Error_% double"
          write(icbt,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            call cbalance(cnew(:,inode),cx(:,inode),zbal,zpos,zneg)
            write(icbt,ascii_fmt) zbal
          end do

          write(icbt,'(a)') "SCALARS Charge_Balance double"
          write(icbt,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            call cbalance(cnew(:,inode),cx(:,inode),zbal,zpos,zneg)
            write(icbt,ascii_fmt) zpos-zneg
          end do
        end if
      end if

!c  output gmf data
!c  write dataset head
      if(flux_out)then
        if (b_output_binary) then
#ifdef PETSC_HDF
          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.gmf.xmf',              &
                 status='unknown',form='formatted')
          end if

          strfilename_result = trim(strfilename)//'.gmf.h5'
          if (b_output_separate_mesh_result) then
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_mesh = strfilename_result
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)
          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)

          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                           hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                           OBJECT_NAMELEN_DEFAULT_F)

          do ic = 1, nc-1
            do inode = 1, num_nodes
              realbuffer(inode) = totcflux_vols(ic,inode)
            end do
            call hdf5_usg_write_group_data_1d(group_id,trim(namec(ic)),  &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results",trim(namec(ic)),"Scalar","Node",       &
                        num_nodes_gbl,1)
            end if
          end do

          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          write(igmf,'(a,1x,i12)') "POINT_DATA",num_nodes
          do ic=1,nc-1
            write(igmf,'(3a)') "SCALARS ",trim(namec(ic)(:l_namec(ic)))," double"
            write(igmf,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igmf,ascii_fmt) totcflux_vols(ic,inode)
            end do
          end do
        end if
        call memory_monitor(-sizeof(totcflux_vols),'totcflux_vols',.true.)
        deallocate(totcflux_vols)
      end if

      !c  compress vector containing total aqueous component concentrations
      do inode = 1, num_nodes
        if (redox_equil.and.nr.gt.0) then
          call comptotc(totcnew(1,inode))
        end if
      end do

!cdsu concentration of radioelement related to noble gas ingrowth
      if (b_use_ngi .and. ngre_i > 0) then
!c  output gsre data
!c  write dataset head
        if (b_output_binary) then
#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.gsre.xmf',             &
                 status='unknown',form='formatted')
          end if

          strfilename_result = trim(strfilename)//'.gsre.h5'

          if (b_output_separate_mesh_result) then
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_mesh = strfilename_result
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)
          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)

          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,        &
                           file_id, hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)

          do ingre = 1, ngre_i
            do inode = 1, num_nodes
              realbuffer(inode) = conc_ngre(ingre,inode)
            end do
            call hdf5_usg_write_group_data_1d(group_id,                &
                      trim(name_ngre_i(ingre)),num_nodes_loc,          &
                      num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result, "results",trim(namec(ic)), &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
          end do

          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          write(igsre,'(a,1x,i12)') "POINT_DATA",num_nodes
          do ingre = 1, ngre_i
            write(igsre,'(3a)') "SCALARS ",trim(name_ngre_i(ingre))," double"
            write(igsre,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsre,ascii_fmt) conc_ngre(ingre,inode)
            end do
          end do
        end if
      end if

!c  ---------------------------------------------------------------------
!c  extended output --> species concentrations
!c                      master variables
!c                      partial gas pressures
!c                      sorbed species concentrations
!c                      saturation indices of minerals
!c                      dissolution-precipitation rates
!c                      oxidation-reduction rates
!c                      volume fractions of minerals
!c  ---------------------------------------------------------------------
 
      if (extended_output_gs) then

!c  -----------------------------------------------
!c  free species and aqueous complex concentrations
!c  -----------------------------------------------
!c  title and variables
        if (initial_condition) then
          strbuffer = ", initial"
        else
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
                ", solution time = ",time_io,time_unit
        end if

        if (.not. b_output_binary) then
          call write_mesh_data_vtk_ascii(igsc,"gsc variables"//        &
                     trim(adjustl(strbuffer)))
        end if
        
        if (b_output_activity .and. .not. b_output_binary) then
          call write_mesh_data_vtk_ascii(igsac,"gsac variables"//      &
                     trim(adjustl(strbuffer)))
        end if
!c  ----------------
!c  master variables
!c  ----------------
        if (ph_output .or. pe_output) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsm,                       &
                       "gsm master variables"//trim(adjustl(strbuffer)))
          end if
        end if       !(ph_output or. pe_output)

!c  -------------------------
!c  oxidation-reduction rates
!c  -------------------------

        if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)              &
                    .and.(.not.initial_condition)) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsi,                       &
                     "gsi hom. reaction rates"//                       &
                     trim(adjustl(strbuffer)))
          end if

        end if       !((nr.gt.0)..... )

!c  ----------------------------------------
!c  rates of intra-aqueous kinetic reactions
!c  ----------------------------------------

        if (naq.gt.0.and.(.not.initial_condition)) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsi,                       &
                       "gsi intra-aqueous reactions"//                 &
                       trim(adjustl(strbuffer)))
          end if
        end if       !(naq.gt.0..... )

!c  --------------------------------------------------------------------- 
!c  partial gas pressures
!c  --------------------------------------------------------------------- 
 
        if (ng.gt.0) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsg,                       &
                       "gsg variables"//trim(adjustl(strbuffer)))
          end if

          if (gas_advection .or. dgm .or. maxwell) then
            if (.not. b_output_binary) then
              call write_mesh_data_vtk_ascii(igs2,                     &
                        "gs2 variables"//trim(adjustl(strbuffer)))
            end if

          end if

!c  ---------------------------------------------------------------------
!c  degassing rates
!c  ---------------------------------------------------------------------

          if (gas_removal) then
            if (.not. b_output_binary) then
              call write_mesh_data_vtk_ascii(igsgr,                    &
                         "gsgr R_i^g"//trim(adjustl(strbuffer)))
            end if
          end if         !(gas_removal)

        end if           !(ng.gt.0)

!c  -----------------------------
!c  sorbed species concentrations
!c  -----------------------------

        if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.       &
            nsb_surf.gt.0.or.noncompetitive_sorption)) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsb,                       &
                       "gsb S_i"//trim(adjustl(strbuffer)))
          end if
        end if


        if (nm.gt.0) then
!c  --------------------------
!c  mineral saturation indices
!c  --------------------------
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igss,                       &
                       "gss SI"//trim(adjustl(strbuffer)))
          end if

!c  -------------------------------
!c  dissolution-precipitation rates
!c  -------------------------------
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsd,                       &
                       "gsd Diss.-prec. rates"//                       &
                       trim(adjustl(strbuffer)))
          end if

!c  ----------------------------
!c  volume fractions of minerals
!c  ----------------------------
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsv,                       &
                       "gsv phi_i"//trim(adjustl(strbuffer)))
          end if

        end if         !(nm.gt.0)


        if (nmx.gt.0) then
!c  --------------------------------------
!c  saturation indices - excluded minerals
!c  --------------------------------------
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsx,                       &
                       "gsx SI"//trim(adjustl(strbuffer)))
          end if

        end if         !(nmx.gt.0)

!c  --------------------------------------
!c  isotope data
!c  --------------------------------------
!c  title and variables
        if (iso_output) then

          i1 = 0
          do i=1,nip
            istart = iamdisoo(i)
            istop = iamdisoo(i+1)-1
            do i2 = istart, istop
              ic2 = jamdisoo(i2)
              i1 = i1 +1
              nametemp(i1) = namec(ic2)
              l_nametemp(i1) = index(nametemp(i1),' ')-1
            end do
            i1 = i1 +1
            ic2 = jamdisoo(istart)
            nametemp(i1) = 'sum_'//namec(ic2)
            l_nametemp(i1) = index(nametemp(i1),' ')-1

            istart = iamdisoo(i)
            istop = iamdisoo(i+1)-1
            do i2 = istart+1, istop
              ic2 = jamdisoo(i2)
              i1 = i1 +1
              nametemp(i1) = 'delta_'//namec(ic2)
              l_nametemp(i1) = index(nametemp(i1),' ')-1
            end do
          end do

          nmi = i1

          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsis,                      &
                       "gsis isotope data"//trim(adjustl(strbuffer)))
          end if

        end if         !(iso_output)

!c  ---------------------------------------------------------------------
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------
        if (chemical_water) then
          if (.not. b_output_binary) then
            call write_mesh_data_vtk_ascii(igsw,                       &
                       "gsw G_i"//trim(adjustl(strbuffer)))
          end if
        endif

!c  ---------------------------------------------------------------------
!c  output - water phase
!c  ---------------------------------------------------------------------
        
        do inode=1,num_nodes
            
!c  skip ghost nodes
#ifdef PETSC
          if(node_idx_lg2l(inode) < 0) then
            cycle  
          end if
#endif

#ifdef OPENMP
          tid = omp_get_thread_num() + 1
#else
          tid = 1
#endif

          izn_c = mpropc(inode)

!c  temperature corrections for debye-huckel, equilibrium and
!c  rate constants

          if (temp_corr.or.heat_transport) then
            call tcorr(tkel(inode),inode,tid)
          end if

!c  assign depth coordinate in terms of depth or elevation
!c  this is currently not supported in USG
!c          zout = zoutput(depth_output,zg(inode),elevmax)
 
!c  update secondary variables before output
 
          call updtsvap(cnew(1,inode),cx(1,inode),gamma(1,inode),      &
     &                  gamma(nc+1,inode),sionnew(inode),tid)
          
          if (hmulti_diff) then
          
            call updtsvap(c(1,inode),cxold(1,inode),gammaold(1,inode), &
     &                    gammaold(nc+1,inode),sionold(inode),tid)  
          end if       !MX test
     
!c  free species and aqueous complex concentrations
          !write(igsc,ascii_fmt) xg(inode),yg(inode),zout,              &
          !                         (cnew(ic,inode),ic=1,nc-1),         &
          !                         (cx(ix,inode),ix=1,nxout)

!c  master variables
          ! Compute charge balance
          call cbalance(cnew(:,inode),cx(:,inode),zbal,zpos,zneg) 

          call phpe(cnew(1,inode),gamma(1,inode),ph,pe,eh,tkel(inode))

          if (compute_alkalinity) then
            call alkcalc(alk_carb,alk_noncarb,alk_tot,                 &
     &                   alk_carb_mg,alk_noncarb_mg,alk_tot_mg,        &
     &                   alkfacc,alkfacx,cnew(1,inode),cx(1,inode),    &
     &                   iax,jax,nc,nx,namec,namex)                    
          else                                        !MX              
             alk_carb = r0                                             
             alk_noncarb = r0                                          
             alk_tot = r0                                              
             alk_carb_mg = r0                                          
             alk_noncarb_mg = r0                                       
             alk_tot_mg = r0                                           
          end if
          
          if (ph_output .or. pe_output) then
            ph_vols(inode) = ph
            pe_vols(inode) = pe
            eh_vols(inode) = eh

            alk_carb_vols(inode) = alk_carb
            alk_noncarb_vols(inode) = alk_noncarb
            alk_tot_vols(inode) = alk_tot
            alk_carb_mg_vols(inode) = alk_carb_mg
            alk_noncarb_mg_vols(inode) = alk_noncarb_mg
            alk_tot_mg_vols(inode) = alk_tot_mg
            zbal_vols(inode) = zbal
          end if

          !if ((ph_output).and.(pe_output)) then
          !  write(igsm,ascii_fmt) xg(inode),yg(inode),zout,ph,pe,eh,     &
          !                         sionnew(inode),alk_carb,alk_noncarb, &
          !                         alk_tot,alk_carb_mg,alk_noncarb_mg, &
          !                         alk_tot_mg,tkel(inode)-tconv,zbal
          !elseif ((.not.ph_output).and.(pe_output)) then
          !  write(igsm,ascii_fmt) xg(inode),yg(inode),zout,pe,eh,        &
          !                       sionnew(inode),alk_carb,alk_noncarb,   &
          !                       alk_tot,alk_carb_mg,alk_noncarb_mg,   &
          !                       alk_tot_mg,tkel(inode)-tconv,zbal
          !elseif ((ph_output).and.(.not.pe_output)) then
          !  write(igsm,ascii_fmt) xg(inode),yg(inode),zout,ph,           &
          !                       sionnew(inode),alk_carb,alk_noncarb,   &
          !                       alk_tot,alk_carb_mg,alk_noncarb_mg,   &
          !                       alk_tot_mg,tkel(inode)-tconv,zbal
          !end if

!c  oxidation-reduction rates

          if (nr.gt.0.and.(.not.redox_equil)                           &
     &               .and.(.not.initial_condition)) then

!c  recompute oxidation-reduction rates

            do ir = 1,nr
              call rateredx(cnew(1,inode),cx(1,inode),gamma(1,inode),  &
     &                      gamma(nc+1,inode),rateor(ir,tid),          &
     &                      totcnew(1,inode),ir,tid)
              rateor_vols(ir,inode) = rateor(ir,tid)
            end do
            !write(igsi,ascii_fmt) xg(inode),yg(inode),zout,            &
            !                      (rateor(ir,tid),ir = 1,nr)
            !
          end if               !((nr.gt.0).....)
                                                                      
!c  intra-aqueous kinetic reactions
                                                                       
          if (naq.gt.0.and.(.not.initial_condition)) then
                                                                      
!c  recompute rates of intra-aqueous kinetic reactions
                                                                       
            do iaq = 1,naq
              if (new_database) then                                   
                call rateint_new(rateaq(iaq,tid),totcnew(1,inode),     &
                                 cnew(1,inode),cx(1,inode),            &
                                 gamma(1,inode),gamma(nc+1,inode),     &
                                 phi(1,inode),iaq,                     &
                                 scalfac_aq_ivol(iaq,inode),           &
                                 sanew(inode),pornew(inode),tid)
              else                                                     
                call rateint(rateaq(iaq,tid),totcnew(1,inode),         &
                             cnew(1,inode),gamma(1,inode),phi(1,inode),&
                             iaq,scalfac_aq_ivol(iaq,inode),tid)
              end if
              rateaq_vols(iaq,inode) = rateaq(iaq,tid)
            end do

            !write(igsi,ascii_fmt) xg(inode),yg(inode),zout,           &
            !                        (rateaq(iaq,tid),iaq = 1,naq)
            !
          end if               !(naq.gt.0.....)
 
!c  --------------------------------------------------------------------- 
!c  output - gas phase
!c  --------------------------------------------------------------------- 

          if (ng.gt.0) then

!c         gas advection
            if (gas_advection .or. dgm .or. maxwell) then
              do ig=1,ng
                pg(ig) = 0.0d0
                if (cum_molfrac) then
                  do jg=1,ig
                     pg(ig) = pg(ig) + rgasatm*tkel(inode)*gnew(jg,inode)            
                  enddo
                else
                  pg(ig) = rgasatm*tkel(inode)*gnew(ig,inode)             
                endif
              enddo 
            end if

!c  compute total gas pressure

            pres_tot = r0
            do ig = 1,ng
              pres_tot = pres_tot+rgasatm*tkel(inode)*gnew(ig,inode)
            end do

!c  partial gas pressures and total gas pressure
            pres_tot_vols(inode) = pres_tot
            !write(igsg,ascii_fmt) xg(inode),yg(inode),zout,           &
            !                   (rgasatm*tkel(inode)*gnew(ig,inode),   &
            !                    ig=1,ng),pres_tot
     
            if (gas_advection .or. dgm .or. maxwell) then
              do ig = 1, ng
                pg_vols(ig,inode) = pg(ig)/pres_tot
              end do
              !write(igs2,ascii_fmt) xg(inode),yg(inode),zout,         &
              !                        (pg(ig)/pres_tot,ig=1,ng)
            end if

!c  compute degassing rates and total rates for removal of aqueous
!c  components due to degassing [mol L^-1 h2o s^-1]

            if (gas_removal) then

              if (density_dependence) then
                call rategasd(gnew(1,inode),tkel(inode),uvsnew(inode), &
                              sgnew(inode),tid)
              else
                call rategas(gnew(1,inode),tkel(inode),hhead(inode),   &
                             zg(inode),sgnew(inode),tid)                      
              end if

              rateg_vols(:,inode) =  rateg(:,tid)
              !write(igsgr,ascii_fmt) xg(inode),yg(inode),zout,        &
              !                        (rateg(ig,tid),ig=1,ng)

            end if

          end if

!c  --------------------------------------------------------------------- 
!c  output - solid phase
!c  --------------------------------------------------------------------- 

!c  concentrations of sorbed species - non-competitive sorption

          if (noncompetitive_sorption) then
          
            if (redox_equil.and.nr.gt.0) then
              call totconc(cnew(1,inode),cx(1,inode),totcnew(1,inode))
            end if

            call totcona(totan(:,tid),totcnew(1,inode),                &
                         distcoff_rt(1,inode),sanew(inode),pornew(inode))

            if (redox_equil.and.nr.gt.0) then
              call comptotc(totcnew(1,inode))
            end if

!c  compress concentration vector for output

            ianc = 0
            do ic = 1,nc-1
              if (isotherm_type(ic).ne.'none') then
                ianc = ianc+1
                totan(ianc,tid) = totan(ic,tid)
              end if
            end do

          end if

!c  concentrations of sorbed species - competitive sorption

          if (nsb_ion.gt.0.or.nsb_surf.gt.0) then

              do isb = 1,nsb_ion
                  call sorbspc_m(csb_ion(isb,tid),dummy,cec_g(inode),  &
                       cec_fraction_g(idx_nsites_ion(isb),inode),      &
                       eqsb_ion(:,tid),eqsb_surf(:,tid),               &
                       gamma(1,inode),cnew(1,inode),xnusb_ion,xnusb_surf,&
                       iasb_ion,iasb_surf,jasb_ion,jasb_surf,          &
                       nsb_ion,nsb_surf,isb,0,                         &
                       sorption_type_ion,sorption_type_surf,           &
                       sorption_group,isactcexch)
              end do

              do isb = 1,nsb_surf
                call sorbspc(dummy,csb_surf(isb,tid),cec_g(inode),     &
                     eqsb_ion(:,tid),eqsb_surf(:,tid),                 &
                     gamma(1,inode),cnew(1,inode),                     &
                     xnusb_ion,xnusb_surf,iasb_ion,iasb_surf,          &
                     jasb_ion,jasb_surf,nsb_ion,                       &
                     nsb_surf,0,isb,sorption_type_ion,                 &
                     sorption_type_surf,sorption_group,isactcexch)
              end do

          end if
                                                                      
!c  output 

          if(.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.      &
             nsb_surf.gt.0.or.noncompetitive_sorption)) then

            if (nsb_ion.eq.0.and.nsb_surf.eq.0) then

!c  non-competitive sorption only
              totan_vols(:,inode) = totan(:,tid)
              !write(igsb,ascii_fmt) xg(inode),yg(inode),zout,          &
              !                        (totan(ianc,tid),                &
              !                        ianc=1,nanc)
!c  competitive sorption only

            elseif (.not.noncompetitive_sorption) then
              if (nsb_ion > 0) then
                csb_ion_vols(:,inode) = csb_ion(:,tid)
              end if

              if (nsb_surf > 0) then
                csb_surf_vols(:,inode) = csb_surf(:,tid)
              end if
              !if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
              !  write(igsb,ascii_fmt)                                  &
              !        xg(inode),yg(inode),zout,                        &
              !        (cnew(iaic(isites),inode),                       &
              !        isites=1,nsites),                                &
              !        (csb_ion(isb,tid),isb=1,nsb_ion),                &
              !        (csb_surf(isb,tid),isb=1,nsb_surf)
              !else
              !  ! unit for SCM concentration in 'mol/L bulk'
              !  write(igsb,ascii_fmt)                                  &
              !        xg(inode),yg(inode),zout,                        &
              !        (cnew(iaic(isites),inode)*                       &
              !        sanew(inode)*pornew(inode),                      &
              !        isites=1,nsites),                                &
              !        (csb_ion(isb,tid),isb=1,nsb_ion),                &
              !        (csb_surf(isb,tid)*sanew(inode)*pornew(inode),   &
              !        isb=1,nsb_surf)
              !end if

!c  competitive and non-competitive sorption

            else
              if (nanc > 0) then
                totan_vols(:,inode) = totan(:,tid)
              end if

              if (nsb_ion > 0) then
                csb_ion_vols(:,inode) = csb_ion(:,tid)
              end if

              if (nsb_surf > 0) then
                csb_surf_vols(:,inode) = csb_surf(:,tid)
              end if
              !if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
              !  write(igsb,ascii_fmt)                                  &
              !        xg(inode),yg(inode),zout,                        &
              !        (totan(ianc,tid),                                &
              !        ianc=1,nanc),                                    &
              !        (cnew(iaic(isites),inode),                       &
              !        isites=1,nsites),                                &
              !        (csb_ion(isb,tid),isb=1,nsb_ion),                &
              !        (csb_surf(isb,tid),isb=1,nsb_surf)
              !else
              !  ! unit for SCM concentration in 'mol/L bulk'
              !  write(igsb,ascii_fmt)                                  &
              !        xg(inode),yg(inode),zout,                        &
              !        (totan(ianc,tid),                                &
              !        ianc=1,nanc),                                    &
              !        (cnew(iaic(isites),inode)*                       &
              !        sanew(inode)*pornew(inode),                      &
              !        isites=1,nsites),                                &
              !        (csb_ion(isb,tid),isb=1,nsb_ion),                &
              !        (csb_surf(isb,tid)*sanew(inode)*pornew(inode),   &
              !        isb=1,nsb_surf)
              !end if
              
            end if

          end if


!c  saturation indices for minerals
  
          if (nm.gt.0) then

!c  compute total molar concentration of organic mixture
!c  in solid phase

            call molconc(phiold(1,inode),tid)

            do im=1,nm

              if (.not.far_from_equil(im)) then
!c  saturation indices for minerals
!c_isotope
                if (isofrac(im)) then
                  satm(im,tid) = eqm(im,tid)**(-r1)
                  ireac = iamd(im)            
                  istart = iam(im)
                  istop = iam(im+1)-1           
          
                  do i1 = istart, istop ! loop through components in mineral
                    icount = 0
                    ic = jam(i1)
                    next = 0 
                    do i = 1, nifrm(im)  ! loop through isotope sets
                      istart2 = next + iamdiso(im)
                      icur = iamdiso2(im) + i - 1
                      istop2 = iamdiso(im) + jamdiso2(icur) - 1
                      next = jamdiso2(icur)
                      gammatemp = r0
                      !loop through isotope compents in set
                      do i2 = istart2, istop2
                        ii = jamdiso(i2)
                        !check to see if component is an isotope
                        if (ii.eq.ic) then 
                          icount = icount + 1
                          !if so sum the isotope activities
                          do i3 = istart2, istop2 
                            ic2 = jamdiso(i3)
                            gammatemp = gammatemp + gamma(ic2,inode)*  &
                                        cnew(ic2,inode)           
                          end do                                        
                          satm(im,tid) = satm(im,tid)*gammatemp**xnum(i1)             
                        end if                                          
                      end do                                            
                    end do                                              
                    !if not calculate the saturaton index the normal way  
                    if (icount.eq.0) then                               
                      satm(im,tid) = satm(im,tid) *                    &
     &                        (gamma(ic,inode)*cnew(ic,inode))**xnum(i1)  
                    end if                                              
                  end do   !i1                                          
                                                                        
                  satm_log(im) = dlog10(satm(im,tid))
                                                                        
                else if (reaction_type(im).ne.'raoult') then
                   
                  satm(im,tid) = satindex(cnew(1,inode),eqm(im,tid),   &
     &                                gamma(1,inode),xnum,iam,jam,im)
                  satm_log(im) = dlog10(satm(im,tid))

!c  effective saturation indices for dissolution form organic mixtures
!c  based on raoult's law

                elseif (reaction_type(im).eq.'raoult') then

!c  compute molar concentration of organic compound in organic mixture

                  conc_mol = phiold(im,inode)*densm(im)/gfwm(im)

!c  pure phase saturation index

                  satm(im,tid) = satindex(cnew(1,inode),eqm(im,tid),   &
     &                                gamma(1,inode),xnum,iam,jam,im)

!c  effective solubility according to Raoult's Law

                  frac_mol = conc_mol/conc_mol_avg(tid)
                  satm(im,tid) = satm(im,tid)/frac_mol
                  satm_log(im) = dlog10(satm(im,tid))

                end if

!c  skip calculation for far-from-equilibrium reactions

              else

                satm_log(im) = r0

              end if

            end do

            satm_log_vols(:,inode) = satm_log(:)
            !write(igss,ascii_fmt) xg(inode),yg(inode),zout,            &
            !                          (satm_log(im),im=1,nm)
 
!c  dissolution-precipitation rates

            do im = 1,nm

!c  recompute rates for output

              if (new_database) then
                if (root_uptake) then
                  rootdens = rld(inode)
                else
                  rootdens = r1
                end if
                call ratemin_new(totcnew(1,inode),cnew(1,inode),       &
                                 cx(1,inode),gamma(1,inode),           &
                                 gamma(nc+1,inode),sanew(inode),       &
                                 ratemdp(im,inode),                    &
                                 phi(1,inode),phiold(im,inode),        &
                                 area(im,inode),rootdens,im,tid)  
              else                                                     
                call ratemin(totcnew(1,inode),cnew(1,inode),cx(1,inode),&
                             gamma(1,inode),gamma(nc+1,inode),          &
                             ratemdp(im,inode),phi(im,inode),           &
                             phiold(im,inode),area(im,inode),im,tid)
              end if

!cdsu  Adjust mineral rate for intermittent reactions
              if (flag_intermittent_react) then
                if (imizn2jairm(im,izn_c) > 0) then
                  ratemdp(im,inode) = ratemdp(im,inode)*imizn2irc(im,izn_c)
                end if
              end if
             
!cdsu  Assign mineral rate for freezing water
              if(b_water_freezing_ratemin) then
                if (tkel(inode) < pressure_melt_k(inode,r0)) then
                  ratemdp(im,inode) = water_freezing_ratemin
                end if
              end if

!c  modify computed rates in the same manner as done in the residual
!c  assembly

              call modrate(ratemdp(im,inode),cmnew(im,inode),          &
                           pornew(inode),delt,im,tid)

            end do

            !write(igsd,ascii_fmt) xg(inode),yg(inode),zout,             &
            !      (ratemdp(im,inode),im = 1, nm)

!c  volume fractions of minerals
 
!c  get rid off concentrations below numerical accuracy

            do im = 1,nm
              if (phi(im,inode).gt.phimin_out(im)) then
                phi_out(im) = phi(im,inode)
              else
                phi_out(im) = phimin(im)
              end if
            end do

!c  compute porosity from mineral volume fractions for output
!cdsu Bugfix 2021-03-30: The calculated porosity is only correct  
!cdsu if all solids are considered in the calculation 
!cdsu including those "inert" minerals. Otherwise, the porosity 
!cdsu will be higher than the actual porosity.
            !por_out = r1
            !do im = 1,nm
            !  if (iamp(im+1)-iamp(im).gt.0) then
            !    por_out = por_out - phi_out(im)
            !  end if
            !end do

            phi_out_vols(:,inode) = phi_out(:)

          end if    !(nm.gt.0)

!c  saturation indices for excluded minerals

          if (nmx.gt.0) then

            do imx = 1,nmx
              satmx(imx) =  satindex(cnew(1,inode),eqmx(imx,tid),      &
                                     gamma(1,inode),xnumx,iamx,jamx,imx)
            end do
            
            satmx_vols(:,inode) = satmx(:)
            !write(igsx,ascii_fmt) xg(inode),yg(inode),zout,            &
            !                        (dlog10(satmx(imx)),imx=1,nmx)

          end if    !(nmx.gt.0)
          
!c_isotopes
!c isotope data          
          if (iso_output) then

            i1 = 0
            do i=1,nip
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              tottemp = 0
              do i2 = istart, istop
                ic2 = jamdisoo(i2)
                i1 = i1 +1
                valuetemp(i1) = totcnew(ic2,inode)
                tottemp = tottemp + totcnew(ic2,inode)
              end do
              i1 = i1 +1
              valuetemp(i1) = tottemp
               
              istart = iamdisoo(i)
              istop = iamdisoo(i+1)-1
              do i2 = istart+1, istop
                ic1 = jamdisoo(istart)
                ic2 = jamdisoo(i2)
                i1 = i1 +1 
                valuetemp(i1)=(totcnew(ic2,inode)/totcnew(ic1,inode)/  &
                              isodelta(i2)-1)*1000                      
              end do                                                    
            end do                
            
            valuetemp_vols(1:i1,inode) = valuetemp(1:i1)
            !write(igsis,ascii_fmt) xg(inode),yg(inode),zout,          &
            !        (valuetemp(imi),imi=1,i1)
          end if    !(iso_output)    
          
!c  ---------------------------------------------------------------------  
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------

          if (chemical_water) then
        
              !write(igsw,ascii_fmt) xg(inode),yg(inode),zout,qwater(inode)

          endif

        end do      !loop over control volumes


!c  output gsc dataset
!c  write dataset head
        if (b_output_binary) then
#ifdef PETSC_HDF
          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.gsc.xmf',              &
                 status='unknown',form='formatted')
          end if

          strfilename_result = trim(strfilename)//'.gsc.h5'
          if (b_output_separate_mesh_result) then
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_mesh = strfilename_result
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)
          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)

          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                           hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)

          do ic = 1, nc-1
            do inode = 1, num_nodes
              realbuffer(inode) = cnew(ic,inode)
            end do
            call hdf5_usg_write_group_data_1d(group_id,trim(namec(ic)),  &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results",trim(namec(ic)),"Scalar","Node",       &
                        num_nodes_gbl,1)
            end if
          end do

          do ix = 1, nxout
            do inode = 1, num_nodes
              realbuffer(inode) = cx(ix,inode)
            end do
            call hdf5_usg_write_group_data_1d(group_id,trim(namex(ix)),  &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results",trim(namex(ix)),"Scalar","Node",       &
                        num_nodes_gbl,1)
            end if
          end do

          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          write(igsc,'(a,1x,i12)') "POINT_DATA",num_nodes
          do ic=1,nc-1
            write(igsc,'(3a)') "SCALARS ",trim(namec(ic)(:l_namec(ic)))," double"
            write(igsc,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsc,ascii_fmt) cnew(ic,inode)
            end do
          end do
          do ix=1,nxout
            write(igsc,'(3a)') "SCALARS ",trim(namex(ix)(:l_namex(ix)))," double"
            write(igsc,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsc,ascii_fmt) cx(ix,inode)
            end do
          end do
        end if
        
!c  output gsac dataset
!c  write dataset head
        if (b_output_activity) then 
          if (b_output_binary) then
#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.gsac.xmf',              &
                   status='unknown',form='formatted')
            end if
            
            strfilename_result = trim(strfilename)//'.gsac.h5'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_mesh = strfilename_result
            end if
            
            !c initialize fortran interface
            call h5open_f(hdf5_ierr)
            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                    MPI_INFO_NULL, hdf5_ierr)
            
            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)
            
            !c write attribute
            call hdf5_usg_write_attribute(file_id)
            
            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if
            
            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                        cell_type,num_cells_gbl,num_nodes_gbl,           &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                    &
                        strfilename_mesh,"domain","vertices_rank",       &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                    &
                        strfilename_mesh,"domain","cells_rank",          &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                    &
                        strfilename_mesh,"domain","vertices_lg2g",       &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                    &
                        strfilename_mesh,"domain","cells_lg2g",          &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                  &
                          strfilename_mesh,"domain","vertices_matid",    &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                  &
                          strfilename_mesh,"domain","cells_matid",       &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if
            
            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                             OBJECT_NAMELEN_DEFAULT_F)
            
            do ic = 1, nc-1
              do inode = 1, num_nodes
                realbuffer(inode) = gamma(ic,inode)
              end do
              call hdf5_usg_write_group_data_1d(group_id,                  &
                        trim(namec(ic))//"(activity)",                     &
                        num_nodes_loc,num_nodes_gbl,                       &
                        offset_nodes,realbuffer)
            
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results",trim(namec(ic))//"(activity)",         &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
            end do
            
            do ix = 1, nxout
              do inode = 1, num_nodes
                realbuffer(inode) = gamma(ix+nc,inode)
              end do
              call hdf5_usg_write_group_data_1d(group_id,                  &
                        trim(namex(ix))//"(activity)",num_nodes_loc,       &
                        num_nodes_gbl,offset_nodes,realbuffer)
            
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results",trim(namex(ix))//"(activity)",         &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
            end do
            
            !c close group
            call h5gclose_f(group_id,hdf5_ierr)
            
            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)
            
            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)
            
            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            write(igsac,'(a,1x,i12)') "POINT_DATA",num_nodes
            do ic=1,nc-1
              write(igsac,'(3a)') "SCALARS ",trim(namec(ic)(:l_namec(ic)))// &
                                  "(activity)"," double"
              write(igsac,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsac,ascii_fmt) gamma(ic,inode)
              end do
            end do
            do ix=1,nxout
              write(igsac,'(3a)') "SCALARS ",trim(namex(ix)(:l_namex(ix)))// &
                                  "(activity)"," double"
              write(igsac,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsac,ascii_fmt) gamma(ix+nc,inode)
              end do
            end do            
          end if
        end if    !c activity coefficient

!c  output gsm dataset
!c  write dataset head
        if (ph_output .or. pe_output) then
          if (b_output_binary) then
#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.gsm.xmf',            &
                   status='unknown',form='formatted')
            end if

            strfilename_result = trim(strfilename)//'.gsm.h5'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_mesh = strfilename_result
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)
            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                    MPI_INFO_NULL, hdf5_ierr)

            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                        cell_type,num_cells_gbl,num_nodes_gbl,         &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_rank",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_rank",        &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_lg2g",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_lg2g",        &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_matid",  &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_matid",     &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                             OBJECT_NAMELEN_DEFAULT_F)

            !c ph
            call hdf5_usg_write_group_data_1d(group_id,"ph",               &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,ph_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","ph","Scalar","Node",                    &
                        num_nodes_gbl,1)
            end if

            !c pe and eh
            if (pe_output) then
              call hdf5_usg_write_group_data_1d(group_id,"pe",             &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,pe_vols)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results","pe","Scalar","Node",                  &
                          num_nodes_gbl,1)
              end if

              call hdf5_usg_write_group_data_1d(group_id,"eh",             &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,eh_vols)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results","eh","Scalar","Node",                  &
                          num_nodes_gbl,1)
              end if
            end if

            !c ionic_strength
            call hdf5_usg_write_group_data_1d(group_id,"ionic_strength",   &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,sionnew)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","ionic_strength","Scalar","Node",        &
                        num_nodes_gbl,1)
            end if

            !c Note: hdf5 does not allow dataset name with '/'
            !c C-Alk[eq/L]
            call hdf5_usg_write_group_data_1d(group_id,"C-Alk[eq_per_L]",  &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,            &
                      alk_carb_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","C-Alk[eq_per_L]","Scalar","Node",       &
                        num_nodes_gbl,1,"C-Alk[eq/L]")
            end if

            !c NC-Alk[eq/L]
            call hdf5_usg_write_group_data_1d(group_id,"NC-Alk[eq_per_L]", &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,            &
                      alk_noncarb_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","NC-Alk[eq_per_L]","Scalar","Node",      &
                        num_nodes_gbl,1,"NC-Alk[eq/L]")
            end if

            !c Alk[eq/L]
            call hdf5_usg_write_group_data_1d(group_id,"Alk[eq_per_L]",    &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,            &
                      alk_tot_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","Alk[eq_per_L]","Scalar","Node",         &
                        num_nodes_gbl,1,"Alk[eq/L]")
            end if

            !c C-Alk[mg/L-CaCO_3]
            call hdf5_usg_write_group_data_1d(group_id,                    &
                      "C-Alk[mg_per_L-CaCO_3]",num_nodes_loc,num_nodes_gbl,&
                      offset_nodes,alk_carb_mg_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","C-Alk[mg_per_L-CaCO_3]","Scalar","Node",&
                        num_nodes_gbl,1,"C-Alk[mg/L-CaCO_3]")
            end if

            !c NC-Alk[mg/L-CaCO_3]
            call hdf5_usg_write_group_data_1d(group_id,                    &
                      "NC-Alk[mg_per_L-CaCO_3]",num_nodes_loc,             &
                      num_nodes_gbl,offset_nodes,alk_noncarb_mg_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","NC-Alk[mg_per_L-CaCO_3]","Scalar",      &
                        "Node",num_nodes_gbl,1,"NC-Alk[mg/L-CaCO_3]")
            end if

            !c Alk[mg/L-CaCO_3]
            call hdf5_usg_write_group_data_1d(group_id,                    &
                      "Alk[mg_per_L-CaCO_3]",num_nodes_loc,num_nodes_gbl,  &
                      offset_nodes,alk_tot_mg_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","Alk[mg_per_L-CaCO_3]","Scalar","Node",  &
                        num_nodes_gbl,1,"Alk[mg/L-CaCO_3]")
            end if

            !c temperature
            do inode = 1, num_nodes
              realbuffer(inode) = tkel(inode)-tconv
            end do
            call hdf5_usg_write_group_data_1d(group_id,"temperature",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","temperature","Scalar","Node",           &
                        num_nodes_gbl,1)
            end if

            !c charge_bal[%]
            call hdf5_usg_write_group_data_1d(group_id,"charge_bal[%]",    &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,zbal_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                        "results","charge_bal[%]","Scalar","Node",         &
                        num_nodes_gbl,1)
            end if

            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            write(igsm,'(a,1x,i12)') "POINT_DATA",num_nodes
            if (ph_output) then
              write(igsm,'(a)') "SCALARS ph double"
              write(igsm,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsm,ascii_fmt) ph_vols(inode)
              end do
            end if

            if (pe_output) then
              write(igsm,'(a)') "SCALARS pe double"
              write(igsm,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsm,ascii_fmt) pe_vols(inode)
              end do

              write(igsm,'(a)') "SCALARS eh double"
              write(igsm,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsm,ascii_fmt) eh_vols(inode)
              end do
            end if

            write(igsm,'(a)') "SCALARS ionic_strength double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) sionnew(inode)
            end do

            write(igsm,'(a)') "SCALARS C-Alk[eq/L] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_carb_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS NC-Alk[eq/L] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_noncarb_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS Alk[eq/L] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_tot_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS C-Alk[mg/L-CaCO_3] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_carb_mg_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS NC-Alk[mg/L-CaCO_3] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_noncarb_mg_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS Alk[mg/L-CaCO_3] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) alk_tot_mg_vols(inode)
            end do

            write(igsm,'(a)') "SCALARS temperature double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) tkel(inode)-tconv
            end do

            write(igsm,'(a)') "SCALARS charge_bal[%] double"
            write(igsm,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsm,ascii_fmt) zbal_vols(inode)
            end do
          end if

          call memory_monitor(-sizeof(ph_vols),'ph_vols',.true.)
          call memory_monitor(-sizeof(pe_vols),'pe_vols',.true.)
          call memory_monitor(-sizeof(eh_vols),'eh_vols',.true.)
          call memory_monitor(-sizeof(alk_carb_vols),'alk_carb_vols',.true.)
          call memory_monitor(-sizeof(alk_noncarb_vols),'alk_noncarb_vols',.true.)
          call memory_monitor(-sizeof(alk_tot_vols),'alk_tot_vols',.true.)
          call memory_monitor(-sizeof(alk_carb_mg_vols),'alk_carb_mg_vols',.true.)
          call memory_monitor(-sizeof(alk_noncarb_mg_vols),'alk_noncarb_mg_vols',.true.)
          call memory_monitor(-sizeof(alk_tot_mg_vols),'alk_tot_mg_vols',.true.)
          call memory_monitor(-sizeof(zbal_vols),'zbal_vols',.true.)

          deallocate(ph_vols)
          deallocate(pe_vols)
          deallocate(eh_vols)
          deallocate(alk_carb_vols)
          deallocate(alk_noncarb_vols)
          deallocate(alk_tot_vols)
          deallocate(alk_carb_mg_vols)
          deallocate(alk_noncarb_mg_vols)
          deallocate(alk_tot_mg_vols)
          deallocate(zbal_vols)
        end if


        if (nr.gt.0.and.(.not.redox_equil)                          &
                   .and.(.not.initial_condition)) then
!c  recompute oxidation-reduction rates

          if (b_output_binary) then
#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.gsr.xmf',            &
                   status='unknown',form='formatted')
            end if

            strfilename_result = trim(strfilename)//'.gsr.h5'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_mesh = strfilename_result
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)
            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                    MPI_INFO_NULL, hdf5_ierr)

            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                        cell_type,num_cells_gbl,num_nodes_gbl,         &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_rank",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_rank",        &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_lg2g",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_lg2g",        &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_matid",  &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_matid",     &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                             OBJECT_NAMELEN_DEFAULT_F)

            do ir = 1, nr
              do inode = 1, num_nodes
                realbuffer(inode) = rateor_vols(ir,inode)
              end do
              call hdf5_usg_write_group_data_1d(group_id,trim(namec(ir)),  &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results",trim(namec(ir)),"Scalar","Node",       &
                          num_nodes_gbl,1)
              end if
            end do

            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            write(igsi,'(a,1x,i12)') "POINT_DATA",num_nodes
            do ir = 1, nr
              write(igsi,'(3a)') "SCALARS ",namer(ir)(:l_namer(ir))," double"
              write(igsi,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsi,ascii_fmt) rateor_vols(ir,inode)
              end do
            end do
          end if

          call memory_monitor(-sizeof(rateor_vols),'rateor_vols',.true.)
          deallocate(rateor_vols)
        end if               !((nr.gt.0).....)

        if (naq.gt.0.and.(.not.initial_condition)) then
!c  recompute rates of intra-aqueous kinetic reactions
          if (b_output_binary) then
#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.gsi.xmf',            &
                   status='unknown',form='formatted')
            end if

            strfilename_result = trim(strfilename)//'.gsi.h5'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_mesh = strfilename_result
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)
            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                    MPI_INFO_NULL, hdf5_ierr)

            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                        cell_type,num_cells_gbl,num_nodes_gbl,         &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_rank",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_rank",        &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_lg2g",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_lg2g",        &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_matid",  &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_matid",     &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,     &
                             OBJECT_NAMELEN_DEFAULT_F)

            do iaq = 1,naq
              do inode = 1, num_nodes
                realbuffer(inode) = rateaq_vols(iaq,inode)
              end do
              call hdf5_usg_write_group_data_1d(group_id,trim(nameaq(iaq)),&
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results",trim(nameaq(iaq)),"Scalar","Node",     &
                          num_nodes_gbl,1)
              end if
            end do

            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            write(igsi,'(a,1x,i12)') "POINT_DATA",num_nodes
            do iaq = 1,naq
              write(igsi,'(3a)') "SCALARS ",nameaq(iaq)(:l_nameaq(iaq))," double"
              write(igsi,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsi,ascii_fmt) rateaq_vols(iaq,inode)
              end do
            end do
          end if

          call memory_monitor(-sizeof(rateaq_vols),'rateaq_vols',.true.)
          deallocate(rateaq_vols)
        end if               !(naq.gt.0.....)


!c  output - gas phase
          if (ng.gt.0) then

!c  partial gas pressures and total gas pressure
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsg.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsg.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,   &
                               OBJECT_NAMELEN_DEFAULT_F)

              do ig = 1, ng
                do inode = 1, num_nodes
                  realbuffer(inode) = rgasatm*tkel(inode)*gnew(ig,inode)
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(nameg(ig)),  &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                            "results",trim(nameg(ig)),"Scalar","Node",       &
                            num_nodes_gbl,1)
                end if
              end do

              !c p_t_o_t
              call hdf5_usg_write_group_data_1d(group_id,"pres_tot_vols",    &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,pres_tot_vols)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                          "results","pres_tot_vols","Scalar","Node",         &
                          num_nodes_gbl,1)
              end if

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsg,'(a,1x,i12)') "POINT_DATA",num_nodes
              do ig = 1,ng
                write(igsg,'(3a)') "SCALARS ",nameg(ig)(:l_nameg(ig))," double"
                write(igsg,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igsg,ascii_fmt) rgasatm*tkel(inode)*gnew(ig,inode)
                end do
              end do
              write(igsg,'(a)') "SCALARS p_t_o_t double"
              write(igsg,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsg,ascii_fmt) pres_tot_vols(inode)
              end do
            end if

            call memory_monitor(-sizeof(pres_tot_vols),'pres_tot_vols',.true.)
            deallocate(pres_tot_vols)


            if (gas_advection .or. dgm .or. maxwell) then
              if (b_output_binary) then
#ifdef PETSC_HDF
                !c open corresponding xmf file to be loaded by paraview
                if (rank == 0) then
                  ixmf = lun_get()
                  open(ixmf,file=trim(strfilename)//'.gs2.xmf',        &
                       status='unknown',form='formatted')
                end if

                strfilename_result = trim(strfilename)//'.gs2.h5'
                if (b_output_separate_mesh_result) then
                  strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
                else
                  strfilename_mesh = strfilename_result
                end if

                !c initialize fortran interface
                call h5open_f(hdf5_ierr)
                !c setup file access property list with parallel I/O access
                call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
                call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                        MPI_INFO_NULL, hdf5_ierr)

                !c create the file collectively
                call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                                 hdf5_ierr, access_prp = plist_id)

                !c write attribute
                call hdf5_usg_write_attribute(file_id)

                if (.not. b_output_separate_mesh_result) then
                  !c write mesh data
                  call hdf5_usg_write_mesh_data(file_id)
                end if

                !c open corresponding xmf file for mesh and domain decomposition
                if (rank == 0) then
                  call hdf5_usg_write_xmf_initialize(ixmf)
                  call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                            cell_type,num_cells_gbl,num_nodes_gbl,       &
                            num_nodes_per_cell)
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_mesh,"domain","vertices_rank",   &
                            "Scalar","Node",num_nodes_gbl,1)
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_mesh,"domain","cells_rank",      &
                            "Scalar","Cell",num_cells_gbl,1)

                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_mesh,"domain","vertices_lg2g",   &
                            "Scalar","Node",num_nodes_gbl,1)
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_mesh,"domain","cells_lg2g",      &
                            "Scalar","Cell",num_cells_gbl,1)

                  if (b_use_node_matids) then
                    call hdf5_usg_write_xmf_attribute(ixmf,              &
                              strfilename_mesh,"domain",                 &
                              "vertices_matid","Scalar","Node",          &
                              num_nodes_gbl,1)
                  end if
                  if (b_use_cell_matids) then
                    call hdf5_usg_write_xmf_attribute(ixmf,              &
                              strfilename_mesh,"domain","cells_matid",   &
                              "Scalar","Cell",num_cells_gbl,1)
                  end if
                end if

                !c create a group for the mesh data set
                strbuffer = "results"
                !c create and open a group
                call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                                 OBJECT_NAMELEN_DEFAULT_F)

                do ig = 1, ng
                  do inode = 1, num_nodes
                    realbuffer(inode) = pg_vols(ig,inode)
                  end do
                  call hdf5_usg_write_group_data_1d(group_id,trim(nameg(ig)),  &
                            num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                  if (rank == 0) then
                    call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                              "results",trim(nameg(ig)),"Scalar","Node",       &
                              num_nodes_gbl,1)
                  end if
                end do

                !c close group
                call h5gclose_f(group_id,hdf5_ierr)

                !c close file
                call h5pclose_f(plist_id, hdf5_ierr)
                call h5fclose_f(file_id, hdf5_ierr)

                !c close FORTRAN interface
                call h5close_f(hdf5_ierr)

                !c close xmf file
                if (rank == 0) then
                  call hdf5_usg_write_xmf_finalize(ixmf)
                  close(ixmf)
                  call lun_free(ixmf)
                end if
#endif
              else
                write(igs2,'(a,1x,i12)') "POINT_DATA",num_nodes
                do ig = 1,ng
                  write(igs2,'(3a)') "SCALARS ",nameg(ig)(:l_nameg(ig))," double"
                  write(igs2,'(a)') "LOOKUP_TABLE default"
                  do inode = 1, num_nodes
                    write(igs2,ascii_fmt) pg_vols(ig,inode)
                  end do
                end do
              end if

              call memory_monitor(-sizeof(pg_vols),'pg_vols',.true.)
              deallocate(pg_vols)
            end if

!c  compute degassing rates and total rates for removal of aqueous
!c  components due to degassing [mol L^-1 h2o s^-1]

            if (gas_removal) then
              if (b_output_binary) then
#ifdef PETSC_HDF
                !c open corresponding xmf file to be loaded by paraview
                if (rank == 0) then
                  ixmf = lun_get()
                  open(ixmf,file=trim(strfilename)//'.gsgr.xmf',       &
                       status='unknown',form='formatted')
                end if

                strfilename_result = trim(strfilename)//'.gsgr.h5'
                if (b_output_separate_mesh_result) then
                  strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
                else
                  strfilename_mesh = strfilename_result
                end if

                !c initialize fortran interface
                call h5open_f(hdf5_ierr)
                !c setup file access property list with parallel I/O access
                call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
                call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                        MPI_INFO_NULL, hdf5_ierr)

                !c create the file collectively
                call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                                 hdf5_ierr, access_prp = plist_id)

                !c write attribute
                call hdf5_usg_write_attribute(file_id)

                if (.not. b_output_separate_mesh_result) then
                  !c write mesh data
                  call hdf5_usg_write_mesh_data(file_id)
                end if

                !c open corresponding xmf file for mesh and domain decomposition
                if (rank == 0) then
                  call hdf5_usg_write_xmf_initialize(ixmf)
                  call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                            cell_type,num_cells_gbl,num_nodes_gbl,         &
                            num_nodes_per_cell)
                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","vertices_rank",     &
                            "Scalar","Node",num_nodes_gbl,1)
                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","cells_rank",        &
                            "Scalar","Cell",num_cells_gbl,1)

                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","vertices_lg2g",     &
                            "Scalar","Node",num_nodes_gbl,1)
                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","cells_lg2g",        &
                            "Scalar","Cell",num_cells_gbl,1)

                  if (b_use_node_matids) then
                    call hdf5_usg_write_xmf_attribute(ixmf,                &
                              strfilename_mesh,"domain","vertices_matid",  &
                              "Scalar","Node",num_nodes_gbl,1)
                  end if
                  if (b_use_cell_matids) then
                    call hdf5_usg_write_xmf_attribute(ixmf,                &
                              strfilename_mesh,"domain","cells_matid",     &
                              "Scalar","Cell",num_cells_gbl,1)
                  end if
                end if

                !c create a group for the mesh data set
                strbuffer = "results"
                !c create and open a group
                call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,     &
                                 OBJECT_NAMELEN_DEFAULT_F)

                do ig = 1, ng
                  do inode = 1, num_nodes
                    realbuffer(inode) = rateg_vols(ig,inode)
                  end do
                  call hdf5_usg_write_group_data_1d(group_id,trim(nameg(ig)),  &
                            num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                  if (rank == 0) then
                    call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                              "results",trim(nameg(ig)),"Scalar","Node",       &
                              num_nodes_gbl,1)
                  end if
                end do

                !c close group
                call h5gclose_f(group_id,hdf5_ierr)

                !c close file
                call h5pclose_f(plist_id, hdf5_ierr)
                call h5fclose_f(file_id, hdf5_ierr)

                !c close FORTRAN interface
                call h5close_f(hdf5_ierr)

                !c close xmf file
                if (rank == 0) then
                  call hdf5_usg_write_xmf_finalize(ixmf)
                  close(ixmf)
                  call lun_free(ixmf)
                end if
#endif
              else
                write(igsgr,'(a,1x,i12)') "POINT_DATA",num_nodes
                do ig = 1,ng
                  write(igsgr,'(3a)') "SCALARS ",nameg(ig)(:l_nameg(ig))," double"
                  write(igsgr,'(a)') "LOOKUP_TABLE default"
                  do inode = 1, num_nodes
                    write(igsgr,ascii_fmt) rateg_vols(ig,inode)
                  end do
                end do
              end if

              call memory_monitor(-sizeof(rateg_vols),'rateg_vols',.true.)
              deallocate(rateg_vols)
            end if
          end if


          if(.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.      &
             nsb_surf.gt.0.or.noncompetitive_sorption)) then
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsb.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsb.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,   &
                               OBJECT_NAMELEN_DEFAULT_F)

              if (nsb_ion.eq.0.and.nsb_surf.eq.0) then
!c  non-competitive sorption only
                do ianc = 1,nanc
                  do inode = 1, num_nodes
                    realbuffer(inode) = totan_vols(ianc,inode)
                  end do
                  call hdf5_usg_write_group_data_1d(group_id,trim(nameanc(ianc)),&
                            num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                  if (rank == 0) then
                    call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                              "results",trim(nameanc(ianc)),"Scalar","Node",     &
                              num_nodes_gbl,1)
                  end if
                end do
!c  competitive sorption only

              elseif (.not.noncompetitive_sorption) then

                if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
                  do isites = 1,nsites
                    do inode = 1, num_nodes
                      realbuffer(inode) = cnew(iaic(isites),inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namec(iaic(isites))),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
                  
                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,         &
                                "results",trim(namec(iaic(isites))),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                    
                  do isb = 1,nsb_ion
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_ion_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_ion(isb)),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,     &
                                "results",trim(namesb_ion(isb)),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do

                  do isb = 1,nsb_surf
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_surf_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_surf(isb)), &
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,       &
                                "results",trim(namesb_surf(isb)),"Scalar","Node",      &
                                num_nodes_gbl,1)
                    end if
                  end do
                else
                  ! unit for SCM concentration in 'mol/L bulk'
                  do isites = 1,nsites
                    do inode = 1, num_nodes
                      realbuffer(inode) = cnew(iaic(isites),inode)*sanew(inode)*pornew(inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namec(iaic(isites))),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
                  
                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,         &
                                "results",trim(namec(iaic(isites))),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                  
                  do isb = 1,nsb_ion
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_ion_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_ion(isb)),  &
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,       &
                                "results",trim(namesb_ion(isb)),"Scalar","Node",       &
                                num_nodes_gbl,1)
                    end if
                  end do
                  do isb = 1,nsb_surf
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_surf_vols(isb,inode)*sanew(inode)*pornew(inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_surf(isb)), &
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,       &
                                "results",trim(namesb_surf(isb)),"Scalar","Node",      &
                                num_nodes_gbl,1)
                    end if
                  end do
                end if

!c  competitive and non-competitive sorption

              else
                do ianc = 1,nanc
                  do inode = 1, num_nodes
                    realbuffer(inode) = totan_vols(ianc,inode)
                  end do
                  call hdf5_usg_write_group_data_1d(group_id,trim(nameanc(ianc)),&
                            num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                  if (rank == 0) then
                    call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                              "results",trim(nameanc(ianc)),"Scalar","Node",     &
                              num_nodes_gbl,1)
                  end if
                end do

                if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
                    
                  do isites = 1,nsites
                    do inode = 1, num_nodes
                      realbuffer(inode) = cnew(iaic(isites),inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namec(iaic(isites))),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
                  
                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,         &
                                "results",trim(namec(iaic(isites))),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                    
                  do isb = 1,nsb_ion
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_ion_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_ion(isb)),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,     &
                                "results",trim(namesb_ion(isb)),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                  do isb = 1,nsb_surf
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_surf_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_surf(isb)), &
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,       &
                                "results",trim(namesb_surf(isb)),"Scalar","Node",      &
                                num_nodes_gbl,1)
                    end if
                  end do
                else
                  ! unit for SCM concentration in 'mol/L bulk'
                  
                  do isites = 1,nsites
                    do inode = 1, num_nodes
                      realbuffer(inode) = cnew(iaic(isites),inode)*sanew(inode)*pornew(inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namec(iaic(isites))),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
                  
                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,         &
                                "results",trim(namec(iaic(isites))),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                  
                  do isb = 1,nsb_ion
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_ion_vols(isb,inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_ion(isb)),&
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,     &
                                "results",trim(namesb_ion(isb)),"Scalar","Node",     &
                                num_nodes_gbl,1)
                    end if
                  end do
                  do isb = 1,nsb_surf
                    do inode = 1, num_nodes
                      realbuffer(inode) = csb_surf_vols(isb,inode)*sanew(inode)*pornew(inode)
                    end do
                    call hdf5_usg_write_group_data_1d(group_id,trim(namesb_surf(isb)), &
                              num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                    if (rank == 0) then
                      call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,       &
                                "results",trim(namesb_surf(isb)),"Scalar","Node",      &
                                num_nodes_gbl,1)
                    end if
                  end do
                end if

              end if

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else

              if (nsb_ion.eq.0.and.nsb_surf.eq.0) then
!c  non-competitive sorption only
                write(igsb,'(a,1x,i12)') "POINT_DATA",num_nodes
                do ianc = 1,nanc
                  write(igsb,'(3a)') "SCALARS ",nameanc(ianc)(:l_nameanc(ianc))," double"
                  write(igsb,'(a)') "LOOKUP_TABLE default"
                  do inode = 1, num_nodes
                    write(igsb,ascii_fmt) totan_vols(ianc,inode)
                  end do
                end do
!c  competitive sorption only

              elseif (.not.noncompetitive_sorption) then
                write(igsb,'(a,1x,i12)') "POINT_DATA",num_nodes

                if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then
                  do isites = 1,nsites
                    write(igsb,'(3a)') "SCALARS ",namec(iaic(isites))(:l_namec(iaic(isites)))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) cnew(iaic(isites),inode)
                    end do
                  end do
                  do isb = 1,nsb_ion
                    write(igsb,'(3a)') "SCALARS ",namesb_ion(isb)(:l_namesb_ion(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_ion_vols(isb,inode)
                    end do
                  end do
                  do isb = 1,nsb_surf
                    write(igsb,'(3a)') "SCALARS ",namesb_surf(isb)(:l_namesb_surf(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_surf_vols(isb,inode)
                    end do
                  end do
                else
                  ! unit for SCM concentration in 'mol/L bulk'
                  do isites = 1,nsites
                    write(igsb,'(3a)') "SCALARS ",namec(iaic(isites))(:l_namec(iaic(isites)))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) cnew(iaic(isites),inode)*sanew(inode)*pornew(inode)
                    end do
                  end do
                  do isb = 1,nsb_ion
                    write(igsb,'(3a)') "SCALARS ",namesb_ion(isb)(:l_namesb_ion(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_ion_vols(isb,inode)
                    end do
                  end do
                  do isb = 1,nsb_surf
                    write(igsb,'(3a)') "SCALARS ",namesb_surf(isb)(:l_namesb_surf(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_surf_vols(isb,inode)*sanew(inode)*pornew(inode)
                    end do
                  end do
                end if

!c  competitive and non-competitive sorption

              else

                write(igsb,'(a,1x,i12)') "POINT_DATA",num_nodes

                do ianc = 1,nanc
                  write(igsb,'(3a)') "SCALARS ",nameanc(ianc)(:l_nameanc(ianc))," double"
                  write(igsb,'(a)') "LOOKUP_TABLE default"
                  do inode = 1, num_nodes
                    write(igsb,ascii_fmt) totan_vols(ianc,inode)
                  end do
                end do

                if (trim(output_unit_sb_surf) .eq. 'mol/L H2O') then                   
                  do isites = 1,nsites
                    write(igsb,'(3a)') "SCALARS ",namec(iaic(isites))(:l_namec(iaic(isites)))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) cnew(iaic(isites),inode)
                    end do
                  end do
                    
                  do isb = 1,nsb_ion
                    write(igsb,'(3a)') "SCALARS ",namesb_ion(isb)(:l_namesb_ion(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_ion_vols(isb,inode)
                    end do
                  end do
                  do isb = 1,nsb_surf
                    write(igsb,'(3a)') "SCALARS ",namesb_surf(isb)(:l_namesb_surf(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_surf_vols(isb,inode)
                    end do
                  end do
                else
                  ! unit for SCM concentration in 'mol/L bulk'
                  do isites = 1,nsites
                    write(igsb,'(3a)') "SCALARS ",namec(iaic(isites))(:l_namec(iaic(isites)))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) cnew(iaic(isites),inode)*sanew(inode)*pornew(inode)
                    end do
                  end do
                  
                  do isb = 1,nsb_ion
                    write(igsb,'(3a)') "SCALARS ",namesb_ion(isb)(:l_namesb_ion(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_ion_vols(isb,inode)
                    end do
                  end do
                  do isb = 1,nsb_surf
                    write(igsb,'(3a)') "SCALARS ",namesb_surf(isb)(:l_namesb_surf(isb))," double"
                    write(igsb,'(a)') "LOOKUP_TABLE default"
                    do inode = 1, num_nodes
                      write(igsb,ascii_fmt) csb_surf_vols(isb,inode)*sanew(inode)*pornew(inode)
                    end do
                  end do
                end if

              end if
            end if

            if (allocated(totan_vols)) then
              call memory_monitor(-sizeof(totan_vols),'totan_vols',.true.)
              deallocate(totan_vols)
            endif

            if (allocated(csb_ion_vols)) then
              call memory_monitor(-sizeof(csb_ion_vols),'csb_ion_vols',.true.)
              deallocate(csb_ion_vols)
            end if

            if (allocated(csb_surf_vols)) then
              call memory_monitor(-sizeof(csb_surf_vols),'csb_surf_vols',.true.)
              deallocate(csb_surf_vols)
            end if

          end if


          if (nm.gt.0) then
!c  saturation indices for minerals
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gss.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gss.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                               OBJECT_NAMELEN_DEFAULT_F)

              do im = 1, nm
                do inode = 1, num_nodes
                  realbuffer(inode) = satm_log_vols(im,inode)
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(namem(im)),  &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                            "results",trim(namem(im)),"Scalar","Node",       &
                            num_nodes_gbl,1)
                end if
              end do

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igss,'(a,1x,i12)') "POINT_DATA",num_nodes
              do im = 1, nm
                write(igss,'(3a)') "SCALARS ",namem(im)(:l_namem(im))," double"
                write(igss,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igss,ascii_fmt) satm_log_vols(im,inode)
                end do
              end do
            end if
!c  dissolution-precipitation rates
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsd.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsd.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                               OBJECT_NAMELEN_DEFAULT_F)

              do im = 1, nm
                do inode = 1, num_nodes
                  realbuffer(inode) = ratemdp(im,inode)
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(namem(im)),  &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                            "results",trim(namem(im)),"Scalar","Node",       &
                            num_nodes_gbl,1)
                end if
              end do

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsd,'(a,1x,i12)') "POINT_DATA",num_nodes
              do im = 1, nm
                write(igsd,'(3a)') "SCALARS ",namem(im)(:l_namem(im))," double"
                write(igsd,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igsd,ascii_fmt) ratemdp(im,inode)
                end do
              end do
            end if

!c  output of volume fractions
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsv.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsv.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                               OBJECT_NAMELEN_DEFAULT_F)

              do im = 1, nm
                do inode = 1, num_nodes
                  realbuffer(inode) = phi_out_vols(im,inode)
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(namem(im)),  &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                            "results",trim(namem(im)),"Scalar","Node",       &
                            num_nodes_gbl,1)
                end if
              end do

              !c porosity
              do inode = 1, num_nodes
                realbuffer(inode) = pornew(inode)
              end do
              call hdf5_usg_write_group_data_1d(group_id,"porosity",       &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results","porosity","Scalar","Node",            &
                          num_nodes_gbl,1)
              end if

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsv,'(a,1x,i12)') "POINT_DATA",num_nodes
              do im = 1, nm
                write(igsv,'(3a)') "SCALARS ",namem(im)(:l_namem(im))," double"
                write(igsv,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igsv,ascii_fmt) phi_out_vols(im,inode)
                end do
              end do

!c  output of volume porosity
              write(igsv,'(a)') "SCALARS porosity double"
              write(igsv,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsv,ascii_fmt) pornew(inode)
              end do
            end if

            call memory_monitor(-sizeof(satm_log_vols),'satm_log_vols',.true.)
            call memory_monitor(-sizeof(phi_out_vols),'phi_out_vols',.true.)
            deallocate(satm_log_vols)
            deallocate(phi_out_vols)

          end if    !(nm.gt.0)

!c  saturation indices for excluded minerals

          if (nmx.gt.0) then
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsx.xmf',          &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsx.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                          cell_type,num_cells_gbl,num_nodes_gbl,           &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                          "domain","vertices_rank","Scalar","Node",        &
                          num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                          "domain","cells_rank","Scalar","Cell",           &
                          num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                          "domain","vertices_lg2g","Scalar","Node",        &
                          num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                          "domain","cells_lg2g","Scalar","Cell",           &
                          num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","vertices_matid",    &
                            "Scalar","Node",num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                  &
                            strfilename_mesh,"domain","cells_matid",       &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                               OBJECT_NAMELEN_DEFAULT_F)

              do imx = 1, nmx
                do inode = 1, num_nodes
                  realbuffer(inode) = dlog10(satmx_vols(imx,inode))
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(namemx(imx)),&
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                            "results",trim(namemx(imx)),"Scalar","Node",     &
                            num_nodes_gbl,1)
                end if
              end do

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsx,'(a,1x,i12)') "POINT_DATA",num_nodes
              do imx = 1, nmx
                write(igsx,'(3a)') "SCALARS ",namemx(imx)(:l_namemx(imx))," double"
                write(igsx,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igsx,ascii_fmt) dlog10(satmx_vols(imx,inode))
                end do
              end do
            end if

            call memory_monitor(-sizeof(satmx_vols),'satmx_vols',.true.)
            deallocate(satmx_vols)
          end if    !(nmx.gt.0)

!c_isotopes
!c isotope data
          if (iso_output) then
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                open(ixmf,file=trim(strfilename)//'.gsis.xmf',         &
                     status='unknown',form='formatted')
              end if

              strfilename_result = trim(strfilename)//'.gsis.h5'
              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,   &
                               OBJECT_NAMELEN_DEFAULT_F)

              do imi = 1, nmi
                do inode = 1, num_nodes
                  realbuffer(inode) = valuetemp_vols(imi,inode)
                end do
                call hdf5_usg_write_group_data_1d(group_id,trim(nametemp(imi)),&
                          num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                            "results",trim(nametemp(imi)),"Scalar","Node",     &
                            num_nodes_gbl,1)
                end if
              end do

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsis,'(a,1x,i12)') "POINT_DATA",num_nodes
              do imi = 1, nmi
                write(igsis,'(3a)') "SCALARS "//                          &
                      trim(nametemp(imi)(:l_nametemp(imi)))//" double"
                write(igsis,'(a)') "LOOKUP_TABLE default"
                do inode = 1, num_nodes
                  write(igsis,ascii_fmt) valuetemp_vols(imi,inode)
                end do
              end do
            end if

            call memory_monitor(-sizeof(valuetemp_vols),'valuetemp_vols',.true.)
            deallocate(valuetemp_vols)
          end if    !(iso_output)

!c  ---------------------------------------------------------------------
!c  water produced/consumed by geochemical reactions
!c  ---------------------------------------------------------------------
          if (chemical_water) then
            if (b_output_binary) then
#ifdef PETSC_HDF
              !c open corresponding xmf file to be loaded by paraview
              if (rank == 0) then
                ixmf = lun_get()
                if (combined_gst_gsb_output) then
                  open(ixmf,file=trim(strfilename)//'.gstgsb.xmf',      &
                       status='unknown',form='formatted')
                else
                  open(ixmf,file=trim(strfilename)//'.gst.xmf',        &
                       status='unknown',form='formatted')
                end if
              end if

              if (combined_gst_gsb_output) then
                strfilename_result = trim(strfilename)//'.gstgsb.h5'
              else
                strfilename_result = trim(strfilename)//'.gst.h5'
              end if

              if (b_output_separate_mesh_result) then
                strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              else
                strfilename_mesh = strfilename_result
              end if

              !c initialize fortran interface
              call h5open_f(hdf5_ierr)
              !c setup file access property list with parallel I/O access
              call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
              call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                      MPI_INFO_NULL, hdf5_ierr)

              !c create the file collectively
              call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                               hdf5_ierr, access_prp = plist_id)

              !c write attribute
              call hdf5_usg_write_attribute(file_id)

              if (.not. b_output_separate_mesh_result) then
                !c write mesh data
                call hdf5_usg_write_mesh_data(file_id)
              end if

              !c open corresponding xmf file for mesh and domain decomposition
              if (rank == 0) then
                call hdf5_usg_write_xmf_initialize(ixmf)
                call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,    &
                          cell_type,num_cells_gbl,num_nodes_gbl,       &
                          num_nodes_per_cell)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_rank",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_rank",      &
                          "Scalar","Cell",num_cells_gbl,1)

                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_lg2g",   &
                          "Scalar","Node",num_nodes_gbl,1)
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_lg2g",      &
                          "Scalar","Cell",num_cells_gbl,1)

                if (b_use_node_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain",                 &
                            "vertices_matid","Scalar","Node",          &
                            num_nodes_gbl,1)
                end if
                if (b_use_cell_matids) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_mesh,"domain","cells_matid",   &
                            "Scalar","Cell",num_cells_gbl,1)
                end if
              end if

              !c create a group for the mesh data set
              strbuffer = "results"
              !c create and open a group
              call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                               OBJECT_NAMELEN_DEFAULT_F)

              call hdf5_usg_write_group_data_1d(group_id,"water_prod/cons",  &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,qwater)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                          "results","water_prod/cons","Scalar","Node",       &
                          num_nodes_gbl,1)
              end if

              !c close group
              call h5gclose_f(group_id,hdf5_ierr)

              !c close file
              call h5pclose_f(plist_id, hdf5_ierr)
              call h5fclose_f(file_id, hdf5_ierr)

              !c close FORTRAN interface
              call h5close_f(hdf5_ierr)

              !c close xmf file
              if (rank == 0) then
                call hdf5_usg_write_xmf_finalize(ixmf)
                close(ixmf)
                call lun_free(ixmf)
              end if
#endif
            else
              write(igsw,'(a,1x,i12)') "POINT_DATA",num_nodes
              write(igsw,'(a)') "SCALARS water_prod/cons double"
              write(igsw,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsw,ascii_fmt) qwater(inode)
              end do
              !write(igsw,ascii_fmt) xg(inode),yg(inode),zout,qwater(inode)
            end if
          endif
 
      end if        !(extended_output_gs)

      if (b_output_binary) then
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)

        call memory_monitor(-sizeof(realbuffer2),'realbuffer2',.true.)
        deallocate(realbuffer2)
      end if

!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
      if (.not. b_output_binary) then
        close(igst)
        !Keep the file unit, this will be used later
        !call lun_free(igst)
        if (multi_diff) then
          close(icbt)
          !Keep the file unit, this will be used later
          !call lun_free(icbt)
        end if
        if (flux_out) then
          close(igmf)
          !Keep the file unit, this will be used later
          !call lun_free(igmf)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          close(igsre)
        end if

        if (extended_output_gs) then
          close(igsc)
          !Keep the file unit, this will be used later
          !call lun_free(igsc)
          if (b_output_activity) then
            close(igsac)
          end if
          if (ph_output .or. pe_output) then
            close(igsm)
            !Keep the file unit, this will be used later
            !call lun_free(igsm)
          end if
          if (naq.gt.0.and.(.not.initial_condition)) then
            close(igsi)
            !Keep the file unit, this will be used later
            !call lun_free(igsi)
          end if
          if (ng.gt.0) then
            !Keep the file unit, this will be used later
            close(igsg)
            !call lun_free(igsg)
            if (gas_removal) then
              close(igsgr)
              !Keep the file unit, this will be used later
              !call lun_free(igsgr)
            end if
          end if
          if (.not.combined_gst_gsb_output .and. (nsb_ion.gt.0.or.     &
              nsb_surf.gt.0.or.noncompetitive_sorption)) then
            close(igsb)
            !Keep the file unit, this will be used later
            !call lun_free(igsb)
          end if
          if (nm.gt.0) then
            close(igss)
            close(igsd)
            close(igsv)
            !Keep the file unit, this will be used later
            !call lun_free(igss)
            !call lun_free(igsd)
            !call lun_free(igsv)
          end if
          if (nmx.gt.0) then
            close(igsx)
            !Keep the file unit, this will be used later
            !call lun_free(igsx)
          end if          
          if (iso_output) then
            close(igsis)
            !Keep the file unit, this will be used later
            !call lun_free(igsis)
          end if
          
          if (chemical_water) then
            close(igsw)
            !Keep the file unit, this will be used later
            !call lun_free(igsw)
          end if
        
        end if
      end if

      return
      end
#endif
