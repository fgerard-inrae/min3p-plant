!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/infcrt_g_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c --------------------------------------------------------------------------
!c subroutine infcrt_g
!c -------------------
!c
!c compute influence coefficients for diffusive flux terms 
!c for rectangular, cartesian finite volume discretization
!c (reactive transport)
!c
!c
!c written by:      Danyang Su - Aug 04, 2016
!c
!c last modified:
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                        I O
!c     input:
!c
!c        idbg - output for debugging information
!c        ilog - unit number, logbook
!c        nngl - max cells for dim purposes (ncomp.com)
!c        nphas - max number of phases (ncomp.com)
!c        njavs - max dim ja array (ncomp.com)
!c        nx, ny, nz - number of cells in x,y,z dir
!c        pornew(ibk) - porosity
!c        sgnew(nngl) - gaseous phase saturation
!c        ia(), ja() - ysmp pointers
!c        isymvs(ii) - symmetry pointer for cell ibk
!c           tortuosity_corr    = .true.  -> Millington-Quirk
!c                                           tortuosity correction
!c                                           for diffusion
!c                                           coefficients
!c        gas_tortuosity - model of gas tortuosity 
!c                              =  'same as aqueous'
!c                                 'millington'
!c                                 'no correction'
!c                                 'moldrup repacked'
!c
!c     output:
!c
!c        cinfrt_dg() - area / dx * diffusivity 
!c                      influence coefficients (diffusive flux terms)
!c        deltaij     - distance between i and j [m]
!c        tauij       - tortusosity correction for gas diffusion 
!c        gporij      - gas filled porosity at interface i-j
!c        gsatij      - gas saturation at interface i-j
!c
!c passed:   -
!c
!c common:   -
!c
!c local:
!c
!c external: diffcoff  = compute effective diffusion coefficient
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine infcrt_g_usg

      use phys, only : diff_g, frozen_diff_g
#ifdef OPENMP
      use omp_lib 
#endif
      use gen, only :                                                  &
#ifdef OPENMP
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infcrt_g_1,                     &
                      numofloops_thred_infcrt_g_2,                     &
#endif
                      iavs, javs, isymvs, cinfrt_dg, pornew,           &
                      sgnew, njavs, nngl, tortuosity_corr,             &
                      type_tortuosity, marchies, tkel,                 &
                      b_water_freezing,                                &
                      assigned_tau_gas, taugas, b_water_freezing,      &
                      cinfrad, radial_coord, tau_fac, gsatij, gporij,  &
                      deltaij, tauij, gas_tortuosity, sonew,           &
                      jaedgelen, jacell, jaedgeunitdirection,          &
                      tor_corr_a_mq, tor_corr_b_mq, janumcell,         &
                      idbg, ilog, rank, b_enable_output

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use geometry
      use usg_mesh_data, only : nodes, cells, cell_type, cvol_method,  &
                                num_edge_dvols, num_edge_maxcells,     &
                                num_nodes_per_cell,                    &
                                cell_projection, CellCvolFaceArea,     &
                                CellCvolFaceUnitNorm,                  &
                                CellCvolFace_disp_g,                   &
                                get_cell_edge_cvol_id

      implicit none

!c     local variables
      integer :: ivol, jvol, istart, iend, idvol, idvol_r, icell,      &
                 icell2, iedge_r, jtemp

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0,         &
                           rverysmall = 1.0d-30, rsmallarea = 1.0d-8,  &
                           pi = 3.141592653589793d0

      real*8 :: gpor, porav, satav, diffav, diff_eff, marchieav,       &
                tauloc, tort, so_av, tauav, cvolfacearea

      type(point) :: tend, wtend, utend, vtend, ntend

      real*8 :: diff_eff_direct, diff_eff_cross, alpha, beta, rswitch

      real*8 :: diffcoff_g
      external diffcoff_g

      real*8 :: pressure_melt_k
      external :: pressure_melt_k

!c  compute influence coefficients for diffusive flux terms
!c  in gas phase

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infcrt_g_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, istart, iend, icell, icell2,                 &
    !$omp idvol, idvol_r, iedge_r, jtemp, jvol,                       &
    !$omp tend, ntend, wtend, utend, vtend,                           &
    !$omp cvolfacearea, diffav, diff_eff, gpor, marchieav,            &
    !$omp porav, rswitch, satav, so_av, tauloc, tauav, tort)                             
    !$omp do schedule(static)
#endif
      do ivol = 1, nngl

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1
        do jtemp = istart, iend  !c loop over connection
          jvol = javs(jtemp)

!c average porosity of the element, can be other interpolation methods
          porav = 0.5d0*(min(r1, pornew(ivol)) + min(r1,pornew(jvol)))

!c  average tortuosity of the element
          if (assigned_tau_gas) then
            tauloc = 0.5d0*(taugas(ivol)*tau_fac(ivol)+                &
                           taugas(jvol)*tau_fac(jvol))
          end if

!c  calculate average diffusion coefficients for the "pseudo
!c  dispersion element"

!c  calculate the diffusion tensor for the "pseudo diffusion element"
!c  average porosity of the element
          satav = (min(r1,sgnew(ivol))+min(r1,sgnew(jvol)))*0.5d0
          tauav = (min(r1,taugas(ivol))+min(r1,taugas(jvol)))*0.5d0
          so_av = (min(r1,sonew(ivol))+min(r1,sonew(jvol)))*0.5d0

          if (.not.assigned_tau_gas) then
            tauloc = tauav
          end if

!c  calculate the average marchie factor
          marchieav = (marchies(ivol)+marchies(jvol))*0.5d0

!c  calculate effective diffusion coefficient
          diffav = diff_g
          diff_eff = diffcoff_g(diffav,satav,porav,tortuosity_corr,    &
                              assigned_tau_gas,tauloc,type_tortuosity, &
                              marchieav,gas_tortuosity,so_av,          &
                              tor_corr_a_mq, tor_corr_b_mq)

          if (b_water_freezing) then
            if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.             &
                tkel(jvol) < pressure_melt_k(jvol,r0)) then
              diff_eff = diff_eff*frozen_diff_g
            end if
          end if

!c  calculate gas filled porosity
          gpor =  satav * porav

          if (gpor.lt.rverysmall) then
            tort = r0
          else
            tort = diff_eff / diffav / gpor  ! tortuosity
          endif

          tend = math_common_set_vector(diff_eff,diff_eff,diff_eff)

          !c influence coefficient of direct gradient term
          do icell = 1, janumcell(jtemp)   !c loop over all linked cells
            icell2 = jacell(icell,jtemp)
            if (icell2 <= 0) then
              cycle
            end if
            do idvol = 1, num_edge_dvols   !c loop over all dual volumes
              call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,       &
                                         idvol_r,iedge_r,rswitch)
              cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell2)

              if(jacell(icell,jtemp) > 0 .and. cvolfacearea > rsmallarea) then
                !c save gas diffusion
                if (rswitch > r0) then
                  CellCvolFace_disp_g(idvol_r,iedge_r,icell2) = tend
                end if
              end if
            end do
          end do


          gsatij(jtemp)            = satav

          !gsatij(isymvs(jtemp))    = satav

          gporij(jtemp)            = gpor

          !gporij(isymvs(jtemp))    = gpor

          deltaij(jtemp)           = jaedgelen(jtemp)

          !deltaij(isymvs(jtemp))   = jaedgelen(jtemp)

          tauij(jtemp)             = tort
          !tauij(isymvs(jtemp))     = tort
        end do                   !c loop over connection

      end do                     !c  loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

!cdbg
!c     do ibk = 1,nngl
!c       do ii = ia(ibk),ia(ibk+1)-1
!c         write(idbg,*) 'cinfrt_dg(',ii,') = ',cinfrt_dg(ii)
!c       end do
!c     end do
!c       do ibk = 1,nngl
!c       do ii = ia(ibk),ia(ibk+1)-1
!c         write(idbg,*) 'gporij(',ii,') = ',gporij(ii)
!c       end do
!c     end do
!      
!c       do ibk = 1,nngl
!c       do ii = ia(ibk),ia(ibk+1)-1
!c         write(idbg,*) 'deltaij(',ii,') = ',deltaij(ii)
!c       end do
!c     end do
!#ifdef PETSC
!      call petsc_mpi_finalize
!#endif
!c     stop
!cdbg

      return
      end
#endif
