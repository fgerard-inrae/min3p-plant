!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/outputdd_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputdd_usg
!c -------------------
!c
!c write contour data for variably saturated flow simulation to output
!c file
!c
!c toggle logical variable ioutdebug = 0,1 for standard output or
!c density dependent output including pressure and density
!c
!c modified from outputdd.F90
!c
!c written by:      Danyang Su- Oct. 15, 2016
!c
!c last modified:
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cinfvs(njavs)      = influence coefficients              + -
!c                                (variably saturated flow)
!c           cvol(nn)           = nodal volumes                       + -
!c           dimcv(3,nn)        = dimension of control volumes        + -
!c           elevmax            = max. elevation of solution domain   + -
!c           sgnew(nn)          = gaseous phase saturation            + - 
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + - 
!c                                - new time level
!c           relperm(nn)        = relative permeability               + -
!c           time_io            = current solution time (I/O units)   + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c           ifls               = unit number, file information       + -
!c           ilog               = unit number, log book               + -
!c           igsp               = unit number, flow variables         + -
!c           igstime            = pointer to next output time for     + -
!c                                contour data
!c           icnv               = unit number, data conversion        + -
!c           ivel               = unit number, average interfacial    + -
!c                                             velocities
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           iavs(nn+1)         = row pointer array for 1d-scalar     + -
!c                                matrix
!c           javs(njavs)        = connectivity list for 1d-scalar     + -
!c                                matrix
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = current time step                   + -
!c           njavs              = number of global connections        + -
!c           nn                 = number of control volumes           + -
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c           half_cells         = .true.  -> half cells on boundary   + -
!c           initial_condition  = .true.  -> output of initial        + -
!c                                           contour data
!c                                .false. -> output contour data
!c                                           for steady state or
!c                                           transient solutions
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           steady_flow        = .true.  -> steady state flow        + -
!c           upstream           = .true.  -> upstream weighting       + -
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient conditions for    
!c                                           variably saturated flow 
!c                                           simulation
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           problem_title      = problem title                       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c
!c dens.f:   real*8:
!c           -------
!c           pressure(nn)       = fluid pressure                      + -
!c           density(nn)        = fluid density                       + -
!c           ref_dens           = reference density to convert        + -
!c                                from freshwater heads to pressures
!c
!c local:    real*8:
!c           ------- 
!c           fhead              = freshwater head
!c           qroot              = root water uptake for current
!c                                control volume
!c           theta_a            = aqueous phase content
!c           theta_g            = gas phase content
!c           r0                 = constant         
!c           r1                 = constant
!c           zout               = output for z-coordinate in terms
!c                                depth or elevation
!c
!c           integer*4:
!c           ----------
!c           inode               = counter (control volumes)
!c           l_sufx             = length of file suffix
!c           ioutdebug          = output toggle
!c
!c           character:
!c           ---------- 
!c           suffix             = file suffix
!c
!c external: velocity  = average interfacial velocities
!c           zoutput   = assign depth coordinate in terms of depth
!c                       or elevation
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine outputdd_usg
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen      
      use phys
      use dens
      use chem
      use writeversion
      use file_unit, only : lun_get, lun_free
      use biol


#ifdef OPENMP
      use omp_lib
#endif
#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use geometry
      use usg_mesh_data

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif

      
      integer :: i, i1, ic, itemp, im, inode, izn, ioutdebug, iprint,  &
                 istart, istop, icell, ixmf, offset, l_sufx, ierr

      real*8 :: rootwat, evapo, qroot, transp, soilevapo

      real*8 :: dvi, ddens, ddens_c, ddens_dt, ddens_temp,             &
                ddensreact_dt, ddensmix_dt, volnew, volold, stq,       &
                tempk1, tempk2, zoutput

      external zoutput, velodd_usg, velovapour_usg, rootwat, evapo,    &
      checkerr

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, eps=1.0d-300,       &
              r1000=1.0d3, rkelvin=273.15d0, zero=1.0d-5

      real*8, allocatable  :: ddens_dvi(:), totc(:), s_ice(:), s_water(:)

      character*5 :: suffix
      character*128 :: msg
      character*256 :: strbuffer
      character*256 :: strfilename, strfilename_result, strfilename_mesh

      logical          :: iserror

      real*8, allocatable :: ddens_dt_vols(:),ddensmix_dt_vols(:),     &
                             ddensreact_dt_vols(:),                    &
                             fhead_vols(:),phead_vols(:),              &
                             theta_a_vols(:),theta_n_vols(:),          &
                             theta_g_vols(:),actw_vols(:)
      real*8, allocatable :: ddens_dvi_vols(:,:)

      real*8 :: pressure_melt_k
      external :: pressure_melt_k

!c  assign file suffix for initial condition or current time step
!c  works for up to 999 output times

      rewind(icnv)

!c  logical variable for output format
!c  0 = identical format to non-density dependent flow
!c  1 = complete output

      ioutdebug = 1

!c flow verification output
      if (flow_verification) then
        ioutdebug = 0
      end if

      l_sufx = 0

      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then
          !Deprecated, use internal convert instead. DSU
          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if

        elseif (igstime.ge.10.and.igstime.lt.100) then

          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if

        elseif (igstime.ge.100.and.igstime.lt.1000) then

          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if

        elseif (igstime.gt.1000) then

          if (rank == 0) then
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputrt'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if
      end if

#ifdef PETSC_HDF
      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_separate_mesh_result .and. b_output_binary) then
        strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
      end if

      !c separate mesh data from results data
      if (b_output_separate_mesh_result .and. initial_condition .and.  &
          b_output_binary) then
        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_mesh, H5F_ACC_TRUNC_F, file_id,   &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        !c write mesh data
        call hdf5_usg_write_mesh_data(file_id)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=prefix(:l_prfx)//'_domain.xmf',               &
               status='unknown', form='formatted')

          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_rank","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_rank","Scalar","Cell",             &
                    num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","vertices_matid","Scalar","Node",       &
                      num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","cells_matid","Scalar","Cell",          &
                      num_cells_gbl,1)
          end if
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if

      end if
#endif

!cprovi------------------------------------------------------------------
!cprovi Compute and write the density components
!cprovi------------------------------------------------------------------
      if (issplitdens.and.time_io/=r0) then

        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.dens'

        if (b_output_binary) then
#ifdef PETSC_HDF
          strfilename_result = trim(strfilename)//'.h5'

          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.xmf',status='unknown', &
                 form='formatted')
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)

          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)
          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,        &
                           file_id, hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            strfilename_mesh = strfilename_result
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)

#endif
        else
          open(idens,file=trim(strfilename)//'.vtk',status='unknown',  &
               form='formatted')
        end if

        allocate (ddens_dvi(nm), stat = ierr)
        call checkerr(ierr,'ddens_dvi',ilog)
        ddens_dvi = 0.0d0
        call memory_monitor(sizeof(ddens_dvi),'ddens_dvi',.true.)

        allocate(ddens_dt_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'ddens_dt_vols',ilog)
        ddens_dt_vols = r0
        call memory_monitor(sizeof(ddens_dt_vols),'ddens_dt_vols',.true.)

        allocate(ddensmix_dt_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'ddensmix_dt_vols',ilog)
        ddensmix_dt_vols = r0
        call memory_monitor(sizeof(ddensmix_dt_vols),'ddensmix_dt_vols',.true.)

        allocate(ddensreact_dt_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'ddensreact_dt_vols',ilog)
        ddensreact_dt_vols = r0
        call memory_monitor(sizeof(ddensreact_dt_vols),'ddensreact_dt_vols',.true.)

        allocate(ddens_dvi_vols(nm,num_nodes), stat = ierr)
        call checkerr(ierr,'ddens_dvi_vols',ilog)
        ddens_dvi_vols = r0
        call memory_monitor(sizeof(ddens_dvi_vols),'ddens_dvi_vols',.true.)

        do inode = 1, num_nodes

          ddens_dt = (density(inode)-densold(inode))/delt
          ddensreact_dt=r0
          do im=1,nm
            istart = iam(im)
            istop = iam(im+1)-1
            if (phi(im,inode)>zero) then
              volnew = phi(im,inode)/pornew(inode)
            else
              volnew = zero
            end if
            if (phiold(im,inode)>zero) then
              volold = phiold(im,inode)/pornew(inode)
            else
              volold = zero
            end if
!cprovi--------------------------------------------------------
!cprovi Compute the changes in mol/lw
!cprovi--------------------------------------------------------
            dvi = r1000*(volnew-volold)*densm(im)/gfwm(im)
!cprovi--------------------------------------------------------
!cprovi Store the concentration vector for aqueous species
!cprovi--------------------------------------------------------
            cpz_loc(1:nc)=r0 ! cnew(1:nc,inode)
            cpz_loc(nc+1:nc+nx)= r0 ! cx(1:nx,inode)
!cprovi--------------------------------------------------------
!cprovi Compute the increment for dissolution/precipitation
!cprovi--------------------------------------------------------
            do i1 = istart,istop
              ic = jam(i1)
              stq = xnum(i1)
              cpz_loc(ic) = cpz_loc(ic) - stq * dvi
            end do
!cprovi--------------------------------------------------------
!cprovi Compute density
!cprovi--------------------------------------------------------

            if (ispitzerdens) then
              msg=' '
              call compute_density_ (phase,r0,r0,cpz_loc,ddens,      &
                                       .false.,iserror)
              if (iserror) then
                msg='Error when call compute_density_ in the phase object'
                write (ilog,*) msg
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if
            else
              allocate(totc(nc), stat = ierr)
              call checkerr(ierr,'outputdd_usg-totc',ilog)
              call memory_monitor(sizeof(totc),'totc',.true.)

              totc=r0
              call totconc(cpz_loc(1:nc),cpz_loc(nc+1:nc+nx),totc)
              totc=totcold(1:nc-1,inode)+totc(1:nc-1)
              tot_tds = r0
              do ic=1,nc-1
                itemp = ncorder(ic)
                if ((namec(itemp) .ne. 'h+').and.                &
                    (namec(itemp) .ne. 'h+1').and.               &
                    (namec(itemp) .ne. 'o2(aq)').and.            &
                    (namec(itemp) .ne. 'h2(aq)').and.            &
                    (namec(itemp) .ne. 'n2(aq)').and.            &
                    (namec(itemp) .ne. 'ch4(aq)')) then

                  if (specify_dd_comp) then
                    tds_ic = totc(itemp) * gfwdd(itemp)
                  else
                    tds_ic = totc(itemp) * gfwc(itemp)
                  end if

                    tot_tds = tot_tds + tds_ic
                end if
              end do

              ddens_c = drho_dc * (tot_tds - ref_tds)
              if ((heat_transport .or. temp_field) .and. nonlindens_heat) then
                  tempk1=tempref_dens+rkelvin
                  tempk2=tempnew(inode)+rkelvin
                  ddens_temp = cdens1+r1000*tempk1*(cdens2+tempk1* &
                             (cdens3-tempk1*cdens4))
                  ddens_temp = cdens1+r1000*tempk2*(cdens2+tempk2* &
                             (cdens3-tempk2*cdens4)) - ddens_temp
              else
                  ddens_temp = drho_dt*(tempnew(inode) - tempref_dens)
              end if
              call memory_monitor(-sizeof(totc),'totc',.true.)
              deallocate(totc)
              ddens = ref_dens + ddens_temp + ddens_c
            end if


            if (dvi/=r0) then
              ddens = ddens - densold(inode)
            else
              ddens = r0
            end if

            ddensreact_dt = ddensreact_dt + ddens
            ddens_dvi(im) = ddens / delt

          end do

          ddensreact_dt = ddensreact_dt / delt
          ddensmix_dt = ddens_dt - ddensreact_dt

          ddens_dt_vols(inode) = ddens_dt
          ddensmix_dt_vols(inode) = ddensmix_dt
          ddensreact_dt_vols(inode) = ddensreact_dt
          ddens_dvi_vols(1:nm,inode) = ddens_dvi(1:nm)

        end do

        if (.not. b_output_binary) then
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                     &
                "density components, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(idens, trim(adjustl(strbuffer)))
          write(idens,'(a,1x,i12)') "POINT_DATA",num_nodes
        end if

        !c write ddens_dt
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"ddens_dt",       &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,          &
                    ddens_dt_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","ddens_dt","Scalar","Node",            &
                      num_nodes_gbl,1)
          end if
#endif
        else
          write(idens,'(a)') "SCALARS ddens_dt double"
          write(idens,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(idens,ascii_fmt) ddens_dt_vols(inode)
          end do
        end if

        !c write ddensmix_dt
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"ddensmix_dt",    &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,          &
                    ddensmix_dt_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","ddensmix_dt","Scalar","Node",         &
                      num_nodes_gbl,1)
          end if
#endif
        else
          write(idens,'(a)') "SCALARS ddensmix_dt double"
          write(idens,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(idens,ascii_fmt) ddensmix_dt_vols(inode)
          end do
        end if

        !c write ddensreact_dt
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"ddensreact_dt",  &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,          &
                    ddensreact_dt_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","ddensreact_dt","Scalar","Node",       &
                      num_nodes_gbl,1)
          end if
#endif
        else
          write(idens,'(a)') "SCALARS ddensreact_dt double"
          write(idens,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(idens,ascii_fmt) ddensreact_dt_vols(inode)
          end do
        end if

        !c write ddensreact_dt
        if (b_output_binary) then
          allocate(realbuffer(num_nodes), stat = ierr)
          call checkerr(ierr,'outputdd_usg-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if

        do im = 1, nm
          if (b_output_binary) then
#ifdef PETSC_HDF
            do inode = 1, num_nodes
              realbuffer(inode) = ddens_dvi_vols(im,inode)
            end do
            call hdf5_usg_write_group_data_1d(group_id,                &
                      namem(im)(:l_namem(im)),num_nodes_loc,           &
                      num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results",                  &
                        namem(im)(:l_namem(im)),"Scalar","Node",       &
                        num_nodes_gbl,1)
            end if
#endif
          else
            write(idens,'(a,1x,a,1x,a)') "SCALARS",   &
                  namem(im)(:l_namem(im)),"double"
            write(idens,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(idens,ascii_fmt) ddens_dvi_vols(im,inode)
            end do
          end if
        end do

        if (b_output_binary) then
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer)
        end if

        call memory_monitor(-sizeof(ddens_dvi),'ddens_dvi',.true.)
        call memory_monitor(-sizeof(ddens_dt_vols),'ddens_dt_vols',.true.)
        call memory_monitor(-sizeof(ddensmix_dt_vols),'ddensmix_dt_vols',.true.)
        call memory_monitor(-sizeof(ddensreact_dt_vols),'ddensreact_dt_vols',.true.)
        call memory_monitor(-sizeof(ddens_dvi_vols),'ddens_dvi_vols',.true.)

        deallocate(ddens_dvi)
        deallocate(ddens_dt_vols)
        deallocate(ddensmix_dt_vols)
        deallocate(ddensreact_dt_vols)
        deallocate(ddens_dvi_vols)

        if (b_output_binary) then
#ifdef PETSC_HDF
          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          close(idens)
          !Keep the file unit, this will be used later
          !call lun_free(idens)
        end if

      end if

!cprovi------------------------------------------------------------------
!cprovi Compute and write the density components
!cprovi------------------------------------------------------------------
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsp'
        if (b_output_separate_mesh_result) then
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          strfilename_result = trim(strfilename)//'.h5'
        else
          strfilename_mesh = trim(strfilename)//'.h5'
          strfilename_result = trim(strfilename)//'.h5'
        end if
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsp'
      end if

!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsp,file=trim(strfilename)//'.vtk',status='unknown',     &
             form='formatted')
      end if
      
      if (rank == 0 .and. b_enable_output) then

        if (initial_condition) then

          write(ifls,'(/2a/72a)')'Flow variables, initial ',           &
                                 'condition',('-',i=1,72)
                                                                        
        elseif (steady_flow) then
                                                                        
          write(ifls,'(/2a/72a)')'Flow variables, steady ',            &
                                 'state solution',('-',i=1,72)
                                                                        
        else
                                                                        
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Flow variables, T = ',time_io,time_unit,('-',i=1,72)
                                                                        
        end if
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                            suffix(:l_sufx)//'.gsp.vtk'
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'
        write(ifls,'(2a)')                                             &
              '4        freshwater head                 ','m'
        write(ifls,'(2a)')                                             &
              '5        fluid pressure                  ','Pa'
        write(ifls,'(2a)')                                             &
              '6        pressure head                   ','m'
        write(ifls,'(2a)')                                             &
              '7        density                         ','kg/m^3'
        write(ifls,'(2a)')                                             &
              '8        water saturation                ','-'
        write(ifls,'(2a)')                                             &
              '9        water content                   ','-'
        if (variably_saturated) then
          write(ifls,'(2a)')                                           &
                '10        air saturation               ','-'
          write(ifls,'(2a)')                                           &
                '11        air content                  ','-'
          write(ifls,'(2a)')                                           &
                '12       root uptake rate              ','m^3/d'
        end if
      
      end if

!c debugging output for comparison to standard test files

!c  use same output fomat as non-density dependent flow simulations
!c  to compare results

      if (ioutdebug .eq. 0) then  !outputvs format - no fluid pressures

!c  ---------------------------------------------------------------------
!c  output outputvs format - no fluid pressures
!c  ---------------------------------------------------------------------
        allocate(fhead_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'fhead_vols',ilog)
        fhead_vols = r0
        call memory_monitor(sizeof(fhead_vols),'fhead_vols',.true.)

        allocate(phead_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'phead_vols',ilog)
        phead_vols = r0
        call memory_monitor(sizeof(phead_vols),'phead_vols',.true.)

        allocate(theta_a_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'theta_a_vols',ilog)
        theta_a_vols = r0
        call memory_monitor(sizeof(theta_a_vols),'theta_a_vols',.true.)

        if(variably_saturated) then
          allocate(theta_g_vols(num_nodes), stat = ierr)
          call checkerr(ierr,'theta_g_vols',ilog)
          theta_g_vols = r0
          call memory_monitor(sizeof(theta_g_vols),'theta_g_vols',.true.)
        end if

        if ((heat_transport .or. temp_field) .and. b_water_freezing) then
          allocate(s_ice(num_nodes), stat = ierr)
          call checkerr(ierr,'s_ice',ilog)
          s_ice = r0
          call memory_monitor(sizeof(s_ice),'s_ice',.true.)

          allocate(s_water(num_nodes), stat = ierr)
          call checkerr(ierr,'s_water',ilog)
          s_water = r0
          call memory_monitor(sizeof(s_water),'s_water',.true.)
        end if

!C----------Zone Data. Each variable is in data format asspecified above.

!c  loop over control volumes

        do inode = 1,num_nodes
!c  calculate freshwater heads

          phead_vols(inode) = uvsnew(inode)/(density(inode) * gacc)

          fhead_vols(inode) = phead_vols(inode) + zg(inode)

          theta_a_vols(inode) = pornew(inode) * sanew(inode)

          if (variably_saturated) then
            sgnew(inode) = r1 - sanew(inode)
            theta_g_vols(inode) = pornew(inode)*sgnew(inode)
          end if ! fully saturated

        end do  !inode = 1,num_nodes


!c  zone record for initial condition
        if (.not. b_output_binary) then
          if (initial_condition) then
            call write_mesh_data_vtk_ascii(igsp,                       &
                       "Flow variables, initial condition")
!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions
          elseif (.not.initial_condition) then
            if (steady_flow) then
              call write_mesh_data_vtk_ascii(igsp,                     &
                         "Flow variables, steady state")
            elseif (transient_flow) then
              write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                 &
                    "Flow variables, solution time = ",time_io,time_unit
              call write_mesh_data_vtk_ascii(igsp,                     &
                         trim(adjustl(strbuffer)))
            end if
          end if                    !(initial_condition)

          write(igsp,'(a,1x,i12)') "POINT_DATA",num_nodes
        end if

!c  common output for all type of flow

        !c write hydraulic head
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"h_w",            &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,fhead_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","h_w","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS h_w double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) fhead_vols(inode)
          end do
        end if

        !c write pressure head
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"ph_w",           &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,phead_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","ph_w","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS ph_w double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) phead_vols(inode)
          end do
        end if

        !c write water saturation
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"s_a",            &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,sanew)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","s_a","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS s_a double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) sanew(inode)
          end do
        end if

        !c write theta_a
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"theta_a",        &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,theta_a_vols)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","theta_a","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS theta_a double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) theta_a_vols(inode)
          end do
        end if

        if (fully_saturated .and. (heat_transport .or. temp_field)) then
          !c write temperature
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"temp_n",       &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,        &
                      tempnew)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","temp_n",         &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS temp_n double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) tempnew(inode)
            end do
          end if

          !c write viscosity
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"visco_n",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,        &
                      viscosity)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","visco_n",        &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS visco_n double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) viscosity(inode)
            end do
          end if

!c  calculate ice and water saturation when freezing/thawing are considered
          if (b_water_freezing) then
            do inode = 1, num_nodes
              if (tempnew(inode)+tconv > pressure_melt_k(inode,r0)) then
                s_ice(inode) = r0
                s_water(inode) = sanew(inode)
              else
                s_ice(inode) = sanew(inode)
                s_water(inode) = r0              
              end if
            end do

            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"s_ice",      &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        s_ice)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","s_ice",        &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS s_ice double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) s_ice(inode)
              end do
            end if

            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"s_water",    &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        s_water)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","s_water",      &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS s_water double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) s_water(inode)
              end do
            end if

          end if

        elseif (variably_saturated) then
          !c write gas saturation
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"s_g",          &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,        &
                      sgnew)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","s_g",            &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS s_g double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) sgnew(inode)
            end do
          end if

          !c write theta_g
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"theta_g",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,        &
                      theta_g_vols)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","theta_g",        &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS theta_g double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) theta_g_vols(inode)
            end do
          end if

          if (b_output_binary) then
            allocate(realbuffer(num_nodes), stat = ierr)
            call checkerr(ierr,'outputdd_usg-realbuffer',ilog)
            call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
          end if

          if (root_uptake .or. pure_evap) then
            if (b_output_binary) then
              !c total root water uptake
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if

                soilevapo = r0
                if (soilhydrfunc_field) then
                  if (h1dry_vol(inode).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                else
                  izn = mpropvs(inode)
                  if (h1dry(izn).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                end if

                realbuffer(inode) = transp + soilevapo
              end do
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"q_root",     &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","q_root",       &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS q_root double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if

                soilevapo = r0
                if (soilhydrfunc_field) then
                  if (h1dry_vol(inode).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                else
                  izn = mpropvs(inode)
                  if (h1dry(izn).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                end if

                qroot = transp + soilevapo
                write(igsp,ascii_fmt) qroot
              end do
            end if

            !c root water uptake
            if (b_output_binary) then
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if
                realbuffer(inode) = transp
              end do
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"rootwat",       &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,&
                          "results","rootwat","Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS rootwat double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if
                write(igsp,ascii_fmt) transp
              end do
            end if
          end if

!c soil evaporation
          if (b_output_binary) then
            do inode = 1, num_nodes
              soilevapo = r0
              if (soilhydrfunc_field) then
                if (h1dry_vol(inode).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              else
                izn = mpropvs(inode)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              end if
              realbuffer(inode) = soilevapo
            end do
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"soilevapo",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results","soilevapo","Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS soilevapo double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              soilevapo =r0
              if (soilhydrfunc_field) then
                if (h1dry_vol(inode).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              else
                izn = mpropvs(inode)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              end if
              write(igsp,ascii_fmt) soilevapo
            end do
          end if

          !c release buffer
          if (b_output_binary) then
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
          end if

        end if ! fully saturated

        call memory_monitor(-sizeof(fhead_vols),'fhead_vols',.true.)
        call memory_monitor(-sizeof(phead_vols),'phead_vols',.true.)
        call memory_monitor(-sizeof(theta_a_vols),'theta_a_vols',.true.)
        deallocate(fhead_vols)
        deallocate(phead_vols)
        deallocate(theta_a_vols)

        if(variably_saturated) then
          call memory_monitor(-sizeof(theta_g_vols),'theta_g_vols',.true.)
          deallocate(theta_g_vols)
        end if

        if ((heat_transport .or. temp_field) .and. b_water_freezing) then
          call memory_monitor(-sizeof(s_ice),'s_ice',.true.)
          deallocate(s_ice)

          call memory_monitor(-sizeof(s_water),'s_water',.true.)
          deallocate(s_water)
        end if

      end if !ioutputdebug = 0

!c  This output includes pressure, density, and NAPL saturation
!c  doesn't provide identical files for easy comparison
!c   with non-density dependent test cases

      if (ioutdebug .eq. 1) then

!c  ---------------------------------------------------------------------
!c  output outputdd format - fluid pressures, densities, and
!c  NAPL saturatons reported
!c  ---------------------------------------------------------------------
        allocate(fhead_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'fhead_vols',ilog)
        fhead_vols = r0
        call memory_monitor(sizeof(fhead_vols),'fhead_vols',.true.)

        allocate(phead_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'phead_vols',ilog)
        phead_vols = r0
        call memory_monitor(sizeof(phead_vols),'phead_vols',.true.)

        allocate(theta_a_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'theta_a_vols',ilog)
        theta_a_vols = r0
        call memory_monitor(sizeof(theta_a_vols),'theta_a_vols',.true.)

        allocate(theta_n_vols(num_nodes), stat = ierr)
        call checkerr(ierr,'theta_n_vols',ilog)
        theta_n_vols = r0
        call memory_monitor(sizeof(theta_n_vols),'theta_n_vols',.true.)

        if(variably_saturated) then
          allocate(theta_g_vols(num_nodes), stat = ierr)
          call checkerr(ierr,'theta_g_vols',ilog)
          theta_g_vols = r0
          call memory_monitor(sizeof(theta_g_vols),'theta_g_vols',.true.)

          allocate(actw_vols(num_nodes), stat = ierr)
          call checkerr(ierr,'actw_vols',ilog)
          actw_vols = r0
          call memory_monitor(sizeof(actw_vols),'actw_vols',.true.)
        end if

        if ((heat_transport .or. temp_field) .and. b_water_freezing) then
          allocate(s_ice(num_nodes), stat = ierr)
          call checkerr(ierr,'s_ice',ilog)
          s_ice = r0
          call memory_monitor(sizeof(s_ice),'s_ice',.true.)

          allocate(s_water(num_nodes), stat = ierr)
          call checkerr(ierr,'s_water',ilog)
          s_water = r0
          call memory_monitor(sizeof(s_water),'s_water',.true.) 
        end if

        do inode = 1,num_nodes

!c  calculate pressure and freshwater heads
          phead_vols(inode) = uvsnew(inode)/(density(inode) * gacc)
          fhead_vols(inode) = phead_vols(inode) * density(inode)/ref_dens + zg(inode)

          theta_a_vols(inode) = pornew(inode) * sanew(inode)
          theta_n_vols(inode) = pornew(inode) * snnew(inode)

          if (variably_saturated) then
            sgnew(inode) = r1 - sanew(inode)
            theta_g_vols(inode) = pornew(inode)*sgnew(inode)
            if (reactive_transport) then
              actw_vols(inode) = gamma(nc,inode)
            else
              actw_vols(inode) = r1
            end if
          end if

        end do ! inode = 1,num_nodes


!c  zone record for initial condition
        if (.not. b_output_binary) then
          if (initial_condition) then
            call write_mesh_data_vtk_ascii(igsp,                       &
                       "Flow variables, initial condition")
!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions

          elseif (.not.initial_condition) then

            if (steady_flow) then
              call write_mesh_data_vtk_ascii(igsp,                     &
                         "Flow variables, steady state")
            elseif (transient_flow) then
              write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                 &
                    "Flow variables, solution time = ",time_io,time_unit
              call write_mesh_data_vtk_ascii(igsp,                     &
                         trim(adjustl(strbuffer)))
            end if
          end if                    !(initial_condition)

          write(igsp,'(a,1x,i12)') "POINT_DATA",num_nodes
        end if

!c  common output for all type of flow

        !c write hydraulic head
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"fh_w",           &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,fhead_vols)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","fh_w","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS fh_w double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) fhead_vols(inode)
          end do
        end if

        !c write pressure p_w head
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"p_w",            &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,uvsnew)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","p_w","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS p_w double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) uvsnew(inode)
          end do
        end if

        !c write pressure ph_w head
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"ph_w",           &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,phead_vols)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","ph_w","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS ph_w double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) phead_vols(inode)
          end do
        end if

        !c write density
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"density",        &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,density)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","density","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS density double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) density(inode)
          end do
        end if

        !c write water saturation
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"s_a",            &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,sanew)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","s_a","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS s_a double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) sanew(inode)
          end do
        end if

        !c write theta_a
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"theta_a",        &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,theta_a_vols)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","theta_a","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS theta_a double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) theta_a_vols(inode)
          end do
        end if

        !c write s_n
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"s_n",            &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,snnew)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","s_n","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS s_n double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) snnew(inode)
          end do
        end if

        !c write theta_n
        if (b_output_binary) then
#ifdef PETSC_HDF
          call hdf5_usg_write_group_data_1d(group_id,"theta_n",        &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,theta_n_vols)
          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","theta_n","Scalar","Node",num_nodes_gbl,1)
          end if
#endif
        else
          write(igsp,'(a)') "SCALARS theta_n double"
          write(igsp,'(a)') "LOOKUP_TABLE default"
          do inode = 1, num_nodes
            write(igsp,ascii_fmt) theta_n_vols(inode)
          end do
        end if


        if (heat_transport .or. temp_field) then
          !c write temperature
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"temp_n",       &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,tempnew)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","temp_n",         &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS temp_n double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) tempnew(inode)
            end do
          end if

          !c write viscosity
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"visco_n",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,viscosity)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","visco_n",        &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS visco_n double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) viscosity(inode)
            end do
          end if

!c  calculate ice and water saturation when freezing/thawing are considered
          if (b_water_freezing) then
            do inode = 1, num_nodes
              if (tempnew(inode)+tconv > pressure_melt_k(inode,r0)) then
                s_ice(inode) = r0
                s_water(inode) = sanew(inode)
              else
                s_ice(inode) = sanew(inode)
                s_water(inode) = r0              
              end if
            end do

            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"s_ice",      &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        s_ice)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","s_ice",        &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS s_ice double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) s_ice(inode)
              end do
            end if

            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"s_water",    &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        s_water)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","s_water",      &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS s_water double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) s_water(inode)
              end do
            end if

          end if
        end if

        if (variably_saturated) then

          if (b_output_binary) then
            allocate(realbuffer(num_nodes), stat = ierr)
            call checkerr(ierr,'outputdd_usg-realbuffer',ilog)
            call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
          end if

          if (root_uptake .or. pure_evap) then
            !c total root water uptake
            if (b_output_binary) then
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if
                soilevapo = r0
                if (soilhydrfunc_field) then
                  if (h1dry_vol(inode).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                else
                  izn = mpropvs(inode)
                  if (h1dry(izn).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                end if
                realbuffer(inode) = transp + soilevapo
              end do
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"q_root",     &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","q_root",       &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS q_root double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if

                soilevapo = r0
                if (soilhydrfunc_field) then
                  if (h1dry_vol(inode).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                else
                  izn = mpropvs(inode)
                  if (h1dry(izn).gt.r0) then
                    soilevapo = cvol(inode)*evapo(sanew,inode)
                  end if
                end if
                qroot = transp + soilevapo
                write(igsp,ascii_fmt) qroot
              end do
            end if

            !c root water uptake
            if (b_output_binary) then
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if
                realbuffer(inode) = transp
              end do
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"rootwat",       &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,&
                          "results","rootwat","Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS rootwat double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                if (root_uptake) then
                  transp = cvol(inode)*rootwat(sanew,inode,rsum_vprop)
                else
                  transp = r0
                end if
                write(igsp,ascii_fmt) transp
              end do
            end if
          end if

!c soil evaporation
          if (b_output_binary) then
            do inode = 1, num_nodes
              soilevapo = r0
              if (soilhydrfunc_field) then
                if (h1dry_vol(inode).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              else
                izn = mpropvs(inode)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              end if
              realbuffer(inode) = soilevapo
            end do
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"soilevapo",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results","soilevapo","Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS soilevapo double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              soilevapo = r0
              if (soilhydrfunc_field) then
                if (h1dry_vol(inode).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              else
                izn = mpropvs(inode)
                if (h1dry(izn).gt.r0) then
                  soilevapo = cvol(inode)*evapo(sanew,inode)
                end if
              end if
              write(igsp,ascii_fmt) soilevapo
            end do
          end if

          !c release buffer
          if (b_output_binary) then
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
          end if

          !c write gas saturation
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"s_g",          &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,sgnew)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","s_g","Scalar",   &
                        "Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS s_g double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) sgnew(inode)
            end do
          end if

          !c write theta_g
          if (b_output_binary) then
#ifdef PETSC_HDF
            call hdf5_usg_write_group_data_1d(group_id,"theta_g",      &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,        &
                      theta_g_vols)
            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_result,"results","theta_g",        &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
#endif
          else
            write(igsp,'(a)') "SCALARS theta_g double"
            write(igsp,'(a)') "LOOKUP_TABLE default"
            do inode = 1, num_nodes
              write(igsp,ascii_fmt) theta_g_vols(inode)
            end do
          end if

          if ((heat_transport .or. temp_field) .and. evaporation) then
            !c write rho_v
            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"rho_v",      &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        densvnew)
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","rho_v",        &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS rho_v double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) densvnew(inode)
              end do
            end if

            !c write actw
            if (b_output_binary) then
#ifdef PETSC_HDF
              call hdf5_usg_write_group_data_1d(group_id,"actw",       &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        actw_vols)
              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","actw",         &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
#endif
            else
              write(igsp,'(a)') "SCALARS actw double"
              write(igsp,'(a)') "LOOKUP_TABLE default"
              do inode = 1, num_nodes
                write(igsp,ascii_fmt) actw_vols(inode)
              end do
            end if
          end if
        end if ! fully saturated

        call memory_monitor(-sizeof(fhead_vols),'fhead_vols',.true.)
        call memory_monitor(-sizeof(phead_vols),'phead_vols',.true.)
        call memory_monitor(-sizeof(theta_a_vols),'theta_a_vols',.true.)
        call memory_monitor(-sizeof(theta_n_vols),'theta_n_vols',.true.)

        deallocate(fhead_vols)
        deallocate(phead_vols)
        deallocate(theta_a_vols)
        deallocate(theta_n_vols)

        if(variably_saturated) then
          call memory_monitor(-sizeof(theta_g_vols),'theta_g_vols',.true.)
          call memory_monitor(-sizeof(actw_vols),'actw_vols',.true.)
          deallocate(theta_g_vols)
          deallocate(actw_vols)
        end if

        if ((heat_transport .or. temp_field) .and. b_water_freezing) then
          call memory_monitor(-sizeof(s_ice),'s_ice',.true.)
          deallocate(s_ice)
          call memory_monitor(-sizeof(s_water),'s_water',.true.)
          deallocate(s_water)
        end if

      end if !ioutputdebug = 1

!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsp)
      end if
      !Keep the file unit, this will be used later
      !call lun_free(igsp)

      if (.not.initial_condition) then
        iprint = 1
        call velodd_usg(iprint)

        if (evaporation) then
          call velovapour_usg
        end if
      end if


      return
      end
#endif
