!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/infheat_d_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

! ----------------------------------------------------------------------
! subroutine infheat_d_usg
! -------------------                                                   
!                                                                       
! compute influence coefficients for heat transport for USG
!
! written by:      Danyang Su - Aug 08, 2016
!
! last modified:
! definition of variables:                                              
!                                                                       
! I --> on input   * arbitrary  - initialized  + entries expected       
! O --> on output  * arbitrary  - unaltered    + altered                
!                                                                    I O
!     input:                                                            
!                                                                       
! passed:   real*8:                                                     
!           -------                                                     
!                                                                       
!                                                                       
! local:                                                                
!                                                                       
! external: diffcoff  = compute effective diffusion coefficient         

! ----------------------------------------------------------------------
#ifdef USG
      subroutine infheat_d_usg

#ifdef OPENMP
      use omp_lib
#endif
      use gen, only :                                                  &
#ifdef OPENMP
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infheat_d_1,                    &
#endif
                      iavs, javs, nngl, isymvs, cinfvs, gacc,          &
                      pornew, sanew, uvsnew, relperm,                  &
                      jacell, janumcell, jaedgelen,                    &
                      jacrossdiffweight, jaedgeunitdirection,          &
                      jacrossdifficv, jacrossdifficvnum,               &
                      useAnisoHeatDispCorr, b_grad_interpolate_cell,   &
                      idbg, ilog, rank, b_enable_output
      use dens, only : density, viscosity, av_dens_z

      use m_heat_transport, only : cinfheat_d, disheatx, disheaty,     &
                 disheatz, ups_heat

      use phys, only : is_cell_based_disp_heat, is_cell_based_relp,    &
                       aca_vol

      use geometry

      use usg_mesh_data, only : nodes, cells, cell_type,num_cells,     &
                                grad_method, num_edge_dvols,           &
                                num_edge_maxcells, num_edges_per_cell, &
                                cell_projection, CellCvolFaceArea,     &
                                CellCvolFaceUnitNorm,                  &
                                CellCvolFace_heat_d,                   &
                                CellCvolFace_heat_d_tensor,            &
                                get_cell_edge_cvol_id

      use usg_face_utility, only : usg_face_utility_vel_heat_d
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
                                                                        
      implicit none 

!     local variables                                                   
                                                                        
      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0,  &
                 r1 = 1.0d0, r2 = 2.0d0, rsmallarea = 1.0d-8,          &
                 rverysmall = 1.0d-100
                                                                        
      real*8 :: vmag,vmag2,disx_avg,disy_avg,disz_avg,                 &
                disxy_avg,disxz_avg,disyz_avg,                         &
                delp_dd,delz_dd,rho_av,div,cvolfacearea, rswitch

      real*8 :: flux_ddflow_hls_corr(num_edge_dvols,num_edge_maxcells)
      type(point) :: vel, vxyz2, tend, wtend, utend, vtend, ntend,     &
                     cond, grad_ddflow_loc, grad_ddflow_ivol,          &
                     grad_ddflow_jvol, grad_ddflow_kvol,               &
                     grad_ddflow_mids(num_edge_dvols,num_edge_maxcells)

      real*8 :: disxyz_avg_direct,disxyz_avg_cross, alpha, beta


      integer :: i, i2, ivol, jvol, istart, iend, jtemp1, jtemp2,      &
                 icell, icell1, icell2, iedge, idvol, idvol_r,         &
                 iedge_r, kvol, info_debug
      type(point) :: aca_av, velsloc(num_edge_dvols)
      type(tensor) :: tenf, rml, rmr

                                                                        
!c  compute influence coefficients for advective flux terms
!c  (influence coefficients are equal Darcy flux = J_ij/A_ij)

      info_debug = 0

!c  calculate influence coefficient based on mesh cells

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (num_cells > numofloops_thred_infheat_d_1)               &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(icell, icell1, iedge, ivol, istart, iend,           &
    !$omp idvol, idvol_r, iedge_r, jvol, jtemp1, jtemp2,              &
    !$omp cvolfacearea, disx_avg, disy_avg, disz_avg,                 &
    !$omp rswitch, vmag, vxyz2,                                       &
    !$omp tenf, rml, rmr, aca_av, disxy_avg, disxz_avg, disyz_avg,    &
    !$omp vel, velsloc, tend, ntend, wtend, utend, vtend)
    !$omp do schedule(static)
#endif 
      do icell = 1, num_cells         !c loop over cells

!c  set zero vector to relative variables
        vel = vector_zero
        tend = vector_zero

!c  find ivol-jvol pair for the cell and calculate velocity component for this cell
        if (cell_type == cell_type_tri .or. cell_type == cell_type_quad) then
          do iedge = 1, num_edges_per_cell  !c loop over cell edges
            if (cell_type == cell_type_tri) then
              ivol = cells(edge_node_mapping_tri(1,iedge),icell)
              jvol = cells(edge_node_mapping_tri(2,iedge),icell)
            else if (cell_type == cell_type_quad) then
              ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
              jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
            end if

            !get the jtemp1 value
            istart = iavs(ivol)+1
            iend = iavs(ivol+1)-1
            do jtemp1 = istart, iend       !c loop over connections
              if(jvol == javs(jtemp1)) then
                exit
              end if
            end do
          end do
        else if (cell_type == cell_type_tetra .or.                     &
                 cell_type == cell_type_hexa .or.                      &
                 cell_type == cell_type_prism) then
          do iedge = 1, num_edges_per_cell

            if (cell_type == cell_type_tetra) then
              ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
              jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
            else if (cell_type == cell_type_hexa) then
              ivol = cells(edge_node_mapping_hexa(1,iedge),icell)
              jvol = cells(edge_node_mapping_hexa(2,iedge),icell)
            else if (cell_type == cell_type_prism) then
              ivol = cells(edge_node_mapping_prism(1,iedge),icell)
              jvol = cells(edge_node_mapping_prism(2,iedge),icell)
            end if

            !get the jtemp1 value
            istart = iavs(ivol)+1
            iend = iavs(ivol+1)-1
            do jtemp1 = istart, iend       !c loop over connections
              if(jvol == javs(jtemp1)) then
                exit
              end if
            end do

            !get the cell index of jacell
            icell1 = 0
            do icell1 = 1, janumcell(jtemp1)
              if (jacell(icell1,jtemp1) == icell) then
                exit
              end if
            end do

          end do
        end if


!c  find ivol-jvol pair for the cell and calculate influence coefficient
!c  jtemp1 is the index for edge ivol-jvol and jtemp2 is the index for edge jvol-ivol
        do iedge = 1, num_edges_per_cell
          if (cell_type == cell_type_tri) then
            ivol = cells(edge_node_mapping_tri(1,iedge),icell)
            jvol = cells(edge_node_mapping_tri(2,iedge),icell)
          else if (cell_type == cell_type_quad) then  
            ivol = cells(edge_node_mapping_quad(1,iedge),icell)
            jvol = cells(edge_node_mapping_quad(2,iedge),icell)
          else if (cell_type == cell_type_tetra) then  
            ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
            jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
          else if (cell_type == cell_type_hexa) then
            ivol = cells(edge_node_mapping_hexa(1,iedge),icell)
            jvol = cells(edge_node_mapping_hexa(2,iedge),icell)
          else if (cell_type == cell_type_prism) then
            ivol = cells(edge_node_mapping_prism(1,iedge),icell)
            jvol = cells(edge_node_mapping_prism(2,iedge),icell)
          end if

          ! get the jtemp1 value
          istart = iavs(ivol)+1
          iend = iavs(ivol+1)-1
          do jtemp1 = istart, iend       !c loop over connections
            if(jvol == javs(jtemp1)) then
              exit
            end if
          end do

          ! get the icell1 value
          do icell1 = 1, janumcell(jtemp1)
            if (jacell(icell1,jtemp1) == icell) then
              exit
            end if
          end do

          ! get the jtemp2 value, which is symmetr
          istart = iavs(jvol)+1
          iend = iavs(jvol+1)-1
          do jtemp2 = istart, iend       !c loop over connections
            if(ivol == javs(jtemp2)) then
              exit
            end if
          end do

          ! get the icell2 value, this value can be same as icell1 after further optimization in javs
          do icell2 = 1, janumcell(jtemp2)
            if (jacell(icell2,jtemp2) == icell) then
              exit
            end if
          end do

          !c calculate control face velocity
          call usg_face_utility_vel_heat_d(ivol,jvol,icell1,jtemp1,velsloc)

!cdsu get rotation angle for anisotropic thermal dispersivity correction
          if (useAnisoHeatDispCorr) then
            aca_av = (aca_vol(ivol) + aca_vol(jvol))*rhalf
            call geometry_cal_rotation_matrix(aca_av,rml,rmr)
          end if

!c  calculate average dispersivities for the "pseudo
!c  dispersion element"
          if (is_cell_based_disp_heat) then
            disx_avg = disheatx(icell)
            disy_avg = disheaty(icell)
            disz_avg = disheatz(icell)
          else
            disx_avg = (disheatx(ivol)+disheatx(jvol))*0.5d0
            disy_avg = (disheaty(ivol)+disheaty(jvol))*0.5d0
            disz_avg = (disheatz(ivol)+disheatz(jvol))*0.5d0
          end if

          do idvol = 1, num_edge_dvols
            call get_cell_edge_cvol_id(idvol,ivol,jvol,icell,          &
                                       idvol_r,iedge_r,rswitch)
            cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell)
            
            if(jacell(icell1,jtemp1) > 0 .and. cvolfacearea > rsmallarea) then
!c  calculate the dispersion tensor for the "pseudo dispersion element"
!c  average porosity of the element
              vel = velsloc(idvol)
              vmag = sqrt(vel%x**2 + vel%y**2 + vel%z**2)

              vxyz2 = math_common_set_vector(vel%x**2/(vmag + eps),       &
                          vel%y**2/(vmag + eps),vel%z**2/(vmag + eps))

!c  calculate the influence coefficient for the specified icell1, icell2, jtemp1, jtemp2

              if (useAnisoHeatDispCorr) then
                !c get principle dispersivity
                tenf%xx = disx_avg
                tenf%yy = disy_avg
                tenf%zz = disz_avg

                tenf = (rml.dot.tenf).dot.rmr

                disx_avg = tenf%xx
                disy_avg = tenf%yy
                disz_avg = tenf%zz
                disxy_avg = tenf%xy
                disxz_avg = tenf%xz
                disyz_avg = tenf%yz

                !c calculate dispersion terms
                tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+      &
                          disz_avg*vxyz2%z
                tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+      &
                          disz_avg*vxyz2%z
                tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+      &
                          disx_avg*vxyz2%z
                tenf%xy = disxy_avg*vel%x*vel%y/(vmag+eps)
                tenf%yx = tenf%xy
                tenf%xz = disxz_avg*vel%x*vel%z/(vmag+eps)
                tenf%zx = tenf%xz
                tenf%yz = disyz_avg*vel%y*vel%z/(vmag+eps)
                tenf%zy = tenf%yz

                !c save dispersion tensor
                CellCvolFace_heat_d_tensor(idvol_r,iedge_r,icell) = tenf
              else
                tend = math_common_set_vector(disx_avg*vxyz2%x+           &
                       disy_avg*vxyz2%y+disz_avg*vxyz2%z,              &
                                         disy_avg*vxyz2%x+             &
                       disx_avg*vxyz2%y+disz_avg*vxyz2%z,              &
                                         disz_avg*vxyz2%x+             &
                       disz_avg*vxyz2%y+disx_avg*vxyz2%z)

                !c save dispersion tensor
                CellCvolFace_heat_d(idvol_r,iedge_r,icell) = tend
              end if

            end if

          end do
        
        end do

      end do                        !c loop over cells
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      return
      end
#endif
