!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/darcy_energybal_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c module mod_darcy_energybal_usg
!c ----------------------
!c
!c compute energy flux for heat transport
!c
!c written by:      Danyang Su - Aug. 8, 2016
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c
!c           logical:
!c           --------
!c
!c           character:
!c           ----------
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c
!c external: -
!c ----------------------------------------------------------------------
#ifdef USG
    module mod_darcy_energybal_usg

    implicit none

    contains
  
    !c calculate flux term
    real*8 function darcy_energybal_usg(dp1,dp2,ndvol,ncell,           &
                          grad_mids, flux_corr,                        &
                          dens_ivol,dens_jvol,visco_ivol,visco_jvol,   &
                          bcellbased,nrelp,relps,cinfvs,               &
                          cinfvs_cross,ups_fac,isboussinesq)
 
      use geometry
      use mod_fluxdd_usg

      implicit none

      real*8, intent(in)     :: dp1                      ! delta pressure
      real*8, intent(in)     :: dp2                      ! delta pressure
      integer, intent(in)    :: ndvol                    ! number of linked dual volume interface for each cell
      integer, intent(in)    :: ncell                    ! number of linked cells
      type(point), intent(in):: grad_mids(ndvol,ncell)   ! interface gradient
      real*8, intent(in)     :: flux_corr(ndvol,ncell)   ! flux correction using high order taylor's expansion
      real*8, intent(in)     :: dens_ivol                ! density ivol
      real*8, intent(in)     :: dens_jvol                ! density jvol
      real*8, intent(in)     :: visco_ivol               ! viscosity ivol
      real*8, intent(in)     :: visco_jvol               ! viscosity jvol
      logical, intent(in)    :: bcellbased               ! use cell based relative permeability or not
      integer, intent(in)    :: nrelp                    ! number of input relative permeability
      real*8, intent(in)     :: relps(nrelp)             ! relative permeability for ivol, jvol or linkded cells
      real*8, intent(in)     :: ups_fac                  ! upstream factor
      real*8, intent(in)     :: cinfvs(ndvol,ncell)      ! influence coefficients for the linked interfacial
      type(point), intent(in):: cinfvs_cross(ndvol,ncell)! influence coefficient for the linked interfacial (cross diffusion term)
      logical, intent(in)    :: isboussinesq             !

      real*8 :: relperm_av,visco_av,rho_av,coeff,                      &
                visco_md,dens_md, visco_loc
      real*8, parameter      :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0


      visco_md   = rhalf*(visco_ivol+visco_jvol)
      dens_md     = rhalf*(dens_ivol+dens_jvol)

      if (isboussinesq) then
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
        end if
        if (.not.bcellbased) then
          coeff = relperm_av / visco_av
        else
          visco_loc = visco_av
        end if
      else
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
          rho_av = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
          rho_av = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
        end if

        if (.not.bcellbased) then
          coeff  = relperm_av * rho_av / visco_av
        else
          visco_loc = visco_av / rho_av
        end if
      end if

      if (bcellbased) then
        darcy_energybal_usg = -fluxdd_usg(dp2,ndvol,ncell,grad_mids,   &
                                      flux_corr,cinfvs,cinfvs_cross,   &
                                      bcellbased,ncell,relps/visco_loc)
      else
        darcy_energybal_usg = -fluxdd_usg(dp2,ndvol,ncell,grad_mids,   &
                                      flux_corr,cinfvs,cinfvs_cross,   &
                                      bcellbased,1,(/coeff/))
      end if

      return
    end function darcy_energybal_usg

    !c calculate velocity term
    type(point) function darcy_energybal_vel_usg_tend(dp1,dp2,ndvol,ncell,  &
                         dens_ivol,dens_jvol,visco_ivol,visco_jvol,         &
                         bcellbased,nrelp,relps,ups_fac,isboussinesq,       &
                         cond_mid,grad_mid)

      use geometry
      use mod_fluxdd_usg

      implicit none

      real*8, intent(in)     :: dp1                      ! delta pressure
      real*8, intent(in)     :: dp2                      ! delta pressure
      integer, intent(in)    :: ndvol                    ! number of linked dual volume interface for each cell
      integer, intent(in)    :: ncell                    ! number of linked cells
      real*8, intent(in)     :: dens_ivol                ! density ivol
      real*8, intent(in)     :: dens_jvol                ! density jvol
      real*8, intent(in)     :: visco_ivol               ! viscosity ivol
      real*8, intent(in)     :: visco_jvol               ! viscosity jvol
      logical, intent(in)    :: bcellbased               ! use cell based relative permeability or not
      integer, intent(in)    :: nrelp                    ! number of input relative permeability
      real*8, intent(in)     :: relps(nrelp)             ! relative permeability for ivol, jvol or linkded cells
      real*8, intent(in)     :: ups_fac                  ! upstream factor
      logical, intent(in)    :: isboussinesq             !
      type(point), intent(in):: cond_mid, grad_mid

      real*8 :: relperm_av,visco_av,rho_av,coeff,                      &
                visco_md,dens_md, visco_loc
      real*8, parameter :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0

      visco_md   = rhalf*(visco_ivol+visco_jvol)
      dens_md     = rhalf*(dens_ivol+dens_jvol)

      if (isboussinesq) then
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
        end if
        if (.not.bcellbased) then
          coeff = relperm_av / visco_av
        else
          visco_loc = visco_av
        end if
      else
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
          rho_av = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
          rho_av = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
        end if
        if (.not.bcellbased) then
          coeff  = relperm_av * rho_av / visco_av
        else
          visco_loc = visco_av / rho_av
        end if
      end if

      if (bcellbased) then
        darcy_energybal_vel_usg_tend = -fluxdd_vel_usg_tend(relps(1)/visco_loc,&
                                                            cond_mid,grad_mid)
      else
        darcy_energybal_vel_usg_tend = -fluxdd_vel_usg_tend(coeff,cond_mid,grad_mid)
      end if

      return
    end function darcy_energybal_vel_usg_tend

    !c calculate velocity term
    type(point) function darcy_energybal_vel_usg_tenf(dp1,dp2,ndvol,ncell,  &
                         dens_ivol,dens_jvol,visco_ivol,visco_jvol,         &
                         bcellbased,nrelp,relps,ups_fac,isboussinesq,       &
                         conf_mid,grad_mid)

      use geometry
      use mod_fluxdd_usg

      implicit none

      real*8, intent(in)     :: dp1                      ! delta pressure
      real*8, intent(in)     :: dp2                      ! delta pressure
      integer, intent(in)    :: ndvol                    ! number of linked dual volume interface for each cell
      integer, intent(in)    :: ncell                    ! number of linked cells
      real*8, intent(in)     :: dens_ivol                ! density ivol
      real*8, intent(in)     :: dens_jvol                ! density jvol
      real*8, intent(in)     :: visco_ivol               ! viscosity ivol
      real*8, intent(in)     :: visco_jvol               ! viscosity jvol
      logical, intent(in)    :: bcellbased               ! use cell based relative permeability or not
      integer, intent(in)    :: nrelp                    ! number of input relative permeability
      real*8, intent(in)     :: relps(nrelp)             ! relative permeability for ivol, jvol or linkded cells
      real*8, intent(in)     :: ups_fac                  ! upstream factor
      logical, intent(in)    :: isboussinesq             !
      type(tensor), intent(in) :: conf_mid 
      type(point), intent(in):: grad_mid

      real*8 :: relperm_av,visco_av,rho_av,coeff,                      &
                visco_md,dens_md, visco_loc
      real*8, parameter :: r0=0.0d0, r1=1.0d0, rhalf=0.5d0

      visco_md   = rhalf*(visco_ivol+visco_jvol)
      dens_md     = rhalf*(dens_ivol+dens_jvol)

      if (isboussinesq) then
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
        end if
        if (.not.bcellbased) then
          coeff = relperm_av / visco_av
        else
          visco_loc = visco_av
        end if
      else
        if (dp1 > r0) then
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(2)+(r1-ups_fac)*relps(1)
          end if
          visco_av = ups_fac*visco_jvol+(r1-ups_fac)*visco_ivol
          rho_av = ups_fac*dens_jvol+(r1-ups_fac)*dens_ivol
        else
          if (.not.bcellbased) then
            relperm_av = ups_fac*relps(1)+(r1-ups_fac)*relps(2)
          end if
          visco_av = ups_fac*visco_ivol+(r1-ups_fac)*visco_jvol
          rho_av = ups_fac*dens_ivol+(r1-ups_fac)*dens_jvol
        end if
        if (.not.bcellbased) then
          coeff  = relperm_av * rho_av / visco_av
        else
          visco_loc = visco_av / rho_av
        end if
      end if

      if (bcellbased) then
        darcy_energybal_vel_usg_tenf = -fluxdd_vel_usg_tenf(relps(1)/visco_loc,&
                                                            conf_mid, grad_mid)
      else
        darcy_energybal_vel_usg_tenf = -fluxdd_vel_usg_tenf(coeff,conf_mid,grad_mid)
      end if

      return
    end function darcy_energybal_vel_usg_tenf

    end module mod_darcy_energybal_usg
#endif
