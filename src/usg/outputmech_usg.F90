!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/outputmech_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputmech_usg
!c -------------------
!c
!c write contour data for mechanical variables to output 
!c file for unstructured mesh
!c
!c written by:      Danyang Su - Jul 7, 2020
!c
!c last modified:   
!c
!c                  Danyang Su - Jul 7, 2020
!c                  HPC capabilities
!c
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine outputmech_usg
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
      use biol
      use phys
      use writeversion
      use dens, only : density_dependence, density
      use file_unit, only : lun_get, lun_free
#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      use geometry
      use usg_mesh_data

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif
      
      integer :: i, icell, inode, ixmf, l_sufx, ierr
      
      type(point) :: grad

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rm1 = -1.0d0

      character*5 :: suffix
      character*256 :: strbuffer
      character*256 :: strfilename, strfilename_result, strfilename_mesh

      external :: checkerr

      l_sufx = 0

      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then

          !write(icnv,'(i1)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if

        elseif (igstime.ge.10.and.igstime.lt.100) then

          !write(icnv,'(i2)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if

        elseif (igstime.ge.100.and.igstime.lt.1000) then

          !write(icnv,'(i3)') igstime
          !rewind(icnv)
          !read(icnv,'(a3)') suffix
          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if

        elseif (igstime.gt.1000) then
          if (rank == 0) then
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if
      end if

      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsmech'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsmech'
      end if

      !c separate mesh data from results data
#ifdef PETSC_HDF
      if (b_output_separate_mesh_result .and. initial_condition .and.  &
          b_output_binary) then
        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_mesh, H5F_ACC_TRUNC_F, file_id,   &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        !c write mesh data
        call hdf5_usg_write_mesh_data(file_id)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=prefix(:l_prfx)//'_domain.xmf',               &
               status='unknown', form='formatted')

          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_rank","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_rank","Scalar","Cell",             &
                    num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","vertices_matid","Scalar","Node",       &
                      num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","cells_matid","Scalar","Cell",          &
                      num_cells_gbl,1)
          end if
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
      end if
#endif

!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then

#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsmech,file=trim(strfilename)//'.vtk',status='unknown',  &
             form='formatted')
      end if
      
      if (rank == 0) then
                                                                       
        if (initial_condition) then
                                                                         
          write(ifls,'(/2a/72a)')'Mechanical variables, initial ',     &
                                 'condition',('-',i=1,72)                                                                        
                                                         
        else
                                                                        
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
            'Mechanical variables, T = ',time_io,time_unit,('-',i=1,72)
                                                                        
        end if
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                            suffix(:l_sufx)//'.gsmech.vtk'
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        storage coefficient             ','1/m'           
        write(ifls,'(2a)')                                             &
              '5        skempton coefficient            ','-'           
        write(ifls,'(2a)')                                             &
              '6        loading efficiency coefficient  ','-'           
        write(ifls,'(2a)')                                             &
              '7        pore stress                     ','-'
        write(ifls,'(2a)')                                             &
              '8        porosity                        ','-'      
      end if

      !c allocate buffer
      if (b_output_binary) then
        allocate(realbuffer(num_nodes), stat = ierr)
        call checkerr(ierr,'outputmech_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
      end if

!c  title and mesh variables
      if (.not. b_output_binary) then
        if (initial_condition) then
          call write_mesh_data_vtk_ascii(igsmech,                      &
                     "Mechanical variables, initial condition")
        else
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                     &
            "Mechanical variables, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(igsmech,trim(adjustl(strbuffer)))
        end if
        write(igsmech,'(a,1x,i12)') "POINT_DATA",num_nodes
      end if

      !c write storage coefficient
      if (b_output_binary) then
#ifdef PETSC_HDF
        if (density_dependence) then
          realbuffer = stor*density*gacc
        else
          realbuffer = stor
        end if
        call hdf5_usg_write_group_data_1d(group_id,                    &
                  "storage_coefficient",num_nodes_loc,num_nodes_gbl,   &
                  offset_nodes,realbuffer)

        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","storage_coefficient","Scalar","Node",   &
                    num_nodes_gbl,1)
        end if
#endif
      else
        write(igsmech,'(a)') "SCALARS storage_coefficient double"
        write(igsmech,'(a)') "LOOKUP_TABLE default"
        if (density_dependence) then
          do inode = 1, num_nodes
            write(igsmech,ascii_fmt) stor(inode)*density(inode)*gacc
          end do
        else
          do inode = 1, num_nodes
            write(igsmech,ascii_fmt) stor(inode)
          end do
        end if
      end if

      !c write Skempton's coefficient
      if (b_output_binary) then
#ifdef PETSC_HDF
        call hdf5_usg_write_group_data_1d(group_id,                    &
                  "skempton_coefficient",num_nodes_loc,num_nodes_gbl,  &
                  offset_nodes,skempton)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","skempton_coefficient","Scalar","Node",  &
                    num_nodes_gbl,1)
        end if
#endif
      else
        write(igsmech,'(a)') "SCALARS skempton_coefficient double"
        write(igsmech,'(a)') "LOOKUP_TABLE default"
        do inode = 1, num_nodes
          write(igsmech,ascii_fmt) skempton(inode)
        end do
      end if

      !c write loading efficiency coefficient
      if (b_output_binary) then
#ifdef PETSC_HDF
        realbuffer = skempton*loading_factor
        call hdf5_usg_write_group_data_1d(group_id,                    &
                  "loading_coefficient",num_nodes_loc,num_nodes_gbl,   &
                  offset_nodes,realbuffer)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","loading_coefficient","Scalar","Node",   &
                    num_nodes_gbl,1)
        end if
#endif
      else
        write(igsmech,'(a)') "SCALARS loading_coefficient double"
        write(igsmech,'(a)') "LOOKUP_TABLE default"
        do inode = 1, num_nodes
          write(igsmech,ascii_fmt) skempton(inode)*loading_factor(inode)
        end do
      end if

!      !c write por stress, exclude: "por_stress"
!      if (b_output_binary) then
!#ifdef PETSC_HDF
!        call hdf5_usg_write_group_data_1d(group_id,"por_stress",       &
!                  num_nodes_loc,num_nodes_gbl,offset_nodes,por_stress)
!        if (rank == 0) then
!          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
!                    "results","por_stress","Scalar","Node",            &
!                    num_nodes_gbl,1)
!        end if
!#endif
!      else
!        write(igsmech,'(a)') "SCALARS por_stress double"
!        write(igsmech,'(a)') "LOOKUP_TABLE default"
!        do inode = 1, num_nodes
!          write(igsmech,ascii_fmt) por_stress(inode)
!        end do
!      end if

      !c write porosity
      if (b_output_binary) then
#ifdef PETSC_HDF
        call hdf5_usg_write_group_data_1d(group_id,"porosity",         &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,pornew)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","porosity","Scalar","Node",              &
                    num_nodes_gbl,1)
        end if
#endif
      else
        write(igsmech,'(a)') "SCALARS porosity double"
        write(igsmech,'(a)') "LOOKUP_TABLE default"
        do inode = 1, num_nodes
          write(igsmech,ascii_fmt) pornew(inode)
        end do
      end if

      !c release buffer
      if (b_output_binary) then
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
      end if

!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsmech)
      end if

      return
      end
#endif
