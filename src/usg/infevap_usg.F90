!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/infevap_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine infcrtdd
!c -------------------
!c
!c compute influence coefficients for evaporation
!c
!c from Tom Henderson - July 11, 2003
!c
!c  written by:      Danyang Su - Aug 04, 2016
!c
!c  last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c     input:
!c
!c passed:   real*8:
!c           -------
!c           d(3, ibk)          = dimension of cells in x,y,z         + -
!c                                direction
!c           density(nn)        = fluid density                       + -
!c           dvolcoef           = volume flux coefficient including   * +
!c                                viscosity and relative permeability
!c           diffv0             = phase molecular diffusion (m2/day)
!c           disx(nzn)          = dispersion, x direction (m)
!c           disy(nzn)          =    "      , y    "      (m)
!c           disz(nzn)          =    "      , z    "      (m)
!c           cinfrt_va()        = influence coefficients
!c                                J^w_ij/A_ij
!c                                (advective flux terms)
!c           cinfrt_da()        = influence coefficients
!c                                D_ij * A_ij / d_ij
!c                                (dispersvie flux terms)
!c           viscosity(nn)      = fluid viscosity                     - -
!c
!c           integer*4:
!c           ----------
!c           ibk                = block i
!c           id                 = connected block j
!c           idbg               = output for debugging information
!c           ilog               = unit number, logbook
!c           nngl               = max cells for dim purposes
!c           nphas              = max number of phases
!c           njavs              = max dim javs array (ncomp.com)
!c           nvx                = number of control volumes
!c                                in x direction
!c           nvy                = number of control volumes
!c                                in y direction
!c           nvz                = number of control volumes
!c                                in z direction
!c           pornew(ibk)        = porosity
!c           sanew(nngl)        = aqueous phase saturation
!c                                - new time level
!c           uvsnew(nngl)       = pressure
!c           relperm(nngl)      = rel permeability
!c           cinfvs(nngl)       = influence coefficient
!c                                (variably saturated flow)
!c           iavs(), javs()         = ysmp pointers
!c           isymvs(ii)         = symmetry pointer for cell ibk
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions
!c           variably_saturated = .true.  -> .not.fully_saturated,
!c                                        -> variably saturated
!c                                           conditions
!c           half_cells         = .true.  -> half cells on boundary
!c           tortuosity_corr    = .true.  -> Millington-Quirk
!c                                           tortuosity correction
!c                                           for diffusion
!c                                           coefficients
!c
!c
!c
!c local:
!c
!c external: diffcoff  = compute effective diffusion coefficient
!c           fluxdd    = flux function for fully saturated flow
!c --------------------------------------------------------------------------

#ifdef USG
      subroutine infevap_usg
     
#ifdef OPENMP
      use omp_lib 
#endif
      use gen, only :                                                  &
#ifdef OPENMP
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infevap_1,                      &
#endif
                      iavs, javs, isymvs, nngl,                        &
                      pornew, sanew, tortuosity_corr,                  &
                      assigned_tau, tau, type_tortuosity, marchies,    &
                      cinfrad, radial_coord, gacc, tau_fac,            &
                      jacell, jaedgeunitdirection,jaedgelen, janumcell,&
                      idbg, ilog, rank, b_enable_output

      use m_heat_transport, only :  ddensvdpa, ddensvdt, tempnew,      &
                 diffv0, isenhfactor, fclay_nabla, coeff_t_usg,        &
                 cte_nabla, nabla_qhv, split_divdensv, gainwt,         &
                 dsurftensdt, gammaw0, cinfvs_t

      use dens, only : density, ref_dens

      use geometry

      use usg_mesh_data, only : nodes, cells, cell_type, cvol_method,  &
                                num_edge_dvols, num_edge_maxcells,     &
                                num_nodes_per_cell,                    &
                                cell_projection, CellCvolFaceArea,     &
                                CellCvolFaceUnitNorm,                  &
                                CellCvolFace_evap_pa,                  &
                                CellCvolFace_evap_t,                   &
                                get_cell_edge_cvol_id
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
!c     local variables
      real*8 :: ddensvdpa_av, ddensvdt_av 

      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0,  &
                       r1 = 1.0d0, r2 = 2.0d0, r3 = 3.0d0, r4=4.0d0,   &
                       rkelvin=273.15d0, rsmallarea = 1.0d-8

      real*8 :: porav, satav, diffav, tempav,densav, coeff_pa,          &
                coeff_t, nabla, expo, dsurftensdt_av, div,             &
                cvolfacearea, rswitch

      integer :: ivol, jvol, istart, iend, idvol, idvol_r, icell,      &
                 icell2, iedge_r, izn, jzn, jtemp
      
      type(point) :: tend_pa, tend_t, wtend, utend, vtend, ntend

      real*8 :: coeff_pa_direct, coeff_pa_cross,                       &
                coeff_t_direct, coeff_t_cross, alpha, beta

      integer :: info_debug

      character*1 iups

      external :: zero_r8
      
      
      info_debug = 0

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infevap_1)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, istart, iend, icell, icell2, idvol,          &
    !$omp idvol_r, iedge_r, jtemp, jvol,                              &
    !$omp cvolfacearea, coeff_pa, coeff_t, ddensvdpa_av,              &
    !$omp ddensvdt_av, densav, diffav, dsurftensdt_av, expo,          &
    !$omp nabla, porav, rswitch, satav, tempav,                       &
    !$omp tend_pa, tend_t, ntend, wtend, utend, vtend)
    !$omp do schedule(static)
#endif
      do ivol = 1, nngl

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1
        do jtemp = istart, iend  !c loop over connection
          jvol = javs(jtemp)
!c average porosity of the element, can be other interpolation methods
          porav = 0.5d0*(min(r1, pornew(ivol)) + min(r1,pornew(jvol)))
!c  calculate average dispersivities for the "pseudo
!c  dispersion element"
          tempav = 0.5d0*(tempnew(ivol)+tempnew(jvol))+rkelvin
          diffav = diffv0*(tempav/rkelvin)**r2

          ddensvdpa_av = 0.5d0*(ddensvdpa(ivol)+ddensvdpa(jvol))
          ddensvdt_av = 0.5d0*(ddensvdt(ivol)+ddensvdt(jvol))
          densav = 0.5d0*(density(ivol)+density(jvol))
          dsurftensdt_av = 0.5d0*(dsurftensdt(ivol)+dsurftensdt(jvol))
          satav = 0.5d0*(min(r1,sanew(ivol))+min(r1,sanew(jvol)))

          !cprovi-------------------------------------------------
          !cprovi Compute the enhanced factor in vapour difussion
          !cprovi This enhanced factor is only for thermal vapor
          !cpeovi fluxes
          !cprovi This expression is based on Sakai et al., 2009)
          !cprovi-------------------------------------------------
          if (isenhfactor) then
            expo=dexp(-(r1+(2.6d0/sqrt(fclay_nabla))*satav)**r4)
            nabla=cte_nabla+r3*satav-(cte_nabla-r1)*expo
          else
            nabla=r1
          end if

          if (split_divdensv) then
            coeff_pa = nabla_qhv*diffav*ddensvdpa_av
            coeff_t  = nabla*diffav*ddensvdt_av
          else
            coeff_pa = nabla*diffav
            coeff_t  = nabla*diffav
          end if

          tend_pa = math_common_set_vector(coeff_pa,coeff_pa,coeff_pa)

          tend_t = math_common_set_vector(coeff_t,coeff_t,coeff_t)

          do icell = 1, janumcell(jtemp)   !c loop over all linked cells
            icell2 = jacell(icell,jtemp)
            if (icell2 <= 0) then
              cycle
            end if
            do idvol = 1, num_edge_dvols   !c loop over all dual volumes
              call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,       &
                                         idvol_r,iedge_r,rswitch)
              cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell2)

              if(jacell(icell,jtemp) > 0 .and. cvolfacearea > rsmallarea) then

                !c save diffision conductivity tensor
                if (rswitch > r0) then
                  CellCvolFace_evap_pa(idvol_r,iedge_r,icell2) = tend_pa
                  CellCvolFace_evap_t(idvol_r,iedge_r,icell2) = tend_t
                end if

              end if
            end do
          end do

          coeff_t_usg(jtemp) = gainwt*dsurftensdt_av/gammaw0

        end do                   !c loop over connection
      end do                     !c  loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  

      return
      end
#endif
