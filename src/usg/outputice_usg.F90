!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/outputice_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputice_usg
!c -------------------
!c
!c output initial condition and results of ice loading/unloading
!c
!c written by:      Danyang Su - April 06, 20
!c
!c last modified:   
!c
!c ----------------------------------------------------------------------
#ifdef USG
    subroutine outputice_usg

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif 
      use gen
      use file_unit, only : lun_get, lun_free
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize, Petsc_Comm_Group
#endif

#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use geometry
      use usg_ice_sheet
      use usg_mesh_surface
      use usg_mesh_data, only : b_use_cell_matids, b_use_node_matids

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif
      integer :: i, ic, iiz, iunitice, ierr, ixmf, l_sufx

      character*5   :: suffix
      character*256 :: strbuffer, strfilename, strfilename_result,     &
                       strfilename_mesh
#ifdef PETSC 
      PetscErrorCode :: ierrcode
#endif  

!c  read numerical data and write to temporary file
!c  open file for ice sheet mesh and results output
      l_sufx = 0
      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then
          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if
        elseif (igstime.ge.10.and.igstime.lt.100) then
          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if
        elseif (igstime.ge.100.and.igstime.lt.1000) then
          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if
        elseif (igstime.gt.1000) then
          if (rank == 0) then
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputrt'
            close(ilog)
          end if
#ifdef PETSC
         call petsc_mpi_finalize
#endif
          stop
        end if
      end if

!c  output initial condition of ice sheet
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.ice'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_surface.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if 

      !c separate mesh data from results data
#ifdef PETSC_HDF
        if (b_output_separate_mesh_result .and. initial_condition) then

          if (num_nodes_sn_loc > 0) then
            !c initialize fortran interface
            call h5open_f(hdf5_ierr)

            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_Group,          &
                                    MPI_INFO_NULL, hdf5_ierr)
            !c create the file collectively
            call h5fcreate_f(strfilename_mesh, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            !c write mesh data
            call hdf5_usg_write_surface_mesh_data(file_id)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)
          end if

          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=prefix(:l_prfx)//'_surface.xmf',            &
                 status='unknown', form='formatted')
  
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type_sn,num_cells_sn_gbl,num_nodes_sn_gbl,  &
                      num_nodes_sn_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","vertices_rank","Scalar","Node",        &
                      num_nodes_sn_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","vertices_lg2g","Scalar","Node",        &
                      num_nodes_sn_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh, &
                        "domain","vertices_matid","Scalar","Node",     &
                        num_nodes_sn_gbl,1)
            end if

            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","cells_rank","Scalar","Cell",           &
                      num_cells_sn_gbl,1)
  
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","cells_lg2g","Scalar","Cell",           &
                      num_cells_sn_gbl,1)
  
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh, &
                        "domain","cells_matid","Scalar","Cell",        &
                        num_cells_sn_gbl,1)
            end if
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
        end if


!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        if (num_nodes_sn_loc > 0) then
          !c initialize fortran interface
          call h5open_f(hdf5_ierr)

          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_Group,          &
                                  MPI_INFO_NULL, hdf5_ierr)
          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,        &
                           file_id, hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_surface_mesh_data(file_id)
          end if

        !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)
  
          !c write ice sheet thickness data
          call hdf5_usg_write_group_data_1d(group_id,"thickness",      &
                    num_nodes_sn_loc,num_nodes_sn_gbl,offset_nodes_sn, &
                    ice_thickness_new)

          !c write ice sheet thickness data
          call hdf5_usg_write_group_data_1d(group_id,"thickness_phw2ice",  &
                    num_nodes_sn_loc,num_nodes_sn_gbl,offset_nodes_sn,     &
                    ice_thickness_phw2ice_new)

          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type_sn,num_cells_sn_gbl,num_nodes_sn_gbl,    &
                    num_nodes_sn_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_sn_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_sn_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_sn_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_sn_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_sn_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_sn_gbl,1)
          end if

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","thickness","Scalar","Node",             &
                    num_nodes_sn_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","thickness_phw2ice","Scalar","Node",     &
                    num_nodes_sn_gbl,1)

          !c close xmf file
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if        
#endif
      else if (.not.b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                   trim(adjustl(str_rank))//'.ice.vtk'
        !c output ice sheet surface without ghost nodes and cells
        if (num_nodes_sn_loc > 0 .and. num_cells_sn_loc > 0) then
          iunitice = lun_get()
          open(iunitice,file=trim(strfilename),status='unknown',       &
               form='formatted')
          !c output ice sheet data
          call usg_ice_output_mesh(iunitice,"ice sheet initial condition")
          close(iunitice)
          call lun_free(iunitice)
        end if
      end if 

      !c  write file information to fls file
      if (rank == 0) then
        if (initial_condition) then
          write(ifls,'(/2a/72a)')'Ice sheet variables, initial ',      &
                                 'condition',('-',i=1,72)
        else
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
                'Ice sheet variables, T = ',time_io, time_unit,        &
                ('-',i=1,72)
        end if


        write(ifls,'(/a/)') trim(strfilename)

        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        ice sheet temperature           ','°C'           
        write(ifls,'(2a)')                                             &
              '5        ice sheet thickness             ','m'         
      end if
      
      end
#endif  