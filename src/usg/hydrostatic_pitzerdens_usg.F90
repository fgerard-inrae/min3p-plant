!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 473 $
!> $Author: dsu $
!> $Date: 2017-05-31 22:02:12 -0700 (Wed, 31 May 2017) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/hydrostatic_pitzerdens_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

! --------------------------------------------------------------------
!> Module of hydrostatic conditions calculation for USG
!>
!> Module description:
!>
!> Written by:    Danyang Su - Dec. 11, 2016
!>
!> Last modified:
!>
!> Notes:
! --------------------------------------------------------------------
#ifdef USG
      !>
      !> calculate hydrostatic head for unstructured grid
      !> note: this method does not allow the existence of internal physical boundary
      !>
      subroutine hydrostatic_pitzerdens_usg (ivol)
 !cprovi---------------------------------------------------------------
 !cprovi Compute the hydrostatic conditions for the ivol cell 
 !cprovi Only when Pitzer equations are choosen 
 !cprovi---------------------------------------------------------------
      use parm
      use gen
      use dens
      use usg_mesh_data, only : usg_mesh_data_find_cell,               &
                                usg_mesh_data_interpolate,             &
                                usg_mesh_data_interpolate_bd,          &
                                nodes

      implicit none
      integer, intent(in) :: ivol
      
      !c local variables
      integer :: icell, icell_old
      real*8 :: dz, x, y, z, z_down, dens_up, dens_down, dens_av
      logical :: bflag
      
      !write(idbg,*) "before hydrostatic ivol",ivol,"uvsnew(ivol)",uvsnew(ivol)

!cprovi---------------------------------------------------------------------------
!cprovi Add a residual water pressure in ivol
!cprovi---------------------------------------------------------------------------
      uvsnew(ivol) = (hydro_top - node_max%z) * ref_dens * gacc

      !c set the parameters
      dz = (node_max%z-node_min%z)/100.0d0

      x = nodes(ivol)%x
      y = nodes(ivol)%y
      z = nodes(ivol)%z + dz
      dens_down = density(ivol)
      bflag = .true.
      icell_old = -1
      do while(bflag)
        icell = usg_mesh_data_find_cell(x,y,z)
        if(icell > 0) then
          dens_up = usg_mesh_data_interpolate(x,y,z,icell,density)
          dens_av = 0.5d0*(dens_up + dens_down)
          uvsnew(ivol) = uvsnew(ivol) + dens_av*gacc*dz
          dens_down = dens_up
          z_down = z
          icell_old = icell
          z = z + dz
        else
          call usg_mesh_data_interpolate_bd(x,y,z,density,dens_up)
          dens_av = 0.5d0*(dens_up + dens_down)
          dz = z - z_down
          uvsnew(ivol) = uvsnew(ivol) + dens_av*gacc*dz
          bflag = .false.
          exit
        end if
      end do

      !write(idbg,*) "after  hydrostatic ivol",ivol,"uvsnew(ivol)",uvsnew(ivol)

      return
      end
#endif
