!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/velocity_g_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine velocity_g_usg
!c -------------------
!c
!c write contour data of velocity for gas flow
!c simulation to output file
!c
!c written by:      Danyang Su- Oct. 04, 2016
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c
!c                                                                    I O
!c passed:   -
!c
!c common:
!c code.f:    type:
!c           -------
!c                              =                                     + -
!c local:
!c code.f:    type:
!c           -------
!c                              =                                     + -
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine velocity_g_usg

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use gen
      use chem
      use phys
      use dgml
      use writeversion
      use math_common
      use geometry
#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use usg_mesh_data
      use mod_fluxd_usg
      use gradient_usg, only : gradient_cross_diff_rt,                 &
                               gradient_cross_diff_rt_average
      use usg_face_utility, only : usg_face_utility_cinfvs,            &
                                   usg_face_utility_cinfrt_dg

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer :: ixmf
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif

      real*8 :: gasp_m, gasd_m, gasv, gpi, den, gasdiff2

      type(point) :: fluxvg_vel_usg

      external gasp_m, gasd_m, gasv, gasdiff2, wgprop,                 &
               fluxvg_vel_usg

!c    local variables
      integer :: i, ic, ig, ivol, jvol, kvol, idvol, icell, icell2,    &
                 icon, ierr, igsa2, igsf2, istart, iend,               &
                 idvol_r, iedge_r, jtemp, nmaxconc, ndvol, ncell
      integer :: nvel, nvel2, nvels(n), nvels2(n)
      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0, rhalf = 0.5d0
      real*8, parameter :: r1 = 1.0d0, rd3 = 1.0d3,                    &
                           rsmallarea = 1.0d-8, rverysmall = 1.d-30


!c    I/O variables
      integer*4      :: l_sufx, l_sfx2
      character*12   :: suffix, suffix2
      character*32   :: strvar32
      character*256  :: strbuffer
      character*256 :: strfilename, strfilename_result, strfilename_mesh

!c    advective flux calculations
      character*12 :: spt_weight

!c  dgm calculations
      integer*4 :: ipvt(ng)
      real*8    :: ludecomp(ng,ng)
      real*8    :: dgm_gflux(nc)
      real*8    :: fmat(ng)

!c  maxwell stefan
      real*8 :: ms_gflux(nc), neflux(nc)

!c    more variables (gas)
      real*8 :: relpgij, densgij, viscgij, gpij, gasdiff_loc, rswitch,     &
                gpivol_ivol, gpivol_jvol, gdens_ivol, gdens_jvol,          &
                gvisc_ivol, gvisc_jvol, cvolfacearea, relpgi, relpgj, rcvt

      real*8 :: grad_gasdiff_ij(ng,ncon_usg),                              &
                grad_weights(num_crossdifficv_max),                        &
                flux_totgnew_hls_corr(num_edge_dvols,num_edge_maxcells),   &
                cinfrt_usg(num_edge_dvols,num_edge_maxcells)


      type(point) :: grad_totgnew_locs(num_crossdifficv_max),              &
                     grad_totgnew_ivol(n), grad_totgnew_jvol(n),           &
                     grad_totgnew_kvol(n,num_nodes_per_cell,num_edge_maxcells),&
                     grad_totgnew_mids(num_edge_dvols,num_edge_maxcells),  &
                     cinfrt_usg_cross(num_edge_dvols,num_edge_maxcells),   &
                     grad_cgg_totgnew(n,num_edge_dvols,num_edge_maxcells)
      

      real*8 :: cinfvs_usg_loc(num_edge_dvols,num_edge_maxcells)
      type(point) :: cinfvs_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

      real*8 :: cinfrt_dg_usg_loc(num_edge_dvols,num_edge_maxcells)
      type(point) :: cinfrt_dg_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

      type(grad_hls_term) :: grad_totgnew_hls_loc(n,num_edge_dvols,num_edge_maxcells)

      type(point), allocatable :: vels_v(:), vels_grad(:),             &
                                  vels_ca(:,:), vels_cd(:,:),          &
                                  vels_dgm(:,:), vels_neq(:,:),        &
                                  gasdiff_usg(:,:), grad_gasdiff(:,:), &
                                  vels_v_loc(:), vels_grad_loc(:),     &
                                  vels_ca_loc(:,:), vels_cd_loc(:,:),  &
                                  vels_dgm_loc(:,:), vels_neq_loc(:,:),&
                                  gasdiff_usg_loc(:,:),                &
                                  grad_gasdiff_loc(:,:)
      type(point) :: cond, disp
      type(tensor) :: tenf_cond

      external :: checkerr


      l_sufx = 0
      if (igstime.lt.10) then
        write(suffix,'(i1)') igstime
        l_sufx = 1
      elseif (igstime.ge.10.and.igstime.lt.100) then
        write(suffix,'(i2)') igstime
        l_sufx = 2
      elseif (igstime.ge.100.and.igstime.lt.1000) then
        write(suffix,'(i3)') igstime
        l_sufx = 3

      elseif (igstime.gt.1000) then
        if (rank == 0) then
          write(ilog,'(/a)')'error in input file'
          write(ilog,'(a)')'max. number of output times exceeded'
          write(ilog,'(a)')'abnormal exit in routine outputrt'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      end if

!c  allocate memory space
      allocate(vels_v(nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_v',ilog)
      call memory_monitor(sizeof(vels_v),'vels_v',.true.)

      allocate(vels_grad(nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_grad',ilog)
      call memory_monitor(sizeof(vels_grad),'vels_grad',.true.)

      allocate(vels_ca(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_ca',ilog)
      call memory_monitor(sizeof(vels_ca),'vels_ca',.true.)

      allocate(vels_cd(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_cd',ilog)
      call memory_monitor(sizeof(vels_cd),'vels_cd',.true.)

      allocate(vels_dgm(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_dgm',ilog)
      call memory_monitor(sizeof(vels_dgm),'vels_dgm',.true.)

      allocate(vels_neq(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_neq',ilog)
      call memory_monitor(sizeof(vels_neq),'vels_neq',.true.)

      allocate(gasdiff_usg(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-gasdiff_usg',ilog)
      call memory_monitor(sizeof(gasdiff_usg),'gasdiff_usg',.true.)

      allocate(grad_gasdiff(ng,nngl), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-grad_gasdiff',ilog)
      call memory_monitor(sizeof(grad_gasdiff),'grad_gasdiff',.true.)

      nmaxconc = ncon_usg*num_edge_dvols*num_edge_maxcells
      allocate(vels_v_loc(nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_v_loc',ilog)
      call memory_monitor(sizeof(vels_v_loc),'vels_v_loc',.true.)

      allocate(vels_grad_loc(nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_grad_loc',ilog)
      call memory_monitor(sizeof(vels_grad_loc),'vels_grad_loc',.true.)

      allocate(vels_ca_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_ca_loc',ilog)
      call memory_monitor(sizeof(vels_ca_loc),'vels_ca_loc',.true.)

      allocate(vels_cd_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_cd_loc',ilog)
      call memory_monitor(sizeof(vels_cd_loc),'vels_cd_loc',.true.)

      allocate(vels_dgm_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_dgm_loc',ilog)
      call memory_monitor(sizeof(vels_dgm_loc),'vels_dgm_loc',.true.)

      allocate(vels_neq_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-vels_neq_loc',ilog)
      call memory_monitor(sizeof(vels_neq_loc),'vels_neq_loc',.true.)

      allocate(gasdiff_usg(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-gasdiff_usg',ilog)
      call memory_monitor(sizeof(gasdiff_usg),'gasdiff_usg',.true.)

      allocate(grad_gasdiff(ng,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_g_usg-grad_gasdiff',ilog)
      call memory_monitor(sizeof(grad_gasdiff),'grad_gasdiff',.true.)

!c    spatial weighting for the gas phase
      spt_weight = spatial_weighting

      fmat = r0
      neflux = r0

      rcvt = visc_h2o/dens_h2o/gacc

!c  compute average interfacial velocities
      do ivol = 1, nngl

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1

        grad_gasdiff_ij = r0

        icon = 0
        nvel = 0
        nvel2 = 0
        nvels = 0
        nvels2 = 0

        do jtemp = istart, iend
          jvol = javs(jtemp)
          icon = icon+1           !counter (connections)

          ncell = janumcell(jtemp)

          call gradient_cross_diff_rt(jtemp,ivol,jvol,n,totgnew,       &
                        grad_totgnew_ivol,grad_totgnew_jvol,           &
                        grad_totgnew_kvol,grad_totgnew_hls_loc,        &
                        grad_cgg_totgnew)

!cdsu calculate influence coefficient for variable saturated flow
          call usg_face_utility_cinfvs(ivol,jvol,jtemp,cinfvs_usg_loc, &
                                       cinfvs_usg_cross_loc)

          call usg_face_utility_cinfrt_dg(ivol,jvol,jtemp,             &
                   cinfrt_dg_usg_loc,cinfrt_dg_usg_cross_loc)



!c  pressure, density, viscosity, relative permeability
          gpivol_ivol = gasp_m(mdens_g(ivol),ivol)
          gpivol_jvol = gasp_m(mdens_g(jvol),jvol)
          gdens_ivol = gasd_m(mdens_g(ivol),gmfrac(:,ivol))
          gdens_jvol = gasd_m(mdens_g(jvol),gmfrac(:,jvol))
          gvisc_ivol = gasv(gmfrac(:,ivol))
          gvisc_jvol = gasv(gmfrac(:,jvol))

!c  calculate gas properties at interface according to weighting scheme

          if (discretization_type > 0 .and. is_cell_based_relp) then

            !c modify relpgij externally
            relpgij = 0.0d0
            do icell = 1, node_num_cells(ivol)
              relpgij = relpgij + relpermg(node_cells(icell,ivol))
            end do
            relpgij = relpgij / node_num_cells(ivol)

            relpgi = relpgij
            relpgj = relpgij

          else
            relpgi = relpermg(ivol)
            relpgj = relpermg(jvol)
          end if

          call wgprop(totgnew(1,ivol),totgnew(1,jvol),totgij   ,       &
                      gnew(1,ivol)   ,gnew(1,jvol)   ,gij      ,       &
                      gmfrac(1,ivol) ,gmfrac(1,jvol) ,gmfracij ,       &
                      relpgi         ,relpgj         ,relpgij  ,       &
                      gdens_ivol     ,gdens_jvol     ,densgij  ,       &
                      gvisc_ivol     ,gvisc_jvol     ,viscgij  ,       &
                      gpivol_ivol    ,gpivol_jvol    ,gpij     ,       &
                      zg(ivol)       ,zg(jvol)       ,                 &
                      spt_weight     ,iupsg(jtemp)   ,                 &
                      nc             ,ng             ,gacc     )

!c  calculate gradients that drive diffusive fluxes using the DGM model
!c  find flux between control volume pair
!c ----- Dusty Gas module -------------------------------------------------------

          if (dgm) then

!c           solve A F = B
!c           computes fluxes F of all gas components at current c.v. interphase

            call dgm_fluxdg(gnew(1,ivol)     ,gnew(1,jvol)  ,          &
                            gij              ,gmfracij      ,          &
                            zg(ivol)         ,zg(jvol)      ,          &
                            densgij          ,gpij          ,          &
                            tkel(ivol)       ,permij(jtemp) ,          &
                            relpgij          ,tauij(jtemp)  ,          &
                            gporij(jtemp)    ,deltaij(jtemp),          &
                            rverysmall       ,                         &
                            ludecomp         ,                         &
                            fmat             ,ipvt          ,          &
                            dgm_gflux        ,neflux       )

            call diff_grad(gnew(1,ivol)  ,gnew(1,jvol) ,               &
                           gmfracij      ,                             &
                           zg(ivol)      ,zg(jvol)     ,               &
                           densgij       ,tkel(ivol)   ,               &
                           gporij(jtemp),                              &
                           deltaij(jtemp)              ,               &
                           grad_gasdiff_ij(1,icon))

!c ----- Maxwell Stefan module --------------------------------------------------

          else if (maxwell) then

            call ms_fluxdg (gnew(1,ivol)     ,gnew(1,jvol)    ,        &
                            gij              ,gmfracij        ,        &
                            zg(ivol)         ,zg(jvol)        ,        &
                            densgij          ,gpij            ,        &
                            tkel(ivol)       ,tauij(jtemp)    ,        &
                            gporij(jtemp)    ,deltaij(jtemp)  ,        &
                            rverysmall       ,                         &
                            ludecomp         ,fmat            ,        &
                            ipvt             ,equimolar       ,        &
                            ms_gflux         ,neflux       )

          endif

!c  find flux between control volume pair

!c when gas advection, report velocity and flux results

          do icell = 1, janumcell(jtemp)
            icell2 = jacell(icell,jtemp)
            if (icell2 > 0) then
              do idvol = 1, num_edge_dvols

                call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,     &
                                           idvol_r,iedge_r,rswitch)
                cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,       &
                                                icell2)
                                
                if(cvolfacearea > rsmallarea) then                  
                  nvel = nvel + 1     
                  
                  if (type_cond_perm == 1 .and. .not.useAnisoCondCorr) then
                    cond = CellCvolFace_cond(idvol_r,iedge_r,icell2)*rcvt
                    vels_v_loc(nvel) = fluxvg_vel_usg(                   &
                                          gpivol_ivol , gpivol_jvol,     &
                                          zg(ivol)    , zg(jvol),        &
                                          r1          , relpgij,         &
                                          densgij     , viscgij,         &
                                          cond        , gas_gravity,     &
                                          gacc)

                    cond = cond/(cinfvs_usg_loc(idvol,icell)*rcvt)

                    vels_grad_loc(nvel) = fluxvg_vel_usg(                &
                                          gpivol_ivol , gpivol_jvol,     &
                                          zg(ivol)    , zg(jvol),        &
                                          r1          , r1,              &
                                          densgij     , r1,              &
                                          cond        , gas_gravity,     &
                                          gacc)
                  else if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                    tenf_cond = CellCvolFace_cond_tensor(idvol_r,iedge_r,icell2)*rcvt
                    !trick here, not strict, convert from full tensor to diagonal terms
                    cond = tenf_cond .cross. math_common_vector_unit(nodes(jvol)-nodes(ivol))
                    vels_v_loc(nvel) = fluxvg_vel_usg(                   &
                                          gpivol_ivol , gpivol_jvol,     &
                                          zg(ivol)    , zg(jvol),        &
                                          r1          , relpgij,         &
                                          densgij     , viscgij,         &
                                          cond        , gas_gravity,     &
                                          gacc)

                    tenf_cond = tenf_cond/(cinfvs_usg_loc(idvol,icell)*rcvt)

                    !trick here, not strict, convert from full tensor to diagonal terms
                    cond = tenf_cond .cross. math_common_vector_unit(nodes(jvol)-nodes(ivol))
                    vels_grad_loc(nvel) = fluxvg_vel_usg(                &
                                          gpivol_ivol , gpivol_jvol,     &
                                          zg(ivol)    , zg(jvol),        &
                                          r1          , r1,              &
                                          densgij     , r1,              &
                                          cond        , gas_gravity,     &
                                          gacc)
                  end if
                end if

              end do
            end if
          end do

          do ic=1,n

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
            grad_totgnew_mids = vector_zero
            flux_totgnew_hls_corr = r0

            call gradient_cross_diff_rt_average(ic,n,jtemp,ivol, &
                 jvol,grad_totgnew_ivol,grad_totgnew_jvol,       &
                 grad_totgnew_kvol,grad_totgnew_hls_loc,         &
                 grad_weights,grad_totgnew_locs,                 &
                 grad_totgnew_mids,flux_totgnew_hls_corr,        &
                 grad_cgg_totgnew)

!c ----------------gas advection -------------------------
            do icell = 1, janumcell(jtemp)
              icell2 = jacell(icell,jtemp)
              if (icell2 > 0) then
                do idvol = 1, num_edge_dvols
                  call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,   &
                                             idvol_r,iedge_r,rswitch)
                  cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,     &
                                                  icell2)
                  
                  if(cvolfacearea > rsmallarea) then
                    nvels(ic) = nvels(ic) + 1

                    if (gas_advection) then
                      if (type_cond_perm == 1 .and. .not.useAnisoCondCorr) then
                        cond = CellCvolFace_cond(idvol_r,iedge_r,icell2)*rcvt
                        vels_ca_loc(ic,nvels(ic)) = fluxvg_vel_usg(      &
                                               gpivol_ivol ,gpivol_jvol, &
                                               zg(ivol)    ,zg(jvol)    ,&
                                               totgij(ic)  ,relpgij     ,&
                                               densgij     ,viscgij     ,&
                                               cond        ,gas_gravity ,&
                                               gacc)
                      else if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                        tenf_cond = CellCvolFace_cond_tensor(idvol_r,iedge_r,icell2)*rcvt
                        !trick here, not strict, convert from full tensor to diagonal terms
                        cond = tenf_cond .cross. math_common_vector_unit(nodes(jvol)-nodes(ivol))
                        vels_ca_loc(ic,nvels(ic)) = fluxvg_vel_usg(      &
                                               gpivol_ivol ,gpivol_jvol, &
                                               zg(ivol)    ,zg(jvol)    ,&
                                               totgij(ic)  ,relpgij     ,&
                                               densgij     ,viscgij     ,&
                                               cond        ,gas_gravity ,&
                                               gacc)
                      end if
                    endif
                  end if

                end do
              end if
            end do

!c ----------------gas diffusion -------------------------
!c ---------------- fick's law, business as usual -------------------------

            if (blanc_diff_g) then
!c            diffusion coefficient calc'd with LeBlanc's law
              gasdiff_loc = gasdiff2 (gmfrac(1,ivol),gmfrac(1,jvol),   &
                                      gpivol_ivol   ,gpivol_jvol   ,   &
                                      zg(ivol)      ,zg(jvol)      ,   &
                                      gdens_ivol    ,gdens_jvol    ,   &
                                      ic            ,                  &
                                      iupsg(jtemp)  ,spt_weight    )
            else
!c            single constant diffusion
              gasdiff_loc = r1
            endif

            cinfrt_usg(:,:) = cinfrt_dg_usg_loc(:,:)*gasdiff_loc
            cinfrt_usg_cross(:,:) = cinfrt_dg_usg_cross_loc(:,:) *     &
                                           gasdiff_loc

            do icell = 1, janumcell(jtemp)
              icell2 = jacell(icell,jtemp)
              if (icell2 > 0) then
                do idvol = 1, num_edge_dvols

                  call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,   &
                                             idvol_r,iedge_r,rswitch)
                  cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,     &
                                                  icell2)
                  disp = CellCvolFace_disp_g(idvol_r,iedge_r,icell2)*  &
                         gasdiff_loc

                  if(cvolfacearea > rsmallarea) then

                    nvels2(ic) = nvels2(ic) + 1
                    vels_cd_loc(ic,nvels2(ic)) = -fluxd_vel_usg_tend(  &
                        disp,grad_totgnew_mids(idvol,icell))             !diffusive flux

                    !c diffusion coefficient calc'd with LeBlanc's law
                    if (blanc_diff_g) then
                      gasdiff_usg_loc(ic,nvels2(ic)) =                 &
                         CellCvolFaceUnitNorm(idvol_r,iedge_r,icell2)* &
                         (rswitch*cinfrt_usg(idvol,icell))
                    end if

                  end if

                  if (dgm) then
!c                     check if there is gas phase
                    if (gporij(jtemp).lt.rverysmall) then
!c                     no gas phase
                    else
                      vels_dgm_loc(ic,nvels2(ic)) =                    &
                                          disp*deltaij(jtemp)*         &
                                          dgm_gflux(ic)/               &
                                          tauij(jtemp)/                &
                                          gporij(jtemp)

                      vels_neq_loc(ic,nvels2(ic)) =                    &
                                          disp*deltaij(jtemp)*         &
                                          neflux(ic)/                  &
                                          tauij(jtemp)/                &
                                          gporij(jtemp)
                    endif
                  else if (maxwell) then
!c                     check if there is gas phase
                    if (gporij(jtemp).lt.rverysmall) then
!c                     no gas phase
                    else
                      vels_dgm_loc(ic,nvels2(ic)) =                    &
                                          disp*deltaij(jtemp)*         &
                                          ms_gflux(ic)/                &
                                          tauij(jtemp)/                &
                                          gporij(jtemp)

                      vels_neq_loc(ic,nvels2(ic)) =                    &
                                          disp*deltaij(jtemp)*         &
                                          neflux(ic)/                  &
                                          tauij(jtemp)/                &
                                          gporij(jtemp)

                    endif
                  else
                    vels_dgm_loc(ic,nvels2(ic)) = vels_cd_loc(ic,nvels2(ic))
                  endif
                end do
              end if
            end do

          end do          !loop over components

        end do            !loop over ivol-jvol connections


        icon = 0
        do jtemp = istart, iend
          jvol = javs(jtemp)
          icon = icon+1           !counter (connections)

          do ig = 1, ng
            do icell = 1, janumcell(jtemp)
              icell2 = jacell(icell,jtemp)
              if (icell2 <= 0) then
                cycle
              end if
              do idvol = 1, num_edge_dvols
                call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,     &
                                           idvol_r,iedge_r,rswitch)
                cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell2)

                if(cvolfacearea > rsmallarea) then

                  if (ig == 1) then
                    nvel2 = nvel2 + 1
                  end if
                  grad_gasdiff_loc(ig,nvel2) =                         &
                       CellCvolFaceUnitNorm(idvol_r,iedge_r,icell2)*   &
                       (rswitch*grad_gasdiff_ij(ig,icon))
                end if
              end do
            end do
          end do
        end do

        !c interpolcate final velocity to be output
        if (grad_average_weighting == 2) then
          vels_v(ivol) = math_common_min(nvel,vels_v_loc(1:nvel))*rd3
          vels_grad(ivol) = math_common_min(nvel,vels_grad_loc(1:nvel))*rd3
          do ic = 1, n
            vels_ca(ic,ivol) = math_common_min(nvel,vels_ca_loc(ic,1:nvel))*rd3
            vels_cd(ic,ivol) = math_common_min(nvel,vels_cd_loc(ic,1:nvel))*rd3
            vels_dgm(ic,ivol) = math_common_min(nvel,vels_dgm_loc(ic,1:nvel))*rd3
            vels_neq(ic,ivol) = math_common_min(nvel,vels_neq_loc(ic,1:nvel))*rd3
            gasdiff_usg(ic,ivol) = math_common_min(nvel,gasdiff_usg_loc(ic,1:nvel))*rd3
          end do
  
          do ig = 1, ng
            grad_gasdiff(ig,ivol) = math_common_min(nvel,grad_gasdiff_loc(ig,1:nvel))*rd3
          end do
        else if (grad_average_weighting == 1) then
          vels_v(ivol) = math_common_harmonic(nvel,vels_v_loc(1:nvel))*rd3
          vels_grad(ivol) = math_common_harmonic(nvel,vels_grad_loc(1:nvel))*rd3
          do ic = 1, n
            vels_ca(ic,ivol) = math_common_harmonic(nvel,vels_ca_loc(ic,1:nvel))*rd3
            vels_cd(ic,ivol) = math_common_harmonic(nvel,vels_cd_loc(ic,1:nvel))*rd3
            vels_dgm(ic,ivol) = math_common_harmonic(nvel,vels_dgm_loc(ic,1:nvel))*rd3
            vels_neq(ic,ivol) = math_common_harmonic(nvel,vels_neq_loc(ic,1:nvel))*rd3
            gasdiff_usg(ic,ivol) = math_common_harmonic(nvel,gasdiff_usg_loc(ic,1:nvel))*rd3
          end do
  
          do ig = 1, ng
            grad_gasdiff(ig,ivol) = math_common_harmonic(nvel,grad_gasdiff_loc(ig,1:nvel))*rd3
          end do
        else if (grad_average_weighting == 0) then
          vels_v(ivol) = math_common_arithmetic(nvel,vels_v_loc(1:nvel))*rd3
          vels_grad(ivol) = math_common_arithmetic(nvel,vels_grad_loc(1:nvel))*rd3
          do ic = 1, n
            vels_ca(ic,ivol) = math_common_arithmetic(nvel,vels_ca_loc(ic,1:nvel))*rd3
            vels_cd(ic,ivol) = math_common_arithmetic(nvel,vels_cd_loc(ic,1:nvel))*rd3
            vels_dgm(ic,ivol) = math_common_arithmetic(nvel,vels_dgm_loc(ic,1:nvel))*rd3
            vels_neq(ic,ivol) = math_common_arithmetic(nvel,vels_neq_loc(ic,1:nvel))*rd3
            gasdiff_usg(ic,ivol) = math_common_arithmetic(nvel,gasdiff_usg_loc(ic,1:nvel))*rd3
          end do
  
          do ig = 1, ng
            grad_gasdiff(ig,ivol) = math_common_arithmetic(nvel,grad_gasdiff_loc(ig,1:nvel))*rd3
          end do
        end if

      end do          !loop over volumes


!c    open output files___________________________________________

      igsa = igsa_first

!c    gas phase velocity
      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version

      if (b_output_binary) then

#ifdef PETSC_HDF
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.vlg'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if

        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,          &
                         file_id, hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsa,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//         &
             trim(adjustl(str_rank))//'.vlg.vtk',                      &
             status='unknown',form='formatted')
      end if

      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                         &
                   'Average interfacial gas phase velocities, T = ',   &
                    time_io,time_unit,('-',i=1,72)

        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                   suffix(:l_sufx)//trim(adjustl(str_rank))//'.vlg.vtk'

        write(ifls,'(2a)')                                             &
                'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
                '1        x                               ','m'
        write(ifls,'(2a)')                                             &
                '2        y                               ','m'
        write(ifls,'(2a)')                                             &
                '3        z                               ','m'
        write(ifls,'(2a)')                                             &
                '4        v_x                             ','m/d'
        write(ifls,'(2a)')                                             &
                '5        v_y                             ','m/d'
        write(ifls,'(2a)')                                             &
                '6        v_z                             ','m/d'
        write(ifls,'(2a)')                                             &
                '7        p_t_o_t                         ','atm'

      end if

      if (.not. b_output_binary) then
        write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
                "Average gas phase velocities, solution time = ",      &
                time_io,time_unit
        call write_mesh_data_vtk_ascii(igsa,trim(adjustl(strbuffer)))

        write(igsa,'(a,1x,i12)') "POINT_DATA",nngl
      end if


      !c write advective velocity vector
      if (b_output_binary) then
#ifdef PETSC_HDF
        allocate(realbuffer(num_nodes*3), stat = ierr)
        call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)

        do ivol = 1, num_nodes
          realbuffer((ivol-1)*3+1) = vels_v(ivol)%x
          realbuffer((ivol-1)*3+2) = vels_v(ivol)%y
          realbuffer((ivol-1)*3+3) = vels_v(ivol)%z
        end do

        call hdf5_usg_write_group_data_vec(group_id,"velocity_g",3,    &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","velocity_g","Vector","Node",            &
                    num_nodes_gbl,3)
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
#endif
      else
        write(igsa,'(a)') "VECTORS velocity_g double"
        do ivol = 1, nngl
          write(igsa,'(3(1pe15.6e3,1x))')                              &
                vels_v(ivol)%x, vels_v(ivol)%y, vels_v(ivol)%z
        end do
      end if

      !c write p_t_o_t
      if (b_output_binary) then
#ifdef PETSC_HDF
        allocate(realbuffer(num_nodes), stat = ierr)
        call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)

        do ivol = 1, num_nodes
          realbuffer(ivol) = gasp_m(mdens_g(ivol),ivol)/pa_atm
        end do
        call hdf5_usg_write_group_data_1d(group_id,"p_t_o_t",          &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","p_t_o_t","Scalar","Node",num_nodes_gbl,1)
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
#endif
      else
        write(igsa,'(a)') "SCALARS p_t_o_t double"
        write(igsa,'(a)') "LOOKUP_TABLE default"
        do ivol = 1, nngl
          gpi = gasp_m(mdens_g(ivol),ivol)/pa_atm   ! gas pressure
          write(igsa,ascii_fmt) gpi
        end do
      end if

      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsa)
      end if

      igsa2 = igsa

!c  velocity of gases species in mixture
!c  File extension name was changed from .gsa to .gsga as the flux
!c  output result takes the extension name .gsa.
      do ic=1,n

        igsa2 = igsa2+1

        call icnvrt(0,ic,suffix2,l_sfx2,ierr)

        if (ierr > 0) then
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          write(*,*) "Error in icnvrt function in velocity_g"
          write(ilog,*) "Error in icnvrt function in velocity_g"
          close(ilog)
          stop
        end if

        !c file for result and mesh
        !c note: binary output using separated file for each subdomain is
        !c deprecated for unstructured grid version
        if (b_output_binary) then
          strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
                        suffix2(:l_sfx2)//'.gsga'
          if (b_output_separate_mesh_result) then
            strfilename_result = trim(strfilename)//'.h5'
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_result = trim(strfilename)//'.h5'
            strfilename_mesh = strfilename_result
          end if
        else
          strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
             suffix2(:l_sfx2)//trim(adjustl(str_rank))//'.gsga'
        end if

        if (b_output_binary) then
#ifdef PETSC_HDF
          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.xmf',status='unknown', &
                 form='formatted')
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)

          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)
          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,        &
                           file_id, hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)
#endif
        else
          open(igsa2,file=trim(strfilename)//'.vtk',                   &
               status='unknown', form='formatted')
        end if

        if (rank == 0 .and. b_enable_output) then

          write(ifls,'(/a, a, 1x, a, 1p, 1pe15.6e3, 1x, a, /, 72a)')   &
                'Average interfacial gas fluxes for component: ',      &
                 namec(ic)(:l_namec(ic)),' T = ',                      &
                 time_io,time_unit,('-',i=1,72)

          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                      suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//         &
                      trim(adjustl(str_rank))//'.gsga.vtk'

          write(ifls,'(2a)')                                           &
              'column   entry                           ','unit'
          write(ifls,'(2a)')                                           &
              '1        x                               ','m'
          write(ifls,'(2a)')                                           &
              '2        y                               ','m'
          write(ifls,'(2a)')                                           &
              '3        z                               ','m'
          write(ifls,'(2a)')                                           &
              '4        v_x advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '5        v_y advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '6        v_z advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '7        v_x Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '8        v_y Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '9        v_z Fick s diffusion            ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '10       v_x total                       ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '11       v_y total                       ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '12       v_z total                       ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '13       v_x DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '14       v_y DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '15       v_z DGM / M-S diffusion         ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '16       v_x non-equimolar diffusion     ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '17       v_y non-equimolar diffusion     ','moles/m^2/d'
          write(ifls,'(2a)')                                           &
              '18       v_z non-equimolar diffusion     ','moles/m^2/d'

        end if

        if (.not. b_output_binary) then
          write(strbuffer,'(3a,1pe15.6e3,1x,a)')                       &
                "advection and diffusion fluxes for ", trim(namec(ic)),&
                ", solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(igsa2,trim(adjustl(strbuffer)))

          write(igsa2,'(a,1x,i12)') "POINT_DATA",nngl
        end if

        if (b_output_binary) then
          allocate(realbuffer(num_nodes*3), stat = ierr)
          call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if

        !c write advective velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_ca(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_ca(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_ca(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_adv",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_adv","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_adv double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_ca(ic,ivol)%x,       &
                  vels_ca(ic,ivol)%y, vels_ca(ic,ivol)%z
          end do
        end if

        !c write diffusive velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_cd(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_cd(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_cd(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_dif",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_dif","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_dif double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_cd(ic,ivol)%x,       &
                  vels_cd(ic,ivol)%y, vels_cd(ic,ivol)%z
          end do
        end if

        !c write total velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_ca(ic,ivol)%x+             &
                                       vels_dgm(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_ca(ic,ivol)%y+             &
                                       vels_dgm(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_ca(ic,ivol)%z+             &
                                       vels_dgm(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_tot",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_tot","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_tot double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))')                           &
                 vels_ca(ic,ivol)%x+vels_dgm(ic,ivol)%x,               &
                 vels_ca(ic,ivol)%y+vels_dgm(ic,ivol)%y,               &
                 vels_ca(ic,ivol)%z+vels_dgm(ic,ivol)%z
          end do
        end if

        !c write DGM / M-S diffusion velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_dgm(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_dgm(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_dgm(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,                 &
                    "velocity_dif_dgm",3,num_nodes_loc,num_nodes_gbl,  &
                    offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_dif_dgm","Vector","Node",    &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_dif_dgm double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_dgm(ic,ivol)%x,      &
                  vels_dgm(ic,ivol)%y, vels_dgm(ic,ivol)%z
          end do
        end if

        !c write non-equimolar diffusion velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_neq(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_neq(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_neq(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,                 &
                    "velocity_dif_neq",3,num_nodes_loc,num_nodes_gbl,  &
                    offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_dif_neq","Vector","Node",    &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_dif_neq double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_neq(ic,ivol)%x,      &
                  vels_neq(ic,ivol)%y, vels_neq(ic,ivol)%z
          end do
        end if

        if (b_output_binary) then
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer)
        end if

        if (b_output_binary) then
#ifdef PETSC_HDF
          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          close(igsa2)
        end if

      enddo

      igsa_last = igsa2

      igsf2 = igsf_first

!c  variable diffusion coefficients
      if (blanc_diff_g) then

        do ic=1,n

          igsf2 = igsf2+1

          call icnvrt(0,ic,suffix2,l_sfx2,ierr)

          if (ierr > 0) then
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            write(*,*) "Error in icnvrt function in velocity_g"
            write(ilog,*) "Error in icnvrt function in velocity_g"
            close(ilog)
            stop
          end if

          !c file for result and mesh
          !c note: binary output using separated file for each subdomain is
          !c deprecated for unstructured grid version
          if (b_output_binary) then
            strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
                          suffix2(:l_sfx2)//'.gsf'
            if (b_output_separate_mesh_result) then
              strfilename_result = trim(strfilename)//'.h5'
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_result = trim(strfilename)//'.h5'
              strfilename_mesh = strfilename_result
            end if
          else
            strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'// &
               suffix2(:l_sfx2)//trim(adjustl(str_rank))//'.gsf'
          end if

          if (b_output_binary) then

#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.xmf',                &
                   status='unknown',form='formatted')
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)

            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,        &
                                    MPI_INFO_NULL, hdf5_ierr)
            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,      &
                             file_id, hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                        cell_type,num_cells_gbl,num_nodes_gbl,         &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_rank",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_rank",        &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_lg2g",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_lg2g",        &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_matid",  &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_matid",     &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,     &
                             OBJECT_NAMELEN_DEFAULT_F)
#endif
          else
            open(igsf2,file=trim(strfilename)//'.vtk',                 &
                 status='unknown',form='formatted')
          end if

          if (rank == 0 .and. b_enable_output) then
            write(ifls,'(/a, a, 1x, a, 1p, 1pe15.6e3, 1x, a, /, 72a)') &
                  'Species-dependent gas diffusion coefficients: ',    &
                  namec(ic)(:l_namec(ic)),' T = ',                     &
                  time_io,time_unit,('-',i=1,72)

            write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                 &
                                suffix(:l_sufx)//'_'//                 &
                                suffix2(:l_sfx2)//'.gsf.vtk'

            write(ifls,'(2a)')                                         &
                  'column   entry                           ','unit'
            write(ifls,'(2a)')                                         &
                  '1        x                               ','m'
            write(ifls,'(2a)')                                         &
                  '2        y                               ','m'
            write(ifls,'(2a)')                                         &
                  '3        z                               ','m'
            write(ifls,'(2a)')                                         &
                  '4        Dxx                             ','m2/d'
            write(ifls,'(2a)')                                         &
                  '5        Dyy                             ','m2/d'
            write(ifls,'(2a)')                                         &
                  '6        Dzz                             ','m2/d'
          end if


          if (.not. b_output_binary) then
            write(strbuffer,'(3a,1pe15.6e3,1x,a)')                     &
                  "Species-dependent gas diffusion coefficients for ", &
                  trim(namec(ic)), ", solution time = ",time_io,time_unit
            call write_mesh_data_vtk_ascii(igsf2,trim(adjustl(strbuffer)))

            write(igsf2,'(a,1x,i12)') "POINT_DATA",nngl
          end if

          !c write advective velocity vector
          if (b_output_binary) then
#ifdef PETSC_HDF
            allocate(realbuffer(num_nodes*3), stat = ierr)
            call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
            call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
            do ivol = 1, num_nodes
              realbuffer((ivol-1)*3+1) = gasdiff_usg(ic,ivol)%x/sec_per_days
              realbuffer((ivol-1)*3+2) = gasdiff_usg(ic,ivol)%y/sec_per_days
              realbuffer((ivol-1)*3+3) = gasdiff_usg(ic,ivol)%z/sec_per_days
            end do

            call hdf5_usg_write_group_data_vec(group_id,"diff_coeff",3,  &
                      num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

            if (rank == 0) then
              call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                        "results","diff_coeff","Vector","Node",          &
                        num_nodes_gbl,3)
            end if
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
#endif
          else
            write(igsf2,'(a)') "VECTORS diff_coeff double"
            do ivol = 1, nngl
              write(igsf2,'(3(1pe15.6e3,1x))')                           &
                    gasdiff_usg(ic,ivol)%x/sec_per_days,                 &
                    gasdiff_usg(ic,ivol)%y/sec_per_days,                 &
                    gasdiff_usg(ic,ivol)%z/sec_per_days
            end do
          end if

          if (b_output_binary) then
#ifdef PETSC_HDF
            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            close(igsf2)
          end if

        enddo

      endif

      if (b_output_binary) then
        allocate(realbuffer(num_nodes), stat = ierr)
        call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
      end if

      igsf_last = igsf2

!c   open files for density
      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsr'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsr'
      end if

      if (b_output_binary) then

#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,          &
                         file_id, hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsr,file=prefix(:l_prfx)//'_'//suffix(:l_sufx)//         &
             trim(adjustl(str_rank))//'.gsr.vtk',                      &
             status='unknown',form='formatted')
      end if

      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                         &
                   'Density of the gas phase, T = ',                   &
                    time_io,time_unit,('-',i=1,72)

        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                            trim(adjustl(str_rank))//'.gsr'

        write(ifls,'(2a)')                                             &
                'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
                '1        x                               ','m'
        write(ifls,'(2a)')                                             &
                '2        y                               ','m'
        write(ifls,'(2a)')                                             &
                '3        z                               ','m'
        write(ifls,'(2a)')                                             &
                '4        density                         ','g/l'

      end if

      if (.not. b_output_binary) then
        write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
                "Density of the gas phase, solution time = ",          &
                time_io,time_unit
        call write_mesh_data_vtk_ascii(igsr,trim(adjustl(strbuffer)))

        write(igsr,'(a,1x,i12)') "POINT_DATA",nngl
      end if

      !c write p_t_o_t
      if (b_output_binary) then
#ifdef PETSC_HDF
        do ivol = 1, num_nodes
          realbuffer(ivol) = gasd_m(mdens_g(ivol),gmfrac(:,ivol))
        end do
        call hdf5_usg_write_group_data_1d(group_id,"density",           &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,    &
                    "results","density","Scalar","Node",num_nodes_gbl,1)
        end if
#endif
      else
        write(igsr,'(a)') "SCALARS density double"
        write(igsr,'(a)') "LOOKUP_TABLE default"
        do ivol = 1, nngl
          den = gasd_m(mdens_g(ivol),gmfrac(:,ivol))
          write(igsr,ascii_fmt) den
        end do
      end if

      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsr)
      end if


!c   open files for density
      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsy'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsy'
      end if

      if (b_output_binary) then

#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,          &
                         file_id, hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsy,file=trim(strfilename)//'.vtk',                      &
             status='unknown',form='formatted')
      end if

      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                         &
                   'Viscosity of the gas phase, T = ',                 &
                    time_io,time_unit,('-',i=1,72)

        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//suffix(:l_sufx)//    &
                   trim(adjustl(str_rank))//'.gsy'

        write(ifls,'(2a)')                                             &
                'column   entry                           ','unit'
        write(ifls,'(2a)')                                             &
                '1        x                               ','m'
        write(ifls,'(2a)')                                             &
                '2        y                               ','m'
        write(ifls,'(2a)')                                             &
                '3        z                               ','m'
        write(ifls,'(2a)')                                             &
                '4        viscosity                       ','Pa s'

      end if

      if (.not. b_output_binary) then
        write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                       &
                "Viscosity of the gas phase, solution time = ",        &
                time_io,time_unit
        call write_mesh_data_vtk_ascii(igsy,trim(adjustl(strbuffer)))

        write(igsy,'(a,1x,i12)') "POINT_DATA",nngl
      end if

      !c write p_t_o_t
      if (b_output_binary) then
#ifdef PETSC_HDF
        do ivol = 1, num_nodes
          realbuffer(ivol) = gasv(gmfrac(:,ivol))
        end do
        call hdf5_usg_write_group_data_1d(group_id,"density",           &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,    &
                    "results","density","Scalar","Node",num_nodes_gbl,1)
        end if
#endif
      else
        write(igsy,'(a)') "SCALARS density double"
        write(igsy,'(a)') "LOOKUP_TABLE default"
        do ivol = 1, nngl
          write(igsy,ascii_fmt) gasv(gmfrac(:,ivol))
        end do
      end if

      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsy)
      end if

      if (b_output_binary) then
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
      end if

!c  gas phase velocity
      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsk'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if
      else
        strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//          &
                      trim(adjustl(str_rank))//'.gsk'
      end if

      if (b_output_binary) then

#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,          &
                         file_id, hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_lg2g",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_lg2g",            &
                    "Scalar","Cell",num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        open(igsk,file=trim(strfilename)//'.vtk',                      &
             status='unknown',form='formatted')
      end if

      if (rank == 0 .and. b_enable_output) then

        write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                        &
                   'Advective and Diffusive driving force gradients', &
                    time_io,time_unit,('-',i=1,72)

        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                    &
                            suffix(:l_sufx)//'.gsk'

        write(ifls,'(2a)')                                            &
                'column   entry                           ','unit'
        write(ifls,'(2a)')                                            &
                '1        x                               ','m'
        write(ifls,'(2a)')                                            &
                '2        y                               ','m'
        write(ifls,'(2a)')                                            &
                '3        z                               ','m'
        write(ifls,'(2a)')                                            &
                '4        grad_adv_x                      ','m^3/d'
        write(ifls,'(2a)')                                            &
                '5        grad_adv_y                      ','m^3/d'
        write(ifls,'(2a)')                                            &
                '6        grad_adv_z                      ','m^3/d'
        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_x"
          if(ic+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else if (ic+6 >= 10 .and. ic+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else if (ic+6 >= 100 .and. ic+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else if (ic+6 >= 1000 .and. ic+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          else
            write(ifls,'(i8,1x,2a)') ic+6,strvar32,'moles L^-1 m^-1'
          end if
        end do

        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_y"
          if (ic+ng+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 10 .and. ic+ng+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 100 .and. ic+ng+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else if (ic+ng+6 >= 1000 .and. ic+ng+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          else
            write(ifls,'(i8,1x,2a)') ic+ng+6,strvar32,                 &
                  'moles L^-1 m^-1'
          end if
        end do

        do ic = 1,ng
          strvar32 = trim(nameg(ic))//"_diff_z"
          if (ic+2*ng+6 < 10) then
            write(ifls,'(i1,8x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 10 .and. ic+2*ng+6 < 100) then
            write(ifls,'(i2,7x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 100 .and. ic+2*ng+6 < 1000) then
            write(ifls,'(i3,6x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else if (ic+2*ng+6 >= 1000 .and. ic+2*ng+6 < 10000) then
            write(ifls,'(i4,5x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          else
            write(ifls,'(i8,1x,2a)') ic+2*ng+6,strvar32,               &
                  'moles L^-1 m^-1'
          end if
        end do

      end if

      if (.not. b_output_binary) then
        write(strbuffer,'(2a,1pe15.6e3,1x,a)')                         &
              "Advective and Diffusive driving force gradients",       &
              ", solution time = ",time_io,time_unit
        call write_mesh_data_vtk_ascii(igsk,trim(adjustl(strbuffer)))

        write(igsk,'(a,1x,i12)') "POINT_DATA",nngl
      end if

      if (b_output_binary) then
        allocate(realbuffer(num_nodes*3), stat = ierr)
        call checkerr(ierr,'velocity_g_usg-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
      end if

      !c write advective velocity vector
      if (b_output_binary) then
#ifdef PETSC_HDF
        do ivol = 1, num_nodes
          realbuffer((ivol-1)*3+1) = vels_grad(ivol)%x
          realbuffer((ivol-1)*3+2) = vels_grad(ivol)%y
          realbuffer((ivol-1)*3+3) = vels_grad(ivol)%z
        end do
        call hdf5_usg_write_group_data_vec(group_id,"grad_adv",3,      &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result,   &
                    "results","grad_adv","Vector","Node",              &
                    num_nodes_gbl,3)
        end if
#endif
      else
        write(igsk,'(a)') "VECTORS grad_adv double"
        do ivol = 1, nngl
          write(igsk,'(3(1pe15.6e3,1x))') vels_grad(ivol)%x,           &
                vels_grad(ivol)%y, vels_grad(ivol)%z
        end do
      end if

      do ig = 1, ng
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = grad_gasdiff(ig,ivol)%x
            realbuffer((ivol-1)*3+2) = grad_gasdiff(ig,ivol)%y
            realbuffer((ivol-1)*3+3) = grad_gasdiff(ig,ivol)%z
          end do
          call hdf5_usg_write_group_data_vec(group_id,trim(nameg(ig)),3, &
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results",trim(nameg(ig)),"Vector","Node",       &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsk,'(3a)') "VECTORS grad_diff_",trim(nameg(ig))," double"
          do ivol = 1, nngl
            write(igsk,'(3(1pe15.6e3,1x))') grad_gasdiff(ig,ivol)%x,   &
                  grad_gasdiff(ig,ivol)%y, grad_gasdiff(ig,ivol)%z
          end do
        end if
      end do

      if (b_output_binary) then
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
      end if

      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(igsk)
      end if

!c  release memory space
      call memory_monitor(-sizeof(vels_v),'vels_v',.true.)
      call memory_monitor(-sizeof(vels_ca),'vels_ca',.true.)
      call memory_monitor(-sizeof(vels_cd),'vels_cd',.true.)
      call memory_monitor(-sizeof(vels_dgm),'vels_dgm',.true.)
      call memory_monitor(-sizeof(vels_neq),'vels_neq',.true.)
      call memory_monitor(-sizeof(vels_grad),'vels_grad',.true.)
      call memory_monitor(-sizeof(gasdiff_usg),'gasdiff_usg',.true.)

      deallocate(vels_v)
      deallocate(vels_ca)
      deallocate(vels_cd)
      deallocate(vels_dgm)
      deallocate(vels_neq)
      deallocate(vels_grad)
      deallocate(gasdiff_usg)

      return

      end
#endif
