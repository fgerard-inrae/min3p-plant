!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/velocity_a_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine velocity_usg
!c -------------------
!c
!c write contour data of velocity for aqueous flow
!c simulation to output file
!c
!c written by:      Danyang Su- Oct. 04, 2016
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c
!c                                                                    I O
!c passed:   -
!c
!c common:
!c code.f:    type:
!c           -------
!c                              =                                     + -
!c local:
!c code.f:    type:
!c           -------
!c                              =                                     + -
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine velocity_a_usg
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
      use phys
      use chem
      use writeversion
      use file_unit, only : lun_get, lun_free
      use math_common
      use geometry
      use usg_mesh_data
      use mod_fluxd_usg
      use gradient_usg, only : gradient_cross_diff_md,                 &
                               gradient_cross_diff_rt,                 &
                               gradient_cross_diff_rt_average

#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer :: ixmf
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif

      integer :: i, ic, icon, ivol, jvol, istart, iend, jtemp, l_sufx,     &
                 l_sfx2, ierr, igsa2, icell, icell2, idvol, idvol_r,       &
                 iedge_r, kvol, nmaxconc, ndvol, ncell

      real*8 :: fluxv_vl_loc, cvolfacearea, rswitch

      real*8 :: flux_totcnew_hls_corr(num_edge_dvols,num_edge_maxcells),   &
                flux_totviscnew_hls_corr(num_edge_dvols,num_edge_maxcells),&
                flux_electro_hls_corr(num_edge_dvols,num_edge_maxcells)

      integer :: nvels(n)

      real*8 :: grad_weights(num_crossdifficv_max)
      type(point) :: grad_totcnew_locs(num_crossdifficv_max),                  &
                     grad_totviscnew_locs(num_crossdifficv_max),               &
                     grad_electro_locs(num_crossdifficv_max),                  &
                     grad_totcnew_ivol(n), grad_totcnew_jvol(n),               &
                     grad_totviscnew_ivol(n), grad_totviscnew_jvol(n),         &
                     grad_electro_ivol(n), grad_electro_jvol(n),               &
                     grad_totcnew_kvol(n,num_nodes_per_cell,num_edge_maxcells),&
                     grad_totviscnew_kvol(n,num_nodes_per_cell,num_edge_maxcells),&
                     grad_electro_kvol(n,num_nodes_per_cell,num_edge_maxcells),&
                     grad_totcnew_mids(num_edge_dvols,num_edge_maxcells),      &
                     grad_totviscnew_mids(num_edge_dvols,num_edge_maxcells),   &
                     grad_electro_mids(num_edge_dvols,num_edge_maxcells),      &
                     grad_cgg_totcnew(n,num_edge_dvols,num_edge_maxcells),     &
                     grad_cgg_totviscnew(n,num_edge_dvols,num_edge_maxcells),  &
                     grad_cgg_electro(n,num_edge_dvols,num_edge_maxcells)
                     
      type(tensor) :: disp_tensor

      type(grad_hls_term) :: grad_totcnew_hls_loc(n,num_edge_dvols,num_edge_maxcells),&
                             grad_totviscnew_hls_loc(n,num_edge_dvols,num_edge_maxcells),&
                             grad_electro_hls_loc(n,num_edge_dvols,num_edge_maxcells)

      type(point), allocatable :: vels_adv(:,:), vels_dif(:,:),        &
                                  vels_mig(:,:), vels_tot(:,:),        &
                                  vels_adv_loc(:,:), vels_dif_loc(:,:),&
                                  vels_mig_loc(:,:), vels_tot_loc(:,:),&
                                  vels_tmp_loc(:), disp
     
      real*8 :: fluxv_vl

      external :: fluxv_vl

      external :: checkerr

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rd3 = 1.0d3,        &
                           rsmallarea = 1.0d-8, rverysmall = 1.0d-30

      character*3 suffix, suffix2
      character*256 strbuffer
      character*256 :: strfilename, strfilename_result, strfilename_mesh

      l_sufx = 0
      if (igstime.lt.10) then
        write(suffix,'(i1)') igstime
        l_sufx = 1
      elseif (igstime.ge.10.and.igstime.lt.100) then
        write(suffix,'(i2)') igstime
        l_sufx = 2
      elseif (igstime.ge.100.and.igstime.lt.1000) then
        write(suffix,'(i3)') igstime
        l_sufx = 3

      elseif (igstime.gt.1000) then
        if (rank == 0) then
          write(ilog,'(/a)')'error in input file'
          write(ilog,'(a)')'max. number of output times exceeded'
          write(ilog,'(a)')'abnormal exit in routine outputrt'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      end if

!c  allocate memory space
      allocate(vels_adv(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_adv',ilog)
      call memory_monitor(sizeof(vels_adv),'vels_adv',.true.)

      allocate(vels_dif(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_dif',ilog)
      call memory_monitor(sizeof(vels_dif),'vels_dif',.true.)

      allocate(vels_mig(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_mig',ilog)
      call memory_monitor(sizeof(vels_mig),'vels_mig',.true.)

      allocate(vels_tot(n,nngl), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_tot',ilog)
      call memory_monitor(sizeof(vels_tot),'vels_tot',.true.)

      nmaxconc = ncon_usg*num_edge_dvols*num_edge_maxcells
      allocate(vels_adv_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_adv_loc',ilog)
      call memory_monitor(sizeof(vels_adv_loc),'vels_adv_loc',.true.)

      allocate(vels_dif_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_dif_loc',ilog)
      call memory_monitor(sizeof(vels_dif_loc),'vels_dif_loc',.true.)

      allocate(vels_mig_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_mig_loc',ilog)
      call memory_monitor(sizeof(vels_mig_loc),'vels_mig_loc',.true.)

      allocate(vels_tot_loc(n,nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_tot_loc',ilog)
      call memory_monitor(sizeof(vels_tot_loc),'vels_tot_loc',.true.)

      !c temporary variable
      allocate(vels_tmp_loc(nmaxconc), stat = ierr)
      call checkerr(ierr,'velocity_a_usg-vels_tmp_loc',ilog)
      call memory_monitor(sizeof(vels_tmp_loc),'vels_tmp_loc',.true.)


!c  calculate aqueous velocity
      do ivol = 1, nngl
        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1

        icon = 0
        nvels = 0
        do jtemp = istart, iend
          jvol = javs(jtemp)
          icon = icon+1           !counter (connections)

          ncell = janumcell(jtemp)

! cdsu -------------------------------------------------------
! cdsu gradient reconstruction for reactive transport
! cdsu -------------------------------------------------------
          if (discretization_type > 0) then
            if (multi_diff) then
              call gradient_cross_diff_md(jtemp,ivol,jvol,             &
                   grad_totviscnew_ivol,grad_totviscnew_jvol,          &
                   grad_totviscnew_kvol,grad_electro_ivol,             &
                   grad_electro_jvol,grad_electro_kvol,                &
                   grad_totviscnew_hls_loc,grad_electro_hls_loc,       &
                   grad_cgg_totviscnew,grad_cgg_electro)
            else
              call gradient_cross_diff_rt(jtemp,ivol,jvol,n,totcnew,   &
                   grad_totcnew_ivol,grad_totcnew_jvol,                &
                   grad_totcnew_kvol,grad_totcnew_hls_loc,             &
                   grad_cgg_totcnew)
            end if
          end if

          do ic = 1, n

!c  compute aqueous phase flux
            if (multi_diff) then

              grad_totviscnew_mids = vector_zero
              grad_electro_mids = vector_zero
              flux_totviscnew_hls_corr = r0
              flux_electro_hls_corr = r0

              call gradient_cross_diff_rt_average(ic,n,jtemp,ivol,     &
                   jvol,grad_totviscnew_ivol,grad_totviscnew_jvol,     &
                   grad_totviscnew_kvol,grad_totviscnew_hls_loc,       &
                   grad_weights,grad_totviscnew_locs,                  &
                   grad_totviscnew_mids,flux_totviscnew_hls_corr,      &
                   grad_cgg_totviscnew)
  
              call gradient_cross_diff_rt_average(ic,n,jtemp,ivol,     &
                   jvol,grad_electro_ivol,grad_electro_jvol,           &
                   grad_electro_kvol,grad_electro_hls_loc,             &
                   grad_weights,grad_electro_locs,                     &
                   grad_electro_mids,flux_electro_hls_corr,            &
                   grad_cgg_electro)

              do icell = 1, janumcell(jtemp)
                icell2 = jacell(icell,jtemp)
                if (icell2 > 0) then
                  do idvol = 1, num_edge_dvols

                    call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2, &
                                               idvol_r,iedge_r,rswitch)
                    cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,   &
                                                    icell2)
                    
                    if(cvolfacearea > rsmallarea) then
                      nvels(ic) = nvels(ic) + 1

                      if (abs(cinfrt_va_usg(jtemp)) > rverysmall) then
                        fluxv_vl_loc = fluxv_vl(totcnew(ic,ivol),totcnew(ic,jvol),   &
                                                ivol,jvol,cinfrt_va_usg(jtemp),ic)
                        vels_adv_loc(ic,nvels(ic)) =                                 &
                             CellCvolFace_adv(idvol_r,iedge_r,icell2)*               &
                             (fluxv_vl_loc/cinfrt_va_usg(jtemp))
                      end if

                      disp = CellCvolFace_disp_mcd(idvol_r,iedge_r,icell2)

                      vels_dif_loc(ic,nvels(ic)) = -fluxd_vel_usg_tend(disp,         &    !diffusive term
                                                    grad_totviscnew_mids(idvol,icell))

                      vels_mig_loc(ic,nvels(ic)) =  fluxd_vel_usg_tend(disp,         &    !electromigration term
                                                    grad_electro_mids(idvol,icell))
                    end if

                  end do
                end if
              end do

            else

              grad_totcnew_mids = vector_zero
              flux_totcnew_hls_corr = r0

              call gradient_cross_diff_rt_average(ic,n,jtemp,ivol,     &
                   jvol,grad_totcnew_ivol,grad_totcnew_jvol,           &
                   grad_totcnew_kvol,grad_totcnew_hls_loc,             &
                   grad_weights,grad_totcnew_locs,                     &
                   grad_totcnew_mids,flux_totcnew_hls_corr,            &
                   grad_cgg_totcnew)

!c ---------------- fick's law, business as usual -------------------------
              do icell = 1, janumcell(jtemp)
                icell2 = jacell(icell,jtemp)
                if (icell2 > 0) then
                  do idvol = 1, num_edge_dvols

                    call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2, &
                                               idvol_r,iedge_r,rswitch)
                    cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,   &
                                                    icell2)                    
                    if(cvolfacearea > rsmallarea) then
                      nvels(ic) = nvels(ic) + 1

                      if (abs(cinfrt_va_usg(jtemp)) > rverysmall) then
                        fluxv_vl_loc = fluxv_vl(totcnew(ic,ivol),totcnew(ic,jvol),   &
                                                ivol,jvol,cinfrt_va_usg(jtemp),ic)
                        vels_adv_loc(ic,nvels(ic)) =                                 &
                             CellCvolFace_adv(idvol_r,iedge_r,icell2)*               &
                             (fluxv_vl_loc/cinfrt_va_usg(jtemp))
                      end if

                      if (type_disp_coeff == 2 .or. type_diff_ic_coeff == 2) then
                        disp_tensor = CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell2)
                        vels_dif_loc(ic,nvels(ic)) = -fluxd_vel_usg_tenf(disp_tensor,&    !diffusive term
                                                     grad_totcnew_mids(idvol,icell))
                      else
                        disp = CellCvolFace_disp_da(idvol_r,iedge_r,icell2)
                        vels_dif_loc(ic,nvels(ic)) = -fluxd_vel_usg_tend(disp,       &    !diffusive term
                                                     grad_totcnew_mids(idvol,icell))
                      end if
                    end if

                  end do
                end if
              end do

            end if

          end do
        end do

        do ic = 1, n
          vels_tmp_loc(1:nvels(ic)) = vels_adv_loc(ic,1:nvels(ic))
          if (grad_average_weighting == 2) then
            vels_adv(ic,ivol) = math_common_min(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 1) then
            vels_adv(ic,ivol) = math_common_harmonic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 0) then
            vels_adv(ic,ivol) = math_common_arithmetic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          end if

          vels_tmp_loc(1:nvels(ic)) = vels_dif_loc(ic,1:nvels(ic))
          if (grad_average_weighting == 2) then
            vels_dif(ic,ivol) = math_common_min(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 1) then
            vels_dif(ic,ivol) = math_common_harmonic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 0) then
            vels_dif(ic,ivol) = math_common_arithmetic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          end if

          vels_tmp_loc(1:nvels(ic)) = vels_mig_loc(ic,1:nvels(ic))
          if (grad_average_weighting == 2) then
            vels_mig(ic,ivol) = math_common_min(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 1) then
            vels_mig(ic,ivol) = math_common_harmonic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          else if (grad_average_weighting == 0) then
            vels_mig(ic,ivol) = math_common_arithmetic(nvels(ic),vels_tmp_loc(1:nvels(ic)))*rd3
          end if

          vels_tot(ic,ivol) = vels_adv(ic,ivol) + vels_dif(ic,ivol) + vels_mig(ic,ivol)
        end do
      end do

      call memory_monitor(-sizeof(vels_adv_loc),'vels_adv_loc',.true.)
      call memory_monitor(-sizeof(vels_dif_loc),'vels_dif_loc',.true.)
      call memory_monitor(-sizeof(vels_mig_loc),'vels_mig_loc',.true.)
      call memory_monitor(-sizeof(vels_tot_loc),'vels_tot_loc',.true.)
      call memory_monitor(-sizeof(vels_tmp_loc),'vels_tmp_loc',.true.)

      deallocate(vels_adv_loc)
      deallocate(vels_dif_loc)
      deallocate(vels_mig_loc)
      deallocate(vels_tot_loc)
      deallocate(vels_tmp_loc)


!c  open output files
      igsa = igsa_first
      igsa2 = igsa

!c  velocity of aqueous species in mixture
      do ic=1,n

        igsa2 = igsa2+1
        call icnvrt(0,ic,suffix2,l_sfx2,ierr)

        !c file for result and mesh
        !c note: binary output using separated file for each subdomain is
        !c deprecated for unstructured grid version
        if (b_output_binary) then
          strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
                        suffix2(:l_sfx2)//'.gsa'
          if (b_output_separate_mesh_result) then
            strfilename_result = trim(strfilename)//'.h5'
            strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
          else
            strfilename_result = trim(strfilename)//'.h5'
            strfilename_mesh = strfilename_result
          end if
        else
          strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_'//   &
             suffix2(:l_sfx2)//trim(adjustl(str_rank))//'.gsa'
        end if

        if (b_output_binary) then

#ifdef PETSC_HDF
          !c open corresponding xmf file to be loaded by paraview
          if (rank == 0) then
            ixmf = lun_get()
            open(ixmf,file=trim(strfilename)//'.xmf',status='unknown', &
                 form='formatted')
          end if

          !c initialize fortran interface
          call h5open_f(hdf5_ierr)

          !c setup file access property list with parallel I/O access
          call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
          call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,          &
                                  MPI_INFO_NULL, hdf5_ierr)
          !c create the file collectively
          call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,        &
                           file_id, hdf5_ierr, access_prp = plist_id)

          !c write attribute
          call hdf5_usg_write_attribute(file_id)

          if (.not. b_output_separate_mesh_result) then
            !c write mesh data
            call hdf5_usg_write_mesh_data(file_id)
          end if

          !c open corresponding xmf file for mesh and domain decomposition
          if (rank == 0) then
            call hdf5_usg_write_xmf_initialize(ixmf)
            call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,        &
                      cell_type,num_cells_gbl,num_nodes_gbl,           &
                      num_nodes_per_cell)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_rank",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_rank",          &
                      "Scalar","Cell",num_cells_gbl,1)

            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_lg2g",       &
                      "Scalar","Node",num_nodes_gbl,1)
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_lg2g",          &
                      "Scalar","Cell",num_cells_gbl,1)

            if (b_use_node_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_matid",    &
                        "Scalar","Node",num_nodes_gbl,1)
            end if
            if (b_use_cell_matids) then
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_matid",       &
                        "Scalar","Cell",num_cells_gbl,1)
            end if
          end if

          !c create a group for the mesh data set
          strbuffer = "results"
          !c create and open a group
          call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,       &
                           OBJECT_NAMELEN_DEFAULT_F)
#endif
        else
          open(igsa2,file=trim(strfilename)//'.vtk',                   &
               status='unknown', form='formatted')
        end if

        if (rank == 0 .and. b_enable_output) then
          write(ifls,'(/a, a, 1x, a, 1p, 1pe15.6e3, 1x, a, /, 72a)')   &
               'Average interfacial aqueous fluxes for component: ',   &
                namec(ic)(:l_namec(ic)),' T = ',                       &
                time_io,time_unit,('-',i=1,72)

          write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                   &
                suffix(:l_sufx)//'_'//suffix2(:l_sfx2)//               &
                trim(adjustl(str_rank))//'.gsa'

          write(ifls,'(2a)')                        &
              'column   entry                           ','unit'
          write(ifls,'(2a)')                        &
              '1        x                               ','m'
          write(ifls,'(2a)')                        &
              '2        y                               ','m'
          write(ifls,'(2a)')                        &
              '3        z                               ','m'
          write(ifls,'(2a)')                        &
              '4        v_x Advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '5        v_y Advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '6        v_z Advection                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '7        v_x Diffusion                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '8        v_y Diffusion                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '9        v_z Diffusion                   ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '10       v_x Electromigration            ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '11       v_y Electromigration            ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '12       v_z Electromigration            ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '13       v_x Total                       ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '14       v_y Total                       ','moles/m^2/d'
          write(ifls,'(2a)')                        &
              '15       v_z Total                       ','moles/m^2/d'

        end if

        if (.not. b_output_binary) then
          write(strbuffer,'(a,1x,1pe15.6e3,1x,a)')                     &
                  "Flow variables, solution time = ",time_io,time_unit
          call write_mesh_data_vtk_ascii(igsa2,trim(adjustl(strbuffer)))

          write(igsa2,'(a,1x,i12)') "POINT_DATA",nngl
        end if

        if (b_output_binary) then
          allocate(realbuffer(num_nodes*3), stat = ierr)
          call checkerr(ierr,'velocity_a_usg-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if

        !c write advective velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_adv(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_adv(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_adv(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_adv",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_adv","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_adv double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_adv(ic,ivol)%x,      &
                                             vels_adv(ic,ivol)%y,      &
                                             vels_adv(ic,ivol)%z
          end do
        end if

        !c write diffusive velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_dif(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_dif(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_dif(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_dif",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_dif","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_dif double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_dif(ic,ivol)%x,      &
                                             vels_dif(ic,ivol)%y,      &
                                             vels_dif(ic,ivol)%z
          end do
        end if

        !c write electromigration velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_mig(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_mig(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_mig(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_mig",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_mig","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_mig double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_mig(ic,ivol)%x,      &
                                             vels_mig(ic,ivol)%y,      &
                                             vels_mig(ic,ivol)%z
          end do
        end if

        !c write total velocity vector
        if (b_output_binary) then
#ifdef PETSC_HDF
          do ivol = 1, num_nodes
            realbuffer((ivol-1)*3+1) = vels_tot(ic,ivol)%x
            realbuffer((ivol-1)*3+2) = vels_tot(ic,ivol)%y
            realbuffer((ivol-1)*3+3) = vels_tot(ic,ivol)%z
          end do

          call hdf5_usg_write_group_data_vec(group_id,"velocity_tot",3,&
                    num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

          if (rank == 0) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                      "results","velocity_tot","Vector","Node",        &
                      num_nodes_gbl,3)
          end if
#endif
        else
          write(igsa2,'(a)') "VECTORS velocity_tot double"
          do ivol = 1, nngl
            write(igsa2,'(3(1pe15.6e3,1x))') vels_tot(ic,ivol)%x,      &
                                             vels_tot(ic,ivol)%y,      &
                                             vels_tot(ic,ivol)%z
          end do
        end if
        if (b_output_binary) then
          call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
          deallocate(realbuffer)
        end if

        if (b_output_binary) then
#ifdef PETSC_HDF
          !c close group
          call h5gclose_f(group_id,hdf5_ierr)

          !c close file
          call h5pclose_f(plist_id, hdf5_ierr)
          call h5fclose_f(file_id, hdf5_ierr)

          !c close FORTRAN interface
          call h5close_f(hdf5_ierr)

          !c close xmf file
          if (rank == 0) then
            call hdf5_usg_write_xmf_finalize(ixmf)
            close(ixmf)
            call lun_free(ixmf)
          end if
#endif
        else
          close(igsa2)
        end if

      enddo


!c  release memory space
      call memory_monitor(-sizeof(vels_adv),'vels_adv',.true.)
      call memory_monitor(-sizeof(vels_dif),'vels_dif',.true.)
      call memory_monitor(-sizeof(vels_mig),'vels_mig',.true.)
      call memory_monitor(-sizeof(vels_tot),'vels_tot',.true.)

      deallocate(vels_adv)
      deallocate(vels_dif)
      deallocate(vels_mig)
      deallocate(vels_tot)

      return

      end
#endif
