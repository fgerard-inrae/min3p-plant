!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/infheat_c_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

! ----------------------------------------------------------------------
! subroutine infheat_c_usg
! -------------------                                                   
!                                                                       
! compute influence coefficients for heat transport for USG
!
! written by:      Danyang Su - Aug 08, 2016
!
! last modified:
! definition of variables:                                              
!                                                                       
! I --> on input   * arbitrary  - initialized  + entries expected       
! O --> on output  * arbitrary  - unaltered    + altered                
!                                                                    I O
!     input:                                                            
!                                                                       
! passed:   real*8:                                                     
!           -------                                                     
!                                                                       
!                                                                       
! local:                                                                
!                                                                       
! external: diffcoff  = compute effective diffusion coefficient         
!           fluxdd    = flux function for fully saturated flow          
   
! ----------------------------------------------------------------------
#ifdef USG
      subroutine infheat_c_usg
#ifdef OPENMP
      use omp_lib
#endif
      use gen, only :                                                  &
#ifdef OPENMP
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infheat_c_1,                    &
#endif
                      iavs, javs, isymvs, nngl, pornew, sanew,         &
                      uvsnew, discretization_type, jacell,             &
                      useAnisoHeatCondCorr,                            &
                      janumcell, jaedgelen, jaedgeunitdirection,       &
                      idbg, ilog, rank, b_enable_output
      use m_heat_transport, only : cinfheat_c, heatcondw, heatconds,   &
          heatcondg, heatcondi, heatcond_model, nheatcond, tempnew
      use phys, only : aca_vol, is_cell_based_disp_heat
      use geometry
      use usg_mesh_data, only : nodes, cells, cell_type, cvol_method,  &
                                num_edge_dvols, num_edge_maxcells,     &
                                num_nodes_per_cell,                    &
                                cell_projection, CellCvolFaceArea,     &
                                CellCvolFaceArea,                      &
                                CellCvolFaceUnitNorm,                  &
                                CellCvolFace_heat_c,                   &
                                CellCvolFace_heat_c_tensor,            &                                
                                get_cell_edge_cvol_id

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
                                                                        
      implicit none 
                                                                        
                                                                        
!     local variables
      integer :: i, i2, icell, istart, iend, ii, ic, ivol, jvol,       &
                 jtemp, k, kvol, idvol, idvol_r, iedge_r, icell2,      &
                 info_debug

                                                                        
      real*8, parameter :: r0 = 0.0d0, rhalf = 0.5d0,                  &
                           r1 = 1.0d0, r2 = 2.0d0, rsmallarea = 1.0d-8
                                                                        
      real*8 :: porav, satav, lambdax, lambday, lambdaz,               &
                lambda_dry, lambda_sat,lambda_ivol, lambda_jvol,       &
                term1_ivol, term1_jvol, term2_ivol, term2_jvol,        &
                term1_kvol, term2_kvol, term1, term2,                  &
                cvolfacearea, rswitch
      real*8 :: relheat_iw_ivol(3), relheat_iw_jvol(3), relheat_iw_icell(3)
      type(point) :: tend, wtend, utend, vtend, ntend, aca_av
      type(tensor) :: tenf_cond, rml, rmr

      real*8 :: lambdaxyz_direct, lambdaxyz_cross, alpha, beta

      real*8 :: relheat_freezing
      external :: relheat_freezing

!  compute influence coefficients for advective flux terms              
!  (influence coefficients are equal Darcy flux = J_ij/A_ij)            
                                                                        
!  loop over control volumes                                            
                                                                        
      info_debug = 0 
                                                                        
!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infheat_c_1)                    &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, istart, iend, icell, icell2, idvol,          &
    !$omp idvol_r, iedge_r, jtemp, jvol,                              &
    !$omp cvolfacearea, lambdax, lambday, lambdaz, lambda_ivol,       &
    !$omp lambda_jvol, lambda_dry, lambda_sat, porav, rswitch,        &
    !$omp satav, term1, term2, term1_ivol, term1_jvol,                &
    !$omp term2_ivol, term2_jvol, tenf_cond, rml, rmr, aca_av,        &
    !$omp tend, ntend, wtend, utend, vtend)                
    !$omp do schedule(static)
#endif
      do ivol = 1, nngl

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1
        do jtemp = istart, iend    !c  loop over connections
          jvol = javs(jtemp)

          !c average of ivol-jvol, can be other interpolation methods
          porav = 0.5d0*(min(r1, pornew(ivol)) + min(r1,pornew(jvol)))

!c  calculate the dispersion tensor for the "pseudo dispersion element"
!c  average porosity of the element
          satav = 0.5d0*(min(r1,sanew(ivol))+min(r1,sanew(jvol)))

!cdsu get rotation angle for anisotropic thermal conductivity correction
          if (useAnisoHeatCondCorr) then
            aca_av = (aca_vol(ivol) + aca_vol(jvol))*rhalf
            call geometry_cal_rotation_matrix(aca_av,rml,rmr)
          end if

          if (.not. is_cell_based_disp_heat) then
            lambdax=r0
            lambday=r0
            lambdaz=r0

            !c update the coefficient for ice heat parameters compared 
            !c to water heat parameters
            relheat_iw_ivol(1) = relheat_freezing(tempnew(ivol),       &
                                 heatcondw(ivol,1), heatcondi(ivol,1), &
                                 uvsnew(ivol))
            relheat_iw_ivol(2) = relheat_freezing(tempnew(ivol),       &
                                 heatcondw(ivol,2), heatcondi(ivol,2), &
                                 uvsnew(ivol))
            relheat_iw_ivol(3) = relheat_freezing(tempnew(ivol),       &
                                 heatcondw(ivol,3), heatcondi(ivol,3), &
                                 uvsnew(ivol))

            relheat_iw_jvol(1) = relheat_freezing(tempnew(jvol),       &
                                 heatcondw(jvol,1), heatcondi(jvol,1), &
                                 uvsnew(jvol))
            relheat_iw_jvol(2) = relheat_freezing(tempnew(jvol),       &
                                 heatcondw(jvol,2), heatcondi(jvol,2), &
                                 uvsnew(jvol))
            relheat_iw_jvol(3) = relheat_freezing(tempnew(jvol),       &
                                 heatcondw(jvol,3), heatcondi(jvol,3), &
                                 uvsnew(jvol))                                 

            select case (heatcond_model)
              case ('model 1')
                lambdax = 0.5d0*(porav*satav*heatcondw(ivol,1)*        &
                                 relheat_iw_ivol(1)+                   &
                                (r1-porav)*heatconds(ivol,1)+          &
                                 porav*satav*heatcondw(jvol,1)*        &
                                 relheat_iw_jvol(1)+                   &
                                (r1-porav)*heatconds(jvol,1))

                lambday = 0.5d0*(porav*satav*heatcondw(ivol,2)*        &
                                 relheat_iw_ivol(2)+                   &
                                (r1-porav)*heatconds(ivol,2)+          &
                                 porav*satav*heatcondw(jvol,2)*        &
                                 relheat_iw_jvol(2)+                   &
                                (r1-porav)*heatconds(jvol,2))

                lambdaz = 0.5d0*(porav*satav*heatcondw(ivol,3)*        &
                                 relheat_iw_ivol(3)+                   &
                                (r1-porav)*heatconds(ivol,3)+          &
                                 porav*satav*heatcondw(jvol,3)*        &
                                 relheat_iw_jvol(3)+                   &
                                (r1-porav)*heatconds(jvol,3))

              case ('model 2')

                lambda_ivol = 86.4d0*(0.228d0-2.406d0*pornew(ivol)*    &
                              sanew(ivol)+4.909d0*                     &
                              (pornew(ivol)*sanew(ivol))**0.5d0)

                lambda_jvol = 86.4d0*(0.228d0-2.406d0*pornew(jvol)*    &
                              sanew(jvol)+4.909d0*                     &
                              (pornew(jvol)*sanew(jvol))**0.5d0)

                lambdax = 0.5d0*(lambda_ivol + lambda_jvol)
                lambday = 0.5d0*(lambda_ivol + lambda_jvol)
                lambdaz = 0.5d0*(lambda_ivol + lambda_jvol)

              case ('model 3')
                 lambda_dry = heatconds(ivol,1)**(r1-pornew(ivol))*    &
                              heatcondg**pornew(ivol)
                 lambda_sat = heatconds(ivol,1)**(r1-pornew(ivol))*    &
                              (heatcondw(ivol,1)*relheat_iw_ivol(1))**pornew(ivol)

                 lambda_ivol = lambda_sat*dsqrt(sanew(ivol))+          &
                              lambda_dry*(r1-dsqrt(sanew(ivol)))

                 lambda_dry = heatconds(jvol,1)**(r1-pornew(jvol))*    &
                              heatcondg**pornew(jvol)
                 lambda_sat = heatconds(jvol,1)**(r1-pornew(jvol))*    &
                              (heatcondw(jvol,1)*relheat_iw_jvol(1))**pornew(jvol)

                 lambda_jvol = lambda_sat*dsqrt(sanew(jvol))+          &
                             lambda_dry*(r1-dsqrt(sanew(jvol)))
                 lambdax = 0.5d0*(lambda_ivol + lambda_jvol)

!---------------------------------------------------------------
                 lambda_dry = heatconds(ivol,2)**(r1-pornew(ivol))*    &
                              heatcondg**pornew(ivol)
                 lambda_sat = heatconds(ivol,2)**(r1-pornew(ivol))*    &
                              (heatcondw(ivol,2)*relheat_iw_ivol(2))**pornew(ivol)

                 lambda_ivol = lambda_sat*dsqrt(sanew(ivol))+          &
                              lambda_dry*(r1-dsqrt(sanew(ivol)))

                 lambda_dry = heatconds(jvol,2)**(r1-pornew(jvol))*    &
                              heatcondg**pornew(jvol)
                 lambda_sat = heatconds(jvol,2)**(r1-pornew(jvol))*    &
                              (heatcondw(jvol,2)*relheat_iw_jvol(2))**pornew(jvol)

                 lambda_jvol = lambda_sat*dsqrt(sanew(jvol))+          &
                             lambda_dry*(r1-dsqrt(sanew(jvol)))
                 lambday = 0.5d0*(lambda_ivol + lambda_jvol)
!---------------------------------------------------------------
                 lambda_dry = heatconds(ivol,3)**(r1-pornew(ivol))*    &
                              heatcondg**pornew(ivol)
                 lambda_sat = heatconds(ivol,3)**(r1-pornew(ivol))*    &
                              (heatcondw(ivol,3)*relheat_iw_ivol(3))**pornew(ivol)

                 lambda_ivol = lambda_sat*dsqrt(sanew(ivol))+          &
                              lambda_dry*(r1-dsqrt(sanew(ivol)))

                 lambda_dry = heatconds(jvol,3)**(r1-pornew(jvol))*    &
                              heatcondg**pornew(jvol)
                 lambda_sat = heatconds(jvol,3)**(r1-pornew(jvol))*    &
                              (heatcondw(jvol,3)*relheat_iw_jvol(3))**pornew(jvol)

                 lambda_jvol = lambda_sat*dsqrt(sanew(jvol))+          &
                             lambda_dry*(r1-dsqrt(sanew(jvol)))
                 lambdaz = 0.5d0*(lambda_ivol + lambda_jvol)


              case ('model 4')

                lambda_dry = heatconds(ivol,1)**(r1-pornew(ivol))*     &
                             heatcondg**pornew(ivol)
                lambda_sat = heatconds(ivol,1)**(r1-pornew(ivol))*     &
                             (heatcondw(ivol,1)*relheat_iw_ivol(1))**pornew(ivol)

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,1)**(r1-pornew(jvol))*     &
                             heatcondg**pornew(jvol)
                lambda_sat = heatconds(jvol,1)**(r1-pornew(jvol))*     &
                             (heatcondw(jvol,1)*relheat_iw_jvol(1))**pornew(jvol)

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambdax = 0.5d0*(lambda_ivol + lambda_jvol)
!--------------------------------------------------------------
                lambda_dry = heatconds(ivol,2)**(r1-pornew(ivol))*     &
                             heatcondg**pornew(ivol)
                lambda_sat = heatconds(ivol,2)**(r1-pornew(ivol))*     &
                             (heatcondw(ivol,2)*relheat_iw_ivol(2))**pornew(ivol)

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,2)**(r1-pornew(jvol))*     &
                             heatcondg**pornew(jvol)
                lambda_sat = heatconds(jvol,2)**(r1-pornew(jvol))*     &
                             (heatcondw(jvol,2)*relheat_iw_jvol(2))**pornew(jvol)

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambday = 0.5d0*(lambda_ivol + lambda_jvol)
!--------------------------------------------------------------
                lambda_dry = heatconds(ivol,3)**(r1-pornew(ivol))*     &
                             heatcondg**pornew(ivol)
                lambda_sat = heatconds(ivol,3)**(r1-pornew(ivol))*     &
                             (heatcondw(ivol,3)*relheat_iw_ivol(3))**pornew(ivol)

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,3)**(r1-pornew(jvol))*     &
                             heatcondg**pornew(jvol)
                lambda_sat = heatconds(jvol,3)**(r1-pornew(jvol))*     &
                             (heatcondw(jvol,3)*relheat_iw_jvol(3))**pornew(jvol)

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambdaz = 0.5d0*(lambda_ivol + lambda_jvol)

              case ('model 5')
                term1_ivol = (r1-pornew(ivol))**nheatcond
                term2_ivol = pornew(ivol)**nheatcond
                term1_jvol = (r1-pornew(jvol))**nheatcond
                term2_jvol = pornew(jvol)**nheatcond

                lambda_dry = heatconds(ivol,1)*term1_ivol+             &
                             heatcondg*term2_ivol
                lambda_sat = heatconds(ivol,1)*term1_ivol+             &
                             heatcondw(ivol,1)*relheat_iw_ivol(1)*term2_ivol

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,1)*term1_jvol+             &
                             heatcondg*term2_jvol
                lambda_sat = heatconds(jvol,1)*term1_jvol+             &
                             heatcondw(jvol,1)*relheat_iw_jvol(1)*term2_jvol

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambdax = 0.5d0*(lambda_ivol + lambda_jvol)
!--------------------------------------------------------------
                lambda_dry = heatconds(ivol,2)*term1_ivol+             &
                             heatcondg*term2_ivol
                lambda_sat = heatconds(ivol,2)*term1_ivol+             &
                             heatcondw(ivol,2)*relheat_iw_ivol(2)*term2_ivol

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,2)*term1_jvol+             &
                             heatcondg*term2_jvol
                lambda_sat = heatconds(jvol,2)*term1_jvol+             &
                             heatcondw(jvol,2)*relheat_iw_jvol(2)*term2_jvol

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambday = 0.5d0*(lambda_ivol + lambda_jvol)
!--------------------------------------------------------------
                lambda_dry = heatconds(ivol,3)*term1_ivol+             &
                             heatcondg*term2_ivol
                lambda_sat = heatconds(ivol,3)*term1_ivol+             &
                             heatcondw(ivol,3)*relheat_iw_ivol(3)*term2_ivol

                lambda_ivol = lambda_sat**sanew(ivol)*                 &
                             lambda_dry**(r1-sanew(ivol))

                lambda_dry = heatconds(jvol,3)*term1_jvol+             &
                             heatcondg*term2_jvol
                lambda_sat = heatconds(jvol,3)*term1_jvol+             &
                             heatcondw(jvol,3)*relheat_iw_jvol(3)*term2_jvol

                lambda_jvol =  lambda_sat**sanew(jvol)*                &
                             lambda_dry**(r1-sanew(jvol))
                lambdaz = 0.5d0*(lambda_ivol + lambda_jvol)

              case ('model 6')


                 lambda_ivol =0.228d0-2.406d0*sanew(ivol)*pornew(ivol) &
                         + 4.909d0*(sanew(ivol)*pornew(ivol))**rhalf
                 lambda_ivol = lambda_ivol * 86.4d0

                 lambda_jvol =0.228d0-2.406d0*sanew(jvol)*pornew(jvol) &
                           + 4.909d0*(sanew(jvol)*pornew(jvol))**rhalf
                 lambda_jvol = lambda_jvol * 86.4d0

                 lambdax = 0.5d0*(lambda_ivol + lambda_jvol)
                 lambday = 0.5d0*(lambda_ivol + lambda_jvol)
                 lambdaz = 0.5d0*(lambda_ivol + lambda_jvol)

            end select

            tend = math_common_set_vector(lambdax,lambday,lambdaz)

          end if

          do icell = 1, janumcell(jtemp)   !c loop over all linked cells
            icell2 = jacell(icell,jtemp)
            if (icell2 <= 0) then
              cycle
            end if
            if (is_cell_based_disp_heat) then
              lambdax=r0
              lambday=r0
              lambdaz=r0

              !c update the coefficient for ice heat parameters compared 
              !c to water heat parameters
              relheat_iw_icell(1) = relheat_freezing(                      &
                                  (tempnew(ivol)+tempnew(jvol))*0.5d0,     &
                                  heatcondw(icell2,1),heatcondi(icell2,1), &
                                  (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
              relheat_iw_icell(2) = relheat_freezing(                      &
                                  (tempnew(ivol)+tempnew(jvol))*0.5d0,     &
                                  heatcondw(icell2,2),heatcondi(icell2,2), &
                                  (uvsnew(ivol)+uvsnew(jvol))*0.5d0) 
              relheat_iw_icell(3) = relheat_freezing(                      &
                                  (tempnew(ivol)+tempnew(jvol))*0.5d0,     &
                                  heatcondw(icell2,3),heatcondi(icell2,3), &
                                  (uvsnew(ivol)+uvsnew(jvol))*0.5d0)

              select case (heatcond_model)
                case ('model 1')
                  lambdax = porav*satav*heatcondw(icell2,1)*relheat_iw_icell(1)+ &
                                (r1-porav)*heatconds(icell2,1)

                  lambday = porav*satav*heatcondw(icell2,2)*relheat_iw_icell(2)+ &
                                 (r1-porav)*heatconds(icell2,2)

                  lambdaz = porav*satav*heatcondw(icell2,3)*relheat_iw_icell(3)+ &
                                 (r1-porav)*heatconds(icell2,3)

                case ('model 2')

                  lambdax = 86.4d0*(0.228d0-2.406d0*porav*         &
                                    sanew(ivol)+4.909d0*           &
                                    (porav*satav)**0.5d0)
                  lambday = lambdax
                  lambdaz = lambdax

                case ('model 3')
                   lambda_dry = heatconds(icell2,1)**(r1-porav)*    &
                                heatcondg**porav
                   lambda_sat = heatconds(icell2,1)**(r1-porav)*    &
                                (heatcondw(icell2,1)*relheat_iw_icell(1))**porav

                   lambdax    = lambda_sat*dsqrt(satav)+            &
                                lambda_dry*(r1-dsqrt(satav))
!---------------------------------------------------------------
                   lambda_dry = heatconds(icell2,2)**(r1-porav)*    &
                                heatcondg**porav
                   lambda_sat = heatconds(icell2,2)**(r1-porav)*    &
                                (heatcondw(icell2,2)*relheat_iw_icell(2))**porav

                   lambday    = lambda_sat*dsqrt(satav)+            &
                                lambda_dry*(r1-dsqrt(satav))
!---------------------------------------------------------------
                   lambda_dry = heatconds(icell2,3)**(r1-porav)*    &
                                heatcondg**porav
                   lambda_sat = heatconds(icell2,3)**(r1-porav)*    &
                                (heatcondw(icell2,3)*relheat_iw_icell(3))**porav

                   lambdaz    = lambda_sat*dsqrt(satav)+            &
                                lambda_dry*(r1-dsqrt(satav))

                case ('model 4')

                  lambda_dry = heatconds(icell2,1)**(r1-porav)*     &
                               heatcondg**porav
                  lambda_sat = heatconds(icell2,1)**(r1-porav)*     &
                               (heatcondw(icell2,1)*relheat_iw_icell(1))**porav

                  lambdax =    lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)
!--------------------------------------------------------------
                  lambda_dry = heatconds(icell2,2)**(r1-porav)*     &
                               heatcondg**porav
                  lambda_sat = heatconds(icell2,2)**(r1-porav)*     &
                               (heatcondw(icell2,2)*relheat_iw_icell(2))**porav

                  lambday =    lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)
!--------------------------------------------------------------
                  lambda_dry = heatconds(icell2,3)**(r1-porav)*     &
                               heatcondg**porav
                  lambda_sat = heatconds(icell2,3)**(r1-porav)*     &
                               (heatcondw(icell2,3)*relheat_iw_icell(3))**porav

                  lambdaz =    lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)

                case ('model 5')
                  term1 = (r1-porav)**nheatcond
                  term2 = porav**nheatcond

                  lambda_dry = heatconds(icell2,1)*term1+           &
                               heatcondg*term2
                  lambda_sat = heatconds(icell2,1)*term1+           &
                               heatcondw(icell2,1)*relheat_iw_icell(1)*term2

                  lambdax    = lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)
!--------------------------------------------------------------
                  lambda_dry = heatconds(icell2,2)*term1+           &
                               heatcondg*term2
                  lambda_sat = heatconds(icell2,2)*term1+           &
                               heatcondw(icell2,2)*relheat_iw_icell(2)*term2

                  lambday    = lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)
!--------------------------------------------------------------
                  lambda_dry = heatconds(icell2,3)*term1+           &
                               heatcondg*term2
                  lambda_sat = heatconds(icell2,3)*term1+           &
                               heatcondw(icell2,3)*relheat_iw_icell(3)*term2

                  lambdaz    = lambda_sat**satav*                   &
                               lambda_dry**(r1-satav)

                case ('model 6')

                   lambdax = (0.228d0-2.406d0*satav*porav +         &
                              4.909d0*(satav*porav)**rhalf)* 86.4d0
                   lambday = lambdax
                   lambdaz = lambdax

              end select

              tend = math_common_set_vector(lambdax,lambday,lambdaz)

            end if

            do idvol = 1, num_edge_dvols   !c loop over all dual volumes
              call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,       &
                                         idvol_r,iedge_r,rswitch)
              cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell2)
              if(jacell(icell,jtemp) > 0 .and. cvolfacearea > rsmallarea) then

                !c save diffision conductivity tensor
                if (rswitch > r0) then
                  if (useAnisoHeatCondCorr) then
                    tenf_cond = tensor_zero
                    tenf_cond%xx = tend%x
                    tenf_cond%yy = tend%y
                    tenf_cond%zz = tend%z

                    tenf_cond = (rml.dot.tenf_cond).dot.rmr  
                    
                    CellCvolFace_heat_c_tensor(idvol_r,iedge_r,icell2) = tenf_cond
                  else
                    CellCvolFace_heat_c(idvol_r,iedge_r,icell2) = tend
                  end if
                end if

              end if
            end do
          end do

        end do                     !c  loop over connections
      end do                       !c  loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      return 
      END                                           
#endif
