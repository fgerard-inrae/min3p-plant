!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/infcrtdd_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine infcrtdd_usg
!c -------------------
!c
!c compute influence coefficients for advective and dispersive flux 
!c terms for rectangular, cartesian finite volume discretization 
!c (reactive transport) for aqueous phase using density dependent 
!c flow equation
!c
!c from Tom Henderson - July 11, 2003 template
!c
!c written by:      Danyang Su - Aug 08, 2016
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c     input:
!c
!c passed:   real*8:
!c           -------
!c           dimcv(3, ibk)          = dimension of cells in x,y,z         + -
!c                                direction
!c           density(nn)        = fluid density                       + - 
!c           dvolcoef           = volume flux coefficient including   * +       
!c                                viscosity and relative permeability
!c           diff_a              = phase molecular diffusion (m2/day)
!c           disx(nzn)          = dispersion, x direction (m)
!c           disy(nzn)          =    "      , y    "      (m)
!c           disz(nzn)          =    "      , z    "      (m)
!c           cinfrt_va()        = influence coefficients 
!c                                J^w_ij/A_ij
!c                                (advective flux terms)
!c           cinfrt_da()        = influence coefficients
!c                                D_ij * A_ij / d_ij  
!c                                (dispersvie flux terms)
!c           viscosity(nn)      = fluid viscosity                     - -     
!c
!c           integer*4:
!c           ----------
!c           ibk                = block i
!c           id                 = connected block j
!c           idbg               = output for debugging information
!c           ilog               = unit number, logbook
!c           nngl               = max cells for dim purposes
!c           nphas              = max number of phases
!c           njavs             = max dim javs array (ncomp.com)
!c           nvx                = number of control volumes 
!c                                in x direction
!c           nvy                = number of control volumes 
!c                                in y direction
!c           nvz                = number of control volumes 
!c                                in z direction
!c           pornew(ibk)        = porosity
!c           sanew(nngl)        = aqueous phase saturation
!c                                - new time level
!c           uvsnew(nngl)       = pressure
!c           relperm(nngl)      = rel permeability
!c           cinfvs_a(nngl)       = influence coefficient
!c                                (variably saturated flow) 
!c           iavs(), javs()         = ysmp pointers
!c           isymvs(ii)          = symmetry pointer for cell ibk
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions
!c           variably_saturated = .true.  -> .not.fully_saturated,
!c                                        -> variably saturated
!c                                           conditions
!c           half_cells         = .true.  -> half cells on boundary
!c           tortuosity_corr    = .true.  -> Millington-Quirk 
!c                                           tortuosity correction
!c                                           for diffusion
!c                                           coefficients
!c
!c
!c
!c local:
!c
!c external: diffcoff  = compute effective diffusion coefficient
!c           fluxdd    = flux function for fully saturated flow 
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine infcrtdd_usg

#ifdef OPENMP
      use omp_lib 
#endif

      use gen, only :                                                  &
#ifdef OPENMP
                      numofthreads_global,                             &
                      numofloops_thred_global,                         &
                      numofloops_thred_infcrtdd_1,                     &
                      numofloops_thred_infcrtdd_2,                     &
                      numofloops_thred_infcrtdd_3,                     &
#endif
                      iavs, javs, isymvs, cinfvs_a, cinfrt_va_usg,     &
                      cinfrt_da, mpropvs, mpropvs_cell, pornew, sanew, &
                      type_averaging_de, b_water_freezing, tkel,       &
                      uvsnew, sonew, relperm, fully_saturated,         &
                      variably_saturated, njavs, nngl,                 &
                      tortuosity_corr, time, tfinal, cinfrt_da_ic,     &
                      diff_coff, diff_ic, diff_ic_tensor,              &
                      type_diff_coeff, type_diff_ic_coeff,             &
                      useAnisoTauCorr, useAnisoDispCorr,               &
                      useAnisoCondCorr, assigned_tau, tau,             &
                      type_disp_coeff, type_cond_perm,                 &                      
                      type_tortuosity, marchies, harmonic_porosity,    &
                      gacc, cinfrad, radial_coord, tau_fac,            &
                      tor_corr_a_mq, tor_corr_b_mq,                    &
                      b_use_fixed_flow_vel, fixed_flow_vel,            &
                      discretization_type, jacell, janumcell,          &
                      jaedgeunitdirection, jaedgelen,                  &
                      b_grad_interpolate_cell, jagradweight,           &
                      jacrossdiffweight, b_grad_interpolate_cell,      &
                      jacrossdifficv, jacrossdifficvnum,               &   
                      num_crossdifficv_max,                            &                   
                      idbg, ilog, rank, b_enable_output

      use dens, only : ups_flow, density, viscosity, av_dens_z
      use phys, only : disx, disy, disz, diff_a, oil_saturation,       &
                       is_cell_based_disp_rt, is_cell_based_relp,      &
                       atc_zone, aca_vol, frozen_diff_a, diff_a_tensor
      use chem, only : nc
      use m_heat_transport, only : heat_transport, ups_heat,           &
                                   decoupled_type_vs_heat
      use multidiff, only : multi_diff
      use mod_diffcoff, only : diffcoff
      use geometry
      use math_common, only : math_common_harmonic
      use usg_mesh_data, only : nodes, cells, cell_type, num_cells,    &
                                num_edge_dvols, num_edge_maxcells,     &
                                num_edges_per_cell,                    &
                                grad_method, cell_projection,          &
                                CellCvolFaceArea,                      &
                                CellCvolFaceUnitNorm,                  &
                                CellCvolFace_cond,                     &
                                CellCvolFace_cond_tensor,              &
                                CellCvolFace_disp_da,                  &
                                CellCvolFace_disp_da_tensor,           &
                                CellCvolFace_disp_da_ic,               &
                                CellCvolFace_disp_da_ic_tensor,        &
                                CellCvolFace_adv,                      &
                                get_cell_edge_cvol_id

      use usg_face_utility, only : usg_face_utility_cinfvs,            &
                                   usg_face_utility_vel_ddflow
      use gradient_usg, only : gradient_cross_diff_dd
      use mod_fluxdd_usg

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none

!c     local variables
      
      integer :: i, i2, ic, j, k, ivol, jvol, kvol, jtemp1, icell,     &
                 inode, icon, jtemp2, istart, iend, iedge, idvol,      &
                 ndvol, icell1, icell2, idvol_r, iedge_r,              &
                 izn, jzn, info_debug

      real*8, parameter :: eps = 1.0d-300, r0 = 0.0d0,                 &
                rhalf = 0.5d0, r1 = 1.0d0, r2 = 2.0d0, r3 = 3.0d0,     &
                pi = 3.141592653589793d0, rsmallarea = 1.0d-8,       &
                rverysmall = 1.0d-100

      real*8 :: ups_flow_loc, visco_av, rpel_av, porav, satav,         &
                so_av, vx2, vy2, vz2, vmag, diffav, diff_eff,          &
                disx_avg, disy_avg, disz_avg,                          &
                disxy_avg, disxz_avg, disyz_avg, delp_dd,              &
                delz_dd, rho_av, dvolcoef, tauav, marchieav

      real*8 :: diff_i, diff_j, areaf, por_i, por_j,                   &
                tau_i, tau_j, diff_eff_i, diff_eff_j,                  &
                cvolfacearea, rswitch

      real*8 :: flux_ddflow_hls_corr(num_edge_dvols,num_edge_maxcells)

      type(point) :: vel, vxyz2, tend, atc_av, aca_av, cond,           &
                     grad_ddflow_ivol, grad_ddflow_jvol,               &
                     grad_ddflow_kvol,                                 &
                     grad_ddflow_mids(num_edge_dvols,num_edge_maxcells)
      type(grad_hls_term) :: grad_ddflow_hls_loc(num_edge_dvols)
      real*8 :: diffxyz_avg, disxyz_avg_direct, disxyz_avg_cross

      type(tensor) :: diffav_tensor, diff_eff_tensor,                  &
                      diff_eff_i_tensor, diff_eff_j_tensor,            &
                      diff_i_tensor, diff_j_tensor, rml, rmr,          &
                      diffxyz_avg_tensor, tenf, tenf_cond

      type(point) :: velsloc(num_edge_dvols)

      real*8 :: cinfvs_usg_loc(num_edge_dvols,num_edge_maxcells)
      type(point) :: cinfvs_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

      real*8 :: grad_weights(num_crossdifficv_max)
      type(point) :: grad_ddflow_loc(num_crossdifficv_max)

      real*8 :: pressure_melt_k
      external :: pressure_melt_k

!c  compute influence coefficients for advective flux terms
!c  (influence coefficients are equal Darcy flux = J_ij/A_ij)

      info_debug = 0 
      ivol=0
      tau_i = r1
      tau_j = r1


!c  set upstream factor
      if (heat_transport .and. decoupled_type_vs_heat <= 1) then
        ups_flow_loc = ups_heat
      else
        ups_flow_loc = ups_flow
      end if

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infcrtdd_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, istart, iend, icell1, icell2,                &
    !$omp idvol, idvol_r, iedge_r, jtemp1, jvol, kvol, ndvol,         &
    !$omp tend, tenf, tenf_cond,                                      &
    !$omp cvolfacearea, cond, delp_dd, delz_dd, dvolcoef,             &
    !$omp rho_av, rpel_av, rswitch, visco_av,                         &
    !$omp flux_ddflow_hls_corr, grad_ddflow_hls_loc,                  &
    !$omp grad_ddflow_mids, grad_ddflow_loc, grad_ddflow_ivol,        &
    !$omp grad_ddflow_jvol, grad_ddflow_kvol, grad_weights,           &
    !$omp cinfvs_usg_loc, cinfvs_usg_cross_loc)
    !$omp do schedule(static)
#endif
      do ivol = 1, nngl

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1

        do jtemp1 = istart, iend       !c loop over connections
          jvol = javs(jtemp1)

          cinfrt_va_usg(jtemp1) = r0

!c  find darcy volume (not mass) flux between node pair
          delp_dd = uvsnew(jvol) - uvsnew(ivol)
          delz_dd = nodes(jvol)%z - nodes(ivol)%z
          rho_av = rhalf * (density(ivol) + density(jvol))

!c  convert delz_dd to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential

          delz_dd = delz_dd * rho_av * gacc
          delp_dd = delp_dd + delz_dd

!c  assign coefficients for upstream weighting
!c calculate water volume (not mass!!) fluxes
          if (delp_dd .gt. r0) then
            if (.not. is_cell_based_relp) then
              rpel_av = ups_flow_loc*relperm(jvol) +                   &
                        (r1-ups_flow_loc)*relperm(ivol)
            end if
            visco_av = ups_flow_loc*viscosity(jvol) +                  &
                       (r1-ups_flow_loc)*viscosity(ivol)
          else
            if (.not. is_cell_based_relp) then
              rpel_av = ups_flow_loc*relperm(ivol) +                   &
                        (r1-ups_flow_loc)*relperm(jvol)
            end if
            visco_av = ups_flow_loc*viscosity(ivol) +                  &
                       (r1-ups_flow_loc)*viscosity(jvol)
          end if

          if (is_cell_based_relp) then
            dvolcoef=1.0d0/visco_av
          else
            dvolcoef=rpel_av/visco_av
          end if

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
          grad_ddflow_mids = vector_zero
          flux_ddflow_hls_corr = r0

          call gradient_cross_diff_dd(jtemp1,ivol,jvol,grad_ddflow_loc,&
               grad_ddflow_mids,grad_weights,flux_ddflow_hls_corr,     &
               grad_ddflow_hls_loc)          

!cdsu calculate influence coefficient for variable saturated flow
          call usg_face_utility_cinfvs(ivol,jvol,jtemp1,cinfvs_usg_loc,&
                                       cinfvs_usg_cross_loc)

!c  find darcy volume (not mass) flux
          if (is_cell_based_relp) then
            do icell1 = 1, janumcell(jtemp1)
              icell2 = jacell(icell1,jtemp1)
              if (icell2 > 0) then
                do idvol = 1, num_edge_dvols

                  call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,   &
                                             idvol_r,iedge_r,rswitch)
                  cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,     &
                                                  icell2)
                  
                  if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                    tenf_cond = CellCvolFace_cond_tensor(idvol_r,iedge_r,icell2)
                  else if (type_cond_perm == 1) then
                    cond = CellCvolFace_cond(idvol_r,iedge_r,icell2)
                  end if

                  if (cvolfacearea > rsmallarea) then
                    cinfrt_va_usg(jtemp1) = cinfrt_va_usg(jtemp1)      &
                      - fluxdd_usg(delp_dd,1,1,                        &
                                   grad_ddflow_mids(idvol,icell1),     &
                                   flux_ddflow_hls_corr(idvol,icell1), &
                                   cinfvs_usg_loc(idvol,icell1),       &
                                   cinfvs_usg_cross_loc(idvol,icell1), &
                                   .true.,1,(/relperm(icell2)/)*dvolcoef)

                    if (rswitch > r0) then                      
                      if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                        CellCvolFace_adv(idvol_r,iedge_r,icell2) =       &
                          - fluxdd_vel_usg_tenf(relperm(icell2)*dvolcoef,&
                                tenf_cond,grad_ddflow_mids(idvol,icell1))
                      else if (type_cond_perm == 1) then
                        CellCvolFace_adv(idvol_r,iedge_r,icell2) =       &
                          - fluxdd_vel_usg_tend(relperm(icell2)*dvolcoef,&
                                cond,grad_ddflow_mids(idvol,icell1))
                      end if
                    end if

                  else

                    if (rswitch > r0) then
                      CellCvolFace_adv(idvol_r,iedge_r,icell2) = vector_zero
                    end if

                  end if
                end do
              end if
            end do
          else
            do icell1 = 1, janumcell(jtemp1)
              icell2 = jacell(icell1,jtemp1)
              if (icell2 > 0) then
                do idvol = 1, num_edge_dvols

                  call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,   &
                                             idvol_r,iedge_r,rswitch)
                  cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,     &
                                                  icell2)
                  
                  if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                    tenf_cond = CellCvolFace_cond_tensor(idvol_r,iedge_r,icell2)
                  else if (type_cond_perm == 1) then
                    cond = CellCvolFace_cond(idvol_r,iedge_r,icell2)
                  end if

                  if (cvolfacearea > rsmallarea) then
                    cinfrt_va_usg(jtemp1) = cinfrt_va_usg(jtemp1)      &
                      - fluxdd_usg(delp_dd,1,1,                        &
                                   grad_ddflow_mids(idvol,icell1),     &
                                   flux_ddflow_hls_corr(idvol,icell1), &
                                   cinfvs_usg_loc(idvol,icell1),       &
                                   cinfvs_usg_cross_loc(idvol,icell1), &
                                   .false.,1,(/dvolcoef/))

                    if (rswitch > r0) then                      
                      if (type_cond_perm == 2 .or. useAnisoCondCorr) then
                        CellCvolFace_adv(idvol_r,iedge_r,icell2) =     &
                          - fluxdd_vel_usg_tenf(dvolcoef,tenf_cond,    &
                                   grad_ddflow_mids(idvol,icell1))
                      else if (type_cond_perm == 1) then
                        CellCvolFace_adv(idvol_r,iedge_r,icell2) =     &
                          - fluxdd_vel_usg_tend(dvolcoef,cond,         &
                                   grad_ddflow_mids(idvol,icell1))
                      end if
                    end if

                  else

                    if (rswitch > r0) then
                      CellCvolFace_adv(idvol_r,iedge_r,icell2) = vector_zero
                    end if

                  end if
                end do
              end if
            end do
          end if

        end do                        !c loop over connections
      end do                          !c loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 


#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_infcrtdd_3)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (icell, icell1, icell2, ic, idvol, idvol_r,         &
    !$omp iedge, iedge_r, ivol, istart, iend, jvol, jtemp1, jtemp2,   &
    !$omp izn, jzn, atc_av, aca_av, rml, rmr, vel, velsloc,           &
    !$omp tend, tenf, cvolfacearea, diffav, diff_i, diff_j, diff_eff, &
    !$omp diff_eff_i, diff_eff_j, diffxyz_avg, disx_avg,              &
    !$omp disxy_avg, disxz_avg, disyz_avg,                            &
    !$omp diffav_tensor, diff_i_tensor, diff_j_tensor,                &
    !$omp diff_eff_tensor, diff_eff_i_tensor, diff_eff_j_tensor,      &
    !$omp diffxyz_avg_tensor,                                         &
    !$omp disy_avg, disz_avg, marchieav, porav, por_i, por_j,         &
    !$omp rswitch, satav, so_av, tauav, tau_i, tau_j, vmag, vxyz2)                  
    !$omp do schedule(static)
#endif
      do icell = 1, num_cells         !c loop over cells

!c  set zero vector to relative variables
        vel = vector_zero
        tend = vector_zero

!c  find ivol-jvol pair for the cell and calculate velocity component for this cell
        if (cell_type == cell_type_tri .or. cell_type == cell_type_quad) then
          do iedge = 1, num_edges_per_cell  !c loop over cell edges

            if (cell_type == cell_type_tri) then
              ivol = cells(edge_node_mapping_tri(1,iedge),icell)
              jvol = cells(edge_node_mapping_tri(2,iedge),icell)
            else if (cell_type == cell_type_quad) then
              ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
              jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
            end if

            !get the jtemp1 value
            istart = iavs(ivol)+1
            iend = iavs(ivol+1)-1
            do jtemp1 = istart, iend       !c loop over connections
              if(jvol == javs(jtemp1)) then
                exit
              end if
            end do
          end do
        else if (cell_type == cell_type_tetra .or.                     &
                 cell_type == cell_type_hexa .or.                      &
                 cell_type == cell_type_prism) then
          do iedge = 1, num_edges_per_cell

            if (cell_type == cell_type_tetra) then
              ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
              jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
            else if (cell_type == cell_type_hexa) then
              ivol = cells(edge_node_mapping_hexa(1,iedge),icell)
              jvol = cells(edge_node_mapping_hexa(2,iedge),icell)
            else if (cell_type == cell_type_prism) then
              ivol = cells(edge_node_mapping_prism(1,iedge),icell)
              jvol = cells(edge_node_mapping_prism(2,iedge),icell)
            end if

            !get the jtemp1 value
            istart = iavs(ivol)+1
            iend = iavs(ivol+1)-1
            do jtemp1 = istart, iend       !c loop over connections
              if(jvol == javs(jtemp1)) then
                exit
              end if
            end do

            !get the cell index of jacell
            icell1 = 0
            do icell1 = 1, janumcell(jtemp1)
              if (jacell(icell1,jtemp1) == icell) then
                exit
              end if
            end do

          end do
        end if

!c  find ivol-jvol pair for the cell and calculate influence coefficient
!c  jtemp1 is the index for edge ivol-jvol and jtemp2 is the index for edge jvol-ivol
        do iedge = 1, num_edges_per_cell
          if (cell_type == cell_type_tri) then
            ivol = cells(edge_node_mapping_tri(1,iedge),icell)
            jvol = cells(edge_node_mapping_tri(2,iedge),icell)
          else if (cell_type == cell_type_quad) then  
            ivol = cells(edge_node_mapping_quad(1,iedge),icell)
            jvol = cells(edge_node_mapping_quad(2,iedge),icell)
          else if (cell_type == cell_type_tetra) then  
            ivol = cells(edge_node_mapping_tetra(1,iedge),icell)
            jvol = cells(edge_node_mapping_tetra(2,iedge),icell)
          else if (cell_type == cell_type_hexa) then
            ivol = cells(edge_node_mapping_hexa(1,iedge),icell)
            jvol = cells(edge_node_mapping_hexa(2,iedge),icell)
          else if (cell_type == cell_type_prism) then
            ivol = cells(edge_node_mapping_prism(1,iedge),icell)
            jvol = cells(edge_node_mapping_prism(2,iedge),icell)
          end if

          ! get the jtemp1 value
          istart = iavs(ivol)+1
          iend = iavs(ivol+1)-1
          do jtemp1 = istart, iend       !c loop over connections
            if(jvol == javs(jtemp1)) then
              exit
            end if
          end do

          ! get the icell1 value
          do icell1 = 1, janumcell(jtemp1)
            if (jacell(icell1,jtemp1) == icell) then
              exit
            end if
          end do

          ! get the jtemp2 value, which is symmetrical to jtemp1
          istart = iavs(jvol)+1
          iend = iavs(jvol+1)-1
          do jtemp2 = istart, iend       !c loop over connections
            if(ivol == javs(jtemp2)) then
              exit
            end if
          end do

          ! get the icell2 value, this value can be same as icell1 after further optimization in javs
          do icell2 = 1, janumcell(jtemp2)
            if (jacell(icell2,jtemp2) == icell) then
              exit
            end if
          end do

          !c calculate control face velocity
          if (b_use_fixed_flow_vel) then
            velsloc = fixed_flow_vel
          else
            call usg_face_utility_vel_ddflow(ivol,jvol,icell1,jtemp1,velsloc)
          end if

!cdsu get rotation angle for anisotropic tortuosity and dispersivity correction
          if (useAnisoTauCorr .or. useAnisoDispCorr) then
            izn = mpropvs(ivol)
            jzn = mpropvs(jvol)
            
            aca_av = (aca_vol(ivol) + aca_vol(jvol))*rhalf
            call geometry_cal_rotation_matrix(aca_av,rml,rmr)

            if (useAnisoTauCorr) then
              if (type_averaging_De .eq. 'harmonic') then
                atc_av = math_common_harmonic(atc_zone(izn),atc_zone(jzn))
              else
                atc_av = (atc_zone(izn) + atc_zone(jzn))*rhalf
              end if
            end if

          end if          

!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------
!cprovi Not harmonic average in porosity 
!cprovi-------------------------------------------------------------------
!cprovi-------------------------------------------------------------------
      
          if (.not.harmonic_porosity) then
         
            !c average of ivol-jvol, can be other interpolation methods
            porav = 0.5d0*(min(r1, pornew(ivol))+                      &
                           min(r1,pornew(jvol)))
            if (assigned_tau) then
              tauav = 0.5d0*(tau(ivol)*tau_fac(ivol)+                  &
                             tau(jvol)*tau_fac(jvol))
            end if
         
!c  calculate average dispersivities for the "pseudo
!c  dispersion element"
            if (is_cell_based_disp_rt) then
              disx_avg = disx(mpropvs_cell(icell))
              disy_avg = disy(mpropvs_cell(icell))
              disz_avg = disz(mpropvs_cell(icell))
            else
              disx_avg = (disx(mpropvs(ivol))+disx(mpropvs(jvol)))*0.5d0
              disy_avg = (disy(mpropvs(ivol))+disy(mpropvs(jvol)))*0.5d0
              disz_avg = (disz(mpropvs(ivol))+disz(mpropvs(jvol)))*0.5d0
            end if

!c  average porosity of the element
            satav = (min(r1,sanew(ivol))+min(r1,sanew(jvol)))*0.5d0
            so_av = (min(r1,sonew(ivol))+min(r1,sonew(jvol)))*0.5d0
    
    
!c  calculate the average marchie factor
            marchieav = (marchies(ivol)+marchies(jvol))*0.5d0

!c  calculate effective diffusion coefficient
!c_bubbles use averaged diffusion coefficient
            if (type_diff_coeff == 0) then
              diffav = diff_a
            else if (type_diff_coeff > 0) then
              diffav_tensor = diff_a_tensor
            end if
            if (.not.diff_coff) then
              if (type_averaging_De .ne. 'arithmetic De' ) then
                if (type_diff_coeff == 0) then
                  diff_eff = diffcoff(diffav,satav,porav,              &
                                    tortuosity_corr,assigned_tau,      &
                                    tauav,type_tortuosity,marchieav,   &
                                    so_av,tor_corr_a_mq,tor_corr_b_mq)
                else if (type_diff_coeff > 0) then
                  diff_eff_tensor = diffcoff(diffav_tensor,satav,porav,&
                                    tortuosity_corr,assigned_tau,      &
                                    tauav,type_tortuosity,marchieav,   &
                                    so_av,tor_corr_a_mq,tor_corr_b_mq)
                end if
              else
                por_i = min( r1, pornew(ivol) )
                por_j = min( r1, pornew(jvol) )
        
                if (type_diff_coeff == 0) then
                  diff_eff_i = diffcoff(diffav,satav,por_i,              &
                                       tortuosity_corr,assigned_tau,     &
                                       tauav,type_tortuosity,marchieav,  &
                                       so_av,tor_corr_a_mq,tor_corr_b_mq)
                  diff_eff_j = diffcoff(diffav,satav,por_j,              &
                                       tortuosity_corr,assigned_tau,     &
                                       tauav,type_tortuosity,marchieav,  &
                                       so_av,tor_corr_a_mq,tor_corr_b_mq)
                  diff_eff = (diff_eff_i + diff_eff_j)/2.0d0
                else if (type_diff_coeff > 0) then
                  diff_eff_i_tensor = diffcoff(diffav_tensor,satav,por_i,&
                                       tortuosity_corr,assigned_tau,     &
                                       tauav,type_tortuosity,marchieav,  &
                                       so_av,tor_corr_a_mq,tor_corr_b_mq)
                  diff_eff_j_tensor = diffcoff(diffav_tensor,satav,por_j,&
                                       tortuosity_corr,assigned_tau,     &
                                       tauav,type_tortuosity,marchieav,  &
                                       so_av,tor_corr_a_mq,tor_corr_b_mq)
                  diff_eff_tensor = (diff_eff_i_tensor +                 &
                                     diff_eff_j_tensor)/2.0d0
                end if
              end if

              if (b_water_freezing) then
                if (tkel(ivol) < pressure_melt_k(ivol,r0) .or.           &
                    tkel(jvol) < pressure_melt_k(jvol,r0)) then
                  if (type_diff_coeff == 0) then
                    diff_eff = diff_eff*frozen_diff_a
                  else if (type_diff_coeff > 0) then
                    diff_eff_tensor = diff_eff_tensor*frozen_diff_a
                  end if
                end if
              end if              
! prc -------------------------------------------------------------------
! prc Modified for Multicomponent diffusion
! prc diff_eff = r0 the diffusion coefficient will be taken out from
! prc dispersion coefficient.
! prc -------------------------------------------------------------------

              if (multi_diff) then
                if (type_diff_coeff == 0) then
                  diff_eff = r0
                else if (type_diff_coeff > 0) then
                  diff_eff_tensor = tensor_zero
                end if
              end if

!cdsu correction for anisotropic material properties
              if (useAnisoTauCorr) then
                if (type_diff_coeff == 0) then
                  diff_eff_tensor = tensor_zero
                  diff_eff_tensor%xx = diff_eff
                  diff_eff_tensor%yy = diff_eff
                  diff_eff_tensor%zz = diff_eff
                end if

                diff_eff_tensor%xx = diff_eff_tensor%xx*atc_av%x
                diff_eff_tensor%yy = diff_eff_tensor%yy*atc_av%y
                diff_eff_tensor%zz = diff_eff_tensor%zz*atc_av%z

                diff_eff_tensor = (rml.dot.diff_eff_tensor).dot.rmr
              end if

!c  calculate the influence coefficient for the specified icell1, icell2, jtemp1, jtemp2
              do idvol = 1, num_edge_dvols

                call get_cell_edge_cvol_id(idvol,ivol,jvol,icell,      &
                                           idvol_r,iedge_r,rswitch)
                cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell)
     
                if(jacell(icell1,jtemp1) > 0 .and. cvolfacearea > rsmallarea) then
!c  calculate dispersivity
!c  calculate the dispersion tensor for the "pseudo dispersion element"
                  vel = velsloc(idvol)
                  vmag = sqrt(vel%x**2 + vel%y**2 + vel%z**2)
                  vxyz2 = math_common_set_vector(vel%x**2/(vmag + eps),   &
                             vel%y**2/(vmag + eps),vel%z**2/(vmag + eps))

                  if (useAnisoDispCorr .or. useAnisoTauCorr) then
                    !c to be further checked if it is right here
                    tenf = tensor_zero

                    !c get dispersivity tensor
                    if (useAnisoDispCorr) then
                      !c get principle dispersivity
                      tenf%xx = disx_avg
                      tenf%yy = disy_avg
                      tenf%zz = disz_avg

                      tenf = (rml.dot.tenf).dot.rmr

                      disx_avg = tenf%xx
                      disy_avg = tenf%yy
                      disz_avg = tenf%zz
                      disxy_avg = tenf%xy
                      disxz_avg = tenf%xz
                      disyz_avg = tenf%yz
                    else
                      disxy_avg = disx_avg-disy_avg
                      disxz_avg = disx_avg-disz_avg
                      disyz_avg = disx_avg-disz_avg
                    end if

                    !c calculate dispersion terms
                    tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+      &
                               disz_avg*vxyz2%z
                    tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+      &
                                 disz_avg*vxyz2%z
                    tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+      &
                                 disx_avg*vxyz2%z
                    tenf%xy = disxy_avg*vel%x*vel%y/(vmag+eps)
                    tenf%yx = tenf%xy
                    tenf%xz = disxz_avg*vel%x*vel%z/(vmag+eps)
                    tenf%zx = tenf%xz
                    tenf%yz = disyz_avg*vel%y*vel%z/(vmag+eps)
                    tenf%zy = tenf%yz

                    CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = &
                                 tenf + diff_eff_tensor
                  else
                  !c save dispersion tensor
                    if (type_disp_coeff == 1) then
                      tend = math_common_set_vector(disx_avg*vxyz2%x+     &
                                disy_avg*vxyz2%y+disz_avg*vxyz2%z,     &
                                                 disy_avg*vxyz2%x+     &
                                disx_avg*vxyz2%y+disz_avg*vxyz2%z,     &
                                                 disz_avg*vxyz2%x+     &
                                disz_avg*vxyz2%y+disx_avg*vxyz2%z)

                      if (type_diff_coeff == 0) then
                        tend = tend + math_common_set_vector(diff_eff,    &
                                                 diff_eff,diff_eff)
                        CellCvolFace_disp_da(idvol_r,iedge_r,icell) = tend
                      else if (type_diff_coeff == 1) then
                        tend = tend + math_common_set_vector(             &
                                               diff_eff_tensor%xx,     &
                                               diff_eff_tensor%yy,     &
                                               diff_eff_tensor%zz)
                        CellCvolFace_disp_da(idvol_r,iedge_r,icell) = tend
                      else if (type_diff_coeff == 2) then
                        tenf = diff_eff_tensor
                        tenf%xx = tenf%xx + tend%x
                        tenf%yy = tenf%yy + tend%y
                        tenf%zz = tenf%zz + tend%z
                        CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = tenf
                      end if

                    else if (type_disp_coeff == 2) then
                      tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+     &
                                   disz_avg*vxyz2%z
                      tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+     &
                                   disz_avg*vxyz2%z
                      tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+     &
                                   disx_avg*vxyz2%z
                      tenf%xy = (disx_avg-disy_avg)*vel%x*vel%y/(vmag+eps)
                      tenf%yx = tenf%xy
                      tenf%xz = (disx_avg-disz_avg)*vel%x*vel%z/(vmag+eps)
                      tenf%zx = tenf%xz
                      tenf%yz = (disx_avg-disz_avg)*vel%y*vel%z/(vmag+eps)
                      tenf%zy = tenf%yz

                      if (type_diff_coeff == 0) then
                        tenf%xx = tenf%xx + diff_eff
                        tenf%yy = tenf%yy + diff_eff
                        tenf%zz = tenf%zz + diff_eff
                      else if (type_diff_coeff > 0) then
                        tenf = tenf + diff_eff_tensor
                      end if
                      CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = tenf
                    end if
                  end if                  

                end if
    
              end do
    
            else

!c  calculate the influence coefficient for the specified icell1, icell2, jtemp1, jtemp2
              do idvol = 1, num_edge_dvols

                call get_cell_edge_cvol_id(idvol,ivol,jvol,icell,      &
                                           idvol_r,iedge_r,rswitch)
                cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell)
    
                do ic = 1,nc
    
                  if(jacell(icell1,jtemp1) > 0 .and. cvolfacearea > rsmallarea) then
!c  calculate dispersivity
                    vel = velsloc(idvol)
                    vmag = sqrt(vel%x**2 + vel%y**2 + vel%z**2)
                    vxyz2 = math_common_set_vector(vel%x**2/(vmag + eps), &
                            vel%y**2/(vmag + eps),vel%z**2/(vmag + eps)) 

                    if (type_diff_ic_coeff == 0) then
                      diff_eff = diffcoff(diff_ic(ic),satav,porav,     &
                                   tortuosity_corr,assigned_tau,       &
                                   tauav,type_tortuosity,marchieav,    &
                                   so_av,tor_corr_a_mq,tor_corr_b_mq) 
                    else if (type_diff_ic_coeff > 0) then
                      diff_eff_tensor = diffcoff(                      &
                              diff_ic_tensor(ic),satav,porav,          &
                              tortuosity_corr,assigned_tau,            &
                              tauav,type_tortuosity,marchieav,         &
                              so_av,tor_corr_a_mq,tor_corr_b_mq)
                    end if  
                    
!cdsu correction for anisotropic material properties
                    if (useAnisoTauCorr) then
                      if (type_diff_ic_coeff == 0) then
                        diff_eff_tensor = tensor_zero
                        diff_eff_tensor%xx = diff_eff
                        diff_eff_tensor%yy = diff_eff
                        diff_eff_tensor%zz = diff_eff
                      end if

                      diff_eff_tensor%xx = diff_eff_tensor%xx*atc_av%x
                      diff_eff_tensor%yy = diff_eff_tensor%yy*atc_av%y
                      diff_eff_tensor%zz = diff_eff_tensor%zz*atc_av%z
      
                      diff_eff_tensor = (rml.dot.diff_eff_tensor).dot.rmr
                    end if                    
                    
                    if (useAnisoDispCorr .or. useAnisoTauCorr) then
                      !c to be further checked if it is right here
                      tenf = tensor_zero

                      !c get dispersivity tensor
                      if (useAnisoDispCorr) then
                        !c get principle dispersivity
                        tenf%xx = disx_avg
                        tenf%yy = disy_avg
                        tenf%zz = disz_avg
  
                        tenf = (rml.dot.tenf).dot.rmr
  
                        disx_avg = tenf%xx
                        disy_avg = tenf%yy
                        disz_avg = tenf%zz
                        disxy_avg = tenf%xy
                        disxz_avg = tenf%xz
                        disyz_avg = tenf%yz
                      else
                        disxy_avg = disx_avg-disy_avg
                        disxz_avg = disx_avg-disz_avg
                        disyz_avg = disx_avg-disz_avg
                      end if

                      !c calculate dispersion terms
                      tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+      &
                                 disz_avg*vxyz2%z
                      tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+      &
                                   disz_avg*vxyz2%z
                      tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+      &
                                   disx_avg*vxyz2%z
                      tenf%xy = disxy_avg*vel%x*vel%y/(vmag+eps)
                      tenf%yx = tenf%xy
                      tenf%xz = disxz_avg*vel%x*vel%z/(vmag+eps)
                      tenf%zx = tenf%xz
                      tenf%yz = disyz_avg*vel%y*vel%z/(vmag+eps)
                      tenf%zy = tenf%yz

                      CellCvolFace_disp_da_ic_tensor(ic,idvol_r,iedge_r,icell) = &
                                   tenf + diff_eff_tensor
                    else
                      !c save dispersion tensor
                      if (type_disp_coeff == 1) then
                        tend = math_common_set_vector(disx_avg*vxyz2%x+   &
                                  disy_avg*vxyz2%y+disz_avg*vxyz2%z,   &
                                                   disy_avg*vxyz2%x+   &
                                  disx_avg*vxyz2%y+disz_avg*vxyz2%z,   &
                                                   disz_avg*vxyz2%x+   &
                                  disz_avg*vxyz2%y+disx_avg*vxyz2%z)

                        if (type_diff_ic_coeff == 0) then                                  
                          tend = tend + math_common_set_vector(diff_eff,  &
                                                   diff_eff,diff_eff)
                          CellCvolFace_disp_da_ic(ic,idvol_r,iedge_r,icell) = tend
                        else if (type_diff_ic_coeff == 1) then
                          tend = tend + math_common_set_vector(           &
                                                 diff_eff_tensor%xx,   &
                                                 diff_eff_tensor%yy,   &
                                                 diff_eff_tensor%zz) 
                          CellCvolFace_disp_da_ic(ic,idvol_r,iedge_r,icell) = tend
                        else if (type_diff_ic_coeff == 2) then
                          tenf = diff_eff_tensor
                          tenf%xx = tenf%xx + tend%x
                          tenf%yy = tenf%yy + tend%y
                          tenf%zz = tenf%zz + tend%z
                          CellCvolFace_disp_da_ic_tensor(ic,idvol_r,iedge_r,icell) = tenf
                        end if
                      else if (type_disp_coeff == 2) then 
                        tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+   &
                                     disz_avg*vxyz2%z
                        tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+   &
                                     disz_avg*vxyz2%z
                        tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+   &
                                     disx_avg*vxyz2%z
                        tenf%xy = (disx_avg-disy_avg)*vel%x*vel%y/(vmag+eps)
                        tenf%yx = tenf%xy
                        tenf%xz = (disx_avg-disz_avg)*vel%x*vel%z/(vmag+eps)
                        tenf%zx = tenf%xz
                        tenf%yz = (disx_avg-disz_avg)*vel%y*vel%z/(vmag+eps)
                        tenf%zy = tenf%yz
  
                        if (type_diff_ic_coeff == 0) then
                          tenf%xx = tenf%xx + diff_eff
                          tenf%yy = tenf%yy + diff_eff
                          tenf%zz = tenf%zz + diff_eff
                        else if (type_diff_ic_coeff > 0) then
                          tenf = tenf + diff_eff_tensor
                        end if
                        CellCvolFace_disp_da_ic_tensor(ic,idvol_r,iedge_r,icell) = tenf
                      end if
                    end if

                  end if
     
                end do
     
              end do
     
            end if
             
          else ! Harmonic averaging of effective diffusion
!c  calculate average dispersivities for the "pseudo
!c  dispersion element"
            if (type_diff_coeff == 0) then
              diffav = r0
            else if (type_diff_coeff > 0) then
              diffav_tensor = tensor_zero
            end if
            if (is_cell_based_disp_rt) then
              disx_avg = disx(mpropvs_cell(icell))
              disy_avg = disy(mpropvs_cell(icell))
              disz_avg = disz(mpropvs_cell(icell))
            else
              disx_avg = (disx(mpropvs(ivol))+disx(mpropvs(jvol)))*0.5d0
              disy_avg = (disy(mpropvs(ivol))+disy(mpropvs(jvol)))*0.5d0
              disz_avg = (disz(mpropvs(ivol))+disz(mpropvs(jvol)))*0.5d0
            end if     
     
            !c property of ivol
            por_i = pornew(ivol)
            if (assigned_tau) then
              tau_i = tau(ivol)*tau_fac(ivol)
            end if

            satav = min(r1, sanew(ivol))
            so_av = min(r1, sonew(ivol))
            marchieav = marchies(ivol)
      
            if (type_diff_coeff == 0) then
              diffav = diff_a
              diff_i = diffcoff(diffav,satav,por_i,tortuosity_corr,    &
                                assigned_tau,tau_i,type_tortuosity,    &
                                marchieav,so_av,                       &
                                tor_corr_a_mq,tor_corr_b_mq)
            else if (type_diff_coeff > 0) then
              diffav_tensor = diff_a_tensor
              diff_i_tensor = diffcoff(diffav_tensor,satav,            &
                                por_i,tortuosity_corr,                 &
                                assigned_tau,tau_i,type_tortuosity,    &
                                marchieav,so_av,                       &
                                tor_corr_a_mq,tor_corr_b_mq)
            end if

            if (b_water_freezing) then
              if (tkel(ivol) < pressure_melt_k(ivol,r0)) then
                if (type_diff_coeff == 0) then
                  diff_i = diff_i*frozen_diff_a
                else if (type_diff_coeff > 0) then
                  diff_i_tensor = diff_i_tensor*frozen_diff_a
                end if
              end if
            end if                                
      
            !c property of jvol
            por_j = pornew(jvol)
            if (assigned_tau) then
             tau_j = tau(jvol)*tau_fac(jvol)    !
            end if
      
            satav = min(r1, sanew(jvol))
            so_av = min(r1, sonew(jvol))
            marchieav = marchies(jvol)
      
            if (type_diff_coeff == 0) then
              diffav = diff_a
              diff_j = diffcoff(diffav,satav,por_j,tortuosity_corr,    &
                                assigned_tau,tau_j,type_tortuosity,    &
                                marchieav,so_av,                       &
                                tor_corr_a_mq,tor_corr_b_mq)
            else if (type_diff_coeff > 0) then
              diffav_tensor = diff_a_tensor
              diff_j_tensor = diffcoff(diffav_tensor,satav,            &
                                por_j,tortuosity_corr,                 &
                                assigned_tau,tau_j,type_tortuosity,    &
                                marchieav,so_av,                       &
                                tor_corr_a_mq,tor_corr_b_mq)
            end if

            if (b_water_freezing) then
              if (tkel(jvol) < pressure_melt_k(jvol,r0)) then
                if (type_diff_coeff == 0) then
                  diff_j = diff_j*frozen_diff_a
                else if (type_diff_coeff > 0) then
                  diff_j_tensor = diff_j_tensor*frozen_diff_a
                end if
              end if
            end if  
      
            !c weighted harmonic average, midpoint, weight = 1.0
            !c check coordinate system to avoid dividing by zero
            if (type_diff_coeff == 0) then
              diffxyz_avg = math_common_harmonic(diff_i, diff_j)
            else if (type_diff_coeff > 0) then
              diffxyz_avg_tensor = math_common_harmonic(diff_i_tensor, diff_j_tensor)
            end if

!cdsu correction for anisotropic material properties
            if (useAnisoTauCorr) then
              if (type_diff_coeff == 0) then
                diffxyz_avg_tensor = tensor_zero
                diffxyz_avg_tensor%xx = diffxyz_avg
                diffxyz_avg_tensor%yy = diffxyz_avg
                diffxyz_avg_tensor%zz = diffxyz_avg
              end if

              diffxyz_avg_tensor%xx = diffxyz_avg_tensor%xx*atc_av%x
              diffxyz_avg_tensor%yy = diffxyz_avg_tensor%yy*atc_av%y
              diffxyz_avg_tensor%zz = diffxyz_avg_tensor%zz*atc_av%z

              diffxyz_avg_tensor = (rml.dot.diffxyz_avg_tensor).dot.rmr
            end if            
      
            do idvol = 1, num_edge_dvols

              call get_cell_edge_cvol_id(idvol,ivol,jvol,icell,        &
                                         idvol_r,iedge_r,rswitch)
              cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell)
      
              !c influence coefficient of direct gradient term
              if(jacell(icell1,jtemp1) > 0 .and.                       &
                 cvolfacearea > rsmallarea) then

!c  calculate the dispersion tensor for the "pseudo dispersion element"
!c  average porosity of the element
                vel = velsloc(idvol)
                vmag = sqrt(vel%x**2 + vel%y**2 + vel%z**2)
                vxyz2 = math_common_set_vector(vel%x**2/(vmag + eps),     &
                          vel%y**2/(vmag + eps),vel%z**2/(vmag + eps))

                if (useAnisoDispCorr .or. useAnisoTauCorr) then
                  !c to be further checked if it is right here
                  tenf = tensor_zero

                  !c get dispersivity tensor
                  if (useAnisoDispCorr) then
                    !c get principle dispersivity
                    tenf%xx = disx_avg
                    tenf%yy = disy_avg
                    tenf%zz = disz_avg

                    tenf = (rml.dot.tenf).dot.rmr

                    disx_avg = tenf%xx
                    disy_avg = tenf%yy
                    disz_avg = tenf%zz
                    disxy_avg = tenf%xy
                    disxz_avg = tenf%xz
                    disyz_avg = tenf%yz
                  else
                    disxy_avg = disx_avg-disy_avg
                    disxz_avg = disx_avg-disz_avg
                    disyz_avg = disx_avg-disz_avg
                  end if

                  !c calculate dispersion terms
                  tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+      &
                             disz_avg*vxyz2%z
                  tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+      &
                               disz_avg*vxyz2%z
                  tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+      &
                               disx_avg*vxyz2%z
                  tenf%xy = disxy_avg*vel%x*vel%y/(vmag+eps)
                  tenf%yx = tenf%xy
                  tenf%xz = disxz_avg*vel%x*vel%z/(vmag+eps)
                  tenf%zx = tenf%xz
                  tenf%yz = disyz_avg*vel%y*vel%z/(vmag+eps)
                  tenf%zy = tenf%yz

                  CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = &
                               tenf + diffxyz_avg_tensor
                else
!c save dispersion tensor
                  if (type_disp_coeff == 1) then 
                    tend = math_common_set_vector(disx_avg*vxyz2%x+       &
                              disy_avg*vxyz2%y+disz_avg*vxyz2%z,       &
                                               disy_avg*vxyz2%x+       &
                              disx_avg*vxyz2%y+disz_avg*vxyz2%z,       &
                                               disz_avg*vxyz2%x+       &
                              disz_avg*vxyz2%y+disx_avg*vxyz2%z)
       
                    if (type_diff_coeff == 0) then
                      tend = tend + math_common_set_vector(diffxyz_avg,   &
                                            diffxyz_avg,diffxyz_avg)
                      CellCvolFace_disp_da(idvol_r,iedge_r,icell) = tend
                    else if (type_diff_coeff == 1) then 
                      tend = tend + math_common_set_vector(               &
                                             diffxyz_avg_tensor%xx,    &
                                             diffxyz_avg_tensor%yy,    &
                                             diffxyz_avg_tensor%zz)
                      CellCvolFace_disp_da(idvol_r,iedge_r,icell) = tend
                    else if (type_diff_coeff == 2) then
                      tenf = diffxyz_avg_tensor
                      tenf%xx = tenf%xx + tend%x
                      tenf%yy = tenf%yy + tend%y
                      tenf%zz = tenf%zz + tend%z
                      CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = tenf
                    end if
                  
                  else if (type_disp_coeff == 2) then
                    tenf%xx = disx_avg*vxyz2%x+disy_avg*vxyz2%y+       &
                                 disz_avg*vxyz2%z
                    tenf%yy = disy_avg*vxyz2%x+disx_avg*vxyz2%y+       &
                                 disz_avg*vxyz2%z
                    tenf%zz = disz_avg*vxyz2%x+disz_avg*vxyz2%y+       &
                                 disx_avg*vxyz2%z
                    tenf%xy = (disx_avg-disy_avg)*vel%x*vel%y/(vmag+eps)
                    tenf%yx = tenf%xy
                    tenf%xz = (disx_avg-disz_avg)*vel%x*vel%z/(vmag+eps)
                    tenf%zx = tenf%xz
                    tenf%yz = (disx_avg-disz_avg)*vel%y*vel%z/(vmag+eps)
                    tenf%zy = tenf%yz

                    if (type_diff_coeff == 0) then
                      tenf%xx = tenf%xx + diffxyz_avg
                      tenf%yy = tenf%yy + diffxyz_avg
                      tenf%zz = tenf%zz + diffxyz_avg
                    else if (type_diff_coeff > 0) then
                      tenf = tenf + diffxyz_avg_tensor
                    end if
                    CellCvolFace_disp_da_tensor(idvol_r,iedge_r,icell) = tenf
                  end if
                end if

              end if
      
            end do
          end if                      ! Harmonic averaging of effective diffusion
        end do
      end do                        !c loop over cells
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif       

#ifdef DEBUG
      info_debug = 0
      if (info_debug.gt.0) then

        do ivol = 1,nngl
          do jtemp1 = iavs(ivol),iavs(ivol+1)-1
            jvol = javs(jtemp1)
            do icell1 = 1, janumcell(jtemp1)
              write(idbg,'(4(a,1x,i6,1x),a,1x,1pe15.6e3)')               &
                    '-->check cinfrt_va ivol',ivol,'jvol',jvol,          &
                    "local cell", icell1, 'cinfrt_va(',jtemp1,') = ',    &
                    cinfrt_va_usg(jtemp1)
            end do
          end do
        end do

        if (info_debug.gt.1) then
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if

      end if    ! (info_debug.gt.0)
#endif

      return
      end
#endif
