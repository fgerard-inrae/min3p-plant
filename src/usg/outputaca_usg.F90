!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/outputaca_usg.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputaca_usg
!c -------------------
!c
!c write contour data for anisotropic correction angles to output 
!c file for unstructured mesh
!c
!c written by:      Danyang Su - Jan 25, 2021
!c
!c last modified:   
!c
!c                  Danyang Su - Jan 25, 2021
!c                  HPC capabilities
!c
!c --------------------------------------------------------------------------
#ifdef USG
      subroutine outputaca_usg
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
      use phys
      use writeversion
      use file_unit, only : lun_get, lun_free
#ifdef PETSC
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      use geometry
      use usg_mesh_data

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
#endif
      
      integer :: i, icell, inode, ixmf, ierr, iaca
      
      type(point) :: grad

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rm1 = -1.0d0,       &
                           r180 = 180.0d0, pi=3.14159265359d0

      character*256 :: strbuffer
      character*256 :: strfilename, strfilename_result, strfilename_mesh

      external :: checkerr

      !c file for result and mesh
      !c note: binary output using separated file for each subdomain is
      !c deprecated for unstructured grid version
      if (b_output_binary) then
        strfilename = prefix(:l_prfx)//'_o.aca'
        if (b_output_separate_mesh_result) then
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
        else
          strfilename_result = trim(strfilename)//'.h5'
          strfilename_mesh = strfilename_result
        end if
      else
        strfilename = prefix(:l_prfx)//'_o'//trim(adjustl(str_rank))//'.aca'
      end if

      !c separate mesh data from results data
#ifdef PETSC_HDF
      if (b_output_separate_mesh_result .and. initial_condition .and.  &
          b_output_binary) then
        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_mesh, H5F_ACC_TRUNC_F, file_id,   &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        !c write mesh data
        call hdf5_usg_write_mesh_data(file_id)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=prefix(:l_prfx)//'_domain.xmf',               &
               status='unknown', form='formatted')

          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_rank","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_rank","Scalar","Cell",             &
                    num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","vertices_matid","Scalar","Node",       &
                      num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,   &
                      "domain","cells_matid","Scalar","Cell",          &
                      num_cells_gbl,1)
          end if
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
      end if
#endif

!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then

#ifdef PETSC_HDF
        !c open corresponding xmf file to be loaded by paraview
        if (rank == 0) then
          ixmf = lun_get()
          open(ixmf,file=trim(strfilename)//'.xmf',status='unknown',   &
               form='formatted')
        end if

        !c initialize fortran interface
        call h5open_f(hdf5_ierr)

        !c setup file access property list with parallel I/O access
        call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
        call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                MPI_INFO_NULL, hdf5_ierr)
        !c create the file collectively
        call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                         hdf5_ierr, access_prp = plist_id)

        !c write attribute
        call hdf5_usg_write_attribute(file_id)

        if (.not. b_output_separate_mesh_result) then
          !c write mesh data
          call hdf5_usg_write_mesh_data(file_id)
        end if

        !c open corresponding xmf file for mesh and domain decomposition
        if (rank == 0) then
          call hdf5_usg_write_xmf_initialize(ixmf)
          call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                    cell_type,num_cells_gbl,num_nodes_gbl,             &
                    num_nodes_per_cell)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","vertices_rank",         &
                    "Scalar","Node",num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,                      &
                    strfilename_mesh,"domain","cells_rank",            &
                    "Scalar","Cell",num_cells_gbl,1)

          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","vertices_lg2g","Scalar","Node",          &
                    num_nodes_gbl,1)
          call hdf5_usg_write_xmf_attribute(ixmf,strfilename_mesh,     &
                    "domain","cells_lg2g","Scalar","Cell",             &
                    num_cells_gbl,1)

          if (b_use_node_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","vertices_matid",      &
                      "Scalar","Node",num_nodes_gbl,1)
          end if
          if (b_use_cell_matids) then
            call hdf5_usg_write_xmf_attribute(ixmf,                    &
                      strfilename_mesh,"domain","cells_matid",         &
                      "Scalar","Cell",num_cells_gbl,1)
          end if
        end if

        !c create a group for the mesh data set
        strbuffer = "results"
        !c create and open a group
        call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                         OBJECT_NAMELEN_DEFAULT_F)
#endif
      else
        iaca = lun_get()
        open(iaca,file=trim(strfilename)//'.vtk',status='unknown',     &
             form='formatted')
      end if
      
      if (rank == 0) then
        write(ifls,'(/a/72a)')'Anisotropic correction angles ',        &
                              ('-',i=1,72)                                                                        
                                                         
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_o.aca.vtk'
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        alpha(yaw)                      ','°'           
        write(ifls,'(2a)')                                             &
              '5        beta(pitch)                     ','°'           
        write(ifls,'(2a)')                                             &
              '6        gamma(roll)                     ','°'           
      end if

!c  title and mesh variables
      if (.not. b_output_binary) then
        call write_mesh_data_vtk_ascii(iaca,                         &
                                       "Anisotropic correction angles")
        write(iaca,'(a,1x,i12)') "POINT_DATA",num_nodes
      end if

      !c write storage coefficient
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c allocate buffer
        if (b_output_binary) then
          allocate(realbuffer(num_nodes*3), stat = ierr)
          call checkerr(ierr,'outputaca_usg-realbuffer',ilog)
          call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        end if
        do inode = 1, num_nodes
          realbuffer((inode-1)*3+1) = aca_vol(inode)%x*(r180/pi)
          realbuffer((inode-1)*3+2) = aca_vol(inode)%y*(r180/pi)
          realbuffer((inode-1)*3+3) = aca_vol(inode)%z*(r180/pi)
        end do        
        call hdf5_usg_write_group_data_vec(group_id,"aca",3,     &
                  num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                  realbuffer)
        if (rank == 0) then
          call hdf5_usg_write_xmf_attribute(ixmf,                &
                    strfilename_result,"results","aca","Vector", &
                    "Node",num_nodes_gbl,3)
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
#endif
      else
        write(iaca,'(a)') "VECTORS aca double"
        do inode = 1, num_nodes
          write(iaca,'(3(1pe15.6e3,1x))') aca_vol(inode)%x*(r180/pi),  &
                aca_vol(inode)%y*(r180/pi), aca_vol(inode)%z*(r180/pi)
        end do
      end if

!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if (b_output_binary) then
#ifdef PETSC_HDF
        !c close group
        call h5gclose_f(group_id,hdf5_ierr)

        !c close file
        call h5pclose_f(plist_id, hdf5_ierr)
        call h5fclose_f(file_id, hdf5_ierr)

        !c close FORTRAN interface
        call h5close_f(hdf5_ierr)

        !c close xmf file
        if (rank == 0) then
          call hdf5_usg_write_xmf_finalize(ixmf)
          close(ixmf)
          call lun_free(ixmf)
        end if
#endif
      else
        close(iaca)
        call lun_free(iaca)
      end if

      return
      end
#endif
