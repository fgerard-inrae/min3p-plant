!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 434 $
!> $Author: dsu $
!> $Date: 2016-08-04 15:09:50 -0700 (Thu, 04 Aug 2016) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/usg/metis_iface.F90 $
!---------------------------------------------------------------------
!********************************************************************!


! --------------------------------------------------------------------
!> Module of metis code for graph partitioning and fill-reducing matrix ordering
!>
!> Module description:
!>
!> Written by:    Danyang Su - July 27, 2016
!> Last modified:
!> Note: This code is modified from METIS forum http://glaros.dtc.umn.edu/gkhome/node/877
! --------------------------------------------------------------------

#ifdef METIS
module metis_iface

  use,intrinsic::ISO_C_BINDING

  implicit none

  integer::ia,ic
  integer(C_INT)::metis_ne,metis_nn
  integer(C_INT)::ncommon,objval
  integer(C_INT)::nparts
  integer(C_INT),allocatable,dimension(:)::eptr,eind,perm,iperm
  integer(C_INT),allocatable,dimension(:)::epart,npart
  type(C_PTR)::vwgt,vsize,twgts
  integer(C_INT)::opts(0:40)

  interface
    integer(C_INT) function METIS_SetDefaultOptions(opts) bind(C,name="METIS_SetDefaultOptions")
      use,intrinsic::ISO_C_BINDING
      implicit none
      integer(C_INT)::opts(0:40)
    end function METIS_SetDefaultOptions
  end interface

  interface
    integer(C_INT) function METIS_NodeND(nvtxs,xadj,adjncy,vwgt,opts,perm,iperm) bind(C,name="METIS_NodeND")
      use,intrinsic::ISO_C_BINDING
      implicit none
      integer(C_INT)::nvtxs
      integer(C_INT),dimension(*)::xadj,adjncy,perm,iperm
      type(C_PTR),value::vwgt
      integer(C_INT)::opts(0:40)
    end function METIS_NodeND
  end interface

  contains

  !>
  !> metis fill-reducing ordering
  !>
  subroutine metis_fill_reducing_ordering(nn,nnja,ia,ja,lorder,invord)

    use gen, only : idbg

    implicit none

    integer :: nn            ! number of equations
    integer :: nnja          ! number of non-zero entries in the matrix
    integer :: ia(*)         ! nn + 1, row start pointers for a()
    integer :: ja(*)         ! nja, global connection list for a()
    integer :: lorder(*)     ! nn, array containing rcm ordering
    integer :: invord(*)     ! nn, backward ordering of unknowns

    integer, allocatable :: xadj(:), adjncy(:)
    integer :: irow, istart, iend, icol, n, iflag

    allocate(xadj(nn+1))
    xadj = 0

    n = nnja-nn
    allocate(adjncy(n))
    adjncy = 0

    do irow=1,nn+1
      xadj(irow) = ia(irow)-(irow-1)
    end do

    n = 0
    do irow=1,nn
      istart = ia(irow)
      iend = ia(irow+1)-1
      do icol = istart, iend
        if(ja(icol) /= irow) then
          n = n + 1
          adjncy(n) = ja(icol)
        end if
      end do
    end do

    iflag = METIS_SetDefaultOptions(opts)
    opts(17) = 1             ! METIS_OPTION_NUMBERING = 17 needs to be set to make sure it uses fortran numbering
    iflag = METIS_NodeND(nn,xadj,adjncy,vwgt,opts,lorder,invord)

    deallocate(xadj)
    deallocate(adjncy)

    !!c ************test part for same graph on Metis5.1.0 manual P24***************
    !integer :: iflag, n
    !integer, allocatable :: xadj(:),adjncy(:),perm(:),iperm(:)
    !
    !n = 15
    !allocate(xadj(n+1))
    !xadj(:)=(/1,3,6,9,12,14,17,21,25,29,32,34,37,40,43,45/)
    !allocate(adjncy(44))
    !adjncy(:)=(/2,6,1,3,7,2,4,8,3,5,9,4,10,1,7,11,2,6,8,12,3,7,9,13,4, &
    !&           8,10,14,5,9,15,6,12,7,11,13,8,12,14,9,13,15,10,14/)
    !
    !allocate(perm(n))
    !perm = 0
    !allocate(iperm(n))
    !iperm = 0
    !
    !iflag = METIS_SetDefaultOptions(opts)
    !opts(17) = 1             ! METIS_OPTION_NUMBERING = 17 needs to be set to make sure it uses fortran numbering
    !iflag = METIS_NodeND(n,xadj,adjncy,vwgt,opts,perm,iperm)
    !
    !write(*,'(a,100i4)') "perm  ",perm(:)
    !write(*,'(a,100i4)') "iperm ",iperm(:)
    !!c ********************************end of test**********************************

  end subroutine metis_fill_reducing_ordering

end module metis_iface
#endif

