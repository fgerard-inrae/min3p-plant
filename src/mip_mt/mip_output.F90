!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/mip_mt/mip_output.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> module: mip_output
!>
!> written by: Danyang Su
!>
!> module description:
!>   module of mip (macroscopic invasion percolation) output
!>   Invasion percolation in a gradient includes fragmentation and mobilization of multiple 
!>   clusters, multi-component mass transfer under equilibrium conditions.!>
!> Note:  
!>   
!> 

module mip_output

    use gen
    use chem
    use writeversion
    use mip_bubble
    
    use file_unit, only : lun_get, lun_free
    
#ifdef PETSC
    use petsc_mpi_common, only : petsc_mpi_finalize
#endif

    implicit none
    
contains

    !>
    !> output MIP_MT spatial parameters
    !> 
    subroutine mip_output_params 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, ic, ig, ivol, ivol_l, imip, l_sufx, nvars
      
      real*8 :: zout
      
      character*3 :: suffix      
      
      real*8, external :: zoutput
      
      if (.not. b_enable_output) then
        return
      end if
      
      imip = lun_get()
!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 


      if (b_output_binary) then
        !c add binary output  
      else
        open(imip,file=prefix(:l_prfx)//'_'//                          &
                  trim(adjustl(str_rank))//'o.mip',                    &
                  status='unknown',form='formatted')
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(/2a/72a)')'Spatial parameters for ',              &
              'macroscopic invasion percolation', ('-',i=1,72)
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                  trim(adjustl(str_rank))//'o.mip'
      end if
      
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c  title and variables
      nvars = 10

          
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(imip, "#")
      end if
        
!c  title and variables
      if (b_output_binary) then
          
      else
        write(imip,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        
        write(imip,'(100a)') 'variables = "x", "y", "z",',             &
                     ' "pore radius (m)",',                            &
                     ' "water pressure (m)",',                         &
                     ' "entry pressure (m)",',                         &
                     ' "breakthrough pressure (m)",',                  &
                     ' "terminal pressure (m)",',                      &
                     ' "entry threshold (m)",',                        &
                     ' "terminal threshold (m)"' 
        write(imip,'(a,1x,3(i5,a))')                                   &
                     'zone t = "MIP initial parameters", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        pore radius                     ','m'          
        write(ifls,'(2a)')                                             &
              '5        water pressure                  ','m'           
        write(ifls,'(2a)')                                             &
              '6        entry pressure                  ','m'           
        write(ifls,'(2a)')                                             &
              '7        breakthrough pressure           ','m'           
        write(ifls,'(2a)')                                             &
              '8        terminal pressure               ','m'
        write(ifls,'(2a)')                                             &
              '9        entry threshold                 ','m'           
        write(ifls,'(2a)')                                             &
              '10       terminal threshold              ','m'           
      end if
        
      
      do ivol = 1, nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
          cycle  
        end if
#endif
        ivol_l = ivol_l + 1
        
!c  assign depth coordinate in terms of depth or elevation
        zout = zoutput(depth_output,zg(ivol),elevmax)
        
        if (b_output_binary) then
            
        else
          write(imip,ascii_fmt)  xg(ivol),yg(ivol),zout,               &
                                 mip_rp(ivol),mip_pw(ivol),            &
                                 mip_pd(ivol),mip_pe(ivol),            &
                                 mip_pt(ivol),mip_te(ivol),            &
                                 mip_tt(ivol)
        end if
          
      end do
      
!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
      if(b_output_binary .and. b_output_mpiio_single) then 
          
      else
        close(imip)
        call lun_free(imip)
      end if
    
    end subroutine mip_output_params

    !>
    !> output MIP_MT results
    !> 
    subroutine mip_output_spatial 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, igsmip, l_sufx, ic, ig, ivol, ivol_l, nvars, ivar
      
      real*8 :: zout
      real*8, external :: zoutput
      
      character*3 :: suffix      
      
      if (.not. b_enable_output) then
        return
      end if
      
      igsmip = lun_get()
!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 

      !rewind(icnv)           !Deprecated, use internal convert instead. DSU
      if (igstime.lt.10) then
        write(suffix,'(i1)') igstime
        l_sufx = 1
      elseif (igstime.ge.10.and.igstime.lt.100) then
        write(suffix,'(i2)') igstime
        l_sufx = 2
      elseif (igstime.ge.100.and.igstime.lt.1000) then
        write(suffix,'(i3)') igstime
        l_sufx = 3
      elseif (igstime.ge.1000) then
        if (rank == 0) then  
          write(ilog,'(/a)')'error in input file'
          write(ilog,'(a)')'max. number of output times exceeded'
          write(ilog,'(a)')'abnormal exit in routine mip_output_spatial'
          close(ilog)
#ifdef DEBUG
          write(idbg,'(/a)') 'error in input file'
          write(idbg,'(a)') 'max. number of output times exceeded'
          write(idbg,'(a)') 'abnormal exit in routine mip_output_spatial'
          close(idbg)
#endif
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

      if (b_output_binary) then
        !c add binary output  
      else
        open(igsmip,file=prefix(:l_prfx)//'_'//                        &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsmip',  &
                  status='unknown',form='formatted')
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(/2a/72a)')'Spatial output for ',                  &
              'macroscopic invasion percolation', ('-',i=1,72)
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsmip'
      end if
      
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c  title and variables
      nvars = 3*mip_ngas + 5

          
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsmip, "#")
      end if
        
!c  title and variables
      if (b_output_binary) then
          
      else
        write(igsmip,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        
        write(igsmip,'(100a)') 'variables = "x", "y", "z",',           &
                     ' "pore radius (m)",',                            &
                     ' "connected gas cluster",',                      &
                     ' "air saturatio (-)"',                           &
                     ' "entry threshold (m)"',                         &
                     ' "terminal threshold (m)"',                      &
                     (',"',nameg(ig)(:l_nameg(ig)),'"',ig=1,ng),       &
                     (',"',nameg(ig)(:l_nameg(ig)),'_aq"',ig=1,ng),    &
                     (',"tot ',nameg(ig)(:l_nameg(ig)),'_aq"',ig=1,ng)
        
        write(igsmip,'(a,1pe10.3,1x,a,3(a,i5),a)')                     &
                     'zone t = "G_i, T = ',                            &
                     time_io,time_unit(:l_time_unit),'", i =',         &
                     itec,', j =',jtec,', k =',ktec,',  f=point'
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        pore radius                     ','m'          
        write(ifls,'(2a)')                                             &
              '5        connected gas cluster           ','-'          
        write(ifls,'(2a)')                                             &
              '6        air saturatio                   ','-' 
        write(ifls,'(2a)')                                             &
              '7        entry threshold                 ','-'          
        write(ifls,'(2a)')                                             &
              '8        terminal threshold              ','-'       
        
        do ig = 1, ng
           ivar = ig+8 
           if(ivar < 10) then
             write(ifls,'(i1, 8x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig)),'Pa' 
           else if (ivar >= 10 .and. ivar < 100) then
             write(ifls,'(i2, 7x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig)),'Pa' 
           else if (ivar >= 100) then
             write(ifls,'(i3, 6x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig)),'Pa' 
           end if
        end do
        
        do ig = 1, ng
           ivar = ig+8+ng 
           if(ivar < 10) then
             write(ifls,'(i1, 8x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           else if (ivar >= 10 .and. ivar < 100) then
             write(ifls,'(i2, 7x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           else if (ivar >= 100) then
             write(ifls,'(i3, 6x, a32,a)') ivar,                       &
                   nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           end if
        end do
        
        do ig = 1, ng
           ivar = ig+7+2*ng 
           if(ivar < 10) then
             write(ifls,'(i1, 8x, a32,a)') ivar,                       &
                   "tot "//nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           else if (ivar >= 10 .and. ivar < 100) then
             write(ifls,'(i2, 7x, a32,a)') ivar,                       &
                   "tot "//nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           else if (ivar >= 100) then
             write(ifls,'(i3, 6x, a32,a)') ivar,                       &
                   "tot "//nameg(ig)(:l_nameg(ig))//"_aq",'mol/L H2O' 
           end if
        end do
        
      end if
        
      
      do ivol = 1, nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
          cycle  
        end if
#endif
        ivol_l = ivol_l + 1
        
!c  assign depth coordinate in terms of depth or elevation
        zout = zoutput(depth_output,zg(ivol),elevmax)
        
        if (b_output_binary) then
            
        else
          write(igsmip,ascii_fmt) xg(ivol),yg(ivol),zout,              &
                mip_rp(ivol), real(mip_g(ivol)),mip_sg(ivol),          &
                mip_te(ivol), mip_tt(ivol), (mip_pg(ig,ivol),ig=1,ng), &
                (mip_cw(ig,ivol),ig=1,ng), (mip_ct(ig,ivol),ig=1,ng)
                                     
        end if
          
      end do
      
!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
      if(b_output_binary .and. b_output_mpiio_single) then 
          
      else
        close(igsmip)
        call lun_free(igsmip)
      end if
    
    end subroutine mip_output_spatial
    
    !>
    !> output MIP_MT results
    !> 
    subroutine mip_output_transient(ivol,igbmip,ntstp,time_io)
 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      !c passed variable
      integer :: ivol, igbmip, ntstp
      real*8 :: time_io
      
      !c local variable
      integer :: ig, nvars
      
!c  title and variables
      nvars = 3*mip_ngas + 2
          
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igbmip, "#")
      end if        
      
      !c write header
      if (ntstp == 1) then
!c  title and variables
        if (b_output_binary) then
            
        else
          write(igbmip,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          
          write(igbmip,'(100a)') 'variables = "time",',                &
                       '"connected gas cluster","air saturatio (-)",', &
                       ' "entry threshold (m)",',                      &
                       ' "terminal threshold (m)"',                    &
                       (',"',nameg(ig)(:l_nameg(ig)),'"',ig=1,ng),     &
                       (',"',nameg(ig)(:l_nameg(ig)),'_aq"',ig=1,ng),  &
                       (',"tot ',nameg(ig)(:l_nameg(ig)),'_aq"',ig=1,ng)
          
          write(igbmip,'(a,i8,1x,a,3(a,i5),a)')                        &
                       'zone t = "G_i, Volume = ', ivol, '", f=point'
        end if
      end if
      
      !c write data
      if (b_output_binary) then
          
      else
        write(igbmip,ascii_fmt) time_io,real(mip_g(ivol)),             &
              mip_sg(ivol),mip_te(ivol),mip_tt(ivol),                  &
              (mip_pg(ig,ivol),ig=1,ng), (mip_cw(ig,ivol),ig=1,ng),    &
              (mip_ct(ig,ivol),ig=1,ng)
      end if   
    
    end subroutine mip_output_transient

end module mip_output
