!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/parallel_io/dumpstring.F90 $
!---------------------------------------------------------------------
!********************************************************************!


!> subroutine: dumpstring
!>
!> written by: Danyang Su
!>
!> subroutine description:
!>
!> Convert string to binary output
!>
!> Note: 
    
    !>
    !> Convert ascii string to binary and write to file iunit
    !>
    subroutine dumpstring(iunit, offset, lenstr_plus, instring, b_mpi)
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
        use petscsys
#endif
#endif
        implicit none

#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

        !passing variables
        integer*4 :: iunit, lenstr_plus
#ifdef PETSC
        integer(kind=MPI_OFFSET_KIND) :: offset
#else
        integer*8 :: offset
#endif
        character(*) :: instring
        logical :: b_mpi
        
       
        !local variables
        integer*4 :: idecs(lenstr_plus)
        integer :: i
        
#ifdef PETSC    
        integer :: wstatus(MPI_STATUS_SIZE)
#endif
        integer :: ierrcode

       
        do i=1,lenstr_plus-1
         idecs(i)=ICHAR(instring(i:i))
        end do
        idecs(lenstr_plus) = 0
        
#ifdef PETSC
        if(b_mpi) then
          call MPI_File_write_at(iunit, offset, idecs, lenstr_plus,    &
               MPI_INTEGER4, wstatus, ierrcode) 
          CHKERRQ(ierrcode)
        end if
#endif
        
        if (.not. b_mpi) then
          do i = 1, lenstr_plus
            write(iunit) idecs(i)
          end do
        end if

        return

    end subroutine dumpstring
