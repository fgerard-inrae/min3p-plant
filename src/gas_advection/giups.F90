!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/gas_advection/giups.F90 $
!---------------------------------------------------------------------
!********************************************************************!
!c ----------------------------------------------------------------------
!c subroutine giups
!c ---------------------
!c
!c choose the upstream node for weighting parameters in gas transport
!c
!c written by: Sergi Molins, May 2, 2006 
!c
!c last modified: Sergi Molins, May 29, 2007
!c                gravity option
!c
!c modified by: Danyang Su - March 26, 2014
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c phys.f:   real*8:
!c           -------
!c           mdens_g(nn)        = molar density                       + - 
!c           
!c gen.f:    real*8:
!c           -------
!c           iupsg(njavs)       = upstream node                       * + 
!c           gmfrac(ng,nn)      = number of gas species               + -
!c           nn                 = number of control volumes           + -
!c
!c external: -  
!c ----------------------------------------------------------------------
      subroutine giups

      use gen
      use phys
    
      implicit none
      
      integer :: i1, icon, ivol, istart, iend, jvol
      real*8 :: hi, hj  

      real*8 gpi   ,gpj
      real*8 zgi   ,zgj
      real*8 dens_i,dens_j,dens
      

      real*8, external :: gasp_m, gasd_m

      dens = 0.0d0

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_global)                         &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (i1, icon, ivol, istart, iend, jvol,                &
    !$omp dens, dens_i, dens_j, gpi, gpj, hi, hj, zgi, zgj)    
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl
    
        istart = iavs(ivol)+1     !pointer - start of row
        iend = iavs(ivol+1)-1     !pointer - end of row
        icon = 0                  !counter (connections)

        do i1=istart,iend         !loop over connections

          jvol = javs(i1)         !column pointer
          icon = icon+1           !counter (connections)

          gpi = gasp_m(mdens_g(ivol),ivol)
          gpj = gasp_m(mdens_g(jvol),jvol)
          
          dens_i = gasd_m(mdens_g(ivol),gmfrac(:,ivol))
          dens_j = gasd_m(mdens_g(jvol),gmfrac(:,jvol))
          
          zgi = zg(ivol)
          zgj = zg(jvol)

!         20060303
          if (iupsg(i1).eq.'i') then
            dens = dens_i
          else if (iupsg(i1).eq.'j') then
            dens = dens_j
          else if (iupsg(i1).eq.'a') then
            dens = ( dens_i + dens_j ) * 0.5d0
          endif

          if (gas_gravity) then
            hi = gpi + dens * gacc * zgi
            hj = gpj + dens * gacc * zgj
          else
            hi = gpi
            hj = gpj
          endif

          if (hj.gt.hi) then
            iupsg(i1) = 'j'
          else
            iupsg(i1) = 'i'  
          end if

        enddo

      enddo
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  

      return
      
      end

