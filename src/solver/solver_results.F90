!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/solver/solver_results.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> module: solver_results
!>
!> written by: Danyang Su
!>
!> module description:
!>
!> Module of comparing the results by different solvers
!> See http://www.mcs.anl.gov/petsc/ for detail

module solver_results

    use file_unit, only : lun_get, lun_free

    implicit none
    
    public solver_results_check_output
    
    contains
    
    !>
    !> Compare the results with different solver
    !>
    subroutine solver_results_check_output(ifilenum, n, xref, xnew, strsuffix)
    
        use gen, only : str_rank 

        implicit none

        integer, intent(in) :: ifilenum
        integer, intent(in) :: n
        real*8, intent(in)  :: xref(n)
        real*8, intent(in)  :: xnew(n)
        character(len=*), intent(in) :: strsuffix
        
        integer :: i, j, iunit
        character(12) :: strnum
        real*8 :: errbws
        character(256) :: strpathsurfix
        
        
        write(strnum, *) ifilenum  
        
        strpathsurfix = "error_"//trim(adjustl(strsuffix))//"_"//trim(adjustl(strnum))//trim(str_rank)//".txt"
        
        !iunit = 92
        iunit = lun_get() 

        open(unit = iunit, file = trim(strpathsurfix))

        write(iunit, *) "---solver result:  x_ref      x_new          diff: " // strnum
        do i = 1, n
            write(iunit,"(3(1pe15.6e3,1x))") xref(i), xnew(i),abs(xnew(i)-xref(i))
        end do
        close(iunit)
        
        call lun_free(iunit)

    end subroutine solver_results_check_output
    
    !>
    !> Read solver resutls from external data file, for test only
    !>
    subroutine solver_results_readin(ifilenum, strsuffix, numdat, xnew)
    
        use gen, only : str_rank 

        implicit none

        integer, intent(in) :: ifilenum     
        integer, intent(in) :: numdat
        character(len=*), intent(in) :: strsuffix 
        real*8, intent(inout)  :: xnew(numdat)
        
        
        integer :: i, n, iunit
        character(12) :: strnum
        character(256) :: strpathsurfix
        
        write(strnum, *) ifilenum  
        strpathsurfix = trim(adjustl(strsuffix))//"_"//trim(adjustl(strnum))//trim(str_rank)//".txt"
        
        !iunit = 92 
        iunit = lun_get()

        open(unit = iunit, file = trim(strpathsurfix))
        read(iunit, *) n
        
        if(n == numdat) then
            do i = 1, n
                read(iunit, *) xnew(i)
            end do
        else
            write(*,*) "Solver result data amount from external file does not match"
        end if
        
        close(iunit)
        
        call lun_free(iunit)

    end subroutine solver_results_readin    

end module solver_results
