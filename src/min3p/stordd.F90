!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/stordd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function stordd
!c ------------------------
!c
!c
!c compute mass storage term for density dependent flow in
!c variably saturated conditions with fluid pressure as the
!c primary dependent variable
!c
!c assign fluid densities as a function of total component 
!c concentrations and empirical linear coefficient drho_dc
!c
!c Note: the value passed to delt2 depends on the Picard iteration
!c number.  For the initial picard iteration (iter_sia .eq. 1), the
!c previous time step length is passed as delt2.  For subsequent
!c iterations, the current time step length is passed.
!c
!c written by:      Tom Henderson - August 19, 2002
!c
!c last modified:   Tom Henderson - September 8, 2003
!c
!c last modified:   
!c                  Danyang Su - Add specific storage term and apply chain 
!c                               rule to porosity and temperature derivative.
!c                               The previous formula is buggy.
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           ------- 
!c           deltnew            = current time step                   + -
!c           delttds            = previous time step                  + -
!c           dens_ivol          = water density                       + - 
!c           pressnew           = fluid pressure (new time level)     + -
!c           pressold           = fluid pressure (old time level)     + -
!c           satwnew            = water saturation (new time level)   + -
!c           satwold            = water saturation (old time level)   + -
!c           stordd             = mass storage term                   * +
!c           tdsnew             = TDS (new time level)                + -  
!c           tdsold             = TDS (old time level)                + -
!c
!c           integer*4:
!c           ----------
!c           izn                = pointer (material property zone)    + -
!c
!c common: 
!c phys.f:   nzn                = number of zones                     + -
!c           por                = porosity                            + -
!c           spstor(nzn)        = specific storage coefficient        + -
!c                                wrt fluid pressure
!c
!c dens.f:   drho_dc            = density-TDS constant drho/dTDS      + -
!c           
!c
!c local:    real*8:
!c           -------
!c           densstor           = mass storage from temporal 
!c                                density variations
!c           elast              = elastic mass storage from pressure
!c                                variations
!c
!c external: -
!c ----------------------------------------------------------------------
 
      real*8 function stordd(delt1,delt2,pornew,porold,                &
                             satwnew,satwold,densnew,densold,          &
                             densnewc,densoldc,tdsnew,tdsold,          &
                             tempnew,tempold,drhodc,drhodT,            &
                             pwnew,pwold,spstor,                       &
                             ispitzerdens,new_stor_deri,               &
                             coupled_porpress,coupled_drhodt)
                                                                       
      implicit none                                                    
                                                                       
      real*8, intent(in) :: delt1,delt2,pornew,porold,                 &
                            satwnew,satwold,densnew,densold,           &
                            densnewc,densoldc,tdsnew,tdsold,           &
                            tempnew,tempold,drhodT,                    &
                            drhodc,pwnew,pwold,spstor
      logical, intent(in) :: ispitzerdens,new_stor_deri,               &
                             coupled_porpress,coupled_drhodt
     
      real*8             :: term1,term2,term3,term4

!cdsu change over specific storage

!c  spstor(izn) converted to units of pressure in subroutine  
!c  initppdd using the following equation:  
!c  spstor(izn) = spstor(izn)/(gacc * ref_dens)

!cdsu old code
      !term1 = satwnew * densnew * (pornew-porold) / delt1  
!cdsu new code
!cdsu chain rule: d(porosity)/d(t) = d(porosity)/d(pressure)*d(pressure)/d(t)
!cdsu decoupled scenario when porosity is modified but pressure is not modified accordingly,
!cdsu chain rule in derivative cannot be used 
      if (new_stor_deri .and. coupled_porpress) then
        term1 = satwnew*densnew*spstor*(pwnew-pwold)/delt1
      else
        term1 = satwnew*densnew*(pornew-porold)/delt1
      end if

!cdsu change over saturation
      term2 = pornew * densnew * (satwnew-satwold) / delt1 

!cdsu change over concentration (TDS)
!cdsu old code
      !term3 = satwnew * pornew * (densnew - densold)/delt2
!cdsu new code
      if (new_stor_deri) then
        if (ispitzerdens) then 
          term3 = pornew*satwnew*(densnewc-densoldc)/delt2
        else
          term3 = pornew*satwnew*drhodc*(tdsnew-tdsold)/delt2
        end if
      else
        term3 = pornew*satwnew*(densnew-densold)/delt2
      end if

      !cdsu to be further checked
      !cdsu coupled density-temperature in storage term calculation (stordd) 
      !cdsu causes convergence problem, disable this term (coupled_drhodt = .false.) 
      !cdsu at this moment
      if (new_stor_deri .and. coupled_drhodt) then
        term4 = pornew*satwnew*drhodT*(tempnew-tempold)/delt1
      else
        term4 = 0.0d0
      end if

      stordd = term1 + term2 + term3 + term4

      return
      end
