!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 598 $
!> $Author: mxie $
!> $Date: 2018-07-24 09:15:37 -0700 (Tue, 24 Jul 2018) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/acoff.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function acoff
!c ---------------------
!c compute activity coefficient 
!c
!c written by:      Uli Mayer - October 10, 95
!c
!c last modified:   Uli Mayer - April 18, 96
!c                  implemented b-dot equation
!c                  Uli Mayer - February 4, 98
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of components        + -
!c                                as species in solution
!c           cx(nx)             = concentrations of secondary aqueous + -
!c                                species
!c           acth2omin          = min. activity of h2o                + -
!c           adav               = coefficient for davies equation     + -
!c           bdav               = coefficient for davies equation     + -
!c           dhad               = debye-huckel constant a_d           + -
!c                                depending on dielectric constant 
!c                                and temperature
!c           dhbd               = debye-huckel constant b_d           + -
!c                                depending on dielectric constant 
!c                                and temperature
!c           dha                = debye-huckel a                      + -
!c           dhb                = debye-huckel b                      + -
!c           charge             = charge of aqueous species           + -
!c           strion             = ionic strength                      + -
!c           acoff              = activity coefficient                * +
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components                + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           character:
!c           ----------
!c           name               = name of current dissolved species   + -
!c           namec(nc)          = component names                     + -
!c 
!c local:    real*8:
!c           ------- 
!c           c1                 = constant
!c           rstrion            = square root of ionic strength
!c           rtenth             = constant
!c           r0                 = constant
!c           r1                 = constant
!c           r10                = constant
!c           sumc               = sum of all aqueous species 
!c                                concentrations
!c           tiny               = constant
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueous species)
!c
!c common:   
!c chem.f:   real*8:
!c           -------
!c           asit               = coefficient for SIT model           + -
!c           basit              = coefficient for SIT model           + -
!c                                  based on Grethe et al. (2004)
!c                                  Appendix B, eqn B.1, B.2
!c           coepsil((nc+nx)*(nc+nx))
!c                              =  array for coefficient epsilon      + -
!c                                  of SIT model
!c
!c           integer:
!c           -------
!c           iasit(nc+nx+1)     = row pointer array for SIT model     + -
!c           jasit((nc+nx)*(nc+nx))
!c                              = colume pointer array for SIT model  + -
!c
!c           logical:
!c           --------
!c           issit              = .true.  -> SIT model                + -
!c external: -
!c ---------------------------------------------------------------------- 

      real*8 function acoff(c,cx,strion,charge,dha,dhb,                & 
                           dhad,dhbd,adav,bdav,acth2omin,nc,nx,        &
                           name,namec,icx,issit,asit,bsit,coepsil,     &
                           iasit,jasit)
  
      implicit none

      intrinsic dabs,dsqrt
 
      character*72 name,namec
      real*8 :: c, cx, strion, charge, dha, dhb, dhad,dhbd,adav,bdav,  &
                acth2omin,asit,bsit,coepsil,etemp 
      integer :: nc,nx, icx, istart, iend,jtemp,iasit,jasit
      dimension c(*),cx(*),namec(*),coepsil(*),iasit(*),jasit(*)
 
      !local variables
      real*8 :: tiny, rtenth, r0, r1, r10, c1, rstrion, sumc, dtemp
      integer :: ic, ix
      parameter (tiny = 1.0d-10, rtenth = 0.1d0, r0 = 0.0d0, &
                r1 = 1.0d0, r10 = 10.0d0, c1 = 0.017d0)
      logical :: issit

      acoff = r0 

!c  exclude h2o

      if (name.ne.'h2o') then
 
!c  compute activity coefficient for charged species

        if (dabs(charge).gt.tiny) then

!c  exclude electron

          if (name.eq.'e-1') then

            acoff = r1

          else 

!c  dissolved species
            rstrion  = sqrt(strion) 
            
            if (.not. issit) then
 
!c  debye-hueckel parameters in database --> use bdot-equation
 
              if (dabs(dha).gt.tiny) then
                acoff = r10 ** &
                    ((-dhad*charge**2*rstrion)/ &
                     (r1+dhbd*dha*rstrion)+dhb*strion)
              
!c  otherwis  e --> use davies equation
              
              elseif (dabs(dha).lt.tiny) then
                acoff = r10 ** &
                      (- adav*charge**2*(rstrion/(r1+rstrion) &
                       - bdav*strion))
              end if
            else
!c ----------SIT model ------------------------------  
!c  Reference: Grenthe I et al. (2004) Chemical 
!c      thermodynamics of uranium. NEA OECD, Paris 
!c      France, Appedix B
                
                etemp = 0.0d0
                istart = iasit(icx)
                iend = iasit(icx+1)-1
                
                do jtemp = istart, iend
                    if (jasit(jtemp) .le. nc-1) then
                       etemp = etemp + coepsil(jtemp)*c(jasit(jtemp)) 
                    else
                       etemp = etemp + coepsil(jtemp)*cx(jasit(jtemp)-nc) 
                    end if                 
                end do
               
                acoff = r10 **                                       &
                      (- asit*charge**2*(rstrion/(r1+bsit*rstrion))  &
                       + etemp)
                dtemp=- asit*charge**2*(rstrion/(r1+bsit*rstrion))
                
            end if

          end if
 
!c  activity coefficient for uncharged species 
 
        elseif (dabs(charge).lt.tiny) then
          if (.not. issit) then
              acoff = r10 ** (rtenth * strion)
          else
           
!c ----------SIT model (issit = .true.)------------------------- 
!c  Assumption 2: the ion interaction coefficients are 
!c    zero for ions of the sam echarge sign and for 
!c    uncharged species. Therefore, if charge = 0:

              acoff = r1
          end if

        end if 
 
!c  activity coefficient for h2o
      
      elseif (name.eq.'h2o') then
 
        sumc = r0
        do ic = 1,nc-1
          if (namec(ic).ne.'e-1') then
            sumc = sumc + c(ic)
          end if
        end do
        do ix = 1,nx
          sumc = sumc + cx(ix)
        end do
 
        acoff = r1 - c1 * sumc

!c  constrain to minimum specified activity  
 
        acoff = dmax1(acoff,acth2omin)

      end if

      return
    end