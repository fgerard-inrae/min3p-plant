!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readgses.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readgses
!c -------------------
!c
!c read database for gaseous species and assign to permanent storage
!c
!c written by:      Uli Mayer - September 12, 96
!c
!c last modified:   Uli Mayer - December 6, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           igdbs              = unit number, database gases         + -
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number, debugging file         + -
!c           ipsp               = unit number, list of possible       + -
!c                                             secondary aqueous 
!c                                             species, gases and 
!c                                             minerals
!c
!c common:
!c bbls.f    real*8
!c           ------
!c           gascon_a(ng)       = temperature dependent solubility coefficient
!c           gascon_b(ng)       = temperature dependent solubility coefficient
!c           gascon_c(ng)       = temperature dependent solubility coefficient
!c                              
!c           character          
!c           ---------          
!c           gas_type(ng)       = specifies temperature dependence of solubility
!c                                 'type_0' enthalphy (default)               
!c                                 'type_1' CRC handbook
!c                                 'type_2' bunsen solubility coefficients
!c
!c chem.f:   real*8:
!c           -------
!c           dhcg(ng)           = enthalpy change for gases           * +
!c           eqgs(ng)           = equilibrium constants for           * +
!c                                formation of gases from free
!c                                species at standard temperature
!c           gfwg(ng)           = gram formula weight for gases       * +
!c           xnug(ng*nc)        = stoichiometric coefficient matrix   * +
!c                                for formation of gases from
!c                                free species
!c            
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           jaga(ng*nc)        = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c
!c           logical:
!c           --------
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namet(30)          = species names (temporary)           * *
!c
!c local:    real*8:
!c           -------
!c           dhc                = enthalpy change (temporary)
!c           eqt                = log equilibrium constant 
!c                                (temporary)
!c           gfw                = gram formula weight (temporary)
!c           xnugt(iv)          = stoichiometric coefficient of 
!c                                component in gaseous species 
!c                                (temporary)
!c
!c           integer*4:
!c           ----------
!c           i                = counter
!c                              array)
!c           ic               = counter (components)
!c           icount           = counter (check number of species)
!c           icur             = counter (position in compresses
!c                                       array)
!c           iend             = pointer
!c           istart           = pointer
!c           iv               = counter
!c           l_name           = length of name
!c           nv               = number of components forming 
!c                              gas (temporary)
!c
!c           logical:
!c           --------
!c           found            = logical variable to stop search 
!c                              for species
!c           done             = logical variable to stop search 
!c                              for gas
!c
!c           character:
!c           ----------
!c           name             = name of component currently 
!c                              processed
!c           rgas_type        = specifies temperature dependence of solubility
!c                              - temporary
!c           rgascon_a        = solubility coefficient - temporary
!c           rgascon_b        = solubility coefficient - temporary
!c           rgascon_c        = solubility coefficient - temporary
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readgses(igdbs,ipsp,ilog,idbg,igen)
 
      use parm
      use chem
      use bbls
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk
      use file_utility, only : makelowercase, replacecharacter,        &
                               readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: igdbs,ipsp,ilog,idbg,igen
      
      integer :: i, iii, ic, ig, icount, icur, istart, iend, iv, nv,   &
                 l_name
      
      real*8 :: dhc, eqt, gfw, xnugt, rgascon_a, rgascon_b, rgascon_c

      character*1024 :: strbuffer
      character*72 :: name
      character*12 :: rgas_type
      character*1, parameter :: strspace = ' '
      dimension xnugt(100)
      logical done,found    
      real*8, parameter :: r0 = 0.0d0
!c_bubbles initialize temperature dependence variables

      if (gas_bubbles) then
        gascon_a = r0
        gascon_b = r0
        gascon_c = r0
        gas_type = 'type_0'
      end if
 
!c  search database for possible secondary aqueous species

      if (search_database) then

        if (rank == 0 .and. b_enable_output) then
          write(ipsp,'(/a)') 'gases'
          write(ipsp,'(a/)') '-----'
        end if

        do while (.true.)
          if (space_delimiter_dbs) then                  !merged space delimiters
            read(igdbs,'(a)',end=999,err=9999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace) 
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 999
            end if
            name = strbuffer(1:iend-1)
            
            strbuffer = trim(adjustl(strbuffer(iend:))) 
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=999,err=9999) dhc
            
            strbuffer = trim(adjustl(strbuffer(iend:))) 
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=999,err=9999) eqt
            
            strbuffer = trim(adjustl(strbuffer(iend:))) 
            iend = index(strbuffer,strspace)
            read(strbuffer,*,end=999,err=9999) gfw

            !cdsu this parameter is hardwired in bubble model.
            !cdsu put temperature dependent solubility coefficients
            !cdsu after gram formula weight so that when gas bubble
            !cdsu is deactivated, no modification in the database is required
            if (compatible_bubble_dbs .and. gas_bubbles .and.          &
                abs(dhc).gt.9.975e2 .and. abs(dhc).lt.9.995e2) then
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) rgascon_a

              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) rgascon_b
              
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) rgascon_c
            end if            
            
            !c next line
            read(igdbs,'(a)',end=999,err=9999) strbuffer
            !c make lower case and replace tab and quote with space
            call makelowercase(strbuffer)
            call replacecharacter(strbuffer, achar(9), strspace)
            call replacecharacter(strbuffer, "'", strspace)
            call replacecharacter(strbuffer, '"', strspace)
            strbuffer = trim(adjustl(strbuffer))
            iend = index(strbuffer,strspace)
            if (iend <= 1) then
              goto 999
            end if
            read(strbuffer,*,end=999,err=9999) nv
            
            do iv = 1, nv
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              namet(iv) = strbuffer(1:iend-1)
              
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=999,err=9999) xnugt(iv)
            end do
          else                                           !fixed format
            read(igdbs,100,end=999,err=9999) name,dhc,eqt,gfw,        &
                 nv,(namet(iv),xnugt(iv),iv=1,nv)
                  
            !cdsu this parameter is hardwired in bubble model.
            !cdsu put temperature dependent solubility coefficients
            !cdsu after gram formula weight so that when gas bubble
            !cdsu is deactivated, no modification in the database is required
            if (compatible_bubble_dbs .and. gas_bubbles .and.          &
                abs(dhc).gt.9.975e2 .and. abs(dhc).lt.9.995e2) then
              backspace(igdbs)
              backspace(igdbs)
              read(igdbs,200,err=9999) name, dhc, eqt, gfw,  &
                   rgascon_a, rgascon_b, rgascon_c,          &
                   nv,(namet(iv),xnugt(iv),iv=1,nv)
            end if                 
          end if
             
!c_bubbles - read temperature dependence variables for gases
!c_bubbles - if dhc = 999 then gas type is type 1, from CRC manual
!cdsu important note:
!cdsu add abs to dhc since this dhc may be reversed due to code change 

!cdsu old format to read temperature dependent solubility coefficients from a new line.
!cdsu If bubble flow is deactivated, this extra line should also be deleted, 
!cdsu otherwise, the code crashes due to reading error.
!cdsu For the modified format, the solubility coefficients are placed after 

          if ((.not.compatible_bubble_dbs) .and. gas_bubbles) then  
            if ((abs(dhc).gt.9.985e2).and.(abs(dhc).lt.9.995e2))then
              if (space_delimiter_dbs) then                  !merged space delimiters
                read (igdbs,*,end=999,err=9999) rgascon_a, rgascon_b, rgascon_c
              else
                read (igdbs,'(3f10.4)',end=999,err=9999) rgascon_a, rgascon_b, rgascon_c
              end if
            else if ((abs(dhc).gt.9.975e2).and.(abs(dhc).lt.9.985e2))then
              if (space_delimiter_dbs) then                  !merged space delimiters
                read (igdbs,*,end=999,err=9999) rgascon_a, rgascon_b, rgascon_c  
              else
                read (igdbs,'(3f10.4)',end=999,err=9999) rgascon_a, rgascon_b, rgascon_c
              end if
            end if
          end if

          if (name.eq.'end') goto 999

!c  check if all components with non-zero stoichiometric coefficients in 
!c  gas are specified in general input file

          icount = 0
          ic = 0
          do while ((icount.lt.nv).and.(ic.lt.nc))
            ic = ic+1
            iv = 0
            found = .false.
            do while ((iv.lt.nv).and.(.not.found))
              iv = iv+1
              if (namet(iv).eq.namec(ic)) then
                found = .true.
                icount = icount+1
              end if
            end do
          end do

!c  report all possible gases

          if (icount.eq.nv) then
             l_name = index(name,' ')-1
             if (l_name.gt.72.or.l_name.eq.-1) then
               l_name = 72
             end if
             if (rank == 0 .and. b_enable_output) then
               write(ipsp,'(3a)') "'",name(:l_name),"'"
             end if
          end if

        end do             !loop over gases in database

999     continue

!c  rewind database file

        rewind(igdbs)

      end if               !search_database

!c  read data for specified gases

      if (ng.gt.0) then

!c  initialize row pointer array for sparse matrix structure
 
        iaga(1) = 1
 
!c  loop over gaseous species specified for simulation
 
        do ig = 1,ng
 
!c  loop over gaseous species in database,
!c  search for match and assign data to permanent storage
!c  exit when done or when end of file is reached
 
          done = .false.
 
          do while (.not.done)
              
!c_bubbles set temporary temperature dependence variables to zero
            if (gas_bubbles) then
              rgascon_a = r0
              rgascon_b = r0
              rgascon_c = r0
              rgas_type = 'type_0'
            end if
 
!c  read name of complexed species and complex specific data 
 
            if (space_delimiter_dbs) then                  !merged space delimiters
              read(igdbs,'(a)',err=9999) strbuffer
              !c make lower case and replace tab and quote with space
              call makelowercase(strbuffer)
              call replacecharacter(strbuffer, achar(9), strspace) 
              call replacecharacter(strbuffer, "'", strspace)
              call replacecharacter(strbuffer, '"', strspace)
              strbuffer = trim(adjustl(strbuffer))
              iend = index(strbuffer,strspace)
              if (iend <= 1) then
                goto 9999
              end if
              name = strbuffer(1:iend-1)
            
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) dhc
              
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) eqt
              
              strbuffer = trim(adjustl(strbuffer(iend:))) 
              iend = index(strbuffer,strspace)
              read(strbuffer,*,end=9998,err=9999) gfw

              !cdsu this parameter is hardwired in bubble model.
              !cdsu put temperature dependent solubility coefficients
              !cdsu after gram formula weight so that when gas bubble
              !cdsu is deactivated, no modification in the database is required
              if (compatible_bubble_dbs .and. gas_bubbles .and.      &
                  abs(dhc).gt.9.975e2 .and. abs(dhc).lt.9.995e2) then
                strbuffer = trim(adjustl(strbuffer(iend:))) 
                iend = index(strbuffer,strspace)
                read(strbuffer,*,end=9998,err=9999) rgascon_a

                strbuffer = trim(adjustl(strbuffer(iend:))) 
                iend = index(strbuffer,strspace)
                read(strbuffer,*,end=9998,err=9999) rgascon_b
                
                strbuffer = trim(adjustl(strbuffer(iend:))) 
                iend = index(strbuffer,strspace)
                read(strbuffer,*,end=9998,err=9999) rgascon_c

                if ((abs(dhc).gt.9.985e2).and.(abs(dhc).lt.9.995e2)) then
                  rgas_type = 'type_1'
                else if ((abs(dhc).gt.9.975e2).and.(abs(dhc).lt.9.985e2)) then
                  rgas_type = 'type_2'
                end if
              end if
              
              !c next line
              read(igdbs,'(a)',end=9998,err=9999) strbuffer
              !c make lower case and replace tab and quote with space
              call makelowercase(strbuffer)
              call replacecharacter(strbuffer, achar(9), strspace)
              call replacecharacter(strbuffer, "'", strspace)
              call replacecharacter(strbuffer, '"', strspace)
              strbuffer = trim(adjustl(strbuffer))
              iend = index(strbuffer,strspace)
              if (iend <= 1) then
                goto 9998
              end if
              read(strbuffer,*,end=9998,err=9999) nv
              
              do iv = 1, nv
                strbuffer = trim(adjustl(strbuffer(iend:))) 
                iend = index(strbuffer,strspace)
                namet(iv) = strbuffer(1:iend-1)
                
                strbuffer = trim(adjustl(strbuffer(iend:))) 
                iend = index(strbuffer,strspace)
                read(strbuffer,*,end=9998,err=9999) xnugt(iv)
              end do
            else
              read(igdbs,100,err=9999) name,dhc,eqt,gfw,       &
                   nv,(namet(iv),xnugt(iv),iv=1,nv)
                   
              !cdsu this parameter is hardwired in bubble model.
              !cdsu put temperature dependent solubility coefficients
              !cdsu after gram formula weight so that when gas bubble
              !cdsu is deactivated, no modification in the database is required
              if (compatible_bubble_dbs .and. gas_bubbles .and.        &
                  abs(dhc).gt.9.975e2 .and. abs(dhc).lt.9.995e2) then
                backspace(igdbs)
                backspace(igdbs)
                read(igdbs,200,err=9999) name, dhc, eqt, gfw,  &
                     rgascon_a, rgascon_b, rgascon_c,          &
                     nv,(namet(iv),xnugt(iv),iv=1,nv)

                if ((abs(dhc).gt.9.985e2).and.(abs(dhc).lt.9.995e2)) then
                  rgas_type = 'type_1'
                else if ((abs(dhc).gt.9.975e2).and.(abs(dhc).lt.9.985e2)) then
                  rgas_type = 'type_2'
                end if
              end if

            end if
            
!c_bubbles - read temperature dependence variables for gases
!c_bubbles - if dhc = 999 then gas type is type 1, from CRC manual
!cdsu important note:
!cdsu add abs to dhc since this dhc may be reversed due to code change 

!cdsu old format to read temperature dependent solubility coefficients from a new line.
!cdsu If bubble flow is deactivated, this extra line should also be deleted, 
!cdsu otherwise, the code crashes due to reading error.
!cdsu For the modified format, the solubility coefficients are placed after 

            if ((.not.compatible_bubble_dbs) .and. gas_bubbles) then
              if ((abs(dhc).gt.9.985e2).and.(abs(dhc).lt.9.995e2))then
                rgas_type = 'type_1'
                if (space_delimiter_dbs) then                  !merged space delimiters
                  read (igdbs,*,err=9999) rgascon_a, rgascon_b, rgascon_c
                else
                  read (igdbs,'(3f10.4)',err=9999) rgascon_a, rgascon_b, rgascon_c
                end if
              !c_bubbles - if dhc = 998 then gas type is type 2, bunsen solubility coefficients
              else if ((abs(dhc).gt.9.975e2).and.(abs(dhc).lt.9.985e2))then
                rgas_type = 'type_2'
                if (space_delimiter_dbs) then                  !merged space delimiters
                  read (igdbs,*,err=9999) rgascon_a, rgascon_b, rgascon_c
                else
                  read (igdbs,'(3f10.4)',err=9999) rgascon_a, rgascon_b, rgascon_c
                end if
              end if 
            end if
 
!c  look for match, as long end of file is not reached or 
!c  match is found
 
!c  complexed species is found --> assign permanent storage
 
            if (name.eq.nameg(ig)) then
 
              done = .true.
 
!c  pointer array to row in stoichiometric reaction matrix for
!c  next complex
 
              iaga(ig+1) = iaga(ig)+nv
 
!c  check if all components for gas
!c  are specified in general input file
!c  set up pointer array to column in stoichiometric matrix
 
              icount = 0
              ic = 0
              do while ((icount.lt.nv).and.(ic.lt.nc))
                ic = ic+1
                iv = 0
                found = .false.
                do while ((iv.lt.nv).and.(.not.found))
                  iv = iv+1
                  if (namet(iv).eq.namec(ic)) then
                    found = .true.
                    icount = icount+1
                    icur = iaga(ig)+iv-1
                    jaga(icur) = ic
                  end if
                end do
              end do
 
!c  if component is missing, exit
 
              if (icount.ne.nv) then
                  
                if (rank == 0) then  
                  write(ilog,'(72a)') ('-',i=1,72)
                  write(ilog,'(a,a12,a)')'component for ',              &
     &                                    name,' is missing'
                  write(ilog,'(72a)') ('-',i=1,72)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
 
!c  all components available --> assign data to permanent storage
 
              elseif (icount.eq.nv) then
!                dhcg(ig) = dhc
!cdhr - corrected April 06
                if (dhc_reverse) then
                  dhcg(ig) = dhc
                else
                  dhcg(ig) = -dhc
                end if    

                eqgs(ig) = 10.0d0**(-eqt)
                gfwg(ig) = gfw
                
!c_bubbles assign temperature dependence variables
                if (gas_bubbles) then
                  gascon_a(ig) = rgascon_a
                  gascon_b(ig) = rgascon_b
                  gascon_c(ig) = rgascon_c
                  gas_type(ig) = rgas_type
                end if
 
!c  stoichiometric coefficients
 
                istart = iaga(ig)
                iend = iaga(ig+1)-1
                iv = 0
                do i = istart,iend
                  iv = iv+1
                  xnug(i) = xnugt(iv)
                end do
              end if
 
!c  end of file is reached --> exit 
 
            elseif (name.eq.'end') then
              if (rank == 0) then
                write(ilog,'(72a)') ('-',i=1,72)
                write(ilog,'(a,a,a)')'gaseous species ',trim(nameg(ig)),    & 
     &                                 ' not in database'
                write(ilog,'(72a)') ('-',i=1,72)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
 
            end if
          end do                 !end - loop over database for gases
 
!c  rewind database for aqueous complexes to search for next 
!c  complexed species, doing this allows the specification of 
!c  complexed species in an arbitray order
 
          rewind(igdbs)
 
        end do                   !end - loop over specified complexes

!cdsu write warning information for sign switch in the value of enthaply change
        if (ng > 0 .and. dhc_reverse) then
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(72a)') ('-',i=1,72)
            write(ilog,'(2a)') 'warning: enthalpy change for',         &
                               ' gas is reversed'
            write(ilog,'(72a)') ('-',i=1,72)

            write(igen,'(72a)') ('-',i=1,72)
            write(igen,'(2a)') 'warning: enthalpy change for',         &
                               ' gas is reversed'
            write(igen,'(72a)') ('-',i=1,72)
          end if
        end if

      end if                     !(ng.gt.0)

100  format(a12,2x,2f10.4,31x,f9.4/6x,i2,2x,20(a12,1x,f7.3,1x))
200  format(a12,2x,2f10.4,31x,f9.4,2x,3f10.4/6x,i2,2x,20(a12,1x,f7.3,1x))
! 100  format(a12,2x,2f10.4,31x,f9.4/6x,i1,3x,5(a12,1x,f7.3,1x))
 
!cdbg ---- activate this section for purposes of debugging -----
#ifdef DEBUG      
      iii = 0
      if (iii.eq.1) then 
      do ig=1,ng 
        write(idbg,'(a,i3,2x,a)') 'ig    = ',ig,trim(nameg(ig))
        write(idbg,'(a,f10.4)') 'dhcg(ig)     = ',dhcg(ig)
        write(idbg,'(a,f10.4)') 'eqgs(ig)     = ',dlog10(eqgs(ig))
        write(idbg,'(a,f10.4)') 'gfwg(ig)     = ',gfwg(ig)
        write(idbg,'(a,i10)') 'iaga    ',iaga(ig)
        if (gas_bubbles) then
          write(idbg,'(a,a)')'gas_type(ig)   =',gas_type(ig)
          write(idbg,'(a,f10.4)') 'gascon_a(ig) = ',gascon_a(ig)
          write(idbg,'(a,f10.4)') 'gascon_b(ig) = ',gascon_b(ig)
          write(idbg,'(a,f10.4)') 'gascon_c(ig) = ',gascon_c(ig)
        end if
 
!c  echo check for stoichiometric coefficients
 
        istart = iaga(ig)
        iend = iaga(ig+1)-1
        do i = istart, iend
          icur = jaga(i)
          write(idbg,'(i5,2x,a72,a,i5,a,f10.3)') i,namec(icur),' jaga ',&
     &                jaga(i),' xnug ',xnug(i)
        end do
        write(idbg,*)
        write(idbg,*) '----------------------------------------------'
        write(idbg,*)
      end do
      end if      
!c     stop
#endif

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: gases.dbs'
          write(idbs_bk, '(a)') '<------ gases.dbs: start of gaseous species ------>'      
          do ig = 1,ng
            rewind(igdbs)
            do while(.true.)
              if (readnextline(igdbs,strbuffer,lowercase=.false.,      &
                  original=.true.)) then
                if (index(adjustl(strbuffer),trim(nameg(ig))) == 1) then
                  write(idbs_bk,'(a)') trim(strbuffer)
                  if (readnextline(igdbs, strbuffer, lowercase=.false.,&
                      original=.true.)) then
                    write(idbs_bk,'(a)') trim(strbuffer)
                  end if
                  exit
                end if
              end if
            end do
          end do
          rewind(igdbs) 
          !write(idbs_bk, '(a)') 'end'
          write(idbs_bk, '(a/)') '<------ gases.dbs: end of gaseous species ------>'
          write(*,'(1x,a)') 'end of database backup: gases.dbs'
        end if
      end if

      return

9998  continue
      backspace(igdbs)
      read(igdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'end of reading in gas database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'end of reading in gas database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

9999  continue
      backspace(igdbs)
      read(igdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in gas database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in gas database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
  
