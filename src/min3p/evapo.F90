!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/evapo.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c real*8 function evapo
!c -----------------------
!c compute water evaporation for current control volume 
!c
!c written by:      Fred GÃ©rard - Oct. 05, 05
!c
!c last modified:   Celine Blitz Frayret (CBF) for Frederic Gerard, december 14, 2018 : 
!c            correction of commented parameters
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           satwnew(nn)        = aqueous phase saturation            + -
!c                                - new time level
!c
!c           integer*4:
!c           ----------
!c           ivol               = pointer to current volume
!c        
!c common:   
!c
!c gen.f     real*8
!c           ------
!c           cvol(nn)           = nodal volumes
!c           pe_soil            = potential soil evaporation
!c           delx(nvx)          = spatial increment in x-direction         
!c           dely(nvy)          = spatial increment in y-direction         
!c           delz(nvz)          = spatial increment in z-direction 
!c         toparea         = profil area exposed to atmosphere
!c
!c           integer*4
!c           ------
!c           nn                 = total number of control volumes 
!c           mpropvs(nn)        = pointer array to volume properties
!c
!c           logical:
!c           --------
!c           root_uptake        = .true. -> compute root water       * +
!c                                          and passive/rejective
!c                        solute uptakes
!c                                        
!c phys.f:   real*8:
!c           ------- 
!c           satwfield(nzn)     = water saturation at field capacity  + -
!c           satwdry(nzn)       = air-dry water saturation
!c           pvol(nzn)          = volume of property zone (used for evaporation)
!c           h1dry(nzn)         = air-dry aqueous pressure
!c
!c
!c biol.F90: real*8:
!c         -------
!c           pe_soil            = potential soil evaporation          * +
!c
!c         logical:
!c           --------
!c           pure_evap   = .true.  -> physical evaporation only
!c
!c local:    
!c         integer*4:
!c           ----------
!c           izn                = pointer (material property zone)    + -
!c
!c external: -
!c ----------------------------------------------------------------------
    real*8 function evapo(satwnew,ivol)
 
      use parm
      use phys
      use gen
      use dual
      use biol

      implicit none
      
      !c passed variables
      real*8 :: satwnew(*)
      integer :: ivol
      
      !c local variables
      integer :: izn
      real*8, parameter :: r0 = 0.0d0

!c
!c!FG april 2013: initialization as required regarding how evap is used 
!c                in the function (see third case below).
!c                Note that this fix also correct time step differences (and so on)
!c                compared to compaq
!c
      evapo = r0

!c     
!c  setup pointer to the material properties of the current volume
!c    
      izn = mpropvs(ivol)

!c
!c  check for zone where soil evaporation should operate and calculate the total flux (in s-1)
!c
      if (soilhydrfunc_field) then
        if (h1dry_vol(ivol).gt.r0) then
!DSU: this part should be used with cautious, as h1dry is initial condition, which means
!DSU: it does not change over time, may cause problem for transient flow.

          if (satwnew(ivol).gt.satwfield(izn)) then      ! h1dry > 0 and satwnew > satwfield

            evapo = pe_soil/pvol(izn)                    !FG August 2021 - toparea discarded as conversion in m3/s done before now. Here conversion into s-1

          elseif (satwnew(ivol).lt.satwdry_vol(ivol)) then    !  h1dry > 0 and satwnew < satwdry

            evapo=r0

          else                                           !  h1dry > 0 and satwdry <= satwnew <= satwfield

            evapo = ((satwnew(ivol)- satwdry_vol(ivol))/    &
                    (satwfield(izn)-satwdry_vol(ivol)))

            evapo = evapo*pe_soil/pvol(izn)   !FG August 2021 - toparea discarded as conversion in m3/s done before now. Here conversion into s-1

          endif

        endif ! if h1dry>0
      else
        if (h1dry(izn).gt.r0) then
!DSU: this part should be used with cautious, as h1dry is initial condition, which means
!DSU: it does not change over time, may cause problem for transient flow.


          if (satwnew(ivol).gt.satwfield(izn)) then      ! h1dry > 0 and satwnew > satwfield

            evapo = pe_soil/pvol(izn)                    !FG August 2021 - toparea discarded as conversion in m3/s done before now. Here conversion into s-1

          elseif (satwnew(ivol).lt.satwdry(izn)) then    !  h1dry > 0 and satwnew < satwdry

            evapo=r0

          else                                           !  h1dry > 0 and satwdry <= satwnew <= satwfield

            evapo = ((satwnew(ivol)- satwdry(izn))/    &
                    (satwfield(izn)-satwdry(izn)))

            evapo = evapo*pe_soil/pvol(izn)              !FG August 2021 - toparea discarded as conversion in m3/s done before now. Here conversion into s-1

          endif

        endif ! if h1dry>0
      end if

      return
      
    end
