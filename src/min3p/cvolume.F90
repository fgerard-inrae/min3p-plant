!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/cvolume.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine cvolume
!c ------------------
!c
!c compute volumes on a nodal basis for a block discretization
!c
!c written by:      Uli Mayer - June 10, 96 
!c
!c last modified:   Tom Henderson - April 7,2005
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           delx(nvx)          = spatial increment in x-direction    + -
!c           dely(nvy)          = spatial increment in y-direction    + -
!c           delz(nvz)          = spatial increment in z-direction    + -
!c           cvol(nn)           = nodal volumes                       * +
!c
!c           integer*4:
!c           ----------
!c           nvx                = number of control volumes in        + - 
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c local:    integer*4:
!c           ----------
!c           ivx                = counter (number of control volumes
!c                                in x-direction)
!c           ivy                = counter (number of control volumes
!c                                in y-direction)
!c           ivz                = counter (number of control volumes
!c                                in z-direction)
!c           ivol               = pointer (current control volume)
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine cvolume
 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use parm
      use gen
#ifdef OPENMP
      use omp_lib
#endif
#ifdef USG
      use geometry
      use usg_mesh_data, only : cell_type, nodes, cells, CellCenter,   &
                                cvol_method, num_cells,                &
                                num_nodes, CellFaceCenter,             &
                                get_face_edge_index,                   &
                                num_faces_per_cell, num_nodes_per_face,&
                                num_nodes_per_cell
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC
      real*8 :: cvol_tot_gbl
      PetscErrorCode :: ierrcode
#endif

      real*8, parameter  ::               &
          pi = 3.141592653589793d0,       &
          r0 = 0.0d0, r2=2.0d0,           &
          rhalf=0.5d0
      
#ifdef OPENMP      
      integer :: nvols
#endif
      integer :: info_dbg, ivol, ivx, ivy, ivz 

      real*8 :: rvol

#ifdef USG
      integer :: icell, iface, inode, inode2, jnode2, jvol, kvol,      &
                 ivol1, ivol2, ivol3, ivol4, ivol5, ivol6, ivol7, ivol8
      type(point) :: points(8)
#endif
     
      info_dbg = 0

!c  optional radial coordinates
!c  see infcvs.f
    
      if (discretization_type == 0) then

!c  loop over control volumes  
 
        ivol = 0

#ifdef OPENMP
    !$omp parallel                                                     &
    !$omp if (nngl > numofloops_thred_cvolume_1)                       &
    !$omp num_threads(numofthreads_global)                             &
    !$omp default(shared)                                              &
    !$omp private (ivol, ivx, ivy, ivz)
    !$omp do schedule(static)
#endif 
        do ivz = nvzgls,nvzgle                  ! number of control volumes in z
          do ivy = nvygls,nvygle                ! number of control volumes in y
            do ivx = nvxgls,nvxgle              ! number of control volumes in x

!c  pointer to current control volume
#ifdef OPENMP
              ivol = (ivz-nvzgls)*nvygl*nvxgl + (ivy-nvygls)*nvxgl +   &
                      ivx-nvxgls+1
#else
              ivol = ivol+1
#endif

!c  calculate volume
 
              cvol(ivol) = delx(ivx)*dely(ivy)*delz(ivz)

!c correct for radial coord
              if (radial_coord) then
                if (half_cells) then
                  if (ivx .eq. 1) then

!----------------------------------old------------------------------------------
!                  !cvol(ivol) = pi*delx(ivx)*delx(ivx)*delz(ivz)
!                   cvol(ivol) = pi*rhalf*delx(ivx)*delx(ivx)  &
!                                 *delz(ivz)
!                elseif (ivx .eq. nvx) then
!   !                 cvol(ivol) = r2*pi*
!   !  &                  (xg(ivol)-rhalf*delx(ivx))*delx(ivx)*delz(ivz)
!                     cvol(ivol) = r2*pi*xg(ivol)*delx(ivx)*delz(ivz)
!                else ! full cell in xx direction
!                 ! cvol(ivol) = r2*pi*xg(ivol)*delx(ivx)*delz(ivz)
!                   cvol(ivol) = r2*pi*xg(ivol)*rhalf*(delx(ivx-1)+delx(ivx))&
!                                 *delz(ivz)
!----------------------------------old-------------------------------------------                 

!----------------------------------M. Xie, 2012-12-07-----------------------------
                  cvol(ivol) = pi*delx(ivx)*delx(ivx)*delz(ivz)
                  ! cvol(ivol) = pi*rhalf*delx(ivx)*delx(ivx)
  !   &                          *delz(ivz)
                  elseif (ivx .eq. nvxgbl) then
                    cvol(ivol) = r2*pi*                                &
     &                  (xg(ivol)-rhalf*delx(ivx))*delx(ivx)*delz(ivz)
   !                  cvol(ivol) = r2*pi*xg(ivol)*delx(ivx)*delz(ivz)
                  else ! full cell in xx direction
                  cvol(ivol) = r2*pi*xg(ivol)*delx(ivx)*delz(ivz)
                 !  cvol(ivol) = r2*pi*xg(ivol)*rhalf*(delx(ivx-1)+delx(ivx))
  !   &                          *delz(ivz)                 
 !----------------------------------M. Xie, 2012-12-07-----------------------------
                  end if
                else ! full cells
                  cvol(ivol) = r2*pi*xg(ivol)*delx(ivx)*delz(ivz)
                end if
              end if
            continue

            end do                      ! number of increments in x
          end do                        ! number of increments in y
        end do                          ! number of increments in z
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

      else
#ifdef USG
        if (cell_type == cell_type_tri .or. cell_type == cell_type_quad) then
          do icell = 1, num_cells
            do inode = 1, num_nodes_per_cell
              ivol = cells(inode,icell)
              points(1) = nodes(ivol)

              if(inode < num_nodes_per_cell) then
                jvol = cells(inode+1,icell)
              else
                jvol = cells(1,icell)
              end if


              if (cvol_method == cvol_method_cc) then
                iface = get_face_edge_index(icell,ivol,jvol)
                points(2) = CellFaceCenter(iface,icell)
              else
                points(2) = (nodes(ivol) + nodes(jvol))*rhalf
              end if

              points(3) = CellCenter(icell)

              if(inode == 1) then
                jvol = cells(num_nodes_per_cell,icell)
              else
                jvol = cells(inode-1,icell)
              end if

              if (cvol_method == cvol_method_cc) then
                iface = get_face_edge_index(icell,ivol,jvol)
                points(4) = CellFaceCenter(iface,icell)
              else
                points(4) = (nodes(ivol) + nodes(jvol))*rhalf
              end if

              rvol = geometry_area(4,points)
              cvol(ivol) = cvol(ivol) + rvol
            end do
          end do
        else if (cell_type == cell_type_tetra) then
          do icell = 1, num_cells                !number of cells
            do iface = 1, num_faces_per_cell     !number of faces
              do inode = 1, num_nodes_per_face
                inode2 = face_node_mapping_tetra(inode,iface)
                ivol = cells(inode2,icell)
                if(inode == 3) then
                  jnode2 = face_node_mapping_tetra(1,iface)
                  jvol = cells(jnode2,icell)
                else
                  jnode2 = face_node_mapping_tetra(inode+1,iface)
                  jvol = cells(jnode2,icell)
                end if
                points(1) = CellFaceCenter(iface,icell)
                points(2) = (nodes(ivol) + nodes(jvol))*rhalf
                points(3) = CellCenter(icell)
                points(4) = nodes(ivol)

                rvol = geometry_volume(4,points)
                cvol(ivol) = cvol(ivol) + rvol
                cvol(jvol) = cvol(jvol) + rvol
              end do
            end do
          end do
        else if (cell_type == cell_type_hexa) then
          do icell = 1, num_cells                !number of cells
            ivol1 = cells(1,icell)
            ivol2 = cells(2,icell)
            ivol3 = cells(3,icell)
            ivol4 = cells(4,icell)
            ivol5 = cells(5,icell)
            ivol6 = cells(6,icell)
            ivol7 = cells(7,icell)
            ivol8 = cells(8,icell)

            !c node 1 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol1)+nodes(ivol4))*rhalf
            points(3) = nodes(ivol1)
            points(4) = (nodes(ivol1)+nodes(ivol2))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(6,icell)
            points(7) = (nodes(ivol1)+nodes(ivol5))*rhalf
            points(8) = CellFaceCenter(3,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol1) = cvol(ivol1) + rvol            

            !c node 2 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol1)+nodes(ivol2))*rhalf
            points(3) = nodes(ivol2)
            points(4) = (nodes(ivol2)+nodes(ivol3))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(3,icell)
            points(7) = (nodes(ivol2)+nodes(ivol6))*rhalf
            points(8) = CellFaceCenter(4,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol2) = cvol(ivol2) + rvol

            !c node 3 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol2)+nodes(ivol3))*rhalf
            points(3) = nodes(ivol3)
            points(4) = (nodes(ivol3)+nodes(ivol4))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(4,icell)
            points(7) = (nodes(ivol3)+nodes(ivol7))*rhalf
            points(8) = CellFaceCenter(5,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol3) = cvol(ivol3) + rvol

            !c node 4 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol3)+nodes(ivol4))*rhalf
            points(3) = nodes(ivol4)
            points(4) = (nodes(ivol4)+nodes(ivol1))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(5,icell)
            points(7) = (nodes(ivol4)+nodes(ivol8))*rhalf
            points(8) = CellFaceCenter(6,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol4) = cvol(ivol4) + rvol

            !c node 5 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(6,icell)
            points(3) = (nodes(ivol1)+nodes(ivol5))*rhalf
            points(4) = CellFaceCenter(3,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol5)+nodes(ivol8))*rhalf
            points(7) = nodes(ivol5)
            points(8) = (nodes(ivol5)+nodes(ivol6))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol5) = cvol(ivol5) + rvol

            !c node 6 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(3,icell)
            points(3) = (nodes(ivol2)+nodes(ivol6))*rhalf
            points(4) = CellFaceCenter(4,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol5)+nodes(ivol6))*rhalf
            points(7) = nodes(ivol6)
            points(8) = (nodes(ivol6)+nodes(ivol7))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol6) = cvol(ivol6) + rvol

            !c node 7 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(4,icell)
            points(3) = (nodes(ivol3)+nodes(ivol7))*rhalf
            points(4) = CellFaceCenter(5,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol6)+nodes(ivol7))*rhalf
            points(7) = nodes(ivol7)
            points(8) = (nodes(ivol7)+nodes(ivol8))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol7) = cvol(ivol7) + rvol

            !c node 8 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(5,icell)
            points(3) = (nodes(ivol4)+nodes(ivol8))*rhalf
            points(4) = CellFaceCenter(6,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol7)+nodes(ivol8))*rhalf
            points(7) = nodes(ivol8)
            points(8) = (nodes(ivol8)+nodes(ivol5))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol8) = cvol(ivol8) + rvol
          end do

        else if (cell_type == cell_type_prism) then

          do icell = 1, num_cells                !number of cells
            ivol1 = cells(1,icell)
            ivol2 = cells(2,icell)
            ivol3 = cells(3,icell)
            ivol4 = cells(4,icell)
            ivol5 = cells(5,icell)
            ivol6 = cells(6,icell)

            !c node 1 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol1)+nodes(ivol3))*rhalf
            points(3) = nodes(ivol1)
            points(4) = (nodes(ivol1)+nodes(ivol2))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(5,icell)
            points(7) = (nodes(ivol1)+nodes(ivol4))*rhalf
            points(8) = CellFaceCenter(3,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol1) = cvol(ivol1) + rvol

            !c node 2 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol1)+nodes(ivol2))*rhalf
            points(3) = nodes(ivol2)
            points(4) = (nodes(ivol2)+nodes(ivol3))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(3,icell)
            points(7) = (nodes(ivol2)+nodes(ivol5))*rhalf
            points(8) = CellFaceCenter(4,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol2) = cvol(ivol2) + rvol

            !c node 3 of current cell
            points(1) = CellFaceCenter(1,icell)
            points(2) = (nodes(ivol2)+nodes(ivol3))*rhalf
            points(3) = nodes(ivol3)
            points(4) = (nodes(ivol1)+nodes(ivol3))*rhalf
            points(5) = CellCenter(icell)
            points(6) = CellFaceCenter(4,icell)
            points(7) = (nodes(ivol3)+nodes(ivol6))*rhalf
            points(8) = CellFaceCenter(5,icell)

            rvol = geometry_volume(8,points)
            cvol(ivol3) = cvol(ivol3) + rvol

            !c node 4 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(5,icell)
            points(3) = (nodes(ivol1)+nodes(ivol4))*rhalf
            points(4) = CellFaceCenter(3,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol4)+nodes(ivol6))*rhalf
            points(7) = nodes(ivol4)
            points(8) = (nodes(ivol4)+nodes(ivol5))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol4) = cvol(ivol4) + rvol

            !c node 5 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(3,icell)
            points(3) = (nodes(ivol2)+nodes(ivol5))*rhalf
            points(4) = CellFaceCenter(4,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol4)+nodes(ivol5))*rhalf
            points(7) = nodes(ivol5)
            points(8) = (nodes(ivol5)+nodes(ivol6))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol5) = cvol(ivol5) + rvol

            !c node 6 of current cell
            points(1) = CellCenter(icell)
            points(2) = CellFaceCenter(4,icell)
            points(3) = (nodes(ivol3)+nodes(ivol6))*rhalf
            points(4) = CellFaceCenter(5,icell)
            points(5) = CellFaceCenter(2,icell)
            points(6) = (nodes(ivol5)+nodes(ivol6))*rhalf
            points(7) = nodes(ivol6)
            points(8) = (nodes(ivol4)+nodes(ivol6))*rhalf

            rvol = geometry_volume(8,points)
            cvol(ivol6) = cvol(ivol6) + rvol
          end do

        else
          if (rank == 0) then
            write(ilog,*) 'cvolume calculation does not support cell_type ',cell_type
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
#endif
      end if

!c calculate total control volume for the whole domain
      cvol_tot = r0
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_cvolume_1)                      &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp reduction(+:cvol_tot)
    !$omp do schedule(static)
#endif
      do ivol = 1,nngl
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
          cycle
        end if
#endif
        cvol_tot = cvol_tot + cvol(ivol)
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef PETSC
      call MPI_Allreduce(cvol_tot, cvol_tot_gbl,1,MPI_REAL8,MPI_SUM, &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      cvol_tot = cvol_tot_gbl
#endif

!c  output total control volume to screen and log file
      if (rank == 0 .and. b_enable_output) then
        write(*,'(1x,a,1x,e16.8)') 'Total volume of simulation domain',cvol_tot
        write(ilog,'(1x,a,1x,e16.8)') 'Total volume of simulation domain',cvol_tot
      end if

      info_dbg = 0
      if (info_dbg .gt. 0) then
        if (b_enable_output .and. b_enable_output_gen) then
          rvol = 0.0d0
          if (discretization_type == 0) then
            write(igen,'(2a)')                                         &
                  "  ivol   ivx   ivy   ivz              xg",          &
                  "              yg              zg            cvol"
            ivol = 0
            do ivz = nvzgls,nvzgle                  ! number of control volumes in z
              do ivy = nvygls,nvygle                ! number of control volumes in y
                do ivx = nvxgls,nvxgle              ! number of control volumes in x
                  ivol = ivol+1
                  !write(igen,'(4i6,4(1x,es15.7))') ivol,ivx,ivy,ivz,   &
                  !      xg(ivol),yg(ivol),zg(ivol),cvol(ivol)
                  write(igen,'(i6,4(1x,es15.7))') ivol,                &
                        xg(ivol),yg(ivol),zg(ivol),cvol(ivol)
                  rvol = rvol + cvol(ivol)
                end do
              end do
            end do
            write(igen,'(a,1x,es24.16)') "total volume:",rvol
          else
#ifdef USG
            write(igen,'(2a)') "  ivol              xg              ", &
                               "yg              zg            cvol"
            do ivol = 1, nngl
              write(igen,'(i6,4(1x,es15.7))') ivol,nodes(ivol)%x,      &
                    nodes(ivol)%y,nodes(ivol)%z,cvol(ivol)
              rvol = rvol + cvol(ivol)
            end do
            write(igen,'(a,1x,es24.16)') "total volume:",rvol
#endif
          end if
        end if
        
        if (info_dbg .gt. 1) then
          if (rank == 0) then
            write(ilog,*) 'program stopped by dbg in cvolume.f'
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
      end if
      info_dbg = 0

      return
      end
