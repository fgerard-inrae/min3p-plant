!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/diffcoff.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function diffcoff
!c ------------------------
!c
!c compute effective diffusion coefficient
!c
!c note: tau^org = (S_p * por)^10/3 / por^2
!c               =  S_p^10/3 * por^4/3          (1)
!c
!c according to Simunek and Suarez (WRR(30)4, pp. 1115-1133):
!c
!c S_p * por * D_p^eff = tau^org * D_p          (2)
!c
!c where the factor S_p * por is considered in assembly
!c to relate pore space filled with phase p to the 
!c bulk volume of medium
!c
!c D_p^eff = tau^org * D_p / (S_p * por)        (2')
!c
!c subsitituting (1) in (2') yields:
!c
!c D_p^eff = S_p^10/3 * por^4/3 * D_p / (S_p * por)
!c         = S_p^7/3  * por^1/3 * D_p
!c         = tau^mod * D_p
!c
!c here use tau = tau^org
!c where D_p is the free diffusion coefficient in phase p
!c ----------------------------------------------------------------------
!c
!c written by:      Uli Mayer - April 28, 97
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           diffcoff           = effective diffusion coefficient     * +
!c           diff_p             = free diffusion coefficient in       + -
!c                                phase p
!c           sat_p              = saturation of phase p               + -
!c           por                = porosity                            + -
!c           tortuosity_corr    = .true.  -> Millington-Quirk         + -
!c                                           tortuosity correction
!c                                           for diffusion
!c                                           coefficients
!c
!c common:   -
!c
!c local:    real*8:
!c           -------
!c           r3                 = constant
!c           r4                 = constant
!c           r10                = constant
!c
!c external: -
!c ----------------------------------------------------------------------

      module mod_diffcoff

      use geometry_definition
      use geometry

      implicit none

      interface diffcoff
        module procedure diffcoff_single
        module procedure diffcoff_tensor
      end interface diffcoff

      contains
 
      real*8 function diffcoff_single(diff_p,sat_p,por,tortuosity_corr,&
                               assigned_tau,tau,type_tortuosity,       &
                               m_archie,sat_oil,a_mq,b_mq)
      
      implicit none

      real*8 :: diff_p, sat_p, por, tau , sat_oil, a_mq, b_mq
      
      real*8 :: r1, r2, r3, r4, r10

      parameter (r1 = 1.0d0, r2 = 2.0d0, r3 = 3.0d0, r4 = 4.0d0,       &
                 r10 = 10.0d0)
 
      logical tortuosity_corr,assigned_tau
      
      character(len=*) type_tortuosity
      
      real*8 m_archie 

      diffcoff_single = 0.0d0

      if (tortuosity_corr) then
       
        if (assigned_tau) then
          diffcoff_single = diff_p * (tau * sat_p * por)
        else   
          select case (type_tortuosity)
          case('millington')
            diffcoff_single = diff_p * (sat_p**(r10/r3) * por**(r4/r3)*&
                              (r1-sat_oil)**r2)
          case('millington-quirk experimental') 
            diffcoff_single = diff_p * ((sat_p**b_mq) * (por**(a_mq+r1))) 
          case('millington-quirk adjustable')
            diffcoff_single = diff_p * ((sat_p**(b_mq+r1)) * (por**(a_mq+r1)))              
          case('archie')
            !diffcoff = diff_p * sat_p * por**m_archie          ! bug, DSU 2013-2-28
            diffcoff_single = diff_p * (sat_p * por**(m_archie + r1))
          case('fix diffusion')
            diffcoff_single = diff_p  
          case default
            diffcoff_single = diff_p * (sat_p**(r10/r3) * por**(r4/r3)*&
                             (r1-sat_oil)**r2)
          end select
        end if
      
      else  
              
        diffcoff_single = diff_p * (sat_p * por)
      
      end if

    end function diffcoff_single

    function diffcoff_tensor(diff_p,sat_p,por,tortuosity_corr,         &
                      assigned_tau,tau,type_tortuosity,                &
                      m_archie,sat_oil,a_mq,b_mq) result(diffcoff)
      
      implicit none

      type(tensor) :: diff_p, diffcoff
      real*8 :: sat_p, por, tau , sat_oil, a_mq, b_mq
      
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0,         &
                           r3 = 3.0d0, r4 = 4.0d0, r10 = 10.0d0
 
      logical :: tortuosity_corr,assigned_tau
      
      character(len=*) :: type_tortuosity
      
      real*8 :: m_archie 

      diffcoff = tensor_zero

      if (tortuosity_corr) then
       
        if (assigned_tau) then
          diffcoff = diff_p * (tau * sat_p * por)
        else   
          select case (type_tortuosity)
          case('millington')
            diffcoff = diff_p * (sat_p**(r10/r3) * por**(r4/r3)*       &
                       (r1-sat_oil)**r2)
          case('millington-quirk experimental')
            diffcoff = diff_p * ((sat_p**b_mq) * (por**(a_mq+r1)))
          case('millington-quirk adjustable')
            diffcoff = diff_p * ((sat_p**(b_mq+r1)) * (por**(a_mq+r1)))               
          case('archie')
            !diffcoff = diff_p * sat_p * por**m_archie          ! bug, DSU 2013-2-28
            diffcoff = diff_p * (sat_p * por**(m_archie + r1))
          case('fix diffusion')
            diffcoff = diff_p  
          case default
            diffcoff = diff_p * (sat_p**(r10/r3) * por**(r4/r3)*       &
                       (r1-sat_oil)**r2)
          end select
        end if
      
      else  
              
        diffcoff = diff_p * (sat_p * por)
      
      end if

    end function diffcoff_tensor

    end module mod_diffcoff
