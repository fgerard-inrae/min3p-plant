!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/rootwat.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c real*8 function rootwat
!c -----------------------
!c compute root water uptake for current control volume 
!c
!c written by:      Uli Mayer - July 24, 01
!c
!c last modified:   Uli Mayer - Nov. 28, 01
!c                  updated calculation of root water uptake
!c            Fred Gérard - Oct. 5, 05
!c                  pretty much rewritten : evaporation component taken off, 
!c            function evap used instead
!c                  Fred Gérard - Oct, 07
!c                  change in the alpha function applied to transpiration : mean 
!c            REW profile scale used
!c            Celine Blitz Frayret (CBF) for Frederic Gerard, December 14, 2018 :
!c            updates in commented parameters
!c 
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           satwnew            = aqueous phase satutaion             + -
!c                                - new time level
!c          
!c common: 
!c
!c gen.F90:  integer*4
!c         ----------
!c           mpropvs(nn)        = pointer array for allocation of 
!c                                material properties
!c         real*8
!c           -------
!c         cvol(nn)           = nodal volumes
!c         toparea         = profil area exposed to atmosphere
!c
!c biol.F90: real*8
!c           ------
!c         rld(nn)            = root length density
!c           p1(nzn)            = fitting parameter for root water    + -
!c                                uptake function
!c           pet                = potential evapotranspiration
!c           pe_soil            = potential soil evaporation
!c           canopy_int         = canopy interception
!c         scale_tree_growth  = scale factor to account for the influence
!c                                of tree growth on transpiration 
!c
!c           integer*4
!c         -------
!c         cmws              = computing method for water stress             * +
!c
!c           logical:
!c           --------
!c           vegetation_growth = .true. -> account for the effect of vegetation growth
!c         rootdensitynill   = .true. -> when root density length equal to zero
!c
!c phys.f:   real*8:
!c           ------- 
!c           satwlim(nzn)       = water saturation at wilting point   + -
!c           satwfield(nzn)     = water saturation at field capacity  + -
!c           rew0(izn)          = relative extractable water at       + -
!c                                50% of maximum extraction capacity 
!c                                (fitting parameter)
!c         rew(izn)           = relative extractable water  CBF     + -
!c           rewm               = mean reserve of extractible water CBF
!c
!c
!c local:    real*8:
!c           ------- 
!c           r0                 = constant
!c           r1                 = constant
!c           r2                 = constant
!c           v_prop             = proportion of actual transpiration in current volume  CBF
!c           alpha              = reduction factor for transpiration  CBF
!c           rsum               = total root transpiration  CBF
!c
!c         integer*4
!c         -------
!c           izn                = pointer to material property zone  CBF
!c
!c
!c external: -
!c ----------------------------------------------------------------------

    real*8 function rootwat(satwnew,ivol,rsum)
 
      use parm
      use phys
      use dual
      use gen 
      use biol

      implicit none

      real*8 :: satwnew(*)

      integer :: ivol

      real*8 :: rsum

      integer :: i, izn
      
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0

      real*8 :: alpha, v_prop, rew, a, b !CBF

      real*8 :: satwlim_loc, satwfield_loc, h1field_loc, satwopt_loc,  &
                h1lim_loc, h1opt_loc, p1_loc, rew0_loc

!c CBF --------------------------------------------------------------------
!c CBF function re-written from here 
!c CBF --------------------------------------------------------------------
!c CBF In previous version , rootwat = alpha/tree_trans_factor(1) or rootwat = 0,
!c CBF corresponding to the case where cmws = 1.
!c CBF Now, rootwat depends on :
!c CBF - computation of the reduction factor (alpha)
!c CBF - computation of the proportion of potential transpiration (v_prop), linked to RLD
!c CBF - others parameters and variables : toparea, scale_tree_growth, cvol(ivol)
!c CBF For more details about calculation, please refer to Mayer et al., 2011
!c CBF------------------------------------------------------------------------


      if (rootdensitynill) then !no calculation if no root => 0 returned
        
        rootwat=0.0d0
        
      else !calculations of rootwat



!    setup pointer to the material properties of the current volume :

        izn = mpropvs(ivol)

        if (rootwateruptake_field) then
          satwlim_loc = satwlim_vol(ivol)
          satwfield_loc = satwfield_vol(ivol)
          h1field_loc = h1field_vol(ivol)
          satwopt_loc = satwopt_vol(ivol)
          h1lim_loc = h1lim_vol(ivol)
          h1opt_loc = h1opt_vol(ivol)
        else
          satwlim_loc = satwlim(izn)
          satwfield_loc = satwfield(izn)
          h1field_loc = h1field(izn)
          satwopt_loc = satwopt(izn)
          h1lim_loc = h1lim(izn)
          h1opt_loc = h1opt(izn)
        end if

        if (battaglia_field) then
          p1_loc = p1_vol(ivol)
          rew0_loc = rew0_vol(ivol)
        else
          p1_loc = p1(izn)
          rew0_loc = rew0(izn)
        end if

        rew = dmin1((satwnew(ivol)-satwlim_loc)/                       &
                    (satwfield_loc-satwlim_loc),r1)

!c ---------------------------------------------------------------------------
!c Computation of the reduction factor 'alpha'
!c ---------------------------------------------------------------------------

        alpha = r0

!c method 1: correction according to the continuous function of Battaglia et al. (1997) 

        if (cmws.eq.1) then

          if (satwnew(ivol).le.satwlim_loc) then
            alpha = r0
          else
            alpha=rew**r2*dexp(rew*p1_loc)/                            &
                 (rew0_loc**r2*dexp(p1_loc*rew0_loc)                   &
                  +rew**r2*dexp(p1_loc*rew))
          endif

!c method 2: correction according to the discontinuous function of Feddes (1978)

        elseif (cmws.eq.2) then

          if (satwnew(ivol).le.satwlim_loc) then    !100% reduction if Sa < wilting point
            alpha = r0
          else if (satwnew(ivol).ge.satwfield_loc) then ! linear reduction because saturation exceeds field capacity (and Sa max = 1)
            alpha = r1/h1field_loc*abs(uvsnew(ivol))
          else if (satwnew(ivol).ge.satwopt_loc) then ! no reduction if between field capacity and optimal value
            alpha = r1
          else  ! here, satwnew must be comprised between Sa lim and Sa opt => linear reduction
            a = -r1/(h1lim_loc - h1opt_loc)
            b = r1-(a*h1opt_loc)
            alpha = a*abs(uvsnew(ivol))+b           
          end if


!c method 3:  no reduction factor

        elseif (cmws.eq.3) then

          if (satwnew(ivol).le.satwlim_loc) then
            alpha = r0
          else          
            alpha = r1
          end if

        endif ! cmws

!c --------------------------------------------------------------------------------
!c Computation of the proportion of potential transpiration in each volume 'v_prop'
!c the root volume prop 'v_prop' is computed using root length and soil moisture
!c --------------------------------------------------------------------------------
        v_prop = satwnew(ivol) * rld(ivol) * cvol(ivol)/rsum ! CBF RLD, DSU rsum_vprop
     
        rootwat = v_prop * alpha * tpot / cvol(ivol)  !FG August 2021 - scale_tree_growth and toparea discarded as conversion done before now, as well
                                                        ! tpot already corrected for the effect top area if vegetation growth, and expressed in m3/s
                                                        ! rootwat in s-1 therefore here

!cdsu----------------------------------------------------------
!cdsu node based root water uptake parameters for output only
!cdsu----------------------------------------------------------
        alpha_vol(ivol) = alpha
        v_prop_vol(ivol) = v_prop

      endif ! rootdensitynill or not

      return

    end
