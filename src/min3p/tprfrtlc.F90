!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/tprfrtlc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tprfrtlc
!c -------------------
!c write transient data to output file for postprocessing
!c (reactive transport or local chemistry)
!c
!c
!c written by:      Uli Mayer - February 17, 96
!c
!c last modified:   Uli Mayer - February 1, 98
!c                  Uli Mayer - November 12, 01
!c                  added new database format
!c                  for dissolution-precipitation reactions
!c
!c                  Danyang Su - March. 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc)              = concentrations of free species      + -
!c                                [moles/l water]
!c           cx(nx)             = concentrations of secondary aqueous + +
!c                                species [moles/l water]
!c           cm(nm)             = concentrations of minerals          + -
!c                                [moles/l bulk]
!c           deltat             = time step                           + -
!c           g(ng)              = gas concentrations [moles/l air]    + -
!c           gammac(nc)         = activity coefficients of free       * *
!c                                species
!c           gammax(nx)         = activity coefficients of aqueous    * *
!c                                complexes
!c           cec_l              = cation exchange capacity (meq/100g) + -
!c                                - local system
!c           distcoff(nc)       = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk] 
!c           phim(nm)           = volume fractions of minerals        + -
!c           phimold(nm)        = volume fractions of minerals        + -
!c                                (old time level)
!c           porvol             = porosity                            + -
!c           strion             = ionic strength                      + +
!c           sw                 = saturation (aqueous phase)          + -
!c           time               = current solution time               + -
!c           totc(n)            = total aqueous component             + -
!c                                concentrations [moles/l water]
!c           tempkel            = temperature [deg K]                 + -
!c           hhead              = hydraulic head                      + -
!c           zg                 = elevation head                      + -
!c
!c           integer*4:
!c           ----------
!c           fibt             = unit number, total aqueous          + -
!c                                             component 
!c                                             concentrations
!c                                             transient data
!c           fibc             = unit number, species concentrations + -
!c                                             transient data
!c           fibm             = unit number, master variables       + -
!c                                             transient data
!c           fibg             = unit number, partial gas pressures  + -
!c                                             transient data
!c           fibgr            = unit number, degassing rates        + -
!c                                             transient data
!c           fibi             = unit number, oxidation-reduction    + -
!c                                             rates, transient 
!c                                             data
!c           fibb             = unit number, concentrations of      + -
!c                                             sorbed species     
!c           fibs             = unit number, mineral saturation     + -
!c                                             indices, transient 
!c                                             data
!c           fibv             = unit number, mineral volume         + -
!c                                             fractions, transient
!c                                             data
!c           fibd             = unit number, dissolution-           + -
!c                                             precipitation rates
!c                                             transient data
!c           fibx            = unit number, saturation indices     + -
!c                                             (excluded minerals)
!c                                             transient data
!c           fibis            = unit number, Isotope data           + -
!c
!c           fibre            = unit number, concentration of       + -
!c                                             radioelements
!c                                             transient data
!c           igbac              = unit number, activity coefficient   + -
!c                                              - transient data
!c                                                global system
!c           ivolume            = number of control volume considered + -
!c                                ( = 0, for batch problem)
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 + -
!c           ntstp              = current time step                   + -
!c
!c           logical:    
!c           --------
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           zone_name          = zone name                           + -
!c
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           alkfacc(nc)        = alkalinity factors for components   + -
!c                                as species in solution
!c           alkfacx(nx)        = alkalinity factors for aqueous      + -
!c                                complexes
!c           conc_mol_avg(nthreads)
!c                              = average molar concentration of      + *
!c                                organic mixture
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)   
!c                              = concentrations of sorbed species    * *
!c                                - new time level
!c                                (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level
!c                                (surface-complex)
!c           densm(nm)          = densities of minerals               + -
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqmx(nmx,nthreads) = equilibrium constants for excluded  + -
!c                                minerals
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           gfwm(nm)           = gram formula weight of minerals     + -
!c           phimin(nm)         = volume fractions of minerals for    + -
!c                                nucleation
!c           phimin_out(nm)     = cutoff mineral volume fractions     + -
!c                                for output
!c           phi_out(nm)        = mineral volume fractions for output * *
!c           rateaq(naq,nthreads)
!c                              = reaction rates of intra-aqueous     * *
!c                                kinetic reaction
!c           rateg(ng,nthreads) = degassing rates                     * a
!c           rateor(nr,tid)     = oxidation-reduction rate for        * * 
!c                                redox couple [moles/(l h2o*day)
!c           rgasatm            = ideal gas constant                  + -
!c                                [liter atm/(deg K mole)]
!c           satm(nm,nthreads)  = IAP/K                               * +
!c           satm_log(nm)       = saturation indices                  * +
!c           satmx(nmx)         = saturation indices for excluded     * +
!c                                minerals
!c           tconv              = temperature correction factor       + -
!c           totan(nc,nthreads) = total sorbed component              * *
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c           xnumx(nmx*nc)      = stoichiometric coefficients of      + -
!c                                components in excluded mineral
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)= stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c           
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iamp(nm+1)         = pointer array for distribution      + -
!c                                and combination of mineralogical
!c                                parameters
!c           iamx(nmx+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in excluded mineral
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jamx(nmx*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in excluded mineral
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           l_nameanc(nc)      = length of names of sorbed           + -
!c                                components (non-competitive
!c                                sorption
!c           l_nameaq(naq)      = length of names of intra-aqueous    + -
!c                                kinetic reactions
!c           l_namec(nc)        = length of component names           + -
!c           l_nameg(ng)        = length of names of gases            + -
!c           l_namem(nm)        = length of mineral names             + -
!c           l_namemp(ndr*nm)   = length of names of parallel         + -
!c                                dissolution-precipitation reactions
!c           l_namemx(nmx)      = length of names of excluded         + -
!c                                minerals
!c           l_namer(nr)        = length of names of redox couples    + -
!c           l_namesb_ion(nsb)  = length of names of sorbed           + -
!c                                species (ion-exchange)
!c           l_namesb_surf(nsb) = length of names of sorbed           + -
!c                                species (surface-complex)
!c           l_namesb(nsb)      = length of names of sorbed           + -
!c                                species
!c           l_namex(nx)        = length of names of secondary        + -
!c                                aqueous species
!c           nanc               = number of sorbed species            + -
!c                                non-competitive sorption
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c           nx                 = number of secondary aqueous species + -
!c
!c           logical:
!c           --------
!c           compute_alkalinity = .true.  -> calculate alkalinity     + -
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c           ph_output          = .true.  -> output of pH             + -
!c           ph_sweep           = .true.  -> sweep over specified     + -
!c                                           pH-range
!c           pe_output          = .true.  -> output of pe and Eh      + -
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           update_porosity    = .true.  -> update porosity as       + -
!c                                           a result of dissolution-
!c                                           precipitation reactions
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -   
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namemx(nm)         = names of excluded minerals          + -
!c           namer(nr)          = names of redox couples              + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c           namex(nx)          = names of secondary aqueous species  + -
!c           reaction_type(nm)  = 'reversible'                        + -
!c                                'dissolution_to_equilibrium'
!c                                'precipitation_to_equilibrium'
!c                                'dissolution_far_from_equilibrium'
!c                                'precipitation_far_from_equilibrium'
!c                                'monod'
!c                                'raoult'
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c
!c local:    real*8:
!c           -------
!c           alk_carb           = carbonate alkalinity [eq/L]
!c           alk_noncarb        = noncarbonate alkalinity [eq/L]
!c           alk_tot            = total alkalinity [eq/L]
!c           alk_carb_mg        = carbonate alkalinity [mg/L CaCO3]
!c           alk_noncarb_mg     = non-carbonate alkalinity
!c                                [mg/L CaCO3]
!c           alk_tot_mg         = total alkalinity [mg/L CaCO3]
!c           conc_mol           = molar concentration of organic
!c                                compound in organic mixture
!c           eh                 = Eh
!c           frac_mol           = mole fraction of organic compound
!c                                in organic mixture
!c           pe                 = pe
!c           ph                 = pH
!c           por_out            = porosity for output
!c           pres_tot           = total gas pressure [atm]
!c           r0                 = constant
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ianc               = counter (non-competitive sorption
!c                                         reactions)
!c           iaq                = counter (intra-aqueous kinetic
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imx                = counter (excluded minerals)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           ir                 = counter (redox couples)
!c           ix                 = counter (secondary species)
!c           l_indep_var        = length of independent variable
!c                                for output
!c           nxout              = number of secondary species for 
!c                                output
!c           character:
!c           ----------
!c           indep_var          = independent variable for output
!c
!c external: alkcalc   = compute alkalinity
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions
!c           modrate   = modify reaction rate
!c           molconc   = compute average molar concentration for
!c                       organic mixture
!c           phpe      = compute pH, pe and Eh
!c           rategas   = compute degassing rates
!c           rateint   = compute rate for intra-aqueous kinetic
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic
!c                       reactions (new database format)
!c           ratemin   = compute absolute dissolution-precipitation
!c                       rates of minerals
!c           ratemin_new = compute absolute dissolution-precipitation
!c                       rates of minerals (new database format)
!c           rateredx  = compute oxidation/reduction rates for
!c                       redox couples
!c           satindex  = compute saturation index
!c           sorbspc   = compute sorbed species concentration
!c           totconc   = total aqueous component concentration
!c           updtsvap  = update secondary variables in aqueous phase
!c ----------------------------------------------------------------------

      subroutine tprfrtlc(totc,c,cx,gammac,gammax,cm,g,cec_l,distcoff,&
                          aream,phim,phimold,strion,                  &
                          tempkel,hhead,xg,yg,zg,                     &
                          time,deltat,sw,porvol,fibt,fibc,fibm,       &
                          fibg,fibgr,fibi,fibb,fibs,fibv,             &
                          fibd,fibx,fibis,fibac,fibre,                &
                          offset_bt,offset_bc,offset_bm,              &
                          offset_bg,offset_bx,offset_bgr,             &
                          offset_bi,offset_bb,offset_bs,              &
                          offset_bv,offset_bd,offset_bis,             &
                          offset_bac,offset_bre,                      &
                          offset_bt_ijk,offset_bc_ijk,offset_bm_ijk,  &
                          offset_bg_ijk,offset_bgr_ijk,offset_bi_ijk, &
                          offset_bb_ijk,offset_bs_ijk,offset_bv_ijk,  &
                          offset_bd_ijk,offset_bx_ijk,offset_bis_ijk, & 
                          offset_bac_ijk,offset_bre_ijk,              &
                          prefix,l_prfx,tec_header,                   &
                          ivolume,tid,ntstp,ngb_tstep,zone_name,      &
                          l_zone_name,update_porosity,                &
                          mtime,i_append_sim, mtime_append)

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use chem
      use dens
      use bbls
      use writeversion
      use nobleGasIngrowth, only : b_use_ngi, ngre_i, name_ngre_i,     &
          conc_ngre_loc
      use file_utility, only : reposition_file, check_rewind_status
      use biol, only : rld

      use gen, only :                                                  &
#ifdef PETSC
                      node_idx_lg2g,                                   &
#else
                      Petsc_Comm_Self,                                 &
#endif
                      ilog, b_writeversion_tecplot, backup_frequency,  &
                      b_output_trans_binary, realbuffer_gb,            &
                      b_output_multizone,b_output_activity,            &
                      mem_cur, mem_max, memory_monitor,                &
                      nfloatbit, idbg, ascii_fmt, extended_output_gb,  &
                      b_water_freezing_ratemin, water_freezing_ratemin,&
                      ngb_step, ngb_step_bk, mpropc,                   &
                      imizn2jairm, imizn2irc, flag_intermittent_react, &
                      totcnew, totcold, root_uptake

      use module_binary_mpiio, only :  tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data
      
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: tid,iaq,ianc,ierr,i,i1,i2,i3,ii,ic,ic1,ic2,           &
                 icur,icount,ig,im,imi,imx,ir,ireac,isb,isites,        &
                 istart,istop,istart2,istop2,fibt,fibc,                &
                 fibm,fibg,fibi,fibb,fibs,fibv,fibd,                   &
                 fibx,fibgr,fibis,fibac,fibre,                         &
                 ivolume,ix,next,nxout, mtime, irecord,                &
                 l_indep_var,l_prfx,l_zone_name,ntstp,ngb_tstep  

      integer :: i_append_sim, mtime_append
      
      real*8 :: c, cx, gammac, gammax, strion, totc, time, rootdens,   &
                zbal, zpos, zneg, ph, pe, eh,                          &
                tempkel, xg, yg, zg, alk_carb,                         &
                alk_noncarb, alk_tot, alk_carb_mg, alk_noncarb_mg,     &
                alk_tot_mg, pres_tot, g, hhead, phim, distcoff,        &
                sw, porvol, dummy, cec_l, phimold, conc_mol,           &
                frac_mol, ratem, aream, cm, deltat, gammatemp, tottemp
      real*8, external :: satindex, pressure_melt_k

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
 
      external alkcalc, comptotc, phpe, rateredx,                      &
               sorbspc, totconc, molconc, rategas, rategasd,           &
               rateint, rateint_new, ratemin, ratemin_new,             &
               updtsvap, modrate, checkerr
                                                                       
      character*72 prefix, indep_var                                   
      character*72 zone_name
                                                                       
      logical tec_header,update_porosity
                                                                       
      dimension totc(*),c(*),cx(*),cm(*),g(*),distcoff(*),gammac(*),   &
                gammax(*),aream(*),phim(*),phimold(*)
      
      character*72, allocatable :: nametemp(:)
      integer (type_i4), allocatable :: l_nametemp(:)
      real*8, allocatable :: valuetemp(:)
      
      integer*4 :: nvars, izn_c, ingre
      character*72, allocatable :: tec_variables(:)
      character*2048 :: strbuffer
      
      logical :: b_use_tectitle, b_rewind_valid

#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) ::                                 &
                   offset_bt,offset_bc,offset_bm,offset_bg,            &
                   offset_bgr,offset_bi,offset_bb,offset_bs,           &
                   offset_bv,offset_bd,offset_bx,offset_bis,           &
                   offset_bac,offset_bre,                              &
                   offset_bt_ijk,offset_bc_ijk,offset_bm_ijk,          &
                   offset_bg_ijk,offset_bi_ijk,offset_bb_ijk,          &
                   offset_bs_ijk,offset_bv_ijk,offset_bd_ijk,          &
                   offset_bx_ijk,offset_bgr_ijk,offset_bis_ijk,        &
                   offset_bac_ijk,offset_bre_ijk
#else
      integer*8 ::                                                     &
                   offset_bt,offset_bc,offset_bm,offset_bg,            &
                   offset_bgr,offset_bi,offset_bb,offset_bs,           &
                   offset_bv,offset_bd,offset_bx,offset_bis,           &
                   offset_bac,offset_bre,                              &
                   offset_bt_ijk,offset_bc_ijk,offset_bm_ijk,          &
                   offset_bg_ijk,offset_bi_ijk,offset_bb_ijk,          &
                   offset_bs_ijk,offset_bv_ijk,offset_bd_ijk,          &
                   offset_bx_ijk,offset_bgr_ijk,offset_bis_ijk,        &
                   offset_bac_ijk,offset_bre_ijk
#endif

      if (ivolume > 0) then
        izn_c = mpropc(ivolume)
      end if

!cdsu when read aqueous concentration from file, output using tecplot multizone format
!cdsu for local chemistry
      b_use_tectitle = .true.
      b_rewind_valid = .false.

      if (index(zone_name,'local chemistry ivol =') > 0 .and.          &
          zone_name(1:l_zone_name).ne.'local chemistry ivol = 1') then
        b_use_tectitle = .false.
      end if

!cprovi----------------------------------------- 
!cprovi was initialized 
!cprovi Sergio Andres Bea
!cprovi 02/02/2009
!cprovi-----------------------------------------
      istart=1
      istop=1
      
      allocate (nametemp(nip*8), stat = ierr)
      nametemp = ""
      call checkerr(ierr,'nametemp',ilog)
      call memory_monitor(sizeof(nametemp),'nametemp',.false.)

      allocate (l_nametemp(nip*8), stat = ierr)
      l_nametemp = 0
      call checkerr(ierr,'l_nametemp',ilog)
      call memory_monitor(sizeof(l_nametemp),'l_nametemp',.false.)

      allocate (valuetemp(nip*8), stat = ierr)
      valuetemp = 0.0d0
      call checkerr(ierr,'valuetemp',ilog)
      call memory_monitor(sizeof(valuetemp),'valuetemp',.false.)
      
!cprovi-----------------------------------------
!c  output for maximum 120 species concentrations

!cmx        nxout = min(100-nc-1,nx)       !max. 100 species for output  
!cmx         100 is not enough for the example waybrant (isotope)

      nxout = min(1000-nc-1,nx)       !max. 120 species (nc+nx-1) for output

!c  define independent variable for output

      if(ph_sweep) then
        indep_var = 'pH'
        l_indep_var = 2
      else
        indep_var = 'time'
        l_indep_var = 4
      end if
  
!c  write out headers
 
!c  total aqueous component concentrations 
 
      if (ntstp.eq.0) then          !(ntstp.eq.0)
 
!c  --------------------------------------------------------------------- 
!c  file header for postprocessing using tecplot
!c  --------------------------------------------------------------------- 

        if (tec_header) then
          
          if (b_output_trans_binary) then
            allocate(tec_variables(1000+nc+nxout), stat = ierr)
            call checkerr(ierr,'tprfrtlc-tec_variables',ilog)
            tec_variables = ''
            call memory_monitor(sizeof(tec_variables),'tec_variables',.false.)
          end if

!c  total aqueous component concentrations
!c ----------------------------------------------------------------------

!c  file header
!c  version information
          if (.not. b_output_trans_binary) then
            b_rewind_valid = check_rewind_status(fibt)
          else
            b_rewind_valid = .false.
          end if

          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
              call writeversion2file(fibt, "#")
            end if
          end if
        
          if (b_output_trans_binary) then
            offset_bt = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         fibt, "#!TDV102",'dataset '//                 &
                         prefix(:l_prfx),offset_bt,.true.,.true.) 
            
            nvars = nc
            tec_variables(1) = indep_var(:l_indep_var)
            do ic = 1, nc-1
              tec_variables(ic+1) = namec(ic)(:l_namec(ic))
            end do

            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         fibt, nvars,tec_variables(1:nvars),           &
                         offset_bt,.true.,.true.)
          else if (b_use_tectitle) then
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(fibt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(fibt,'(1000a)') 'variables = "',                   &
                                      indep_var(:l_indep_var),'"',     &
                                    (',"',namec(ic)(:l_namec(ic)),     &
                                     '"',ic=1,nc-1)
            end if
          end if

!c  zone record

          if (ivolume.eq.0) then
            if (b_output_trans_binary) then  
              strbuffer = 'T_j, '//zone_name(:l_zone_name)
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(fibt,'(3a)')                                     &
                      'zone t = "T_j, ',                               &
                      zone_name(:l_zone_name),'", f=point'
              end if
            end if
          else
            if (b_output_trans_binary) then
#ifdef PETSC
              write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')              &
                    'T_j, local volume = ',ivolume,                    &
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    ', x = ',xg, ', y = ',yg,', z = ',zg
#else
              write(strbuffer,'(a,i0,3(a,1pe15.6e3))')                 &
                    'T_j, volume = ',ivolume,                          &
                    ', x = ',xg, ', y = ',yg,', z = ',zg
#endif
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
#ifdef PETSC
                write(fibt,'(a,2(a,i0),3(a,1pe15.6e3),a)')             &
                      'zone t = "T_j, ',                               &
                      'local volume = ',ivolume,                       &
                      ', global volume = ', node_idx_lg2g(ivolume),    &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                write(fibt,'(a,(a,i0),3(a,1pe15.6e3),a)')              &
                      'zone t = "T_j, ','volume = ',ivolume,           &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
              end if
            end if
          end if
          
          if (b_output_trans_binary) then
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,fibt,   &
                         trim(strbuffer),offset_bt, 1, 1, 1, .true.,   &
                         .true.,b_output_multizone)
            offset_bt_ijk = offset_bt - 5*4
            call tecplot_binary_write_section(PETSC_COMM_SELF,fibt,    &
                         nvars,0,offset_bt,.true.,.true.,              &
                         b_output_multizone) 
          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
!c  version information
            if (.not. b_output_trans_binary) then
              b_rewind_valid = check_rewind_status(fibre)
            else
              b_rewind_valid = .false.
            end if

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                call writeversion2file(fibre, "#")
              end if
            end if
        
            if (b_output_trans_binary) then
              offset_bre = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           fibre, "#!TDV102",'dataset '//              &
                           prefix(:l_prfx),offset_bre,.true.,.true.) 
              
              nvars = ngre_i+1
              tec_variables(1) = indep_var(:l_indep_var)
              do ingre = 1, ngre_i
                tec_variables(ingre+1) = trim(name_ngre_i(ingre))
              end do

              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           fibre, nvars,tec_variables(1:nvars),        &
                           offset_bre,.true.,.true.)
            else if (b_use_tectitle) then
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(fibre,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(fibre,'(1000a)') 'variables = "',                &
                                        indep_var(:l_indep_var),'"',   &
                                      (',"',trim(name_ngre_i(ingre)),  &
                                       '"',ingre=1,ngre_i)
              end if
            end if

!c  zone record

            if (ivolume.eq.0) then
              if (b_output_trans_binary) then  
                strbuffer = 'T_j, '//zone_name(:l_zone_name)
              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibre,'(3a)')                                  &
                        'zone t = "T_j, ',                             &
                        zone_name(:l_zone_name),'", f=point'
                end if
              end if
            else
              if (b_output_trans_binary) then
#ifdef PETSC
                write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')            &
                      'T_j, local volume = ',ivolume,                  &
                      ', global volume = ', node_idx_lg2g(ivolume),    &
                      ', x = ',xg, ', y = ',yg,', z = ',zg
#else
                write(strbuffer,'(a,i0,3(a,1pe15.6e3))')               &
                      'T_j, volume = ',ivolume,                        &
                      ', x = ',xg, ', y = ',yg,', z = ',zg
#endif
              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
#ifdef PETSC
                  write(fibre,'(a,2(a,i0),3(a,1pe15.6e3),a)')          &
                        'zone t = "T_j, ',                             &
                        'local volume = ',ivolume,                     &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibre,'(a,(a,i0),3(a,1pe15.6e3),a)')         &
                        'zone t = "T_j, ','volume = ',ivolume,         &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if
            end if
          
            if (b_output_trans_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,fibre, &
                           trim(strbuffer),offset_bre, 1, 1, 1, .true.,     &
                           .true.,b_output_multizone)
              offset_bre_ijk = offset_bre - 5*4
              call tecplot_binary_write_section(PETSC_COMM_SELF,fibre,  &
                           nvars,0,offset_bre,.true.,.true.,                &
                           b_output_multizone) 
            end if

          end if

 
          if (extended_output_gb) then
!c  species concentrations
!c ----------------------------------------------------------------------

!c  file header
!c  version information
            if (.not. b_output_trans_binary) then
              b_rewind_valid = check_rewind_status(fibc)
            else
              b_rewind_valid = .false.
            end if

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                call writeversion2file(fibc, "#")
              end if
            end if
          
            if (b_output_trans_binary) then
              offset_bc = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                             fibc, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bc,.true.,.true.)  
    
              nvars = nc + nxout 
              
              tec_variables(1) = indep_var(:l_indep_var)
              do ic=1,nc-1
                tec_variables(ic+1) = namec(ic)(:l_namec(ic))  
              end do
              do ix=1,nxout
                tec_variables(nc+ix) = namex(ix)(:l_namex(ix)) 
              end do
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           fibc,nvars,tec_variables(1:nvars),          &
                           offset_bc,.true.,.true.) 
            else if (b_use_tectitle) then
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(fibc,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(fibc,'(1000a)') 'variables = "',                 &
                                       indep_var(:l_indep_var),'"',    &
                                      (',"',namec(ic)(:l_namec(ic)),   &
                                      '"',ic=1,nc-1),                  &
                                      (',"',namex(ix)(:l_namex(ix)),   &
                                      '"',ix=1,nxout)
              end if
            end if

!c  zone record

            if (ivolume.eq.0) then
              if (b_output_trans_binary) then
                strbuffer = 'C_j, X_i, '//zone_name(:l_zone_name)              
              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibc,'(3a)')                                   &
                        'zone t = "C_j, X_i, ',                        &
                         zone_name(:l_zone_name),'", f=point'
                end if
              end if
            else
#ifdef PETSC
              if (b_output_trans_binary) then
                write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')            &
                      'C_j, X_i, local volume = ', ivolume,            &
                      ', global volume = ', node_idx_lg2g(ivolume),    &
                      ', x = ',xg, ', y = ',yg,', z = ',zg

              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibc,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                        'zone t = "C_j, X_i, local volume = ', ivolume,&
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                end if
              end if
#else
              if (b_output_trans_binary) then
                write(strbuffer,'((a,i0),3(a,1pe15.6e3))')             &
                      'C_j, X_i, volume = ',ivolume,                   &
                      ', x = ',xg, ', y = ',yg,', z = ',zg
              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibc,'((a,i0),3(a,1pe15.6e3),a)')              &
                        'zone t = "C_j, X_i, volume = ', ivolume,      &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                end if
              end if
#endif
            end if
          
            if (b_output_trans_binary) then
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,fibc, &
                           trim(strbuffer),offset_bc, 1, 1, 1,.true.,  &
                           .true.,b_output_multizone)
              offset_bc_ijk = offset_bc - 5*4
  
              call tecplot_binary_write_section(PETSC_COMM_SELF,fibc,  &
                           nvars,0,offset_bc,.true.,.true.,            &
                           b_output_multizone)
            end if
          
!c  activity coefficients
!c ----------------------------------------------------------------------
            if (b_output_activity) then
!c  file header
!c  version information
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibac)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibac, "#")
                end if
              end if
          
              if (b_output_trans_binary) then
                offset_bac = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                               fibac, "#!TDV102",'dataset '//          &
                               prefix(:l_prfx),offset_bac,.true.,.true.)  
              
                nvars = nc + nxout 
                
                tec_variables(1) = indep_var(:l_indep_var)
                do ic=1,nc-1
                  tec_variables(ic+1) = namec(ic)(:l_namec(ic))  
                end do
                do ix=1,nxout
                  tec_variables(nc+ix) = namex(ix)(:l_namex(ix)) 
                end do
                
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibac,nvars,tec_variables(1:nvars),       &
                             offset_bac,.true.,.true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibac,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                  write(fibac,'(1000a)') 'variables = "',              &
                                         indep_var(:l_indep_var),'"',  &
                                        (',"',namec(ic)(:l_namec(ic)), &
                                        '"',ic=1,nc-1),                &
                                        (',"',namex(ix)(:l_namex(ix)), &
                                        '"',ix=1,nxout)
                end if
              end if

!c  zone record

              if (ivolume.eq.0) then
                if (b_output_trans_binary) then
                  strbuffer = 'C_j, X_i, '//zone_name(:l_zone_name)              
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibac,'(3a)')                                &
                          'zone t = "C_j, X_i, ',                      &
                           zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'C_j, X_i, local volume = ', ivolume,          &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibac,'(2(a,i0),3(a,1pe15.6e3),a)')          &
                        'zone t = "C_j, X_i, local volume = ', ivolume,&
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else         
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'C_j, X_i, volume = ',ivolume,                 &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibac,'((a,i0),3(a,1pe15.6e3),a)')           &
                          'zone t = "C_j, X_i, volume = ',ivolume,     &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
          
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,fibac,&
                             trim(strbuffer),offset_bac, 1, 1, 1,.true., &
                             .true.,b_output_multizone)
                offset_bac_ijk = offset_bac - 5*4
              
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibac, &
                             nvars,0,offset_bac,.true.,.true.,           &
                             b_output_multizone)
              end if
            end if

!c  master variables
!c ----------------------------------------------------------------------
            if (ph_output .or. pe_output) then
!c  version information
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibm)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibm, "#")
                end if
              end if
          
!c  title and variables  
              if (b_output_trans_binary) then
                offset_bm = 0
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibm, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bm,.true.,.true.)
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibm,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                end if
              end if
            end if
          
            if ((ph_output).and.(pe_output)) then
              if (b_output_trans_binary) then
                nvars = 13
                !Tecplot binary output cannot allow the same variable name
                if (indep_var(:l_indep_var) == 'pH') then
                  tec_variables(1) = "pH_"
                else
                  tec_variables(1) = indep_var(:l_indep_var)
                end if
                tec_variables(2:13) = [character(len=72) ::              &
                                    "pH","pe","Eh","ionic strength",     &
                                    "C-Alk [eq/L]","NC-Alk [eq/L]",      &
                                    "Alk [eq/L]","C-Alk [mg/L CaCO_3]",  &
                                    "NC-Alk [mg/L CaCO_3]",              &
                                    "Alk [mg/L CaCO_3]","temperature",   &
                                    "charge bal [%]"] 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibm,'(10a)') 'variables = "',                   &
                                     indep_var(:l_indep_var),'",',       &
                                   '"pH","pe","Eh","ionic strength",',   &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                   '"NC-Alk [mg/L CaCO_3]",',            &
                                   '"Alk [mg/L CaCO_3]",',               &
                                   '"temperature",',                     &
                                   '"charge bal [%]"'
                end if
              end if
            elseif ((.not.ph_output).and.(pe_output)) then
              if (b_output_trans_binary) then
                nvars = 12
                tec_variables(1) = indep_var(:l_indep_var)
                tec_variables(2:12) = [character(len=72) ::              &
                                   "pe","Eh","ionic strength",           &
                                   "C-Alk [eq/L]","NC-Alk [eq/L]",       &
                                   "Alk [eq/L]","C-Alk [mg/L CaCO_3]",   &
                                   "NC-Alk [mg/L CaCO_3]",               &
                                   "Alk [mg/L CaCO_3]","temperature",    &
                                   "charge bal [%]"] 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibm,'(10a)') 'variables = "',                   &
                                      indep_var(:l_indep_var),'",',      &
                                   '"pe","Eh","ionic strength",',        &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                   '"NC-Alk [mg/L CaCO_3]",',            &
                                   '"Alk [mg/L CaCO_3]",',               &
                                   '"temperature",',                     &
                                   '"charge bal [%]"'
                end if
              end if
            elseif ((ph_output).and.(.not.pe_output)) then
              if (b_output_trans_binary) then
                nvars = 11
                !Tecplot binary output cannot allow the same variable name
                if (indep_var(:l_indep_var) == 'pH') then
                  tec_variables(1) = "pH_"
                else
                  tec_variables(1) = indep_var(:l_indep_var)
                end if
                tec_variables(2:11) = [character(len=72) ::              &
                                   "pH","ionic strength",                &
                                   "C-Alk [eq/L]","NC-Alk [eq/L]",       &
                                   "Alk [eq/L]","C-Alk [mg/L CaCO_3]",   &
                                   "NC-Alk [mg/L CaCO_3]",               &
                                   "Alk [mg/L CaCO_3]","temperature",    &
                                   "charge bal [%]"] 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibm,'(10a)') 'variables = "',                   &
                                      indep_var(:l_indep_var),'",',      &
                                   '"pH","ionic strength",',             &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',    &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",',&
                                   '"NC-Alk [mg/L CaCO_3]",',            &
                                   '"Alk [mg/L CaCO_3]",',               &
                                   '"temperature",',                     &
                                   '"charge bal [%]"'
                end if
              end if
            end if
          
            if (ph_output .or. pe_output) then

              if (b_output_trans_binary) then
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibm, nvars, tec_variables(1:nvars),      &
                             offset_bm, .true., .true.)
              end if

!c  zone record

              if (ivolume.eq.0) then
                if (b_output_trans_binary) then
                  strbuffer = 'Master variables, '//zone_name(:l_zone_name)
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibm,'(3a)')                                 &
                          'zone t = "Master variables, ',              &
                           zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                     'Master variables, local volume = ',ivolume,      &
                     ', global volume = ', node_idx_lg2g(ivolume),     &
                     ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibm,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                       'zone t = "Master variables, local volume = ',  &
                       ivolume,', global volume = ',                   &
                       node_idx_lg2g(ivolume),                         &
                       ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'Master variables, volume = ',ivolume,         &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibm,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "Master variables, volume = ',     &
                           ivolume,                                    &
                           ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if

              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,fibm,&
                             trim(strbuffer),offset_bm, 1, 1, 1, .true.,&
                             .true.,b_output_multizone)
                offset_bm_ijk = offset_bm - 5*4
  
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibm, &
                             nvars,0,offset_bm,.true.,.true.,           &
                             b_output_multizone)
              end if
          
            end if

!c  partial gas pressures
!c ----------------------------------------------------------------------

            if (ng.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibg)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibg, "#")
                end if
              end if
            
!c  file header  
              if (b_output_trans_binary) then
                offset_bg = 0
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibg, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bg,.true.,.true.)
                
                nvars = 2+ng
                tec_variables(1) = indep_var(:l_indep_var)
                do ig=1,ng
                  tec_variables(ig+1) = nameg(ig)(:l_nameg(ig))
                end do
                tec_variables(ng+2) = "p_t_o_t"
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibg, nvars, tec_variables(1:nvars),      &
                             offset_bg,.true.,.true.)
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibg,'(3a)') 'title = "dataset ',              &
                                        prefix(:l_prfx),'"'
                  write(fibg,'(1000a)') 'variables = "',               &
                                          indep_var(:l_indep_var),'"', &
                                     (',"',nameg(ig)(:l_nameg(ig)),    &
                                     '"',ig=1,ng),', "p_t_o_t"'
                end if
              end if

!c  zone record 

              if (ivolume.eq.0) then
                if (b_output_trans_binary) then
                  strbuffer = 'G_i, '//zone_name(:l_zone_name)
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibg,'(3a)') 'zone t = "G_i, ',              &
                                          zone_name(:l_zone_name),     &
                                         '", f=point'
                  end if
                end if
              else           
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'G_i, local volume = ', ivolume,               &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibg,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                          'zone t = "G_i, local volume = ', ivolume,   &
                          ', global volume = ', node_idx_lg2g(ivolume),&
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'G_i, volume = ', ivolume,                     &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibg,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "G_i, volume = ', ivolume,         &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibg,trim(strbuffer),offset_bg, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bg_ijk = offset_bg - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibg,&
                             nvars,0,offset_bg,.true.,.true.,          &
                             b_output_multizone)
              end if

!c  degassing rates
!c ----------------------------------------------------------------------

              if (gas_removal) then

                if (.not. b_output_trans_binary) then
                  b_rewind_valid = check_rewind_status(fibgr)
                else
                  b_rewind_valid = .false.
                end if

!c  version information
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                    call writeversion2file(fibgr, "#")
                  end if
                end if
              
!c  file header 
                if (b_output_trans_binary) then
                  offset_bx = 0  
                  call tecplot_binary_write_header(PETSC_COMM_SELF,    &
                               fibgr, "#!TDV102",'dataset '//          &
                               prefix(:l_prfx),offset_bx,.true.,.true.)  
                  
                  nvars = ng + 1
                  tec_variables(1) = indep_var(:l_indep_var)
                  do ig=1,ng
                    tec_variables(ig+1) = nameg(ig)(:l_nameg(ig))  
                  end do
                  
                  call tecplot_binary_write_variable(PETSC_COMM_SELF,  &
                               fibgr,nvars,tec_variables(1:nvars),     &
                               offset_bx,.true.,.true.) 
                else if (b_use_tectitle) then
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibgr,'(3a)') 'title = "dataset ',           &
                                          prefix(:l_prfx),'"'
                    write(fibgr,'(1000a)') 'variables = "',            &
                          indep_var(:l_indep_var),'"',                 &
                          (',"',nameg(ig)(:l_nameg(ig)),'"',ig=1,ng)
                  end if
                end if

!c  zone record

                if (ivolume.eq.0) then
                  if (b_output_trans_binary) then
                    strbuffer =  'R_i^g, '//zone_name(:l_zone_name)
                  else
                    if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                      write(fibgr,'(3a)') 'zone t = "R_i^g, ',         &
                                             zone_name(:l_zone_name),  &
                                            '", f=point'
                    end if
                  end if
                else
#ifdef PETSC    
                  if (b_output_trans_binary) then
                    write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')        &
                       'R_i^g, local volume = ', ivolume,              &
                       ', global volume = ', node_idx_lg2g(ivolume),   &
                       ', x = ',xg, ', y = ',yg,', z = ',zg
                  else
                    if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                      write(fibgr,'(2(a,i0),3(a,1pe15.6e3),a)')        &
                         'zone t = "R_i^g, local volume = ', ivolume,  &
                         ', global volume = ', node_idx_lg2g(ivolume), &
                         ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                    end if
                  end if
#else
                  if (b_output_trans_binary) then
                    write(strbuffer,'((a,i0),3(a,1pe15.6e3))')         &
                          'R_i^g, volume = ', ivolume,                 &
                          ', x = ',xg, ', y = ',yg,', z = ',zg
                  else
                    if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                      write(fibgr,'((a,i0),3(a,1pe15.6e3),a)')         &
                            'zone t = "R_i^g, volume = ', ivolume,     &
                            ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                    end if
                  end if
#endif
                end if
              
                if (b_output_trans_binary) then
                 call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,   &
                              fibgr,trim(strbuffer),offset_bx, 1, 1, 1,&
                              .true.,.true.,b_output_multizone)
                 offset_bgr_ijk = offset_bx - 5*4
                 
                 call tecplot_binary_write_section(PETSC_COMM_SELF,    &
                              fibgr,nvars,0,offset_bx,.true.,.true.,   &
                              b_output_multizone) 
                end if
              end if

            end if                  !(ng.gt.0)

!c  oxidation-reduction rates
!c ----------------------------------------------------------------------

            if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibi)
              else
                b_rewind_valid = .false.
              end if
            
!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibi, "#")
                end if
              end if
            
!c  file header 
              if (b_output_trans_binary) then
                offset_bgr = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibi, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bgr,.true.,.true.)  
    
                nvars = nr + 1
                tec_variables(1) = indep_var(:l_indep_var)
                do ir = 1, nr
                  tec_variables(ir+1) = namer(ir)(:l_namer(ir))
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibi,nvars,tec_variables(1:nvars),        &
                             offset_bgr,.true.,.true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibi,'(3a)') 'title = "dataset ',              &
                                        prefix(:l_prfx),'"'
                  write(fibi,'(1000a)') 'variables = "',               &
                                          indep_var(:l_indep_var),'"', &
                                     (',"',namer(ir)(:l_namer(ir)),'"',&
                                      ir=1,nr)
                end if
              end if
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer = 'hom. reaction rates, '//                &
                              zone_name(:l_zone_name) 
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibi,'(3a)')                                 &
                          'zone t = "hom. reaction rates, ',           &
                           zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else    
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i10),3(a,1pe15.6e3))')         &
                    'hom. reaction rates, local volume = ',ivolume,    &
                    ', global volume = ',node_idx_lg2g(ivolume),       &
                    ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibi,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                      'zone t = "hom. reaction rates, local volume = ',&
                      ivolume,', global volume = ',                    &
                      node_idx_lg2g(ivolume),                          &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'hom. reaction rates, volume = ', ivolume,     &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibi,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "hom. reaction rates, volume = ',  &
                          ivolume,                                     &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,     &
                             fibi,trim(strbuffer),offset_bgr, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bi_ijk = offset_bgr - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibi,&
                             nvars,0,offset_bgr,.true.,.true.,         &
                             b_output_multizone) 
              end if

            end if              !((nr.gt.0)....)

!c  rates of intra-aqueous kinetic reactions 
!c ----------------------------------------------------------------------

            if (naq.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibi)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibi, "#")
                end if
              end if
            
!c  file header 
              if (b_output_trans_binary) then
                offset_bgr = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibi, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bgr,.true.,.true.)  
                
                nvars = naq + 1
                tec_variables(1) = indep_var(:l_indep_var)
                do iaq=1,naq
                  tec_variables(iaq+1) = nameaq(iaq)(:l_nameaq(iaq))  
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibi, nvars, tec_variables(1:nvars),      &
                             offset_bgr, .true., .true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibi,'(3a)') 'title = "dataset ',              &
                                        prefix(:l_prfx),'"'
                  write(fibi,'(1000a)') 'variables = "',               &
                                        indep_var(:l_indep_var),'"',   &
                                     (',"',nameaq(iaq)(:l_nameaq(iaq)),&
                                     '"',iaq=1,naq)
                end if
              end if
                                                                       
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer =  'intra-aqueous reactions, ' //          &
                               zone_name(:l_zone_name) 
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                   write(fibi,'(3a)')                                  &
                         'zone t = "intra-aqueous reactions, ',        &
                          zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else  
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                    'intra-aqueous reactions, local volume = ',ivolume,&
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibi,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                    'zone t = "intra-aqueous reactions, local volume = ',&
                    ivolume,', global volume = ', node_idx_lg2g(ivolume),&
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'intra-aqueous reactions, volume = ',ivolume,  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibi,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "intra-aqueous reactions, volume = ',&
                           ivolume,                                      &
                           ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibi,trim(strbuffer),offset_bgr, 1, 1, 1, &
                             .true.,.true.,b_output_multizone)
                offset_bi_ijk = offset_bgr - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibi,&
                             nvars,0,offset_bgr,.true.,.true.,         &
                             b_output_multizone)
              end if

            end if              !(naq.gt.0....)

!c  concentrations of sorbed species
!c ----------------------------------------------------------------------

            if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibb)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibb, "#")
                end if
              end if
            
!c  file header 
              if (b_output_trans_binary) then
                offset_bi = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibb, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bi,.true.,.true.)  
    
                nvars = nanc+nsites+nsb_ion+nsb_surf+1
                
                tec_variables(1) = indep_var(:l_indep_var)
                do ianc=1,nanc
                  tec_variables(ianc+1) = nameanc(ianc)(:l_nameanc(ianc))  
                end do
                do isites=1,nsites
                  tec_variables(nanc+isites+1) =                       &
                      namec(iaic(isites))(:l_namec(iaic(isites)))
                end do
                do isb=1,nsb_ion
                  tec_variables(nanc+nsites+isb+1) =                   &
                      namesb_ion(isb)(:l_namesb_ion(isb))
                end do
                do isb=1,nsb_surf
                  tec_variables(nanc+nsites+nsb_ion+isb+1) =           &
                      namesb_surf(isb)(:l_namesb_surf(isb))
                end do
                
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibb, nvars, tec_variables(1:nvars),      &
                             offset_bi,.true.,.true.)
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibb,'(3a)') 'title = "dataset ',              &
                                       prefix(:l_prfx),'"'
                  write(fibb,'(1000a)') 'variables = "',               &
                        indep_var(:l_indep_var),'"',                   &
                        (',"',nameanc(ianc)                            &
                        (:l_nameanc(ianc)),                            &
                        '"',ianc=1,nanc),                              &
                        (',"',namec(iaic(isites))                      &
                        (:l_namec(iaic(isites))),                      &
                        '"',isites=1,nsites),                          &
                        (',"',namesb_ion(isb)(:l_namesb_ion(isb)),     &
                        '"',isb=1,nsb_ion),                            &
                        (',"',namesb_surf(isb)(:l_namesb_surf(isb)),   &
                        '"',isb=1,nsb_surf)
                end if
              end if
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer = 'S_i, ' // zone_name(:l_zone_name) 
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibb,'(3a)')                                 &
                          'zone t = "S_i, ',                           &
                           zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else      
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'S_i, local volume = ', ivolume,               &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibb,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                          'zone t = "S_i, local volume = ', ivolume,   &
                          ', global volume = ', node_idx_lg2g(ivolume),&
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'S_i, volume = ',ivolume,                      &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibb,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "S_i, volume = ',ivolume,          &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibb,trim(strbuffer),offset_bi, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bb_ijk = offset_bi - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibb,&
                             nvars,0,offset_bi,.true.,.true.,          &
                             b_output_multizone)
              end if

            end if

!c  mineral saturation indices
!c ----------------------------------------------------------------------

            if (nm.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibs)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibs, "#")
                end if
              end if
            
!c  file header
              if (b_output_trans_binary) then
                offset_bb = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibs, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bb,.true.,.true.)  
    
                nvars = nm+1
                tec_variables(1) = indep_var(:l_indep_var)
                do im=1,nm
                  tec_variables(im+1) = namem(im)(:l_namem(im))  
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibs, nvars, tec_variables(1:nvars),      &
                             offset_bb, .true., .true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibs,'(3a)') 'title = "dataset ',              &
                                       prefix(:l_prfx),'"'
                  write(fibs,'(1000a)') 'variables = "',               &
                                        indep_var(:l_indep_var),'"',   &
                                     (',"',namem(im)(:l_namem(im)),    &
                                     '"',im=1,nm)
                end if
              end if
                                                                      
!c  zone record for initial condition
                                                                       
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer = 'SI, ' // zone_name(:l_zone_name)
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibs,'(3a)')                                 &
                          'zone t = "SI, ',                            &
                          zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else      
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'SI, local volume = ',ivolume,                 &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibs,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                          'zone t = "SI, local volume = ',ivolume,     &
                          ', global volume = ', node_idx_lg2g(ivolume),&
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'SI, volume = ',ivolume,                       &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibs,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "SI, volume = ', ivolume,          &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibs,trim(strbuffer),offset_bb, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bs_ijk = offset_bb - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibs,&
                             nvars,0,offset_bb,.true.,.true.,          &
                             b_output_multizone)
              end if
   
!c  mineral volume fractions
!c ----------------------------------------------------------------------
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibv)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibv, "#")
                end if
              end if

!c  file header
              if (b_output_trans_binary) then
                offset_bs = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibv, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bs,.true.,.true.)  
    
                nvars = nm+2
                tec_variables(1) = indep_var(:l_indep_var)
                do im=1,nm
                  tec_variables(im+1) = namem(im)(:l_namem(im))  
                end do
                tec_variables(nm+2) = 'porosity'
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibv, nvars,tec_variables(1:nvars),       &
                             offset_bs,.true.,.true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibv,'(3a)') 'title = "dataset ',              &
                                       prefix(:l_prfx),'"'
                  write(fibv,'(1000a)') 'variables = "',               &
                                          indep_var(:l_indep_var),'"', &
                                       (',"',namem(im)(:l_namem(im)),  &
                                        '"',im=1,nm),',"porosity"'
                end if
              end if                                                          
!c  zone record
                                                                       
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer = 'phi_i, '//zone_name(:l_zone_name) 
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibv,'(3a)') 'zone t = "phi_i, ',            &
                                          zone_name(:l_zone_name),     &
                                         '", f=point'
                  end if
                end if
              else  
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'phi_i, local volume = ', ivolume,             &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibv,'(2(a,i0),3(a,1pe15.6e3),a)')           &
                          'zone t = "phi_i, local volume = ', ivolume, &
                          ', global volume = ', node_idx_lg2g(ivolume),&
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'phi_i, volume = ',ivolume,                    &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibv,'((a,i0),3(a,1pe15.6e3),a)')            &
                          'zone t = "phi_i, volume = ', ivolume,       &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibv,trim(strbuffer),offset_bs, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bv_ijk = offset_bs - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibv,&
                             nvars,0,offset_bs,.true.,.true.,          &
                             b_output_multizone)
              end if

!c  mineral dissolution-precipitation rates
!c ----------------------------------------------------------------------
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibd)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibd, "#")
                end if
              end if
            
!c  file header 
              if (b_output_trans_binary) then
                offset_bv = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibd, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bv,.true.,.true.)  
                
                istart = iamd(1)                                          
                istop = iamd(nm+1)-1 
                nvars = istop-istart+2
                tec_variables(1) = indep_var(:l_indep_var)
                do ireac=istart,istop 
                  tec_variables(ireac+1) = namemp(ireac)(:l_namemp(ireac))  
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibd,nvars,tec_variables(1:nvars),        &
                             offset_bv,.true.,.true.) 
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibd,'(3a)') 'title = "dataset ',              &
                                       prefix(:l_prfx),'"'
                  istart = iamd(1)
                  istop = iamd(nm+1)-1
                  write(fibd,'(1000a)') 'variables = "',               &
                               indep_var(:l_indep_var),'"',            &
                               (',"',namemp(ireac)(:l_namemp(ireac)),  &
                               '"',ireac=istart,istop)
                end if
              end if
                                                                      
!c  zone record                                                                      
              if (ivolume.eq.0) then 
                if (b_output_trans_binary) then
                  strbuffer = 'Diss.-prec. rates, '//                  &
                              zone_name(:l_zone_name)  
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibd,'(3a)')                                 &
                          'zone t = "Diss.-prec. rates, ',             &
                          zone_name(:l_zone_name),'", f=point'
                  end if
                end if
              else    
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'Diss.-prec. rates, volume = ',ivolume,        &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibd,'(a,2(a,i0),3(a,1pe15.6e3),a)')         &
                          'zone t = "Diss.-prec. rates, ',             &
                          'volume = ',ivolume, ', global volume = ',   &
                          node_idx_lg2g(ivolume),                      &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'Diss.-prec. rates, volume = ',ivolume,        &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibd,'(2a,i0,3(a,1pe15.6e3),a)')             &
                          'zone t = "Diss.-prec. rates, ',             &
                          'volume = ',ivolume,                         &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibd,trim(strbuffer),offset_bv, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bd_ijk = offset_bv - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,fibd,&
                             nvars,0,offset_bv,.true.,.true.,          &
                             b_output_multizone) 
              end if

            end if                  !(nm.gt.0)

!c  saturation indices (excluded minerals)
!c ----------------------------------------------------------------------

            if (nmx.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibx)
              else
                b_rewind_valid = .false.
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibx, "#")
                end if
              end if
            
!c  file header
              if (b_output_trans_binary) then
                offset_bd = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibx, "#!TDV102",'dataset '//             &
                             prefix(:l_prfx),offset_bd,.true.,.true.)  
    
                nvars = nmx+1
                tec_variables(1) = indep_var(:l_indep_var)
                do imx=1,nmx
                  tec_variables(imx+1) = namemx(imx)(:l_namemx(imx))  
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                             fibx, nvars,tec_variables(1:nvars),       &
                             offset_bd,.true.,.true.)
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibx,'(3a)') 'title = "dataset ',              &
                                         prefix(:l_prfx),'"'
                  write(fibx,'(1000a)') 'variables = "',               &
                        indep_var(:l_indep_var),'"',                   &
                        (',"',namemx(imx)(:l_namemx(imx)),'"',         &
                        imx=1,nmx)
                end if
              end if
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then
                if (b_output_trans_binary) then
                  strbuffer = 'SI, '//zone_name(:l_zone_name) 
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibx,'(3a)') 'zone t = "SI, ',            &
                                          zone_name(:l_zone_name),     &
                                         '", f=point'
                  end if
                end if
              else      
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                        'SI, local volume = ',ivolume,                 &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibx,'(a,2(a,i0),3(a,1pe15.6e3),a)')         &
                          'zone t = "SI, ', 'local volume = ',ivolume, &
                          ', global volume = ',node_idx_lg2g(ivolume), &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'((a,i0),3(a,1pe15.6e3))')           &
                        'SI, volume = ',ivolume,                       &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibx,'(2a,i0,3(a,1pe15.6e3),a)')             &
                          'zone t = "SI, ','volume = ',ivolume,        &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibx,trim(strbuffer),offset_bd, 1, 1, 1,  &
                             .true.,.true.,b_output_multizone)
                offset_bx_ijk = offset_bd - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,     &
                             fibx,nvars,0,offset_bd,.true.,.true.,     &
                             b_output_multizone) 
              end if

            end if                  !(nmx.gt.0) 
          
!c_isotope
!c ----------------------------------------------------------------------

            if (iso_output) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibis)
              else
                b_rewind_valid = .false.
              end if
              
!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibis, "#")
                end if
              end if
            
!c  file header
              i1 = 0
              do i=1,nip
                istart = iamdisoo(i)
                istop = iamdisoo(i+1)-1
                do i2 = istart, istop
                  ic2 = jamdisoo(i2)
                  i1 = i1 +1
                  nametemp(i1) = namec(ic2)
                  l_nametemp(i1) = index(nametemp(i1),' ')-1
                end do
                i1 = i1 +1
                ic2 = jamdisoo(istart)
                nametemp(i1) = 'sum_'//namec(ic2)
                l_nametemp(i1) = index(nametemp(i1),' ')-1
                
                istart = iamdisoo(i)
                istop = iamdisoo(i+1)-1
                do i2 = istart+1, istop
                  ic2 = jamdisoo(i2)
                  i1 = i1 +1 
                  nametemp(i1) = 'delta_'//namec(ic2)
                  l_nametemp(i1) = index(nametemp(i1),' ')-1
                end do
              end do
            
              nvars = i1 + 1
            
              if (b_output_trans_binary) then
                offset_bis = 0  
                call tecplot_binary_write_header(PETSC_COMM_SELF,      &
                             fibis, "#!TDV102",'dataset '//            &
                             prefix(:l_prfx),offset_bis,.true.,.true.)  
    
                tec_variables(1) = indep_var(:l_indep_var)
                do imi=1,i1
                  tec_variables(imi+1) = nametemp(imi)(:l_nametemp(imi))
                end do
  
                call tecplot_binary_write_variable(PETSC_COMM_SELF,    &
                           fibis,nvars,tec_variables(1:nvars),         &
                           offset_bis,.true.,.true.)
              else if (b_use_tectitle) then
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(fibis,'(3a)') 'title = "dataset ',             &
                                        prefix(:l_prfx),'"'
  
                  write(fibis,'(1000a)') 'variables = "',              &
                        indep_var(:l_indep_var),'"',                   &
                        (',"',nametemp(imi)(:l_nametemp(imi)),'"',imi=1,i1)
                end if
              end if
                                                                        
              if (ivolume.eq.0) then  
                if (b_output_trans_binary) then
                  strbuffer = 'SI, '//zone_name(:l_zone_name) 
                else 
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibis,'(3a)') 'zone t = "Isotopes, ',        &
                                          zone_name(:l_zone_name),     &
                                         '", f=point'
                  end if
                end if
              else  
#ifdef PETSC
                if (b_output_trans_binary) then
                  write(strbuffer,'(2(a,i0),3(a,1pe15.6e3))')          &
                       'Isotopes, local volume = ',ivolume,            &
                       ', global volume = ', node_idx_lg2g(ivolume),   &
                       ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibis,'(a,2(a,i0),3(a,1pe15.6e3),a)')        &
                          'zone t = "Isotopes, ','local volume = ',    &
                          ivolume, ', global volume = ',               &
                          node_idx_lg2g(ivolume),                      &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#else
                if (b_output_trans_binary) then
                  write(strbuffer,'(a,i0,3(a,1pe15.6e3))')             &
                        'Isotopes, volume = ',ivolume,                 &
                        ', x = ',xg, ', y = ',yg,', z = ',zg
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(fibis,'(2a,i0,3(a,1pe15.6e3),a)')            &
                          'zone t = "Isotopes, ','volume = ',ivolume,  &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                  end if
                end if
#endif 
              end if
            
              if (b_output_trans_binary) then
                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,    &
                             fibis,trim(strbuffer),offset_bis, 1, 1, 1,&
                             .true.,.true.,b_output_multizone)
                offset_bis_ijk = offset_bis - 5*4
                
                call tecplot_binary_write_section(PETSC_COMM_SELF,     &
                             fibis,nvars,0,offset_bis,.true.,.true.,   &
                             b_output_multizone) 
              end if
           
            end if
          
            if (b_output_trans_binary) then
              call memory_monitor(-sizeof(tec_variables),'tec_variables',.false.)
              deallocate(tec_variables)
            end if
          end if                  !(extended_output_gb)

        else                      !(tec_header)

!c  --------------------------------------------------------------------- 
!c  file header for postprocessing using xmgr - convertible to tecplot
!c  --------------------------------------------------------------------- 

!c  total aqueous component concentrations
!c ----------------------------------------------------------------------
          if (.not. b_output_trans_binary) then
            b_rewind_valid = check_rewind_status(fibt)
          else
            b_rewind_valid = .false.
          end if

          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
            if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
              call writeversion2file(fibt, "#")
            end if
          
!c  file header
            write(fibt,'(3a)') '# title = "dataset ',                  &
                                 prefix(:l_prfx),'"'
            write(fibt,'(1000a)') '# variables = "',                   &
                                  indep_var(:l_indep_var),'"',         &
                                (',"',namec(ic)(:l_namec(ic)),         &
                                '"',ic=1,nc-1)
                                                                      
!c  zone record
                                                                       
            if (ivolume.eq.0) then
              write(fibt,'(3a)')                                       &
                    '# zone t = "T_j, ',zone_name(:l_zone_name),       &
                    '", f=point'
            else
#ifdef PETSC
              write(fibt,'(2(a,i0),3(a,1pe15.6e3),a)')                 &
                    '# zone t = "T_j, local volume = ',ivolume,        &
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
              write(fibt,'(a,i0,3(a,1pe15.6e3),a)')                    &
                    '# zone t = "T_j, volume = ',ivolume,              &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
            end if

          end if

!cdsu concentration of radioelement related to noble gas ingrowth
          if (b_use_ngi .and. ngre_i > 0) then
            if (.not. b_output_trans_binary) then
              b_rewind_valid = check_rewind_status(fibre)
            else
              b_rewind_valid = .false.
            end if

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
              if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                call writeversion2file(fibre, "#")
              end if
          
!c  file header
              write(fibre,'(3a)') '# title = "dataset ',               &
                                   prefix(:l_prfx),'"'
              write(fibre,'(1000a)') '# variables = "',                &
                                    indep_var(:l_indep_var),'"',       &
                                  (',"',trim(name_ngre_i(ingre)),      &
                                  '"',ingre=1,ngre_i)
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then
                write(fibre,'(3a)')                                    &
                      '# zone t = "T_j, ',zone_name(:l_zone_name),     &
                      '", f=point'
              else
#ifdef PETSC
                write(fibre,'(2(a,i0),3(a,1pe15.6e3),a)')              &
                      '# zone t = "T_j, local volume = ',ivolume,      &
                      ', global volume = ', node_idx_lg2g(ivolume),    &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                write(fibre,'(a,i0,3(a,1pe15.6e3),a)')                 &
                      '# zone t = "T_j, volume = ',ivolume,            &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
              end if

            end if
          end if

 
          if (extended_output_gb) then
!c  species concentrations
!c ----------------------------------------------------------------------
            if (.not. b_output_trans_binary) then
              b_rewind_valid = check_rewind_status(fibc)
            else
              b_rewind_valid = .false.
            end if

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
              if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                call writeversion2file(fibc, "#")
              end if
          
!c  file header          
              write(fibc,'(3a)') '# title = "dataset ',                &
                                   prefix(:l_prfx),'"'
              write(fibc,'(1000a)') '# variables = "',                 &
                                   indep_var(:l_indep_var),'"',        &
                                  (',"',namec(ic)(:l_namec(ic)),'"',   &
                                  ic=1,nc-1),                          &
                                  (',"',namex(ix)(:l_namex(ix)),'"',   &
                                  ix=1,nxout)
                                                                      
!c  zone record
                                                                       
              if (ivolume.eq.0) then
                write(fibc,'(3a)')                                     &
                      '# zone t = "C_j, X_i, ',                        &
                       zone_name(:l_zone_name),'", f=point'
              else
#ifdef PETSC
                write(fibc,'(2(a,i0),3(a,1pe15.6e3),a)')               &
                  '# zone t = "C_j, X_i, local volume = ',ivolume,     &
                  ', global volume = ', node_idx_lg2g(ivolume),        &
                  ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                write(fibc,'((a,i0),3(a,1pe15.6e3),a)')                &
                      '# zone t = "C_j, X_i, volume = ',ivolume,       &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
              end if
            end if
          
!c  activity coefficients
            if (b_output_activity) then
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibac)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c ----------------------------------------------------------------------
!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibac, "#")
                end if
          
!c  file header          
                write(fibac,'(3a)') '# title = "dataset ',             &
                                      prefix(:l_prfx),'"'
                write(fibac,'(1000a)') '# variables = "',              &
                                 indep_var(:l_indep_var),'"',          &
                                (',"',namec(ic)(:l_namec(ic)),'"',     &
                                ic=1,nc-1),                            &
                                (',"',namex(ix)(:l_namex(ix)),'"',     &
                                ix=1,nxout)
                                                                       
!c  zone record                                                        
                                                                         
                if (ivolume.eq.0) then
                  write(fibac,'(3a)')                                  &
                        '# zone t = "C_j, X_i, ',                      &
                         zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibac,'(2(a,i0),3(a,1pe15.6e3),a)')            &
                    '# zone t = "C_j, X_i, local volume = ',ivolume,   &
                    ', global volume = ', node_idx_lg2g(ivolume),      &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else                                                                  
                  write(fibac,'((a,i0),3(a,1pe15.6e3),a)')             &
                      '# zone t = "C_j, X_i, volume = ',ivolume,       &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if
            end if      !c activity coefficients

!c  master variables
!c ----------------------------------------------------------------------
            if (.not. b_output_trans_binary) then
              b_rewind_valid = check_rewind_status(fibm)
            else
              b_rewind_valid = .false.
            end if

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
              if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                call writeversion2file(fibm, "#")
              end if
          
!c  title and variables          
              write(fibm,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
              if ((ph_output).and.(pe_output)) then
                write(fibm,'(10a)') '# variables = "',                    &
                                      indep_var(:l_indep_var),'",',       &
                                   '"pH","pe","Eh","ionic strength",',    &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
                                   '"NC-Alk [mg/L CaCO_3]",',             &
                                   '"Alk [mg/L CaCO_3]",',                &
                                   '"temperature",',                      &
                                   '"charge bal [%]"'
              elseif ((.not.ph_output).and.(pe_output)) then
                write(fibm,'(10a)') '# variables = "',                    &
                                      indep_var(:l_indep_var),'",',       &
                                   '"pe","Eh","ionic strength",',         &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
                                   '"NC-Alk [mg/L CaCO_3]",',             &
                                   '"Alk [mg/L CaCO_3]",',                &
                                   '"temperature",',                      &
                                   '"charge bal [%]"'
              elseif ((ph_output).and.(.not.pe_output)) then
                write(fibm,'(10a)') '# variables = "',                    &
                                      indep_var(:l_indep_var),'",',       &
                                   '"pH","ionic strength", ',             &
                                   '"C-Alk [eq/L]","NC-Alk [eq/L]",',     &
                                   '"Alk [eq/L]","C-Alk [mg/L CaCO_3]",', &
                                   '"NC-Alk [mg/L CaCO_3]",',             &
                                   '"Alk [mg/L CaCO_3]",',                &
                                   '"temperature",',                      &
                                   '"charge bal [%]"'
              end if

!c  zone record

              if (ivolume.eq.0) then
                write(fibm,'(3a)')                                     &
                      '# zone t = "Master variables, ',                &
                       zone_name(:l_zone_name),'", f=point'
              else
#ifdef PETSC
                write(fibm,'(2(a,i0),3(a,1pe15.6e3),a)')               &
                      '# zone t = "Master variables, local volume = ', &
                      ivolume,', global volume = ',                    &
                      node_idx_lg2g(ivolume),                          &
                      ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                write(fibm,'((a,i0),3(a,1pe15.6e3),a)')                &
                    '# zone t = "Master variables, volume = ',ivolume, &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
              end if
            end if

!c  partial gas pressures
!c ----------------------------------------------------------------------

            if (ng.ne.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibg)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibg, "#")
                end if
            
!c  file header          
                write(fibg,'(3a)') '# title = "dataset ',              &
                                      prefix(:l_prfx),'"'
                write(fibg,'(1000a)') '# variables = "',               &
                                        indep_var(:l_indep_var),'"',   &
                                   (',"',nameg(ig)(:l_nameg(ig)),'"',  &
                                    ig=1,ng),', "p_t_o_t"'

!c  zone record 
                                                                       
                if (ivolume.eq.0) then
                  write(fibg,'(3a)')                                   &
                        '# zone t = "G_i, ',                           &
                         zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibg,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                        '# zone t = "G_i, local volume = ', ivolume,   &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibg,'((a,i0),3(a,1pe15.6e3),a)')              &
                        '# zone t = "G_i, volume = ', ivolume,         &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if
!c  degassing rates
!c ----------------------------------------------------------------------

              if (gas_removal) then

                if (.not. b_output_trans_binary) then
                  b_rewind_valid = check_rewind_status(fibgr)
                else
                  b_rewind_valid = .false.
                end if

                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
                  if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                    call writeversion2file(fibgr, "#")
                  end if
              
!c  file header          
                  write(fibgr,'(3a)') '# title = "dataset ',         &
                                         prefix(:l_prfx),'"'
                  write(fibgr,'(1000a)') '# variables = "',          &
                                         indep_var(:l_indep_var),'"',  &
                                    (',"',nameg(ig)(:l_nameg(ig)),'"', &
                                     ig=1,ng)

!c  zone record
                                                                       
                  if (ivolume.eq.0) then
                    write(fibgr,'(3a)')                                &
                          '# zone t = "R_i^g, ',                       &
                           zone_name(:l_zone_name),'", f=point'
                  else
#ifdef PETSC
                    write(fibgr,'(2(a,i0),3(a,1pe15.6e3),a)')          &
                          '# zone t = "R_i^g, local volume = ',ivolume,&
                          ', global volume = ', node_idx_lg2g(ivolume),&
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                    write(fibgr,'((a,i0),3(a,1pe15.6e3),a)')           &
                          '# zone t = "R_i^g, volume = ',ivolume,      &
                          ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                  end if

                end if

              end if                !(gas_removal)

            end if                  !(ng.eq.0)

!c  oxidation-reduction rates
!c ----------------------------------------------------------------------

            if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then
            
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibi)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibi, "#")
                end if
            
!c  file header          
                write(fibi,'(3a)') '# title = "dataset ',            &
                                      prefix(:l_prfx),'"'
                write(fibi,'(1000a)') '# variables = "',             &
                                        indep_var(:l_indep_var),'"',   &
                                   (',"',namer(ir)(:l_namer(ir)),      &
                                    ir=1,nr)
                                                                      
!c  zone record
                                                                       
                if (ivolume.eq.0) then
                  write(fibi,'(3a)')                                 &
                        '# zone t = "hom. reaction rates, ',           &
                         zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibi,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                    '# zone t = "hom. reaction rates, local volume = ',&
                    ivolume,', global volume = ',                      &
                    node_idx_lg2g(ivolume),                            &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibi,'((a,i0),3(a,1pe15.6e3),a)')              &
                        '# zone t = "hom. reaction rates, volume = ',  &
                         ivolume,                                      &
                         ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if

            end if              !((nr.gt.0)....)

!c  rates of intra-aqueous kinetic reactions
!c ----------------------------------------------------------------------

            if (naq.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibi)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibi, "#")
                end if
            
!c  file header          
                write(fibi,'(3a)') '# title = "dataset ',              &
                                      prefix(:l_prfx),'"'
                write(fibi,'(1000a)') '# variables = "',               &
                                        indep_var(:l_indep_var),'"',   &
                                   (',"',nameaq(iaq)(:l_nameaq(iaq)),  &
                                    iaq=1,naq)
                                                                      
!c  zone record
                                                                       
                if (ivolume.eq.0) then
                  write(fibi,'(3a)')                                   &
                        '# zone t = "intra-aqueous reactions, ',       &
                         zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibi,'(2(a,i0),3(a,1pe15.6e3),a)')                 &
                    '# zone t = "intra-aqueous reactions, local volume = ',&
                    ivolume,', global volume = ', node_idx_lg2g(ivolume),  &
                    ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibi,'((a,i0),3(a,1pe15.6e3),a)')                &
                        '# zone t = "intra-aqueous reactions, volume = ',&
                         ivolume,                                        &
                         ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if

            end if              !(naq.gt.0)

!c  concentrations of sorbed species
!c ----------------------------------------------------------------------

            if (nsb_ion.gt.0.or.nsb_surf.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibb)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibb, "#")
                end if
            
!c  file header          
                write(fibb,'(3a)') '# title = "dataset ',              &
                                     prefix(:l_prfx),'"'
                write(fibb,'(1000a)') '# variables = "',               &
                       indep_var(:l_indep_var),'"',                    &
                     (',"',nameanc(ianc)                               &
                     (:l_nameanc(ianc)),                               &
                     '"',ianc=1,nanc),                                 &
                    (',"',namec(iaic(isites))                          &
                    (:l_namec(iaic(isites))),'"',                      &
                     isites=1,nsites),                                 &
                    (',"',namesb_ion(isb)(:l_namesb_ion(isb)),'"',     &
                     isb=1,nsb_ion),                                   &
                    (',"',namesb_surf(isb)(:l_namesb_surf(isb)),'"',   &
                     isb=1,nsb_surf)
                                                                       
!c  zone record
                                                                        
                if (ivolume.eq.0) then
                  write(fibb,'(3a)')                                   &
                        '# zone t = "S_i, ',                           &
                        zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibb,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                        '# zone t = "S_i, local volume = ', ivolume,   &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibb,'((a,i0),3(a,1pe15.6e3),a)')              &
                        '# zone t = "S_i, volume = ',ivolume,          &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if

            end if

!c  mineral saturation indices
!c ----------------------------------------------------------------------

            if (nm.gt.0) then

              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibs)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibs, "#")
                end if
            
!c  file header          
                write(fibs,'(3a)') '# title = "dataset ',              &
                                     prefix(:l_prfx),'"'
                write(fibs,'(1000a)') '# variables = "',               &
                                      indep_var(:l_indep_var),'"',     &
                                   (',"',namem(im)(:l_namem(im)),'"',  &
                                    im=1,nm)
                                                                       
!c  zone record for initial condition
                                                                        
                if (ivolume.eq.0) then
                  write(fibs,'(3a)')                                   &
                        '# zone t = "SI, ',                            &
                        zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibs,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                        '# zone t = "SI, local volume = ', ivolume,    &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibs,'((a,i0),3(a,1pe15.6e3),a)')              &
                        '# zone t = "SI, volume = ', ivolume,          &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if
   
!c  mineral volume fractions
!c ----------------------------------------------------------------------
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibv)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibv, "#")
                end if
            
!c  file header          
                write(fibv,'(3a)') '# title = "dataset ',              &
                                     prefix(:l_prfx),'"'
                write(fibv,'(1000a)') '# variables = "',               &
                                        indep_var(:l_indep_var),'"',   &
                                     (',"',namem(im)(:l_namem(im)),'"',&
                                      im=1,nm),',"porosity"'
                                                                       
!c  zone record
                                                                        
                if (ivolume.eq.0) then
                  write(fibv,'(3a)')                                   &
                        '# zone t = "phi_i, ',                         &
                        zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibv,'(2(a,i0),3(a,1pe15.6e3),a)')             &
                        '# zone t = "phi_i, local volume = ', ivolume, &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibv,'((a,i0),3(a,1pe15.6e3),a)')              &
                        '# zone t = "phi_i, volume = ', ivolume,       &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if

!c  mineral dissolution-precipitation rates
!c ----------------------------------------------------------------------
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibd)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibd, "#")
                end if
            
!c  file header          
                write(fibd,'(3a)') '# title = "dataset ',              &
                                     prefix(:l_prfx),'"'
                istart = iamd(1)
                istop = iamd(nm+1)-1
                write(fibd,'(1000a)') '# variables = "',               &
                                    indep_var(:l_indep_var),'"',       &
                                 (',"',namemp(ireac)(:l_namemp(ireac)),&
                                  '"',ireac=istart,istop)
                                                                       
!c  zone record
                                                                        
                if (ivolume.eq.0) then
                  write(fibd,'(3a)')                                   &
                        '# zone t = "Diss.-prec. rates, ',             &
                        zone_name(:l_zone_name),'", f=point'
                else
#ifdef PETSC
                  write(fibd,'(a,2(a,i0),3(a,1pe15.6e3),a)')           &
                        '# zone t = "Diss.-prec. rates, ',             &
                        'local volume = ',ivolume,                     &
                        ', global volume = ', node_idx_lg2g(ivolume),  &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#else
                  write(fibd,'(a,(a,i0),3(a,1pe15.6e3),a)')            &
                        '# zone t = "Diss.-prec. rates, ',             &
                        'volume = ',ivolume,                           &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
#endif
                end if
              end if
            end if                  !(nm.gt.0)

!c  saturation indices (excluded minerals)
!c ----------------------------------------------------------------------

            if (nmx.gt.0) then
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibx)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibx, "#")
                end if
            
!c  file header          
                write(fibx,'(3a)') '# title = "dataset ',              &
                                      prefix(:l_prfx),'"'
                write(fibx,'(1000a)') '# variables = "',               &
                                     indep_var(:l_indep_var),'"',      &
                                 (',"',namemx(imx)(:l_namemx(imx)),'"',&
                                  imx=1,nmx)
                                                                        
!c  zone record
                                                                         
                if (ivolume.eq.0) then
                  write(fibx,'(3a)')                                   &
                        '# zone t = "SI, ',zone_name(:l_zone_name),    &
                        '", f=point'
                else
                  write(fibx,'(a,i0,3(a,1pe15.6e3),a)')                &
                        '# zone t = "SI, volume = ',ivolume,           &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                end if
              end if
            end if                  !(nmx.gt.0)
          
!c  isotope
            if (iso_output) then
              if (.not. b_output_trans_binary) then
                b_rewind_valid = check_rewind_status(fibis)
              else
                b_rewind_valid = .false.
              end if

              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
!c  version information
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(fibis, "#")
                end if
            
                i1 = 0
                do i=1,nip
                  istart = iamdisoo(i)
                  istop = iamdisoo(i+1)-1
                  do i2 = istart, istop
                    ic2 = jamdisoo(i2)
                    i1 = i1 +1
                    nametemp(i1) = namec(ic2)
                    l_nametemp(i1) = index(nametemp(i1),' ')-1
                  end do
                  i1 = i1 +1
                  ic2 = jamdisoo(istart)
                  nametemp(i1) = 'sum_'//namec(ic2)
                  l_nametemp(i1) = index(nametemp(i1),' ')-1

                  istart = iamdisoo(i)
                  istop = iamdisoo(i+1)-1
                  do i2 = istart+1, istop
                      ic2 = jamdisoo(i2)
                      i1 = i1 +1
                      nametemp(i1) = 'delta_'//namec(ic2)
                    l_nametemp(i1) = index(nametemp(i1),' ')-1
                  end do
                end do
            
!c  file header 
                write(fibis,'(3a)') '# title = "dataset ',             &
                                      prefix(:l_prfx),'"'

                write(fibis,'(1000a)') '# variables = "',              &
                    indep_var(:l_indep_var),'"',                       &
                    (',"',nametemp(imi)(:l_nametemp(imi)),'"',imi=1,i1)

                if (ivolume.eq.0) then
                  write(fibis,'(3a)')                                  &
                        '# zone t = "Isotopes, ',                      &
                        zone_name(:l_zone_name),'", f=point'
                else
                  write(fibis,'(a,i0,3(a,1pe15.6e3),a,a)')             &
                        '# zone t = "Isotopes, volume = ',ivolume,     &
                        ', x = ',xg, ', y = ',yg,', z = ',zg, '", f=point'
                end if
              end if
            end if
          end if                  !(extended_output_gb)
        end if                    !(tec_header)
      end if                      !(ntstp.eq.0)

!c  skip transient data output
      if (ngb_step /= ngb_step_bk) then
        return
      end if

!c  update secondary variables before print-out
      call updtsvap(c,cx,gammac,gammax,strion,tid)
  
!c  total aqueous component concentrations  
      call totconc(c,cx,totc)

      !c  print out results of current time step

      if (b_output_trans_binary) then
        nvars = nc
        realbuffer_gb(1:nvars) =  (/time,(totc(ic),ic=1,nc-1)/)
        call binary_write_data(fibt, 1,(/ngb_tstep/),offset_bt_ijk,.true.)
        call binary_write_data(fibt, nvars, realbuffer_gb,offset_bt,.true.) 

        offset_bt = offset_bt + nvars*nfloatbit

      else
        if (mtime == mtime_append .and. i_append_sim >= 1) then
          call reposition_file(fibt,irecord)
        end if

        if (i_append_sim < 1 .or.                                      &
           (mtime >= mtime_append .and. i_append_sim >= 1)) then
          write(fibt,ascii_fmt) time,(totc(ic),ic=1,nc-1)
        end if
      end if

!cdsu concentration of radioelement related to noble gas ingrowth
      if (b_use_ngi .and. ngre_i > 0) then
        if (b_output_trans_binary) then
          nvars = ngre_i+1
          realbuffer_gb(1:nvars) =  (/time,(conc_ngre_loc(ingre),ingre=1,ngre_i)/)
          call binary_write_data(fibre, 1,(/ngb_tstep/),offset_bre_ijk,.true.)
          call binary_write_data(fibre, nvars, realbuffer_gb,offset_bre,.true.) 
  
          offset_bre = offset_bre + nvars*nfloatbit

        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            call reposition_file(fibre,irecord)
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            write(fibre,ascii_fmt) time,(conc_ngre_loc(ingre),ingre=1,ngre_i)
          end if
        end if
      end if

      if (extended_output_gb) then
!c  species concentrations
 
        if (b_output_trans_binary) then
          nvars = nc+nxout
          realbuffer_gb(1:nvars) = (/time,(c(ic),ic=1,nc-1),   &
                                     (cx(ix),ix=1,nxout)/)
          call binary_write_data(fibc, 1,(/ngb_tstep/),        &
                       offset_bc_ijk,.true.)
          call binary_write_data(fibc, nvars, realbuffer_gb,   &
                       offset_bc,.true.) 

          offset_bc = offset_bc + nvars*nfloatbit

        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            call reposition_file(fibc,irecord)
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            write(fibc,ascii_fmt) time,(c(ic),ic=1,nc-1),              &
                                          (cx(ix),ix=1,nxout)
          end if
        end if
      
!c  species concentrations
        if (b_output_activity) then
          if (b_output_trans_binary) then
            nvars = nc+nxout
            realbuffer_gb(1:nvars) = (/time,(gammac(ic),ic=1,nc-1),    &
                                       (gammax(ix),ix=1,nxout)/)
            call binary_write_data(fibac, 1,(/ngb_tstep/),             &
                         offset_bac_ijk,.true.)
            call binary_write_data(fibac, nvars, realbuffer_gb,        &
                         offset_bac,.true.) 
          
            offset_bac = offset_bac + nvars*nfloatbit
          
          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibac,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibac,ascii_fmt)                                   &
                    time,(gammac(ic),ic=1,nc-1),(gammax(ix),ix=1,nxout)
            end if
          end if
        end if     !c activity coefficients

!c  master variables

        ! Compute charge balance
        call cbalance(c,cx,zbal,zpos,zneg)

        call phpe(c,gammac,ph,pe,eh,tempkel)      

        if (compute_alkalinity) then
          call alkcalc(alk_carb,alk_noncarb,alk_tot,                   &
                       alk_carb_mg,alk_noncarb_mg,alk_tot_mg,          &
                       alkfacc,alkfacx,c,cx,                           &
                       iax,jax,nc,nx,namec,namex)
        else                     !CMX
          alk_carb=r0
          alk_noncarb=r0
          alk_tot=r0
          alk_carb_mg=r0
          alk_noncarb_mg=r0
          alk_tot_mg=r0
        end if

        if (b_output_trans_binary) then
          if ((ph_output).and.(pe_output)) then
            nvars = 13
            realbuffer_gb(1:nvars) =  (/time,ph,pe,eh,strion,alk_carb, &
                                      alk_noncarb,alk_tot,alk_carb_mg, &
                                      alk_noncarb_mg,alk_tot_mg,       &
                                      tempkel-tconv,zbal/)
          elseif ((.not.ph_output).and.(pe_output)) then 
            nvars = 12
            realbuffer_gb(1:nvars) =  (/time,pe,eh,strion,alk_carb,    &
                                      alk_noncarb,alk_tot,alk_carb_mg, &
                                      alk_noncarb_mg,alk_tot_mg,       &
                                      tempkel-tconv,zbal/)                
          elseif ((ph_output).and.(.not.pe_output)) then  
            nvars = 11
            realbuffer_gb(1:nvars) =  (/time,ph,strion,alk_carb,       &
                                      alk_noncarb, alk_tot,alk_carb_mg,&
                                      alk_noncarb_mg,alk_tot_mg,       &
                                      tempkel-tconv,zbal/)
          end if

          if (ph_output .or. pe_output) then
            call binary_write_data(fibm, 1, (/ngb_tstep/),             &
                                   offset_bm_ijk,.true.)
            call binary_write_data(fibm, nvars, realbuffer_gb,         &
                                   offset_bm,.true.) 

            offset_bm = offset_bm + nvars*nfloatbit
          end if

        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            if (ph_output .or. pe_output) then
              call reposition_file(fibm,irecord)
            end if
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            if ((ph_output).and.(pe_output)) then
              write(fibm,ascii_fmt)                                    &
                                      time,ph,pe,eh,strion,alk_carb,   &
                                      alk_noncarb,alk_tot,alk_carb_mg, &
                                      alk_noncarb_mg,alk_tot_mg,       &
                                      tempkel-tconv,zbal
            elseif ((.not.ph_output).and.(pe_output)) then
              write(fibm,ascii_fmt) time,pe,eh,strion,alk_carb,        &
                                      alk_noncarb,alk_tot,alk_carb_mg, &
                                      alk_noncarb_mg,alk_tot_mg,       &
                                      tempkel-tconv,zbal
            elseif ((ph_output).and.(.not.pe_output)) then
              write(fibm,ascii_fmt) time,ph,strion,alk_carb,           &
                    alk_noncarb, alk_tot,alk_carb_mg,alk_noncarb_mg,   &
                    alk_tot_mg,tempkel-tconv,zbal
            end if
          end if
        end if

!c  partial gas pressures

        if (ng.gt.0) then
 
!c  total gas pressure

          pres_tot = r0
          do ig = 1,ng
            pres_tot = pres_tot+rgasatm*tempkel*g(ig)
          end do
 
          if (b_output_trans_binary) then
            nvars = ng+2
            realbuffer_gb(1:nvars) =  (/time,(rgasatm*tempkel*g(ig),   &
                                      ig=1,ng),pres_tot/)
            call binary_write_data(fibg, 1,(/ngb_tstep/),              &
                         offset_bg_ijk,.true.)
            call binary_write_data(fibg, nvars, realbuffer_gb,         &
                         offset_bg,.true.) 

            offset_bg = offset_bg + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibg,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibg,ascii_fmt)                                    &
                    time,(rgasatm*tempkel*g(ig),ig=1,ng),pres_tot
            end if
          end if

!c  gas removal rates

          if (gas_removal) then
            if (density_dependence) then
!c  uvsnew was passed into hhead
              call rategasd(g,tempkel,hhead,1-sw,tid)
            else
              call rategas(g,tempkel,hhead,zg,1-sw,tid)
            end if

            if (b_output_trans_binary) then
              nvars = ng+1
              realbuffer_gb(1:nvars) =  (/time,(rateg(ig,tid),ig=1,ng)/)
              call binary_write_data(fibgr, 1,(/ngb_tstep/),           &
                           offset_bgr_ijk,.true.)
              call binary_write_data(fibgr, nvars,                     &
                           realbuffer_gb,offset_bx,.true.) 

              offset_bx = offset_bx + nvars*nfloatbit

            else
              if (mtime == mtime_append .and. i_append_sim >= 1) then
                call reposition_file(fibgr,irecord)
              end if

              if (i_append_sim < 1 .or.                                &
                 (mtime >= mtime_append .and. i_append_sim >= 1)) then
                write(fibgr,ascii_fmt) time,(rateg(ig,tid),ig=1,ng)
              end if
            end if
 
          end if

        end if
 
!c  oxidation-reduction rates
!c  !!!use fibi for intra-aqueous reactions
!c  !!!get rid of the following, after raterdx is incorporated into 
!c  !!!rateint

        if (naq.eq.0.and.(nr.gt.0).and.(.not.redox_equil)) then

          do ir = 1,nr
            call rateredx(c,cx,gammac,gammax,rateor(ir,tid),totc,ir,tid)
          end do

          if (b_output_trans_binary) then
            nvars = nr+1
            realbuffer_gb(1:nvars) =  (/time,(rateor(ir,tid),ir=1,nr)/)
            call binary_write_data(fibi, 1,(/ngb_tstep/),      &
                         offset_bi_ijk,.true.)
            call binary_write_data(fibi, nvars,                &
                         realbuffer_gb,offset_bgr,.true.) 

            offset_bgr = offset_bgr + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibi,irecord)
            end if

            if (i_append_sim < 1 .or.                                    &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibi,ascii_fmt) time,(rateor(ir,tid),ir=1,nr)
            end if
          end if

        end if

!c  reaction rates of intra-aqueous kinetic reactions

        if (naq.gt.0) then 
          if (ivolume > 0) then
            scalfac_aq(1:naq) = scalfac_aq_ivol(1:naq,ivolume)
          end if
          do iaq = 1,naq
            if (new_database) then
              call rateint_new(rateaq(iaq,tid),totc,c,cx,gammac,gammax,  &
                               phim,iaq,scalfac_aq(iaq),sw,porvol,tid)
            else
              call rateint(rateaq(iaq,tid),totc,c,gammac,phim,iaq,       &
                           scalfac_aq(iaq),tid)
            end if
          end do

          if (b_output_trans_binary) then
            nvars = naq+1
            realbuffer_gb(1:nvars) =  (/time,(rateaq(iaq,tid),iaq=1,naq)/)
            call binary_write_data(fibi, 1,(/ngb_tstep/),      &
                         offset_bi_ijk,.true.)
            call binary_write_data(fibi, nvars,                &
                         realbuffer_gb,offset_bgr,.true.) 

            offset_bgr = offset_bgr + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibi,irecord)
            end if

            if (i_append_sim < 1 .or.                          &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibi,ascii_fmt) time,(rateaq(iaq,tid),iaq=1,naq)
            end if
          end if

        end if

!c  concentrations of sorbed species

!c  compute sorbed concentrations - noncompetitive reactions

        if (noncompetitive_sorption) then
      
          call totcona(totan(:,tid),totc,distcoff,sw,porvol)

!c  compress sorbed concentration vector for output      

          ianc = 0
          do ic = 1,nc-1
            if (isotherm_type(ic).ne.'none') then
              ianc = ianc+1
              totan(ianc,tid) = totan(ic,tid)
            end if
          end do

        end if

!c  compute sorbed species concentrations based on aqueous concentrations
!c  competitive sorption

        if (nsb_ion.gt.0) then
            do isb = 1,nsb_ion 
                  call sorbspc_m(csb_ion(isb,tid),dummy,cec_l,         &
                       cec_fraction(idx_nsites_ion(isb)),              &
                       eqsb_ion(:,tid),eqsb_surf(:,tid),               &
                       gammac,c,xnusb_ion,xnusb_surf,                  &
                       iasb_ion,iasb_surf,jasb_ion,jasb_surf,          &
                       nsb_ion,nsb_surf,isb,0,                         &
                       sorption_type_ion,sorption_type_surf,           &
                       sorption_group,isactcexch)
            end do  
        end if
      
        if (nsb_surf.gt.0) then
          do isb = 1,nsb_surf
            call sorbspc(dummy,csb_surf(isb,tid),cec_l,                &
                 eqsb_ion(:,tid),eqsb_surf(:,tid),                     &
                 gammac,c,xnusb_ion,xnusb_surf,                        &
                 iasb_ion,iasb_surf,jasb_ion,jasb_surf,                &
                 nsb_ion,nsb_surf,0,isb,                               &
                 sorption_type_ion,sorption_type_surf,                 &
                 sorption_group,isactcexch)
          end do
        end if

!c  output - sorbed species

        if (nsb_ion .gt. 0 .or. nsb_surf.gt.0 .or.                     &
            noncompetitive_sorption) then

          if (b_output_trans_binary) then
            nvars = nanc+nsites+nsb_ion+nsb_surf+1
            realbuffer_gb(1:nvars) =  (/time,                          &
                  (totan(ianc,tid),ianc=1,nanc),                       &
                  (c(iaic(isites)),isites=1,nsites),                   &
                  (csb_ion(isb,tid),isb=1,nsb_ion),                    &
                  (csb_surf(isb,tid),isb=1,nsb_surf)/)
            call binary_write_data(fibb, 1,(/ngb_tstep/),              &
                         offset_bb_ijk,.true.)
            call binary_write_data(fibb, nvars,                        &
                         realbuffer_gb,offset_bi,.true.) 

            offset_bi = offset_bi + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibb,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibb,ascii_fmt) time,                              &
                    (totan(ianc,tid),ianc=1,nanc),                     &
                    (c(iaic(isites)),isites=1,nsites),                 &
                    (csb_ion(isb,tid),isb=1,nsb_ion),                  &
                    (csb_surf(isb,tid),isb=1,nsb_surf)
            end if
          end if
        end if

!c  mineral saturation indices
 
        if (nm.gt.0) then

!c  compute average molar concentrations for organic mixture
!c  in solid phase

          call molconc(phimold,tid)

          do im = 1,nm

            if (.not.far_from_equil(im)) then

!c  saturation indices for minerals
!c_isotope
              if (isofrac(im)) then
                satm(im,tid) = eqm(im,tid)**(-r1)
                ireac = iamd(im)            
                istart = iam(im)
                istop = iam(im+1)-1 
                  
                do i1 = istart, istop ! loop through components in mineral
                  icount = 0
                  ic = jam(i1)
                  next = 0
                  do i = 1, nifrm(im)  ! loop through isotope sets
                    istart2 = next + iamdiso(im)
                    icur = iamdiso2(im) + i - 1
                    istop2 = iamdiso(im) + jamdiso2(icur) - 1
                    next = jamdiso2(icur)
                    gammatemp = r0
                    !loop through isotope compents in set
                    do i2 = istart2, istop2 
                      ii = jamdiso(i2)
                      !check to see if component is an isotope
                      if (ii.eq.ic) then 
                        icount = icount + 1
                        !if so sum the isotope activities
                        do i3 = istart2, istop2 
                          ic2 = jamdiso(i3)
                          gammatemp = gammatemp + gammac(ic2)*c(ic2)
                        end do 
                        satm(im,tid) = satm(im,tid) *(gammatemp**xnum(i1))
                      end if
                    end do
                  end do 
                  !if not calculate the saturaton index the normal way  
                  if (icount.eq.0) then    
                      satm(im,tid) = satm(im,tid) * (gammac(ic)*c(ic))**xnum(i1)
                  end if
                end do   !i1
            
                satm_log(im) = dlog10(satm(im,tid))

              else if (reaction_type(im).ne.'raoult') then

                satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,     &
                               iam,jam,im)
                satm_log(im) = dlog10(satm(im,tid))

!c  effective saturation indices for dissolution form organic mixtures
!c  based on raoult's law

              elseif (reaction_type(im).eq.'raoult') then

!c  compute molar concentration of organic compound in organic mixture

                conc_mol = phimold(im)*densm(im)/gfwm(im)

!c  pure phase saturation index

                satm(im,tid) = satindex(c,eqm(im,tid),gammac,xnum,     &
                               iam,jam,im)

!c  effective solubility according to Raoult's law

                frac_mol = conc_mol/conc_mol_avg(tid) 
                satm(im,tid) = satm(im,tid)/frac_mol
                satm_log(im) = dlog10(satm(im,tid))

              end if

!c  skip for far-from-equilibrium reactions

            else

              satm_log(im) = r0

            end if
          end do

          if (b_output_trans_binary) then
            nvars = nm+1
            realbuffer_gb(1:nvars) =  (/time,(satm_log(im),im=1,nm)/)
            call binary_write_data(fibs, 1,(/ngb_tstep/),            &
                         offset_bs_ijk,.true.)
            call binary_write_data(fibs, nvars,                      &
                         realbuffer_gb,offset_bb,.true.) 

            offset_bb = offset_bb + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibs,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibs,ascii_fmt) time,(satm_log(im),im=1,nm)
            end if
          end if
 
!c  mineral volume fractions
 
!c  get rid off concentrations below numerical accuracy

          do im = 1,nm
            if (phim(im).gt.phimin_out(im)) then
              phi_out(im) = phim(im)
            else
              phi_out(im) = phimin(im)
            end if
          end do

!c  compute porosity from mineral volume fractions for output
!cdsu Bugfix 2021-03-30: The calculated porosity is only correct  
!cdsu if all solids are considered in the calculation 
!cdsu including those "inert" minerals. Otherwise, the porosity 
!cdsu will be higher than the actual porosity.
          !por_out = r1
          !do im = 1,nm
          !  if (iamp(im+1)-iamp(im).gt.0) then
          !    por_out = por_out - phi_out(im)
          !  end if
          !end do
       
          if (update_porosity) then
            if (b_output_trans_binary) then
              nvars = nm+2
              realbuffer_gb(1:nvars) =  (/time,(phi_out(im),im=1,nm),  &
                                          porvol/)
            else
              if (mtime == mtime_append .and. i_append_sim >= 1) then
                call reposition_file(fibv,irecord)
              end if
  
              if (i_append_sim < 1 .or.                                &
                 (mtime >= mtime_append .and. i_append_sim >= 1)) then
                write(fibv,ascii_fmt) time,(phi_out(im),im=1,nm),porvol
              end if
            end if

          else
            if (b_output_trans_binary) then
              nvars = nm+2
              realbuffer_gb(1:nvars) =  (/time,(phi_out(im),im=1,nm),  &
                                          porvol/)
            else
              if (mtime == mtime_append .and. i_append_sim >= 1) then
                call reposition_file(fibv,irecord)
              end if
  
              if (i_append_sim < 1 .or.                                &
                 (mtime >= mtime_append .and. i_append_sim >= 1)) then
                write(fibv,ascii_fmt) time,(phi_out(im),im=1,nm),porvol
              end if
            end if
          
          end if

          if (b_output_trans_binary) then
            call binary_write_data(fibv, 1,(/ngb_tstep/),              &
                         offset_bv_ijk,.true.)
            call binary_write_data(fibv, nvars,                        &
                         realbuffer_gb,offset_bs,.true.) 
            offset_bs = offset_bs + nvars*nfloatbit
          end if

!c  mineral dissolution-precipitation rates

          do im = 1,nm

            if (new_database) then

              rootdens = r1
              if (ivolume > 0 .and. root_uptake) then
                rootdens = rld(ivolume)
              end if

              call ratemin_new(totc,c,cx,gammac,gammax,sw,ratem,phim,  &
                               phimold(im),aream(im),rootdens,im,tid)
            else
              call ratemin(totc,c,cx,gammac,gammax,ratem,phim(im),     &
                           phimold(im),aream(im),im,tid)
            end if

!cdsu  Adjust mineral rate for intermittent reactions
            if (flag_intermittent_react) then
              if (imizn2jairm(im,izn_c) > 0) then
                ratem = ratem*imizn2irc(im,izn_c)
              end if
            end if

!cdsu  Assign mineral rate for freezing water
            if(b_water_freezing_ratemin) then
              if (tempkel < pressure_melt_k(0,r0)) then
                ratem = water_freezing_ratemin
              end if
            end if

!c  modify computed rates in the same manner as done in the residual
!c  assembly
            call modrate(ratem,cm(im),porvol,deltat,im,tid)

          end do

!CMX
          istart = iamd(1)
          istop = iamd(nm+1)-1    
!CMX
        
          if (b_output_trans_binary) then
            nvars = istop-istart+2
            realbuffer_gb(1:nvars) =  (/time,(ratemp(ireac,tid),       &
                                      ireac=istart,istop)/)
            call binary_write_data(fibd, 1,(/ngb_tstep/),              &
                         offset_bd_ijk,.true.)
            call binary_write_data(fibd, nvars,                        &
                         realbuffer_gb,offset_bv,.true.) 

            offset_bv = offset_bv + nvars*nfloatbit

          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibd,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibd,ascii_fmt) time,(ratemp(ireac,tid),           &
                                            ireac=istart,istop)
            end if
          end if

        end if           !(nm.gt.0)

!c  saturation indices (excluded minerals)

        if (nmx.gt.0) then

          do imx = 1,nmx
            satmx(imx) =  satindex(c,eqmx(imx,tid),gammac,xnumx,       &
                                   iamx,jamx,imx)
          end do

          if (b_output_trans_binary) then
            nvars = nmx+1
            realbuffer_gb(1:nvars) =  (/time,(dlog10(satmx(imx)),      &
                                       imx=1,nmx)/)
            call binary_write_data(fibx, 1,(/ngb_tstep/),              &
                         offset_bx_ijk,.true.)
            call binary_write_data(fibx, nvars,                        &
                        realbuffer_gb,offset_bd,.true.) 
  
            offset_bd = offset_bd + nvars*nfloatbit
 
          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibx,irecord)
            end if

            if (i_append_sim < 1 .or.                                   &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibx,ascii_fmt)                                  &
                    time,(dlog10(satmx(imx)), imx=1,nmx)
            end if
          end if

        end if           !(nmx.gt.0)      
      
      
!c_isotopes    
        if (iso_output) then
          i1 = 0
          do i=1,nip
            istart = iamdisoo(i)
            istop = iamdisoo(i+1)-1
            tottemp = r0
            do i2 = istart, istop
              ic2 = jamdisoo(i2)
              i1 = i1 +1
              valuetemp(i1) = totc(ic2)
              tottemp = tottemp + totc(ic2)
            end do
            i1 = i1 +1
            valuetemp(i1) = tottemp
             
            istart = iamdisoo(i)
            istop = iamdisoo(i+1)-1
            do i2 = istart+1, istop
              ic1 = jamdisoo(istart)
              ic2 = jamdisoo(i2)
              i1 = i1 +1 
              valuetemp(i1)=(totc(ic2)/totc(ic1)/isodelta(i2)-1)*1000
            end do            
          end do

          if (b_output_trans_binary) then
            nvars = i1+1
            realbuffer_gb(1:nvars) =  (/time,(valuetemp(imi),imi=1,i1)/)
            call binary_write_data(fibis, 1,(/ngb_tstep/),           &
                         offset_bis_ijk,.true.)
            call binary_write_data(fibis, nvars,                     &
                         realbuffer_gb,offset_bis,.true.) 

            offset_bis = offset_bis + nvars*nfloatbit
 
          else
            if (mtime == mtime_append .and. i_append_sim >= 1) then
              call reposition_file(fibis,irecord)
            end if

            if (i_append_sim < 1 .or.                                  &
               (mtime >= mtime_append .and. i_append_sim >= 1)) then
              write(fibis,ascii_fmt) time,(valuetemp(imi),imi=1,i1)
            end if
          end if
        
        end if
      end if
      
!c  compress total aqueous component concentration vector in case of
!c  equilibrium reactions.
      if (redox_equil.and.nr.gt.0) then
        call comptotc(totc) 
      end if

      call memory_monitor(-sizeof(nametemp),'nametemp',.false.)
      call memory_monitor(-sizeof(l_nametemp),'l_nametemp',.false.)
      call memory_monitor(-sizeof(valuetemp),'valuetemp',.false.)

      deallocate (nametemp, stat = ierr)
      call checkerr(ierr,'nametemp',ilog)

      deallocate (l_nametemp, stat = ierr)
      call checkerr(ierr,'l_nametemp',ilog)

      deallocate (valuetemp, stat = ierr)
      call checkerr(ierr,'valuetemp',ilog)

      return
      end
