!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initppenergybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initppenergybal
!c -------------------
!c
!c physical parameters for energy balance
!c
!c
!c written by:      Sergio Andres Bea Jofre 
!c
!c last modified:   Sergio Andres Bea Jofre 
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c  NOTE: 
!c ----------------------------------------------------------------------
      subroutine initppenergybal

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use dens
      use file_unit, only : lun_get, lun_free
      use file_utility, only : read_vtk_data_from_file
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
#ifdef USG
      use geometry
      use usg_mesh_data, only : nodes, cell_type, num_cells,           &
                                CellCenter, cell_projection,           &
                                is_boundary_node, is_boundary_cell
      use read_zone_usg, only : read_zone_usg_input, type_extent_zone, &
                                type_extent_zone_box,                  &
                                type_flux_direction, flux_direction

#endif
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, ivol, ivolgbl, izn, icell, l_string, nzn1, nntemp, &
                 ierrcd
#ifdef PETSC
      integer :: nntemp_gbl
      PetscErrorCode :: ierrcode
#endif
      
#ifdef USG
      logical :: bfound
      character*72 :: subcommand
      character*2048 :: strbuffer2048
#endif

      real*8 :: rdummy, heatcaps1, heatcondwxx, heatcondwyy,           &
                heatcondwzz, heatcondsxx, heatcondsyy, heatcondszz,    &
                heatcondixx, heatcondiyy, heatcondizz,                 &
                denssolid1, disheatx1, disheaty1, disheatz1,           &
                atfheatx, atfheaty, atfheatz, rtemp, rdeltemp, relheat,&                
                xpmin, xpmax, ypmin, ypmax, zpmin, zpmax

      external :: findstrg, readbloc

      real*8, external :: relheat_freezing

      logical found_section, found_subsection
      character*72 subsection
      character*1 cdummy
      
      integer :: iskip, nskip

      real*8, parameter :: r0 = 0.0d0,              &
                           r1 = 1.0d0,              &
                           r1000 = 1.0d3,           &
                           r86400 = 86400.0d0,      &
                           tiny=1.0d-5,             &
                           r2600=2600.0d0,          &
                           r08=0.8d0

      ierrcd = 0
      
      dens_h2o = 1.0d+3
      visc_h2o = 1.0d-3

!cprovi--------------------------------------------------------------
!cprovi Read parameters for energy balance
!cprovi-------------------------------------------------------------- 
      section_header = 'physical parameters - energy balance'
      call readbloc (idat,itmp,section_header,found_section,.true.)
      
      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      else
        ierrcd = 1
        read(itmp,*,err=999,end=999) nzn1            !number of zones
      end if

      
!c  read specific heat of water

        subsection = 'specific heat of water'
        heatcapw = 4.182d0
        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          read(itmp,*,err=998,end=998) heatcapw
          heatcapw=heatcapw/r1000
        end if

!cdsu  read specific heat of ice

        subsection = 'specific heat of ice'
        heatcapi = 2.050d0
        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          read(itmp,*,err=998,end=998) heatcapi
          heatcapi=heatcapi/r1000
        end if

        if (b_icewater_heat) then
          write(igen,'(/a)') 'specific heat capacity of ice water'
          write(igen,'(72a)')('-',i=1,72)
          write(igen,'(a,7x,a)') 'temperature [Â°C]','specific heat capacity'  

          rdeltemp = (water_freezing_curve_tempmax -                   &
                      water_freezing_curve_tempmin)/20.0
          do i = 0, 20
            rtemp = water_freezing_curve_tempmin+rdeltemp*i
            relheat = relheat_freezing(rtemp,heatcapw,heatcapi,r0)
            write(igen,'(1pe15.6e3,6x,1pe15.6e3)') rtemp, relheat*heatcapw
          end do
        end if
                
!c  read specific heat of vapour (only if evaporation is computed)
        if (evaporation) then
          subsection = 'specific heat of vapour'
          heatcapv = 1.996d0
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcapv
            heatcapv=heatcapv/r1000
          end if
        end if
!c----------------------------------------------------------------------------------
!c  read thermal conductivity for gas (only if variably saturated flow is solved)
!c----------------------------------------------------------------------------------
        if (variably_saturated) then
          subsection = 'gas thermal conductivity'
          heatcondg = 2.0736d0 ! KJ / m / day / K
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcondg
            heatcondg=heatcondg*r86400/r1000
          end if
        end if
        
!c----------------------------------------------------------------------------------        
!c  read specific heat of air (only if evaporation is computed)
!c----------------------------------------------------------------------------------
        if (evaporation) then
          subsection = 'specific heat of air'
          heatcapa = 1.006d0 
          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
            read(itmp,*,err=998,end=998) heatcapa
            heatcapa=heatcapa/r1000
          end if
        end if
        
!c  read energy parameters as nodal values from separate file

        subsection = 'read energy balance parameters from file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
!cprovi----------------------------------------------------------------------
!cprovi Units
!cprovi Thermal capacity => J kg-1 Kelvin-1
!cprovi Thermal conductivity => J s-1 m-1 Kelvin-1
!cprovi Solid density => kg m-3      
!cprovi----------------------------------------------------------------------
          ienergy = lun_get()

          open(ienergy,file=prefix(:l_prfx)//'.energybal',    &
              status='old', form='formatted',err=997)

#ifdef USG
          if (discretization_type > 0 .and. is_cell_based_disp_heat) then
            if (rank == 0) then
              write(ilog,'(2a)') 'SIMULATION TERMINATED'
              write(ilog,'(2a)') 'Error: cell based energy balance ",  &
                    "parameters is not supported from external file'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          else
#endif
            read(ienergy,*,err=998,end=998) cdummy
            read(ienergy,*,err=998,end=998) cdummy
            read(ienergy,*,err=998,end=998) cdummy
#ifdef USG
            if (discretization_type > 0) then
              do ivolgbl = 1,nngbl
#ifdef PETSC
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
                else
                  ivol = node_idx_g2lg(ivolgbl)
                end if
#else
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2g_invord(ivolgbl)
                else
                  ivol = ivolgbl
                end if
#endif
                if (ivol > 0) then
                  if (b_icewater_heat) then
                    read(ienergy,*,err=998,end=998)  &
                         rdummy, rdummy, rdummy,     &
                         heatcaps(ivol),             &
                         heatcondw(ivol,1),          &
                         heatcondw(ivol,2),          &
                         heatcondw(ivol,3),          &
                         heatcondi(ivol,1),          &
                         heatcondi(ivol,2),          &
                         heatcondi(ivol,3),          &
                         heatconds(ivol,1),          &
                         heatconds(ivol,2),          &
                         heatconds(ivol,3),          &
                         disheatx(ivol),             &
                         disheaty(ivol),             &
                         disheatz(ivol),             &
                         denssolid(ivol)
                  else
                    read(ienergy,*,err=998,end=998)  &
                         rdummy, rdummy, rdummy,     &
                         heatcaps(ivol),             &
                         heatcondw(ivol,1),          &
                         heatcondw(ivol,2),          &
                         heatcondw(ivol,3),          &
                         heatconds(ivol,1),          &
                         heatconds(ivol,2),          &
                         heatconds(ivol,3),          &
                         disheatx(ivol),             &
                         disheaty(ivol),             &
                         disheatz(ivol),             &
                         denssolid(ivol)
                  end if
                else
                  read(ienergy,*,err=998,end=998) rdummy
                end if
              end do
            end if
#endif
            if (discretization_type == 0) then
              nskip = 0
              do ivol = 1,nngl
#ifdef PETSC
                do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                  ierrcd = 2
                  read(ienergy,*,end=999,err=999) rdummy
                end do
                nskip = node_idx_lg2g(ivol)
#endif
                if (b_icewater_heat) then
                  read(ienergy,*,err=998,end=998)   &
                       rdummy, rdummy, rdummy,      &
                       heatcaps(ivol),              &
                       heatcondw(ivol,1),           &
                       heatcondw(ivol,2),           &
                       heatcondw(ivol,3),           &
                       heatcondi(ivol,1),           &
                       heatcondi(ivol,2),           &
                       heatcondi(ivol,3),           &
                       heatconds(ivol,1),           &
                       heatconds(ivol,2),           &
                       heatconds(ivol,3),           &                       
                       disheatx(ivol),              &
                       disheaty(ivol),              &
                       disheatz(ivol),              &
                       denssolid(ivol)
                else
                  read(ienergy,*,err=998,end=998)   &
                       rdummy, rdummy, rdummy,      &
                       heatcaps(ivol),              &
                       heatcondw(ivol,1),           &
                       heatcondw(ivol,2),           &
                       heatcondw(ivol,3),           &
                       heatconds(ivol,1),           &
                       heatconds(ivol,2),           &
                       heatconds(ivol,3),           &
                       disheatx(ivol),              &
                       disheaty(ivol),              &
                       disheatz(ivol),              &
                       denssolid(ivol)
                end if
              end do
            end if

!cprovi----------------------------------------------------------------------
!cprovi Transform J s-1 m-1 oC-1 => KJ day-1 m-1 oC-1      
!cprovi----------------------------------------------------------------------  
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                  
    !$omp do schedule(static)
#endif     
            do ivol = 1,nngl
              heatcaps(ivol)=heatcaps(ivol)/r1000
              heatcondw(ivol,1)=heatcondw(ivol,1)*r86400/r1000
              heatcondw(ivol,2)=heatcondw(ivol,2)*r86400/r1000
              heatcondw(ivol,3)=heatcondw(ivol,3)*r86400/r1000
              heatconds(ivol,1)=heatconds(ivol,1)*r86400/r1000
              heatconds(ivol,2)=heatconds(ivol,2)*r86400/r1000
              heatconds(ivol,3)=heatconds(ivol,3)*r86400/r1000
              if (b_icewater_heat) then
                heatcondi(ivol,1)=heatcondi(ivol,1)*r86400/r1000
                heatcondi(ivol,2)=heatcondi(ivol,2)*r86400/r1000
                heatcondi(ivol,3)=heatcondi(ivol,3)*r86400/r1000
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif   

#ifdef USG
          end if
#endif
          close(ienergy)
          call lun_free(ienergy)

          goto 1000
          
        end if

#ifdef USG
!c  read energy parameters as nodal values from separate file

        subsection = 'read energy balance parameters from vtk file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
!cprovi----------------------------------------------------------------------
!cprovi Units
!cprovi Thermal capacity => J kg-1 Kelvin-1
!cprovi Thermal conductivity => J s-1 m-1 Kelvin-1
!cprovi Solid density => kg m-3
!cprovi----------------------------------------------------------------------
          ienergy = lun_get()
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
              .not.read_spatial_master_proc) then
            open(ienergy,file=prefix(:l_prfx)//'.energybal.vtk',       &
                status='old', form='formatted',err=997)
          else
            call lun_free(ienergy)
            ienergy = 0
          end if

          if (discretization_type > 0 .and. is_cell_based_disp_heat) then
            if (rank == 0) then
              write(ilog,'(2a)') 'SIMULATION TERMINATED'
              write(ilog,'(2a)') 'Error: cell based energy balance ",  &
                    "parameters is not supported from external file'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          else

            !c read heatcaps
            call read_vtk_data_from_file(ienergy,'heatcaps',bfound,heatcaps)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read heat capacity from vtk file: done'
                write(ilog,'(a)') 'read heat capacity from vtk file: done'
              end if
            end if

            !c read denssolid
            call read_vtk_data_from_file(ienergy,'denssolid',bfound,denssolid)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read solid density from vtk file: done'
                write(ilog,'(a)') 'read solid density from vtk file: done'
              end if
            end if

            !c read heatcondw
            call read_vtk_data_from_file(ienergy,'heatcondw',2,bfound,heatcondw)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read heat conductivity of water from vtk file: done'
                write(ilog,'(a)') 'read heat conductivity of water from vtk file: done'
              end if
            end if

            !c read heatconds
            call read_vtk_data_from_file(ienergy,'heatconds',2,bfound,heatconds)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read heat conductivity of solid from vtk file: done'
                write(ilog,'(a)') 'read heat conductivity of solid from vtk file: done'
              end if
            end if

            !c read disheat
            call read_vtk_data_from_file(ienergy,'disheat',bfound,   &
                      disheatx,disheaty,disheatz)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read heat dispersivity from vtk file: done'
                write(ilog,'(a)') 'read heat dispersivity from vtk file: done'
              end if
            end if

!cdsu   read ice thermal parameters
            if (b_icewater_heat) then
              call read_vtk_data_from_file(ienergy,'heatcondi',2,bfound,heatcondi)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read heat conductivity of ice from vtk file: done'
                  write(ilog,'(a)') 'read heat conductivity of ice from vtk file: done'
                end if
              end if
            end if

!cprovi----------------------------------------------------------------------
!cprovi Transform J s-1 m-1 oC-1 => KJ day-1 m-1 oC-1
!cprovi----------------------------------------------------------------------
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)
    !$omp do schedule(static)
#endif
            do ivol = 1,nngl
              heatcaps(ivol)=heatcaps(ivol)/r1000
              heatcondw(ivol,1)=heatcondw(ivol,1)*r86400/r1000
              heatcondw(ivol,2)=heatcondw(ivol,2)*r86400/r1000
              heatcondw(ivol,3)=heatcondw(ivol,3)*r86400/r1000
              heatconds(ivol,1)=heatconds(ivol,1)*r86400/r1000
              heatconds(ivol,2)=heatconds(ivol,2)*r86400/r1000
              heatconds(ivol,3)=heatconds(ivol,3)*r86400/r1000
              if (b_icewater_heat) then
                heatcondi(ivol,1)=heatcondi(ivol,1)*r86400/r1000
                heatcondi(ivol,2)=heatcondi(ivol,2)*r86400/r1000
                heatcondi(ivol,3)=heatcondi(ivol,3)*r86400/r1000
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

          end if

          if (ienergy > 0) then
            close(ienergy)
            call lun_free(ienergy)
          end if

          goto 1000

        end if
#endif
     
        nntemp = 0 

!cdsu anisotropic dispersivity correction 
        useAnisoHeatDispCorr = .false.
        if (useAnisoCorr) then
          subsection = 'anisotropic dispersivity correction'
          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
            useAnisoHeatDispCorr = .true.
          end if
        end if

!cdsu anisotropic thermal conductivity correction 
        useAnisoHeatCondCorr = .false.
        if (useAnisoCorr) then
          subsection = 'anisotropic thermal conductivity correction'
          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
            useAnisoHeatCondCorr = .true.
          end if
        end if

        do izn = 1,nzn1

          subsection = 'number and name of zone'

          call findzone(subsection,itmp,found_subsection,izn,zone_name)

          if (found_subsection) then

            call readzone(itmp,icnv,ilog,zone_name,found_subsection)

          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error in input file'
              write(ilog,*) 'section "',section_header(:l_string),'"'
              write(ilog,*) 'zone number "',izn, '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

         
        subsection = 'specific heat of solid'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcaps1
          heatcaps1=heatcaps1/r1000
        else  
          heatcaps1=r08 ! for sandstones 
        end if
        
        subsection = 'water thermal conductivity in x-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwxx
          heatcondwxx=heatcondwxx*r86400/r1000
        else 
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',trim(section_header),'"'
            write(ilog,*) 'zone "', trim(zone_name),'"'
            write(ilog,*) 'subsection "',trim(subsection),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'water thermal conductivity in y-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwyy
          heatcondwyy=heatcondwyy*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',section_header(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'water thermal conductivity in z-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondwzz
          heatcondwzz=heatcondwzz*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',section_header(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
         call petsc_mpi_finalize
#endif
         stop
        end if
        
        subsection = 'solid thermal conductivity in x-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondsxx
          heatcondsxx=heatcondsxx*r86400/r1000
        else
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid thermal conductivity in y-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondsyy
          heatcondsyy=heatcondsyy*r86400/r1000
        else
          if (rank == 0) then  
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid thermal conductivity in z-direction'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) heatcondszz
          heatcondszz=heatcondszz*r86400/r1000
        else
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',subsection(:l_string),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        end if
        
        subsection = 'solid bulk density'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then
          read(icnv,*,err=998,end=998) denssolid1
        else  
          denssolid1 = r2600 
        end if

!cdsu  ice thermal conductivity
        if (b_icewater_heat) then
          subsection = 'ice thermal conductivity in x-direction'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then
            read(icnv,*,err=998,end=998) heatcondixx
            heatcondixx=heatcondixx*r86400/r1000
          else 
            if (rank == 0) then  
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',trim(section_header),'"'
              write(ilog,*) 'zone "', trim(zone_name),'"'
              write(ilog,*) 'subsection "',trim(subsection),'" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if
        
          subsection = 'ice thermal conductivity in y-direction'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then
            read(icnv,*,err=998,end=998) heatcondiyy
            heatcondiyy=heatcondiyy*r86400/r1000
          else
            if (rank == 0) then  
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',section_header(:l_string),'" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if
        
          subsection = 'ice thermal conductivity in z-direction'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then
            read(icnv,*,err=998,end=998) heatcondizz
            heatcondizz=heatcondizz*r86400/r1000
          else
            if (rank == 0) then  
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',section_header(:l_string),'" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if
        end if
        
!cprovi-----------------------------------------------------------------
!cprovi Dispersivities for heat equation 
!cprovi-----------------------------------------------------------------        
        disheatx1=r0  
        subsection = 'longitudinal dispersivity'
       
        call findstrg(subsection,icnv,found_subsection)
    
        if (found_subsection) then

          ierrcd = 3
          read(icnv,*,err=999,end=999) disheatx1
         
        end if

        disheaty1=r0  
        subsection = 'transverse horizontal dispersivity'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

          ierrcd = 4
          read(icnv,*,err=999,end=999) disheaty1
         
        end if           


        disheatz1=r0  
        subsection = 'transverse vertical dispersivity'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

          ierrcd = 5
          read(icnv,*,err=999,end=999) disheatz1

        end if          !(found_subsection)

!c  read coordinates delineating zone

        type_extent_zone = -1
        type_extent_zone_box = -1

        subsection = 'extent of zone'

        call findstrg(subsection,icnv,found_subsection)

        if (found_subsection) then

          type_extent_zone = 0

          ierrcd = 6
          read(icnv,*,err=999,end=999) xpmin,xpmax,ypmin,ypmax,   &
                                       zpmin,zpmax

        end if

#ifdef USG
        call read_zone_usg_input(icnv)
        if (type_extent_zone_box > 0) then
          ierrcd = 7
          read(icnv,*,err=999,end=999) xpmin,xpmax,ypmin,ypmax,   &
                                       zpmin,zpmax
        end if
#endif

        !c check if x dimension is valid
        if (.not.btest(cell_projection,0)) then
          xpmin = -1.0d300
          xpmax = 1.0d300
        end if
      
        !c check if y dimension is valid
        if (.not.btest(cell_projection,1)) then
          ypmin = -1.0d300
          ypmax = 1.0d300
        end if
      
        !c check if z dimension is valid
        if (.not.btest(cell_projection,2)) then
          zpmin = -1.0d300
          zpmax = 1.0d300
        end if

!c  write error information if 'extent of zone' is missing
        if (type_extent_zone < 0) then

          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error reading input file'
            write(ilog,*) 'section "',trim(section_header),'"'
            write(ilog,*) 'zone "', trim(zone_name),'"'
            write(ilog,*) 'subsection "',trim(subsection),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if

        xpmin = xpmin-tiny
        xpmax = xpmax+tiny
        ypmin = ypmin-tiny
        ypmax = ypmax+tiny
        zpmin = zpmin-tiny
        zpmax = zpmax+tiny


 
!c  assign physical parameters to global system

#ifdef USG
!c  assign physical parameters to global system
        if (discretization_type > 0 .and. is_cell_based_disp_heat) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp reduction(+:nntemp)
    !$omp do schedule(static)
#endif        
          do ivol = 1,nngl                  !loop over control volumes

            if (((type_extent_zone==0.or.type_extent_zone_box>0) .and. &
                (xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax) .and.      &
                (yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax) .and.      &
                (zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)) .or.      &
                (type_extent_zone>0 .and. node_iflags(ivol)>=0 .and.   &
                ibits(type_extent_zone,0,1)==0)) then

#ifdef USG
              if (discretization_type > 0 .and. type_extent_zone_box > 0) then
                if ((btest(type_extent_zone_box,1) .and.               &
                     .not. is_boundary_node(ivol)) .or.                &
                    (btest(type_extent_zone_box,2) .and.               &
                     is_boundary_node(ivol))) then
                  cycle
                end if
              end if
#endif

              heatcaps(ivol) = heatcaps1
              denssolid(ivol) = denssolid1
#ifdef PETSC
              if(node_idx_lg2l(ivol) > 0) then
                nntemp = nntemp+1
              end if
#else
              nntemp = nntemp+1
#endif
            end if     !(zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)
                       !(yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax)
                       !(xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax)
          end do       !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (num_cells > numofloops_thred_initppeb_2)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(icell)
    !$omp do schedule(static)
#endif
          do icell = 1,num_cells                  !loop over control volumes

            if (((type_extent_zone==0.or.type_extent_zone_box>0).and.  &
                (CellCenter(icell)%x.gt.xpmin).and.                    &
                (CellCenter(icell)%x.lt.xpmax) .and.                   &
                (CellCenter(icell)%y.gt.ypmin).and.                    &
                (CellCenter(icell)%y.lt.ypmax) .and.                   &
                (CellCenter(icell)%z.gt.zpmin).and.                    &
                (CellCenter(icell)%z.lt.zpmax)) .or.                   &
                (type_extent_zone>0 .and. cell_iflags(icell)>=0 .and.  &
                 ibits(type_extent_zone,0,1) == 1)) then

#ifdef USG
              if (discretization_type > 0 .and. type_extent_zone_box > 0) then
                if ((btest(type_extent_zone_box,1) .and.               &
                     .not. is_boundary_cell(icell)) .or.               &
                    (btest(type_extent_zone_box,2) .and.               &
                     is_boundary_cell(icell))) then
                  cycle
                end if
              end if
#endif

              heatcondw(icell,1)=heatcondwxx
              heatcondw(icell,2)=heatcondwyy
              heatcondw(icell,3)=heatcondwzz

              heatconds(icell,1)=heatcondsxx
              heatconds(icell,2)=heatcondsyy
              heatconds(icell,3)=heatcondszz

              if (b_icewater_heat) then
                heatcondi(icell,1)=heatcondixx
                heatcondi(icell,2)=heatcondiyy
                heatcondi(icell,3)=heatcondizz
              end if

              disheatx(icell) = disheatx1
              disheaty(icell) = disheaty1
              disheatz(icell) = disheatz1
            end if     !(zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)
                       !(yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax)
                       !(xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax)
          end do       !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
        else
#endif

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppeb_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(ivol)                                               &
    !$omp reduction(+:nntemp)
    !$omp do schedule(static)
#endif
          do ivol = 1,nngl                  !loop over control volumes

            if (((type_extent_zone==0.or.type_extent_zone_box>0) .and. &
                (xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax) .and.      &
                (yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax) .and.      &
                (zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)) .or.      &
                (type_extent_zone>0 .and. node_iflags(ivol)>=0 .and.   &
                ibits(type_extent_zone,0,1)==0)) then

#ifdef USG
              if (discretization_type > 0 .and. type_extent_zone_box > 0) then
                if ((btest(type_extent_zone_box,1) .and.               &
                     .not. is_boundary_node(ivol)) .or.                &
                    (btest(type_extent_zone_box,2) .and.               &
                     is_boundary_node(ivol))) then
                  cycle
                end if
              end if
#endif

              heatcaps(ivol) = heatcaps1
              denssolid(ivol) = denssolid1

              heatcondw(ivol,1)=heatcondwxx
              heatcondw(ivol,2)=heatcondwyy
              heatcondw(ivol,3)=heatcondwzz

              heatconds(ivol,1)=heatcondsxx
              heatconds(ivol,2)=heatcondsyy
              heatconds(ivol,3)=heatcondszz

              if (b_icewater_heat) then
                heatcondi(ivol,1)=heatcondixx
                heatcondi(ivol,2)=heatcondiyy
                heatcondi(ivol,3)=heatcondizz
              end if

              disheatx(ivol) = disheatx1
              disheaty(ivol) = disheaty1
              disheatz(ivol) = disheatz1
#ifdef PETSC
              if(node_idx_lg2l(ivol) > 0) then
                nntemp = nntemp+1
              end if
#else
              nntemp = nntemp+1
#endif
            end if     !(zg(ivol).gt.zpmin).and.(zg(ivol).lt.zpmax)
                       !(yg(ivol).gt.ypmin).and.(yg(ivol).lt.ypmax)
                       !(xg(ivol).gt.xpmin).and.(xg(ivol).lt.xpmax)
          end do       !loop over control volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef USG
        end if
#endif

      end do                     !loop over property zones

#ifdef PETSC
      call MPI_Allreduce(nntemp, nntemp_gbl,1,MPI_INTEGER4,MPI_SUM,    &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nntemp = nntemp_gbl
#endif

!c  check if material properties have been assigned correctly

      if (nntemp>nngbl) then
        if (rank == 0) then  
          write(ilog,*)
          write(ilog,'(a)')  &                 !screen or logbook
                'warning ...........'
          write(ilog,'(a,1x,i0,1x,a)')                                 &
               'energy medium properties have been assigned to',       &
                nntemp,'control volumes'
          write(ilog,'(a,1x,i0)')                                      &
               'the actual number of control volumes is only',nngbl
          write(ilog,'(/72a)')('-',i=1,72)
        end if
      elseif (nntemp<nngbl) then            
        if (rank == 0) then
          write(ilog,'(a,i0,a)') 'assign energy properties only to ',  &
                        nntemp, ' control volumes'
          write(ilog,'(a,i0)') 'the actual number of control volumes is ',nngbl
        end if
        ierrcd = 8
        goto 999
      end if                             !(nntemp.....)

      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'file ', prefix(:l_prfx)//'.energybal missing'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading nodal material properties field ', &
     &                'from file'
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end subroutine
