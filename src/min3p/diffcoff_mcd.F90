!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/diffcoff_mcd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c  ----------------------------------------------------------------------
!c  subroutine diffcoff_mcd
!c  -----------------
!c 
!c  compute harmonically averaged diffusion coefficients 
!c  for free and secondary aqueous species  
!c 
!c 
!c                         /|   ij, D_ij
!c                        / | /
!c                       /  |/
!c                      |   /
!c             D_i      |  /|           D_j
!c             *--------|-*-------------*
!c             i d_i,ij |   |  d_j,ij   j
!c                      |   |
!c                      |  / 
!c                      | /   
!c 
!c 
!c  Based on Uli Mayer template
!c 
!c  Written by:   Pejman Rasouli - February 11, 2010
!c 
!c  last modified:   Pejman Rasouli - February 16, 2012
!c
!c                   Danyang Su    - March 14, 2014
!c                                   HPC capabilities
!c                                 - Oct, 2021
!c                                   node based coefficients
!c 
!c  definition of variables:
!c 
!c  I --> on input   * arbitrary  - initialized  + entries expected
!c  O --> on output  * arbitrary  - unaltered    + altered
!c  
!c                                                                     I O
!c  passed:   -
!c 
!c  common:   
!c  gen.f:    real*8:
!c            -------
!c            cinfvs(njavs)      = influence coefficients              * +
!c                                 (variably saturated flow)
!c            delx(nvx)          = spatial increment in x-direction    + -
!c            dely(nvy)          = spatial increment in y-direction    + -
!c            delz(nvz)          = spatial increment in z-direction    + -
!c            perm_fac(nn)       = scaling factor for permeability     + -
!c                                 as a function of porosity changes
!c            f_epor_ps(nc,nzn)  = correction factor of porosity for
!c                                  primary species                    +-
!c            f_epor_ss(nc,nzn)  = correction factor of porosity for
!c                                  secondary species                  +-
!c            f_etau_ps(nc,nzn)  = correction factor of tortuosity for
!c                                  primary species                    +-
!c            f_etau_ss(nc,nzn)  = correction factor of tortuosity for
!c                                  secondary species                  +-
!c 
!c            integer*4:
!c            ----------
!c            nvx                = number of control volumes in        + -
!c                                 x-direction
!c            nvy                = number of control volumes in        + -
!c                                 y-direction
!c            nvz                = number of control volumes in        + -
!c                                 z-direction
!c 
!c            logical:
!c            --------
!c            half_cells         = .true.  -> half cells on boundary   + -
!c 
!c 
!c  phys.f:   real*8:
!c            -------
!c 
!c 
!c 
!c  local:    real*8:
!c            -------
!c            areaf              = interfacial area
!c            delx_i             = interfacial distance i-ij in 
!c                                 x-direction
!c            delx_j             = interfacial distance j-ij in
!c                                 x-direction
!c            dely_i             = interfacial distance i-ij in
!c                                 y-direction
!c            dely_j             = interfacial distance j-ij in
!c                                 y-direction
!c            delz_i             = interfacial distance i-ij in
!c                                 z-direction
!c            delz_j             = interfacial distance j-ij in
!c            rhalf              = constant
!c            
!c            integer*4:
!c            ----------
!c            ivx                = counter (number of control
!c                                 volumes in x-direction)
!c            ivy                = counter (number of control
!c                                 volumes in y-direction)
!c            ivz                = counter (number of control
!c                                 volumes in z-direction)
!c            ivol               = pointer (current control volume)
!c            ivxp               = pointer (previous control 
!c                                 volume in x-direction) 
!c            ivxn               = pointer (next control volume in 
!c                                 x-direction)
!c            ivyp               = pointer (previous control
!c                                 volume in y-direction)
!c            ivyn               = pointer (next control volume in
!c                                 y-direction)
!c            ivzp               = pointer (previous control
!c                                 volume in z-direction)
!c            ivzn               = pointer (next control volume in
!c                                 z-direction)
!c            izn                = pointer (material property zone)
!c            jtemp              = pointer to colum entries
!c 
!c  external: -
!c  ----------------------------------------------------------------------
 
      subroutine diffcoff_mcd()

#ifdef OPENMP
      use omp_lib 
#endif

      use gen
      use chem
      use mod_diffcoff
      use multidiff
      use geometry_definition

      implicit none
      
      integer :: ic, ix, izn, ivol, info_debug

!c    local variables
      real*8 :: so_av, satav, por_i, tau_i, epor_i, etau_i

      real*8, parameter :: rhalf = 0.5d0, r1 = 1.0d0, r2 = 2.0d0,      &
                           pi = 3.141592653589793d0
      
      
!c  set up to work for half and full cells


!c   initialize pointer to current control volume

      info_debug = 0 
      tau_i = r1
      
!c   loop over control volumes

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_diffcoff_mcd_1)                 &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ic, ivol, ix, izn, por_i, satav,           &
    !$omp tau_i, epor_i, etau_i, so_av)
    !$omp do schedule(static)
#endif   
      do ivol = 1, nngl

        izn = mpropvs(ivol)

        if (assigned_tau) then
          tau_i = tau(ivol)*tau_fac(ivol)      ! assign tortuosity
        else
          tau_i = r1
        end if          
        por_i = pornew(ivol)                   ! assign porosity   
                
!cprovi------------------------------------------------                
        do ic =1,nc
!cmx  adding modification factor for effective porosity calculation
!cdsu this part is hardwired, need to modify when necessary.
          
          epor_i = por_i*f_epor_ps(ic,izn)
          etau_i = tau_i*f_etau_ps(ic,izn)

          satav = dmin1(r1, sanew(ivol))
          so_av = dmin1(r1, sonew(ivol))

          if (type_mdiff_ic_coeff == 0) then
            mdiff_ic_cvol(ic, ivol) = diffcoff(                        &
                                      mdiff_ic(ic),satav,epor_i,       &
                                      tortuosity_corr,assigned_tau,    &
                                      etau_i,type_tortuosity,          &
                                      marchies(ivol),so_av,            &
                                      tor_corr_a_mq,tor_corr_b_mq)

          else if (type_mdiff_ic_coeff > 0) then
            mdiff_ic_cvol_tensor(ic, ivol) = diffcoff(                 &
                                      mdiff_ic_tensor(ic),             &
                                      satav,epor_i,                    &
                                      tortuosity_corr,assigned_tau,    &
                                      etau_i,type_tortuosity,          &
                                      marchies(ivol),so_av,            &
                                      tor_corr_a_mq,tor_corr_b_mq)
          end if 

        end do                         ! loop over free species
               
        do ix = 1,nx                   ! loop over secondary species
!cmx  adding modification factor for effective porosity calculation

          epor_i = por_i*f_epor_ss(ix,izn)
          etau_i = tau_i*f_etau_ss(ix,izn)

          satav = dmin1(r1, sanew(ivol))
          so_av = dmin1(r1, sonew(ivol))

          if (type_mdiff_ix_coeff == 0) then
            mdiff_ix_cvol(ix, ivol) = diffcoff(                        &
                                      mdiff_ix(ix),satav,epor_i,       &
                                      tortuosity_corr,assigned_tau,    &
                                      etau_i,type_tortuosity,          &
                                      marchies(ivol),so_av,            &
                                      tor_corr_a_mq,tor_corr_b_mq) 
          else if (type_mdiff_ix_coeff > 0) then
            mdiff_ix_cvol_tensor(ix, ivol) = diffcoff(                 &
                                      mdiff_ix_tensor(ix),satav,epor_i,&
                                      tortuosity_corr,assigned_tau,    &
                                      etau_i,type_tortuosity,          &
                                      marchies(ivol),so_av,            &
                                      tor_corr_a_mq,tor_corr_b_mq) 
          end if
   
        end do                            ! loop over secondary species
               
      end do                              ! loop over volumes
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif       
      
      return
      end
