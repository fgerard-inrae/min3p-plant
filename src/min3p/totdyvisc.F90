!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/totdyvisc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine totdyvisc
!c -------------------
!c
!c compute total aqueous component dynamic viscosity based 
!c on concentrations of free species and secondary aqueous species
!c
!c written by:      Pejman Rasouli - February 17, 2010
!c
!c last modified:   Pejman Rasouli - February 16, 2012
!c
!c definition of variables:   
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                   I O
!c passed:   real*8:
!c          -------
!c          cd(nc)              = concentrations of free species      + -
!c                               [moles/l water]
!c          cdx(nx)             = concentrations of secondary aqueous + -
!c                               species [moles/l water]
!c          drtinc             = increment for numerical             + -
!c                               concentrations [moles/l water]
!c
!c common:
!c chem.f:   real*8:
!c          -------
!c          xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                               for formation of secondary aqueous
!c                               species from free species
!c
!c          integer*4:
!c          ----------
!c          iax(nx+1)          = row pointer array to                + -
!c                               stoichiometric coefficients of
!c                               free species in
!c                               secondary aqueous species
!c          jax(nx*nc)         = column pointer array to             + -
!c                               stoichiometric coefficients of
!c                               free species in secondary aqueous
!c                               species
!c          nc                = number of components including h2o  + -
!c          nx                 = number of secondary aqueous species + -
!c
!c multidiff.f90
!c         mdiff_ic_cvol(nc, njavs)= averaged diffusion coefficient of free 
!c                        aqueous species
!c         mdiff_ix_cvol(nc, njavs)= averaged diffusion coefficient of  
!c                        secondary aqueous species
!c local:    integer*4:
!c          ----------
!c          i                  = counter (stoichiometric
!c                               coefficients)
!c          ic                = counter (components)
!c          ix                 = counter (secondary aqueous species) 
!c          istart             = pointer (stoichiometric 
!c                               coefficients)
!c          iend               = pointer (stoichiometric
!c                               coefficients)
!c        totvisc(nc)        = sum of concentration * diffusion coef. 
!c                 for each species
!c external: -
!c ----------------------------------------------------------------------
  
      subroutine totdyvisc(ivol,jvol,cd_ivol,cdx_ivol,                 &
                           cd_jvol,cdx_jvol,d_totvisc)
      
      use parm
      use chem
      use gen
      use multidiff
 
      implicit none

      integer :: ivol, jvol
      real*8 :: cd_ivol(nc),cdx_ivol(nx),cd_jvol(nc),cdx_jvol(nx),     &
                d_totvisc(nc)

!c local variables
      integer :: i, ic, ix, istart, iend, info_debug    
      real*8 :: diff_ij
      real*8 :: diff_cof_ic_ivol(nc),diff_cof_ix_ivol(nx),             &
                diff_cof_ic_jvol(nc),diff_cof_ix_jvol(nx),             &
                diff_cof_ic(nc),diff_cof_ix(nx)
      real*8 :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0, rhalf = 0.5d0

!c apply averaging method
      diff_cof_ic_ivol(:) = mdiff_ic_cvol(:,ivol)
      diff_cof_ic_jvol(:) = mdiff_ic_cvol(:,jvol)

      diff_cof_ix_ivol(:) = mdiff_ix_cvol(:,ivol)
      diff_cof_ix_jvol(:) = mdiff_ix_cvol(:,jvol)

      diff_cof_ic = r0
      diff_cof_ix = r0

      if (type_averaging_De.eq.'harmonic') then
        do ic=1,nc-1          ! loop over free species 
          diff_ij = diff_cof_ic_ivol(ic)*diff_cof_ic_jvol(ic)
          if (diff_ij > r0) then
            diff_cof_ic(ic) = r2*diff_ij/(diff_cof_ic_ivol(ic)+        &
                                          diff_cof_ic_jvol(ic))
          end if          
        end do

        do ix=1,nx          ! loop over secondary species 
          diff_ij = diff_cof_ix_ivol(ix)*diff_cof_ix_jvol(ix)
          if (diff_ij > r0) then
            diff_cof_ix(ix) = r2*diff_ij/(diff_cof_ix_ivol(ix)+        &
                                          diff_cof_ix_jvol(ix))
          end if          
        end do
      else if (type_averaging_De.eq.'arithmetic') then
        do ic=1,nc-1          ! loop over free species 
          diff_cof_ic(ic) = rhalf*(diff_cof_ic_ivol(ic)+               &
                                   diff_cof_ic_jvol(ic))
        end do

        do ix=1,nx            ! loop over secondary species 
          diff_cof_ix(ix) = rhalf*(diff_cof_ix_ivol(ix)+               &
                                   diff_cof_ix_jvol(ix))
        end do
      else if (type_averaging_De.eq.'no averaging') then
        do ic=1,nc-1          ! loop over free species 
          diff_cof_ic(ic) = diff_cof_ic_ivol(ic)
        end do

        do ix=1,nx            ! loop over secondary species 
          diff_cof_ix(ix) = diff_cof_ix_ivol(ix)
        end do
      end if      
      
!c free species      

      do ic=1,nc-1
        d_totvisc(ic) = diff_cof_ic(ic)*(cd_jvol(ic)-cd_ivol(ic))
      end do            ! loop over free species

!c add up aqueous complexes
 
      do ix=1,nx
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend
          ic = jax(i)
         
!c skip h2o, since not a primary unknown
         
          if (namec(ic).ne.'h2o') then
            d_totvisc(ic) = d_totvisc(ic) + xnux(i)*diff_cof_ix(ix)*   &
                            (cdx_jvol(ix)-cdx_ivol(ix))
          end if
        end do
      end do            ! loop over secondary species

      return
      end
