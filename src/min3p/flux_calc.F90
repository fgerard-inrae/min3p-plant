!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/flux_calc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine flux_out
!c ----------------
!c
!c construct Jacobian matrix and rhs-vector (reactive transport)
!c
!c written by:      Uli Mayer - Aug 15, 96
!c
!c last modified:   Uli Mayer - December 5, 96
!c                  Uli Mayer - November 12, 01
!c                  added new database format
!c                  for dissolution-precipitation reactions
!c
!c
!c                  Danyang Su - March 14, 2014
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           astor(n)           = storage term (non-competitive       * +
!c                                sorption)
!c           area(nm,nn)        = specific reactive surface area of   + - 
!c                                mineral (global system)
!c           art(njart)         = jacobian matrix                     + -
!c           brt(nn*n)          = rhs vector                          + -
!c           cflux(ncon,n)      = interfacial mass fluxes             * *
!c                                (aqueous phase)
!c           cinfrt_da(njavs)   = influence coefficients              + -
!c                                (dispersion - aqueous phase)
!c           cinfrt_dg(njavs)   = influence coefficients              + -
!c                                (diffusion - gaseous phase)
!c           cinfrt_va(njavs)   = influence coefficients              + -
!c                                (advection - aqueous phase)
!c           hhead(nn)          = hydraulic head                      + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c           cmnew(nm,nn)       = mineral concentrations              + -
!c                                - new time level [moles/l bulk]
!c           cnew(nc,nn)        = concentrations of free species      + -
!c                                - new time level [moles/l water]
!c           cec_g(nn)          = cation exchange capacity (meq/100g) + -
!c                                - global system
!c           cstor(n)           = storage term (aqueous phase)        * *
!c           cvol(nn)           = nodal volumes                       + -
!c           cx(nx,nn)          = concentrations of secondary aqueous + -
!c                                species [moles/l water]
!c           distcoff_rt(nc,nn) = sorption distribution coefficient   + -
!c                                [-], [l bulk/l bulk]
!c                                - reactive transport
!c           delt               = time step                           + -
!c           dinc_rt            = factor to compute increment for     + -
!c                                numerical differentiation
!c           dtotcflux(n)       = derivatives of total mass fluxes    * +
!c                                (aqueous phase)
!c           dtotgflux(n)       = derivatives of total mass fluxes    * +
!c                                (gaseous phase)
!c           gamma(nc+nx,nn)    = activity coefficients of aqueous    + +
!c                                species
!c           gnew(ng,nn)        = gas concentrations                  + -
!c                                - new time level [moles / l air]
!c           gflux(ncon,n)      = interfacial mass fluxes             * *
!c                                (gaseous phase)
!c           gstor(n)           = storage term (gaseous phase)        * *
!c           phi(nm,nn)         = volume fractions of minerals        + -
!c           phiold(nm,nn)      = volume fractions of minerals        + -
!c                                (old time level)
!c           pornew(nn)         = porosity                            + -
!c           ratemdp(nm,nn)     = absolute dissolution-precipitation  * +
!c                                rates of minerals
!c           sionnew(nn)        = ionic strength of solution          + +
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           sgnew(nn)          = gaseous phase saturation            + -
!c                                - new time level
!c           sgold(nn)          = gaseous phase saturation            + -
!c                                - old time level
!c           tkel(nn)           = nodal temperatures in Kelvin        + -
!c           totaold(n,nn)      = total sorbed component              + -
!c                                concentrations
!c                                non-competitive sorption 
!c                                - old time level [moles/l bulk]
!c           totanew(n,nn)      = total aqueous component             * +
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk]
!c           totcflux(n)        = total mass fluxes (water phase)     * *
!c           totcnew(n,nn)      = total aqueous component             * +
!c                                concentrations
!c                                - new time level [moles/l water]
!c           totcold(n,nn)      = total aqueous component             * +
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totgflux(n)        = total mass fluxes (gaseous phase)   * *
!c           totgnew(n,nn)      = total gaseous component             * +
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totgold(n,nn)      = total gaseous component             + -
!c                                concentrations
!c                                - old time level [moles/l air]
!c           totmdp(n,nn)       = total source/sink term towards      * +
!c                                total aqueous component
!c                                concentrations due to mineral
!c                                dissolution-precipitation reactions
!c           totsnew(n,nn)      = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totsnew_ion(n,nn)  = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsnew_surf(n,nn) = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           totsold(n,nn)      = total sorbed component              * +
!c                                concentrations
!c                                - old time level [moles/l bulk]
!c           totsold_ion(n,nn)  = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsold_surf(n,nn) = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (surface-complex)
!c           
!c           integer*4:
!c           ----------
!c           i2up(nn)           = pointer array to second upstream    + -
!c                                point
!c           iavs(nn+1)         = row pointer array for avs           + -
!c           idbg               = unit number - debugging file        + -
!c           isymvs(njavs)      = symmetry pointer array              + -
!c           javs(njavs)        = connectivity list                   + -
!c           lart(njavs+1)      = pointer array                       + -
!c           kadbl(n,n)         = pointer array for conversion to     + -
!c                                sparse format (diagonal block
!c                                matrices)
!c           kaobl(n,n)         = pointer array for conversion        + -
!c                                to sparse format
!c                                (off-diagonal block matrices)
!c           kart(njart)        = mapping pointer                     + -
!c                                (global block -> nd-scalar)
!c           nn                 = total number of control volumes     + -
!c           n                  = number of primary unknowns          + -
!c     
!c           logical:
!c           --------
!c           analyt_deriv_rt    = .true.  -> form derivatives         + -
!c                                           analytically
!c
!c
!c chem.f:   real*8:
!c           -------
!c           cinc(nc,nthreads)  = incremented free species            * *
!c                                concentrations
!c                                [moles/l water]
!c           chargesb(nsb)      = charge of sorbed species            + -
!c           chargesb_ion(nsb_ion)   = charge of sorbed species       + -
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) = charge of sorbed species       + -
!c                                     (surface-complex)
!c           cmcmin(nm,nthreads)= min. concentration of minerals      + -
!c                                [moles/l bulk]
!c           csb(nsb)           = concentrations of sorbed species    * *
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)
!                               = concentrations of sorbed species    * *
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * *
!c                                - new time level (surface-complex)
!c           cxinc(nx,nthreads) = secondary aqueous species           * *
!c                                concentrations dependent on
!c                                incremented free species
!c                                concentrations
!c                                [moles/l water]
!c           dcsb(nsb)          = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species
!c           dcsb_ion(nsb_ion,nthreads)  
!c                              = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species (ion-exchange)
!c           dcsb_surf(nsb_surf,nthreads)
!c                              = derivatives of concentrations of    * *
!c                                sorbed species with respect to
!c                                primary species (surface-complex)
!c           dratedp(nm,nthreads)        
!c                              = derivatives of absolute             * *
!c                                dissolution-precipitation
!c                                rates of minerals
!c                                [moles/(l bulk*day)]
!c           dtota(n)           = derivatives of total sorbed         * +
!c                                component concentrations
!c                                (non-competitive sorption)
!c                                [moles/l bulk]
!c           dtotaq(nc-1,nthreads)       
!c                              = derivative of total source-sink     * *
!c                                term towards total aqueous component
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions
!c           totaq(nc-1,nthreads)
!c                              = total source-sink term towards      * *
!c                                total aqueous component
!c                                concentrations due to intra-aqueous
!c                                kinetic reactions
!c           dtotc(n,nthreads)  = derivatives of total aqueous        * *
!c                                component concentrations
!c                                [moles/l water]
!c           dtotdp(n,nthreads) = derivatives of total source/sink    * *
!c                                term towards aqueous component
!c                                concentrations due to mineral
!c                                dissolution-precipitation reactions
!c                                [moles/(l bulk*day)]
!c           dtotor(n)          = derivatives of total source/sink    * *
!c                                term towards aqueous component
!c                                concentrations due to 
!c                                oxidation/reduction reactions
!c                                [moles/(l bulk*day)]
!c           dtotg(n)           = derivatives of total gaseous        * *
!c                                component concentrations
!c                                [moles/l air]
!c           dtotsb(n)          = derivatives of total source/sink    * *
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c           dtotsb_ion(n,nthreads)      
!c                              = derivatives of total source/sink    * *
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (ion-exchange)
!c           dtotsb_surf(n,nthreads)     
!c                              = derivatives of total source/sink    * *
!c                                term towards total aqueous
!c                                component concentrations due to
!c                                sorption reactions
!c                                [moles/(l bulk*day)]
!c                                (surface-complex)
!c           eqm(nm,nthreads)   = equilibrium constants for minerals  + -
!c           eqr(nr,nthreads)   = equilibrium constant for redox      + -
!c                                couple reaction equation
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           eqx(nx,nthreads)   = equilibrium constants for           + -
!c                                aqueous complexes
!c           ginc(ng,nthreads)  = gas concentrations dependent on     * *
!c                                incremented free species
!c                                concentrations
!c                                [moles/l air]
!c           rateaq(naq,nthreads) 
!c                              = reaction rates of intra-aqueous     * *
!c                                kinetic reaction
!c           rateor(nr,nthreads)= oxidation-reduction rate for        * *
!c                                redox couple [moles/(l h2o*day)
!c           rhobulk            = dry bulk density of porous medium   + -
!c           satm(nm,nthreads)  = saturation indices                  * *
!c           supsatm(nm)        = level of supersaturation required   + -
!c                                for precipitation [log cycles]
!c           tinyrate           = set reaction rates to zero,         + -
!c                                if smaller than tinyrate
!c           totcinc(n,nthreads)= total aqueous component             * +
!c                                concentrations - new time level
!c                                incremented [moles/l water]
!c           totdp(n,nthreads)  = total source/sink term towards      * *
!c                                total aqueous component 
!c                                concentrations due to mineral 
!c                                dissolution-precipitation 
!c                                reactions [moles/(l bulk*day)]
!c           totor(nc-1)        = total source/sink term towards      * *
!c                                aqueous component concentrations
!c                                due to oxidation/reduction
!c                                reactions [moles/(l bulk*day)]
!c           totrateg(nc-1)     = total rate for removal of aqueous   * *
!c                                components due to degassing
!c                                [mol L^-1 s^-1]
!c           totsb(n)           = total source/sink term towards      * *
!c                                total aqueous component
!c                                concentrations due to sorption
!c                                reactions [moles/(l bulk*day)]
!c           totsb_ion(n)       = total source/sink term towards      * *
!c                                total aqueous component 
!c                                concentrations due to sorption
!c                                reactions of ion-exchange
!c                                [moles/(l bulk*day)]
!c           totsb_surf(n)      = total source/sink term towards      * *
!c                                total aqueous component 
!c                                concentrations due to sorption
!c                                reactions of surface-complex 
!c                                [moles/(l bulk*day)]
!c           xnug(ng*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of gases from
!c                                free species
!c           xnum(nm*nc)        = stoichiometric coefficients of      + -
!c                                components in mineral
!c           xnur(nr*nc)        = stoichiometric coefficient of       + -
!c                                component in redox couple
!c                                reaction equation
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)= stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)=stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c           xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                                for formation of aqueous complexes
!c                                from components
!c
!c           integer*4:
!c           ----------
!c           iaga(ng+1)         = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           iam(nm+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in mineral
!c           iarc(nr+1)         = row pointer array to                + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iax(nx+1)          = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           jaga(ng*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in gases
!c           jam(nm*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                free species in mineral
!c           jarc(nr*nc)        = column pointer array to             + -
!c                                stoichiometric coefficients in
!c                                redox reaction
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jax(nx*nc)         = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in aqueous complexes
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nr                 = number of redox couples             + -
!c           nx                 = number of aqueous complexes         + -
!c           nsb                = number of sorbed species            + -
!c
!c           logical:
!c           --------
!c           far_from_equil(nm) = .true.  -> far from equilibrium     + -
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           new_database       = .true.  -> use new database format  + -
!c           noncompetitive_sorption = logical array for activation   + -   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c           temp_field         = .true.  -> nodal temperatures       + -
!c           update_activity(nthreads)
!c                              = 'no_update' -> unity activity       + -
!c                                 coefficients
!c                                'time_lagged' -> update activity
!c                                 coefficients after each time step
!c                                'double_update' -> double update
!c                                 of activity coefficients during
!c                                 Newton iterations
!c           character:
!c           ----------
!c           component_type(nc) = 'aqueous' = aqueous component       + -
!c                                'surface' = surface site
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c           sorption_type_ion  = 'gaines-thomas'                     + -
!c                                'gapon'
!c           sorption_type_surf = 'surface-complex'                   + -
!c                                'constant-capacitance'
!c
!c local:    real*8:
!c           -------
!c           dgflux             = derivative of interfacial mass
!c                                flux (gaseous phase)
!c           dissvol            = mineral mass to be dissolved
!c           dcflux             = derivative of interfacial mass
!c                                flux (aqueous phase)
!c           drtinc             = increment for numerical 
!c                                differentiation
!c           dgstor             = derivative of storage term
!c                                (gaseous phase)
!c           dcstor             = derivative of storage term 
!c                                (water phase)
!c           r0                 = constant
!c           r1                 = constant
!c           small              = small increment
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter (entries in ja, a arrays 
!c                                         for 1d-scalar matrix)
!c           i2                 = pointer (entries in ja, a arrays
!c                                         for nd-scalar matrix)
!c           iaq                = counter (intra-aqueous kinetic 
!c                                         reactions)
!c           ibl                = counter (rows of block matrix)
!c           ic                 = counter (components)
!c           icon               = pointer (off-diagonal connections)
!c           idiag              = pointer (diagonal of 1d-scalar 
!c                                         matrix)
!c           iend               = pointer (last off-diagonal entry 
!c                                         in row for 1d-scalar 
!c                                         matrix)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           ir                 = counter (redox couples)
!c           isb                = counter (sorbed species)
!c           irow               = pointer (row in rhs-vector)
!c           istart             = pointer (first off diagonal entry 
!c                                         in row for 1d-scalar 
!c                                         matrix)
!c           isym               = symmetry pointer (1d-scalar 
!c                                                  matrix)
!c           ivol               = counter (control volumes)
!c           ix                 = counter (complexed species)
!c           jbl                = counter (columns of block matrix)
!c           jvol               = pointer (column in 1d-scalar 
!c                                         matrix)
!c           ldiag              = pointer (diagonal block in global 
!c                                         block matrix)
!c           lsym               = symmetry pointer (global block 
!c                                                  matrix)
!c           info_debug         = 0 -> no debugging information
!c                              = 1 -> write debugging information to
!c                                     prefix_o.dbg
!c                              = 2 -> write debugging information to
!c                                     prefix_o.dbg and quit
!c
!c external: acoff     = compute activity coefficient
!c           bulkconc  = convert from [moles/l water] to 
!c                       [moles/l bulk]
!c           comptotc  = compress concentration vector, if number
!c                       of unknowns is reduced due to redox
!c                       equilibrium reactions
!c           drategas  = compute derivatives of degassing rates
!c           drateint  = compute derivative of reaction rate
!c                       of intra-aqueous kinetic reaction
!c           drateint_new  = compute derivative of reaction rate
!c                       of intra-aqueous kinetic reaction (new
!c                       database format)
!c           dratemin  = compute numerical derivative of absolute 
!c                       dissolution-precipitation rates of minerals
!c           dratemin_new  = compute numerical derivative of absolute 
!c                       dissolution-precipitation rates of minerals
!c                       (new database format)
!c           aratemin  = compute analytical derivative of absolute 
!c                       dissolution- precipitation rates of minerals
!c           draterdx  = compute derivative of total oxidation/
!c                       reduction rates for redox couples in terms 
!c                       of total aqueous component concentrations
!c           dtotconc  = compute numerical derivatives of total aqueous
!c                       component concentrations
!c           atotconc  = compute analytical derivatives of total aqueous
!c                       component concentrations
!c           dtotcong  = compute derivative of total gaseous
!c                       component concentrations
!c           fluxd     = diffusive/dispersive flux
!c           fluxv     = advective flux
!c           fluxv_vl  = advective flux (Van Leer flux limiter)
!c           gasconc   = compute gas concentrations based on 
!c                       concentrations of free species
!c           molconc   = compute average molar concentration for 
!c                       organic mixture
!c           rategas   = compute degassing rates
!c           rateint   = compute rate for intra-aqueous kinetic 
!c                       reactions
!c           rateint_new   = compute rate for intra-aqueous kinetic 
!c                       reactions (new database format)
!c           ratemin   = compute absolute dissolution-precipitation
!c                       rates of minerals
!c           ratemin_new  = compute absolute dissolution-precipitation
!c                       rates of minerals (new database format)
!c           rateredx  = compute oxidation/reduction rates for 
!c                       redox couples
!c           rhsrt     = construct rhs-vector (reactive transport)
!c           secspec   = compute aqueous complex concentration
!c                       based on concentrations of free species
!c           sorbspc   = compute concentration of sorbed species
!c           tcorr     = temperature correction for debye-huckel,
!c                       equilibrium and rate constants
!c           totcona   = compute total sorbed component
!c                       concentrations (non-competitive sorption)
!c           totconc   = compute total aqueous component
!c                       concentrations based on concentrations 
!c                       of free species and secondary aqueous 
!c                       species
!c           totconcg  = compute total gaseous component 
!c                       concentrations based on concentrations 
!c                       of gases
!c           totint    = compute total source-sink terms towards
!c                       total aqueous component concentrations
!c                       due to intra-aqueous reactions
!c           totmin    = compute total source/sink terms towards 
!c                       towards total aqueous component concentrations
!c                       due to mineral dissolution-precipitation 
!c                       reactions in [moles/(l bulk x day)]
!c           totredx   = compute total source/sink terms towards 
!c                       total aqueous component concentrations
!c                       due to oxidation/reduction reactions
!c                       in [moles/(l bulk x day)]
!c           totsorb   = compute total sorbed component concentrations
!c                       [moles/l bulk]
!c           updtsvap  = update secondary variables in aqueous 
!c                       phase
!c ----------------------------------------------------------------------
 
      subroutine flux_calc(ivol,tid)
 
      use parm
      use gen
      use chem
      use multidiff, only: cinfrt_mcd
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef USG
      use math_common
      use geometry
      use mod_fluxd_usg
      use usg_mesh_data, only : num_edge_dvols, num_edge_maxcells,     &
                                num_nodes_per_cell, grad_method
      use gradient_usg, only : gradient_cross_diff_md,                 &
                               gradient_cross_diff_rt,                 &
                               gradient_cross_diff_rt_average
      use usg_face_utility, only : usg_face_utility_cinfrt_da,         &
                                   usg_face_utility_cinfrt_mcd
#endif

      implicit none
      
      integer :: ivol, tid
      
      integer :: i1, ic, icon, izn, istart, iend, idiag, jvol
      
      real*8, external :: bulkconc, fluxd, fluxv_vl
      
!c mcd variables     
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, small = 1.d-10     

#ifdef USG
      integer :: icell, idvol, kvol, ndvol, ncell
      real*8 :: grad_weights(num_crossdifficv_max)
      real*8 :: flux_totcnew_hls_corr(num_edge_dvols,num_edge_maxcells),     &
                flux_totviscnew_hls_corr(num_edge_dvols,num_edge_maxcells),  &
                flux_electro_hls_corr(num_edge_dvols,num_edge_maxcells)
      type(point) :: grad_locs(num_crossdifficv_max)
      type(point) :: grad_totcnew_mids(num_edge_dvols,num_edge_maxcells),    &
                     grad_totviscnew_mids(num_edge_dvols,num_edge_maxcells), &
                     grad_electro_mids(num_edge_dvols,num_edge_maxcells),    &
                     grad_totcnew_ivol(n), grad_totcnew_jvol(n),           &
                     grad_totviscnew_ivol(n), grad_totviscnew_jvol(n),     &
                     grad_electro_ivol(n), grad_electro_jvol(n),           &
                     grad_totcnew_kvol(n,num_nodes_per_cell,num_edge_maxcells), &
                     grad_totviscnew_kvol(n,num_nodes_per_cell,num_edge_maxcells), &
                     grad_electro_kvol(n,num_nodes_per_cell,num_edge_maxcells)
      type(grad_hls_term) :: grad_totcnew_hls_loc(n,num_edge_dvols,num_edge_maxcells),  &
                             grad_totviscnew_hls_loc(n,num_edge_dvols,num_edge_maxcells),  &
                             grad_electro_hls_loc(n,num_edge_dvols,num_edge_maxcells)

      real*8 :: cinfrt_da_usg_loc(num_edge_dvols,num_edge_maxcells)
      type(point) :: cinfrt_da_usg_cross_loc(num_edge_dvols,num_edge_maxcells)
      real*8 :: cinfrt_mcd_usg_loc(num_edge_dvols,num_edge_maxcells)
      type(point) :: cinfrt_mcd_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

      type(point) :: grad_cgg_totcnew(n,num_edge_dvols,num_edge_maxcells)
      type(point) :: grad_cgg_totviscnew(n,num_edge_dvols,num_edge_maxcells)
      type(point) :: grad_cgg_electro(n,num_edge_dvols,num_edge_maxcells)
#endif

      external acoff, atotconc, aratemin, comptotc, dtotconc,          &
               dtotcong, molconc,secspec, totcona, totconc, totconcg,  &
               totint, totmin, totredx, elecmigration, tcorr, updtsvap           

!cdsu This part is buggy. It changes concentration when the flux output is used.
!cdsu Comment to disable this part.
!cdsu ************************** Begin *******************************
!cdsu               
!cdsu !c  compute storage flux terms
!cdsu 
!cdsu !      do ivol = 1,nngl                 !loop over control volumes
!cdsu 
!cdsu !c  temperature corrections for debye-huckel, equilibrium and 
!cdsu !c  rate constants 
!cdsu 
!cdsu         if (temp_corr.or.heat_transport) then
!cdsu           call tcorr(tkel(ivol),tid)
!cdsu         end if
!cdsu  
!cdsu !c  constant activity coefficients
!cdsu !c  -> update only concentrations of secondary aqueous species
!cdsu !c     and compute ionic strength
!cdsu 
!cdsu         call updtsvap(cnew(1,ivol),cx(1,ivol),gamma(1,ivol),    &
!cdsu      &                gamma(nc+1,ivol),sionnew(ivol),tid)
!cdsu         
!cdsu         if (hmulti_diff) then
!cdsu           call updtsvap(c(1,ivol),cxold(1,ivol),gammaold(1,ivol),        &
!cdsu      &                  gammaold(nc+1,ivol),sionold(ivol),tid)  
!cdsu         end if       !MX test
!cdsu 
!cdsu 
!cdsu !c  variable activity coefficients
!cdsu !c  -> double update of secondary variables 
!cdsu !c     - activitiy coefficients
!cdsu !c     - concentrations of secondary aqueous species
!cdsu !c     - ionic strength
!cdsu  
!cdsu         if (update_activity(tid).eq.'double_update') then
!cdsu 
!cdsu           call updtsvap(cnew(1,ivol),cx(1,ivol),gamma(1,ivol),    &
!cdsu      &                  gamma(nc+1,ivol),sionnew(ivol),tid)
!cdsu 
!cdsu         end if
!cdsu 
!cdsu !c  compute total aqueous component concentrations
!cdsu 
!cdsu         call totconc(cnew(1,ivol),cx(1,ivol),totcnew(1,ivol))
!cdsu         
!cdsu !c Calculate the secondary species concentrations totcnewf and totcoldf
!cdsu         if (hmulti_diff) then
!cdsu             izn = mpropvs(ivol)
!cdsu                 
!cdsu !c  compute total concentrations of aqueous primary and secondary
!cdsu !c  species times the correction factors
!cdsu                 
!cdsu             call totconcfac(cnew(1,ivol),cx(1,ivol),totcnewf(1,ivol),izn)
!cdsu             call totconcfac(c(1,ivol),cxold(1,ivol),totcoldf(1,ivol),izn)
!cdsu 
!cdsu         end if
!cdsu 
!cdsu 
!cdsu !      end do                         !loop over control volumes
!cdsu **************************  End  *******************************

!c  construct rhs-vector and jacobian matrix

!      do ivol=1,nngl                   !loop over control volumes

!c  get row pointers

        idiag = iavs(ivol)           !diagonal
        istart = iavs(ivol)+1        !start - off-diagonal connections
        iend = iavs(ivol+1)-1        !end   - off-diagonal connections

#ifdef OPENMP
        tid = omp_get_thread_num() + 1
#else
        tid = 1
#endif        

!c  compute storage terms (aqueous phase)
!c  exclude non-aqueous components (surface sites) because 
!c  total surface concentrations remain constant

        do ic=1,n
!c Calculate the secondary species concentrations cxold - old time level !MX
          if (hmulti_diff) then
              izn = mpropvs(ivol)
                
!c  compute total concentrations of aqueous primary and secondary
!c  species times the correction factors
                
              cstor(ic) = cvol(ivol)/delt            &
     &                * (bulkconc(totcnewf(ic,ivol),    &
     &                            sanew(ivol),        &
     &                            pornew(ivol))        &
     &                -  bulkconc(totcoldf(ic,ivol),    &
     &                            saold(ivol),        &
     &                            porold(ivol)))
          else

            cstor(ic) = cvol(ivol)/delt            &
     &                * (bulkconc(totcnew(ic,ivol),    &
     &                            sanew(ivol),        &
     &                            pornew(ivol))        &
     &                -  bulkconc(totcold(ic,ivol),    &
     &                            saold(ivol),        &
     &                            porold(ivol)))
          end if

        end do

!c  compute fluxes between current control volume and adjacent
!c  control volumes and total flux into current control volume

        icon = 0                   !zero counter - connections

        do ic=1,n
          totcflux(ic) = r0        !zero total influx (aqueous phase)
        end do

        do i1 = istart,iend        !off-diagonal connections

          icon = icon+1            !current connection
          jvol = javs(i1)          !column pointer

#ifdef USG
          if (discretization_type > 0) then
            ncell = janumcell(i1)
          end if
#endif

          if (multi_diff) then

            call totdyvisc(ivol,jvol,cnew(:,ivol),cx(:,ivol),          &
                           cnew(:,jvol),cx(:,jvol),                    &
                           delta_totviscnew(:,tid))

            call elecmigration(ivol,jvol,cnew(:,ivol),cx(:,ivol),      &
                               cnew(:,jvol),cx(:,jvol),                &
                               delta_electromignew(:,tid))
          end if

! cdsu -------------------------------------------------------
! cdsu gradient reconstruction for reactive transport
! cdsu -------------------------------------------------------
#ifdef USG
          if (discretization_type > 0) then
            if (b_use_cross_diffusion_react) then
              if (multi_diff) then
                call gradient_cross_diff_md(i1,ivol,jvol,                    &
                              grad_totviscnew_ivol,grad_totviscnew_jvol,     &
                              grad_totviscnew_kvol,grad_electro_ivol,        &
                              grad_electro_jvol,grad_electro_kvol,           &
                              grad_totviscnew_hls_loc,grad_electro_hls_loc,  &
                              grad_cgg_totviscnew,grad_cgg_electro)
              else
                call gradient_cross_diff_rt(i1,ivol,jvol,n,totcnew,    &
                              grad_totcnew_ivol,grad_totcnew_jvol,     &
                              grad_totcnew_kvol,grad_totcnew_hls_loc,  &
                              grad_cgg_totcnew)
              end if              
            end if
!cdsu
!cdsu calculate influence coefficient
!cdsu
            call usg_face_utility_cinfrt_da(ivol,jvol,i1,              &
                     cinfrt_da_usg_loc,cinfrt_da_usg_cross_loc)

            if (multi_diff) then
              call usg_face_utility_cinfrt_mcd(ivol,jvol,i1,           &
                       cinfrt_mcd_usg_loc,cinfrt_mcd_usg_cross_loc)
            end if

          end if
#endif

          do ic=1,n                !loop over primary unknowns

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
#ifdef USG
            if (discretization_type > 0) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
              grad_totcnew_mids = vector_zero
              grad_totviscnew_mids = vector_zero
              grad_electro_mids = vector_zero
              flux_totcnew_hls_corr = r0
              flux_totviscnew_hls_corr = r0
              flux_electro_hls_corr = r0

              if (b_use_cross_diffusion_react) then
                if (multi_diff) then
                  call gradient_cross_diff_rt_average(ic,n,i1,ivol,    &
                       jvol,grad_totviscnew_ivol,grad_totviscnew_jvol, &
                       grad_totviscnew_kvol,grad_totviscnew_hls_loc,   &
                       grad_weights,grad_locs,grad_totviscnew_mids,    &
                       flux_totviscnew_hls_corr,grad_cgg_totviscnew)

                  call gradient_cross_diff_rt_average(ic,n,i1,ivol,    &
                       jvol,grad_electro_ivol,grad_electro_jvol,       &
                       grad_electro_kvol,grad_electro_hls_loc,         &
                       grad_weights,grad_locs,grad_electro_mids,       &
                       flux_electro_hls_corr,grad_cgg_electro)
                else
                  call gradient_cross_diff_rt_average(ic,n,i1,ivol,    &
                       jvol,grad_totcnew_ivol,grad_totcnew_jvol,       &
                       grad_totcnew_kvol,grad_totcnew_hls_loc,         &
                       grad_weights,grad_locs,grad_totcnew_mids,       &
                       flux_totcnew_hls_corr,grad_cgg_totcnew)
                end if
              end if
            end if
#endif

!c  compute aqueous phase flux

            if (multi_diff) then

#ifdef USG
              if (discretization_type > 0) then
                cflux(icon,ic) = fluxv_vl(totcnew(ic,ivol), totcnew(ic,jvol),ivol,jvol,          & !advective term
                                          cinfrt_va_usg(i1),ic)                                  &
                           - fluxd_usg(r0,delta_totviscnew(ic,tid),                              & !diffusive term
                                      num_edge_dvols,janumcell(i1),                              &
                                      grad_totviscnew_mids(1:num_edge_dvols,1:janumcell(i1)),    &
                                      flux_totviscnew_hls_corr(1:num_edge_dvols,1:janumcell(i1)),&
                                      cinfrt_mcd_usg_loc(1:num_edge_dvols,1:janumcell(i1)),      &
                                      cinfrt_mcd_usg_cross_loc(1:num_edge_dvols,1:janumcell(i1)))&
                           - fluxd_usg(r0,delta_electromignew(ic,tid),                           & !electromigration term
                                      num_edge_dvols,janumcell(i1),                              &
                                      grad_electro_mids(1:num_edge_dvols,1:janumcell(i1)),       &
                                      flux_electro_hls_corr(1:num_edge_dvols,1:janumcell(i1)),   &
                                      cinfrt_mcd_usg_loc(1:num_edge_dvols,1:janumcell(i1)),      &
                                      cinfrt_mcd_usg_cross_loc(1:num_edge_dvols,1:janumcell(i1)))
              else
#endif

                cflux(icon,ic) = fluxv_vl(totcnew(ic,ivol),            &  !advective term
                                      totcnew(ic,jvol),                &
                                      ivol,jvol,                       &
                                      cinfrt_va(i1),ic)                &
                               - fluxd(r0,delta_totviscnew(ic,tid),    & !diffusive term
                                       cinfrt_mcd(i1))                 &
                               - fluxd(r0,delta_electromignew(ic,tid), & !electromigration term
                                       cinfrt_mcd(i1))
#ifdef USG
              end if
#endif
        
            else

#ifdef USG
              if (discretization_type > 0) then
                cflux(icon,ic) = fluxv_vl(totcnew(ic,ivol), totcnew(ic,jvol),ivol,jvol,          & !advective term
                                          cinfrt_va_usg(i1),ic)                                  &
                               - fluxd_usg(totcnew(ic,ivol),totcnew(ic,jvol),                    & !dispersive term
                                       num_edge_dvols,janumcell(i1),                             &
                                       grad_totcnew_mids(1:num_edge_dvols,1:janumcell(i1)),      &
                                       flux_totcnew_hls_corr(1:num_edge_dvols,1:janumcell(i1)),  &
                                       cinfrt_da_usg_loc(1:num_edge_dvols,1:janumcell(i1)),      &
                                       cinfrt_da_usg_cross_loc(1:num_edge_dvols,1:janumcell(i1)))

              else
#endif
           
                cflux(icon,ic) = fluxv_vl(totcnew(ic,ivol),            & !advective term
                                      totcnew(ic,jvol),                &
                                      ivol,jvol,                       &
                                      cinfrt_va(i1),ic)                &
                           - fluxd(totcnew(ic,ivol),                   & !dispersive term
                                   totcnew(ic,jvol),                   &
                                   cinfrt_da(i1))
#ifdef USG
              end if
#endif

            end if

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!      no mass flux between them
           if (pore_clogging) then
             if (pornew(ivol) <= por_thresh_min   .or.                 &
                 pornew(jvol) <= por_thresh_min)  then
               cflux(icon,ic) = r0
             end if        
           end if        
        
!c  total influx

            if (ivol.eq.1) then
              totcflux(ic) = totcflux(ic) - cflux(icon,ic)
          
            else
              totcflux(ic) = totcflux(ic) + cflux(icon,ic)
            end if
            
          end do                   !loop over components
        end do                     !off-diagonal connections
!      end do                      !loop over control volumes

      return
      end
