!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/infcrt_mcd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

    
!c --------------------------------------------------------------------------
!c subroutine infcrt_mcd
!c -------------------
!c 
!c compute influence coefficients for diffusive flux terms 
!c for rectangular, cartesian finite volume discretization
!c (reactive transport)
!c 
!c written by:      Uli Mayer - September 21, 96
!c 
!c last modified:   Pejman Rasouli - August, 2011 
!c                  modified to assign values to variables 
!c                  used in Multicomponent Diffusion subroutines
!c 
!c                  Danyang Su - March 14, 2014
!c                  HPC capabilities
!c 
!c definition of variables:
!c 
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                        I O
!c     input:
!c 
!c        d(1-3, ibk) - dimension of cells in x,y,z direction
!c        diffu - phase molecular diffusion (m2/day)
!c        ibk - block i
!c        id - connected block j
!c        idbg - output for debugging information
!c        ilog - unit number, logbook
!c        half_cells -  =.true.  -> half cells on boundary
!c        nmax - max cells for dim purposes (ncomp.com)
!c        nphas - max number of phases (ncomp.com)
!c        njamxc - max dim ja array (ncomp.com)
!c        nvx, nvy, nvz - number of cells in x,y,z dir
!c        pornew(ibk) - porosity
!c        sanew(nmax) - aqueous phase saturation
!c        ia(), ja() - ysmp pointers
!c        isymm(ii) - symmetry pointer for cell ibk
!c        tortuosity_corr    = .true.  -> Millington-Quirk
!c                                         tortuosity correction
!c                                         for diffusion
!c                                         coefficients
!c 
!c 

!c     output:
!c 
!c        cinfrt_mcd() - area / dx * saturation * porosity 
!c                      influence coefficients
!c        deltaij     - distance between i and j [m]
!c        tauij       - tortusosity correction for gas diffusion 
!c        porij       - water filled porosity at interface i-j
!c        satij       - water saturation at interface i-j
!c 
!c passed:   -
!c 
!c common:   -
!c 
!c local:
!c 
!c external: 
!c           
!c --------------------------------------------------------------------------
      subroutine infcrt_mcd (nvx, nvy, nvz, ia, ja, isymm,            &
                          cinfrt_mcd, d, pornew, sanew,               &
                          idbg, ilog, njamxc, nmax, tortuosity_corr,  &
                          half_cells, deltaij, tauij,                 &
                          porij,satij, type_ave_De, assigned_tau,     &
                          tau,type_tortuosity,marchies,cinfrad,       &
                          radial_coord, multi_diff, tau_fac, sonew)
#ifdef OPENMP
      use omp_lib 
#endif

      use mod_diffcoff, only : diffcoff
      use chem, only : namec, chargec, chargex, xnux, iax, jax

      use gen, only :                                                &
#ifdef OPENMP
                      numofthreads_global,                           &
                      numofloops_thred_global,                       &
                      numofloops_thred_infcrt_mcd_1,                 &
                      numofloops_thred_infcrt_mcd_2,                 &
#endif
                      tor_corr_a_mq, tor_corr_b_mq,                  &
                      njavs, nngl, is_javsrec_set, javsrec,          &
                      rank, b_enable_output

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none

      integer nvx, nvy, nvz, njamxc, nmax, jtemp, naver,             &
              ia(nmax+1), ja(njamxc), isymm(njamxc), idbg, ilog

      logical half_cells, tortuosity_corr, assigned_tau,             &
              radial_coord, multi_diff 

      real*8  diffu, pornew(nmax), sanew(nmax),                      &
              d(3,nmax), cinfrt_mcd(njamxc), deltaij(njamxc),        &
              tauij(njamxc), porij(njamxc), satij(njamxc),           &
              tau_man(nmax), tau(nmax),cinfrad(njamxc),              &
              tau_fac(nmax), marchies(nmax), sonew(nmax) 

      real*8 :: tauloc, tort
      
#ifdef OPENMP      
      integer :: nvols
#endif
      
      character(len=*) :: type_ave_De, type_tortuosity 

!c     local variables

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r2 = 2.0d0,         &
                           rhalf = 0.5d0

      real*8 aread(3,12), porav, satav, tend(3), diffav, diff_eff,     &
             areax(3,12), dd(3,12), so_av,                             &  ! tauav, CMX
             dist(3,12), marchieav   
      
      integer i, ic, ix, ibk, ivz, ivy, ivx, ii, id, iisav,            &
              istart, iend, ivol, jvol, idim, ndim, ipair,             &
              idim2, idim3, info_debug,                                &
              npair(3), iface(3,12), fvpair(3,12,2) 

      dd(1:3,1:12) = r0
      
#ifdef OPENMP      
      nvols = nvx * nvy * nvz
#endif

!c  compute influence coefficients for diffusive flux terms
!c  in gas phase

!c  zero the influence coefficient for diffusive flux term
      
      cinfrt_mcd = r0
      deltaij = r0
      porij = r0
      tauij = r0
      satij = r0

!c  loop over control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nvols > numofloops_thred_infcrt_mcd_2)                  &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ibk, id, idim, idim2, idim3, iface, ii, iisav,     &
    !$omp ipair, i, ic, ix, ivx, ivy, ivz, ndim, istart, iend,        &
    !$omp fvpair, npair, aread, areax,                                &
    !$omp diffav, diff_eff, dist, marchieav, porav, satav, tauloc,    &
    !$omp tend, tort)                                                 
    !$omp do schedule(static)
#endif
      do ivz = 1, nvz            !increments in z-direction
        do ivy = 1, nvy         !increments in y-direction
          do ivx = 1, nvx      !increments in x-direction

!c  find node pairs for elemental velocities as well
!c  as influence coefficient for node pairs within dipersion element

!CMX               call cliqdisp (nvx, nvy, nvz, ivx, ivy, ivz,
!     &                        fvpair, npair, aread, d, half_cells,
!     &                        nmax,idbg,dd)
            call cliqdisp(nvx, nvy, nvz, ivx, ivy, ivz,               &
                          fvpair, npair,                              &
                          aread,areax,dist,d,half_cells,ia,ja, njamxc,& 
                          nmax, idbg, cinfrad, radial_coord)

!c  check if fully connected "pseudo dispersion element"
!c  was found for dimensionality of problem

            if ((nvx .gt. 1 .and. npair(1) .eq. 0) .or.        &
                (nvy .gt. 1 .and. npair(2) .eq. 0) .or.        &
                (nvz .gt. 1 .and. npair(3) .eq. 0)) cycle

!c              loop over the dimensions x,y,z

              do idim = 1, 3

                idim2 = idim + 1
                idim3 = idim + 2
                if (idim2 .gt. 3) idim2 = idim2 - 3
                if (idim3 .gt. 3) idim3 = idim3 - 3

!c  loop over the number of node pairs in the dimension

                do ipair = 1, npair(idim)

                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)

                  do ii = ia(ibk), ia(ibk+1)-1
                    if (ja(ii) .eq. id) then
                      iisav = ii
                      go to 431
                    endif
                  end do
                  if (rank == 0) then
                    write(ilog,*) ' error-cannot find id in list-infcrt_mcd'
                    write(ilog,*) ' ibk, id ', ibk, id
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
431               continue
                  iface(idim, ipair) = iisav

                end do
              end do


!c  average porosity of the element
!c  note: each node is included in "ndim" number of node
!c        pairs, therefore the average must be divided
!c        by ndim as well as the number of nodes in the
!c        element

              porav = r0
              do idim = 1, 3
                do ipair = 1, npair(idim)
                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)
                  porav = porav  + min(r1, pornew(ibk)) + min(r1, pornew(id))
                end do
              end do 

              ndim = 0
              if (nvx .gt. 1) ndim = ndim + 1
              if (nvy .gt. 1) ndim = ndim + 1
              if (nvz .gt. 1) ndim = ndim + 1
              porav = porav / float(ndim) / r2**ndim


!c  average tortuosity of the element
!c  note: each node is included in "ndim" number of node
!c        pairs, therefore the average must be divided
!c        by ndim as well as the number of nodes in the
!c        element
              if (assigned_tau) then
                tauloc = r0
                do idim = 1, 3
                  do ipair = 1, npair(idim)
                     ibk = fvpair(idim, ipair, 1)
                     id = fvpair(idim, ipair, 2)
                     !tauloc = tauloc                               &
                     !      + min( r1, tau(ibk) * tau_fac(ibk) )    &
                     !      + min( r1, tau(id) * tau_fac(id) )
                     tauloc = tauloc                                &
                            + tau(ibk) * tau_fac(ibk)               &
                            + tau(id) * tau_fac(id) 
                  end do
                end do 

                ndim = 0
                if (nvx .gt. 1) ndim = ndim + 1
                if (nvy .gt. 1) ndim = ndim + 1
                if (nvz .gt. 1) ndim = ndim + 1
                tauloc = tauloc / float(ndim) / r2**ndim
              end if
           
!c  calculate average diffusion coefficients for the "pseudo
!c  dispersion element"

!cdsu------------------------------------------------------------------
!cdsu  This section is redundant as diffu is not initialized and diffav 
!cdsu  is reset later. DSU, 2014-08-10.
!cdsu
!c               diffav = r0
!c
!c               do idim = 1, 3                      !loop over dimensions
!c                  do ipair = 1, npair(idim)        !node pairs
!c
!c                     ibk = fvpair(idim, ipair, 1)
!c                     id = fvpair(idim, ipair, 2)
!c
!c                     diffav = diffav + r2 * diffu
!c
!c                  end do                           !node pairs
!c               end do                              !dimensions 
!c
!c               diffav = diffav / float(ndim) / r2**ndim
!cdsu------------------------------------------------------------------

!c  calculate the diffusion tensor for the "pseudo diffusion element"
!c  average porosity of the element

              satav = r0
              so_av = r0
!CMX          tauav = r0

              do idim = 1, 3
                do ipair = 1, npair(idim)
                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)

                  satav = satav + min(r1, sanew(ibk)) + min(r1, sanew(id))
                    
                  so_av = so_av + dmin1(r1, sonew(ibk)) + dmin1(r1, sonew(id)) 

!CMX              tauav = tauav + dmin1(r1, tau_man(ibk)) + dmin1(r1, tau_man(id))
                end do
              end do

              satav = satav / float(ndim) / r2**ndim
              so_av = so_av / float(ndim) / r2**ndim

!CMX          tauav = tauav / float(ndim) / r2**ndim


!c  calculate the average marchie factor

              marchieav = r0
              do idim = 1, 3
                do ipair = 1, npair(idim)
                  ibk = fvpair(idim, ipair, 1)
                  id = fvpair(idim, ipair, 2)
                  marchieav = marchieav + marchies(ibk) + marchies(id)
                end do
              end do
              marchieav = marchieav / float(ndim) / r2**ndim 

!c  calculate effective diffusion coefficient           

              diffav = r1
               
              diff_eff = diffcoff(diffav,satav,porav,tortuosity_corr,    &
                                  assigned_tau,tauloc,type_tortuosity,   &
                                  marchieav,so_av,                       &
                                  tor_corr_a_mq,tor_corr_b_mq)

              tend(1) = r1  !diff_eff
              tend(2) = r1  !diff_eff
              tend(3) = r1  !diff_eff

!c  added for Multi-Diff

              tort = diff_eff / diffav / porav  ! tortuosity

!c  build total influence coefficient from all elemental contributions
#ifdef OPENMP
    !$omp critical
#endif 
              do idim = 1, 3                 !loop over dimensions
                do ipair = 1, npair(idim)   !node pairs

                  iisav = iface(idim, ipair)

                  !c the new code uses the average value
                  if (.not. is_javsrec_set) then
                    javsrec(iisav) = javsrec(iisav)+1
                    javsrec(isymm(iisav)) = javsrec(isymm(iisav))+1
                  end if

                  cinfrt_mcd(iisav) = cinfrt_mcd(iisav) +                   &
                                      tend(idim) * aread(idim, ipair)


                  cinfrt_mcd(isymm(iisav)) = cinfrt_mcd(isymm(iisav)) +     &
                                             tend(idim) * aread(idim, ipair)
     
                  !c fix bug below, DSU, May 10, 2019
                  !c these variables should be added as each of the same
                  !c iisav is looped more than once. For example,
                  !c given mesh with 17x1x25 nodes, for such a 2D problem,
                  !c ivx=15, ivy=1, ivz=13, idim=1, ipair=1 ==> iisav = 1050
                  !c ivx=15, ivy=1, ivz=14, idim=1, ipair=2 ==> iisav = 1050
                  !c old code example: gsatij(iisav) = satav
                  !c old code example: gsatij(isymm(iisav)) = satav

                  !c the old code uses the second one
                  !deltaij(iisav)          = dd(idim, ipair)
                  !deltaij(isymm(iisav))   = dd(idim, ipair)
                  !
                  !porij(iisav)            = porav
                  !porij(isymm(iisav))     = porav
                  !
                  !tauij(iisav)            = tort
                  !tauij(isymm(iisav))     = tort
                  !
                  !satij(iisav)            = satav
                  !satij(isymm(iisav))     = satav


                  deltaij(iisav)          = deltaij(iisav) + dist(idim, ipair)
                  deltaij(isymm(iisav))   = deltaij(isymm(iisav)) + dist(idim, ipair)

                  porij(iisav)            = porij(iisav) + porav
                  porij(isymm(iisav))     = porij(isymm(iisav)) + porav

                  tauij(iisav)            = tauij(iisav) + tort
                  tauij(isymm(iisav))     = tauij(isymm(iisav)) + tort

                  satij(iisav)            = satij(iisav) + satav
                  satij(isymm(iisav))     = satij(isymm(iisav)) + satav
                    
                end do                      !node pairs
              end do                         !loop over dimensions
#ifdef OPENMP
    !$omp end critical
#endif 
            end do
         end do   
      end do  
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  

      is_javsrec_set = .true.
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (njavs > numofloops_thred_infcrt_mcd_2)                  &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, istart, iend, jvol, jtemp, naver)
    !$omp do schedule(static)
#endif
      do ivol = 1, nngl
        istart = ia(ivol)+1
        iend = ia(ivol+1)-1
        do jtemp = istart, iend  !c loop over connection
          jvol = ja(jtemp)
          naver = javsrec(jtemp)
          if (naver > 1) then
            deltaij(jtemp) = deltaij(jtemp)/naver
            porij(jtemp) = porij(jtemp)/naver
            tauij(jtemp) = tauij(jtemp)/naver
            satij(jtemp) = satij(jtemp)/naver   
          end if
        end do
      end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

!cdbg
#ifdef DEBUG
      info_debug = 0
      if (info_debug.gt.0) then
      
      do ibk = 1,nmax
        do ii = ia(ibk),ia(ibk+1)-1
          write(idbg,'(a,i4,a,es12.3,/)')        &                       !Previous format '(a,i4,a,es12.3)/' is not correct. The extra characters "/" in the format specification will be ignored.
     &          'cinfrt_mcd(',ii,') = ',cinfrt_mcd(ii)
        end do
      end do
      
      do ibk = 1,nmax
        do ii = ia(ibk),ia(ibk+1)-1
          write(idbg,'(a,i4,a,es12.3,/)')        &
     &          'deltaij(',ii,') = ',deltaij(ii)
        end do
      end do
            
      do ibk = 1,nmax
        do ii = ia(ibk),ia(ibk+1)-1
          write(idbg,'(a,i4,a,es10.3,/)')        &
     &          'porij(',ii,') = ',porij(ii)
        end do
      end do

      do ibk = 1,nmax
        do ii = ia(ibk),ia(ibk+1)-1
          write(idbg,'(a,i4,a,es10.3,/)')        &
     &          'tauij(',ii,') = ',tauij(ii)
        end do
      end do
      
      write(idbg,*) 'wrote to dbg from infcrt_mcd.f'
      
!      pause
!#ifdef PETSC
!      call petsc_mpi_finalize
!#endif
!      stop
      
      end if !(info_debug.gt.0)
#endif
!cdbg

      return
      end

