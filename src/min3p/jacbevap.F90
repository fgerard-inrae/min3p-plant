!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/jacbevap.F90 $
!---------------------------------------------------------------------
!********************************************************************!

subroutine jacbevap(ivol,typeequation,totwflux_atm,tothflux_atm) 
 
  use parm
  use gen
  use dens
  use phys 
  use chem
#ifdef PETSC
  use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
  implicit none
     
  character(len=*), intent(in)  :: typeequation
  integer, intent(in)           :: ivol
  real*8, intent(out)           :: totwflux_atm, tothflux_atm

  ! Local variables

  character(len=100)            :: typebc

  logical                       :: comp_der

  real*8  :: latvaploc, area_ivol, actw, densinc_ivol, densvinc_ivol,    &
             dflux, dummy, dummy1, dummy2, dummy3, dummy4,               &
             evapinc_temp, evapinc_pa, heatflux, heatfluxinc, hrunoff,   &
             hrunoffinc, porinc_ivol, rain,                              &
             radnetinc, rhinc, rhonew, runoffinc, sainc_ivol,            &
             sawinc_ivol, tempinc_ivol, uvsinc_ivol, aentry_loc

  !cdsu bug here, evap_atm is a global variable and control volume dependent.
  !cdsu use a local variable instead, otherwise, only the last changed value
  !cdsu is used outside this function.
  real*8 :: evap_atm_ivol, sheat_atm_ivol, rh_atm_ivol, runoff_atm_ivol, &
            radnet_ivol, relheat_iw

  real*8, external :: relheat_freezing, evap, porosity_flow, radiation
  
  integer :: ibvs, idiag_pa, idiag_temp, izn

  real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rsmall=1.0d-3


  !real*8 :: area_ivol, densinc_ivol, densvinc_ivol, dflux,            &
  !          dummy, dummy1, dummy2, dummy3, dummy4,                    &
  !          evapinc_pa, evapinc_temp, heatflux, heatfluxinc,          &
  !          hrunoff, hrunoffinc, porinc_ivol, radnetinc,              &
  !          rain, rhinc, runoffinc,                                   &
  !          sainc_ivol, sawinc_ivol, uvsinc_ivol
  !real*8 :: sheat_atm, runoff_atm, rh_atm, radnet, evap_atm

  !cprovi---------------------------------------------------      
  !cprovi---------------------------------------------------
  !cprovi---------------------------------------------------  
  izn = mpropvs(ivol)
  ibvs = ivol2bvs(ivol)
  if (ibvs == 0) then
    return
  end if
  !if(ibvs==0) then
  !    if (rank == 0) then
  !      write(ilog,*)'error in atmospheric boundary condition'
  !      write(*,*) 'control volume ',ivol," lack boundary condition"
  !      close(ilog)
  !    end if
  !#ifdef PETSC
  !    call petsc_mpi_finalize
  !#endif
  !    stop
  !end if

  evapinc_temp = r0
  evapinc_pa = r0
  runoffinc = r0

  area_ivol = bcondvs(ibvs)
  !cprovi---------------------------------------------------
  !cprovi Check if the derivatives must be computed 
  !cprovi---------------------------------------------------
  if (typeequation=='heat'.or.typeequation=='flow') then
    comp_der = .true.
    !cprovi---------------------------------------------------
    !cprovi Compute the perturbation 
    !cprovi---------------------------------------------------   
    tempinc_ivol = tempnew(ivol) + dinc_heat
    uvsinc_ivol = uvsnew(ivol) + dinc_vs 
  else
    comp_der = .false.
  end if
  !cprovi---------------------------------------------------
  !cprovi If reactive transport is not solved, water
  !cprovi is considered equal to unity 
  !cprovi---------------------------------------------------
  if (reactive_transport) then
    actw=gamma(nc,ivol)
  else
    actw=r1
  end if
  !cprovi---------------------------------------------------
  !cprovi Compute the rain
  !cprovi---------------------------------------------------
  rain = rain_atm * ssdens(ivol) * area_ivol 
  !cprovi-------------------------------------------------------------
  !cprovi Compute the runoff term 
  !cprovi-------------------------------------------------------------

  if (soilhydrfunc_field) then
    aentry_loc = aentry_vol(ivol)
  else
    aentry_loc = aentry(izn)
  end if

  if (uvsnew(ivol)>aentry_loc) then
    runoff_atm_ivol=gammaw_atm*(uvsnew(ivol)-aentry_loc)
    if (comp_der) then 
      runoffinc=gammaw_atm*(uvsinc_ivol-aentry_loc)
    end if
  else
    runoff_atm_ivol=r0
    if (comp_der) then 
      runoffinc=r0
    end if
  end if
  !cprovi-------------------------------------------------------------
  !cprovi Compute sensible heat
  !cprovi-------------------------------------------------------------
  call compute_sensible (tempnew(ivol),r1,sheat_atm_ivol,rh_atm_ivol)
  !cprovi-------------------------------------------------------------
  !cprovi During a rainfall event, evaporation is equal to zero
  !cprovi-------------------------------------------------------------
  evap_atm_ivol = evap_atm

  if (comp_evap_rate_atm) then  
    evap_atm_ivol = evap(densvnew(ivol),pornew(ivol),sanew(ivol),rh_atm_ivol,r1)
!cprovi-------------------------------------------------------------
!cprovi If derivatives must be computed, then compute the perturbed 
!cpeovi value for evaporation 
!cprovi-------------------------------------------------------------    
    if (comp_der) then 
      if (ispitzerdens) then 
        densinc_ivol =rhonew (ref_dens,density_pitzer(ivol), &
                              ref_dens,tempinc_ivol,tempref_dens,  &
                              r1,drho_dt,nonlindens_heat,cdens1, &
                              cdens2,cdens3,cdens4)
      else
        densinc_ivol = rhonew (ref_dens,tds_new(ivol), &
                               ref_tds,tempinc_ivol,tempref_dens, & 
                               drho_dc,drho_dt,nonlindens_heat,  &
                               cdens1,cdens2,cdens3,cdens4)
      end if
      call vapor_prop (densvinc_ivol,dummy1,dummy2,dummy3,dummy4,  &
                       tempinc_ivol,aentry_loc,uvsnew(ivol),  &
                       actw,densinc_ivol,ivol)    
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed sensible heat by temperature
!cprovi-----------------------------------------------------------------------------                   
      call compute_sensible(tempinc_ivol,r1,dummy,rhinc)
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed evaporation rate by temperature
!cprovi-----------------------------------------------------------------------------             
      evapinc_temp=evap(densvinc_ivol,pornew(ivol),sanew(ivol),rhinc,r1)
 
      if (soilhydrfunc_field) then
        call vapor_prop (densvinc_ivol,dummy1,dummy2,dummy3,dummy4, &
                         tempnew(ivol),aentry_vol(ivol),uvsinc_ivol, &
                         actw,density(ivol),ivol)

        if (.not. b_disable_sat_updt) then
          call soilprdd(uvsinc_ivol,sainc_ivol,dummy1,dummy2,dummy3,  &
                        snnew(ivol),swr_vol(ivol),aentry_vol(ivol),spalpha_vol(ivol), &
                        spbeta_vol(ivol),expn_vol(ivol),spgamma_vol(ivol), &
                        napl_permeability,napl_kfunction,sgr,isovendrying(izn), &
                        beta_ovendry(izn),hm_ovendry(izn),w0_ovendry(izn),&
                        cp0_ovendry(izn),ref_dens,gacc)
        end if
      else
        call vapor_prop (densvinc_ivol,dummy1,dummy2,dummy3,dummy4, &
                         tempnew(ivol),aentry_loc,uvsinc_ivol, &
                         actw,density(ivol),ivol)

        if (.not. b_disable_sat_updt) then
          call soilprdd(uvsinc_ivol,sainc_ivol,dummy1,dummy2,dummy3,  &
                        snnew(ivol),swr(izn),aentry_loc,spalpha(izn), &
                        spbeta(izn),expn(izn),spgamma(izn), &
                        napl_permeability,napl_kfunction,sgr,isovendrying(izn), &
                        beta_ovendry(izn),hm_ovendry(izn),w0_ovendry(izn),&
                        cp0_ovendry(izn),ref_dens,gacc)
        end if
      end if
  
      if (modify_por(ivol)) then
        porinc_ivol = porosity_flow(porold(ivol),uvsinc_ivol,uvsold(ivol),stor(ivol), &
                      por_stress_dt(ivol),por_init(ivol),facpormin)  
      else                  
        porinc_ivol = pornew(ivol)               
      end if                  
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the perturbed sensible heat by liquid pressure
!cprovi-----------------------------------------------------------------------------                      
      evapinc_pa=evap(densvinc_ivol,porinc_ivol,sainc_ivol,rh_atm_ivol,r1) 
      
    end if  ! if compute derivatives      
  else
    if (comp_der) then     
      evapinc_temp=evap_atm_ivol
      evapinc_pa=evap_atm_ivol
    end if 
  end if  ! comp_evap_rate_atm         
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the net radiation
!cprovi-----------------------------------------------------------------------------
  if (.not.read_rad_atm) then
    radnet_ivol=radiation(sanew(ivol),tempnew(ivol))
  else
    radnet_ivol = radnet
  end if
!cprovi-----------------------------------------------------------------------------
!cprovi Compute the total fluxes
!cprovi-----------------------------------------------------------------------------
  if (b_icewater_heat) then
    relheat_iw = r1
  else
    relheat_iw = relheat_freezing(temp_atm,heatcapw,heatcapi,uvsnew(ivol))
  end if

  totwflux_atm = evap_atm_ivol + rain_atm * ssdens(ivol) + runoff_atm_ivol
  tothflux_atm = latvap_atm*evap_atm_ivol + heatcapw*relheat_iw*rain_atm*ssdens(ivol)*temp_atm + &
                 radnet_ivol + heatcapw*relheat_iw*runoff_atm_ivol*temp_atm + sheat_atm_ivol
!cprovi-----------------------------------------------------------------------------
!cprovi Modify residual and jacobian according to type of equation 
!cprovi-----------------------------------------------------------------------------
  if (typeequation=='flow') then

    bglob(ivol) = bglob(ivol) + evap_atm_ivol * area_ivol + rain + runoff_atm_ivol * area_ivol
  
    idiag_temp = iaglob(ivol) + iavs(ivol+1) - iavs(ivol)
  
    idiag_pa = iaglob(ivol)  
  
    dflux =  area_ivol * (evapinc_temp - evap_atm_ivol)/dinc_heat
   
    aglob(idiag_temp) = aglob(idiag_temp) - dflux
               
    dflux =  area_ivol * (evapinc_pa - evap_atm_ivol)/dinc_vs 
   
    aglob(idiag_pa) = aglob(idiag_pa) - dflux
   
    dflux =  area_ivol*(runoffinc - runoff_atm_ivol)/dinc_vs 
   
    aglob(idiag_pa) = aglob(idiag_pa) - dflux
  
  else if (typeequation=='heat') then   
   
    idiag_temp = iaglob(ivol+nngl)
    idiag_pa = iaglob(ivol+nngl) + iavs(ivol+1) - iavs(ivol)
   
    heatflux = evap_atm_ivol*latvap_atm
    bglob(ivol+nngl) = bglob(ivol+nngl) + heatflux * area_ivol  
   
    heatfluxinc=evapinc_temp*latvap_atm
    dflux =  area_ivol * (heatfluxinc - heatflux)/dinc_heat
    aglob(idiag_temp) = aglob(idiag_temp) - dflux           
           
    heatfluxinc=evapinc_pa*latvap_atm
         
    dflux =  area_ivol * (heatfluxinc - heatflux)/dinc_vs 
     
    aglob(idiag_pa) = aglob(idiag_pa) - dflux
    !cprovi-------------------------------------------------------------
    !cprovi Sensible heat  
    !cprovi Compute perturbation in sensible heat 
    !cprovi-------------------------------------------------------------
    call compute_sensible (tempinc_ivol,r1,heatfluxinc,dummy)
           
    dflux =  area_ivol * (heatfluxinc - sheat_atm_ivol)/dinc_heat
     
    aglob(idiag_temp) = aglob(idiag_temp) - dflux
   
    bglob(ivol+nngl) = bglob(ivol+nngl) + sheat_atm_ivol * area_ivol 
    !cprovi-------------------------------------------------------------
    !cprovi Rainfall   
    !cprovi-------------------------------------------------------------    
    bglob(ivol+nngl) = bglob(ivol+nngl) + heatcapw * relheat_iw * rain * temp_atm
    !cprovi-------------------------------------------------------------
    !cprovi Radiation 
    !cprovi-------------------------------------------------------------
    if (.not.read_rad_atm) then
      radnetinc=radiation(sanew(ivol),tempinc_ivol)
      dflux =  area_ivol * (radnetinc - radnet_ivol)/dinc_heat 
      aglob(idiag_temp) = aglob(idiag_temp) - dflux
    end if
    bglob(ivol+nngl) = bglob(ivol+nngl) + radnet_ivol * area_ivol 
    if (.not.read_rad_atm) then
      if (.not. b_disable_sat_updt) then
        if (soilhydrfunc_field) then
          call soilprdd(uvsinc_ivol,sawinc_ivol,dummy1,dummy2,dummy3, &
                        snnew(ivol),swr_vol(ivol),aentry_vol(ivol),spalpha_vol(ivol), &
                        spbeta_vol(ivol),expn_vol(ivol),spgamma_vol(ivol), &
                        napl_permeability,napl_kfunction,sgr, &
                        isovendrying(izn),beta_ovendry(izn),hm_ovendry(izn), &
                        w0_ovendry(izn),cp0_ovendry(izn),ref_dens,gacc)
        else
          call soilprdd(uvsinc_ivol,sawinc_ivol,dummy1,dummy2,dummy3, &
                        snnew(ivol),swr(izn),aentry_loc,spalpha(izn), &
                        spbeta(izn),expn(izn),spgamma(izn), &
                        napl_permeability,napl_kfunction,sgr, &
                        isovendrying(izn),beta_ovendry(izn),hm_ovendry(izn), &
                        w0_ovendry(izn),cp0_ovendry(izn),ref_dens,gacc)
        end if
      end if

      radnetinc=radiation(sawinc_ivol,tempnew(ivol))
      dflux =  area_ivol * (radnetinc - radnet_ivol)/dinc_vs 
      aglob(idiag_pa) = aglob(idiag_pa) - dflux
    end if
    !cprovi-------------------------------------------------------------
    !cprovi Add the runoff term 
    !cprovi If Pl>Pg then the water is going out
    !cprovi-------------------------------------------------------------
    hrunoff=heatcapw*relheat_iw*runoff_atm_ivol*temp_atm 
    hrunoffinc=heatcapw*relheat_iw*runoffinc*temp_atm
    dflux =  area_ivol*(hrunoffinc-hrunoff)/dinc_vs 
    aglob(idiag_pa) = aglob(idiag_pa) - dflux 
    bglob(ivol+nngl) = bglob(ivol+nngl) + hrunoff 
   
  end if   
 
  return
end subroutine 
