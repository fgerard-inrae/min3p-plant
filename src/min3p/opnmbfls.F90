!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/opnmbfls.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine opnmbfls
!c -------------------
!c
!c open mass balance files 
!c
!c written by:      Uli Mayer - February 3, 97
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -   
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           icnv               = unit number, data conversion        + -
!c           ifls               = unit number, file information       + -
!c           imrt               = unit number, mass balance -         * *
!c                                             reactive transport
!c           imrt_first         = pointer - first unit number for     * +
!c                                mass balance - reactive transport
!c           imrt_last          = pointer - last unit number for      * +
!c                                mass balance - reactive transport
!c           imvs               = unit number, mass balance -         * *
!c                                             variably saturated
!c                                             flow
!c           imvs_first         = pointer - first unit number for     * +
!c                                mass balance - variably saturated
!c                                               flow
!c           imvs_last          = pointer - last unit number for      * +
!c                                mass balance - variably saturated
!c                                               flow
!c           l_prfx             = length of prefix of I/O files       + -
!c           nmb                = number of mass balance files for    + -
!c                                selected species
!c
!c           logical:
!c           --------
!c           mass_balance_rt    = .true.  -> compute mass balance     + -
!c                                           (reactive tramsport)
!c           mass_balance_vs    = .true.  -> compute mass balance     + -
!c                                           (variably saturated 
!c                                            flow)
!c
!c           character:
!c           ----------
!c           namemb(nmb)        = names of selected species           + -
!c           prefix             = prefix name for all I/O files       + -
!c           time_unit          = time unit for output -> 'years'     + -
!c                                                        'days'
!c
!c chem.f:   integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           nanc               = number of sorbed species            + -
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           nc                 = number of components including h2o  + -
!c           nm                 = number of minerals                  + -
!c           ng                 = number of gases                     + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c
!c           character:
!c           ----------
!c           isotherm_type(nc)  = definition of sorption isotherm     + -    
!c                                'none' = no sorption
!c                                'linear' = linear adsorption
!c                                'freundlich' = Freundlich isotherm
!c                                'langmuir' = Langmuir isotherm
!c           nameanc(nc)        = names of sorbed species             + -
!c                                (non-competitive sorption)
!c           nameaq(naq)        = names of intra-aqueous kinetic      + -
!c                                reactions
!c           namec(nc)          = component names                     + -
!c           nameg(ng)          = names of gases                      + -
!c           namem(nm)          = mineral names                       + -
!c           namesb(nsb)        = names of sorbed species             + -
!c           namesb_ion(nsb_ion)= names of sorbed species             + -
!c                                (ion-exchange)
!c           namesb_surf(nsb_surf)= names of sorbed species           + -
!c                                  (surface-complex)
!c
!c           logical:
!c           --------
!c           noncompetitive_sorption = logical array for activation   + -  
!c                                     of noncompetitive sorption
!c                                     reactions
!c
!c local:    integer*4:
!c           ----------
!c           ianc               = counter (non-competitive sorption
!c                                         reactions)
!c           iaq                = counter (intra-aqueous kinetic 
!c                                         reactions)
!c           ic                 = counter (components)
!c           ig                 = counter (gases)
!c           im                 = counter (minerals)
!c           imb                = counter (selected species)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c           l_sufx             = length of file suffix
!c
!c           character:
!c           ----------
!c           suffix             = file suffix
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine opnmbfls

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use chem
      use dens, only : density_dependence
      use file_unit, only : lun_get, lun_set
      use file_utility, only : check_rewind_status      
      use module_binary_mpiio, only : binary_file_open,               &
                                      tecplot_binary_write_header,    &
                                      tecplot_binary_write_variable,  &
                                      tecplot_binary_write_zoneinfo,  &
                                      tecplot_binary_write_section
      use biol

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, ianc, iaq, ic, im, imb, ig, isites, isb, itmsb,    &
                 istart, istop, istart2, istop2, ireac, ic2,           &
                 l_sufx, l_sufx2, ierr

      character*2 :: suffix, suffix2, strtemp
      character*36 :: strl36, dix_unit
      character*256 :: strfilename
      character*2048 :: strbuffer
      
      integer*4 :: nvarsimvs, nvarsimrt, nvarsiresp, nvarsirup,        &
                   nvarsidix, nvarsispm, ilun, nlun
      character*72, allocatable :: tec_variables(:)
      logical :: b_rewind_valid

      external :: checkerr

!c  only the master processor needs to output mass balance
      if (rank > 0) then
        return
      end if

      b_rewind_valid = .false.
      
      if (b_enable_output .and. b_output_trans_binary) then
        allocate(tec_variables(nc+nmb+ng+nm+nsites+nsb_ion+            &
                           nsb_surf+26), stat = ierr)
        tec_variables = ''
        call memory_monitor(sizeof(tec_variables),'tec_variables',.false.)

      end if

!c     write(*,'(/a)') 'enter routine opnmbfls ...'
 
!c  mass balance - variably saturated flow
      
      if (mass_balance_vs) then

        !imvs_first  = 100
        imvs_first = lun_get()
        
        if (density_dependence) then
          write(ifls,'(//72a/a/72a/)')                      &
               ('*',i=1,72),                                &
               'mass balance - density dependent variably'//&
               'saturated flow',('*',i=1,72)
        else
          write(ifls,'(//72a/a/72a/)')                      &
               ('*',i=1,72),                                &
               'mass balance - variably saturated flow',    &
               ('*',i=1,72)
        end if

!c  system mass

        imvs = imvs_first
        call lun_set(imvs)
        
        if (b_enable_output .and. b_output_trans_binary) then
          allocate(imvs_mpi(imvs_first:imvs_first+2+ntmsb), stat = ierr)
          call checkerr(ierr,'opnmbfls-imvs_mpi',ilog)
          imvs_mpi = 0
          call memory_monitor(sizeof(imvs_mpi),'imvs_mpi',.false.)

          allocate(offset_imvs(imvs_first:imvs_first+2+ntmsb), stat = ierr)
          call checkerr(ierr,'opnmbfls-offset_imvs',ilog)
          offset_imvs = 0
          call memory_monitor(sizeof(offset_imvs),'offset_imvs',.false.)

          allocate(offset_imvs_ijk(imvs_first:imvs_first+2+ntmsb), stat = ierr)
          call checkerr(ierr,'opnmbfls-offset_imvs_ijk',ilog)
          offset_imvs_ijk = 0
          call memory_monitor(sizeof(offset_imvs_ijk),'offset_imvs_ijk',.false.)
        end if
        
        if (b_enable_output) then
            
          if (b_output_trans_binary) then
#ifndef PETSC
            if (imvs_mpi(imvs) < 10) then
              imvs_mpi(imvs) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,             &
                         imvs_mpi(imvs), prefix(:l_prfx)//'_o.mvs',    &
                         .true.)
          else
            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mvs')
            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imvs,file=prefix(:l_prfx)//'_o.mvs',status='unknown', &
                   form='formatted',position='rewind')
            else
              open(imvs,file=prefix(:l_prfx)//'_o.mvs',status='unknown', &
                   form='formatted')
            end if
          end if
          
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
              call writeversion2file(imvs, "#")
            end if
          end if
          
          if (b_output_trans_binary) then
            nvarsimvs = 4  
            if (evaporation) then
               tec_variables(1:nvarsimvs) = [character(len=72) ::      &
                   "time", "water mass",                               &
                   "water filled volume","vapour filled volume"]
            else
              tec_variables(1:nvarsimvs) =[character(len=72) ::        &
                  "time", "water mass",                                &
                  "water filled volume","gas filled volume"]
            end if
            strbuffer = "system mass - variably saturated flow"
            
            offset_imvs(imvs) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                         imvs_mpi(imvs), "#!TDV102",'dataset '//     &
                         prefix(:l_prfx),offset_imvs(imvs),.true.,   &
                         .true.)  
            
            call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                         imvs_mpi(imvs), nvarsimvs,                  &
                         tec_variables(1:nvarsimvs),                 &
                         offset_imvs(imvs),.true.,.true.)               
            
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                         imvs_mpi(imvs),trim(strbuffer),             &
                         offset_imvs(imvs), 1, 1, 1, .true.,.true.,  &
                         b_output_multizone)
            offset_imvs_ijk(imvs) = offset_imvs(imvs) - 5*4
            
            call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                         imvs_mpi(imvs),nvarsimvs,0,                 &
                         offset_imvs(imvs),.true.,.true.,            &
                         b_output_multizone) 
          else
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (evaporation) then

                write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(imvs,'(3a)') 'variables = "time", "water mass", ', &
                                '"water filled volume", ',               &
                                '"vapour filled volume" '
                write(imvs,'(2a)') 'zone t = "system mass - ',           &
                                ' variably saturated flow", f=point'
              else

                write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(imvs,'(3a)') 'variables = "time", "water mass", ', &
                                '"water filled volume", ',               &
                                '"gas filled volume" '
                write(imvs,'(2a)') 'zone t = "system mass - ',           &
                                ' variably saturated flow", f=point'
              end if
            end if
          end if
          
          write(ifls,'(a/72a/)')'system mass',('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mvs'

          write(ifls,'(2a)')  'column   entry                           ',&
                              'unit'
          write(ifls,'(2a)')  '1        time                            ',&
                               time_unit
          write(ifls,'(2a)')  '2        water mass                      ',&
                              'kg'
          write(ifls,'(2a)')  '3        water filled volume             ',&
                              'm^3'
          write(ifls,'(2a/)') '4        air filled volume               ',&
                              'm^3'
        end if

!c  mass balance contributions

        imvs = imvs+1
        call lun_set(imvs)
        
        if (b_enable_output) then
            
          if (b_output_trans_binary) then
#ifndef PETSC
            if (imvs_mpi(imvs) < 10) then
              imvs_mpi(imvs) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,                     &
                         imvs_mpi(imvs), prefix(:l_prfx)//'_o.mvc',    &
                         .true.)
          else
            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mvc')
            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imvs,file=prefix(:l_prfx)//'_o.mvc',status='unknown', &
                   form='formatted',position='rewind')
            else
              open(imvs,file=prefix(:l_prfx)//'_o.mvc',status='unknown', &
                   form='formatted')
            end if
          end if
        
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
              call writeversion2file(imvs, "#")
            end if
          end if
          
          if (b_output_trans_binary) then
            nvarsimvs = 5
            tec_variables(1:nvarsimvs) = [character(len=72) ::         &
                "time", "inflow", "outflow",                           &
                "change in storage","root water uptake"]
            strbuffer = "mass balance - variably saturated flow"
            
            offset_imvs(imvs) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imvs_mpi(imvs), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imvs(imvs),.true.,     &
                         .true.)                                       
                                                                       
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imvs_mpi(imvs), nvarsimvs,                    &
                         tec_variables(1:nvarsimvs),                   &
                         offset_imvs(imvs),.true.,.true.)                 
                                                                       
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                         imvs_mpi(imvs),trim(strbuffer),               &
                         offset_imvs(imvs), 1, 1, 1, .true.,.true.,    &
                         b_output_multizone)                                
            offset_imvs_ijk(imvs) = offset_imvs(imvs) - 5*4            
                                                                       
            call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                         imvs_mpi(imvs),nvarsimvs,0,offset_imvs(imvs), &
                         .true.,.true.,b_output_multizone) 
          else
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(imvs,'(3a)')                                         &
                    'variables = "time", "inflow", "outflow", ',         &
                    '"change in storage", ',                             &
                    '"root water uptake" '
              write(imvs,'(2a)') 'zone t = "mass balance - ',            &
                                    ' variably saturated flow", f=point'
            end if
          end if

          write(ifls,'(a/72a/)')'mass balance contributions',          &
                                ('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mvc'

          write(ifls,'(2a)')  'column   entry                           ',&
                              'unit'
          write(ifls,'(2a)')  '1        time                            ',&
                               time_unit
          if (density_dependence) then
            write(ifls,'(2a)') '2        total inflow                    ',&
                               'kg/day'
            write(ifls,'(2a)') '3        total outflow                   ',&
                               'kg/day'
            write(ifls,'(2a/)')'4        change in storage               ',&
                               'kg/day'
          else
            write(ifls,'(2a)')  '2        total inflow                    ',&
                                'm^3/day'
            write(ifls,'(2a)')  '3        total outflow                   ',&
                                'm^3/day'
            write(ifls,'(2a/)') '4        change in storage               ',&
                                'm^3/day'
          end if
        end if

!c  mass balance error

        imvs = imvs+1
        call lun_set(imvs)
        
        if (b_enable_output) then
          if (b_output_trans_binary) then
#ifndef PETSC
            if (imvs_mpi(imvs) < 10) then
              imvs_mpi(imvs) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,imvs_mpi(imvs),      &
                        prefix(:l_prfx)//'_o.mve',.true.)
          else

            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mve')
            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imvs,file=prefix(:l_prfx)//'_o.mve',status='unknown', &
                   form='formatted',position='rewind')
            else
              open(imvs,file=prefix(:l_prfx)//'_o.mve',status='unknown', &
                   form='formatted')
            end if
          end if
        
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
              call writeversion2file(imvs, "#")
            end if
          end if
          
          if (b_output_trans_binary) then
            nvarsimvs = 5
            tec_variables(1:nvarsimvs) = [character(len=72) :: "time", &
                        "absolute mass balance error",                 &
                        "relative mass balance error",                 & 
                        "absolute cumulative mass balance error",      &
                        "relative cumulative mass balance error"]
            strbuffer = "mass balance error - variably saturated flow"
            
            offset_imvs(imvs) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imvs_mpi(imvs), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imvs(imvs),.true.,     &
                         .true.)                                       
                                                                       
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imvs_mpi(imvs), nvarsimvs,                    &
                         tec_variables(1:nvarsimvs),                   &
                         offset_imvs(imvs),.true.,.true.)                 
                                                                       
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                         imvs_mpi(imvs),trim(strbuffer),               &
                         offset_imvs(imvs), 1, 1, 1, .true.,.true.,    &
                         b_output_multizone)                                
            offset_imvs_ijk(imvs) = offset_imvs(imvs) - 5*4            
                                                                       
            call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                         imvs_mpi(imvs),nvarsimvs,0,offset_imvs(imvs), &
                         .true.,.true.,b_output_multizone) 
          else
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(imvs,'(5a)') 'variables = "time", ',               &
                         '"absolute mass balance error", ',            &
                         '"relative mass balance error", ',            &
                         '"absolute cumulative mass balance error", ', &
                         '"relative cumulative mass balance error" '
              write(imvs,'(2a)') 'zone t = "mass balance error - ',    &
                                 ' variably saturated flow", f=point'
            end if
          end if
          
          write(ifls,'(a/72a/)')'mass balance error',                  &
                                ('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mve'

          write(ifls,'(2a)')  'column   entry                           ',&
                              'unit'
          write(ifls,'(2a)')  '1        time                            ',&
                               time_unit
          write(ifls,'(2a)')  '2        absolute mass balance error     ',&
                              'm^3'

          if (density_dependence) then
            write(ifls,'(2a)')  '3        relative mass balance error     ',&
                                '% = kg/kg in system x 100'
            write(ifls,'(2a)')  '4        accumulative absolute mass      ',&
                                'kg'
            write(ifls,'(a)')   '         balance error'
            write(ifls,'(2a)')  '5        accumulative relative mass      ',&
                                '% = kg/kg in system x 100'
            write(ifls,'(a)')   '         balance error'
          else
            write(ifls,'(2a)')  '3        relative mass balance error     ',&
                                '% = m^3/m^3 in system x 100'
            write(ifls,'(2a)')  '4        accumulative absolute mass      ',&
                                'm^3'
            write(ifls,'(a)')   '         balance error'
            write(ifls,'(2a)')  '5        accumulative relative mass      ',&
                                '% = m^3/m^3 in system x 100'
            write(ifls,'(a)')   '         balance error'
          end if
        end if

!c  total mass through specified boundary
        if (ntmsb > 0) then

          do itmsb = 1, ntmsb
            imvs = imvs+1
            call lun_set(imvs)

            if (b_enable_output) then

              if(itmsb.lt.10) then
                write(suffix,'(i1)') itmsb
                l_sufx = 1
              elseif (itmsb.ge.10) then
                write(suffix,'(i2)') itmsb
                l_sufx = 2
              end if

              strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'_b.mvc'

              if (b_output_trans_binary) then
#ifndef PETSC
                if (imvs_mpi(imvs) < 10) then
                  imvs_mpi(imvs) = lun_get()
                end if
#endif
                call binary_file_open(PETSC_COMM_SELF,                 &
                            imvs_mpi(imvs), trim(strfilename),.true.)
              else
                b_rewind_valid = check_rewind_status(trim(strfilename))
                if (b_rewind_valid .and. i_append_sim > 0) then
                  open(imvs,file=trim(strfilename),status='unknown',   &
                       form='formatted',position='rewind')
                else
                  open(imvs,file=trim(strfilename),status='unknown',   &
                       form='formatted')
                end if
              end if

!c  version information
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                if (b_writeversion_tecplot .and. .not.b_output_trans_binary) then
                  call writeversion2file(imvs, "#")
                end if
              end if

              if (b_output_trans_binary) then
                nvarsimvs = 5
                tec_variables(1:nvarsimvs) = [character(len=72) ::         &
                    "time","inflow","outflow",                             &
                    "accumulative inflow","accumulative outflow"]
                strbuffer = "mass through specified boundary "//           &
                            trim(name_tmsb(itmsb))//                       &
                            " - variably saturated flow"

                offset_imvs(imvs) = 0
                call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                             imvs_mpi(imvs), "#!TDV102",'dataset '//       &
                             prefix(:l_prfx),offset_imvs(imvs),.true.,     &
                             .true.)

                call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                             imvs_mpi(imvs), nvarsimvs,                    &
                             tec_variables(1:nvarsimvs),                   &
                             offset_imvs(imvs),.true.,.true.)

                call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                             imvs_mpi(imvs),trim(strbuffer),               &
                             offset_imvs(imvs), 1, 1, 1, .true.,.true.,    &
                             b_output_multizone)
                offset_imvs_ijk(imvs) = offset_imvs(imvs) - 5*4

                call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                             imvs_mpi(imvs),nvarsimvs,0,offset_imvs(imvs), &
                             .true.,.true.,b_output_multizone)
              else
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  write(imvs,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                  write(imvs,'(2a)')                                       &
                        'variables = "time", "inflow", "outflow", ',       &
                        '"accumulative inflow", "accumulative outflow"'
                  write(imvs,'(3a)')                                       &
                        'zone t = "mass through specified boundary ',      &
                        trim(name_tmsb(itmsb)),                            &
                        ' - variably saturated flow", f=point'
                end if
              end if

              write(ifls,'(/2a/72a/)')'mass through specified boundary ',     &
                                     trim(name_tmsb(itmsb)),('-',i=1,72)
              write(ifls,'(a/)') trim(strfilename)

              write(ifls,'(2a)')  'column   entry                           ',&
                                  'unit'
              write(ifls,'(2a)')  '1        time                            ',&
                                   time_unit
              if (density_dependence) then
                write(ifls,'(2a)') '2        total inflow                    ',&
                                   'kg/day'
                write(ifls,'(2a)') '3        total outflow                   ',&
                                   'kg/day'
                write(ifls,'(2a)') '4        total accumulative inflow       ',&
                                   'kg/elapsed time'
                write(ifls,'(2a)') '5        total accumulative outflow      ',&
                                   'kg/elapsed time'
              else
                write(ifls,'(2a)') '2        total inflow                    ',&
                                   'm^3/day'
                write(ifls,'(2a)') '3        total outflow                   ',&
                                   'm^3/day'
                write(ifls,'(2a)') '2        total accumulative inflow       ',&
                                   'm^3/elapsed time'
                write(ifls,'(2a)') '3        total accumulative outflow      ',&
                                   'm^3/elapsed time'
              end if
            end if
          end do
        end if

        imvs_last = imvs

      end if
 
!c  mass balance - reactive transport

      if (mass_balance_rt) then
        if (root_uptake) then
          !c root respiration related code
          iresp = lun_get()
          if (b_enable_output .and. b_output_trans_binary) then
            iresp_mpi = 0
            offset_iresp = 0
            offset_iresp_ijk = 0
          end if

          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (iresp_mpi < 10) then
                iresp_mpi = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,iresp_mpi,             &
                                    prefix(:l_prfx)//'_o.resp',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.resp')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(iresp,file=prefix(:l_prfx)//'_o.resp',status='unknown', &
                     form='formatted',position='rewind')
              else
                open(iresp,file=prefix(:l_prfx)//'_o.resp',status='unknown', &
                     form='formatted')
              end if
            end if
          
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(iresp, "#")
              end if
            end if
          
          
            if (b_output_trans_binary) then
              nvarsiresp = 2*(nc-1)+1
              tec_variables(1) = "time"
              do ic = 1, nc-1
                tec_variables(ic+1) = trim(namec(ic))//                &
                    " respiration [mol/day]" 
              end do
              do ic = 1, nc-1
                tec_variables(nc+ic) = trim(namec(ic))//               &
                    " total respiration [mol/elapsed time]" 
              end do
            
              strbuffer = 'root respiration - selected species'
            
              offset_iresp = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           iresp_mpi, "#!TDV102",'dataset '//          &
                           prefix(:l_prfx),offset_iresp,.true.,        &
                           .true.)  
  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           iresp_mpi, nvarsiresp,                      &
                           tec_variables(1:nvarsiresp), offset_iresp,  &
                           .true.,.true.)               

              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           iresp_mpi,trim(strbuffer),                  &
                           offset_iresp, 1, 1, 1, .true.,.true.,       &
                           b_output_multizone)
              offset_iresp_ijk = offset_iresp - 5*4

              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           iresp_mpi,nvarsiresp,0,offset_iresp,        &
                           .true.,.true.,b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(iresp,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'

                do ic = 1,n
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' respiration [mol/day]"'
                end do
                 
                do ic = 1,n
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' total respiration [mol/elapsed time]"'
                end do

                write(iresp,'(a)') trim(strbuffer)
                write(iresp,'(2a)')                                       &
                   'zone t = "root respiration - selected species", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)') 'root respiration - selected species',  &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.resp'

            write(ifls,'(2a)')  'column   entry                           ',&
                                'unit'
            write(ifls,'(2a)')  '1        time                            ',&
                                 time_unit
            do ic = 1,nc-1
              if (ic.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic)//        &
                                               ' respiration','mol/day'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic)//        &
                                               ' respiration','mol/day'
              end if
            end do

            do ic = 1,nc-1
              if (ic.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' total respiration','mol/elapsed time'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' total respiration','mol/elapsed time'
              end if
            end do          
          end if
        end if

!c  total solute uptake by passive uptake and root respiration
        if (root_uptake .or. passive_uptake) then
          !c total root uptake related code
          irup = lun_get()
          if (b_enable_output .and. b_output_trans_binary) then
            irup_mpi = 0
            offset_irup = 0
            offset_irup_ijk = 0
          end if

          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (irup_mpi < 10) then
                irup_mpi = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,irup_mpi,          &
                                    prefix(:l_prfx)//'_o.rup',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.rup')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(irup,file=prefix(:l_prfx)//'_o.rup',status='unknown', &
                     form='formatted',position='rewind')
              else
                open(irup,file=prefix(:l_prfx)//'_o.rup',status='unknown', &
                     form='formatted')
              end if
            end if
          
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(irup, "#")
              end if
            end if
          
          
            if (b_output_trans_binary) then
              nvarsirup = 2*(nc-1)+1
              tec_variables(1) = "time"
              do ic = 1, nc-1
                tec_variables(ic+1) = trim(namec(ic))//                &
                    " root uptake [mol/day]" 
              end do
              do ic = 1, nc-1
                tec_variables(nc+ic) = trim(namec(ic))//               &
                    " total root uptake [mol/elapsed time]" 
              end do
            
              strbuffer = 'total root uptake - selected species'
            
              offset_irup = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           irup_mpi, "#!TDV102",'dataset '//           &
                           prefix(:l_prfx),offset_irup,.true.,         &
                           .true.)  
  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           irup_mpi, nvarsirup,                        &
                           tec_variables(1:nvarsirup), offset_irup,    &
                           .true.,.true.)               

              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,       &
                           irup_mpi,trim(strbuffer),                    &
                           offset_irup, 1, 1, 1, .true.,.true.,         &
                           b_output_multizone)
              offset_irup_ijk = offset_irup - 5*4

              call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                           irup_mpi,nvarsirup,0,offset_irup,          &
                           .true.,.true.,b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(irup,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'

                do ic = 1,n
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' root uptake [mol/day]"'
                end do
                 
                do ic = 1,n
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' total root uptake [mol/elapsed time]"'
                end do

                write(irup,'(a)') trim(strbuffer)
                write(irup,'(2a)')                                           &
                   'zone t = "total root uptake - selected species", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)') 'total root uptake - selected species',  &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.rup'

            write(ifls,'(2a)')  'column   entry                           ', &
                                'unit'
            write(ifls,'(2a)')  '1        time                            ', &
                                 time_unit
            do ic = 1,nc-1
              if (ic.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' root uptake','mol/day'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' root uptake','mol/day'
              end if
            end do

            do ic = 1,nc-1
              if (ic.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' total root uptake','mol'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic)//        &
                      ' total root uptake','mol'
              end if
            end do          
          end if
        end if

!c  output of dilution index
        if (b_dilution_index) then

          if (ndim_sys == 3) then
            dix_unit = 'm^3'
          else if (ndim_sys == 2) then
            dix_unit = 'm^2'
          else
            dix_unit = 'm'
          end if

          idix = lun_get()
          if (b_enable_output .and. b_output_trans_binary) then
            idix_mpi = 0
            offset_idix = 0
            offset_idix_ijk = 0
          end if

          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (idix_mpi < 10) then
                idix_mpi = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,idix_mpi,              &
                                    prefix(:l_prfx)//'_o.dix',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.dix')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(idix,file=prefix(:l_prfx)//'_o.dix',status='unknown', &
                     form='formatted',position='rewind')
              else
                open(idix,file=prefix(:l_prfx)//'_o.dix',status='unknown', &
                     form='formatted')
              end if
            end if
          
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(idix, "#")
              end if
            end if
          
          
            if (b_output_trans_binary) then
              nvarsidix = nc
              tec_variables(1) = "time"
              do ic = 1, nc-1
                tec_variables(ic+1) = trim(namec(ic))//                &
                    " dilution index ["//trim(dix_unit)//']' 
              end do
            
              strbuffer = 'dilution index - selected species'
            
              offset_idix = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           idix_mpi, "#!TDV102",'dataset '//           &
                           prefix(:l_prfx),offset_idix,.true.,.true.)  
  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           idix_mpi, nvarsidix,                        &
                           tec_variables(1:nvarsidix), offset_idix,    &
                           .true.,.true.)               

              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           idix_mpi,trim(strbuffer),                   &
                           offset_idix, 1, 1, 1, .true.,.true.,        &
                           b_output_multizone)
              offset_idix_ijk = offset_idix - 5*4

              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           idix_mpi,nvarsidix,0,offset_idix,           &
                           .true.,.true.,b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(idix,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'

                do ic = 1, nc-1
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' dilution index ['//trim(dix_unit)//']"'
                end do
                 

                write(idix,'(a)') trim(strbuffer)
                write(idix,'(2a)')                                     &
                   'zone t = "dilution index - selected species", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)')                                    &
                  'dilution index - selected species', ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.dix'

            write(ifls,'(2a)')  'column   entry                           ',&
                                'unit'
            write(ifls,'(2a)')  '1        time                            ',&
                                 time_unit
            do ic = 1,nc-1
              if (ic.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic)//        &
                                               ' dixiration',trim(dix_unit)
              else
                write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic)//        &
                                               ' dixiration',trim(dix_unit)
              end if
            end do
         
          end if
        end if

!c  output of spatial moment
        if (b_spatial_moment) then

          ispm = lun_get()
          if (b_enable_output .and. b_output_trans_binary) then
            ispm_mpi = 0
            offset_ispm = 0
            offset_ispm_ijk = 0
          end if

          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (ispm_mpi < 10) then
                ispm_mpi = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,ispm_mpi,              &
                                    prefix(:l_prfx)//'_o.spm',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.spm')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(ispm,file=prefix(:l_prfx)//'_o.spm',status='unknown', &
                     form='formatted',position='rewind')
              else
                open(ispm,file=prefix(:l_prfx)//'_o.spm',status='unknown', &
                     form='formatted')
              end if
            end if
          
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(ispm, "#")
              end if
            end if
          
          
            if (b_output_trans_binary) then
              nvarsispm = 1+(nc-1)*6
              tec_variables(1) = "time"
              do ic = 1, nc-1
                tec_variables((ic-1)*3+2) = trim(namec(ic))//" x_1st [m]"
                tec_variables((ic-1)*3+3) = trim(namec(ic))//" y_1st [m]"
                tec_variables((ic-1)*3+4) = trim(namec(ic))//" z_1st [m]"
              end do

              do ic = 1, nc-1
                tec_variables((nc-1)*3+(ic-1)*3+2) = trim(namec(ic))//" x_2nd [m]"
                tec_variables((nc-1)*3+(ic-1)*3+3) = trim(namec(ic))//" y_2nd [m]"
                tec_variables((nc-1)*3+(ic-1)*3+4) = trim(namec(ic))//" z_2nd [m]"
              end do
            
              strbuffer = 'spatial moment - selected species'
            
              offset_ispm = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           ispm_mpi, "#!TDV102",'dataset '//           &
                           prefix(:l_prfx),offset_ispm,.true.,.true.)  
  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           ispm_mpi, nvarsispm,                        &
                           tec_variables(1:nvarsispm), offset_ispm,    &
                           .true.,.true.)               

              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           ispm_mpi,trim(strbuffer),                   &
                           offset_ispm, 1, 1, 1, .true.,.true.,        &
                           b_output_multizone)
              offset_ispm_ijk = offset_ispm - 5*4

              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           ispm_mpi,nvarsispm,0,offset_ispm,           &
                           .true.,.true.,b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(ispm,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'

                do ic = 1, nc-1
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' x_1st [m]"'//', "'//trim(namec(ic))//  &
                              ' y_1st [m]"'//', "'//trim(namec(ic))//  &
                              ' z_1st [m]"'
                end do

                do ic = 1, nc-1
                  strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//&
                              ' x_2nd [m]"'//', "'//trim(namec(ic))//  &
                              ' y_2nd [m]"'//', "'//trim(namec(ic))//  &
                              ' z_2nd [m]"'
                end do
                 

                write(ispm,'(a)') trim(strbuffer)
                write(ispm,'(2a)')                                     &
                   'zone t = "spatial moment - selected species", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)')                                    &
                  'spatial moment - selected species', ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.spm'

            write(ifls,'(2a)')  'column   entry                           ',&
                                'unit'
            write(ifls,'(2a)')  '1        time                            ',&
                                 time_unit
            do ic = 1,nc-1
              if ((ic-1)*3+2 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (ic-1)*3+2,namec(ic)//" x_1st [m]"
              else if ((ic-1)*3+2 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (ic-1)*3+2,namec(ic)//" x_1st [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (ic-1)*3+2,namec(ic)//" x_1st [m]"
              end if
              if ((ic-1)*3+3 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (ic-1)*3+3,namec(ic)//" y_1st [m]"
              else if ((ic-1)*3+3 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (ic-1)*3+3,namec(ic)//" y_1st [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (ic-1)*3+3,namec(ic)//" y_1st [m]"
              end if
              if ((ic-1)*3+4 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (ic-1)*3+4,namec(ic)//" z_1st [m]"
              else if ((ic-1)*3+4 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (ic-1)*3+4,namec(ic)//" z_1st [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (ic-1)*3+4,namec(ic)//" z_1st [m]"
              end if
            end do

            do ic = 1,nc-1
              if ((nc-1)*3+(ic-1)*3+2 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (nc-1)*3+(ic-1)*3+2,namec(ic)//" x_2nd [m]"
              else if ((nc-1)*3+(ic-1)*3+2 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (nc-1)*3+(ic-1)*3+2,namec(ic)//" x_2nd [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (nc-1)*3+(ic-1)*3+2,namec(ic)//" x_2nd [m]"
              end if
              if ((nc-1)*3+(ic-1)*3+3 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (nc-1)*3+(ic-1)*3+3,namec(ic)//" y_2nd [m]"
              else if ((nc-1)*3+(ic-1)*3+3 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (nc-1)*3+(ic-1)*3+3,namec(ic)//" y_2nd [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (nc-1)*3+(ic-1)*3+3,namec(ic)//" y_2nd [m]"
              end if
              if ((nc-1)*3+(ic-1)*3+4 .lt. 10) then
                write(ifls,'(i1,8x,a30,2x,a)') (nc-1)*3+(ic-1)*3+4,namec(ic)//" z_2nd [m]"
              else if ((nc-1)*3+(ic-1)*3+4 .lt. 100) then
                write(ifls,'(i2,7x,a30,2x,a)') (nc-1)*3+(ic-1)*3+4,namec(ic)//" z_2nd [m]"
              else
                write(ifls,'(i3,6x,a30,2x,a)') (nc-1)*3+(ic-1)*3+4,namec(ic)//" z_2nd [m]"
              end if
            end do
         
          end if
        end if  

        !imrt_first = 103
        imrt_first = lun_get()
        nlun = 5+2*n+nmb+naq+ng+nm+ntmsb*(n+ng)
        do ilun = 1, nlun
          call lun_set(imrt_first+ilun)
        end do

        if (b_enable_output) then
          write(ifls,'(//72a/a/72a)')               &
     &         ('*',i=1,72),                        &
     &         'mass balance - reactive transport', &
     &         ('*',i=1,72)
        end if

!c  total system mass for components

        imrt = imrt_first
        
        if (b_enable_output .and. b_output_trans_binary) then
          allocate(imrt_mpi(imrt_first:imrt_first+nlun-1), stat = ierr)
          call checkerr(ierr,'opnmbfls-imrt_mpi',ilog)
          imrt_mpi = 0
          call memory_monitor(sizeof(imrt_mpi),'imrt_mpi',.false.)

          allocate(offset_imrt(imrt_first:imrt_first+nlun-1), stat = ierr)
          call checkerr(ierr,'opnmbfls-offset_imrt',ilog)
          offset_imrt = 0
          call memory_monitor(sizeof(offset_imrt),'offset_imrt',.false.)

          allocate(offset_imrt_ijk(imrt_first:imrt_first+nlun-1), stat = ierr)
          call checkerr(ierr,'opnmbfls-offset_imrt_ijk',ilog)
          offset_imrt_ijk = 0
          call memory_monitor(sizeof(offset_imrt_ijk),'offset_imrt_ijk',.false.)
        end if
        
        if (b_enable_output) then
          if (b_output_trans_binary) then
#ifndef PETSC
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_o.mas',    &
                         .true.)
          else
            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mas')
            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imrt,file=prefix(:l_prfx)//'_o.mas',status='unknown', &
                   form='formatted',position='rewind')
            else
              open(imrt,file=prefix(:l_prfx)//'_o.mas',status='unknown', &
                   form='formatted')
            end if
          end if
          
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
              call writeversion2file(imrt, "#")
            end if
          end if
          
          
          if (b_output_trans_binary) then
            nvarsimrt = nc
            tec_variables(1) = "time"
            do ic = 1, nc-1
              tec_variables(ic+1) = trim(namec(ic)) 
            end do
            
            strbuffer = 'system mass - aqueous phase'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,     &
                         .true.)  
  
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), nvarsimrt,                    &
                         tec_variables(1:nvarsimrt), offset_imrt(imrt),&
                         .true.,.true.)               

            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt),trim(strbuffer),               &
                         offset_imrt(imrt), 1, 1, 1, .true.,.true.,    &
                         b_output_multizone)
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4

            call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                         imrt_mpi(imrt),nvarsimrt,0,offset_imrt(imrt), &
                         .true.,.true.,b_output_multizone) 
          else
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

              strbuffer = 'variables = "time"'
              do ic = 1,nc-1
                strbuffer = trim(strbuffer)//', "'//trim(namec(ic))//'"'
              end do

              write(imrt,'(a)') trim(strbuffer)
              write(imrt,'(2a)')                                       &
                    'zone t = "system mass - aqueous phase", f=point'
            end if
          end if

          write(ifls,'(/a/72a/)') 'system mass - aqueous phase',       &
                                  ('-',i=1,72)
          write(ifls,'(a/)') prefix(:l_prfx)//'_o.mas'

          write(ifls,'(2a)')  'column   entry                           ',&
                              'unit'
          write(ifls,'(2a)')  '1        time                            ',&
                               time_unit
          do ic = 1,nc-1
            if (ic.lt.9) then
              write(ifls,'(i1,8x,a30,2x,a)') ic+1,namec(ic),'moles'
            else
              write(ifls,'(i2,7x,a30,2x,a)') ic+1,namec(ic),'moles'
            end if
          end do
        end if

!c  total system mass for selected species

        if (nmb.gt.0) then

          imrt = imrt + 1
          
          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mss',  &
                           .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mss')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_o.mss',status='unknown', &
                    form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_o.mss',status='unknown', &
                    form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = nmb+1
              tec_variables(1) = "time"
              do imb=1, nmb
                tec_variables(imb+1) = trim(namemb(imb))
              end do

              strbuffer = 'system mass - selected species'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'
                do imb = 1,nmb
                  strbuffer = trim(strbuffer)//', "'//trim(namemb(imb))//'"'
                end do

                write(imrt,'(a)') trim(strbuffer)
                write(imrt,'(2a)')                                     &
                      'zone t = "system mass - selected species", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)') 'system mass - selected species',  &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mss'

            write(ifls,'(2a)')'column   entry                           ',&
                              'unit'
            write(ifls,'(2a)')'1        time                            ',&
                               time_unit
            do imb = 1,nmb
              if (imb.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') imb+1,namemb(imb),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') imb+1,namemb(imb),'moles'
              end if
            end do
          end if

        end if

!c  total system mass for gases

        if (ng.gt.0) then

          imrt = imrt + 1
          
          if (b_enable_output) then
            if (b_output_trans_binary) then
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mgs',  &
                           .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mgs')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_o.mgs',              &
                     status='unknown',form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_o.mgs',              &
                     status='unknown',form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = ng+1
              tec_variables(1) = "time"
              do ig=1, ng
                tec_variables(ig+1) = trim(nameg(ig)) 
              end do

              strbuffer = 'system mass - gaseous phase'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'
                do ig = 1,ng
                  strbuffer = trim(strbuffer)//', "'//trim(nameg(ig))//'"'
                end do

                write(imrt,'(a)') trim(strbuffer)
                write(imrt,'(2a)')                                     &
                      'zone t = "system mass - gaseous phase", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)') 'system mass - gaseous phase',     &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mgs'

            write(ifls,'(2a)')'column   entry                           ',&
                              'unit'
            write(ifls,'(2a)')'1        time                            ',&
                               time_unit
            do ig = 1,ng
              if (ig.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') ig+1,nameg(ig),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') ig+1,nameg(ig),'moles'
              end if
            end do
          end if

        end if               !(ng.gt.0)

!c  total system mass for sorbed species

        if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then

          imrt = imrt + 1
          
          if (b_enable_output) then
              
            if (b_output_trans_binary) then
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mss',  &
                           .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mss')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_o.mss',              &
                     status='unknown',form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_o.mss',              &
                     status='unknown',form='formatted')
              end if
            end if
          
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              end if
            end if
            
            if (b_output_trans_binary) then
              tec_variables(1) = "time"
            else
              strbuffer = 'variables = "time"'
            end if

            write(ifls,'(/a/72a/)') 'system mass - sorbed species',       &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mss'

            write(ifls,'(2a)')'column   entry                           ',&
                              'unit'
            write(ifls,'(2a)')'1        time                            ',&
                               time_unit
!c  non-competitive sorption reactions

            if (noncompetitive_sorption) then
              ianc = 0
              nvarsimrt = nc
              do ic = 1,nc-1
                if (isotherm_type(ic).ne.'none') then
                  ianc = ianc+1
                  
                  if (b_output_trans_binary) then
                    tec_variables(ic+1) = trim(nameanc(ianc))   
                  else
                    strbuffer = trim(strbuffer)//', "'//               &
                                trim(nameanc(ianc))//'"'
                  end if

                  if (ianc.lt.9) then
                    write(ifls,'(i1,8x,a30,2x,a)') ianc+1,             &
                                                   nameanc(ianc),      &
                                                  'moles'
                  else
                    write(ifls,'(i2,7x,a30,2x,a)') ianc+1,             &
                                                   nameanc(ianc),      &
                                                  'moles'
                  end if
                end if
              end do
            end if
          
          
        
!c  competitive sorption reactions
         
            if (nsb_ion.gt.0.or.nsb_surf.gt.0) then
              nvarsimrt = nsites+nsb_ion+nsb_surf+1
              do isites = 1,nsites
                ic = iaic(isites)
                if (b_output_trans_binary) then
                  tec_variables(isites+1) = trim(namec(ic))
                else
                  strbuffer = trim(strbuffer)//', "'//                 &
                              trim(namec(ic))//'"'
                end if

                if (isites+nanc.lt.9) then
                  write(ifls,'(i1,8x,a30,2x,a)') isites+nanc+1,        &
                                                 namec(ic),'moles'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') isites+nanc+1,        &
                                                 namec(ic),'moles'
                end if
              end do
              
              do isb = 1,nsb_ion
                if (b_output_trans_binary) then
                  tec_variables(nsites+isb+1) = trim(namesb_ion(isb))
                else
                  strbuffer = trim(strbuffer)//', "'//                 &
                              trim(namesb_ion(isb))//'"'
                end if
                  
                if (isb+nsites+nanc.lt.9) then
                  write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+1,    &
                              namesb_ion(isb),'moles'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+1,    &
                              namesb_ion(isb),'moles'
                end if
              end do
              
              do isb = 1,nsb_surf 
                if (b_output_trans_binary) then
                  tec_variables(nsites+nsb_ion+isb+1) =                &
                      trim(namesb_surf(isb))
                else
                  strbuffer = trim(strbuffer)//', "'//                 &
                              trim(namesb_surf(isb))//'"'
                end if

                if (isb+nsites+nanc.lt.9) then
                  write(ifls,'(i1,8x,a30,2x,a)') isb+nsites+nanc+1,    &
                              namesb_surf(isb),'moles'
                else
                  write(ifls,'(i2,7x,a30,2x,a)') isb+nsites+nanc+1,    &
                              namesb_surf(isb),'moles'
                end if
              end do
              
            end if         !nsb.gt.0 
            
            if (b_output_trans_binary) then                
              strbuffer = 'system mass - sorbed species'  
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(a)') trim(strbuffer)
                write(imrt,'(2a)')                                     &
                      'zone t = "system mass - sorbed species", f=point'
              end if
            end if
          
          end if

        end if

!c  total system mass for minerals

        if (nm.gt.0) then    

          imrt = imrt + 1
          
          if (b_enable_output) then
            if (b_output_trans_binary) then  
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_o.mms',  &
                           .true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.mms')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_o.mms',              &
                     status='unknown',form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_o.mms',              &
                     status='unknown',form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = nm+1
              tec_variables(1) = "time"
              do im=1, nm
                tec_variables(im+1) = trim(namem(im))  
              end do

              strbuffer = 'system mass - mineral phase'
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time"'
                do im = 1,nm
                  strbuffer = trim(strbuffer)//', "'//trim(namem(im))//'"'
                end do

                write(imrt,'(a)') trim(strbuffer)
                write(imrt,'(2a)')                                     &
                      'zone t = "system mass - mineral phase", f=point'
              end if
            end if

            write(ifls,'(/a/72a/)') 'system mass - mineral phase',     &
                                    ('-',i=1,72)
            write(ifls,'(a/)') prefix(:l_prfx)//'_o.mms'

            write(ifls,'(2a)')'column   entry                           ',&
                              'unit'
            write(ifls,'(2a)')'1        time                            ',&
                               time_unit
            do im = 1,nm
              if (im.lt.9) then
                write(ifls,'(i1,8x,a30,2x,a)') im+1,namem(im),'moles'
              else
                write(ifls,'(i2,7x,a30,2x,a)') im+1,namem(im),'moles'
              end if
            end do
          
          end if

        end if               !(nm.gt.0)

!c  contributions to mass balance - aqueous phase
        if (b_enable_output) then
          write(ifls,'(/a/72a/)')'mass balance - aqueous phase',       &
                                 ('-',i=1,72)
          write(ifls,'(2a)') 'file name                           ',   &
                             'component'
        end if

        do ic = 1,n

          imrt = imrt+1

          if (b_enable_output) then
          !rewind(icnv)           !Deprecated, use internal convert instead. DSU
          if(ic.lt.10) then
            !write(icnv,'(i1)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') ic
            l_sufx = 1
          elseif (ic.ge.10) then
            !write(icnv,'(i2)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') ic
            l_sufx = 2
          end if

!c  open file
          if (b_output_trans_binary) then
#ifndef PETSC
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_'//        &
                         suffix(:l_sufx)//'.mac',.true.)
          else
            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_'//&
                                          suffix(:l_sufx)//'.mac')

            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.mac',status='unknown',           &
                   form='formatted',position='rewind')
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.mac',status='unknown',           &
                   form='formatted')
            end if
          end if
          
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
              call writeversion2file(imrt, "#")
            end if
          end if
          
          if (b_output_trans_binary) then
            if (ng .gt. 0 .and. gas_advection) then
              nvarsimrt = 33
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
              "time ["//time_unit(:l_time_unit)//"]",                  &
              "mass influx [mol/d]",                                   &
              "mass outflux [mol/d]",                                  &
              "change in storage [mol/d]",                             &
              "source/sink from oxidation/reduction reactns [mol/d]",  &
              "source/sink from intra-aqueous reactns [mol/d]",        &
              "source/sink from mineral phase [mol/d]",                &
              "source/sink from gas phase [mol/d]",                    &
              "mass influx by diffusion (gas phase) [mol/d]",          &
              "mass outflux by diffusion (gas phase) [mol/d]",         &
              "mass influx by advection (gas phase) [mol/d]",          &
              "mass outflux by advection (gas phase) [mol/d]",         &
              "change in storage (gas phase) [mol/d]",                 &
              "mass loss - degassing [mol/d]",                         &
              "source/sink from sorbed phase [mol/d]",                 &
              "source/sink from root uptake [mol/d]",                  &
              "source/sink from noble gas ingrowth [mol/d]",           &
              "total mass influx [mol/elapsed time]",                  &
              "total mass outflux [mol/elapsed time]",                 &
              "total change in storage [mol/elapsed time]",            &
              "total source/sink from oxidation/reduction reactns "//  &
              "[mol/elapsed time]",                                    &
              "total source/sink from intra-aqueous reactns "//        &
              "[mol/elapsed time]",                                    &
              "total source/sink from mineral phase "//                &
              "[mol/elapsed time]",                                    &
              "total source/sink from gas phase "//                    &
              "[mol/elapsed time]",                                    &
              "total mass influx by diffusion (gas phase) "//          &
              "[mol/elapsed time]",                                    &
              "total mass outflux by diffusion (gas phase) "//         &
              "[mol/elapsed time]",                                    &
              "total mass influx by advection (gas phase) "//          &
              "[mol/elapsed time]",                                    &
              "total mass outflux by advection (gas phase) "//         &
              "[mol/elapsed time]",                                    &
              "total change in storage (gas phase) "//                 &
              "[mol/elapsed time]",                                    &
              "total mass loss - degassing [mol/elapsed time]",        &
              "total source/sink from sorbed phase "//                 &
              "[mol/elapsed time]",                                    &
              "total source/sink from root uptake [mol/elapsed time]", &
              "total source/sink from noble gas ingrowth "//           &
              "[mol/elapsed time]"]
            else
              nvarsimrt = 29
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
              "time ["//time_unit(:l_time_unit)//"]",                  &
              "mass influx [mol/d]",                                   &
              "mass outflux [mol/d]",                                  &
              "change in storage [mol/d]",                             &
              "source/sink from oxidation/reduction reactns [mol/d]",  &
              "source/sink from intra-aqueous reactns [mol/d]",        &
              "source/sink from mineral phase [mol/d]",                &
              "source/sink from gas phase [mol/d]",                    &
              "mass influx (gas phase) [mol/d]",                       &
              "mass outflux (gas phase) [mol/d]",                      &
              "change in storage (gas phase) [mol/d]",                 &
              "mass loss - degassing [mol/d]",                         &
              "source/sink from sorbed phase [mol/d]",                 &
              "source/sink from root uptake [mol/d]",                  &
              "source/sink from noble gas ingrowth [mol/d]",           &
              "total mass influx [mol/elapsed time]",                  &
              "total mass outflux [mol/elapsed time]",                 &
              "total change in storage [mol/elapsed time]",            &
              "total source/sink from oxidation/reduction reactns "//  &
              "[mol/elapsed time]",                                    &
              "total source/sink from intra-aqueous reactns "//        &
              "[mol/elapsed time]",                                    &
              "total source/sink from mineral phase "//                &
              "[mol/elapsed time]",                                    &
              "total source/sink from gas phase "//                    &
              "[mol/elapsed time]",                                    &
              "total mass influx (gas phase) "//                       &
              "[mol/elapsed time]",                                    &
              "total mass outflux (gas phase) [mol/elapsed time]",     &
              "total change in storage (gas phase) "//                 &
              "[mol/elapsed time]",                                    &
              "total mass loss - degassing [mol/elapsed time]",        &
              "total source/sink from sorbed phase "//                 &
              "[mol/elapsed time]",                                    &
              "total source/sink from root uptake [mol/elapsed time]", &
              "total source/sink from noble gas ingrowth "//           &
              "[mol/elapsed time]"]
            end if



            write(strbuffer,'(3a)') 'mass balance for component ',     &
                  trim(namec(ic)),' - reactive transport'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//       &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,     &
                         .true.)                                       
                                                                       
            call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), nvarsimrt,                    &
                         tec_variables(1:nvarsimrt),                   &
                         offset_imrt(imrt),.true.,.true.)                 
                                                                       
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt),trim(strbuffer),               &
                         offset_imrt(imrt), 1, 1, 1, .true.,.true.,    &
                         b_output_multizone)                                
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4            
                                                                       
            call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                         imrt_mpi(imrt),nvarsimrt,0,offset_imrt(imrt), &
                         .true.,.true.,b_output_multizone) 
          else

            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

              if (ng .gt. 0 .and. gas_advection) then
                write(imrt,'(45a)') 'variables = "time [',                 &
                 time_unit(:l_time_unit),']", ',                           &
                '"mass influx [mol/d]", ',                                 &
                '"mass outflux [mol/d]", ',                                &
                '"change in storage [mol/d]", ',                           &
                '"source/sink from oxidation/reduction reactns [mol/d]", ',&
                '"source/sink from intra-aqueous reactns [mol/d]", ',      &
                '"source/sink from mineral phase [mol/d]", ',              &
                '"source/sink from gas phase [mol/d]", ',                  &
                '"mass influx by diffusion (gas phase) [mol/d]", ',        &
                '"mass outflux by diffusion (gas phase) [mol/d]", ',       &
                '"mass influx by advection (gas phase) [mol/d]", ',        &
                '"mass outflux by advection (gas phase) [mol/d]", ',       &
                '"change in storage (gas phase) [mol/d]", ',               &
                '"mass loss - degassing [mol/d]", ',                       &
                '"source/sink from sorbed phase [mol/d]", ',               &
                '"source/sink from root uptake [mol/d]",',                 &
                '"source/sink from noble gas ingrowth [mol/d]",',          &
                '"total mass influx [mol/elapsed time]", ',                &
                '"total mass outflux [mol/elapsed time]", ',               &
                '"total change in storage [mol/elapsed time]", ',          &
                '"total source/sink from oxidation/reduction reactns ',    &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from intra-aqueous reactns ',          &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from mineral phase ',                  &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from gas phase ',                      &
                '[mol/elapsed time]", ',                                   &
                '"total mass influx by diffusion (gas phase) ',            &
                '[mol/elapsed time]", ',                                   &
                '"total mass outflux by diffusion (gas phase) ',           &
                '[mol/elapsed time]", ',                                   &
                '"total mass influx by advection (gas phase) ',            &
                '[mol/elapsed time]", ',                                   &
                '"total mass outflux by advection (gas phase) ',           &
                '[mol/elapsed time]", ',                                   &
                '"total change in storage (gas phase) ',                   &
                '[mol/elapsed time]", ',                                   &
                '"total mass loss - degassing [mol/elapsed time]", ',      &
                '"total source/sink from sorbed phase ',                   &
                '[mol/elapsed time]",',                                    &
                '"total source/sink from root uptake [mol/elapsed time]",',&
                '"total source/sink from noble gas ingrowth '//            &
                '[mol/elapsed time]"'
              else
                write(imrt,'(42a)') 'variables = "time [',                 &
                 time_unit(:l_time_unit),']", ',                           &
                '"mass influx [mol/d]", ',                                 &
                '"mass outflux [mol/d]", ',                                &
                '"change in storage [mol/d]", ',                           &
                '"source/sink from oxidation/reduction reactns [mol/d]", ',&
                '"source/sink from intra-aqueous reactns [mol/d]", ',      &
                '"source/sink from mineral phase [mol/d]", ',              &
                '"source/sink from gas phase [mol/d]", ',                  &
                '"mass influx (gas phase) [mol/d]", ',                     &
                '"mass outflux (gas phase) [mol/d]", ',                    &
                '"change in storage (gas phase) [mol/d]", ',               &
                '"mass loss - degassing [mol/d]", ',                       &
                '"source/sink from sorbed phase [mol/d]", ',               &
                '"source/sink from root uptake [mol/d]",',                 &
                '"source/sink from noble gas ingrowth [mol/d]",',          &
                '"total mass influx [mol/elapsed time]", ',                &
                '"total mass outflux [mol/elapsed time]", ',               &
                '"total change in storage [mol/elapsed time]", ',          &
                '"total source/sink from oxidation/reduction reactns ',    &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from intra-aqueous reactns ',          &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from mineral phase ',                  &
                '[mol/elapsed time]", ',                                   &
                '"total source/sink from gas phase ',                      &
                '[mol/elapsed time]", ',                                   &
                '"total mass influx (gas phase) ',                         &
                '[mol/elapsed time]", ',                                   &
                '"total mass outflux (gas phase) [mol/elapsed time]", ',   &
                '"total change in storage (gas phase) ',                   &
                '[mol/elapsed time]", ',                                   &
                '"total mass loss - degassing [mol/elapsed time]", ',      &
                '"total source/sink from sorbed phase ',                   &
                '[mol/elapsed time]",',                                    &
                '"total source/sink from root uptake [mol/elapsed time]",',&
                '"total source/sink from noble gas ingrowth '//            &
                '[mol/elapsed time]"'
              end if

              write(imrt,'(3a)') 'zone t = "mass balance for component ',  &
                    trim(namec(ic)),' - reactive transport", f=point'
            end if
          end if
          

!c  write data to file information file
          strl36 = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.mac'
          write(ifls,'(2a)') strl36,namec(ic)

          end if
        end do

        if (b_enable_output) then
            
        if (ng .gt. 0 .and. gas_advection) then    
        
          write(ifls,'(/2a)')                                          &
                'column entry                                       ', &
                'unit'
          write(ifls,'(2a)')                                           &
                '1      time                                        ', &
                time_unit
          write(ifls,'(2a)')                                           &
                '2      mass influx                                 ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '3      mass outflux                                ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '4      change in storage                           ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '5      source/sink from oxidation/reduction reactn ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '6      source/sink from intra-aqueous reactns      ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '7      source/sink from mineral phase              ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '8      source/sink from gas phase                  ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '9      mass influx by diffusion (gas phase)        ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '10     mass outflux by diffusion (gas phase)       ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '11     mass influx by advection (gas phase)        ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '12     mass outflux by advection (gas phase)       ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '13     change in storage (gas phase)               ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '14     mass loss - degassing                       ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '15     source/sink from sorbed phase               ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '16     source/sink from root uptake                ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '17     source/sink from noble gas ingrowth         ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '18     total mass influx                           ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '19     total mass outflux                          ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '20     total change in storage                     ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '21     total source/sink from oxidation/reduction  ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '22     total source/sink from intra-aqueous reactns', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '23     total source/sink from mineral phase        ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '24     total source/sink from gas phase            ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '25     total mass influx by diffusion (gas phase)  ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '26     total mass outflux by diffusion (gas phase) ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '27     total mass influx by advection (gas phase)  ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '28     total mass outflux by advection (gas phase) ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '29     total change in storage (gas phase)         ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '30     total mass loss - degassing                 ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '31     total source/sink from sorbed phase         ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '32     total source/sink from root uptake          ', &
                'mol/elapsed time'        
          write(ifls,'(2a)')                                           &
                '33     total source/sink from noble gas ingrowth   ', &
                'mol/elapsed time'      
        else
          write(ifls,'(/2a)')                                          &
                'column entry                                       ', &
                'unit'
          write(ifls,'(2a)')                                           &
                '1      time                                        ', &
                time_unit
          write(ifls,'(2a)')                                           &
                '2      mass influx                                 ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '3      mass outflux                                ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '4      change in storage                           ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '5      source/sink from oxidation/reduction reactn ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '6      source/sink from intra-aqueous reactns      ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '7      source/sink from mineral phase              ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '8      source/sink from gas phase                  ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '9      mass influx (gas phase)                     ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '10     mass outflux (gas phase)                    ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '11     change in storage (gas phase)               ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '12     mass loss - degassing                       ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '13     source/sink from sorbed phase               ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '14     source/sink from root uptake                ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '15     source/sink from noble gas ingrowth         ', &
                'mol/day'
          write(ifls,'(2a)')                                           &
                '16     total mass influx                           ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '17     total mass outflux                          ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '18     total change in storage                     ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '19     total source/sink from oxidation/reduction  ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '20     total source/sink from intra-aqueous        ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '21     total source/sink from mineral phase        ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '22     total source/sink from gas phase            ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '23     total mass influx (gas phase)               ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '24     total mass outflux (gas phase)              ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '25     total change in storage (gas phase)         ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '26     total mass loss - degassing                 ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '27     total source/sink from sorbed phase         ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '28     total source/sink from root uptake          ', &
                'mol/elapsed time'
          write(ifls,'(2a)')                                           &
                '29     total source/sink from noble gas ingrowth   ', &
                'mol/elapsed time'
        end if

        end if

!c  mass balance error - aqueous phase

        if (b_enable_output) then
          write(ifls,'(/a/72a/)')'mass balance error - aqueous phase', &
                                 ('-',i=1,72)
          write(ifls,'(2a)') 'file name                           ',   &
                             'component'        
        end if

        do ic = 1,n

          imrt = imrt+1

          if (b_enable_output) then
          !rewind(icnv)             !Deprecated, use internal convert instead. DSU
          if(ic.lt.10) then
            !write(icnv,'(i1)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i1)') ic
            l_sufx = 1
          elseif (ic.ge.10) then
            !write(icnv,'(i2)') ic
            !rewind(icnv)
            !read(icnv,'(a2)') suffix
            write(suffix,'(i2)') ic
            l_sufx = 2
          end if

          if (b_output_trans_binary) then
#ifndef PETSC
            if (imrt_mpi(imrt) < 10) then
              imrt_mpi(imrt) = lun_get()
            end if
#endif
            call binary_file_open(PETSC_COMM_SELF,             &
                         imrt_mpi(imrt), prefix(:l_prfx)//'_'//        &
                         suffix(:l_sufx)//'.mae',.true.)
          else
            b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_'//&
                                          suffix(:l_sufx)//'.mae')
            if (b_rewind_valid .and. i_append_sim > 0) then
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.mae',status='unknown',           &
                   form='formatted',position='rewind')
            else
              open(imrt,file=prefix(:l_prfx)//'_'//                    &
                   suffix(:l_sufx)//'.mae',status='unknown',           &
                   form='formatted')
            end if
          end if
          
!c  version information
          if (i_append_sim < 1 .or. .not.b_rewind_valid) then
            if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
              call writeversion2file(imrt, "#")
            end if
          end if
          
          if (b_output_trans_binary) then
            nvarsimrt = 5
            tec_variables(1:nvarsimrt) = [character(len=72) ::         &
                "time ["//time_unit(:l_time_unit)//"]",                &
                "absolute mass balance error [mol]",                   &
                "relative mass balance error [% of system mass]",      &
                "absolute cumulative mass balance error [mol] ",       &
                "relative cumulative mass balance error "//            &
                "[% of system mass]"]
            write(strbuffer,'(3a)')                                    &
                  'mass balance error for component ',                 &
                  trim(namec(ic)),' - reactive transport'
            
            offset_imrt(imrt) = 0  
            call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                         imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                         prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                         .true.)  
            
            call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                         imrt_mpi(imrt), nvarsimrt,                  &
                         tec_variables(1:nvarsimrt),                 &
                         offset_imrt(imrt),.true.,.true.)               
            
            call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                         imrt_mpi(imrt),trim(strbuffer),             &
                         offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                         b_output_multizone)
            offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
            
            call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                         imrt_mpi(imrt),nvarsimrt,0,                 &
                         offset_imrt(imrt), .true.,.true.,           &
                         b_output_multizone) 
          else
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
              write(imrt,'(11a)') 'variables = "time [',               &
                      time_unit(:l_time_unit),']", ',                  &
                     '"absolute mass balance error [mol]", ',          &
                     '"relative mass balance error ',                  &
                     '[% of system mass]", ',                          &
                     '"absolute cumulative mass balance error ',       &
                     '[mol] ", ',                                      &
                     '"relative cumulative mass balance error ',       &
                     '[% of system mass]"'
              write(imrt,'(3a)')                                       &
                    'zone t = "mass balance error for component ',     &
                    trim(namec(ic)),' - reactive transport", f=point'
            end if
          end if

          strl36 = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.mae'
          write(ifls,'(2a)') strl36,namec(ic)          

          end if

        end do
      
        if (b_enable_output) then
          write(ifls,'(/2a)') 'column   entry                           ',&
                              'unit'
          write(ifls,'(2a)')  '1        time                            ',&
                               time_unit
          write(ifls,'(2a)')  '2        absolute mass balance error     ',&
                              'moles'
          write(ifls,'(2a)')  '3        relative mass balance error     ',&
                              '% = moles/moles in system x 100'
          write(ifls,'(2a)')  '4        accumulative absolute mass      ',&
                              'moles'
          write(ifls,'(a)')   '         balance error'                     
          write(ifls,'(2a)')  '5        accumulative relative mass      ',&
                              '% = moles/moles in system x 100'
          write(ifls,'(a)')   '         balance error'
        end if

!c  total mass through specified boundary
        if (ntmsb > 0) then

          do itmsb = 1, ntmsb

            if (b_enable_output) then
              write(ifls,'(/3a/72a/)')                                     &
                    'mass through specified boundary ',                    &
                    trim(name_tmsb(itmsb)), ' - aqueous phase',            &
                    ('-',i=1,72)
              write(ifls,'(2a)') 'file name                           ',   &
                                 'component'
            end if

            if(itmsb.lt.10) then
              write(suffix2,'(i1)') itmsb
              l_sufx2 = 1
            elseif (itmsb.ge.10) then
              write(suffix2,'(i2)') itmsb
              l_sufx2 = 2
            end if

            do ic = 1,n

              imrt = imrt+1

              if (b_enable_output) then
                !rewind(icnv)           !Deprecated, use internal convert instead. DSU
                if(ic.lt.10) then
                  !write(icnv,'(i1)') ic
                  !rewind(icnv)
                  !read(icnv,'(a2)') suffix
                  write(suffix,'(i1)') ic
                  l_sufx = 1
                elseif (ic.ge.10) then
                  !write(icnv,'(i2)') ic
                  !rewind(icnv)
                  !read(icnv,'(a2)') suffix
                  write(suffix,'(i2)') ic
                  l_sufx = 2
                end if

                strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//  &
                              '_'//suffix2(:l_sufx2)//'_b.mac'

!c  open file
                if (b_output_trans_binary) then
#ifndef PETSC
                  if (imrt_mpi(imrt) < 10) then
                    imrt_mpi(imrt) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,               &
                               imrt_mpi(imrt), trim(strfilename),.true.)
                else
                  b_rewind_valid = check_rewind_status(trim(strfilename))

                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(imrt,file=trim(strfilename),status='unknown', &
                         form='formatted',position='rewind')
                  else
                    open(imrt,file=trim(strfilename),status='unknown', &
                         form='formatted')
                  end if
                end if

!c  version information
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                    call writeversion2file(imrt, "#")
                  end if
                end if

                if (b_output_trans_binary) then
                  if (ng .gt. 0 .and. gas_advection) then
                    nvarsimrt = 13
                    tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                    "time ["//time_unit(:l_time_unit)//"]",                  &
                    "mass influx [mol/d]",                                   &
                    "mass outflux [mol/d]",                                  &
                    "mass influx by diffusion (gas phase) [mol/d]",          &
                    "mass outflux by diffusion (gas phase) [mol/d]",         &
                    "mass influx by advection (gas phase) [mol/d]",          &
                    "mass outflux by advection (gas phase) [mol/d]",         &
                    "total mass influx [mol/elapsed time]",                  &
                    "total mass outflux [mol/elapsed time]",                 &
                    "total mass influx by diffusion (gas phase) "//          &
                    "[mol/elapsed time]",                                    &
                    "total mass outflux by diffusion (gas phase) "//         &
                    "[mol/elapsed time]",                                    &
                    "total mass influx by advection (gas phase) "//          &
                    "[mol/elapsed time]",                                    &
                    "total mass outflux by advection (gas phase) "//         &
                    "[mol/elapsed time]"]
                  else
                    nvarsimrt = 9
                    tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                    "time ["//time_unit(:l_time_unit)//"]",                  &
                    "mass influx [mol/d]",                                   &
                    "mass outflux [mol/d]",                                  &
                    "mass influx (gas phase) [mol/d]",                       &
                    "mass outflux (gas phase) [mol/d]",                      &
                    "total mass influx [mol/elapsed time]",                  &
                    "total mass outflux [mol/elapsed time]",                 &
                    "total mass influx (gas phase) [mol/elapsed time]",      &
                    "total mass outflux (gas phase) [mol/elapsed time]"]
                  end if

                  write(strbuffer,'(5a)') 'mass through specified boundary ',&
                       trim(name_tmsb(itmsb)),' for component ',             &
                       trim(namec(ic)),' - reactive transport'

                  offset_imrt(imrt) = 0
                  call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                               imrt_mpi(imrt), "#!TDV102",'dataset '//       &
                               prefix(:l_prfx),offset_imrt(imrt),.true.,     &
                               .true.)

                  call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                               imrt_mpi(imrt), nvarsimrt,                    &
                               tec_variables(1:nvarsimrt),                   &
                               offset_imrt(imrt),.true.,.true.)

                  call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,        &
                               imrt_mpi(imrt),trim(strbuffer),               &
                               offset_imrt(imrt), 1, 1, 1, .true.,.true.,    &
                               b_output_multizone)
                  offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4

                  call tecplot_binary_write_section(PETSC_COMM_SELF,         &
                               imrt_mpi(imrt),nvarsimrt,0,offset_imrt(imrt), &
                               .true.,.true.,b_output_multizone)
                else

                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                    if (ng .gt. 0 .and. gas_advection) then
                      write(imrt,'(19a)') 'variables = "time [',               &
                       time_unit(:l_time_unit),']", ',                         &
                      '"mass influx [mol/d]", ',                               &
                      '"mass outflux [mol/d]", ',                              &
                      '"mass influx by diffusion (gas phase) [mol/d]", ',      &
                      '"mass outflux by diffusion (gas phase) [mol/d]", ',     &
                      '"mass influx by advection (gas phase) [mol/d]", ',      &
                      '"mass outflux by advection (gas phase) [mol/d]", ',     &
                      '"total mass influx [mol/elapsed time]", ',              &
                      '"total mass outflux [mol/elapsed time]", ',             &
                      '"total mass influx by diffusion (gas phase) ',          &
                      '[mol/elapsed time]", ',                                 &
                      '"total mass outflux by diffusion (gas phase) ',         &
                      '[mol/elapsed time]", ',                                 &
                      '"total mass influx by advection (gas phase) ',          &
                      '[mol/elapsed time]", ',                                 &
                      '"total mass outflux by advection (gas phase) ',         &
                      '[mol/elapsed time]"'
                    else
                      write(imrt,'(11a)') 'variables = "time [',               &
                       time_unit(:l_time_unit),']", ',                         &
                      '"mass influx [mol/d]", ',                               &
                      '"mass outflux [mol/d]", ',                              &
                      '"mass influx (gas phase) [mol/d]", ',                   &
                      '"mass outflux (gas phase) [mol/d]", ',                  &
                      '"total mass influx [mol/elapsed time]", ',              &
                      '"total mass outflux [mol/elapsed time]", ',             &
                      '"total mass influx (gas phase) [mol/elapsed time]", ',  &
                      '"total mass outflux (gas phase) [mol/elapsed time]"'
                    end if

                    write(imrt,'(5a)')                                         &
                          'zone t = "mass through specified boundary ',        &
                          trim(name_tmsb(itmsb)),' for component ',            &
                          trim(namec(ic)),' - reactive transport", f=point'
                  end if
                end if

!c  write data to file information file

                write(ifls,'(a52,a)') strfilename, namec(ic)

              end if
            end do

            if (b_enable_output) then

              if (ng .gt. 0 .and. gas_advection) then

                write(ifls,'(/2a)')                                          &
                      'column entry                                       ', &
                      'unit'
                write(ifls,'(2a)')                                           &
                      '1      time                                        ', &
                      time_unit
                write(ifls,'(2a)')                                           &
                      '2      mass influx                                 ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '3      mass outflux                                ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '4      mass influx by diffusion (gas phase)        ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '5      mass outflux by diffusion (gas phase)       ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '6      mass influx by advection (gas phase)        ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '7      mass outflux by advection (gas phase)       ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '8      total mass influx                           ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '9      total mass outflux                          ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '10     total mass influx by diffusion (gas phase)  ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '11     total mass outflux by diffusion (gas phase) ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '12     total mass influx by advection (gas phase)  ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '13     total mass outflux by advection (gas phase) ', &
                      'mol/elapsed time'

              else
                write(ifls,'(/2a)')                                          &
                      'column entry                                       ', &
                      'unit'
                write(ifls,'(2a)')                                           &
                      '1      time                                        ', &
                      time_unit
                write(ifls,'(2a)')                                           &
                      '2      mass influx                                 ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '3      mass outflux                                ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '4      mass influx (gas phase)                     ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '5      mass outflux (gas phase)                    ', &
                      'mol/day'
                write(ifls,'(2a)')                                           &
                      '6      total mass influx                           ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '7      total mass outflux                          ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '8      total mass influx (gas phase)               ', &
                      'mol/elapsed time'
                write(ifls,'(2a)')                                           &
                      '9      total mass outflux (gas phase)              ', &
                      'mol/elapsed time'
              end if

            end if

          end do  ! itmsb = 1, ntmsb

        end if    ! ntmsb > 0


!c  contributions to mass balance - selected species

        if (nmb.gt.0) then

          if (b_enable_output) then
            write(ifls,'(/a/72a/)')'mass balance - selected species',  &
                                   ('-',i=1,72)
            write(ifls,'(2a)') 'file name                           ', &
                               'species'
          end if

          do imb = 1,nmb

            imrt = imrt+1

            if (b_enable_output) then
            !rewind(icnv)              !Deprecated, use internal convert instead. DSU
            if(imb.lt.10) then
              !write(icnv,'(i1)') imb
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') imb
              l_sufx = 1
            elseif (imb.ge.10) then
              !write(icnv,'(i2)') imb
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') imb
              l_sufx = 2
            end if

!c  open file
            if (b_output_trans_binary) then
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.msc',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.msc')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.msc',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.msc',status='unknown',         &
                     form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = 7
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "mass influx [mol/d]",                               &
                  "mass outflux [mol/d]",                              & 
                  "change in storage [mol/d]",                         &
                  "source/sink from redox reactns [mol/d]",            &
                  "source/sink from mineral phase [mol/d]",            &
                  "source/sink from gas phase [mol/d]"]
              write(strbuffer,'(3a)') 'contributions to mass ',        &
                    'balance for ', trim(namemb(imb))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(imrt,'(9a)') 'variables = "time [',              &
                       time_unit(:l_time_unit),']", ',                 &
                      '"mass influx [mol/d]", ',                       &
                      '"mass outflux [mol/d]", ',                      &
                      '"change in storage [mol/d]", ',                 &
                      '"source/sink from redox reactns [mol/d]", ',    &
                      '"source/sink from mineral phase [mol/d]", ',    &
                      '"source/sink from gas phase [mol/d]"'
                write(imrt,'(4a)') 'zone t = "contributions to mass ', &
                      'balance for ', trim(namemb(imb)), '", f=point'
              end if
            end if

!c  write data to file information file
            if(imb.lt.10) then
              write(ifls,'(a,6x,a)') prefix(:l_prfx)//'_'//            &
                                     suffix(:l_sufx)//'.msc',          &
                                     namemb(imb)
            elseif (imb.ge.10) then
              write(ifls,'(a,5x,a)') prefix(:l_prfx)//'_'//            &
                                     suffix(:l_sufx)//'.msc',          &
                                     namemb(imb)
            end if
            
            end if
          end do

          if (b_enable_output) then
            write(ifls,'(/a)')                                            &
            'column   entry                           unit'
            write(ifls,'(2a)')'1        time                            ',&
                              time_unit
            write(ifls,'(2a)')'2        mass influx                     ',&
                              'moles/day'
            write(ifls,'(2a)')'3        mass outflux                    ',&
                              'moles/day'
            write(ifls,'(2a)')'4        change in storage               ',&
                              'moles/day'
            write(ifls,'(2a)')'5        source/sink from redox reactns  ',&
                              'moles/day'
            write(ifls,'(2a)')'6        source/sink from mineral phase  ',&
                              'moles/day'
            write(ifls,'(2a)')'7        source/sink from gas phase      ',&
                              'moles/day'
          end if

        end if

!c  contributions to mass balance due to intra-aqueous kinetic reactions

        if (naq.gt.0) then

          if (b_enable_output) then
            write(ifls,'(/2a/72a/)')'mass balance contributions - ',   &
                                    'intra-aqueous kinetic reactions', &
                                    ('-',i=1,72)
            write(ifls,'(2a)') 'file name                           ', &
                               'reaction'
          end if

          do iaq = 1,naq

            imrt = imrt+1

            if (b_enable_output) then
            !rewind(icnv)               !Deprecated, use internal convert instead. DSU
            if(iaq.lt.10) then
              !write(icnv,'(i1)') iaq
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') iaq
              l_sufx = 1
            elseif (iaq.ge.10) then
              !write(icnv,'(i2)') iaq
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') iaq
              l_sufx = 2
            end if

!c  open file
            if (b_output_trans_binary) then  
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mic',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.mic')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mic',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mic',status='unknown',         &
                     form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = 3
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "total rate [mol/d]", "total contribution [mol]"]
              write(strbuffer,'(3a)')                                  & 
                 'mass balance contributions ',                        &
                 '- intra-aqueous kinetic reactions for ',             &
                 trim(nameaq(iaq))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(imrt,'(5a)') 'variables = "time [',              &
                       time_unit(:l_time_unit),']", ',                 &
                      '"total rate [mol/d]", ',                        &
                      '"total contribution [mol]"'
                write(imrt,'(4a)')                                     &
                   'zone t = "mass balance contributions ',            &
                   '- intra-aqueous kinetic reactions for ',           &
                      trim(nameaq(iaq)), '", f=point'
              end if
            end if
            

!c  write data to file information file
            strl36 = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.mic'
            write(ifls,'(2a)') strl36,nameaq(iaq)

            end if
          end do

          if (b_enable_output) then
            write(ifls,'(/a)')                                            &
            'column   entry                           unit'
            write(ifls,'(2a)')'1        time                            ',&
                              time_unit
            write(ifls,'(2a)')'2        total rate                      ',&
                              'moles/day'
            write(ifls,'(2a)')'3        total contribution              ',&
                              'moles'
          end if

        end if

!c  contributions to mass balance - gaseous phase

        if (ng.ne.0) then

          if (b_enable_output) then
            write(ifls,'(/a/72a/)')'mass balance - gaseous phase',     &
                                   ('-',i=1,72)
            write(ifls,'(2a)') 'file name                           ', &
                               'gas'
          end if

          do ig = 1,ng

            imrt = imrt+1

            if (b_enable_output) then
            !rewind(icnv)           !Deprecated, use internal convert instead. DSU
            if(ig.lt.10) then
              !write(icnv,'(i1)') ig
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i1)') ig
              l_sufx = 1
            elseif (ig.ge.10) then
              !write(icnv,'(i2)') ig
              !rewind(icnv)
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') ig
              l_sufx = 2
            end if

            if (b_output_trans_binary) then
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mgc',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.mgc')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mgc',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mgc',status='unknown',         &
                     form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = 9
              tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "mass influx [mol/d]",                               &
                  "mass outflux [mol/d]",                              & 
                  "mass influx by gas advection [mol/d]",              &
                  "mass outflux by gas advection [mol/d]",             & 
                  "mass flux across boundary [mol/d]",                 &
                  "change in storage [mol/d]",                         &
                  "source/sink - aqueous phase [mol/d]",               &
                  "mass loss - degassing [mol/d]"]
              write(strbuffer,'(3a)') 'mass balance - gaseous ',       &
                    'phase for ', trim(nameg(ig))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                write(imrt,'(11a)') 'variables = "time [',             &
                       time_unit(:l_time_unit),']", ',                 &
                      '"mass influx [mol/d]", ',                       &
                      '"mass outflux [mol/d]", ',                      &
                      '"mass influx by gas advection [mol/d]", ',      &
                      '"mass outflux by gas advection [mol/d]", ',     &
                      '"mass flux across boundary [mol/d]", ',         &
                      '"change in storage [mol/d]", ',                 &
                      '"source/sink - aqueous phase [mol/d]", ',       &
                      '"mass loss - degassing [mol/d]"'
                write(imrt,'(4a)') 'zone t = "mass balance - gaseous ',&
                      'phase for ', trim(nameg(ig)), '", f=point'
              end if
            end if

!c  write file information
            strl36 = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.mgc'
            write(ifls,'(2a)') strl36,nameg(ig)

            end if
                                                                       
          end do                !(i=1,ng)
          
          if (b_enable_output) then
            write(ifls,'(/a)')                                         &
                  'column   entry                           unit'
            write(ifls,'(2a)')                                         &
                  '1        time                            ',time_unit
            write(ifls,'(a)')                                          &
                  '2        mass influx                     mol/day'
            write(ifls,'(a)')                                          &
                  '3        mass outflux                    mol/day'
            write(ifls,'(a)')                                          &
                  '4        mass influx by gas advection    mol/day'
            write(ifls,'(a)')                                          &
                  '5        mass outflux by gas advection   mol/day'
            write(ifls,'(a)')                                          &
                  '6        mass flux across boundary   mol/day'
            write(ifls,'(a)')                                          &
                  '7        change in storage               mol/day'
            write(ifls,'(a)')                                          &
                  '8        source/sink - aqueous phase     mol/day'
            write(ifls,'(a)')                                          &
                  '9        mass loss - degassing           mol/day'
          end if

        end if                !(ng.ne.0)

!c  total mass through specified boundary - gaseous phase

        if (ng > 0 .and. ntmsb > 0) then

          do itmsb = 1, ntmsb

            if (b_enable_output) then
              write(ifls,'(/3a/72a/)')                                 &
                    'mass through specified boundary ',                &
                     trim(name_tmsb(itmsb)),' - gaseous phase',        &
                    ('-',i=1,72)
              write(ifls,'(2a)') 'file name                           ',&
                                 'gas'
            end if

            if(itmsb.lt.10) then
              write(suffix2,'(i1)') itmsb
              l_sufx2 = 1
            elseif (itmsb.ge.10) then
              write(suffix2,'(i2)') itmsb
              l_sufx2 = 2
            end if

            do ig = 1,ng

              imrt = imrt+1

              if (b_enable_output) then
                !rewind(icnv)           !Deprecated, use internal convert instead. DSU
                if(ig.lt.10) then
                  !write(icnv,'(i1)') ig
                  !rewind(icnv)
                  !read(icnv,'(a2)') suffix
                  write(suffix,'(i1)') ig
                  l_sufx = 1
                elseif (ig.ge.10) then
                  !write(icnv,'(i2)') ig
                  !rewind(icnv)
                  !read(icnv,'(a2)') suffix
                  write(suffix,'(i2)') ig
                  l_sufx = 2
                end if

                strfilename = prefix(:l_prfx)//'_'//suffix(:l_sufx)//  &
                                '_'//suffix2(:l_sufx2)//'_b.mgc'

                if (b_output_trans_binary) then
#ifndef PETSC
                  if (imrt_mpi(imrt) < 10) then
                    imrt_mpi(imrt) = lun_get()
                  end if
#endif
                  call binary_file_open(PETSC_COMM_SELF,imrt_mpi(imrt),  &
                                        trim(strfilename),.true.)
                else
                  b_rewind_valid = check_rewind_status(trim(strfilename))
                  if (b_rewind_valid .and. i_append_sim > 0) then
                    open(imrt,file=trim(strfilename),status='unknown',   &
                         form='formatted',position='rewind')
                  else
                    open(imrt,file=trim(strfilename),status='unknown',   &
                         form='formatted')
                  end if
                end if

!c  version information
                if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                  if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                    call writeversion2file(imrt, "#")
                  end if
                end if

                if (b_output_trans_binary) then
                  nvarsimrt = 5
                  tec_variables(1:nvarsimrt) = [character(len=72) ::       &
                      "time ["//time_unit(:l_time_unit)//"]",              &
                      "mass influx [mol/d]",                               &
                      "mass outflux [mol/d]",                              &
                      "mass influx by gas advection [mol/d]",              &
                      "mass outflux by gas advection [mol/d]"]
                  write(strbuffer,'(4a)')                                  &
                        'mass through specified boundary ',                &
                        trim(name_tmsb(itmsb)), ' - gaseous phase for ',   &
                        trim(nameg(ig))

                  offset_imrt(imrt) = 0
                  call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                               imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                               prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                               .true.)

                  call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                               imrt_mpi(imrt), nvarsimrt,                  &
                               tec_variables(1:nvarsimrt),                 &
                               offset_imrt(imrt),.true.,.true.)

                  call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                               imrt_mpi(imrt),trim(strbuffer),             &
                               offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                               b_output_multizone)
                  offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4

                  call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                               imrt_mpi(imrt),nvarsimrt,0,                 &
                               offset_imrt(imrt),.true.,.true.,            &
                               b_output_multizone)
                else
                  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
                    write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
                    write(imrt,'(7a)') 'variables = "time [',              &
                           time_unit(:l_time_unit),']", ',                 &
                          '"mass influx [mol/d]", ',                       &
                          '"mass outflux [mol/d]", ',                      &
                          '"mass influx by gas advection [mol/d]", ',      &
                          '"mass outflux by gas advection [mol/d]"'
                    write(imrt,'(5a)')                                     &
                          'zone t = "mass through specified boundary ',    &
                          trim(name_tmsb(itmsb)),' - gaseous phase for ',  &
                          trim(nameg(ig)), '", f=point'
                  end if
                end if

                write(ifls,'(a52,a)') strfilename,nameg(ig)

              end if

            end do                !(i=1,ng)

            if (b_enable_output) then
              write(ifls,'(/a)')                                         &
                    'column   entry                           unit'
              write(ifls,'(2a)')                                         &
                    '1        time                            ',time_unit
              write(ifls,'(a)')                                          &
                    '2        mass influx                     mol/day'
              write(ifls,'(a)')                                          &
                    '3        mass outflux                    mol/day'
              write(ifls,'(a)')                                          &
                    '4        mass influx by gas advection    mol/day'
              write(ifls,'(a)')                                          &
                    '5        mass outflux by gas advection   mol/day'
            end if

          end do

        end if                !ng > 0 .and. ntmsb > 0

!c  contributions to mass balance - mineral phase

        if (nm.ne.0) then
            
          if (b_enable_output) then
            write(ifls,'(/a/72a/)')'mass balance - mineral phase',     &
                                   ('-',i=1,72)
            write(ifls,'(2a)') 'file name                           ', &
                               'mineral'
          end if
                                                                       
          do im = 1,nm        !loop over minerals
                                                                       
            imrt = imrt+1

            istart = iamd(im)
            istop = iamd(im+1)-1
                            
            if (b_enable_output) then
            !rewind(icnv)            !Deprecated, use internal convert instead. DSU                                          
            if(im.lt.10) then                                          
              !write(icnv,'(i1)') im                                    
              !rewind(icnv)                                             
              !read(icnv,'(a2)') suffix  
              write(suffix,'(i1)') im
              l_sufx = 1                                               
            elseif (im.ge.10) then                                     
              !write(icnv,'(i2)') im                                    
              !rewind(icnv)                                             
              !read(icnv,'(a2)') suffix
              write(suffix,'(i2)') im
              l_sufx = 2                                               
            end if
                  
            if (b_output_trans_binary) then  
#ifndef PETSC
              if (imrt_mpi(imrt) < 10) then
                imrt_mpi(imrt) = lun_get()
              end if
#endif
              call binary_file_open(PETSC_COMM_SELF,           &
                           imrt_mpi(imrt), prefix(:l_prfx)//'_'//      &
                           suffix(:l_sufx)//'.mmc',.true.)
            else
              b_rewind_valid = check_rewind_status(prefix(:l_prfx)//   &
                                     '_'//suffix(:l_sufx)//'.mmc')
              if (b_rewind_valid .and. i_append_sim > 0) then
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mmc',status='unknown',         &
                     form='formatted',position='rewind')
              else
                open(imrt,file=prefix(:l_prfx)//'_'//                  &
                     suffix(:l_sufx)//'.mmc',status='unknown',         &
                     form='formatted')
              end if
            end if
            
!c  version information
            if (i_append_sim < 1 .or. .not.b_rewind_valid) then
              if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
                call writeversion2file(imrt, "#")
              end if
            end if
            
            if (b_output_trans_binary) then
              nvarsimrt = 6+(istop-istart)*2
              tec_variables(1:4) = [character(len=72) ::               &
                  "time ["//time_unit(:l_time_unit)//"]",              &
                  "change in storage [mol/d]",                         &
                  "source/sink - aqueous phase [mol/d]",               & 
                  "total contribution [mol/elapsed time]"]
              
              if (istart == istop) then
                tec_variables(5:6) = [character(len=72) ::             &
                    "source/sink - aqueous phase "//                   &
                    "parallel reaction pathways [mol/d]",              &
                    "total contribution "//                            &
                    "parallel reaction pathways [mol/elapsed time]"]
              else
                do ireac = istart, istop
                  write(strtemp,'(i0)') ireac-istart+1
                  istart2 = 3+(ireac-istart)*2
                  istop2 = istart2+1
                  tec_variables(istart2:istop2) = [character(len=72) ::&
                    "source/sink - aqueous phase "//                   &
                    "parallel reaction pathways - "//trim(strtemp)//   &
                    " [mol/d]", "total contribution "//                &
                    "parallel reaction pathways - "//trim(strtemp)//   &
                    " [mol/elapsed time]"]
                end do
              end if

              write(strbuffer,'(4a)') 'mass balance - mineral ',       &
                    'phase for ', trim(namem(im))
              
              offset_imrt(imrt) = 0  
              call tecplot_binary_write_header(PETSC_COMM_SELF,        &
                           imrt_mpi(imrt), "#!TDV102",'dataset '//     &
                           prefix(:l_prfx),offset_imrt(imrt),.true.,   &
                           .true.)  
              
              call tecplot_binary_write_variable(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt), nvarsimrt,                  &
                           tec_variables(1:nvarsimrt),                 &
                           offset_imrt(imrt),.true.,.true.)               
              
              call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,      &
                           imrt_mpi(imrt),trim(strbuffer),             &
                           offset_imrt(imrt), 1, 1, 1, .true.,.true.,  &
                           b_output_multizone)
              offset_imrt_ijk(imrt) = offset_imrt(imrt) - 5*4
              
              call tecplot_binary_write_section(PETSC_COMM_SELF,       &
                           imrt_mpi(imrt),nvarsimrt,0,                 &
                           offset_imrt(imrt),.true.,.true.,            &
                           b_output_multizone) 
            else
              if (i_append_sim < 1 .or. .not.b_rewind_valid) then

                write(imrt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

                strbuffer = 'variables = "time ['//                    &
                            time_unit(:l_time_unit)//']", '//          &
                            '"change in storage [mol/d]", '//          &
                            '"source/sink - aqueous phase [mol/d]", '//&
                            '"total contribution [mol/elapsed time]", '
                
                if (istart == istop) then
                  strbuffer = trim(strbuffer)//                        &
                              '"source/sink - aqueous phase '//        &
                              'parallel reaction pathways [mol/d]", '//&
                              '"total contribution '//                 &
                              'parallel reaction pathways [mol/elapsed time]"'
                else
                  do ireac = istart, istop
                    write(strtemp,'(i0)') ireac-istart+1
                    if (ireac == istop) then
                      strbuffer = trim(strbuffer)//                    &
                                  '"source/sink - aqueous phase '//    &
                                  'parallel reaction pathways - '//    &
                                  trim(strtemp)//' [mol/d]", '//       &
                                  '"total contribution '//             &
                                  'parallel reaction pathways - '//    &
                                  trim(strtemp)//' [mol/elapsed time]"'
                    else
                      strbuffer = trim(strbuffer)//                    &
                                  '"source/sink - aqueous phase '//    &
                                  'parallel reaction pathways - '//    &
                                  trim(strtemp)//' [mol/d]", '//       &
                                  '"total contribution '//             &
                                  'parallel reaction pathways - '//    &
                                  trim(strtemp)//' [mol/elapsed time]", '
                    end if
                  end do
                end if
                
                write(imrt,'(a)') trim(strbuffer)

                write(imrt,'(4a)') 'zone t = "mass balance - mineral ',&
                      'phase for ', trim(namem(im)), '", f=point'
              end if
            end if

            strl36 = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.mmc'
            write(ifls,'(2a)') strl36,namem(im)

            end if

          end do           !(im=1,nm)
          
          if (b_enable_output) then
            write(ifls,'(/a)')                                         &
                  'column   entry                           unit'
            write(ifls,'(2a)')                                         &
                  '1        time                            ',time_unit
            write(ifls,'(a)')                                          &
                  '2        change in storage               moles/day'
            write(ifls,'(a)')                                          &
                  '3        source/sink - aqueous phase     moles/day'
            write(ifls,'(a)')                                          &
                  '4        total contribution              moles'
            write(ifls,'(a/a)')                                        &
                  '5 -      source/sink - aqueous phase     moles/day',&
                  '5+Np-1   parallel reaction pathways               '
            write(ifls,'(a/a)')                                        &
                  '5+Np -   total contribution              moles',    &
                  '5+2*Np-1 parallel reaction pathways               '
          end if

        end if             !(nm.gt.0)

!c  pointer to last mass balance file for reactive transport

        imrt_last = imrt

      end if

      return
      end
