!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readzone.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readzone
!c -------------------
!c
!c this subroutine reads a section from the input file unit nin 
!c the block has to start with zone_name='name of zone' and has to end 
!c with 'end of zone' data is written to unit nout for further processing in 
!c the main program 
!c comment lines starting with ! are skipped  
!c both units are rewind after the procedure is finished
!c
!c written by:      Uli Mayer - February 23, 97
!c
!c last modified:
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Add support for long string *256
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ---------- 
!c           nin                = id number of input file             + -
!c           nout               = id number of output file            + -
!c           ilog               = unit number, log book               + -
!c
!c           character:
!c           ----------
!c           zone_name          = character string defining name      + -
!c                                of zone in input file
!c
!c           found              = .true.  -> zone was found in input  * +
!c                                           file
!c
!c common:   -
!c
!c local:    integer*4:
!c           ----------
!c           l_zone_name        = length of zone name
!c
!c           character:
!c           ----------
!c           dummy1             = dummy character string
!c           dummy2             = dummy character string
!c
!c external: -
!c ----------------------------------------------------------------------
      subroutine readzone (nin,nout,ilog,zone_name,found)
      
      use gen, only : rank, b_enable_output
#ifdef PETSC      
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      
      implicit none
      integer :: nin, nout, ilog
      logical :: found
      character(len=*) :: zone_name
      
!c  local variables
      integer :: l_zone_name

!c  change from 72 to 256 to support long string, e.g., database full path
      character*256 :: dummy1, dummy2, strbuffer      

      found = .false.
 
!c  rewind unit nout from previous read-procedure in main routine
 
      rewind nin
      rewind nout

!c  read and write procedure
 
100   continue
      read(nin,*,end=400,err=999) dummy1
      if (trim(dummy1).eq.trim(zone_name)) then
        found = .true.
200     continue
        read(nin,*,end=500,err=999) dummy1
        backspace(nin) 
        read(nin,'(a)',err=999) dummy2
        if (dummy2(1:1).ne.'!') then
          write(nout,'(a)') trim(dummy2)
        end if
        if (trim(dummy1).eq.'end of zone') then
          goto 300
        end if
        goto 200
      else
        goto 100
      end if
 
300   continue
 
      rewind nin
      rewind nout
  
400   return 

500   l_zone_name = index(zone_name,'  ')-1
      if (l_zone_name.eq.-1.or.l_zone_name.gt.72) then
         l_zone_name=72
      end if
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'marker "end of zone" not found'
        write(ilog,*) 'zone "',zone_name(:l_zone_name),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(nin)
      read(nin,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in read zone: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in read zone: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end subroutine readzone


      subroutine readzone_end_with_dbsbk (nin,nout,nout_bk,ilog,zone_name,zone_name_end,found)
      
      use gen, only : rank, b_enable_output
#ifdef PETSC      
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      
      implicit none
      integer :: nin, nout, nout_bk, ilog
      logical :: found
      character(len=*) :: zone_name, zone_name_end
      
!c  local variables
      integer :: l_zone_name

!c  change from 72 to 256 to support long string, e.g., database full path
      character*256 :: dummy1, dummy2, strbuffer

      found = .false.
 
!c  rewind unit nout from previous read-procedure in main routine
 
      rewind nin
      rewind nout

!c  read and write procedure
 
100   continue
      read(nin,*,end=400,err=999) dummy1
      if (trim(dummy1).eq.trim(zone_name)) then
        found = .true.
        write(nout,'(a)') "'"//trim(zone_name)//"'"
        if (nout_bk > 0 .and. rank == 0) then
          write(nout_bk,'(a)') "'"//trim(zone_name)//"'"
        end if
200     continue
        read(nin,*,end=500,err=999) dummy1
        backspace(nin) 
        read(nin,'(a)',err=999) dummy2
        if (dummy2(1:1).ne.'!') then
          write(nout,'(a)') trim(dummy2)
          if (nout_bk > 0 .and. rank == 0) then
            write(nout_bk,'(a)') trim(dummy2)
          end if
        end if
        if (trim(dummy1).eq.trim(zone_name_end)) then
          goto 300
        end if
        goto 200
      else
        goto 100
      end if
 
300   continue
 
      rewind nin
      rewind nout
  
400   return 

500   l_zone_name = index(zone_name,'  ')-1
      if (l_zone_name.eq.-1.or.l_zone_name.gt.72) then
         l_zone_name=72
      end if
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file'
        write(ilog,*) 'marker "end of zone" not found'
        write(ilog,*) 'zone "',zone_name(:l_zone_name),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      backspace(nin)
      read(nin,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in read zone: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in read zone: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end subroutine readzone_end_with_dbsbk
