!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/mem_nsb.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine mem_nsb
!c ------------------
!c
!c allocate memory for one-dimensional arrays of size nsb and related 
!c arrays
!c
!c written by:      Uli Mayer - January 7, 2000
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    integer:
!c           --------
!c           ilog               = unit number, logbook file           + -
!c
!c
!c chem.f:   real*8:
!c           -------
!c           cec_fraction(nsites_ion)                                * +
!c                              = cec fraction of multisite ion-
!c                                exchange sites 
!c           csb(nsb)           = concentrations of sorbed species    * +
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads)
!c                              = concentrations of sorbed species    * +
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * +
!c                                - new time level (surface-complex)
!c           chargesb(nsb)      = charge of sorbed species            * +
!c           chargesb_ion(nsb_ion)   = charge of sorbed species       + -
!c                                     (ion-exchange)
!c           chargesb_surf(nsb_surf) = charge of sorbed species       + -
!c                                     (surface-complex)
!c           dhcsb(nsb)         = enthalpy change for sorbed species  * +
!c           dhcsb_ion(nsb_ion) = enthalpy change for sorbed species  * +
!c                                of ion-exchange
!c           dhcsb_surf(nsb_surf) = enthalpy change for sorbed species  * +
!c                                  of surface-complex
!c           distcoff_lc(nc)    = sorption distribution coefficient   * +
!c                                [L H_2O/L bulk] 
!c                                - reactive transport
!c           eqsb(nsb)          = equilibrium constants for           * +
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           * +
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           * +
!c                                sorbed species (surface-complex)
!c           eqsbs(nsb)         = equilibrium constants for           * +
!c                                sorbed species at standard
!c                                temperature
!c           eqsbs_ion(nsb_ion) = equilibrium constants for           * +
!c                                sorbed species at standard
!c                                temperature (ion-exchange)
!c           eqsbs_surf(nsb_surf)= equilibrium constants for          * +
!c                                sorbed species at standard
!c                                temperature (surface-complex)
!c           gfwsb(nsb)         = gram formula weight for sorbed      * +
!c                                species
!c           gfwsb_ion(nsb_ion)  
!c                              = gram formula weight for sorbed     * +
!c                                   species
!c           gfwsb_surf(nsb_surf)
!c                              = gram formula weight for sorbed     * +
!c                                   species
!c           totan(nc,nthreads) = total sorbed component              * +
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk)
!c           totao(nc)          = total sorbed component              * +
!c                                concentrations
!c                                non-competitive sorption
!c                                - old time level [moles/l bulk)
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   * +
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)
!c                              = stoichiometric coefficient matrix   * +
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)
!c                              = stoichiometric coefficient matrix   * +
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c           site_area(nsites)  = surface area of mineral phase       * +
!c                                [m^2 surface g^-1 mineral]
!c           site_dens(nsites)  = site density                        * +
!c                                [sites nm^-2 surface]
!c           site_mass(nsites)  = mass of mineral phase               * +
!c                                [g L-1 h2o]
!c           dcsb(nsb)          = derivatives of concentrations of    * +
!c                                sorbed species with respect to
!c                                primary species
!c           dcsb_ion(nsb_ion,nthreads)  
!c                              = derivatives of concentrations of    * +
!c                                sorbed species with respect to
!c                                primary species (ion-exchange)
!c           dcsb_surf(nsb_surf,nthreads)  
!c                              = derivatives of concentrations of    * +
!c                                  sorbed species with respect to
!c                                  primary species (surface-complex)
!c
!c           integer:
!c           --------
!c           iaic(nsites)       = pointer array for compressed        * +
!c                                storage of surface site data
!c           iasb(nsb+1)        = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           jasb(nsb*nc)       = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          * +
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           l_nameanc(nc)      = length of names of sorbed           * +
!c                                components (non-competitive
!c                                sorption
!c           l_namesb(nsb)      = length of names of sorbed           * +
!c                                species
!c           l_namesb_ion(nsb)  = length of names of sorbed           * +
!c                                species (ion-exchange)
!c           l_namesb_nsites_ion = length of names of surface         * +
!c            (nsites_ion)        sites of ion-exchange
!c           idx_nsites_ion     = index of sites of sorbed            * +
!c            (nsites_ion)        species of ion-exchange (multisite)
!c           nss_onIsite_ion     = number of sorbed species on each   * +
!c            (nsites_ion)        site of ion-exchange (multisite)
!c           idx_ss2isite_ion     = index of sorbed species on each   * +
!c            (nsites_ion,nsb_ion)  site of ion-exchange (multisite)
!c           l_namesb_surf(nsb) = length of names of sorbed           * +
!c                                species (surface-complex)
!c           nc                 = number of components including h2o  + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           character:
!c           ----------
!c           namenanc(nc)       = names of sorbed species             * +
!c                                non-competitive sorption
!c           namesb(nsb)        = names of sorbed species             * +
!c
!c           logical:
!c           -------
!c           noncompetitive_sorption = logical array for activation   + -
!c                                     of noncompetitive sorption
!c                                     reactions
!c
!c local:    integer:
!c           --------
!c           ierr               = 0 -> memory allocation successful
!c
!c external: checkerr  = check for error during memory allocation
!c
!c---------------------------------------------------------------------- 
!c WARNING
!c---------------------------------------------------------------------- 
!c All allocated variables are initialized to some value. This depends  
!c of its type:
!c 
!c real*8      => 0.0d0
!c integer     => 0 
!c character   => ' '    
!c logical     => .false. 
!c 
!c Sergio Andres Bea Jofre (2009)
!c
!c ----------------------------------------------------------------------
  
      subroutine mem_nsb
 
      use parm
      use gen
      use chem
      
      implicit none
      
      integer :: ierr
 
      external checkerr
      
      !integer, intent(in), optional :: itype_in
      !integer :: itype
      !
      !itype = 1
      !
      !if(present(itype_in)) then
      !    itype = itype_in
      !end if
      
      if (nsites > 0) then
      
          allocate (site_area(nsites), stat = ierr)
          site_area=0.0d0
          call checkerr(ierr,'site_area',ilog)
          call memory_monitor(sizeof(site_area),'site_area',.true.)

          allocate (site_dens(nsites), stat = ierr)
          site_dens=0.0d0
          call checkerr(ierr,'site_dens',ilog)
          call memory_monitor(sizeof(site_dens),'site_dens',.true.)

          allocate (site_mass(nsites), stat = ierr)
          site_mass=0.0d0
          call checkerr(ierr,'site_mass',ilog)
          call memory_monitor(sizeof(site_mass),'site_mass',.true.)

          allocate (site_mass_tmp(nsites), stat = ierr)
          site_mass_tmp=0.0d0
          call checkerr(ierr,'site_mass_tmp',ilog)
          call memory_monitor(sizeof(site_mass_tmp),'site_mass_tmp',.true.)

          allocate (site_mass_tot(nsites), stat = ierr)
          site_mass_tot=0.0d0
          call checkerr(ierr,'site_mass_tot',ilog)
          call memory_monitor(sizeof(site_mass_tot),'site_mass_tot',.true.)

          if (nngl > 0) then
            allocate (site_mass_cvol(nsites,nngl), stat = ierr)
            site_mass_cvol=0.0d0
            call checkerr(ierr,'site_mass_cvol',ilog)
            call memory_monitor(sizeof(site_mass_cvol),'site_mass_cvol',.true.)
          end if
      
          allocate (iaic(nsites), stat = ierr)
          iaic=0 
          call checkerr(ierr,'iaic',ilog)
          call memory_monitor(sizeof(iaic),'iaic',.true.)
      end if
      
      if (nsites_ion >= 1) then
          allocate (cec_fraction(nsites_ion), stat = ierr)
          cec_fraction=0.0d0
          cec_fraction(1) = 1.0d0
          call checkerr(ierr,'cec_fraction, check keywords of sorbed species',ilog)
          call memory_monitor(sizeof(cec_fraction),'cec_fraction',.true.)
      end if

!c  main variables - sorbed species
      !if(itype == 1) then
      !  if(nsb > 0)  then
      !    allocate (csb(nsb), stat = ierr)
      !    csb=0.0d0
      !    call checkerr(ierr,'csb',ilog)
      !
      !    allocate (chargesb(nsb), stat = ierr)
      !    chargesb=0.0d0
      !    call checkerr(ierr,'chargesb',ilog)
      !
      !    allocate (gfwsb(nsb), stat = ierr)
      !    gfwsb=0.0d0 
      !    call checkerr(ierr,'gfwsb',ilog)
      !
      !    allocate (eqsb(nsb), stat = ierr)
      !    eqsb=0.0d0 
      !    call checkerr(ierr,'eqsb',ilog)
      !
      !    allocate (eqsbs(nsb), stat = ierr)
      !    eqsbs=0.0d0
      !    call checkerr(ierr,'eqsbs',ilog)
      !
      !    allocate (dhcsb(nsb), stat = ierr)
      !    dhcsb=0.0d0 
      !    call checkerr(ierr,'dhcsb',ilog)
      !
      !    allocate (xnusb(nsb*nc), stat = ierr)
      !    xnusb=0.0d0
      !    call checkerr(ierr,'xnusb',ilog)
      !
      !    allocate (iasb(nsb+1), stat = ierr)
      !    iasb=0.0d0 
      !    call checkerr(ierr,'iasb',ilog)
      !
      !    allocate (jasb(nsb*nc), stat = ierr)
      !    jasb=0.0d0
      !    call checkerr(ierr,'jasb',ilog)
      !
      !    allocate (l_namesb(nsb), stat = ierr)
      !    l_namesb=0 
      !    call checkerr(ierr,'l_namesb',ilog)
      !
      !    allocate (namesb(nsb), stat = ierr)
      !    namesb=' ' 
      !    call checkerr(ierr,'namesb',ilog)
      !    
      !    !c  newton iteration
      !    allocate (dcsb(nsb), stat = ierr)
      !    dcsb=0.0d0 
      !    call checkerr(ierr,'dcsb',ilog) 
      !  end if
      !    
      !else if (itype == 2) then
          
        if(nsb_surf > 0 .or. nsb_ion > 0)  then
          !******surface-complex data******
          allocate (csb_surf(nsb_surf,nthreads), stat = ierr)
          csb_surf=0.0d0
          call checkerr(ierr,'csb_surf',ilog)
          call memory_monitor(sizeof(csb_surf),'csb_surf',.true.)


          allocate (chargesb_surf(nsb_surf), stat = ierr)
          chargesb_surf=0.0d0
          call checkerr(ierr,'chargesb_surf',ilog)
          call memory_monitor(sizeof(chargesb_surf),'chargesb_surf',.true.)

          allocate (gfwsb_surf(nsb_surf), stat = ierr)
          gfwsb_surf=0.0d0 
          call checkerr(ierr,'gfwsb_surf',ilog)
          call memory_monitor(sizeof(gfwsb_surf),'gfwsb_surf',.true.)

          allocate (eqsb_surf(nsb_surf,nthreads), stat = ierr)
          eqsb_surf=0.0d0 
          call checkerr(ierr,'eqsb_surf',ilog)
          call memory_monitor(sizeof(eqsb_surf),'eqsb_surf',.true.)

          allocate (eqsbs_surf(nsb_surf), stat = ierr)
          eqsbs_surf=0.0d0
          call checkerr(ierr,'eqsbs_surf',ilog)
          call memory_monitor(sizeof(eqsbs_surf),'eqsbs_surf',.true.)

          allocate (dhcsb_surf(nsb_surf), stat = ierr)
          dhcsb_surf=0.0d0 
          call checkerr(ierr,'dhcsb_surf',ilog)
          call memory_monitor(sizeof(dhcsb_surf),'dhcsb_surf',.true.)

          allocate (xnusb_surf(nsb_surf*nc), stat = ierr)
          xnusb_surf=0.0d0
          call checkerr(ierr,'xnusb_surf',ilog)
          call memory_monitor(sizeof(xnusb_surf),'xnusb_surf',.true.)

          allocate (iasb_surf(nsb_surf+1), stat = ierr)
          iasb_surf=0 
          call checkerr(ierr,'iasb_surf',ilog)
          call memory_monitor(sizeof(iasb_surf),'iasb_surf',.true.)

          allocate (jasb_surf(nsb_surf*nc), stat = ierr)
          jasb_surf=0
          call checkerr(ierr,'jasb_surf',ilog)
          call memory_monitor(sizeof(jasb_surf),'jasb_surf',.true.)

          allocate (l_namesb_surf(nsb_surf), stat = ierr)
          l_namesb_surf=0 
          call checkerr(ierr,'l_namesb_surf',ilog)
          call memory_monitor(sizeof(l_namesb_surf),'l_namesb_surf',.true.)

          allocate (namesb_surf(nsb_surf), stat = ierr)
          namesb_surf=' ' 
          call checkerr(ierr,'namesb_surf',ilog)
          call memory_monitor(sizeof(namesb_surf),'namesb_surf',.true.)

          allocate (isurf2isite(nsb_surf), stat = ierr)
          isurf2isite =0 
          call checkerr(ierr,'isurf2isite',ilog)
          call memory_monitor(sizeof(isurf2isite),'isurf2isite',.true.)

          !c newton iteration

          allocate (dcsb_surf(nsb_surf,nthreads), stat = ierr)
          dcsb_surf=0.0d0 
          call checkerr(ierr,'dcsb_surf',ilog) 
          call memory_monitor(sizeof(dcsb_surf),'dcsb_surf',.true.)

        
          !******ion-exchange data******
          allocate (csb_ion(nsb_ion,nthreads), stat = ierr)
          csb_ion=0.0d0
          call checkerr(ierr,'csb_ion',ilog)
          call memory_monitor(sizeof(csb_ion),'csb_ion',.true.)

          allocate (chargesb_ion(nsb_ion), stat = ierr)
          chargesb_ion=0.0d0
          call checkerr(ierr,'chargesb_ion',ilog)
          call memory_monitor(sizeof(chargesb_ion),'chargesb_ion',.true.)

          allocate (gfwsb_ion(nsb_ion), stat = ierr)
          gfwsb_ion=0.0d0 
          call checkerr(ierr,'gfwsb_ion',ilog)
          call memory_monitor(sizeof(gfwsb_ion),'gfwsb_ion',.true.)

          allocate (eqsb_ion(nsb_ion,nthreads), stat = ierr)
          eqsb_ion=0.0d0 
          call checkerr(ierr,'eqsb_ion',ilog)
          call memory_monitor(sizeof(eqsb_ion),'eqsb_ion',.true.)

          allocate (eqsbs_ion(nsb_ion), stat = ierr)
          eqsbs_ion=0.0d0
          call checkerr(ierr,'eqsbs_ion',ilog)
          call memory_monitor(sizeof(eqsbs_ion),'eqsbs_ion',.true.)

          allocate (dhcsb_ion(nsb_ion), stat = ierr)
          dhcsb_ion=0.0d0 
          call checkerr(ierr,'dhcsb_ion',ilog)
          call memory_monitor(sizeof(dhcsb_ion),'dhcsb_ion',.true.)

          allocate (xnusb_ion(nsb_ion*nc), stat = ierr)
          xnusb_ion=0.0d0
          call checkerr(ierr,'xnusb_ion',ilog)
          call memory_monitor(sizeof(xnusb_ion),'xnusb_ion',.true.)

          allocate (iasb_ion(nsb_ion+1), stat = ierr)
          iasb_ion=0 
          call checkerr(ierr,'iasb_ion',ilog)
          call memory_monitor(sizeof(iasb_ion),'iasb_ion',.true.)

          allocate (jasb_ion(nsb_ion*nc), stat = ierr)
          jasb_ion=0
          call checkerr(ierr,'jasb_ion',ilog)
          call memory_monitor(sizeof(jasb_ion),'jasb_ion',.true.)

          allocate (l_namesb_ion(nsb_ion), stat = ierr)
          l_namesb_ion=0 
          call checkerr(ierr,'l_namesb_ion',ilog)
          call memory_monitor(sizeof(l_namesb_ion),'l_namesb_ion',.true.)

          allocate (namesb_ion(nsb_ion), stat = ierr)
          namesb_ion=' ' 
          call checkerr(ierr,'namesb_ion',ilog)
          call memory_monitor(sizeof(namesb_ion),'namesb_ion',.true.)

          allocate (ion2isite(nsb_ion), stat = ierr)
          ion2isite =0 
          call checkerr(ierr,'ion2isite',ilog)
          call memory_monitor(sizeof(ion2isite),'ion2isite',.true.)
          
          !c  newton iteration
          allocate (dcsb_ion(nsb_ion,nthreads), stat = ierr)
          dcsb_ion=0.0d0 
          call checkerr(ierr,'dcsb_ion',ilog) 
          call memory_monitor(sizeof(dcsb_ion),'dcsb_ion',.true.)
          
          allocate (namesb_sites_ion(nsites_ion), stat = ierr)
          namesb_sites_ion=' ' 
          call checkerr(ierr,'namesb_nsites_ion',ilog)
          call memory_monitor(sizeof(namesb_sites_ion),'namesb_sites_ion',.true.)

          allocate (l_namesb_nsites_ion(nsites_ion), stat = ierr)
          l_namesb_nsites_ion=0 
          call checkerr(ierr,'l_namesb_nsites_ion',ilog)
          call memory_monitor(sizeof(l_namesb_nsites_ion),'l_namesb_nsites_ion',.true.)
          
          allocate (idx_nsites_ion(nsb_ion), stat = ierr)
          idx_nsites_ion=1 
          call checkerr(ierr,'idx_nsites_ion',ilog)
          call memory_monitor(sizeof(idx_nsites_ion),'idx_nsites_ion',.true.)
          
          allocate (nss_onIsite_ion(nsites_ion), stat = ierr)
          nss_onIsite_ion=1 
          call checkerr(ierr,'nss_onIsite_ion',ilog)
          call memory_monitor(sizeof(nss_onIsite_ion),'nss_onIsite_ion',.true.)
          
          allocate (idx_ss2isite_ion(nsites_ion,nsb_ion), stat = ierr)
          idx_ss2isite_ion = -1 
          call checkerr(ierr,'idx_ss2isite_ion',ilog)
          call memory_monitor(sizeof(idx_ss2isite_ion),'idx_ss2isite_ion',.true.)

        end if  
        
      !end if

!c  non-competitive sorption

!      if (noncompetitive_sorption) then
!     
!        allocate (distcoff_lc(nc), stat = ierr)
!        distcoff_lc=0.0d0
!        call checkerr(ierr,'distcoff_lc',ilog)
!     
!        allocate (totan(nc,nthreads), stat = ierr)
!        totan=0.0d0 
!        call checkerr(ierr,'totan',ilog)
!     
!        allocate (totao(nc), stat = ierr)
!        totao=0.0d0 
!        call checkerr(ierr,'totao',ilog)
!    
!        allocate (l_nameanc(nc), stat = ierr)
!        l_nameanc=0 
!        call checkerr(ierr,'l_nameanc',ilog)
!     
!        allocate (nameanc(nc), stat = ierr)
!        nameanc=' ' 
!        call checkerr(ierr,'nameanc',ilog)
!
!      end if 

      return
      end
