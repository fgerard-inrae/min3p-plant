!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/updtsurf.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtsurf
!c -------------------
!c
!c update concentrations of surface sites and check for convergence
!c (local chemistry)
!c
!c written by:      Uli Mayer - March 18, 00
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           c(nc-1)            = concentrations of free species      + +
!c                                [moles/l water] 
!c           ulc(nc-1)          = update towards solution-vector      + +
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number, log file               + -
!c
!c           logical:
!c           --------
!c           not_converged      = .true.  -> continue Newton          + +
!c                                           iteration
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           srelfac_lc
!c                              = user specified underrelaxation      + -
!c                                factor
!c           tol_lc             = convergence tolerance               + -
!c                                (reactive transport)
!c
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           idetail_lc
!c                              = information level                   + -
!c           iter_lc(nthreads)  = current newton iteration            + -
!c           nc                 = number of components excluding h2o  + -
!c                                equals number of unknowns per
!c                                control volume
!c           nopu               = number of primary unknowns          + -
!c           nsites             = number of surface sites             + -
!c
!c           logical:
!c           --------
!c           under_relax_lc     = .true.  -> underrelaxation          + -
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c
!c local:    real*8:
!c           -------
!c           enat               = e
!c           r0                 = constant
!c           r1                 = constant
!c           ulcmax             = actual maximum update
!c           ulclim             = allowed maximum update
!c
!c           integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           icount             = counter (non-convergent components)
!c           isites             = counter (surface sites)
!c           ivol               = counter (number of control volumes)
!c           maxvol             = volume with maximum solution update
!c           nexvol             = number of volumes exceeding update
!c                                tolerance
!c
!c           character:
!c           ----------
!c           name               = name of chemical species
!c                                (max update)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine updtsurf(c,ulc,ilog,tid,not_converged,over_flow_lc)
 
      use parm
      use chem
      use dens, only : aq_conc_field
      use gen, only: rank, b_enable_output

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      
      implicit none
      
      real*8 :: c, ulc
      integer :: ilog, tid
      
      dimension c(*),ulc(*)
      
      
      logical not_converged, over_flow_lc
      character*72 name
 
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0,  r10 = 1.0d1,       &
     &                     enat = 2.71828182845904509d0
      
      integer :: ic, isites, info_debug
      real*8 :: ulclim, ulcmax
      
      name = ''
      ulclim = r1 * enat

!c  update solution after new iteration, check for global convergence
  
      ulcmax = r0

      do isites = 1,nsites            !loop over suraface sites

        ic = iaic(isites) 

!c  user specified underrelaxation

        if (under_relax_lc) then
          ulc(ic) = srelfac_lc * ulc(ic)
        end if

!c  use line search, if absolute magnitude of update too large 
!c  limit magnitude of update to one log cycle
 
        if (ulc(ic).gt.ulclim) then    
          ulc(ic) = ulclim
        elseif (ulc(ic).lt.-ulclim) then
          ulc(ic) = -ulclim
        end if

!c  update ln c = ln c + delta (ln c)

        c(ic) = dlog(c(ic)) + ulc(ic)

!c  convert to concentrations

        c(ic) = enat**c(ic)

!cdsu apply concentration limitation to avoid numerical instability
        if (c(ic) < conc_corr_min) then
          c(ic) = conc_corr_min
        else if (c(ic) > conc_corr_max) then
          c(ic) = conc_corr_max
        end if        

!c  determine maximum update

        if (dabs(ulc(ic)).gt.dabs(ulcmax)) then
          ulcmax = ulc(ic)
          name = namec(ic)
        else if (ulc(ic) /= ulc(ic)) then
          over_flow_lc = .true.
          return
        end if
      end do                           !loop over components

!c  report maximum update in log_10 cycles

      !ulcmax = ulcmax/enat          !Error in conversion, DSU, 2014-04-09
      ulcmax = ulcmax/dlog(r10)

!c  determine, if global convergence is achieved
 
      if (dabs(ulcmax).lt.tol_lc) then
        not_converged = .false.
      end if

!c  write convergence history to screen
 
      if (rank == 0 .and. b_enable_output) then
        if (idetail_lc.gt.0 .and. .not.aq_conc_field) then
          if (iter_lc(tid).eq.1 .or. idetail_lc.eq.2) then
            write(ilog,'(a)') ' Newton Iteration Convergence Summary For Chemistry:'
            write(ilog,'(a)') ' Newton     maximum    for         '
            write(ilog,'(a)') ' iteration  update     component   '
          end if
  
          write(ilog,'(i6,5x,1pe11.4,1x,a12)') iter_lc(tid),ulcmax,name
  
        end if
      end if
      
!cdbg
      info_debug = 0
      if (info_debug.gt.0) then
        write(*,*)
        do isites = 1,nsites
          ic = iaic(isites)
          write(*,*) trim(namec(ic))," ", ulc(ic)
        end do
        write(*,*)
      end if
      if (info_debug.eq.2) then
        !pause
      elseif (info_debug.eq.3) then
#ifdef PETSC
        call petsc_mpi_finalize
#endif 
        stop
      end if
!cdbg

      return
      end 
