!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initicrt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initicrt
!c -------------------
!c
!c initial condition (reactive transport) 
!c
!c written by:      Uli Mayer - May 15, 96
!c
!c last modified:   Tom Henderson - June 2, 2004
!c                                  read initial aqueous conc from file 
!c                                  March 2007
!c                                  read nodal mineral surface areas from file
!c                  Rich Amos - 2006
!c                                  overwrite mineral distribution
!c                                  Sergi Molins - May 11, 2006 
!c                                  define/allocate min_to_overwrite and nmo
!c
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           porc               = porosity for local chemistry        + -
!c                                calculations
!c           sac                = air saturation for local            + -
!c                                chemistry calculations
!c           swc                = water saturation for local          + -
!c                                chemistry saturations
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           icnv               =  unit number, data conversion and   + -
!c                                            temporary storage
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           idbg               = unit number, debugging information  + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           itmp               = unit number, temporary storage      + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 * +
!c           mpropc(nn)         = pointer array for allocation of     * +
!c                                chemical material properties
!c
!c           logical:
!c           --------
!c           tec_header         = .true.  -> write header for tecplot + -
!c                                           postprocessing to output
!c                                           files
!c                                .false. -> skip headers
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       + -
!c           section_header     = section_header                      * +
!c           zone_name          = name of zone                        * +
!c
!c chem.f:   real*8:
!c           -------
!c           ccnew(nc)          = concentrations of free species      + +
!c                                - new time level [moles/l water]
!c           ccold(nc)          = concentrations of free species      + +
!c                                - old time level [moles/l water]
!c           cxc(nx)            = concentrations of secondary         * +
!c                                aqueous species
!c                                - new time level [moles/l water]
!c           cgc(ng)            = gas concentrations                  * +
!c                                - new time level [moles/l air]
!c           gamma_l(nc+nx)     = activity coefficients of aqueous    * *
!c                                species
!c           totcn(nc-1,nthreads)
!c                              = total aqueous component             * *
!c                                concentrations
!c                                - new time level [moles/l water]
!c
!c           integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           nm                 = number of minerals                  + -
!c
!c           logical:
!c           --------
!c           lb_output          = .true.  -> output of transient data * +
!c                                           (local chemistry)
!c           reactive_minerals  = .true.  -> consider mineral         * +
!c                                           dissolution-
!c                                           precipitation reaction
!c           redox_equil_lc     = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c           tiny               = small increment
!c           ximax              = max. limit of zone in x-direction
!c           ximin              = min. limit of zone in x-direction
!c           yimax              = max. limit of zone in y-direction
!c           yimin              = min. limit of zone in y-direction
!c           zimax              = max. limit of zone in z-direction
!c           zimin              = min. limit of zone in z-direction
!c
!c           integer*4:
!c           ----------
!c           iiz                = counter (zones)
!c           iminvol            = unit number, initial mimeral vol  
!c                                input file
!c           iminvnuc            = unit number, mimeral nucleation thresholds  
!c                                input file
!c           iaqvol            = unit number, initial aqueous  
!c                                concentration input file
!c           ivol               = counter (control volumes)
!c           l_string           = length of text string
!c           nntemp             = counter (control volumes
!c                                possessing initial condition)
!c           niz                = number of zones
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c           mineral_vol_field  = .true.  -> read mineral volume field
!c                                           from file prefix.min
!c           mineral_vnuc_field  = .true.  -> read mineral volume nucleation thresholds
!c                                           from file prefix.vnuc
!c           mineral_anuc_field  = .true.  -> read reference surface area of mineral volume nucleation thresholds
!c                                           from file prefix.anuc
!c           aq_conc_field  = .true.  -> read aqueous component concentrations
!c                                           from file prefix.aqt
!c
!c           character:
!c           ----------
!c           cdummy             = character dummy variable
!c           subsection         = name of subsection in input file
!c
!c external: clstpfls  = close postprocessing files for transient
!c                       data (local chemistry)
!c           findstrg  = find text string in file
!c           gcreact   = geochemical reactions for batch system
!c           icbcrt    = assign initial or boundary condition
!c                       to global system (reactive transport)
!c           icrtlczn  = read control parameters and initial
!c                       condition for current zone
!c                       (reactive transport or local chemistry)
!c           minmaxwd  = determine minimum total aqueous component
!c                       concentrations and maximum secondary aqueous 
!c                       species concentration in solution domain
!c           opnplfls  = open postprocessing files for
!c                       transient data (local chemistry)
!c           outputlc  = write results of local chemistry
!c                       computations to generic output file
!c           readbloc  = read section of input file and write to
!c                       temporary file
!c           rtrvpprm  = retrieve physical parameters
!c           setsize   = define number of primary unknowns
!c ----------------------------------------------------------------------
 
      subroutine initicrt

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use chem
      use dens
      use bbls
      use nobleGasIngrowth
      use mip_bubble, only : mip_mt_enable, mip_brt_num, mip_brt_idx
      use file_unit, only : lun_get, lun_free
      use file_utility, only : read_vtk_data_from_file
#ifdef OPENMP
      use omp_lib 
#endif
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
#ifdef USG
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use geometry
      use usg_mesh_data
      use read_zone_usg, only : read_zone_usg_input, type_extent_zone, &
                                type_extent_zone_box,                  &
                                type_flux_direction, flux_direction
#endif
!cprovi-----------------------------------------------------------------
!cprovi This was added by Sergio Andres Bea Jofre 
!cprovi We need the por variable
!cprovi-----------------------------------------------------------------
      use phys 
!cprovi-----------------------------------------------------------------
      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, i1, iaqvol, itid, ivol, icecvol, iiz, im, iminvol, &
                 iminsurf, iminvnuc, iminanuc, l_string, niz, nntemp,  &
                 ingi_field, ivolgbl,                                  &
                 nerrs, nwarns, nerrs_gbl, nwarns_gbl

#ifdef PETSC
      integer :: nntemp_gbl, nvols_gbl
      PetscErrorCode :: ierrcode
#endif

#ifdef USG
#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer :: ixmf
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
      integer(HID_T) :: iunit_hdf5
      integer(HID_T) :: iaqvol_hdf5
      integer(HID_T) :: iminvol_hdf5      
#endif
#endif
      
      real*8 :: rdummy, ximin, ximax, yimin, yimax, zimin, zimax, swc, &
                sac, porc, porc_old, rtot, rthresh

      integer :: tid, ierr, imo, istart, istop, j, nmo, ic, ix,        &
                 ire, ie, ince, ivol_l
      integer :: iskip, nskip, iunit_file, nvols, ierrcd

      external clstpfls, findstrg, icbcrt, icrtlczn, gcreact,          &
               minmaxwd, opnplfls, outputlc, readbloc, rtrvpprm,       &
               setsize, minmaxwd_mpi, mem_irm

      logical :: flag_nan, flag_stop, bflag
      logical :: found_section, found_subsection, b_mip_brt_src
      character*72 :: subsection
      character*1 :: cdummy
      
      integer, parameter :: nread = 4
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, tiny = 1.0d-6,      &
                           rsmall = 1.0d-10

      character*256 :: strfilename
      character*2048 :: strbuffer
      character*72, allocatable :: tec_variables(:)
      
      real*8, allocatable :: totco_gbl_tmp(:)

      logical :: mineral_vol_field_vtk, mineral_vnuc_field_vtk,        &
                 mineral_anuc_field_vtk, aq_conc_field_vtk,            &
                 mineral_surf_field_vtk, cec_field_vtk,                &
                 aq_conc_field_hdf5, mineral_vol_field_hdf5,           &
                 density_rock_ngi_field, density_rock_ngi_field_vtk,   &
                 conc_ngre_field, conc_ngre_field_vtk,                 &
                 wtfrac_nge_field, wtfrac_nge_field_vtk,               &
                 ncp_ngnce_field, ncp_ngnce_field_vtk

#ifdef USG
      logical :: bfound, bexist
      character*72 :: subcommand
      character*2048 :: strbuffer2048
      character*256 :: strfilename_result, strfilename_mesh
#endif

#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) ::                                 &
#else
      integer*8 ::                                                     &
#endif
                 offset_iaqt, offset_iaqt_temp
      
#ifdef OPENMP
      tid = omp_get_thread_num() + 1
#else
      tid = 1
#endif
      
!c  set defaults

      ierrcd = 0

      mineral_vol_field = .false.
      mineral_vnuc_field = .false.
      mineral_anuc_field = .false.
      aq_conc_field = .false.
      mineral_surf_field = .false.
      cec_field =.false. 

      mineral_vol_field_vtk = .false.
      mineral_vnuc_field_vtk = .false.
      mineral_anuc_field_vtk = .false.
      aq_conc_field_vtk = .false.
      mineral_surf_field_vtk = .false.
      cec_field_vtk =.false. 

      aq_conc_field_hdf5 = .false.
      mineral_vol_field_hdf5 = .false.

      density_rock_ngi_field = .false.
      density_rock_ngi_field_vtk = .false.
      conc_ngre_field = .false.
      conc_ngre_field_vtk = .false.
      wtfrac_nge_field = .false.
      wtfrac_nge_field_vtk = .false.
      ncp_ngnce_field = .false.
      ncp_ngnce_field_vtk = .false.


!c  initialize number of control volumes with assigned initial condition

      nntemp = 0
 
!c  read section header for initial condition (reactive transport)

      section_header = 'initial condition - reactive transport'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      endif

!c  terminate program if section header not found
      
      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  write section header to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/72a)')('-',i=1,72)
        write(igen,'(a)') section_header(:l_string)
        write(igen,'(72a)')('-',i=1,72)
      end if

      if(rank == 0 .and. b_enable_output) then
        write(*,'(/1x,a)') section_header(:l_string)
        write(*,'(1x,72a)')('-',i=1,72)
      end if
      
      if (rank == 0 .and. b_enable_output) then
        write(ilog,'(a)') section_header(:l_string)
        write(ilog,'(72a/)')('-',i=1,72)
      end if

!c  noble gas ingrowth related variables
      if (b_use_ngi) then
        call mem_ngi_inirt
      end if
 
!c  assign free species concentration for h2o

      ccnew(nc) = r1
      ccold(nc) = r1

!c  read number of zones for initial condition
      ierrcd = 1
      read(itmp,*,err=999,end=999) niz
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/a,i10)')  &
     &  'number of zones for initial condition           = ',niz
      end if

!c  allocate space for intermittent reaction related variables
      niz_irm = niz
      subsection = 'intermittent reactions'
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
        flag_intermittent_react = .true.
        call mem_irm
      else
        flag_intermittent_react = .false.        
      end if

!c  read initial total aqueous component concentrations as nodal values from separate file
!c  file must be named 'prefix'.aqt

!cdsu file format same as gst file but h+1 is output in pH
      subsection = 'read initial aqueous component concentrations from file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        aq_conc_field = .true.
      end if

      subsection = 'read initial mineral volume fractions from file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_vol_field = .true.
      end if      
        
      subsection = 'read mineral volume fractions nucleation thresholds from file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_vnuc_field = .true.
      end if      
     
      subsection = 'read nucleation threshold reference surface area from file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_anuc_field = .true.
      end if
     
      subsection = 'read initial mineral areas from file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_surf_field = .true.
      end if
     
      if (nsb_ion>0) then      
        subsection = 'read cec from file'
        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          cec_field = .true.
        end if        
      end if

!c  read noble gas ingrowth related parameters from files
      if (b_use_ngi) then
        subsection = 'read solid phase density from file'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then
          density_rock_ngi_field = .true.
        end if 

        if (ngre_i > 0) then
          subsection = 'read concentration of radioelements from file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            conc_ngre_field = .true.
          end if 
        end if

        if (nge_i > 0) then
          subsection = 'read weight fraction of elements from file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            wtfrac_nge_field = .true.
          end if 
        end if

        if (ngnce_i > 0) then
          subsection = 'read neutron capture probability from file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            ncp_ngnce_field = .true.
          end if 
        end if
      end if

#ifdef USG
!cdsu file format same as gst file but h+1 is output in pH
      subsection = 'read initial aqueous component concentrations from vtk file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        aq_conc_field = .true.
        aq_conc_field_vtk = .true.
      end if      

      subsection = 'read initial aqueous component concentrations from hdf5 file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        aq_conc_field = .true.
        aq_conc_field_hdf5 = .true.
      end if 
      
      subsection = 'read initial mineral volume fractions from vtk file'
      call findstrg(subsection,itmp,found_subsection)
      
      if (found_subsection) then
        mineral_vol_field = .true.
        mineral_vol_field_vtk = .true.
      end if

      subsection = 'read initial mineral volume fractions from hdf5 file'
      call findstrg(subsection,itmp,found_subsection)
      
      if (found_subsection) then
        mineral_vol_field = .true.
        mineral_vol_field_hdf5 = .true.
      end if
      
      subsection = 'read mineral volume fractions nucleation thresholds from vtk file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_vnuc_field = .true.
        mineral_vnuc_field_vtk = .true.
      end if      
     
      subsection = 'read nucleation threshold reference surface area from vtk file'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        mineral_anuc_field = .true.
        mineral_anuc_field_vtk = .true.
      end if
      
      subsection = 'read initial mineral areas from vtk file'
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
        mineral_surf_field = .true.
        mineral_surf_field_vtk = .true.
      end if
      
      if (nsb_ion>0) then
        subsection = 'read cec from vtk file'
        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          cec_field = .true.
          cec_field_vtk = .true.
        end if
      end if

!c  read noble gas ingrowth related parameters from vtk files
      if (b_use_ngi) then
        subsection = 'read solid phase density from vtk file'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then        
          density_rock_ngi_field = .true.
          density_rock_ngi_field_vtk = .true.
        end if 

        if (ngre_i > 0) then
          subsection = 'read concentration of radioelements from vtk file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            conc_ngre_field = .true.
            conc_ngre_field_vtk = .true.
          end if 
        end if

        if (nge_i > 0) then
          subsection = 'read weight fraction of elements from vtk file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            wtfrac_nge_field = .true.
            wtfrac_nge_field_vtk = .true.
          end if 
        end if

        if (ngnce_i > 0) then
          subsection = 'read neutron capture probability from vtk file'
          call findstrg(subsection,itmp,found_subsection)
          if (found_subsection) then
            ncp_ngnce_field = .true.
            ncp_ngnce_field_vtk = .true.
          end if 
        end if
      end if
#endif

      if (discretization_type == 0) then
        allocate(realbuffer(nn*(2+nc)), stat = ierr)
        realbuffer = 0.0d0
        call checkerr(ierr,'initicrt-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
      end if

      allocate(realbuffer2d(nc-1,nngl), stat = ierr)
      realbuffer2d = 0.0d0
      call checkerr(ierr,'initicrt-realbuffer2d',ilog)
      call memory_monitor(sizeof(realbuffer2d),'realbuffer2d',.true.)

!cprovi---------------------------------------------------------------------------------
!cprovi Read CEC field from file 
!cprovi Open the unit 
!cprovi Sergio Andres Bea Jofre
!cprovi Vancouver 16/11/2009
!cdsu   Move cec reading ahead and add vtk data format.
!cprovi---------------------------------------------------------------------------------      
      if (nsb_ion>0) then
        if (cec_field .and. .not.cec_field_vtk) then
          !icecvol=29
          icecvol = lun_get()
          open(icecvol,file=prefix(:l_prfx)//'.cec',status='old', &
              form='formatted')
          ierrcd = 2
          read(icecvol,*,err=999,end=999) cdummy
          read(icecvol,*,err=999,end=999) cdummy
          read(icecvol,*,err=999,end=999) cdummy
#ifdef USG
          if (discretization_type > 0) then
            do ivolgbl = 1,nngbl
#ifdef PETSC
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
              else
                ivol = node_idx_g2lg(ivolgbl)
              end if
#else
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2g_invord(ivolgbl)
              else
                ivol = ivolgbl
              end if
#endif
              if (ivol > 0) then
                ierrcd = 3
                read(icecvol,*,end=999,err=999) (rdummy, i=1,3),cec_g(ivol), &
                                                rhobulk_g(ivol)
              else
                ierrcd = 4
                read(icecvol,*,end=999,err=999) rdummy
              end if
            end do
          end if
#endif
          if (discretization_type == 0) then
            nskip = 0
            do ivol=1,nngl
#ifdef PETSC
              do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                ierrcd = 5
                read(icecvol,*,end=999,err=999) rdummy
              end do
              nskip = node_idx_lg2g(ivol)
#endif
              ierrcd = 6
              read(icecvol,*,end=999,err=999) (rdummy, i=1,3),cec_g(ivol), &
                                              rhobulk_g(ivol)
            end do
          end if

          close(icecvol)
          call lun_free(icecvol)
#ifdef USG
        else if (cec_field_vtk) then
          icecvol = lun_get()
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
            .not.read_spatial_master_proc) then            
            open(icecvol,file=prefix(:l_prfx)//'.cec.vtk',status='old',&
                 form='formatted')
          else
            call lun_free(icecvol)
            icecvol = 0
          end if

!c  read cec_g
          call read_vtk_data_from_file(icecvol,'cec',bfound,cec_g)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(a)') 'read cec from vtk file: done'
              write(ilog,'(a)') 'read cec from vtk file: done'
            end if
          end if

!c  read rhobulk_g
          call read_vtk_data_from_file(icecvol,'rhobulk',bfound,rhobulk_g)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(a)') 'read bulk density from vtk file: done'
              write(ilog,'(a)') 'read bulk density from vtk file: done'
            end if
          end if

          if (icecvol > 0) then
            close(icecvol)
            call lun_free(icecvol)
          end if          
#endif
        end if
      
      end if

!cprovi---------------------------------------------------------------------------------
!cprovi---------------------------------------------------------------------------------
!cprovi---------------------------------------------------------------------------------
      if(aq_conc_field) then

!c current program: only one zone allowed if aqueous concentrations are read from file
!cdsu this restriction has been lifted, DSU, 2020-08-03
!        if (niz .gt. 1) then
!          if (rank == 0) then
!            write(ilog,*) 'SIMULATION TERMINATED'
!            write(ilog,*) 'error reading input file'
!            write(ilog,*) 'section "', section_header(:l_string),'"'
!            write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
!            l_string = index(subsection,' ')-1
!            if (l_string.eq.-1.or.l_string.gt.72) then
!               l_string=72
!            end if
!            write(ilog,'(2a)') ' only one zone allowed if nodal aqueous',  &  
!                               ' concentrations are read from file'
!            close(ilog)
!          end if
!
!#ifdef PETSC
!          call petsc_mpi_finalize
!#endif
!          stop
!        end if


!c  open nodal file : use *.gst file format with three header rows
!c  pH column must be added in the correct order 

        iaqvol = lun_get()
        if (.not.(aq_conc_field_vtk.or.aq_conc_field_hdf5)) then          
          open(iaqvol,file=prefix(:l_prfx)//'.aqt',status='old',    &
     &            form='formatted')

          ierrcd = 7
          read(iaqvol,*,err=999,end=999) cdummy
          read(iaqvol,*,err=999,end=999) cdummy
          read(iaqvol,*,err=999,end=999) cdummy
#ifdef USG
        else if (aq_conc_field_vtk) then
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
            .not.read_spatial_master_proc) then
            open(iaqvol,file=prefix(:l_prfx)//'.aqt.vtk',status='old', &
                 form='formatted')
          else
            call lun_free(iaqvol)
            iaqvol = 0
          end if

!c  read aqueous concentration
          do ic = 1, nc-1
            call read_vtk_data_from_file(iaqvol,namec(ic),ic,1,bfound,realbuffer2d)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(3a)') 'read aqueous cencentration ',         &
                      trim(namec(ic)),' from vtk file: done'
                write(ilog,'(3a)') 'read aqueous cencentration ',      &
                      trim(namec(ic)),' from vtk file: done'
              end if
            else    !c for those components not found, assign a very small value
              do ivol = 1, nngl
                realbuffer2d(ic,ivol) = 1.0d-20
              end do
            end if
          end do

!c  hdf5 file format, for parallel version only
#ifdef PETSC_HDF
        else if (aq_conc_field_hdf5) then
!c  initialize parallel data mapping if not initialized
          if (.not. b_init_hdf5_lg2g) then

            strfilename = prefix(:l_prfx)//'.domain.h5'
            inquire(file=trim(strfilename),exist=bflag)
  
            if (bflag) then
              iunit_file = lun_get()
              iunit_hdf5 = int(iunit_file,kind(HID_T))
              call hdf5_usg_read_node_lg2g(iunit_hdf5,                   &
                                           trim(strfilename),hdf5_ierr)
              call lun_free(iunit_file)
  
              if (hdf5_ierr < 0) then
                if (rank == 0) then
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error in reading domain from hdf5 file'
                  write(ilog,*) 'file: ',trim(strfilename)
                  close(ilog)
                end if
                call petsc_mpi_finalize
                stop
              else
                if (rank == 0) then
                  write(*,'(a)') 'read domain from hdf5 file: done'
                  write(ilog,'(a)') 'read domain from hdf5 file: done'
                end if
              end if
  
              b_init_hdf5_lg2g = .true.
            else
              if (rank == 0) then
                write(ilog,*) 'SIMULATION TERMINATED'
                write(ilog,*) 'error in reading domain from hdf5 file'
                write(ilog,*) 'file is missing: ',prefix(:l_prfx)//'.domain.h5'
                close(ilog)
              end if
              call petsc_mpi_finalize
              stop    
            end if

          end if
         
          iaqvol_hdf5 = int(iaqvol,kind(HID_T))
          strfilename = prefix(:l_prfx)//'.aqt.h5'

!c  read aqueous concentration
          allocate(realbuffer2(nngl), stat = ierr)
          realbuffer2 = 0.0d0
          call checkerr(ierr,'initicrt-realbuffer2',ilog)
          call memory_monitor(sizeof(realbuffer2),'realbuffer2',.true.)

          do ic = 1, nc-1
            call hdf5_usg_read_node_var(iaqvol_hdf5, trim(strfilename),&
                      "results", trim(namec(ic)), realbuffer2, bexist, &
                      hdf5_ierr)

            if (hdf5_ierr < 0) then
              if (rank == 0) then
                write(ilog,*) 'SIMULATION TERMINATED'
                write(ilog,*) 'error in reading concentration from hdf5 file'
                write(ilog,*) 'file: ',trim(strfilename)
                close(ilog)
              end if
              call petsc_mpi_finalize
              stop
            else
              if (rank == 0) then
                write(*,'(a)') 'read concentration from hdf5 file: done'
                write(ilog,'(a)') 'read concentration from hdf5 file: done'
              end if
            end if
            if (bexist) then
              do ivol = 1, nngl
                realbuffer2d(ic,ivol) = realbuffer2(ivol)
              end do
            else    !c for those components not found, assign a very small value
              do ivol = 1, nngl
                realbuffer2d(ic,ivol) = 1.0d-20
              end do
            end if
          end do

          call memory_monitor(-sizeof(realbuffer2),'realbuffer2',.true.)
          deallocate(realbuffer2, stat = ierr)
#endif
#endif
        end if

!c  initialize control and input parameters for current zone 

        iiz = 1
        call icrtlczn(iiz)

!c  open output files for postprocessing

        if(rank == 0) then
          if (lb_output .and. b_enable_output) then
            call opnplfls(iiz)
          end if
        end if

!c  set number of primary unknowns for current batch problem
        call setsize(redox_equil_lc)

!c nodal aqueous concnentratins

        nskip = 0
#ifdef USG
        do ivolgbl = 1,nngbl
          if (discretization_type > 0) then
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
          else
            if (ivolgbl > nngl) then
              exit
            end if
            ivol = ivolgbl
          end if

#else
        do ivol=1,nngl
#endif
          if (aq_conc_field .and. .not.(aq_conc_field_vtk.or.          &
              aq_conc_field_hdf5)) then
!c read concentrations  
#ifdef USG
            if (discretization_type > 0) then
              if (ivol > 0) then
                ierrcd = 8
                read(iaqvol,*,end=999,err=999) (rdummy, i=1,3),       &
                    (totco(i1,tid),i1 = 1,nc-1)
              else
                ierrcd = 9
                read(iaqvol,*,end=999,err=999) rdummy
              end if
            end if
#endif
            if (discretization_type == 0) then
#ifdef PETSC
              do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                ierrcd = 10
                read(iaqvol,*,end=999,err=999) rdummy
              end do
              nskip = node_idx_lg2g(ivol)
#endif
              ierrcd = 11
              read(iaqvol,*,end=999,err=999) (rdummy, i=1,3),         &
                  (totco(i1,tid),i1 = 1,nc-1)
            end if

#ifdef USG
          else if (aq_conc_field_vtk .or. aq_conc_field_hdf5) then
            if (ivol > 0) then
              do ic = 1, nc-1
                totco(ic,tid) = realbuffer2d(ic,ivol)
              end do
            end if
#endif
          end if

#ifdef PETSC
          if (ivol < 1) then
            cycle
          end if
#endif

!cdsu -------------------------------------------------------------
!cdsu  Sync data to other slave threads
!cdsu -------------------------------------------------------------
          do itid = 1, nthreads
            totco(:,itid) = totco(:,tid)
          end do

!cdsu -------------------------------------------------------------
!cdsu  Check initial total mass
!cdsu -------------------------------------------------------------
          if (nsites > 0) then
            site_mass_cvol(1:nsites,ivol) = site_mass_tmp(1:nsites)*   &
                          (cvol(ivol)*1.0d3*sanew(ivol)*pornew(ivol))
          end if

!cprovi-------------------------------------------------------          
!cprovi This was added by Sergio Andres Bea Jofre 
!cprovi If CEC field was defined, then assign CEC and rhobulk
!cprovi corresponding to ivol 
!cprovi-------------------------------------------------------
          if (cec_field) then
             cec(:)=cec_g(ivol)
             rhobulk=rhobulk_g(ivol)
          end if 
!cprovi-------------------------------------------------------          
!cprovi-------------------------------------------------------          
!cprovi-------------------------------------------------------                    
!cprovi-------------------------------------------------------          
!c  retrieve physical parameters for scaling
          call rtrvpprm(swc,sac,porc,pornew(ivol),section_header)
!c  temperature correction
          if (temp_corr.or.heat_transport) then
            do itid = 1, nthreads
              call tcorr(tkel(ivol),ivol,itid)
            end do
          end if
!c-----------------------------------------------------------------------
!c  compute initial conditions for Newton Raphson
!c-----------------------------------------------------------------------
!cmx   The type of H+ is fixed to 'pH'. The type of 'O2(aq)' is not treated seperatly,
!cmx   which means it can only be given in concentration, not others like 'eh'.
          do ic=1,nc-1
            if (namec(ic).eq.'h+1') then
              ccold(ic) = 10.0**(-phguess)              !cmx
              ccnew(ic) = ccold(ic)
            else
              ccold(ic) = 1.0d-2*totco(ic,tid)
              ccnew(ic) = ccold(ic)
            end if
          end do

!c  assign volume number as zone_name
          write(zone_name,'(a,i0)') "local chemistry ivol = ", ivol
          zone_name = adjustl(zone_name)
          l_zone_name = len_trim(zone_name)

!c  compute initial condition
          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),      &
                     cgc,swc,sac,porc,igen,ilog,tid,idbg,tec_header,  &
                     prefix,l_prfx,zone_name,l_zone_name,             &
                     mtime,i_append_sim,mtime_append)

!c  determine minimum total aqueous component concentrations and maximum
!c  secondary aqueous species concentration in solution domain

          call minmaxwd(cxc,totcn(:,tid))

!c  assign initial condition to global system
          
          mpropc(ivol) = iiz

#ifdef PETSC
          if(node_idx_lg2l(ivol) > 0) then
            nntemp = nntemp+1
          end if
#else
          nntemp = nntemp+1
#endif

          call icbcrt(ivol,0,tid,aq_conc_field)

        end do         !(loop over control volumes)


        if (iaqvol > 0) then
          close(iaqvol)
          call lun_free(iaqvol)
        end if

!c  close files for postprocessing
        if(rank == 0) then
          if (lb_output .and. b_enable_output) then
            call clstpfls
          end if
        end if

#ifdef PETSC
        call minmaxwd_mpi
#endif
 
      end if         !(aq_conc_field)

!cdsu move the initialization to the top so that the read initial *** from file can work for 
!cdsu multiple zones, not limit to one zone only

        property_iflag = 0

!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------
!cprovi------------------------------------------------------------------------------------     
        do iiz=1,niz                            !loop over zones

!c  initialize control and input parameters for current zone 
          call icrtlczn(iiz)

!cdsu  set zone as mip bubble source
          b_mip_brt_src = .false.
          if (mip_mt_enable) then
            subsection = 'mip bubble source'
            call findstrg(subsection,icnv,found_subsection)
            if (found_subsection) then 
              b_mip_brt_src = .true.
            else
              subsection = 'invasion percolation bubble source'
              call findstrg(subsection,icnv,found_subsection)
              if (found_subsection) then 
                b_mip_brt_src = .true.
              end if
            end if
          end if

!c  read coordiantes delineating zone

          type_extent_zone = -1
          type_extent_zone_box = -1

          subsection = 'extent of zone'
          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then

            type_extent_zone = 0
            ierrcd = 12
            read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax,   &
                                         zimin,zimax

          end if

#ifdef USG
          call read_zone_usg_input(icnv)
          if (type_extent_zone_box > 0) then
            ierrcd = 13
            read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax,   &
                                         zimin,zimax
          end if
#endif

          !c check if x dimension is valid
          if (.not.btest(cell_projection,0)) then
            ximin = -1.0d300
            ximax = 1.0d300
          end if
  
          !c check if y dimension is valid
          if (.not.btest(cell_projection,1)) then
            yimin = -1.0d300
            yimax = 1.0d300
          end if
  
          !c check if z dimension is valid
          if (.not.btest(cell_projection,2)) then
            zimin = -1.0d300
            zimax = 1.0d300
          end if
          
!c  write error information if 'extent of zone' is missing
          if (type_extent_zone < 0) then

            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',trim(section_header),'"'
              write(ilog,*) 'zone "', trim(zone_name),'"'
              write(ilog,*) 'subsection "',trim(subsection),'" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if


!c  set number of primary unknowns for current batch problem

          call setsize(redox_equil_lc)

!c  open output files for postprocessing
  
          if(rank == 0) then 
            if (lb_output .and. b_enable_output) then
              call opnplfls(iiz)
            end if
          end if

!c  temperature correction
          if (temp_corr.or.heat_transport) then
            do itid = 1, nthreads
              call tcorr(tempk,0,itid)
            end do
          end if

!c  retrieve physical parameters for scaling
!cdsu bug here in the previous version, porc uses the last porosity data saved in
!cdsu the shared variable por, that value is not zone-based porosity.
!cdsu Keep in mind that the porosity is defined in
!cdsu 'physical parameters - porous medium'
!cdsu that the zone number is different from the zone number in
!cdsu 'initial condition - reactive transport'.
!cdsu Here we use average porosity instead.
          call rtrvpprm(swc,sac,porc,por_init_ave,section_header)
          !call rtrvpprm(swc,sac,porc,porz(1),section_header)

!c  compute initial condition
          call gcreact(ccnew,ccold,cxc,gamma_l(1),gamma_l(nc+1),       &
                     cgc,swc,sac,porc,igen,ilog,tid,idbg,tec_header,   &
                     prefix,l_prfx,zone_name,l_zone_name,              &
                     mtime,i_append_sim,mtime_append)

!c  determine minimum total aqueous component concentrations and maximum
!c  secondary aqueous species concentration in solution domain

          call minmaxwd(cxc,totcn(:,tid))

!c  write results to generic output file
          if(b_enable_output .and. b_enable_output_gen)  then
            call outputlc(ccnew,cxc,gamma_l(1),gamma_l(nc+1),cgc,      &
                        igen,ilog,tid,section_header)
          end if

!c  check if the concentration of solution is physically and numerically reasonable 
          flag_nan = .false.
          do ic = 1, nc-1
            if (isnan(ccnew(ic))) then
              flag_nan = .true.
              exit
            end if
          end do

          do ix = 1, nx
            if (isnan(cxc(ix))) then
              flag_nan = .true.
              exit
            end if
          end do

          flag_stop = flag_nan

#ifdef PETSC        
          call MPI_Allreduce(flag_nan, flag_stop, 1, MPI_LOGICAL,      &
                             MPI_LOR,Petsc_Comm_World,ierrcode)
          CHKERRQ(ierrcode)
#endif
    
          if(flag_stop) then
            if(rank == 0) then
              write(*,'(2a,/,7x,2a)') "Error: Concentration is not physically or ",    &
                    "numerically reasonable. ", "Please check initial conditions",     &
                    " or try other solvers."
              write(ilog,'(2a,/,7x,2a)') "Error: Concentration is not physically or ", &
                    "numerically reasonable. ", "Please check initial conditions",     &
                    " or try other solvers."
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop
          end if
 
!c  assign initial condition to global system

!c  increment coordinates delineating zone

          ximin = ximin-tiny
          ximax = ximax+tiny
          yimin = yimin-tiny
          yimax = yimax+tiny
          zimin = zimin-tiny
          zimax = zimax+tiny

          ivol_l = 0

          do ivol = 1,nngl    !loop over control volumes

#ifdef PETSC
            if (node_idx_lg2l(ivol) >= 0) then
              ivol_l = ivol_l + 1
            end if
#else
            ivol_l = ivol_l + 1
#endif

!c  check limits of boundary zone

            if (((type_extent_zone==0.or.type_extent_zone_box>0) .and. &
                (xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax) .and.      &
                (yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax) .and.      &
                (zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)) .or.      &
                (type_extent_zone>0 .and. node_iflags(ivol)>=0 .and.     &
                ibits(type_extent_zone,0,1)==0)) then

#ifdef USG
              if (discretization_type > 0 .and. type_extent_zone_box > 0) then
                if ((btest(type_extent_zone_box,1) .and.               &
                     .not. is_boundary_node(ivol)) .or.                &
                    (btest(type_extent_zone_box,2) .and.               &
                     is_boundary_node(ivol))) then
                  cycle
                end if
              end if
#endif

              if (b_mip_brt_src) then
                mip_brt_num = mip_brt_num + 1
                mip_brt_idx(mip_brt_num) = ivol
              end if

              property_iflag(ivol) = property_iflag(ivol) + 1
           
              mpropc(ivol) = iiz

#ifdef PETSC
              if(node_idx_lg2l(ivol) > 0) then
                nntemp = nntemp+1
              end if
#else
              nntemp = nntemp+1
#endif

              if (.not.aq_conc_field) then
                if (b_enable_output .and. discretization_type == 0) then
#ifdef PETSC
                  if (node_idx_lg2l(ivol) >= 0) then
                    realbuffer((ivol_l-1)*(2+nc)+1:(ivol_l-1)*(2+nc)+3) =&
                       (/xg(ivol),yg(ivol),zg(ivol)/)
                    do ic = 1, nc-1
                      realbuffer((ivol_l-1)*(2+nc)+3+ic) = totco(ic,tid)
                    end do
                  end if
#else
                  realbuffer((ivol_l-1)*(2+nc)+1:(ivol_l-1)*(2+nc)+3) =  &
                     (/xg(ivol),yg(ivol),zg(ivol)/)
                  do ic = 1, nc-1
                    realbuffer((ivol_l-1)*(2+nc)+3+ic) = totco(ic,tid)
                  end do
#endif

#ifdef USG
                else if (b_enable_output .and. discretization_type > 0) then
                  do ic = 1, nc-1
                    realbuffer2d(ic,ivol) = totco(ic,tid)
                  end do
#endif
                end if
              end if

              call icbcrt(ivol,0,tid,.not.aq_conc_field)

!cdsu -------------------------------------------------------------
!cdsu  Check initial total mass
!cdsu -------------------------------------------------------------
              if (nsites > 0) then
                site_mass_cvol(1:nsites,ivol) = site_mass_tmp(1:nsites)* &
                              (cvol(ivol)*1.0d3*sanew(ivol)*pornew(ivol))
              end if

!cdsu -------------------------------------------------------------
!cdsu  initial conditions of noble gas ingrowth related varables
!cdsu -------------------------------------------------------------

              if (b_use_ngi) then
                if (ngre_i > 0) then
                  conc_ngre(:,ivol) = conc_ngre_lzn(:,tid)
                  conc_ngre_const(ivol) = conc_ngre_const_lzn(tid)
                end if

                if (nge_i > 0) then
                  wtfrac_nge(:,ivol) = wtfrac_nge_lzn(:,tid)
                end if

                if (ngnce_i > 0) then
                   ncp_ngnce(:,ivol) = ncp_ngnce_lzn(:,tid)
                end if

                density_rock_ngi(ivol) = density_rock_ngi_lzn(tid)
              end if

            end if     !(zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)
                       !(yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax)
                       !(xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax)
          end do       !loop over control volumes


!c  clear logical array for next zone
 
          reactive_minerals = .false.
 
!c  close files for postprocessing 
          if(rank == 0) then
            if (lb_output .and. b_enable_output) then
              call clstpfls
            end if
          end if

        end do         !(loop over number of zones)

!cdsu -------------------------------------------------------------
!cdsu  calculate rate of neutron production and noble gas ingrowth
!cdsu -------------------------------------------------------------
        if (b_use_ngi) then
          if (ngre_i > 0) then
            conc_ngre_ini = conc_ngre
          end if

          call update_rate_neutron_product
          call update_rate_noble_gas
        end if

!c  resize intermittent reaction related variables, to be done.

!cdsu -------------------------------------------------------------
!cdsu  Check initial total mass
!cdsu -------------------------------------------------------------
        if (nsites > 0) then
          site_mass_tmp = r0
          site_mass_tot = r0

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initicrt_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                                              &
    !$omp reduction (+:site_mass_tot)
    !$omp do schedule(static) 
#endif
          do ivol = 1,nngl
#ifdef PETSC
            if(node_idx_lg2l(ivol) < 0) then
              cycle
            end if
#endif
            site_mass_tot(1:nsites) = site_mass_tot(1:nsites) +       &
                                      site_mass_cvol(1:nsites,ivol)

          end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
#ifdef PETSC
          call MPI_Allreduce(site_mass_tot,site_mass_tmp,nsites,MPI_REAL8, &
                             MPI_SUM,Petsc_Comm_World,ierrcode)
          CHKERRQ(ierrcode)
          site_mass_tot = site_mass_tmp
#endif
        end if

!c  check if all initial condition for density dependent flow have been set
        if (b_enable_output .and. rank == 0) then
          write(igen,'(2a)') "check control volume: ",                 &
                "initial condition - reactive transport"
        end if

        nerrs = 0
        nwarns = 0
        do ivol = 1, nngl
          if (property_iflag(ivol) == 0) then
            nerrs = nerrs + 1
          else if (property_iflag(ivol) > 1) then
            nwarns = nwarns + 1
          end if
        end do

#ifdef PETSC
        call MPI_Allreduce(nerrs,nerrs_gbl,1,MPI_INTEGER4,MPI_SUM,     &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        nerrs = nerrs_gbl

        call MPI_Allreduce(nwarns,nwarns_gbl,1,MPI_INTEGER4,MPI_SUM,   &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        nwarns = nwarns_gbl       
#endif 

        if (nerrs > 0) then
          if (b_enable_output .and. rank == 0) then
            write(igen,'(a,1x,i8,1x,a)')                               &
                  "Error: initial condition is not set for ",nerrs,    &
                  "control volumes"
          end if
        end if

        if (nwarns > 0) then
          if (b_enable_output .and. rank == 0) then
            write(igen,'(a,1x,i8,1x,a)')                               &
                  "Warning: initial condition is duplicate for",nwarns,&
                  "control volumes"
          end if
        end if

#ifdef PETSC
        call minmaxwd_mpi
#endif

      if (.not. aq_conc_field) then
!c  ---------------------------------------------------------------------  
!c  output initial aqueous component concentration to file
!c  ---------------------------------------------------------------------  
        if (b_enable_output .and. discretization_type == 0) then
          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_o.aqt'
            else
              strbuffer = prefix(:l_prfx)//trim(adjustl(str_rank))//'_o.aqt'
            end if
            call binary_file_open(Petsc_Comm_World, igsaqt,              &
                         trim(strbuffer),b_output_mpiio_single)
          else
            igsaqt = lun_get()
            open(igsaqt,file=prefix(:l_prfx)//trim(adjustl(str_rank))//  &
                      '_o.aqt',status='unknown',form='formatted')
          end if

          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsaqt, "#")
          end if

!c  --------------------------------------------------------------------- 
!c  total aqueous component concentrations
!c  --------------------------------------------------------------------- 

!c  title and variables
!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
            call writeversion2file(igsaqt, "#")
          end if
        
          if (b_output_binary) then
            allocate(tec_variables(nc+2), stat = ierr)
            call checkerr(ierr,'initicrt-tec_variables',ilog)
            call memory_monitor(sizeof(tec_variables),'tec_variables',.true.)
          
            strbuffer = 'dataset '//prefix(:l_prfx)
            offset_iaqt = 0
            call tecplot_binary_write_header(Petsc_Comm_World, igsaqt,   &
                     "#!TDV102", trim(strbuffer), offset_iaqt,           &
                       b_output_mpiio_single,.false.)

            tec_variables(1:3) = [character(len=72):: "x", "y", "z"]
            do ic = 1, nc-1
              tec_variables(3+ic) = namec(ic)(:l_namec(ic))
            end do
            call tecplot_binary_write_variable(Petsc_Comm_World, igsaqt, &
                       2+nc, tec_variables(1:2+nc), offset_iaqt,         &
                       b_output_mpiio_single,.false.)

            call memory_monitor(-sizeof(tec_variables),'tec_variables',.true.)
            deallocate(tec_variables)
          else
            write(igsaqt,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
            write(igsaqt,'(1000a)') 'variables = "x", "y", "z"',         &
                                (',"',namec(ic)(:l_namec(ic)),'"',       &
                                ic=1,nc-1)
          end if

!c  zone record for initial condition
          if (b_output_binary) then
            strbuffer = 'T_j, initial'
            offset_iaqt_temp = offset_iaqt

            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsaqt,trim(strbuffer),offset_iaqt,         &
                           itec,jtec,ktec,                             &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_iaqt = offset_iaqt_temp +                         &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsaqt,trim(strbuffer),offset_iaqt,         &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_iaqt = offset_iaqt_temp +                         &
                            (12+len_trim(strbuffer))*4
            end if
          else
            write(igsaqt,'(a,3(a,i5),a)')                              &
                  'zone t = "T_j, ',                                   &
                  'initial", i =',itec,', j =',jtec,', k =',           &
                  ktec,',  f=point'
          end if

          if (b_output_binary) then
            offset_iaqt_temp = offset_iaqt
            call tecplot_binary_write_section(Petsc_Comm_World,igsaqt,2+nc,&
                       nn_offset,offset_iaqt,b_output_mpiio_single,      &
                       .false.,b_output_multizone)
          end if
#ifdef USG
!c  ---------------------------------------------------------------------
!c  total aqueous component concentrations for unstructured grid vtk file
!c  ---------------------------------------------------------------------
        else if (b_enable_output .and. discretization_type > 0) then
          if (.not. b_output_binary) then
            igsaqt = lun_get()
            open(igsaqt,file=prefix(:l_prfx)//trim(adjustl(str_rank))//  &
                      '_o.aqt.vtk',status='unknown',form='formatted')

            strbuffer = 'T_j, initial'
            call write_mesh_data_vtk_ascii(igsaqt,trim(adjustl(strbuffer)))
          end if
#endif
        end if
      end if

!c  write initial aqueous component concentration to file when initialized from zones
      if (b_enable_output .and. .not.aq_conc_field) then
        if (discretization_type == 0) then
          if (b_output_binary) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(igsaqt, size(realbuffer,1),       &
                          realbuffer, offset_iaqt,                     &
                          b_output_mpiio_single)
            else
              call binary_subarray_initialize(nc+2,                    &
                          b_mpiarray_iaqt_init,.false.,                &
                          mpiarray_filetype_iaqt,                      &
                          mpiarray_sizes_gbl_iaqt,                     &
                          mpiarray_sizes_sub_iaqt,                     &
                          mpiarray_starts_sub_iaqt)
              call binary_write_data(igsaqt,size(realbuffer,1),        &
                       realbuffer,offset_iaqt,mpiarray_filetype_iaqt)
            end if
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
          else
            ivol_l = 0
            do ivol=1,nngl
!c  skip ghost nodes
#ifdef PETSC
              if(node_idx_lg2l(ivol) < 0) then
                cycle
              end if
#endif
              ivol_l = ivol_l + 1
              write(igsaqt,ascii_fmt)                                  &
                    realbuffer((ivol_l-1)*(2+nc)+1:ivol_l*(2+nc))
            end do
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
          end if

!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
          if(b_output_binary) then
            call binary_file_close(igsaqt,b_output_mpiio_single)
          else
            close(igsaqt)
            call lun_free(igsaqt)
          end if
#ifdef USG
        else if (discretization_type > 0) then
          if (b_output_binary) then
#ifdef PETSC_HDF
            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=prefix(:l_prfx)//'_o.aqt.xmf',            &
                   status='unknown',form='formatted')
            end if

            strfilename_result = prefix(:l_prfx)//'_o.aqt.h5'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
            else
              strfilename_mesh = strfilename_result
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)
            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,            &
                                    MPI_INFO_NULL, hdf5_ierr)

            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F, file_id, &
                             hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,          &
                        cell_type,num_cells_gbl,num_nodes_gbl,             &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                      &
                        strfilename_mesh,"domain","vertices_rank",         &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                      &
                        strfilename_mesh,"domain","cells_rank",            &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                      &
                        strfilename_mesh,"domain","vertices_lg2g",         &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                      &
                        strfilename_mesh,"domain","cells_lg2g",            &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                    &
                          strfilename_mesh,"domain","vertices_matid",      &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                    &
                          strfilename_mesh,"domain","cells_matid",         &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,         &
                             OBJECT_NAMELEN_DEFAULT_F)

            allocate(realbuffer(num_nodes), stat = ierr)
            call checkerr(ierr,'initicrt-realbuffer',ilog)
            call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)

            do ic = 1, nc-1
              do ivol = 1, nngl
                realbuffer(ivol) = realbuffer2d(ic,ivol)
              end do
              call hdf5_usg_write_group_data_1d(group_id,trim(namec(ic)),  &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,realbuffer)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,strfilename_result, &
                          "results",trim(namec(ic)),"Scalar","Node",       &
                          num_nodes_gbl,1)
              end if
            end do
            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)

            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if
#endif
          else
            write(igsaqt,'(a,1x,i12)') "POINT_DATA",nngl
            do ic=1,nc-1
              write(igsaqt,'(3a)') "SCALARS ",trim(namec(ic))," double"
              write(igsaqt,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(igsaqt,ascii_fmt) realbuffer2d(ic,ivol)
              end do
            end do
          end if
!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
          if(.not. b_output_binary) then
            close(igsaqt)
            call lun_free(igsaqt)
          end if
#endif
        end if
      end if

!c  release memory
      if (allocated(realbuffer)) then
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer)
      end if

      if (allocated(realbuffer2d)) then
        call memory_monitor(-sizeof(realbuffer2d),'realbuffer2d',.true.)
        deallocate(realbuffer2d)
      end if

!c  read initial mineral volume fractions as nodal values from separate file
!c  file must be named 'prefix'.min

      if (mineral_vol_field .and. .not.(mineral_vol_field_vtk .or.     &
          mineral_vol_field_hdf5)) then

!c  read mineral volumes

        !iminvol=27
        iminvol = lun_get()
        open(iminvol,file=prefix(:l_prfx)//'.min',status='old',form='formatted')
        ierrcd = 14
        read(iminvol,*,err=999,end=999) cdummy
        read(iminvol,*,err=999,end=999) cdummy
        read(iminvol,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 15
              read(iminvol,*,end=999,err=999) (rdummy, i=1,3),      &
                  (phi_init(im,ivol),im=1,nm), por_init(ivol)
            else
              ierrcd = 16
              read(iminvol,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 17
              read(iminvol,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 18
            read(iminvol,*,end=999,err=999) (rdummy, i=1,3),        &
                (phi_init(im,ivol),im=1,nm), por_init(ivol)
          end do
        end if

#ifdef USG
!c  read mineral volumes from prefix.min.vtk file
      else if (mineral_vol_field_vtk) then
        iminvol = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then          
          open(iminvol,file=prefix(:l_prfx)//'.min.vtk',status='old',  &
               form='formatted')
        else
          call lun_free(iminvol)
          iminvol = 0
        end if

!c  read mineral volume fraction
        do im = 1, nm
          call read_vtk_data_from_file(iminvol,namem(im),im,1,bfound,phi_init)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read mineral volume fraction ',         &
                    trim(namem(im)),' from vtk file: done'
              write(ilog,'(3a)') 'read mineral volume fraction ',      &
                    trim(namem(im)),' from vtk file: done'
            end if
          end if
        end do

!c  read porosity
        call read_vtk_data_from_file(iminvol,'porosity',bfound,por_init)
        if (bfound) then
          if (rank == 0 .and. b_enable_output) then
            write(*,'(a)') 'read porosity from vtk file: done'
            write(ilog,'(a)') 'read porosity from vtk file: done'
          end if
        end if

!c  hdf5 file format, for parallel version only
#ifdef PETSC_HDF
      else if (mineral_vol_field_hdf5) then
!c  initialize parallel data mapping if not initialized
        if (.not. b_init_hdf5_lg2g) then

          strfilename = prefix(:l_prfx)//'.domain.h5'
          inquire(file=trim(strfilename),exist=bflag)

          if (bflag) then
            iunit_file = lun_get()
            iunit_hdf5 = int(iunit_file,kind(HID_T))
            call hdf5_usg_read_node_lg2g(iunit_hdf5,                   &
                                         trim(strfilename),hdf5_ierr)
            call lun_free(iunit_file)

            if (hdf5_ierr < 0) then
              if (rank == 0) then
                write(ilog,*) 'SIMULATION TERMINATED'
                write(ilog,*) 'error in reading domain from hdf5 file'
                write(ilog,*) 'file: ',trim(strfilename)
                close(ilog)
              end if
              call petsc_mpi_finalize
              stop
            else
              if (rank == 0) then
                write(*,'(a)') 'read domain from hdf5 file: done'
                write(ilog,'(a)') 'read domain from hdf5 file: done'
              end if
            end if

            b_init_hdf5_lg2g = .true.
          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error in reading domain from hdf5 file'
              write(ilog,*) 'file is missing: ',prefix(:l_prfx)//'.domain.h5'
              close(ilog)
            end if
            call petsc_mpi_finalize
            stop    
          end if

        end if
        
        iminvol_hdf5 = int(iminvol,kind(HID_T))
        strfilename = prefix(:l_prfx)//'.min.h5'

!c  read mineral volume fraction and porosity
        allocate(realbuffer2(nngl), stat = ierr)
        realbuffer2 = 0.0d0
        call checkerr(ierr,'initicrt-realbuffer2',ilog)
        call memory_monitor(sizeof(realbuffer2),'realbuffer2',.true.)

        do im = 1, nm
          call hdf5_usg_read_node_var(iminvol_hdf5, trim(strfilename), &
                    "results", trim(namem(im)), realbuffer2, bexist,   &
                    hdf5_ierr)
          if (hdf5_ierr < 0) then
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error in reading mineral from hdf5 file'
              write(ilog,*) 'file: ',trim(strfilename)
              close(ilog)
            end if
            call petsc_mpi_finalize
            stop
          else
            if (rank == 0) then
              write(*,'(a)') 'read mineral from hdf5 file: done'
              write(ilog,'(a)') 'read mineral from hdf5 file: done'
            end if
          end if
          do ivol = 1, nngl
            phi_init(im,ivol) = realbuffer2(ivol)
          end do
        end do

        call memory_monitor(-sizeof(realbuffer2),'realbuffer2',.true.)
        deallocate(realbuffer2, stat = ierr)

        call hdf5_usg_read_node_var(iminvol_hdf5, trim(strfilename), &
                  "results", "porosity", por_init, bexist,           &
                  hdf5_ierr)
        if (hdf5_ierr < 0) then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error in reading porosity from hdf5 file'
            write(ilog,*) 'file: ',trim(strfilename)
            close(ilog)
          end if
          call petsc_mpi_finalize
          stop
        else
          if (rank == 0) then
            write(*,'(a)') 'read porosity from hdf5 file: done'
            write(ilog,'(a)') 'read porosity from hdf5 file: done'
          end if
        end if
#endif
#endif
      end if !found subsection


!c       update matrices: phi, phiold, cmold, and cmnew 
      if (mineral_vol_field) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initicrt_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private(im, ivol, tid)
    !$omp do schedule(static)
#endif
        do ivol = 1,nngl
#ifdef OPENMP
          tid = omp_get_thread_num() + 1
#else
          tid = 1
#endif
         do im=1,nm
           if (phi_init(im,ivol)<phimin(im)) then
             phi_init(im,ivol)=phimin(im)
           end if 
             phi(im,ivol) = phi_init(im,ivol)
             phiold(im,ivol) = phi_init(im,ivol)
             cm_init(im,ivol) = 1000.d0 * phi_init(im,ivol) *       &
                              densm(im) / gfwm(im)
             cmold(im,ivol) = 1000.d0 * phi_init(im,ivol) *       &
                              densm(im) / gfwm(im)
             cmnew(im,ivol)=cmold(im,ivol)
         end do
        end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

        if (iminvol > 0) then
          close(iminvol)
          call lun_free(iminvol)
        end if
                
      end if !mineral_vol_field

!c THH March 07
!c  read initial mineral surface areas as nodal values from separate file
!c  file must be named 'prefix'.surf
      if (mineral_surf_field .and. .not.mineral_surf_field_vtk) then

!c  read mineral surface area

        !iminsurf=28
        iminsurf = lun_get()
        open(iminsurf,file=prefix(:l_prfx)//'.surf',status='old', &
     &          form='formatted')
        ierrcd = 19
        read(iminsurf,*,err=999,end=999) cdummy
        read(iminsurf,*,err=999,end=999) cdummy
        read(iminsurf,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 20
              read(iminsurf,*,end=999,err=999) (rdummy, i=1,3),     &
                  (area_init(im,ivol),im=1,nm)
            else
              ierrcd = 21
              read(iminsurf,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 22
              read(iminsurf,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 23
            read(iminsurf,*,end=999,err=999) (rdummy, i=1,3),       &
                (area_init(im,ivol),im=1,nm)
          end do
        end if

        close(iminsurf)
        call lun_free(iminsurf)
#ifdef USG
!c  read initial mineral surface areas as nodal values from separate file
!c  file must be named 'prefix'.surf.vtk
      else if (mineral_surf_field_vtk) then 
        iminsurf = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then
          open(iminsurf,file=prefix(:l_prfx)//'.surf.vtk',status='old', &
               form='formatted')
        else
          call lun_free(iminsurf)
          iminsurf = 0
        end if

!c  read mineral surface area
        do im = 1, nm
          call read_vtk_data_from_file(iminsurf,namem(im),im,1,bfound,area_init)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(3a)') 'read mineral surface area ',          &
                      trim(namem(im)),' from vtk file: done'
                write(ilog,'(3a)') 'read mineral surface area ',       &
                      trim(namem(im)),' from vtk file: done'
              end if
            end if
        end do

        if (iminsurf > 0) then
          close(iminsurf)
          call lun_free(iminsurf)
        end if
#endif
      end if

      if (mineral_surf_field) then
!c update areas
        area = area_init

      end if  
      
!c  read mineral volume fractions nucleation thresholds as nodal values from separate file
!c  file must be named 'prefix'.vnuc
!c  DSU, 2013-2-18

      if (mineral_vnuc_field .and. .not.mineral_vnuc_field_vtk) then

!c  read mineral volume fractions nucleation thresholds

        !iminvnuc=94
        iminvnuc=lun_get()
        open(iminvnuc,file=prefix(:l_prfx)//'.vnuc',status='old',   &
     &          form='formatted')
        ierrcd = 24
        read(iminvnuc,*,err=999,end=999) cdummy
        read(iminvnuc,*,err=999,end=999) cdummy
        read(iminvnuc,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 25
              read(iminvnuc,*,end=999,err=999) (rdummy, i=1,3),      &
                  (phinucthrd(im,ivol),im=1,nm)
            else
              ierrcd = 26
              read(iminvnuc,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 27
              read(iminvnuc,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 28
            read(iminvnuc,*,end=999,err=999) (rdummy, i=1,3),        &
                (phinucthrd(im,ivol),im=1,nm)
          end do
        end if

        close(iminvnuc)
        call lun_free(iminvnuc)

#ifdef USG
      else if (mineral_vnuc_field_vtk) then
!c  read mineral volume fractions nucleation thresholds from vtk file

        iminvnuc=lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.          &
            .not.read_spatial_master_proc) then
          open(iminvnuc,file=prefix(:l_prfx)//'.vnuc.vtk',status='old',  &
               form='formatted')
        else
          call lun_free(iminvnuc)
          iminvnuc = 0
        end if

        do im = 1, nm
          call read_vtk_data_from_file(iminvnuc,namem(im),im,1,bfound,phinucthrd)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read mineral volume fraction nucleation threshold ',    &
                    trim(namem(im)),' from vtk file: done'
              write(ilog,'(3a)') 'read mineral volume fraction nucleation threshold ', &
                    trim(namem(im)),' from vtk file: done'
            end if
          end if
        end do

        if (iminvnuc > 0) then
          close(iminvnuc)
          call lun_free(iminvnuc)
        end if
#endif
                
      end if !found subsection
      
!c  read nucleation threshold reference surface area as nodal values from separate file
!c  file must be named 'prefix'.anuc
!c  DSU, 2013-2-18 
      if (mineral_anuc_field .and. .not.mineral_anuc_field_vtk) then

!c  read nucleation threshold reference surface area

        !iminanuc=28
        iminanuc=lun_get()
        open(iminanuc,file=prefix(:l_prfx)//'.anuc',status='old', &
     &          form='formatted')
        ierrcd = 29
        read(iminanuc,*,err=999,end=999) cdummy
        read(iminanuc,*,err=999,end=999) cdummy
        read(iminanuc,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 30
              read(iminanuc,*,end=999,err=999) (rdummy, i=1,3),     &
                  (areanucthrd(im,ivol),im=1,nm)
            else
              ierrcd = 31
              read(iminanuc,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 32
              read(iminanuc,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 33
            read(iminanuc,*,end=999,err=999) (rdummy, i=1,3),       &
                (areanucthrd(im,ivol),im=1,nm)
          end do
        end if

        close(iminanuc)
        call lun_free(iminanuc)

#ifdef USG
!c  read nucleation threshold reference surface area from vtk file
      else if (mineral_anuc_field_vtk) then
        iminanuc=lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then
          open(iminanuc,file=prefix(:l_prfx)//'.anuc.vtk',             &
               status='old',form='formatted')
        else
          call lun_free(iminanuc)
          iminanuc = 0
        end if

        do im = 1, nm
          call read_vtk_data_from_file(iminanuc,namem(im),im,1,bfound,areanucthrd)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read nucleation threshold reference surface area ',     &
                    trim(namem(im)),' from vtk file: done'
              write(ilog,'(3a)') 'read nucleation threshold reference surface area ',  &
                    trim(namem(im)),' from vtk file: done'
            end if
          end if
        end do

        if (iminanuc > 0) then
          close(iminanuc)
          call lun_free(iminanuc)
        end if
#endif

      end if 

!c  noble gas ingrowth related field data, solid phase density

!c  read initial solid phase density as nodal values from separate file
!c  file must be named 'prefix'.ngirho

      if (density_rock_ngi_field .and. .not. density_rock_ngi_field_vtk) then

        ingi_field = lun_get()
        open(ingi_field,file=prefix(:l_prfx)//'.ngirho',status='old',  &
             form='formatted')
        ierrcd = 42
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 43
              read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),      &
                  density_rock_ngi(ivol)
            else
              ierrcd = 44
              read(ingi_field,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

#ifdef USG
!c  read solid phase density from prefix.ngirho.vtk file
      else if (density_rock_ngi_field_vtk) then
        ingi_field = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then          
          open(ingi_field,file=prefix(:l_prfx)//'.ngirho.vtk',         &
               status='old',form='formatted')
        end if

        call read_vtk_data_from_file(ingi_field,'rho_solid',bfound,    &
                                     density_rock_ngi)
        if (bfound) then
          if (rank == 0 .and. b_enable_output) then
            write(*,'(2a)') 'read solid phase density rho_solid',      &
                            ' from vtk file: done'
            write(ilog,'(2a)') 'read solid phase density rho_solid',   &
                            ' from vtk file: done'
          end if
        end if

        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if
#endif
      end if !found subsection

!c  read concentration of radioelements as nodal values from separate file
!c  file must be named 'prefix'.ngiconc

      if (conc_ngre_field .and. .not.conc_ngre_field_vtk) then

        ingi_field = lun_get()
        open(ingi_field,file=prefix(:l_prfx)//'.ngiconc',status='old', &
             form='formatted')
        ierrcd = 45
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 46
              read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),      &
                  (conc_ngre(ire,ivol),ire=1,ngre_i)
            else
              ierrcd = 47
              read(ingi_field,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 48
              read(ingi_field,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 49
            read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),        &
                (conc_ngre(ire,ivol),ire=1,ngre_i)
          end do
        end if

        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

        conc_ngre_ini = conc_ngre

#ifdef USG
!c  read concentration of radioelements from prefix.ngiconc.vtk file
      else if (conc_ngre_field_vtk) then
        ingi_field = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then          
          open(ingi_field,file=prefix(:l_prfx)//'.ngiconc.vtk',        &
               status='old',form='formatted')
        end if

        do ire = 1, ngre_i
          call read_vtk_data_from_file(ingi_field,name_ngre_i(ire),    &
                                       ire,1,bfound,conc_ngre)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read concentration of radioelement ',   &
                    trim(name_ngre_i(ire)),' from vtk file: done'
              write(ilog,'(3a)') 'read concentration of radioelement ',&
                    trim(name_ngre_i(ire)),' from vtk file: done'
            end if
          end if
        end do
#endif
        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

        conc_ngre_ini = conc_ngre
      end if !found subsection

!c  read weight fraction of elements as nodal values from separate file
!c  file must be named 'prefix'.ngiwfe

      if (wtfrac_nge_field .and. .not.wtfrac_nge_field_vtk) then

        ingi_field = lun_get()
        open(ingi_field,file=prefix(:l_prfx)//'.ngiwfe',status='old',   &
             form='formatted')
        ierrcd = 50
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 51
              read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),      &
                  (wtfrac_nge(ie,ivol),ie=1,nge_i)
            else
              ierrcd = 52
              read(ingi_field,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 53
              read(ingi_field,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 54
            read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),        &
                (wtfrac_nge(ie,ivol),ie=1,nge_i)
          end do
        end if

        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

#ifdef USG
!c  read weight fraction of elements from prefix.ngiwfe.vtk file
      else if (wtfrac_nge_field_vtk) then
        ingi_field = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then          
          open(ingi_field,file=prefix(:l_prfx)//'.ngiwfe.vtk',          &
               status='old',form='formatted')
        end if

        do ie = 1, nge_i
          call read_vtk_data_from_file(ingi_field,name_nge_i(ie),      &
                                       ie,1,bfound,wtfrac_nge)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read weight fraction of element ',      &
                    trim(name_nge_i(ie)),' from vtk file: done'
              write(ilog,'(3a)') 'read weight fraction of element ',   &
                    trim(name_nge_i(ie)),' from vtk file: done'
            end if
          end if
        end do
#endif
        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

      end if !found subsection

!c  read neutron capture probability as nodal values from separate file
!c  file must be named 'prefix'.ngincp

      if (ncp_ngnce_field .and. .not.ncp_ngnce_field_vtk) then

        ingi_field = lun_get()
        open(ingi_field,file=prefix(:l_prfx)//'.ngincp',status='old',  &
             form='formatted')
        ierrcd = 50
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
        read(ingi_field,*,err=999,end=999) cdummy
#ifdef USG
        if (discretization_type > 0) then
          do ivolgbl = 1,nngbl
#ifdef PETSC
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
            else
              ivol = node_idx_g2lg(ivolgbl)
            end if
#else
            if (ibits(usg_mesh_ordering,0,2) == 3) then
              ivol = node_idx_g2g_invord(ivolgbl)
            else
              ivol = ivolgbl
            end if
#endif
            if (ivol > 0) then
              ierrcd = 51
              read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),      &
                  (ncp_ngnce(ince,ivol),ince=1,ngnce_i)
            else
              ierrcd = 52
              read(ingi_field,*,end=999,err=999) rdummy
            end if
          end do
        end if
#endif
        if (discretization_type == 0) then
          nskip = 0
          do ivol = 1,nngl
#ifdef PETSC
            do iskip = 1, node_idx_lg2g(ivol) - nskip -1
              ierrcd = 53
              read(ingi_field,*,end=999,err=999) rdummy
            end do
            nskip = node_idx_lg2g(ivol)
#endif
            ierrcd = 54
            read(ingi_field,*,end=999,err=999) (rdummy, i=1,3),        &
                (ncp_ngnce(ince,ivol),ince=1,ngnce_i)
          end do
        end if

        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

#ifdef USG
!c  read neutron capture probability from prefix.ngincp.vtk file
      else if (ncp_ngnce_field_vtk) then
        ingi_field = lun_get()
        if ((read_spatial_master_proc .and. rank == 0) .or.            &
            .not.read_spatial_master_proc) then          
          open(ingi_field,file=prefix(:l_prfx)//'.ngincp.vtk',         &
               status='old',form='formatted')
        end if

        do ie = 1, nge_i
          call read_vtk_data_from_file(ingi_field,name_ngnce_i(ince),  &
                                       ince,1,bfound,ncp_ngnce)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(3a)') 'read neutron capture probability ',     &
                    trim(name_ngnce_i(ince)),' from vtk file: done'
              write(ilog,'(3a)') 'read neutron capture probability ',  &
                    trim(name_ngnce_i(ince)),' from vtk file: done'
            end if
          end if
        end do
#endif
        if (ingi_field > 0) then
          close(ingi_field)
          call lun_free(ingi_field)
        end if

      end if !found subsection
      
!c  check if initial conditions have been assigned correctly
#ifdef PETSC
      call MPI_Allreduce(nntemp, nntemp_gbl,1,MPI_INTEGER4,MPI_SUM,  &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nntemp = nntemp_gbl
#endif

      if (nntemp.gt.nngbl) then

        if (rank == 0 .and. b_enable_output) then            
          write(ilog,*)
          write(ilog,'(a)') &                   !screen or logbook
     &          'warning ...........'
          write(ilog,'(2(a,1x),i0,1x,a)')                               &
     &          'initial conditions for reactive transport have been',  &
     &          'assigned to',nntemp,'control volumes'
          write(ilog,'(a,1x,i0)')                                       &
     &          'the actual number of control volumes is only',nngbl
          write(ilog,'(/72a)')('-',i=1,72)
        end if  
          
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,*)
          write(igen,'(a)') &                  !general output file
     &          'warning ...........'
          write(igen,'(2(a,1x),i0,1x,a)')                               &
     &          'initial conditions for reactive transport have been',  &
     &          'assigned to',nntemp,'control volumes'
          write(igen,'(a,1x,i0)')                                       &
     &          'the actual number of control volumes is only',nngbl
          write(igen,'(/72a)')('-',i=1,72)
        end if

      elseif (nntemp.lt.nngbl) then

        if (rank == 0) then  

          write(ilog,'(2a)') 'could not assign initial conditions ',    &
     &                    'for reactive transport to all control volumes'
        end if
        
        ierrcd = 34
        goto 999

      end if
      
!c_bubbles read subsection 'overwrite mineral distibution'

      subsection = 'overwrite mineral distribution'
      call findstrg(subsection,itmp,found_subsection)
    
      if (found_subsection .and. nm > 0) then

        ierrcd = 35
        read(itmp,*,err=999,end=999) nmo

        allocate (min_to_overwrite(nmo), stat = ierr)
        call checkerr(ierr,'min_to_overwrite',ilog)
        call memory_monitor(sizeof(min_to_overwrite),'min_to_overwrite',.true.)

        do i = 1,nmo,nread

            istart = i
            istop = i+nread-1
            if (istop.gt.nmo) then
              istop = nmo
            end if
            ierrcd = 36
            read(itmp,*,err=999,end=999) (min_to_overwrite(imo),       &
                                          imo=istart,istop)
        end do

        if (rank == 0 .and. b_enable_output) then
          write(ilog,*) 'reading mineral distributions from file'
        end if
        
        !igsv = 69
        igsv = lun_get()
       
        do i=1,nmo

          open(igsv,file=prefix(:l_prfx)//'.gsv',status='unknown',     &
               form='formatted')
          
          im=min_to_overwrite(i)
          if (rank == 0 .and. b_enable_output) then
            write(igen,'(/2a)')                                        &
             'read mineral volume fractions from file for mineral "',  &
              namem(im)(:l_namem(im))
          end if
            
          ierrcd = 37
          read(igsv,*,err=999,end=999) cdummy
          read(igsv,*,err=999,end=999) cdummy
          read(igsv,*,err=999,end=999) cdummy
#ifdef USG
          if (discretization_type > 0) then
            do ivolgbl = 1,nngbl
#ifdef PETSC
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
              else
                ivol = node_idx_g2lg(ivolgbl)
              end if
#else
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2g_invord(ivolgbl)
              else
                ivol = ivolgbl
              end if
#endif
              if (ivol > 0) then
                ierrcd = 38
                read(igsv,*,err=999,end=999) (cdummy,j=1,3+(im-1)),    &
                     phic(im,tid)
                call initgeom(im,idbg)
                cmnew(im,ivol) = cmcnew(im,tid)
                cmold(im,ivol) = cmcnew(im,tid)
                phi(im,ivol) = phic(im,tid)
                phiold(im,ivol) = phic(im,tid)
                phi_init(im,ivol) = phic(im,tid)
              else
                ierrcd = 39
                read(igsv,*,err=999,end=999) rdummy
              end if
            end do
          end if
#endif
          if (discretization_type == 0) then
            nskip = 0
            do ivol = 1,nngl
#ifdef PETSC
              do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                ierrcd = 40
                read(igsv,*,end=999,err=999) rdummy
              end do
              nskip = node_idx_lg2g(ivol)
#endif
              ierrcd = 41
              read(igsv,*,err=999,end=999) (cdummy,j=1,3+(im-1)),      &
                   phic(im,tid)
              call initgeom(im,idbg)
              cmnew(im,ivol) = cmcnew(im,tid)
              cmold(im,ivol) = cmcnew(im,tid)
              phi(im,ivol) = phic(im,tid)
              phiold(im,ivol) = phic(im,tid)
              phi_init(im,ivol) = phic(im,tid)
            end do
          end if

          close (igsv)
        end do
        call lun_free(igsv)
        
        do ivol =1,nngl
          call distmp(cmnew(1,ivol),phi(1,ivol),area(1,ivol),tid)
        end do
        
      end if

!cds  check total mineral volume fraction and porosity value
      nvols = 0
      rthresh = r1 + tiny
      do ivol = 1, nngl
!c  skip ghost nodes
#ifdef PETSC
        if (node_idx_lg2l(ivol) < 0) then
          cycle
        end if
#endif
        rtot = sum(phi(:,ivol))
        if (rtot + pornew(ivol) > rthresh) then
          nvols = nvols + 1
        end if
      end do
#ifdef PETSC
      call MPI_Allreduce(nvols,nvols_gbl,1,MPI_INTEGER4,MPI_SUM,       &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nvols = nvols_gbl   
#endif

      if (nvols > 0) then
        if (rank == 0 .and. b_enable_output) then
          write(*,'(a,i0,a)') ' warning: mineral volume fraction of ',   &
                nvols,' volumes exceeds solid volume fraction'
          write(ilog,'(a,i0,a)') ' warning: mineral volume fraction of ',&
                nvols,' volumes exceeds solid volume fraction'
        end if
      end if

      return
      
999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        write(ilog,*) 'zone "', zone_name(:l_zone_name),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
