!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/jacheat.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine jacheat
!c ----------------
!c
!c construct Jacobian matrix and rhs-vector (decoupled heat transport)
!c
!c modified from Sergio Andres Bea Jofre 
!c
!c written by:      Danyang Su - June 1st, 2020
!c
!c last modified:   Danyang Su - June 1st, 2020
!c
!c                  Unstructured grid and HPC capabilities
!c
!c ----------------------------------------------------------------------
 
       subroutine jacheat
 
       use parm
       use gen
       use phys
       use dens
       use chem
#ifdef OPENMP
       use omp_lib
#endif 

#ifdef USG
       use math_common
       use geometry
       use usg_mesh_data, only : num_edge_dvols,cells, num_cells,      &
                                 num_nodes_per_cell, num_edge_maxcells
       use gradient_usg, only : gradient_cross_diff,                   &
                                gradient_cross_diff_inc,               &
                                gradient_cross_diff_dd
       use diff_vapour_usg_mod, only : diff_vapour_usg
       use usg_face_utility, only : usg_face_utility_cinfvs,           &
                                    usg_face_utility_cinfevap_t,       &
                                    usg_face_utility_cinfevap_pa,      &
                                    usg_face_utility_cinfheat_c,       &
                                    usg_face_utility_cinfheat_d
       use mod_fluxdd_usg, only : fluxdd_usg
       use mod_darcy_energybal_usg, only : darcy_energybal_usg
#endif
 
       implicit none

       integer :: i1, icon, ivol, izn, idiag, istart, iend, isym, im, jvol

       real*8 :: actw, delt_loc, densoldc_ivol, densnewc_ivol,         &
                 tdsold_ivol, tdsnew_ivol, darcy_energybal,            &
                 tortuosity, coeff, factemp, tempinc_ivol,             &
                 densinc_ivol, viscoinc_ivol,                          &
                 porinc_ivol, densnew_ivol, densold_ivol,              &
                 sanew_ivol, saold_ivol, densvinc_pa_ivol, relheat_iw, &
                 densvinc_temp_ivol, vsfluxinc, dtemp_ivol_jvol,       &
                 heatfluxinc, dheatflux, vapfluxinc
       real*8, external :: relpfsat, storevap, storheat,              &
                fluxdd, fluxheat, diff_vapour, rhonew,                 &
                tortuosity_vap, visconew, porosity_flow


       integer :: chunk

#ifdef USG
       integer :: i2, icell, idvol, kvol, ncell, ndvol, nrelp
       real*8 :: sanew_loc
       real*8 :: grad_weights(num_crossdifficv_max)
       real*8 :: relps_loc(num_edge_maxcells)
       real*8 :: flux_ddflow_hls_corr(num_edge_dvols,num_edge_maxcells),     &
                 flux_temp_hls_corr(num_edge_dvols,num_edge_maxcells),       &
                 flux_temp_inc_hls_corr(num_edge_dvols,num_edge_maxcells),   &
                 flux_flow_hls_corr(num_edge_dvols,num_edge_maxcells)
       type(point) :: grad_locs(num_crossdifficv_max)
       type(point) :: grad_ddflow_mids(num_edge_dvols,num_edge_maxcells),    &
                      grad_temp_mids(num_edge_dvols,num_edge_maxcells),      &
                      grad_temp_inc_mids(num_edge_dvols,num_edge_maxcells),  &
                      grad_flow_mids(num_edge_dvols,num_edge_maxcells)
       type(grad_hls_term) :: grad_flow_hls_loc(num_edge_dvols),            &
                              grad_ddflow_hls_loc(num_edge_dvols),          &
                              grad_temp_hls_loc(num_edge_dvols)                             
       real*8 :: cinfvs_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfvs_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfevap_pa_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfevap_pa_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfevap_t_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfevap_t_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfheat_c_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfheat_c_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfheat_d_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfheat_d_usg_cross_loc(num_edge_dvols,num_edge_maxcells)
#endif

       real*8, external :: relheat_freezing

       external :: rhsvs, zero_r8

       real*8, parameter  :: r0 = 0.0d0, &
                             rhalf = 0.5d0, &
                             r1 = 1.0d0, &
                             r2 = 2.0d0, &
                             r3 = 3.0d0, &
                             r4 = 4.0d0, &
                             r1d3 = 1.0d3

       integer, parameter :: i0=0


       logical :: iserror, isdebug
       integer :: info_debug, ivol_track, ivol_gbl

       real*8                 :: heatstor, &
                                 heatstorinc, &
                                 totsinksource, &
                                 totsinksourceinc, &
                                 totheatflux , &
                                 dheatstor, &
                                 dtotheatflux_temp, &
                                 dummy1, &
                                 dummy2, &
                                 dummy3, &
                                 dummy4, &
                                 latvapinc_ivol, &
                                 latvap_av,&
                                 aentry_loc

#ifdef OPENMP
      chunk = nngl / numofthreads_matrix_flow
      if(mod(nngl, numofthreads_matrix_flow) > 0) then
        chunk = chunk + 1                             !This is default chunk size for static scheduling.
      end if
      if (i_chunksize_factor_flow > 1) then
        if(mod(chunk, i_chunksize_factor_flow) > 0) then
          chunk = chunk/i_chunksize_factor_flow + 1
        else
          chunk = chunk/i_chunksize_factor_flow
        end if
      end if
#endif

#ifdef SCHEDULE_DYNAMIC
      if(i_chunksize_factor_flow == 0) then
        chunk = 1                                       !This is the default chunk size for dynamic scheduling.
      end if 
#endif

!c  debug toggle
      isdebug = .false.
            
      if(iter_heat.le.1) then
        info_debug = -1
        ivol_track = -1
      else
        info_debug = -1
        ivol_track = -1
      end if

      heatstor = r0
      heatstorinc = r0


#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (i_matrix_assembly_type_flow == 1)                       &
    !$omp num_threads(numofthreads_matrix_flow)                       &
    !$omp default(shared)                                             &
    !$omp private (                                                   &
#ifdef USG
    !$omp i2, icell, idvol, ncell, nrelp, relps_loc,                  &
    !$omp ivol_gbl, ndvol, sanew_loc, grad_ddflow_mids,               &
    !$omp grad_temp_mids, grad_flow_mids, grad_temp_inc_mids,         &
    !$omp grad_locs, grad_weights, grad_flow_hls_loc,                &
    !$omp grad_temp_hls_loc, grad_ddflow_hls_loc,                   &
    !$omp flux_temp_hls_corr, flux_temp_inc_hls_corr,                 &
    !$omp flux_flow_hls_corr, flux_ddflow_hls_corr,                   &
    !$omp cinfvs_usg_loc, cinfvs_usg_cross_loc,                       &
    !$omp cinfevap_t_usg_loc, cinfevap_t_usg_cross_loc,               &
    !$omp cinfevap_pa_usg_loc, cinfevap_pa_usg_cross_loc,             &
    !$omp cinfheat_c_usg_loc, cinfheat_c_usg_cross_loc,               &
    !$omp cinfheat_d_usg_loc, cinfheat_d_usg_cross_loc,               &
#endif
    !$omp i1, icon, idiag, iend, istart, isym, ivol, izn, jvol,       &
    !$omp actw, coeff, del_p, del_temp, del_z, delt_loc,              &
    !$omp densinc_ivol, densnewc_ivol, densoldc_ivol,                 &
    !$omp densnew_ivol, densold_ivol, sanew_ivol, saold_ivol,         &
    !$omp densvinc_temp_ivol, densvinc_pa_ivol, dheatflux,            &
    !$omp dheatstor, dtemp_ivol_jvol, dtotheatflux_temp,              &
    !$omp dummy1, dummy2, dummy3, dummy4, factemp,                    &
    !$omp heatflux_a, heatflux_c, heatflux_d, heatflux_v,             &
    !$omp heatfluxinc, heatstor, heatstorinc, relheat_iw,             &
    !$omp latvap_av, latvapinc_ivol, porinc_ivol, rho_av,             &
    !$omp tdsnew_ivol, tempinc_ivol, tdsold_ivol, tortuosity,         &
    !$omp totheatflux, vapfluxheat, vapfluxinc, viscoinc_ivol,        &
    !$omp vsfluxinc, vsfluxheat, totsinksource, totsinksourceinc)
#endif

!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi calculate relative permeability to account for the 
!cprovi presence of a napl phase
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------

      if (napl_permeability) then      
#ifdef USG
        if (discretization_type > 0 .and. is_cell_based_relp) then
#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif    
#endif
          do icell = 1,num_cells             !loop over cells
            izn = mpropvs_cell(icell)
            
            sanew_loc = 0.0d0
            do i2 = 1, num_nodes_per_cell
              sanew_loc = sanew_loc + sanew(cells(i2,icell))
            end do
            sanew_loc = sanew_loc / num_nodes_per_cell
            
            if (napl_kfunction .eq. 'vangenuchten') then          
              relperm(icell) = relpfsat(sanew_loc,swr(izn),expn(izn),spgamma(izn))              
            else if (napl_kfunction .eq. 'corey') then                  
              relperm(icell) = ((sanew_loc - swr(izn))/(r1 - swr(izn)))**r4          
            end if 
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif
        else
#endif
      
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif     
          do ivol = 1,nngl             !loop over control volumes
              
#ifdef DEBUG
#ifdef PETSC
            ivol_gbl = node_idx_lg2g(ivol)
#else
            ivol_gbl = ivol
#endif
#endif              
            izn = mpropvs(ivol)
            if (napl_kfunction .eq. 'vangenuchten') then
               
              relperm(ivol) = relpfsat(sanew(ivol),swr(izn),expn(izn),spgamma(izn))
              
            else if (napl_kfunction .eq. 'corey') then
                  
              relperm(ivol) = ((sanew(ivol) - swr(izn))/(r1 - swr(izn)))**r4
          
            end if 
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef USG
        end if
#endif
       
      end if
      
     
!cprovi-----------------------------------------------------------------------
!cprovi Build Jacobian matrix 
!cprovi-----------------------------------------------------------------------
      if (iter_sia==1) then
        delt_loc=delt_tds
      else
        delt_loc=delt
      end if

!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
#endif
      do ivol = 1,nngl
          
#ifdef DEBUG
#ifdef PETSC
        ivol_gbl = node_idx_lg2g(ivol)
#else
        ivol_gbl = ivol
#endif
#endif
 
        if (reactive_transport) then
          actw=gamma(nc,ivol)
        else
          actw=r1
        end if        

        densnew_ivol = density(ivol)
        densold_ivol = densold(ivol)
        sanew_ivol = sanew(ivol)
        saold_ivol = saold(ivol)
        tdsnew_ivol = tds_new(ivol)
        tdsold_ivol = tds_old(ivol)

        if (ispitzerdens) then  
          if (heat_transport) then
            densoldc_ivol = densold_pitzer(ivol)
            densnewc_ivol = density_pitzer(ivol)
          else
            !c density_pitzer is not avaialbe without heat transport
            !c use the following formula which is same as non-pitzer density
            densoldc_ivol = drho_dc*tds_old(ivol)
            densnewc_ivol = drho_dc*tds_new(ivol)
          end if
        else
          densoldc_ivol = r0
          densnewc_ivol = r0
        end if

 
        izn = mpropvs(ivol)                                        ! Zone corresponding to ivol for material properties 
        idiag = iaheat(ivol)                                   ! diagonal pointer dF(T)/dT    
!cprovi-----------------------------------------------------------
!cprovi Pointers to connected cells
!cprovi-----------------------------------------------------------           
        istart = iaheat(ivol)+1                                       
        iend = iaheat(ivol+1)-1                                      
!cprovi-----------------------------------------------------------
!cprovi calculate storage and flux terms for current control 
!cprovi volume
!cprovi-----------------------------------------------------------
        totheatflux = r0         ! initialize total flux for heat 
        icon = 0                 ! counter (connections)

!cprovi---------------------------------------------------------------
!cprovi Loop on connected control volumes
!cprovi---------------------------------------------------------------             
        do i1=istart,iend          !loop over connected control volumes
          
          icon = icon + 1 
!cprovi---------------------------------------------------------------             
!cprovi Column pointer 
!cprovi---------------------------------------------------------------                      
          jvol = jaheat(i1)       
          
#ifdef USG
          if (discretization_type > 0) then
            ncell = janumcell(i1)
          end if
#endif

!cprovi---------------------------------------------------------------             
!cprovi Initialice vectors for connected cells
!cprovi---------------------------------------------------------------             
          heatflux_a(icon)=r0 
          heatflux_c(icon)=r0 
          heatflux_d(icon)=r0 
          if (evaporation) then                                         
            vapfluxheat(icon)=r0
            heatflux_v(icon)=r0                                
          end if   
!cprovi---------------------------------------------------------------            
!cprovi compute difference in total presure potential between  
!cprovi current and adjacent control volumes Pjvol - Pivol
!cprovi the distance between cells are in the influence 
!cprovi coefficients 
!cprovi---------------------------------------------------------------  
          del_p(icon) = uvsnew(jvol) - uvsnew(ivol)
          del_z(icon) = zg(jvol) - zg(ivol)
!cprovi---------------------------------------------------------------             
!cprovi     
!cprovi---------------------------------------------------------------  
          if (del_z(icon)/=r0) then
!cprovi---------------------------------------------------------------  
!cprovi Compute the average density
!cprovi------------------------------------------------------------
            rho_av = rhalf * (density(ivol) + density(jvol))
            if (av_dens_z) then
              del_p(icon)=rho_av*(uvsnew(jvol)/density(jvol)-uvsnew(ivol)/density(ivol))
            end if

!cprovi---------------------------------------------------------------  
!c  convert del_z to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential
!cprovi---------------------------------------------------------------
            del_z(icon) = del_z(icon) * rho_av * gacc
            del_p(icon) = del_p(icon) + del_z(icon)
          end if

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
             write(idbg,'(6(a,1x,e16.8,1x))')                          &
                   "-->jacdd_energybal->del_p",del_p(icon),            &
                   "uvsivol",uvsnew(ivol),"uvsjvol",uvsnew(jvol),      &
                   "densivol",density(ivol),"densjvol",density(jvol),  &
                   "del_z",del_z(icon)
          end if
#endif

!cprovi---------------------------------------------------------------  
!c  assign coefficients for upstream weighting of density and viscosity
!c  required for mass flux calculation
!cprovi---------------------------------------------------------------  
!cprovi----------------------------------------------------------------
!cprovi Compute the advective fluxes 
!cprovi----------------------------------------------------------------

#ifdef USG
!c calculate gradient for interface, mid point of edge ivol-jvol
          if (discretization_type > 0) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
            grad_ddflow_mids = vector_zero
            flux_ddflow_hls_corr = r0
              
            if (b_use_cross_diffusion_flow) then
              call gradient_cross_diff_dd(i1,ivol,jvol,                &
                   grad_locs,grad_ddflow_mids,grad_weights,            &
                   flux_ddflow_hls_corr,grad_ddflow_hls_loc)              
            end if

!c evaporation calculation
            grad_temp_mids = vector_zero
            flux_temp_hls_corr = r0
            if (evaporation) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
              if (b_use_cross_diffusion_heat) then
                call gradient_cross_diff(i1,ivol,jvol,tempnew,         &
                              grad_locs,grad_temp_mids,                &
                              grad_weights,flux_temp_hls_corr,         &
                              grad_temp_hls_loc)
              end if

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
              grad_flow_mids = vector_zero
              flux_flow_hls_corr = r0
              
              if (b_use_cross_diffusion_flow) then
                call gradient_cross_diff(i1,ivol,jvol,uvsnew,          &
                              grad_locs,grad_flow_mids,                &
                              grad_weights,flux_flow_hls_corr,         &
                              grad_flow_hls_loc)
              end if              
              
            end if

!cdsu calculate influence coefficient for variable saturated flow
            call usg_face_utility_cinfvs(ivol,jvol,i1,cinfvs_usg_loc,  &
                                         cinfvs_usg_cross_loc)

            if (evaporation) then
              if (split_divdensv) then
                call usg_face_utility_cinfevap_t(ivol,jvol,i1,         &
                         cinfevap_t_usg_loc,cinfevap_t_usg_cross_loc)
                call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                         cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
              else
                call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                         cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
              end if
            end if

            if (isconductive) then
              call usg_face_utility_cinfheat_c(ivol,jvol,i1,           &
                       cinfheat_c_usg_loc,cinfheat_c_usg_cross_loc)
            end if

            if (isdispersive) then
              call usg_face_utility_cinfheat_d(ivol,jvol,i1,           &
                       cinfheat_d_usg_loc,cinfheat_d_usg_cross_loc)
            end if

            relps_loc = 0.0d0
            if (is_cell_based_relp) then
              nrelp = ncell
              do icell = 1, ncell
                i2 = jacell(icell,i1)
                if (i2 >0) then
                  relps_loc(icell) = relperm(i2)
                end if
              end do
            else
              nrelp = 2
              relps_loc(1:2) = (/relperm(ivol),relperm(jvol)/)
            end if

          end if
#endif
     

!cprovi----------------------------------------------------------------
!cprovi Compute the vapour diffusiive fluxes 
!cprovi with respect to pressure gradients 
!cprovi and temperature gradients
!cprovi----------------------------------------------------------------                                          
          if (evaporation) then

            tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol),sgnew(ivol),sgnew(jvol))
              
          end if
!cprovi--------------------------------------------------------------------------
!cprovi Energy balance equation 
!cprovi--------------------------------------------------------------------------

!cprovi--------------------------------------------------------------------------
!cprovi Advective term 
!cprovi--------------------------------------------------------------------------          
          if (isadvective) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if

            if (b_use_fixed_flow_vel) then
              
              if (b_use_zero_flow_vel) then
                vsfluxheat(icon) = r0
                heatflux_a(icon) = r0
              else
                !c TBD
              end if
            
            else
#ifdef USG
              if (discretization_type > 0) then
            
                vsfluxheat(icon) = darcy_energybal_usg(del_p(icon),del_p(icon),         &
                                         num_edge_dvols,ncell,                          &
                                         grad_ddflow_mids(1:num_edge_dvols,1:ncell),    &
                                         flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell),&
                                         density(ivol),density(jvol),                   &
                                         viscosity(ivol),viscosity(jvol),               &
                                         is_cell_based_relp,nrelp,relps_loc(1:nrelp),   &
                                         cinfvs_usg_loc(1:num_edge_dvols,1:ncell),      &
                                         cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                         ups_heat,isboussinesq)

                if (isboussinesq) then
                  heatflux_a(icon)=fluxheat(tempnew(ivol),tempnew(jvol),ivol,jvol,      &
                                            vsfluxheat(icon),nngl,tempold,              &
                                            i2up,sp_weight_heat,r1,r1)
                else
                  heatflux_a(icon)=heatcapw*relheat_iw*                                 &
                                            fluxheat(tempnew(ivol),tempnew(jvol),       &
                                               ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                               i2up,sp_weight_heat,r1,r1)
                end if

#ifdef DEBUG
                if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
                    ivol_track == 0)) then
                   write(idbg,'(4(a,1x,i6,1x),6(a,1x,e16.8,1x))')              &
                         "-->jacdd_energybal->ivol",ivol,"jvol",jvol,          &
                         "i2upivol",i2up(ivol),"i2upjvol",i2up(jvol),          &
                         "heatflux_a", heatflux_a(icon),                       &
                         "vsfluxheat",vsfluxheat(icon),                        &
                         "tempnivol",tempnew(ivol),"tempnjvol",tempnew(jvol),  &
                         "tempoivol",tempold(ivol),"tempojvol",tempold(jvol)
                end if
#endif

              else
#endif
                vsfluxheat(icon) = darcy_energybal(del_p(icon),del_p(icon),    &
                                         density(ivol),density(jvol),          &
                                         viscosity(ivol),viscosity(jvol),      &
                                         relperm(ivol),relperm(jvol),          &
                                         cinfvs_a(i1),ups_heat,isboussinesq)

                if (isboussinesq) then
                  heatflux_a(icon) = fluxheat(tempnew(ivol),tempnew(jvol),     &
                                              ivol,jvol,vsfluxheat(icon),nngl, &
                                              tempold,i2up,sp_weight_heat,     &
                                              distcells(i1,1),distcells(i1,2))
                else
                  heatflux_a(icon) = heatcapw*relheat_iw*                      &
                                     fluxheat(tempnew(ivol),tempnew(jvol),     &
                                              ivol,jvol,vsfluxheat(icon),nngl, &
                                              tempold,i2up,sp_weight_heat,     &
                                              distcells(i1,1),distcells(i1,2))
                end if

#ifdef USG
              end if
#endif
            end if
          end if
           
!cprovi--------------------------------------------------------------------------
!cprovi Vapour fluxes 
!cprovi--------------------------------------------------------------------------           

          if (evaporation) then
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vapfluxheat(icon) = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),           &
                                    num_edge_dvols,ncell,                                &
                                    grad_flow_mids(1:num_edge_dvols,1:ncell),            &
                                    flux_flow_hls_corr(1:num_edge_dvols,1:ncell),        &
                                    r1,r1,r1,r1,r1,r1,                                   &
                                    cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),       &
                                    cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                                    r1,r1,tortuosity,ups_heat,.false.)


                vapfluxheat(icon) = vapfluxheat(icon) +                                  &
                                    diff_vapour_usg(tempnew(ivol),tempnew(jvol),         &
                                    num_edge_dvols,ncell,                                &
                                    grad_temp_mids(1:num_edge_dvols,1:ncell),            &
                                    flux_temp_hls_corr(1:num_edge_dvols,1:ncell),        &
                                    r1,r1,r1,r1,r1,r1,                                   &
                                    cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),        &
                                    cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                                    r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxheat(icon)  = diff_vapour_usg(densvnew(ivol),densvnew(jvol),      &
                                     num_edge_dvols,ncell,                               &
                                     grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                                     flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                                     r1,r1,r1,r1,r1,r1,                                  &
                                     cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                                     cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                     r1,r1,tortuosity,ups_heat,.false.)
              end if

              heatflux_v(icon) = heatcapv*fluxheat(tempnew(ivol),tempnew(jvol),          &
                                             ivol,jvol,vapfluxheat(icon),nngl,tempold,   &
                                             i2up,sp_weight_heat,r1,r1)
            else
#endif
              if (split_divdensv) then
                vapfluxheat(icon)  = diff_vapour(uvsnew(ivol),uvsnew(jvol),r1,        &
                                     r1,r1,r1,r1,r1,cinfevap_pa(i1),                  &
                                     r1,r1,tortuosity,ups_heat,.false.)


                vapfluxheat(icon)  = vapfluxheat(icon) + diff_vapour(tempnew(ivol),   &
                                    tempnew(jvol),r1,r1,r1,r1,r1,r1,cinfevap_t(i1),   &
                                    r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxheat(icon)  = diff_vapour(densvnew(ivol),densvnew(jvol),r1,    &
                                    r1,r1,r1,r1,r1,cinfevap_pa(i1),                   &
                                    r1,r1,tortuosity,ups_heat,.false.)
              end if

              heatflux_v(icon)   = heatcapv*fluxheat(tempnew(ivol),tempnew(jvol),     &
                                   ivol,jvol,vapfluxheat(icon),nngl,tempold,          &
                                   i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
#ifdef USG
            end if
#endif

            latvap_av = rhalf*(latvapnew(ivol)+latvapnew(jvol))
                                   
            heatflux_v(icon) = heatflux_v(icon) + latvap_av*vapfluxheat(icon)

            totheatflux = totheatflux +  heatflux_v(icon)

          end if

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
              ivol_track == 0)) then
             write(idbg,'(3(a,1x,1pe15.6e3,1x))')                        &
                   "-->jacdd_energybal->totheatflux-a", totheatflux
          end if
#endif

!cprovi--------------------------------------------------------------------------
!cprovi Conductive fluxes 
!cprovi--------------------------------------------------------------------------  
          del_temp(icon) = tempnew(jvol) - tempnew(ivol)

          if (isconductive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi, &
                                            uvsnew(ivol))
            end if

            if (isboussinesq) then
               coeff = r1/(heatcapw*relheat_iw*density(ivol))
            else
               coeff = r1
            end if
#ifdef USG
            if (discretization_type > 0) then
              heatflux_c(icon) = - fluxdd_usg(del_temp(icon),                 &
                         num_edge_dvols,ncell,                                &
                         grad_temp_mids(1:num_edge_dvols,1:ncell),            &
                         flux_temp_hls_corr(1:num_edge_dvols,1:ncell),        &
                         cinfheat_c_usg_loc(1:num_edge_dvols,1:ncell),        &
                         cinfheat_c_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                         .false.,1,(/coeff/))

#ifdef DEBUG
#ifdef USG
              if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
                  ivol_track == 0)) then
                 write(idbg,*) "-->jacdd_energybal->heatflux_c",             &
                       heatflux_c(icon), "del_temp", del_temp(icon),         &
                       "num_edge_dvols", num_edge_dvols, "ncell", ncell,     &
                       "coeff", coeff
                 do icell = 1, ncell
                   do idvol = 1, num_edge_dvols
                     write(idbg,*) "icell",icell,"idvol",idvol,              &
                           "grad_temp",grad_temp_mids(idvol,icell)%x,        &
                           grad_temp_mids(idvol,icell)%y,                    &
                           grad_temp_mids(idvol,icell)%z,                    &
                           "flux_temp_hls_corr",                             &
                           flux_temp_hls_corr(idvol,icell),                  &
                           "cinfheat_c_usg_loc",                             &
                           cinfheat_c_usg_loc(idvol,icell),                  &
                           "cinfheat_c_usg_cross_loc",                       &
                           cinfheat_c_usg_cross_loc(idvol,icell)%x,          &
                           cinfheat_c_usg_cross_loc(idvol,icell)%y,          &
                           cinfheat_c_usg_cross_loc(idvol,icell)%z
                   end do
                 end do
              end if
#endif
#endif

            else
#endif
              heatflux_c(icon) = - fluxdd(del_temp(icon),cinfheat_c(i1),coeff)

#ifdef USG
            end if
#endif
          end if
!cprovi--------------------------------------------------------------------------
!cprovi Dispersive fluxes 
!cprovi--------------------------------------------------------------------------                
          if (isdispersive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if
#ifdef USG
            if (discretization_type > 0) then
              heatflux_d(icon) = diff_vapour_usg(tempnew(ivol),tempnew(jvol),          &
                                 num_edge_dvols,ncell,                                 &
                                 grad_temp_mids(1:num_edge_dvols,1:ncell),             &
                                 flux_temp_hls_corr(1:num_edge_dvols,1:ncell),         &
                                 density(ivol),density(jvol),pornew(ivol),pornew(jvol),&
                                 sanew(ivol),sanew(jvol),                              &
                                 cinfheat_d_usg_loc(1:num_edge_dvols,1:ncell),         &
                                 cinfheat_d_usg_cross_loc(1:num_edge_dvols,1:ncell),   &
                                 r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
              
            else
#endif
              heatflux_d(icon) = diff_vapour(tempnew(ivol),tempnew(jvol),             &
                                      density(ivol),density(jvol),                    &
                                      pornew(ivol),pornew(jvol),                      &
                                      sanew(ivol),sanew(jvol),                        &
                                      cinfheat_d(i1),r1,r1,heatcapw*relheat_iw,       &
                                      ups_heat,isboussinesq)

#ifdef USG
            end if
#endif
          end if
!cprovi--------------------------------------------------------------------------
!cprovi Add the total fluxes
!cprovi--------------------------------------------------------------------------     
          totheatflux = totheatflux + heatflux_a(icon) + heatflux_c(icon) + heatflux_d(icon)

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
              ivol_track == 0)) then
             write(idbg,'(6(a,1x,1pe15.6e3,1x))')                        &
                   "-->jacdd_energybal->totheatflux-b", totheatflux,     &
                   "heatflux_a", heatflux_a(icon),                       &
                   "heatflux_c", heatflux_c(icon),                       &
                   "heatflux_d", heatflux_d(icon)
          end if
#endif

        end do                   !loop over connected control volumes

!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi-------------------------------------------------------------   
        if (b_icewater_heat) then
          relheat_iw = r1
        else
          relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi, &
                                        uvsnew(ivol))
        end if

        if (isstorheat .and. transient_flow) then

          heatstor = cvol(ivol)*storheat(delt,delt_loc,tempnew(ivol),  &
                                tempold(ivol),sanew_ivol,saold_ivol, &
                                densnew_ivol,densold_ivol,densnewc_ivol, &
                                densoldc_ivol,tdsnew_ivol,tdsold_ivol, &
                                drho_dc,drho_dt,denssolid(ivol), &
                                pornew(ivol),porold(ivol),heatcapw*relheat_iw,  &
                                heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                                cdens1,cdens2,cdens3,cdens4)

          !cprovi---------------------------------------------
          !cprovi Add the terms corresponding to evaporation
          !cprovi in the storage of heat equation
          !cprovi---------------------------------------------
          if (evaporation) then
            heatstor = heatstor + cvol(ivol)*storevap(delt,tempnew(ivol), &
                                  tempold(ivol),sgnew(ivol),sgold(ivol), &
                                  densvnew(ivol),densvold(ivol), &
                                  pornew(ivol),porold(ivol),heatcapv)
            heatstor = heatstor + cvol(ivol)*storevap(delt,latvapnew(ivol), &
                                  latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                  densvnew(ivol),densvold(ivol), &
                                  pornew(ivol),porold(ivol),r1)
          end if

          if  (reaction_heat) then
            totsinksource = r0
            do im = 1, nm
              if (cmnew(im,ivol).gt.1d-10) then
                if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
                    reaction_type(im).eq.'reversible') then
                  totsinksource = totsinksource + r1d3*cvol(ivol)*   &
                                  cal2jou*ratemdp(im,ivol)*dscm(im) 
                end if 
              end if            
            end do
            heatstor = heatstor + totsinksource
          end if

        else
          heatstor = r0
        end if
!cprovi-------------------------------------------------------------
!cprovi Store in the residual the total fluxes and storage term  
!cprovi------------------------------------------------------------- 

        call rhsvs(heatstor,totheatflux,bheat(ivol))
          
#ifdef DEBUG
        if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
           write(idbg,'(3(a,1x,1pe15.6e3,1x))')                        &
                 "-->jacdd_energybal->rhsvs heatstor", heatstor,       &
                 "totheatflux", totheatflux, "bheat", bheat(ivol)
        end if
#endif  
                   
!cprovi--------------------------------------------------------------------
!cprovi  If we consider logarithm in unknowns 
!cprovi--------------------------------------------------------------------        
        if (islogunk_energybal) then
          factemp=tempnew(ivol)
        else   
          factemp=r1
        end if

!cprovi--------------------------------------------------------------------
!cprovi Compute increment in temperature 
!cprovi--------------------------------------------------------------------
        tempinc_ivol = tempnew(ivol) + dinc_heat                       
!cprovi--------------------------------------------------------------------
!cprovi Compute density and viscosity increment as a function of 
!cprovi temperature increment 
!cprovi Also compute the increment of porosity as a function of
!cprovi Pl
!cprovi 
!cprovi--------------------------------------------------------------------       
        if (ispitzerdens) then
          densinc_ivol = rhonew(ref_dens,density_pitzer(ivol),ref_dens,      &
                                tempinc_ivol,tempref_dens,r1,drho_dt,        &
                                nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
        else
          densinc_ivol = rhonew(ref_dens,tds_new(ivol),ref_tds,              &
                                tempinc_ivol,tempref_dens,drho_dc,drho_dt,   &
                                nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
        end if

        if (update_viscosity_temp) then
            viscoinc_ivol = visconew(densinc_ivol,tds_new(ivol),             &
                                     tempinc_ivol,update_viscosity,          &
                                     update_viscosity_temp,cvisco1,cvisco2,  &
                                     cvisco3,cvisco4,cvisco5,tempref_dens,   &
                                     iviscomodel,ref_visco,ref_tds,ref_dens)
        else
            viscoinc_ivol = viscosity(ivol)
        end if

        if (modify_por(ivol)) then
             porinc_ivol = porosity_flow(porold(ivol),uvsnew(ivol),          &
                                         uvsold(ivol),stor(ivol),            &
                                         por_stress_dt(ivol),por_init(ivol), &
                                         facpormin)
        else
             porinc_ivol = pornew(ivol)
        end if
!cprovi--------------------------------------------------------------------       
!cprovi Compute the preturbed liquid saturation and relative permeability 
!cprovi as function of liquid pressure 
!cprovi--------------------------------------------------------------------

        if (variably_saturated) then
          izn = mpropvs(ivol)
          !cprovi-----------------------------------------------------------
          !cprovi Compute the perturbations in vapour density
          !cpprovi----------------------------------------------------------
          if (evaporation) then

            if (soilhydrfunc_field) then
              aentry_loc = aentry_vol(ivol)
            else
              aentry_loc = aentry(izn)
            end if

            ! Perturbation in the liquid pressures
            !
            call vapor_prop (densvinc_pa_ivol,dummy1,dummy2,dummy3,dummy4,     &
                             tempnew(ivol),aentry_loc,uvsnew(ivol),            &
                             actw,density(ivol),ivol)
            ! Perturbation in temperature
            !
            call vapor_prop (densvinc_temp_ivol,dummy1,dummy2,dummy3,          &
                             latvapinc_ivol,tempinc_ivol,aentry_loc,           &
                             uvsnew(ivol),actw,densinc_ivol,ivol)

          end if
        end if
              
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------        
!cprovi--------------------------------------------------------------------        
!c  calculate derivatives of storage and flux terms for current 
!c  control volume (assembly columnwise)
!cprovi--------------------------------------------------------------------        
        dtotheatflux_temp = r0
        icon = 0                          !counter (connections)

        do i1=istart,iend                 !loop over connected control volumes
        
          jvol = jaheat(i1)                 !column pointer
          
#ifdef USG
          if (discretization_type > 0) then
            ncell = janumcell(i1)
          end if
#endif
          isym = isymheat(i1)    !symmetry pointer for temp in heat equation
          
          icon = icon + 1
          
          
#ifdef USG
!c calculate gradient for interface, mid point of edge ivol-jvol
          if (discretization_type > 0) then
            grad_temp_inc_mids = vector_zero
            flux_temp_inc_hls_corr = r0
            if (evaporation) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
                
              if (b_use_cross_diffusion_heat) then
                call gradient_cross_diff_inc(i1,ivol,jvol,dinc_heat,   &
                     tempnew,grad_locs,grad_temp_inc_mids,             &
                     grad_weights,flux_temp_inc_hls_corr,              &
                     grad_temp_hls_loc)
              end if              
            end if

!cdsu calculate influence coefficient for variable saturated flow
            call usg_face_utility_cinfvs(ivol,jvol,i1,cinfvs_usg_loc,  &
                                         cinfvs_usg_cross_loc)

            if (evaporation) then
              if (split_divdensv) then
                call usg_face_utility_cinfevap_t(ivol,jvol,i1,         &
                         cinfevap_t_usg_loc,cinfevap_t_usg_cross_loc)
                call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                         cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
              else
                call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                         cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
              end if
            end if

            if (isconductive) then
              call usg_face_utility_cinfheat_c(ivol,jvol,i1,           &
                       cinfheat_c_usg_loc,cinfheat_c_usg_cross_loc)
            end if

            if (isdispersive) then
              call usg_face_utility_cinfheat_d(ivol,jvol,i1,           &
                       cinfheat_d_usg_loc,cinfheat_d_usg_cross_loc)
            end if

            relps_loc = 0.0d0
            if (is_cell_based_relp) then
              nrelp = ncell
              do icell = 1, ncell
                i2 = jacell(icell,i1)
                if (i2 >0) then
                  relps_loc(icell) = relperm(i2)
                end if
              end do
            else
              nrelp = 2
              relps_loc(1:2) = (/relperm(ivol),relperm(jvol)/)
            end if

          end if
#endif

!cprovi--------------------------------------------------------------------
!cprovi End of Computing term dF(Pa)/dPa
!cprovi--------------------------------------------------------------------

!cprovi--------------------------------------------------------------------
!cprovi End of Computing term dF(Pa)/dT
!cprovi--------------------------------------------------------------------

!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa and df(T)/dT
!cprovi--------------------------------------------------------------------        
          dtemp_ivol_jvol = tempnew(jvol) - tempinc_ivol

          if (isadvective) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi Perturbation in the advective term 
!cprovi--------------------------------------------------------------------
            if (b_use_fixed_flow_vel) then
              
              if (b_use_zero_flow_vel) then
                vsfluxinc = r0
                heatfluxinc = r0
              else
                !c TBD
              end if
            
            else
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = darcy_energybal_usg(del_p(icon),del_p(icon),         &
                                  num_edge_dvols,ncell,                          &
                                  grad_ddflow_mids(1:num_edge_dvols,1:ncell),    &
                                  flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell),&
                                  densinc_ivol,density(jvol),                    &
                                  viscoinc_ivol,viscosity(jvol),                 &
                                  is_cell_based_relp,nrelp,relps_loc(1:nrelp),   &
                                  cinfvs_usg_loc(1:num_edge_dvols,1:ncell),      &
                                  cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                  ups_heat,isboussinesq)
              

                if (isboussinesq) then
                  heatfluxinc = fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,   &
                                         vsfluxinc,nngl,tempold,                 &
                                         i2up,sp_weight_heat,r1,r1)
                else
                  heatfluxinc=heatcapw*relheat_iw*                               &
                                       fluxheat(tempinc_ivol,tempnew(jvol),      &
                                                ivol,jvol,vsfluxinc,nngl,tempold,&
                                                i2up,sp_weight_heat,r1,r1)
                end if
              else
#endif
                vsfluxinc = darcy_energybal(del_p(icon),del_p(icon),             &
                                            densinc_ivol,density(jvol),          &
                                            viscoinc_ivol,viscosity(jvol),       &
                                            relperm(ivol),relperm(jvol),         &
                                            cinfvs_a(i1),ups_heat,isboussinesq)

                if (isboussinesq) then
                  heatfluxinc = fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,   &
                                         vsfluxinc,nngl,tempold,i2up,            &
                                         sp_weight_heat,                         &
                                         distcells(i1,1),distcells(i1,2))
                else
                  heatfluxinc = heatcapw*relheat_iw*                             &
                                         fluxheat(tempinc_ivol,tempnew(jvol),    &
                                                  ivol,jvol,vsfluxinc,nngl,      &
                                                  tempold,i2up,sp_weight_heat,   &
                                                  distcells(i1,1),distcells(i1,2))
                end if
#ifdef USG
              end if
#endif
            end if

            dheatflux = (heatfluxinc - heatflux_a(icon)) / dinc_heat
            aheat(isym) = aheat(isym) -factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-F ivol",ivol,"isym",isym, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aheat(isym)",aheat(isym)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux

          end if ! isadvective


!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi Perturbation in the conductive term 
!cprovi--------------------------------------------------------------------         
          if (isconductive) then
            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi,   &
                                            uvsnew(ivol))
            end if

            if (isboussinesq) then
              coeff = r1/(heatcapw*relheat_iw*densinc_ivol)
            else
              coeff = r1
            end if
#ifdef USG
            if (discretization_type > 0) then
              heatfluxinc = -fluxdd_usg(dtemp_ivol_jvol,num_edge_dvols,ncell,   &
                             grad_temp_inc_mids(1:num_edge_dvols,1:ncell),      &
                             flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),  &
                             cinfheat_c_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfheat_c_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             .false.,1,(/coeff/))
            else
#endif
              heatfluxinc = - fluxdd(dtemp_ivol_jvol,cinfheat_c(i1),coeff)
#ifdef USG
            end if
#endif

            dheatflux = (heatfluxinc-heatflux_c(icon)) / dinc_heat

#ifdef DEBUG
#ifdef USG
            if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,*) "jacddfs-G0 ivol",ivol,                    &
                    "dheatflux",dheatflux,"heatfluxinc",heatfluxinc,   &
                    "dtemp_ivol_jvol",dtemp_ivol_jvol,"coeff",coeff
              do icell = 1, ncell
                do idvol = 1, num_edge_dvols
                  write(idbg,*) "-->jacdd_energybal-G0 icell",icell,   &
                        "idvol",idvol,"grad_temp_inc_mids",            &
                        grad_temp_inc_mids(idvol,icell)%x,             &
                        grad_temp_inc_mids(idvol,icell)%y,             &
                        grad_temp_inc_mids(idvol,icell)%z,             &
                        "flux_temp_inc_hls_corr",                      &
                        flux_temp_inc_hls_corr(idvol,icell),           &
                        "cinfheat_c_usg_loc",                          &
                        cinfheat_c_usg_loc(idvol,icell),               &
                        "cinfheat_c_usg_cross_loc",                    &
                        cinfheat_c_usg_cross_loc(idvol,icell)%x,       &
                        cinfheat_c_usg_cross_loc(idvol,icell)%y,       &
                        cinfheat_c_usg_cross_loc(idvol,icell)%z
                end do
              end do
            end if
#endif
#endif
            aheat(isym) = aheat(isym) - factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-G ivol",ivol,"isym",isym, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aheat(isym)",aheat(isym)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux

          end if  ! isconductive
          
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa and df(T)/dT
!cprovi Perturbation in the dispersive term 
!cprovi--------------------------------------------------------------------                
          if (isdispersive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0,&
                                            heatcapw,heatcapi,                  &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi--------------------------------------------------------------------           
#ifdef USG
            if (discretization_type > 0) then
              heatfluxinc = diff_vapour_usg(tempinc_ivol,tempnew(jvol),         &
                            num_edge_dvols,ncell,                               &
                            grad_temp_inc_mids(1:num_edge_dvols,1:ncell),       &
                            flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                            densinc_ivol,density(jvol),                         &
                            pornew(ivol),pornew(jvol),sanew(ivol),sanew(jvol),  &
                            cinfheat_d_usg_loc(1:num_edge_dvols,1:ncell),       &
                            cinfheat_d_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                            r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
            else
#endif
              heatfluxinc = diff_vapour(tempinc_ivol,tempnew(jvol),densinc_ivol,&
                                        density(jvol),pornew(ivol),pornew(jvol),&
                                        sanew(ivol),sanew(jvol),cinfheat_d(i1), &
                                        r1,r1,heatcapw*relheat_iw,              &
                                        ups_heat,isboussinesq)
#ifdef USG
            end if
#endif

            dheatflux = (heatfluxinc-heatflux_d(icon)) / dinc_heat
            aheat(isym) = aheat(isym) - factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-H ivol",ivol,"isym",isym, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aheat(isym)",aheat(isym)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux
                       
          end if   ! isdispersive
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------          
          if (evaporation) then
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vapfluxinc = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),          &
                             num_edge_dvols,ncell,                               &
                             grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                             flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             r1,r1,tortuosity,ups_heat,.false.)
                vapfluxinc = vapfluxinc +                                        &
                             diff_vapour_usg(tempinc_ivol,tempnew(jvol),         &
                             num_edge_dvols,ncell,                               &
                             grad_temp_inc_mids(1:num_edge_dvols,1:ncell),       &
                             flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),       &
                             cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                             r1,r1,tortuosity,ups_heat,.false.)
                              
              else
                vapfluxinc = diff_vapour_usg(densvinc_temp_ivol,densvnew(jvol),   &
                             num_edge_dvols,ncell,                                &
                             grad_flow_mids(1:num_edge_dvols,1:ncell),            &
                             flux_flow_hls_corr(1:num_edge_dvols,1:ncell),        &
                             r1,r1,r1,r1,r1,r1,                                   &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),       &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                             r1,r1,tortuosity,ups_heat,.false.)
              end if
              heatfluxinc = heatcapv*fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,     &
                                        vapfluxinc,nngl,tempold,                        &
                                        i2up,sp_weight_heat,r1,r1)
            else
#endif
              if (split_divdensv) then
                vapfluxinc   = diff_vapour(uvsnew(ivol),uvsnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)
                vapfluxinc = vapfluxinc + diff_vapour(tempinc_ivol,tempnew(jvol),r1, &
                              r1,r1,r1,r1,r1,cinfevap_t(i1), &
                              r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxinc   = diff_vapour(densvinc_temp_ivol,densvnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)
              end if
              heatfluxinc = heatcapv*fluxheat(tempinc_ivol, &
                            tempnew(jvol),ivol,jvol,vapfluxinc,nngl,tempold, &
                            i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
#ifdef USG
            end if
#endif

            latvap_av = rhalf*(latvapinc_ivol+latvapnew(jvol))
            
            heatfluxinc   = heatfluxinc + latvap_av*vapfluxinc

            dheatflux = (heatfluxinc - heatflux_v(icon)) / dinc_heat
            aheat(isym) = aheat(isym) - factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-J ivol",ivol,"isym",isym, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aheat(isym)",aheat(isym)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux
              
          end if    !evaporation
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
        end do                  !loop over connected control volumes

!c  compute storage term with incremented variables (lumped) 
!c  for current control volume, only for transient conditions

       
        aheat(idiag) = aheat(idiag) + factemp * dtotheatflux_temp

#ifdef DEBUG
        if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
          write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')           &
                "jacddfs-L ivol",ivol,"idiag",idiag,   &
                "factemp",factemp,"dvsfluxdtotheatflux_temp",          &
                dtotheatflux_temp,                                     &
                "aheat(idiag)",aheat(idiag)
        end if
#endif 
        
!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi------------------------------------------------------------- 
        if (b_icewater_heat) then
          relheat_iw = r1
        else
          relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi, &
                                        uvsnew(ivol))
        end if

        if (isstorheat .and. transient_flow) then 

          heatstorinc = cvol(ivol)*storheat(delt,delt_loc,tempinc_ivol, &
                                   tempold(ivol),sanew_ivol,saold_ivol, &
                                   densinc_ivol,densold(ivol),densnewc_ivol, &
                                   densoldc_ivol,tdsnew_ivol,tdsold_ivol,drho_dc, &
                                   drho_dt,denssolid(ivol), & 
                                   pornew(ivol),porold(ivol),heatcapw*relheat_iw, &
                                   heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                                   cdens1,cdens2,cdens3,cdens4) 
              
          if (evaporation) then
            heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,tempinc_ivol, &
                                        tempold(ivol),sgnew(ivol),sgold(ivol), &
                                        densvinc_temp_ivol,densvold(ivol), &
                                        pornew(ivol),porold(ivol), &
                                        heatcapv)
            heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,latvapinc_ivol, &
                                        latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                        densvinc_temp_ivol,densvold(ivol),pornew(ivol), &
                                        porold(ivol),r1)                                             
          end if  

          if (reaction_heat) then
            totsinksourceinc = r0
            do im = 1, nm
              if (cmnew(im,ivol).gt.1d-10) then
                if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
                    reaction_type(im).eq.'reversible') then
                  totsinksourceinc = totsinksourceinc + r1d3*cvol(ivol)* &
                                     cal2jou*ratemdp(im,ivol)*dscm(im) 
                end if
              end if            
            end do
            heatstorinc = heatstorinc + totsinksourceinc
          end if
            
          !cprovi-------------------------------------------------------------          
          !cprovi Compute d F(Temp) / d Temp corresponding to storage term
          !cprovi-------------------------------------------------------------                             
          dheatstor = (heatstorinc - heatstor) / dinc_heat
          aheat(idiag) = aheat(idiag) + factemp * dheatstor

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
            write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')         &
                  "jacddfs-R ivol",ivol,"idiag",idiag, &
                  "factemp",factemp,"dheatstor",dheatstor,             &
                  "aheat(idiag)",aheat(idiag)
          end if
#endif
        end if   ! isstorheat

!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------                    
!cprovi------------------------------------------------------------- 
#ifdef DEBUG
        if (isdebug) then
            write(idbg,*) '---------------------------------------------------------------'
            write(idbg,*) 'Iteration:',iter_heat
            write(idbg,*) '---------------------------------------------------------------'

            write(idbg,'(a15,2i6,1pe15.6e3)') 'idiag',ivol,idiag,aheat(idiag)
            do i1=istart,iend
              jvol=jaheat(i1)
              isym = isymheat(i1)
             write (idbg,'(i6,1pe15.6e3)') jvol, aheat(isym)
            end do
        end if
#endif    
    
      end do
      
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef OPENMP
    !$omp end parallel
#endif
      
!10 continue   

      return
      end subroutine jacheat
