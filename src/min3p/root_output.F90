!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/root_output.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> module: root_output
!>
!> written by: Danyang Su
!>
!> module description:
!>   module of root related output, e.g., root length density
!> Note:  
!>   
!> 

module root_output

    use gen
    use phys
    use writeversion   
    use file_unit, only : lun_get, lun_free
    use biol


#ifdef PETSC
    use petsc_mpi_common, only : petsc_mpi_finalize
#endif

    implicit none
    
contains

    !>
    !> output results of root related model
    !> 
    subroutine root_output_spatial 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i, iunit, l_sufx, ic, ig, ivol, ivol_l, nvars, ivar
      
      real*8 :: zout
      real*8, external :: zoutput
      
      character*3 :: suffix      
      
      if (.not. b_enable_output) then
        return
      end if
      
      iunit = lun_get()
!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 

      !rewind(icnv)           !Deprecated, use internal convert instead. DSU
      if (igstime.lt.10) then
        write(suffix,'(i1)') igstime
        l_sufx = 1
      elseif (igstime.ge.10.and.igstime.lt.100) then
        write(suffix,'(i2)') igstime
        l_sufx = 2
      elseif (igstime.ge.100.and.igstime.lt.1000) then
        write(suffix,'(i3)') igstime
        l_sufx = 3
      elseif (igstime.ge.1000) then
        if (rank == 0) then  
          write(ilog,'(/a)')'error in input file'
          write(ilog,'(a)')'max. number of output times exceeded'
          write(ilog,'(a)')'abnormal exit in routine root_output_spatial'
          close(ilog)
#ifdef DEBUG
          write(idbg,'(/a)') 'error in input file'
          write(idbg,'(a)') 'max. number of output times exceeded'
          write(idbg,'(a)') 'abnormal exit in routine root_output_spatial'
          close(idbg)
#endif
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

      if (b_output_binary) then
        !c add binary output  
      else
        open(iunit,file=prefix(:l_prfx)//'_'//                        &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsroot',  &
                  status='unknown',form='formatted')
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(/2a/72a)')'Spatial output for ',                  &
              'root related model', ('-',i=1,72)
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsroot'
      end if
      
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c  title and variables
      nvars = 4

          
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(iunit, "#")
      end if
        
!c  title and variables
      if (b_output_binary) then
          
      else
        write(iunit,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        
        write(iunit,'(100a)') 'variables = "x", "y", "z",',            &
                    ' "root length density (m/m^3)",',                 &
                    ' "reduction factor (-)",',                        &
                    ' "proportion of pot transpiration (-)",',         &
                    ' "wilting point saturation (-)",',                &
                    ' "field capacity saturation (-)",',               &
                    ' "optional saturation (-)",',                     &
                    ' "wilting point pressure (m)",',                  &
                    ' "field capacity pressure (m)",',                 &
                    ' "optional pressure (m)"'

        
        write(iunit,'(a,1pe10.3,1x,a,3(a,i5),a)')                      &
                    'zone t = "G_i, T = ',                             &
                    time_io,time_unit(:l_time_unit),'", i =',          &
                    itec,', j =',jtec,', k =',ktec,',  f=point'
      end if
      
      !c add file description
      if (rank == 0) then
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        root length density             ','m/m^3'
        write(ifls,'(2a)')                                             &
              '5        reduction factor                ','-'           
        write(ifls,'(2a)')                                             &
              '6        proportion of pot transpiration ','-'           
        write(ifls,'(2a)')                                             &
              '7        wilting point saturation        ','-'           
        write(ifls,'(2a)')                                             &
              '8        field capacity saturation       ','-'
        write(ifls,'(2a)')                                             &
              '9        optional saturation             ','-'
        write(ifls,'(2a)')                                             &
              '10       wilting point pressure          ','m'           
        write(ifls,'(2a)')                                             &
              '11       field capacity pressure         ','m'
        write(ifls,'(2a)')                                             &
              '12       optional pressure               ','m'
      end if
        
      
      do ivol = 1, nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
          cycle  
        end if
#endif
        ivol_l = ivol_l + 1
        
!c  assign depth coordinate in terms of depth or elevation
        zout = zoutput(depth_output,zg(ivol),elevmax)
        
        if (b_output_binary) then
            
        else
          write(iunit,ascii_fmt) xg(ivol),yg(ivol),zout,rld(ivol),     &
                                 alpha_vol(ivol),v_prop_vol(ivol),     &
                                 satwlim_vol(ivol),satwfield_vol(ivol),&
                                 satwopt_vol(ivol),h1lim_vol(ivol),    &
                                 h1field_vol(ivol),h1opt_vol(ivol)
        end if
          
      end do
      
!c  --------------------------------------------------------------------- 
!c  close files
!c  --------------------------------------------------------------------- 
      if(b_output_binary .and. b_output_mpiio_single) then 
          
      else
        close(iunit)
        call lun_free(iunit)
      end if
    
    end subroutine root_output_spatial
    
    !>
    !> output results of root related model
    !> 
    subroutine root_output_transient(ivol,iunit,ntstp,time_io)
 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      implicit none
      
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      !c passed variable
      integer :: ivol, iunit, ntstp
      real*8 :: time_io
      
      !c local variable
      integer :: ig, nvars
      
!c  title and variables
      nvars = 4
          
!c  version information
      if (b_writeversion_tecplot .and. .not. b_output_binary) then
        call writeversion2file(iunit, "#")
      end if        
      
      !c write header
      if (ntstp == 1) then
!c  title and variables
        if (b_output_binary) then
            
        else
          write(iunit,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
          
          write(iunit,'(100a)') 'variables = "time",',                 &
                      ' "root length density (m/m^3)",',               &
                      ' "reduction factor (-)",',                      &
                      ' "proportion of pot transpiration (-)",',       &
                      ' "wilting point saturation (-)",',              &
                      ' "field capacity saturation (-)",',             &
                      ' "optional saturation (-)",',                   &
                      ' "wilting point pressure (m)",',                &
                      ' "field capacity pressure (m)",',               &
                      ' "optional pressure (m)"'

          
          write(iunit,'(a,i8,1x,a,3(a,i5),a)')                         &
                       'zone t = "G_i, Volume = ', ivol, '", f=point'
        end if
      end if
      
      !c write data
      if (b_output_binary) then
          
      else
        write(iunit,ascii_fmt) time_io,rld(ivol),alpha_vol(ivol),      &
                               v_prop_vol(ivol),satwlim_vol(ivol),     &
                               satwfield_vol(ivol),satwopt_vol(ivol),  &
                               h1lim_vol(ivol),h1field_vol(ivol),      &
                               h1opt_vol(ivol)
      end if   
    
    end subroutine root_output_transient

end module root_output
