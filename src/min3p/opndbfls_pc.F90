!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/opndbfls_pc.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine opndbfls
!c -------------------
!c
!c open database files
!c
!c written by:      Uli Mayer - February 3, 97
!c
!c last modified:   -
!c
!c                  Danyang Su - March 14, 2014
!c                  dynamic file unit number
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   logical:
!c           --------
!c           search_database    = .true.  -> search database for      * +
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c           character:
!c           ----------
!c           redox_master       = 'o2(aq)'                            + -
!c                                'h2(aq)'
!c                                'e-1'
!c
!c common:   
!c gen.f:    integer*4:
!c           ----------
!c           icdbs              = unit number, database for           * +
!c                                             components
!c           igdbs              = unit number, database for gases     * +
!c           imdbs              = unit number, database for minerals  * +
!c           ipsp               = unit number, list of possible       * +
!c                                             secondary species
!c           irdbs              = unit number, database for redox     * +
!c                                             couples 
!c           isdbs              = unit number, database for sorbed    * +
!c                                             species
!c           ixdbs              = unit number, database for           * +
!c                                             secondary species in
!c                                             water phase
!c           l_dbs_dir          = length of string for database       + -
!c           l_prfx             = length of prefix of I/O files       + -
!c
!c           logical:
!c           --------
!c           full_path          = .true.  -> path for database        + -
!c                                           specified in problem
!c                                           specific input file
!c
!c           character:
!c           ----------
!c           dbs_dir            = database directory                  + -
!c           drive              = drive of program installation       + -
!c           prefix             = prefix name for all I/O files       + -
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine opndbfls(redox_master,search_database)
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif 
      use parm
      use gen
      use file_unit, only : lun_get
      use chem, only : issit
      use nobleGasIngrowth, only : ingdbs
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
   
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      logical :: search_database
      character*12 :: redox_master
      character*256 :: strfile

!c  specify unit numbers and open files
!c  database files for geochemistry

      !icdbs = 30
      !ixdbs = 31
      !imdbs = 32
      !irdbs = 33
      !igdbs = 34
      !isdbs = 35
      icdbs = lun_get()
      ixdbs = lun_get()
      imdbs = lun_get()
      irdbs = lun_get()
      igdbs = lun_get()
      isdbs = lun_get()
      ingdbs = lun_get()
      isitdbs = lun_get()
      idbs_bk = lun_get()

      if (full_path) then

        if(rank == 0 .and. b_enable_output) then    
          write(*,'(1x,a,1x,a)') "database:", trim(dbs_dir)
        end if 
      
        !>Note: In Linux, the path separator is /. In Windows, it is either / or \. 
        !>So just use forward slash. DSU.

        strfile = dbs_dir(:l_dbs_dir)//'/comp.dbs'
        open(icdbs,file=strfile,status='unknown',err=999)

        strfile = dbs_dir(:l_dbs_dir)//'/complex.dbs'
        open(ixdbs,file=strfile,status='unknown',err=999)

        strfile = dbs_dir(:l_dbs_dir)//'/mineral.dbs'
        open(imdbs,file=strfile,status='unknown',err=999)

        if (redox_master.eq.'o2(aq)') then
          strfile = dbs_dir(:l_dbs_dir)//'/redox.dbs'
          open(irdbs,file=strfile,status='unknown',err=999)
        elseif (redox_master.eq.'h2(aq)') then
          strfile = dbs_dir(:l_dbs_dir)//'/redoxh2.dbs'
          open(irdbs,file=strfile,status='unknown',err=999)
        elseif (redox_master.eq.'e-1') then
          strfile = dbs_dir(:l_dbs_dir)//'/redoxe.dbs'
          open(irdbs,file=strfile,status='unknown',err=999)
        end if
        strfile = dbs_dir(:l_dbs_dir)//'/gases.dbs'
        open(igdbs,file=strfile,status='unknown',err=999)

        strfile = dbs_dir(:l_dbs_dir)//'/sorption.dbs'
        open(isdbs,file=strfile,status='unknown',err=999)
        if (issit) then
          strfile = dbs_dir(:l_dbs_dir)//'/sit.dbs'
          open(isitdbs,file=strfile,status='unknown',err=999)
        end if

        strfile = dbs_dir(:l_dbs_dir)//'/noblegases.dbs'
        open(ingdbs,file=strfile,status='unknown',err=999)

      else

!cintellinux *** delete old options ***

        if (drive.eq.'u') then
          strfile = 'u:/min3p-v1.1/new/database/'//                   &
                    dbs_dir(:l_dbs_dir)//'/comp.dbs'
          open(icdbs,file=strfile,status='unknown',err=999)

          strfile = 'u:/min3p-v1.1/new/database/'//                   &
                    dbs_dir(:l_dbs_dir)//'/complex.dbs'
          open(ixdbs,file=strfile,status='unknown',err=999)

          strfile = 'u:/min3p-v1.1/new/database/'//                   &
                    dbs_dir(:l_dbs_dir)//'/mineral.dbs'
          open(imdbs,file=strfile,status='unknown',err=999)

          if (redox_master.eq.'o2(aq)') then
            strfile = 'u:/min3p-v1.1/new/database/'//                 &
                      dbs_dir(:l_dbs_dir)//'/redox.dbs'
            open(irdbs,file=strfile,status='unknown',err=999)
          elseif (redox_master.eq.'h2(aq)') then
            strfile = 'u:/min3p-v1.1/new/database/'//                 &
                      dbs_dir(:l_dbs_dir)//'/redoxh2.dbs'
            open(irdbs,file=strfile,status='unknown',err=999)
          elseif (redox_master.eq.'e-1') then
            strfile = 'u:/min3p-v1.1/new/database/'//                 &
                      dbs_dir(:l_dbs_dir)//'/redoxe.dbs'
            open(irdbs,file=strfile,status='unknown',err=999)
          end if

          strfile = 'u:/min3p-v1.1/new/database/'//                   &
                    dbs_dir(:l_dbs_dir)//'/gases.dbs'
          open(igdbs,file=strfile,status='unknown',err=999)

          strfile = 'u:/min3p-v1.1/new/database/'//                   &
                    dbs_dir(:l_dbs_dir)//'/sorption.dbs'
          open(isdbs,file=strfile,status='unknown',err=999)

        else

          strfile = drive//':/min3p/database/'//dbs_dir(:l_dbs_dir)// &
                    '/comp.dbs'
          open(icdbs,file=strfile,status='unknown',err=999)

          strfile = drive//':/min3p/database/'//dbs_dir(:l_dbs_dir)// &
               '/complex.dbs'
          open(ixdbs,file=strfile,status='unknown',err=999)

          strfile = drive//':/min3p/database/'//dbs_dir(:l_dbs_dir)// &
               '/mineral.dbs'
          open(imdbs,file=strfile,status='unknown',err=999)

          if (redox_master.eq.'o2(aq)') then
            strfile = drive//':/min3p/database/'//                    &
                      dbs_dir(:l_dbs_dir)//'/redox.dbs'
            open(irdbs,file=strfile,status='unknown',err=999)
          elseif (redox_master.eq.'h2(aq)') then
            strfile = drive//':/min3p/database/'//                    &
                      dbs_dir(:l_dbs_dir)//'/redoxh2.dbs'
            open(irdbs,file=strfile,status='unknown',err=999)
          end if     
          strfile = drive//':/min3p/database/'//dbs_dir(:l_dbs_dir)// &
                    '/gases.dbs'                                                
          open(igdbs,file=strfile,status='unknown',err=999)

          strfile = drive//':/min3p/database/'//dbs_dir(:l_dbs_dir)// &
               '/sorption.dbs'
          open(isdbs,file=strfile,status='unknown',err=999)

        end if

      end if

      if (search_database) then
        !ipsp = 36
        ipsp = lun_get()
        if (rank == 0 .and. b_enable_output) then
        open(ipsp,file=prefix(:l_prfx)//'_o.psp',status='unknown',     &
             form='formatted')
        end if
      end if

!c  open database to save all the used items. 
!c  This file can be used to reconstruct the database.
      if (rank == 0) then
        if (.not. use_dbs_bk) then
          open(idbs_bk,file=prefix(:l_prfx)//'_o.dbs',status='unknown',&
               form='formatted')
        end if
      end if

      return

999   continue
      if (rank == 0) then
        write(*,*) 'SIMULATION TERMINATED'
        write(*,*) 'error reading database file '//trim(adjustl(strfile))
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading database file '//trim(adjustl(strfile))
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop      
      end
