!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/updatedd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updatedd
!c -------------------
!c
!c update fluid pressure and check for convergence
!c (density dependent variably saturated flow)
!c compute underrelaxation factor for variably saturated flow
!c update solution vector and secondary variables - check for convergence
!c if relaxation factor is less than one, updates are scaled and the
!c convergence check is based on the scaled updates
!c
!c modified from Uli Mayer template
!c
!c written by:      Tom Henderson - August 23, 2002
!c
!c last modified:   Tom Henderson - March 25, 2003
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   - 
!c
!c common:   
!c gen.f:    real*8:
!c           ------- 
!c           relfacold          = underrelaxation factor              + +
!c                                (old time level)
!c           srelfac_vs         = user specified underrelaxation      + -
!c                                factor
!c           uvs(nn)            = update towards solution-vector      + +
!c           uvsnew(nn)         = solution vector (new time level)    + +
!c           uvslim             = user specified upper limit for      + -
!c                                magnitude of solution update        + -
!c           uvsmaxold          = maximum solution update             + +
!c                                (old time level)
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number, log file               + -
!c           nn                 = total number of control volumes     + -
!c           iter_vs            = iteration counter                   + -
!c                                (variably saturated flow)
!c           itsolv             = actual number of solver iterations
!c           idetail_vs         = solver information level            + -
!c
!c           logical:
!c           --------
!c           comp_relax         = .true.  -> compute underelaxation   + -
!c                                           factor
!c           not_converged      = .true.  -> continue Newton          + +
!c                                           iteration
!c           under_relax        = .true.  -> underrelaxation          + -
!c
!c dens.f:   real*8:
!c           -------
!c           pressure(nn)       = fluid pressure                      + - 
!c           density(nn)        = fluid density                       + -  
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c           r3                 = constant
!c           rhalf              = constant
!c           gacc               = gravitational acceleration [m s^-2]
!c           relfac             = underrelaxation factor
!c           sfac               = intermediate value for 
!c                                computation of relaxation factor
!c           ufac               = intermediate dampening factor
!c           uvsmax             = maximum solution update
!c           uvsabs             = absolute value of solution update
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           maxvol             = control volume with maximum 
!c                                solution update
!c           nexvol             = number of control volumes 
!c                                exceeding update tolerance
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine updatedd 

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens
      use phys
#ifdef USG
      use usg_mesh_data, only : num_cells, cells, num_nodes_per_cell
#endif
#ifdef OPENMP
      use omp_lib 
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: i1, izn, maxvol
      real*8 :: relfac, sfac, ufac, uvsabs, porosity_flow, dummy1, dummy2

      real*8 :: uvsmax, uvs_updt_max, uvs_updt_delta
      real*8 :: swr_loc, aentry_loc, spalpha_loc, spbeta_loc,          &
                expn_loc, spgamma_loc
      integer*4 :: nexvol, nexvol2

#ifdef PETSC
      DOUBLE PRECISION :: mpireduce_in(2), mpireduce_out(2)
      real*8 :: uvsmax_gbl
      integer*4 :: nexvol_gbl, mpireduce_irank
      PetscErrorCode :: ierrcode
#endif

      real*8, parameter :: rhalf = 0.5d0,r0 = 0.0d0,r1 = 1.0d0,        &
                           r3 = 3.0d0

      integer :: ivol, tid

#ifdef USG
      integer :: icell
      real*8 :: uvsnew_cell, sanew_cell, sgnew_cell, snnew_cell

#endif

      relfac = r0
      
      if (under_relax) then          !underrelaxation

        if (comp_relax .or. under_relax_range_vs) then
          uvsmax    = r0
          
#ifdef OPENMP
          maxval_omp = uvsmax
#endif

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_updatedd_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, tid)                                              
    !$omp do schedule(static)
#endif   

#ifdef OPENMP 
          do ivol = 1,nngl
            tid = omp_get_thread_num()+1  

            if (dabs(uvs(ivol)).gt.dabs(maxval_omp(tid))) then
                maxval_omp(tid) = uvs(ivol)
            end if
          end do
#else
          do ivol = 1,nngl  
            if (dabs(uvs(ivol)).gt.dabs(uvsmax)) then
                uvsmax = uvs(ivol)
            end if
          end do
#endif

#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

#ifdef OPENMP
          i1 = maxloc(abs(maxval_omp), 1)
          uvsmax = maxval_omp(i1)       
#endif

#ifdef PETSC
          call MPI_Allreduce(uvsmax, uvsmax_gbl,1,MPI_REAL8,MPI_MAX,   &
                             Petsc_Comm_World,ierrcode)
          CHKERRQ(ierrcode)
          uvsmax = uvsmax_gbl
#endif
        end if

        if (comp_relax) then         !compute underelaxation factor

!c  find maximum update to calculate relaxation factor
!c  according to Cooley's method (1983)

!c  compute underrelaxation factor

          if (iter_vs.eq.1) then                 !first iteration

            relfac = r1

          else                                   !following iterations

            sfac = uvsmax/(uvsmaxold*relfacold)            !step 1

            if (sfac.lt.-r1) then                          !step 2
              relfac = rhalf/dabs(sfac)
            else
              relfac = (r3 + sfac)/(r3 + dabs(sfac))
            endif

          end if

!c  limit to maximum allowed update

          ufac = relfac*dabs(uvsmax)/uvslim                !step 3
          if (ufac.gt.r1) then
            relfac = relfac/ufac
          end if

!c  assign old max. update and relaxation factor for next time step

          uvsmaxold = uvsmax
          relfacold = relfac

        else                      !user specified underelaxtion factor

          if (under_relax_range_vs) then
            if (uvsmax >= srelrange_vs_min .and. uvsmax <= srelrange_vs_max) then
              relfac = srelfac_vs
            else
              relfac = r1
            end if
          else
            relfac = srelfac_vs
          end if

        end if       !comp_relax
      end if         !under_relax

!c  check size of updates (relaxed/un-relaxed) to determine convergence

      uvsmax  = r0
      maxvol = 0
      nexvol = 0
      nexvol2 = 0

#ifdef OPENMP
      maxval_omp = uvsmax      
#endif 

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_updatedd_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (                                                   &
#ifdef USG
    !$omp icell, uvsnew_cell, sanew_cell, sgnew_cell, snnew_cell,     &
#endif
    !$omp ivol, izn, tid, uvsabs, dummy1, dummy2,                     &
    !$omp swr_loc, aentry_loc, spalpha_loc,                           &
    !$omp spbeta_loc, expn_loc, spgamma_loc)                          &
    !$omp reduction(+:nexvol,nexvol2)
#endif

#ifdef OPENMP
    !$omp do schedule(static)
#endif 
      do ivol = 1,nngl   
!#ifdef PETSC 
!        if(node_idx_lg2l(ivol) < 0) then
!            cycle
!        end if
!#endif
          
#ifdef OPENMP    
        tid = omp_get_thread_num()+1
#else
        tid = 1
#endif 

        if (under_relax) then                    !underrelaxation
          uvs(ivol) = relfac*uvs(ivol)
        end if


        uvsnew(ivol) = uvsnew(ivol) + uvs(ivol)    !update primary unknown
       
        uvsabs  = dabs(uvs(ivol))
        
#ifdef OPENMP
        if (uvsabs>maxval_omp(tid)) then
          maxval_omp(tid) = uvsabs               !max solution update
          maxvol_omp(tid) = ivol                 !location of max update
        endif
#else
        if (uvsabs>uvsmax) then
          uvsmax = uvsabs                        !max solution update
          maxvol = ivol                          !location of max update
        endif
#endif
        
        if (uvsabs>tol_vs) then                  !number of volumes
#ifdef PETSC
          if(node_idx_lg2l(ivol) > 0) then
            nexvol = nexvol + 1
          end if
#else
          nexvol = nexvol + 1                    !exceeding convergence
#endif
        end if                                   !tolerance
        
        if (tran_steady_flow) then
          uvs_updt_max = max(abs(uvsnew(ivol)),abs(uvsold(ivol)))
          if (uvs_updt_max > r0) then
            uvs_updt_delta = abs(uvsnew(ivol)-uvsold(ivol))/delt
            if (uvs_updt_delta > atol_tran_steady_flow .and.           &
                uvs_updt_delta/uvs_updt_max > rtol_tran_steady_flow) then
#ifdef PETSC
              if(node_idx_lg2l(ivol) > 0) then
                nexvol2 = nexvol2 + 1
              end if
#else
              nexvol2 = nexvol2 + 1                    !exceeding convergence
#endif
            end if
          end if
        end if

!cprovi----------------------------------------------------------------------------------
!cprovi Update the porosity as a function of Pa
!cprovi----------------------------------------------------------------------------------        
        if (modify_por(ivol)) then
            pornew(ivol)=porosity_flow(porold(ivol),uvsnew(ivol),     &
                                       uvsold(ivol),stor(ivol),       &
                                       por_stress_dt(ivol),           &
                                       por_init(ivol),facpormin)   
        end if 
!cprovi----------------------------------------------------------------------------------
!cprovi Update the soil properties as a function of water pressure
!cprovi Only of variable saturated medium 
!cprovi----------------------------------------------------------------------------------       
        if (variably_saturated .and. .not.b_disable_sat_updt) then
          izn = mpropvs(ivol)
          if (is_cell_based_relp) then
            if (soilhydrfunc_field) then
              call soilprdd(uvsnew(ivol),sanew(ivol),sgnew(ivol),      &
                            dummy1,dummy2,snnew(ivol),                 &
                            swr_vol(ivol),aentry_vol(ivol),            &
                            spalpha_vol(ivol),spbeta_vol(ivol),        &
                            expn_vol(ivol),spgamma_vol(ivol),          &
                            napl_permeability,napl_kfunction,sgr,      &
                            isovendrying(izn),beta_ovendry(izn),       &
                            hm_ovendry(izn),w0_ovendry(izn),           &
                            cp0_ovendry(izn),ref_dens,gacc)
            else
              call soilprdd(uvsnew(ivol),sanew(ivol),sgnew(ivol),      &
                            dummy1,dummy2,snnew(ivol),                 &
                            swr(izn),aentry(izn),                      &
                            spalpha(izn),spbeta(izn),                  &
                            expn(izn),spgamma(izn),                    &
                            napl_permeability,napl_kfunction,sgr,      &
                            isovendrying(izn),beta_ovendry(izn),       &
                            hm_ovendry(izn),w0_ovendry(izn),           &
                            cp0_ovendry(izn),ref_dens,gacc)
            end if
          else
            if (soilhydrfunc_field) then
              call soilprdd(uvsnew(ivol),sanew(ivol),sgnew(ivol),      &
                            relperm(ivol),relpermg(ivol),snnew(ivol),  &
                            swr_vol(ivol),aentry_vol(ivol),            &
                            spalpha_vol(ivol),spbeta_vol(ivol),        &
                            expn_vol(ivol),spgamma_vol(ivol),          &
                            napl_permeability,napl_kfunction,sgr,      &
                            isovendrying(izn),beta_ovendry(izn),       &
                            hm_ovendry(izn),w0_ovendry(izn),           &
                            cp0_ovendry(izn),ref_dens,gacc)
            else
              call soilprdd(uvsnew(ivol),sanew(ivol),sgnew(ivol),      &
                            relperm(ivol),relpermg(ivol),snnew(ivol),  &
                            swr(izn),aentry(izn),                      &
                            spalpha(izn),spbeta(izn),                  &
                            expn(izn),spgamma(izn),                    &
                            napl_permeability,napl_kfunction,sgr,      &
                            isovendrying(izn),beta_ovendry(izn),       &
                            hm_ovendry(izn),w0_ovendry(izn),           &
                            cp0_ovendry(izn),ref_dens,gacc)
            end if
          end if
            
        end if    
        
      end do        !loop over control volumes
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef USG
      if (discretization_type > 0 .and. is_cell_based_relp .and.       &
          variably_saturated) then
#ifdef OPENMP
    !$omp do schedule(static)
#endif
        do icell = 1, num_cells
          izn = mpropvs_cell(icell)
          uvsnew_cell = 0.0d0
          sanew_cell = 0.0d0
          sgnew_cell = 0.0d0
          snnew_cell = 0.0d0

          if (soilhydrfunc_field) then
            swr_loc = 0.0d0
            aentry_loc = 0.0d0
            spalpha_loc = 0.0d0
            spbeta_loc = 0.0d0
            expn_loc = 0.0d0
            spgamma_loc = 0.0d0
          end if

          do i1 = 1, num_nodes_per_cell
            ivol = cells(i1,icell)
            uvsnew_cell = uvsnew_cell + uvsnew(ivol)
            sanew_cell = sanew_cell + sanew(ivol)
            sgnew_cell = sgnew_cell + sgnew(ivol)
            snnew_cell = snnew_cell + snnew(ivol)

            if (soilhydrfunc_field) then
              swr_loc = swr_loc + swr_vol(ivol)
              aentry_loc = aentry_loc + aentry_vol(ivol)
              spalpha_loc = spalpha_loc + spalpha_vol(ivol)
              spbeta_loc = spbeta_loc + spbeta_vol(ivol)
              expn_loc = expn_loc + expn_vol(ivol)
              spgamma_loc = spgamma_loc + spgamma_vol(ivol)
            end if
          end do
          uvsnew_cell = uvsnew_cell/num_nodes_per_cell
          sanew_cell = sanew_cell/num_nodes_per_cell
          sgnew_cell = sgnew_cell/num_nodes_per_cell
          snnew_cell = snnew_cell/num_nodes_per_cell

          if (soilhydrfunc_field) then
            swr_loc = swr_loc/num_nodes_per_cell
            aentry_loc = aentry_loc/num_nodes_per_cell
            spalpha_loc = spalpha_loc/num_nodes_per_cell
            spbeta_loc = spbeta_loc/num_nodes_per_cell
            expn_loc = expn_loc/num_nodes_per_cell
            spgamma_loc = spgamma_loc/num_nodes_per_cell
          else
            swr_loc = swr(izn)
            aentry_loc = aentry(izn)
            spalpha_loc = spalpha(izn)
            spbeta_loc = spbeta(izn)
            expn_loc = expn(izn)
            spgamma_loc = spgamma(izn)
          end if

          if (.not. b_disable_sat_updt) then
            call soilprdd(uvsnew_cell,sanew_cell,sgnew_cell,           &
                          relperm(icell),relpermg(icell),snnew_cell,   &
                          swr_loc,aentry_loc,spalpha_loc,              &
                          spbeta_loc,expn_loc,spgamma_loc,             &
                          napl_permeability,napl_kfunction,sgr,        &
                          isovendrying(izn),beta_ovendry(izn),         &
                          hm_ovendry(izn),w0_ovendry(izn),             &
                          cp0_ovendry(izn),ref_dens,gacc)
          end if
        end do
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp barrier
#endif
      end if
#endif

#ifdef OPENMP
    !$omp end parallel
#endif

#ifdef PETSC
      call MPI_Allreduce(nexvol, nexvol_gbl,1,MPI_INTEGER4,MPI_SUM,    &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nexvol = nexvol_gbl

      call MPI_Allreduce(nexvol2, nexvol_gbl,1,MPI_INTEGER4,MPI_SUM,   &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      nexvol2 = nexvol_gbl
#endif

#ifdef OPENMP
      i1 = maxloc(maxval_omp, 1)
      uvsmax = maxval_omp(i1)
      maxvol = maxvol_omp(i1)
#endif

#ifdef PETSC
      mpireduce_in(1) = uvsmax      !returns the reduced value
      mpireduce_in(2) = rank        !returns the rank of process that owns it
      call MPI_Allreduce(mpireduce_in, mpireduce_out, 1,               &
                         MPI_2DOUBLE_PRECISION,MPI_MAXLOC,             &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      uvsmax = mpireduce_out(1)
      mpireduce_irank = int(mpireduce_out(2))
      
      call MPI_BCAST(maxvol, 1, MPI_INTEGER4, mpireduce_irank,         &
                     Petsc_Comm_World, ierrcode) 
      CHKERRQ(ierrcode)
#endif

      if (nexvol2 == 0) then
        tran_steady_flow_converged = .true.
      else
        tran_steady_flow_converged = .false.
      end if

!c  write convergence history to screen or log file

      if (rank == 0 .and. b_enable_output .and. idetail_vs.gt.0) then

        if(iter_vs == 1) then
          write(*,*)'------------------------------------------------'
          write(*,'(a)')                                               &
                ' Newton Iteration Convergence Summary For Flow:'
          write(*,*)'------------------------------------------------'
          write(*,'(a)')                                               &
                ' Newton       maximum      maximum     solver'

          write(ilog,*)'------------------------------------------------'
          write(ilog,'(a)')                                            &
                ' Newton Iteration Convergence Summary For Flow:'
          write(ilog,*)'------------------------------------------------'
          write(ilog,'(a)')                                            &
                ' Newton       maximum      maximum     solver'

#ifdef PETSC
          if (tran_steady_flow) then
            write(*,'(2a)')                                            &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank    nexvol2'
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank    nexvol2'
          else
            write(*,'(2a)')                                            &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank'
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank'
          end if
#else
          if (tran_steady_flow) then
            write(*,'(2a)')                                            &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol    nexvol2'
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol    nexvol2'
          else
            write(*,'(2a)')                                            &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol'
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol'
          end if
#endif
        end if

#ifdef PETSC
        if (tran_steady_flow) then
          write(*,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x),i6,2x,i9)')      &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,             &
                mpireduce_irank,nexvol2
        else
          write(*,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x),i6)')            &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,             &
                mpireduce_irank
        end if
        
        if(iter_vs > 1 .and. idetail_vs.eq.2) then          
          write(ilog,*)'------------------------------------------------'
          write(ilog,'(a)')                                            &
                ' Newton Iteration Convergence Summary For Flow:'
          write(ilog,*)'------------------------------------------------'
          write(ilog,'(2a)')                                           &
                ' Newton       maximum      maximum    ',              &
                ' solver'
          if (tran_steady_flow) then
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank    nexvol2'
          else
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol     rank'
          end if
        end if
        
        if (tran_steady_flow) then
          write(ilog,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x),i6,2x,i9)')   &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,             &
                mpireduce_irank,nexvol2
        else
          write(ilog,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x),i6)')         &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,             &
                mpireduce_irank
        end if
#else
        if (tran_steady_flow) then
          write(*,'(i6,6x,1pe11.4,2x,1pe11.4,4(i9,2x))')               &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,nexvol2
        else
          write(*,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x))')               &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol
        end if
        
        if(iter_vs > 1 .and. idetail_vs.eq.2) then
          write(ilog,*)'------------------------------------------------'
          write(ilog,'(a)')                                            &
                ' Newton Iteration Convergence Summary For Flow:'
          write(ilog,*)'------------------------------------------------'
          write(ilog,'(2a)')                                           &
                ' Newton       maximum      maximum    ',              &
                ' solver'
          if (tran_steady_flow) then
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol    nexvol2'
          else
            write(ilog,'(2a)')                                         &
                  ' iteration    update(Pa)   residual   ',            &
                  ' iterations  maxvol      nexvol'
          end if
        end if
        
        if (tran_steady_flow) then
          write(ilog,'(i6,6x,1pe11.4,2x,1pe11.4,4(i9,2x))')            &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol,nexvol2
        else
          write(ilog,'(i6,6x,1pe11.4,2x,1pe11.4,3(i9,2x))')            &
                iter_vs,uvsmax,rnorm,itsolv,maxvol,nexvol
        end if
#endif

      end if

!cdsu  ------------------------------------------------------------------------
!cdsu  save maximum update value in newton iteration to check if iteration is diverged
!cdsu  ------------------------------------------------------------------------
      if (b_check_div_vs) then
        i1 = mod(iter_vs,5)
        if (i1 == 0) then
          i1 = 5
        end if
        div_vs(i1) = abs(uvsmax)
      end if

!c  final convergence check

      if (uvsmax.lt.tol_vs) then
        not_converged = .false.
      end if

      return
      end
