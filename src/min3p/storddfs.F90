!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/storddfs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c real*8 function storddfs
!c ------------------------
!c
!c last modified:   
!c                  Danyang Su - Add specific storage term and apply chain 
!c                               rule to porosity and temperature derivative.
!c                               The previous formula is buggy.
!c note: 
!c      This part is a bit weird since it is also used in variably saturated
!c      flow when energybal balance is activated. The function is very 
!c      similar to stordd. Need further optimization for energy balance
!c      related code under variably saturated condition.
!c        
!c
!c compute mass storage term for fully saturated 
!c density dependent conditions
!c ----------------------------------------------------------------------
 
      real*8 function storddfs(delt1,delt2,pornew,porold,              &
                               satnew,satold,densnew,densold,          &
                               densnewc,densoldc,tdsnew,tdsold,        &
                               tempnew,tempold,drhodc,drhodT,          &
                               pwnew,pwold,spstor,new_stor_deri,       &
                               coupled_porpress,coupled_drhodt,        &
                               ispitzerdens,isnonlindens,              &
                               cdens1,cdens2,cdens3,cdens4)            

      implicit none                                                    
                                                                       
      real*8, intent(in):: delt1,delt2,pornew,porold,                  &
                           satnew,satold,densnew,densold,              &
                           densnewc,densoldc,tdsnew,tdsold,            &
                           drhodc,drhodT,tempnew,tempold,              &
                           pwnew,pwold,spstor,                         &
                           cdens1,cdens2,cdens3,cdens4
     
      logical, intent(in) :: new_stor_deri,coupled_porpress,           &
                             coupled_drhodt,ispitzerdens,isnonlindens
     
      real*8   term1,term2,term3,term4,temp1,temp2
      
      real*8, parameter   :: r0 = 0.0d0, r1000=1.0d3, rkelvin=273.15d0
     
!cprovi-----------------------------------------------------------
!cprovi 
!cprovi-----------------------------------------------------------        
      
      
      !cdsu change over specific storage
      !cdsu old code
      !term1=densnew*satnew*(pornew-porold)/delt1
      !cdsu new code  
      !cdsu chain rule: d(porosity)/d(t) = d(porosity)/d(pressure)*d(pressure)/d(t)
      !cdsu decoupled scenario when porosity is modified but pressure is not modified accordingly,
      !cdsu chain rule in derivative cannot be used 
      if (new_stor_deri .and. coupled_porpress) then
        term1 = densnew*satnew*spstor*(pwnew-pwold)/delt1
      else
        term1=densnew*satnew*(pornew-porold)/delt1
      end if
     
      !cdsu change over concentration (TDS)
      if (new_stor_deri) then
        if (ispitzerdens) then 
          term2=pornew*satnew*(densnewc-densoldc)/delt2
        else
          term2=pornew*satnew*drhodc*(tdsnew-tdsold)/delt2
        end if
      else
        term2=pornew*satnew*(densnew-densold)/delt2
      end if

      !cdsu change over temperature
      if (isnonlindens) then
        temp1 = tempold + rkelvin
        temp2 = tempnew + rkelvin
        term3 = cdens1+r1000*temp1*(cdens2+temp1*(cdens3-temp1*cdens4))
        term3 = cdens1+r1000*temp2*(cdens2+temp2*(cdens3-temp2*cdens4))-term3
      !c need further check here, not consistent with stordd  
      else if (new_stor_deri .and. coupled_drhodt) then
        term3 = drhodT*(tempnew-tempold)
      else
        term3 = drhodT*(tempnew-tempold)
      end if  
      
      term3 = pornew*satnew*term3/delt1   
      
      !cdsu density change over saturation
      !cdsu keep this term since it is also used in unsaturated condition.
      !cdsu a bit weird here.
      term4 = pornew*densnew*(satnew-satold)/delt1
      
      storddfs = term1 + term2 + term3 + term4

      return
      end
      
      
