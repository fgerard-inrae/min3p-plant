!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/mem_rt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine mem_rt
!c -----------------
!c
!c allocate memory for reactive transport simulation
!c
!c written by:      Uli Mayer - Januray 6, 2000
!c
!c last modified:   Tom Henderson - June 1, 2006
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c bbls.f    real*8
!c           -------
!c           sanew_b(nn)          = water saturation prior to reactran and gasbub
!c                                    for convergence check of outer bubble loop
!c             c_update(nc,nn)      = component concentration at previous inner
!c                                    bubble iteration. 
!c gen.f:    real*8:
!c           -------
!c           c(nc,nngl)           = concentrations of free species      * +
!c                                - old time level [moles/l water]
!c           cnew(nc,nngl)        = concentrations of free species      * +
!c                                - new time level [moles/l water]
!c           cec_g(nngl)          = cation exchange capacity [meq/100g] * +
!c                                - global system
!c           cec_fraction_g(nsites_ion, nngl)                           * +
!c                              = cec fraction of multisite ion-
!c                                exchange sites - blobal system
!c           totcold(n,nngl)      = total aqueous component             * +
!c                                concentrations
!c                                - old time level [moles/l water]
!c           totcnew(n,nngl)      = total aqueous component             * +
!c                                concentrations
!c                                - new time level [moles/l water]
!c           totgold(nc,nngl)      = total gaseous component            * +
!c                                concentrations
!c                                - old time level [moles/l air]]
!c           totgnew(nc,nngl)      = total gaseous component            * +
!c                                concentrations
!c                                - new time level [moles/l air]
!c           totsold(n,nngl)      = total sorbed component              * +
!c                                concentrations
!c                                - old time level [moles/l bulk]
!c           totsold_ion(n,nngl)  = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsold_surf(n,nngl) = total sorbed component              * +
!c                                concentrations 
!c                                - old time level [moles/l bulk]
!c                                (surface-complex)
!c           totsnew(n,nngl)      = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c           totsnew_ion(n,nngl)  = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (ion-exchange)
!c           totsnew_surf(n,nngl) = total sorbed component              * +
!c                                concentrations
!c                                - new time level [moles/l bulk]
!c                                (surface-complex)
!c           cmold(nm,nngl)       = mineral concentrations              * +
!c                                - old time level [moles/l bulk]
!c           cmnew(nm,nngl)       = mineral concentrations              * +
!c                                - new time level [moles/l bulk]
!c           gold(ng,nngl)        = gas concentrations                  * +
!c                                - old time level [moles/l air]
!c           gnew(ng,nngl)        = gas concentrations                  * +
!c                                - new time level [moles/l air]
!c           cx(nx,nngl)          = concentrations of secondary aqueous * +
!c                                species [moles/l water]
!c           gamma(nc+nx,nngl)    = activity coefficients of aqueous    * +
!c                                species [-]
!c           sionnew(nngl)        = ionic strength of solution          * +
!c           gammaold(nc+nx,nngl) = activity coefficients of aqueous    * +
!c                                species [-] - old time level
!c                                - new time level
!c           sionold(nngl)        = ionic strength of solution          * +
!c                                - old time level
!c           phi(nm,nngl)         = volume fractions of minerals        * +
!c           phiold(nm,nngl)      = volume fractions of minerals        * +
!c                                - old time level
!c           phi_init(nm,nngl)    = volume fractions of minerals        * +
!c                                - initial condition
!c           phinucthrd(nm,nngl) = volume fractions of mineral for     * +
!c                                nucleation threshold
!c                                - initial condition
!c           area(nm,nngl)        = mineral reactivity term             * +
!c                                (global system)
!c           area_init(nm,nngl)   = initial mineral reactivity term     * +
!c                                (global system)
!c           cflux(ncon,n)      = interfacial mass fluxes             * +
!c                                (aqueous phase)
!c           cstor(n)           = storage term (aqueous phase)        * +
!c           gflux(ncon,n)      = interfacial mass fluxes
!c                                (gaseous phase)
!c           gstor(n)           = storage term (gaseous phase)        * +
!c           dtotcflux(n)       = derivatives of total mass fluxes    * +
!c                                (aqueous phase)
!c           dtotgflux(n)       = derivatives of total mass fluxes    * +
!c                                (gaseous phase)
!c           ratemdp(nm,nngl)     = absolute dissolution-precipitation  * +
!c                                rates of minerals
!c           totcflux(n)        = total mass fluxes (aqueous phase)   * +
!c           totgflux(n)        = total mass fluxes (gaseous phase)   * +
!c           totmdp(n,nngl)       = total source/sink term towards      * +
!c                                total aqueous component
!c                                concentrations due to mineral
!c                                dissolution-precipitation reactions
!c           cfluxin(n)         = mass gain due to inflow in water    * +
!c                                phase in terms of total aqueous
!c                                component concentrations
!c           cfluxout(n)        = mass loss due to outflow in water   * +
!c                                phase in terms of total aqueous
!c                                component concentrations
!c           gfluxtbdy(ng)      = mass flux across boundary           * +
!c                                (gaseous phase)
!c           gfluxin(n)         = mass gain due to inflow in air      * +
!c                                phase in terms of total gaseous
!c                                component concentrations
!c           gfluxout(n)        = mass loss due to outflow in air     * +
!c                                phase in terms of total gaseous
!c                                component concentrations
!c           cstordiff(n+nm)    = change in storage in terms of total * +
!c                                aqueous component concentrations
!c           gdegas(n)          = mass loss from aqueous phase due to * +
!c                                degassing                        
!c           gstordiff(n)       = change in storage in terms of total * +
!c                                gaseous component concentrations
!c           ordiff(n)          = global source-sink term due to      * +
!c                                oxidation/reduction reactions
!c           dpdiff(n+nm)       = source-sink term due to phase       * +
!c                                exchange with solid phase
!c                                (minerals)
!c           dpdiffp(ndr*nm)    = individual source-sink terms due    * +
!c                                to parallel dissolution-
!c                                precipitation reactions
!c           gdiff(n+ng)        = source-sink term due to phase       * +
!c                                exchange with air phase
!c           amass(n)           = total adsorbed mass                 * +
!c                                non-competitive sorption [moles]
!c           tmass(n)           = total mass in aqueous and gaseous   * +
!c                                phase in terms of total
!c                                component concentrations [moles]
!c           cmass(n)           = total mass in aqueous phase in      * +
!c                                terms of total aqueous component
!c                                concentrations [moles]
!c           gmass(ng)          = total mass in gaseous phase in      * +
!c                                terms of total gaseous component
!c                                concentrations [moles]
!c           cmmass(nm)         = total mineral mass in system        * +
!c                                [moles]
!c           csbmass(nsb)       = total sorbed mass in system         * +
!c                                [moles]
!c           csbmass_ion(nsb_ion) = total sorbed mass in system       * +
!c                                  [moles] (ion-exchange)
!c           csbmass_surf(nsb_surf) = total sorbed mass in system     * +
!c                                  [moles] (surface-complex)
!c           csbmass_c(nsites)  = total sorbed mass in system         * +
!c                                - non-aqueous components [moles]
!c           cculabsbal(n)      = accumulative absolute mass balance  * +
!c                                error for dissolved species
!c                                [moles/elapsed time]
!c           cculrelbal(n)      = accumulative relative mass balance  * +
!c                                error for dissolved species [%]
!c           gculabsbal(ng)     = accumulative absolute mass balance  * +
!c                                error for gaseous species
!c                                [moles/elapsed time]
!c           gculrelbal(ng)     = accumulative relative mass balance  * +
!c                                error for gaseous species [%]
!c           cmculabsbal(nm)    = accumulative absolute mass balance  * +
!c                                error for minerals
!c                                [moles/elapsed time]
!c           cmculrelbal(nm)    = accumulative relative mass balance  * +
!c                                error for minerals [%]
!c           sbdiff(n)          = source-sink term due to phase       * +
!c                                exchange with sorbed phase
!c           rateaqtot(naq)     = total rate of intra-aqueous kinetic * +
!c                                reaction in solution domain
!c                                [moles/day]
!c           contaqtot(naq)     = contribution of intra-aqueous       * +
!c                                kinetic reactions to mass balance
!c                                [moles/elapsed time]
!c           contmintot(nm)     = contribution of dissolution-        * +
!c                                precipitation reactions to mass
!c                                balance [moles/elapsed time]
!c           totdpdiffp(ndr*nm) = individual contribution of parallel * +
!c                                reaction pathways of dissolution-
!c                                precipitation reactions to mass
!c                                balance [moles/elapsed time]
!c           totcfluxin(nc)     = total mass gain due to inflow in    * +
!c                                auqueous phase in terms of total
!c                                aqueous component concentrations
!c           totcfluxout(nc)    = total mass loss due to inflow in    * +
!c                                aqueous phase in terms of total
!c                                aqueous component concentrations
!c           totcstordiff(nc)   = total change in storage in          * +
!c                                aqueous phase in terms of total
!c                                aqueous component concentrations
!c           totordiff(nc)      = total source/sink to total          * +
!c                                aqueous component concentrations
!c                                due to oxidation/reduction
!c                                reactions
!c           totintradiff(nc)   = total source/sink to total          * +
!c                                aqueous component concentrations
!c                                due to intra-aqueous kinetic
!c                                reactions
!c           totdpdiff(nc)      = total source/sink to total          * +
!c                                aqueous component concentrations
!c                                due to dissolution-precipitation
!c                                reactions
!c           totgdegas(nc)      = total mass los from aqueous         * +
!c                                phase due to degassing
!c           totgdiff(nc)       = total source/sink to total          * +
!c                                aqueous component concentrations
!c                                due to gas dissolution-esolution
!c                                reactions
!c           totgfluxin(nc)     = total mass gain due to inflow in    * +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totgfluxout(nc)    = total mass loss due to inflow in    * +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totgstordiff(nc)   = total change in storage in          * +
!c                                gas phase in terms of total
!c                                gaseous component concentrations
!c           totsbdiff(nc)      = total source/sink to total          * +
!c                                aqueous component concentrations
!c                                due to sorption or ion-exchange
!c                                reactions
!c           distcoff_rt(nc,nngl) = sorption distribution coefficient   * +
!c                                [L H_2O/L bulk] 
!c                                - reactive transport 
!c           totaold(n,nngl)      = total sorbed component              * + 
!c                                concentrations
!c                                non-competitive sorption 
!c                                - old time level [moles/l bulk]
!c           totanew(n,nngl)      = total aqueous component             * +
!c                                concentrations
!c                                non-competitive sorption
!c                                - new time level [moles/l bulk]
!c           astor(n)           = storage term (non-competitive       * +
!c                                sorption)
!c added for gas transport:
!c
!c           dens_g(nn)         = gas density                         * +
!c           gafluxin(n)        = advective gas in-flux               * +
!c           gafluxout(n)       = advective gas out-flux              * + 
!c           gmfrac(ng,nn)      = molar gas fractions                 * +
!c           mdens_g(nn)        = molar gas density                   * +
!c           totgaflux(n)       = total advective gas flux            * +
!c           totgafluxin(nc)    = total advective gas out-flux        * + 
!c           totgafluxout(nc)   = total advective gas in-flux         * +
!c           totgmfrac(n,nn)    = total molar gas fraction            * +
!c           visc_g(nn)         = gas viscosity                       * +
!c
!c ------------------------
!c
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number, logbook file           + -
!c           mpropc(nngl)         = pointer array for allocation of     * +
!c                                chemical material properties
!c           n                  = number of components excluding h2o  + -
!c                                equals number of unknowns per
!c                                control volume
!c           i2up(nngl)           = pointer array to second upstream    * +
!c                                point
!c added for gas transport:
!c
!c           dens_g(nngl)         = gas density                         * +
!c           gafluxin(n)        = advective gas in-flux               * +
!c           gafluxout(n)       = advective gas out-flux              * + 
!c           gmfrac(ng,nngl)      = molar gas fractions                 * +
!c           mdens_g(nngl)        = molar gas density                   * +
!c           totgaflux(n)       = total advective gas flux            * +
!c           totgafluxin(nc)    = total advective gas out-flux        * + 
!c           totgafluxout(nc)   = total advective gas in-flux         * +
!c           totgmfrac(n,nngl)    = total molar gas fraction            * +
!c           visc_g(nngl)         = gas viscosity 
!c
!c chem.f:   integer*4:
!c           ----------
!c           nc                 = number of components including h2o  + -
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nx                 = number of aqueous complexes         + -
!c
!c local:    integer*4:
!c           ----------
!c           ierr               = 0 -> memory allocation successful
!c
!c external: checkerr  = check for error during memory allocation
!c
!c---------------------------------------------------------------------- 
!c WARNING
!c---------------------------------------------------------------------- 
!c All allocated variables are initialized to some value. This depends  
!c of its type:
!c 
!c real*8      => 0.0d0
!c integer     => 0 
!c character   => ' '    
!c logical     => .false. 
!c 
!c Sergio Andres Bea Jofre (2009)
!c
!c ----------------------------------------------------------------------
  
      subroutine mem_rt
 
      use parm
      use gen
      use chem
      use phys
      use bbls
      use multidiff
      use geometry_definition
      use nobleGasIngrowth
      
      implicit none
      
      integer :: ierr
 
      external checkerr
      
      logical iserror

!c  allocate memory for reactive transport simulation

!c  main variables - reactive transport
      allocate (c(nc,nngl), stat = ierr)
      c=0.0d0
      call checkerr(ierr,'c',ilog)
      call memory_monitor(sizeof(c),'c',.true.)

      allocate (cnew(nc,nngl), stat = ierr)
      cnew=0.0d0
      call checkerr(ierr,'cnew',ilog)
      call memory_monitor(sizeof(cnew),'cnew',.true.)

      allocate (cec_g(nngl), stat = ierr)
      cec_g=0.0d0
      call checkerr(ierr,'cec_g',ilog)
      call memory_monitor(sizeof(cec_g),'cec_g',.true.)

      allocate (cec_fraction_g(nsites_ion, nngl), stat = ierr)
      cec_fraction_g=0.0d0
      if (nsites_ion >= 1) then
        cec_fraction_g(1,:)=1.0d0
      end if
      call checkerr(ierr,'cec_fraction_g',ilog)
      call memory_monitor(sizeof(cec_fraction_g),'cec_fraction_g',.true.)

      allocate (rhobulk_g(nngl), stat = ierr)
      rhobulk_g=0.0d0
      call checkerr(ierr,'rhobulk_g',ilog)
      call memory_monitor(sizeof(rhobulk_g),'rhobulk_g',.true.)

      if (nx.gt.0) then
        allocate (gamma(nc+nx,nngl), stat = ierr)
        gamma=1.0d0
        call checkerr(ierr,'gamma',ilog)
        call memory_monitor(sizeof(gamma),'gamma',.true.)
    
        if (hmulti_diff) then
          allocate (gammaold(nc+nx,nngl), stat = ierr)
          gammaold=1.0d0
          call checkerr(ierr,'gammaold',ilog)
          call memory_monitor(sizeof(gammaold),'gammaold',.true.)
        end if

      else
        allocate (gamma(nc+1,nngl), stat = ierr)
        gamma=1.0d0
        call checkerr(ierr,'gamma',ilog)
        call memory_monitor(sizeof(gamma),'gamma',.true.)

        if (hmulti_diff) then
          allocate (gammaold(nc+1,nngl), stat = ierr)
          gammaold=1.0d0
          call checkerr(ierr,'gammaold',ilog)
          call memory_monitor(sizeof(gammaold),'gammaold',.true.)
        end if
    
      end if

      allocate (totcold(n,nngl), stat = ierr)
      totcold=0.0d0
      call checkerr(ierr,'totcold',ilog)
      call memory_monitor(sizeof(totcold),'totcold',.true.)

      if (hmulti_diff) then
        allocate (totcoldf(n,nngl), stat = ierr)
        totcoldf=0.0d0
        call checkerr(ierr,'totcoldf',ilog)
        call memory_monitor(sizeof(totcoldf),'totcoldf',.true.)
      end if
      

      allocate (totcnew(n,nngl), stat = ierr)
      totcnew=0.0d0
      call checkerr(ierr,'totcnew',ilog)
      call memory_monitor(sizeof(totcnew),'totcnew',.true.)
      
      if (hmulti_diff) then
        allocate (totcnewf(n,nngl), stat = ierr)
        totcnewf=0.0d0
        call checkerr(ierr,'totcnewf',ilog)
        call memory_monitor(sizeof(totcnewf),'totcnewf',.true.)
      end if
      
!c  New variables - Multicomponent Diffusion
      allocate (mdiff_ic_cvol(nc, nngl), stat = ierr)
      mdiff_ic_cvol=0.0d0 
      call checkerr(ierr,'mdiff_ic_cvol',ilog)
      call memory_monitor(sizeof(mdiff_ic_cvol),'mdiff_ic_cvol',.true.)

      allocate (mdiff_ix_cvol(nx, nngl), stat = ierr)
      mdiff_ix_cvol=0.0d0 
      call checkerr(ierr,'mdiff_ix_cvol',ilog)
      call memory_monitor(sizeof(mdiff_ix_cvol),'mdiff_ix_cvol',.true.)

      !allocate (totviscnew(nc,nngl), stat = ierr)
      !totviscnew=0.0d0
      !call checkerr(ierr,'totviscnew',ilog)
      !call memory_monitor(sizeof(totviscnew),'totviscnew',.true.)

      !allocate (electromignew(nc,nngl), stat = ierr)
      !electromignew=0.0d0
      !call checkerr(ierr,'electromignew',ilog)
      !call memory_monitor(sizeof(electromignew),'electromignew',.true.)

      !allocate (electromignew_inc(nc,nngl), stat = ierr)
      !electromignew_inc=0.0d0
      !call checkerr(ierr,'electromignew_inc',ilog)
      !call memory_monitor(sizeof(electromignew_inc),'electromignew_inc',.true.)
         
!c  New variables - Multicomponent Diffusion

      allocate (totgold(nc,nngl), stat = ierr)
      totgold=0.0d0
      call checkerr(ierr,'totgold',ilog)
      call memory_monitor(sizeof(totgold),'totgold',.true.)

      allocate (totgnew(nc,nngl), stat = ierr)
      totgnew=0.0d0
      call checkerr(ierr,'totgnew',ilog)
      call memory_monitor(sizeof(totgnew),'totgnew',.true.)


      allocate (totsold_ion(n,nngl), stat = ierr)
      totsold_ion=0.0d0
      call checkerr(ierr,'totsold_ion',ilog)
      call memory_monitor(sizeof(totsold_ion),'totsold_ion',.true.)

      allocate (totsold_surf(n,nngl), stat = ierr)
      totsold_surf=0.0d0
      call checkerr(ierr,'totsold_surf',ilog)
      call memory_monitor(sizeof(totsold_surf),'totsold_surf',.true.)

      !allocate (totsnew(n,nngl), stat = ierr)
      !totsnew=0.0d0
      !call checkerr(ierr,'totsnew',ilog)

      allocate (totsnew_ion(n,nngl), stat = ierr)
      totsnew_ion=0.0d0
      call checkerr(ierr,'totsnew_ion',ilog)
      call memory_monitor(sizeof(totsnew_ion),'totsnew_ion',.true.)

      allocate (totsnew_surf(n,nngl), stat = ierr)
      totsnew_surf=0.0d0
      call checkerr(ierr,'totsnew_surf',ilog)
      call memory_monitor(sizeof(totsnew_surf),'totsnew_surf',.true.)


      allocate (cm_init(nm,nngl), stat = ierr)
      cm_init=0.0d0
      call checkerr(ierr,'cm_init',ilog)
      call memory_monitor(sizeof(cm_init),'cm_init',.true.)

      allocate (cmold(nm,nngl), stat = ierr)
      cmold=0.0d0
      call checkerr(ierr,'cmold',ilog)
      call memory_monitor(sizeof(cmold),'cmold',.true.)


      if (nm.gt.0) then  
        allocate (cmnew(nm,nngl), stat = ierr)
        cmnew=0.0d0
        call checkerr(ierr,'cmnew',ilog)
        call memory_monitor(sizeof(cmnew),'cmnew',.true.)
      else
        allocate (cmnew(1,nngl), stat = ierr)
        cmnew=0.0d0
        call checkerr(ierr,'cmnew',ilog)
        call memory_monitor(sizeof(cmnew),'cmnew',.true.)
      end if

      allocate (gold(ng,nngl), stat = ierr)
      gold=0.0d0
      call checkerr(ierr,'gold',ilog)
      call memory_monitor(sizeof(gold),'gold',.true.)

      if (ng.gt.0) then 
        allocate (gnew(ng,nngl), stat = ierr)
        gnew=0.0d0
        call checkerr(ierr,'gnew',ilog)
        call memory_monitor(sizeof(gnew),'gnew',.true.)
      else
        allocate (gnew(1,nngl), stat = ierr)
        gnew=0.0d0
        call checkerr(ierr,'gnew',ilog)
        call memory_monitor(sizeof(gnew),'gnew',.true.)
      end if

      allocate (gmfrac(ng,nngl), stat = ierr)
      gmfrac=0.0d0
      call checkerr(ierr,'gmfrac',ilog)
      call memory_monitor(sizeof(gmfrac),'gmfrac',.true.)

      allocate (totgmfrac(n,nngl), stat = ierr)
      totgmfrac=0.0d0
      call checkerr(ierr,'totgmfrac',ilog)
      call memory_monitor(sizeof(totgmfrac),'totgmfrac',.true.)

      allocate (tau(nngl), stat = ierr)
      tau=1.0d0
      call checkerr(ierr,'tau',ilog)
      call memory_monitor(sizeof(tau),'tau',.true.)
      

      if (nx.gt.0) then
        allocate (cx(nx,nngl), stat = ierr)
        cx=0.0d0
        call checkerr(ierr,'cx',ilog)
        call memory_monitor(sizeof(cx),'cx',.true.)
    
        if (hmulti_diff) then
          allocate (cxold(nx,nngl), stat = ierr)
          cxold=0.0d0
          call checkerr(ierr,'cxold',ilog)
          call memory_monitor(sizeof(cxold),'cxold',.true.)
        end if
    
      else
        allocate (cx(1,nngl), stat = ierr)
        cx=0.0d0
        call checkerr(ierr,'cx',ilog)
        call memory_monitor(sizeof(cx),'cx',.true.)
    
        if (hmulti_diff) then
          allocate (cxold(1,nngl), stat = ierr)
          cxold=0.0d0
          call checkerr(ierr,'cxold',ilog)
          call memory_monitor(sizeof(cxold),'cxold',.true.)
        end if
    
      end if

      allocate (sionnew(nngl), stat = ierr)
      sionnew=0.0d0
      call checkerr(ierr,'sionnew',ilog)
      call memory_monitor(sizeof(sionnew),'sionnew',.true.)


      allocate (sionold(nngl), stat = ierr)
      sionold=0.0d0
      call checkerr(ierr,'sionold',ilog)
      call memory_monitor(sizeof(sionold),'sionold',.true.)

      if (nm.gt.0) then
        allocate (phi(nm,nngl), stat = ierr)
        phi=0.0d0
        call checkerr(ierr,'phi',ilog)
        call memory_monitor(sizeof(phi),'phi',.true.)
      else
        allocate (phi(1,nngl), stat = ierr)
        phi=0.0d0
        call checkerr(ierr,'phi',ilog)
        call memory_monitor(sizeof(phi),'phi',.true.)
      end if

      allocate (phi_init(nm,nngl), stat = ierr)
      phi_init=0.0d0
      call checkerr(ierr,'phi_init',ilog)
      call memory_monitor(sizeof(phi_init),'phi_init',.true.)

      allocate (phinucthrd(nm,nngl), stat = ierr)
      phinucthrd=0.0d0
      call checkerr(ierr,'phinucthrd',ilog) 
      call memory_monitor(sizeof(phinucthrd),'phinucthrd',.true.)

      allocate (area_init(nm,nngl), stat = ierr)
      area_init=0.0d0
      call checkerr(ierr,'area_init',ilog)
      call memory_monitor(sizeof(area_init),'area_init',.true.)

      allocate (areanucthrd(nm,nngl), stat = ierr)
      areanucthrd=0.0d0
      call checkerr(ierr,'areanucthrd',ilog)
      call memory_monitor(sizeof(areanucthrd),'areanucthrd',.true.)

      if (nm.gt.0) then
        allocate (phiold(nm,nngl), stat = ierr)
        phiold=0.0d0
        call checkerr(ierr,'phiold',ilog)
        call memory_monitor(sizeof(phiold),'phiold',.true.)
      else
        allocate (phiold(1,nngl), stat = ierr)
        phiold=0.0d0
        call checkerr(ierr,'phiold',ilog)
        call memory_monitor(sizeof(phiold),'phiold',.true.)
      end if      

      if (nm.gt.0) then
        allocate (area(nm,nngl), stat = ierr)
        area=0.0d0
        call checkerr(ierr,'area',ilog)
        call memory_monitor(sizeof(area),'area',.true.)
      else
        allocate (area(1,nngl), stat = ierr)
        area=0.0d0
        call checkerr(ierr,'area',ilog)
        call memory_monitor(sizeof(area),'area',.true.)
      end if

      allocate (mpropc(nngl), stat = ierr)
      mpropc=0
      call checkerr(ierr,'mpropc',ilog)
      call memory_monitor(sizeof(mpropc),'mpropc',.true.)

      allocate (totanew(nc,nngl), stat = ierr)
      totanew=0.0d0
      call checkerr(ierr,'totanew',ilog)
      call memory_monitor(sizeof(totanew),'totanew',.true.)

      allocate (totaold(nc,nngl), stat = ierr)
      totaold=0.0d0
      call checkerr(ierr,'totaold',ilog)
      call memory_monitor(sizeof(totaold),'totaold',.true.)

      allocate (distcoff_rt(nc,nngl), stat = ierr)
      distcoff_rt=0.0d0
      call checkerr(ierr,'distcoff_rt',ilog)
      call memory_monitor(sizeof(distcoff_rt),'distcoff_rt',.true.)

!cprovi-------------------------------------------------------------
!cprovi-------------------------------------------------------------
!cprovi-------------------------------------------------------------

      allocate (diff_ic(nc), stat = ierr)
      diff_ic=0.0d0 
      call checkerr(ierr,'diff_ic',ilog)
      call memory_monitor(sizeof(diff_ic),'diff_ic',.true.)

!cdsu component dependent diffusion coefficient tensor      
      allocate (diff_ic_tensor(nc), stat = ierr)
      diff_ic_tensor=tensor_zero 
      call checkerr(ierr,'diff_ic_tensor',ilog)
      call memory_monitor(sizeof(diff_ic_tensor),'diff_ic_tensor',.true.)

!cdsu dimension of boundary condition for diffusion
      allocate (diff_brt_dim(nngl), stat = ierr)
      diff_brt_dim=0 
      call checkerr(ierr,'diff_brt_dim',ilog)
      call memory_monitor(sizeof(diff_brt_dim),'diff_brt_dim',.true.)

   
!cmx-------------------------------------------------------------
!c  newton iteration - reactive transport
      if (discretization_type == 0) then
        allocate (cflux(ncon,n), stat = ierr)
        cflux=0.0d0
        call checkerr(ierr,'cflux',ilog)
        call memory_monitor(sizeof(cflux),'cflux',.true.)

        allocate (gflux(ncon,n), stat = ierr)
        gflux=0.0d0
        call checkerr(ierr,'gflux',ilog)
        call memory_monitor(sizeof(gflux),'gflux',.true.)

#ifdef USG
      else
        allocate (cflux(ncon_usg-1,n), stat = ierr)
        cflux=0.0d0
        call checkerr(ierr,'cflux',ilog)
        call memory_monitor(sizeof(cflux),'cflux',.true.)

        allocate (gflux(ncon_usg-1,n), stat = ierr)
        gflux=0.0d0
        call checkerr(ierr,'gflux',ilog)
        call memory_monitor(sizeof(gflux),'gflux',.true.)
#endif
      end if

      allocate (cstor(n), stat = ierr)
      cstor=0.0d0
      call checkerr(ierr,'cstor',ilog)
      call memory_monitor(sizeof(cstor),'cstor',.true.)

      allocate (gstor(n), stat = ierr)
      gstor=0.0d0
      call checkerr(ierr,'gstor',ilog)
      call memory_monitor(sizeof(gstor),'gstor',.true.)

      allocate (dtotcflux(n), stat = ierr)
      dtotcflux=0.0d0
      call checkerr(ierr,'dtotcflux',ilog)
      call memory_monitor(sizeof(dtotcflux),'dtotcflux',.true.)

      allocate (dtotgflux(n), stat = ierr)
      dtotgflux=0.0d0
      call checkerr(ierr,'dtotgflux',ilog)
      call memory_monitor(sizeof(dtotgflux),'dtotgflux',.true.)


      allocate (ratemdp(nm,nngl), stat = ierr)
      ratemdp=0.0d0
      call checkerr(ierr,'ratemdp',ilog)
      call memory_monitor(sizeof(ratemdp),'ratemdp',.true.)

      allocate (totcflux(n), stat = ierr)
      totcflux=0.0d0
      call checkerr(ierr,'totcflux',ilog)
      call memory_monitor(sizeof(totcflux),'totcflux',.true.)

      allocate (totcflux_diff(n), stat = ierr)         !MCD
      totcflux_diff=0.0d0
      call checkerr(ierr,'totcflux_diff',ilog)
      call memory_monitor(sizeof(totcflux_diff),'totcflux_diff',.true.)
      
      allocate (totcflux_mig(n), stat = ierr)          !MCD
      totcflux_mig=0.0d0
      call checkerr(ierr,'totcflux_mig',ilog)
      call memory_monitor(sizeof(totcflux_mig),'totcflux_mig',.true.)
      
      allocate (totgflux(n), stat = ierr)
      totgflux=0.0d0
      call checkerr(ierr,'totgflux',ilog)
      call memory_monitor(sizeof(totgflux),'totgflux',.true.)
      
      allocate (totgaflux(n), stat = ierr)
      totgaflux=0.0d0
      call checkerr(ierr,'totgaflux',ilog)
      call memory_monitor(sizeof(totgaflux),'totgaflux',.true.)
      
      allocate (gafluxin(n), stat = ierr)
      gafluxin = 0.0d0
      call checkerr(ierr,'gafluxin',ilog)
      call memory_monitor(sizeof(gafluxin),'gafluxin',.true.)

      allocate (gafluxout(n), stat = ierr)
      gafluxout = 0.0d0
      call checkerr(ierr,'gafluxout',ilog)
      call memory_monitor(sizeof(gafluxout),'gafluxout',.true.)
      

      allocate (totmdp(n,nngl), stat = ierr)
      totmdp=0.0d0
      call checkerr(ierr,'totmdp',ilog)
      call memory_monitor(sizeof(totmdp),'totmdp',.true.)


      allocate (astor(n), stat = ierr)
      astor=0.0d0
      call checkerr(ierr,'astor',ilog)
      call memory_monitor(sizeof(astor),'astor',.true.)

!c  data structure and solver - reactive transport

      allocate (brt(nngl*n), stat = ierr)
      brt=0.0d0
      call checkerr(ierr,'brt',ilog)
      call memory_monitor(sizeof(brt),'brt',.true.)


      allocate (urt(nngl*n), stat = ierr)
      urt=0.0d0
      call checkerr(ierr,'urt',ilog)
      call memory_monitor(sizeof(urt),'urt',.true.)


      allocate (resrt(nngl*n), stat = ierr)
      resrt=0.0d0
      call checkerr(ierr,'resrt',ilog)
      call memory_monitor(sizeof(resrt),'resrt',.true.)
      
      !b_doublecheck_residual = .true.
      !if(b_doublecheck_residual) then
      !    allocate (resrt_check(nngl*n), stat = ierr)
      !    restrt_check=0.0d0
      !    call checkerr(ierr,'resrt_check',ilog)   
      !end if

      allocate (iart(nngl*n+1), stat = ierr)
      iart=0
      call checkerr(ierr,'iart',ilog)
      call memory_monitor(sizeof(iart),'iart',.true.)

#ifdef PETSC

      allocate (row_idx_l2pg_rt(nngl*n+1), stat = ierr)
      row_idx_l2pg_rt=0
      call checkerr(ierr,'row_idx_l2pg_rt',ilog)
      call memory_monitor(sizeof(row_idx_l2pg_rt),'row_idx_l2pg_rt',.true.)

#endif

      allocate (kbl(n,n), stat = ierr)
      kbl=0
      call checkerr(ierr,'kbl',ilog)
      call memory_monitor(sizeof(kbl),'kbl',.true.)


      allocate (kblsorb(n,n), stat = ierr)
      kblsorb=0
      call checkerr(ierr,'kblsorb',ilog)
      call memory_monitor(sizeof(kblsorb),'kblsorb',.true.)

      allocate (kblredox(n,n), stat = ierr)
      kblredox=0
      call checkerr(ierr,'kblredox',ilog)
      call memory_monitor(sizeof(kblredox),'kblredox',.true.)


      allocate (iafrt(nngl*n+1), stat = ierr)
      iafrt=0
      call checkerr(ierr,'iafrt',ilog)
      call memory_monitor(sizeof(iafrt),'iafrt',.true.)


      allocate (iafdrt(nngl*n), stat = ierr)
      iafdrt=0
      call checkerr(ierr,'iafdrt',ilog)
      call memory_monitor(sizeof(iafdrt),'iafdrt',.true.)


      allocate (lorderrt(nngl*n), stat = ierr)
      lorderrt=0
      call checkerr(ierr,'lorderrt',ilog)
      call memory_monitor(sizeof(lorderrt),'lorderrt',.true.)


      allocate (invordrt(nngl*n), stat = ierr)
      invordrt=0
      call checkerr(ierr,'invordrt',ilog)
      call memory_monitor(sizeof(invordrt),'invordrt',.true.)


      allocate (iadbl(n+1), stat = ierr)
      iadbl=0
      call checkerr(ierr,'iadbl',ilog)
      call memory_monitor(sizeof(iadbl),'iadbl',.true.)


      allocate (jadbl(n*n), stat = ierr)
      jadbl=0
      call checkerr(ierr,'jadbl',ilog)
      call memory_monitor(sizeof(jadbl),'jadbl',.true.)


      allocate (kadbl(n,n), stat = ierr)
      kadbl=0
      call checkerr(ierr,'kadbl',ilog)
      call memory_monitor(sizeof(kadbl),'kadbl',.true.)

      allocate (iaobl(n+1), stat = ierr)
      iaobl=0
      call checkerr(ierr,'iaobl',ilog)
      call memory_monitor(sizeof(iaobl),'iaobl',.true.)

      allocate (jaobl(n*n), stat = ierr)
      jaobl=0
      call checkerr(ierr,'jaobl',ilog)
      call memory_monitor(sizeof(jaobl),'jaobl',.true.)

      allocate (kaobl(n,n), stat = ierr)
      kaobl=0
      call checkerr(ierr,'kaobl',ilog)
      call memory_monitor(sizeof(kaobl),'kaobl',.true.)

!c  mass balance - reactive transport

      allocate (cfluxin(n), stat = ierr)
      cfluxin=0.0d0
      call checkerr(ierr,'cfluxin',ilog)
      call memory_monitor(sizeof(cfluxin),'cfluxin',.true.)

      allocate (cfluxin_diff(n), stat = ierr)       !MCD
      cfluxin_diff=0.0d0
      call checkerr(ierr,'cfluxin_diff',ilog)
      call memory_monitor(sizeof(cfluxin_diff),'cfluxin_diff',.true.)

      allocate (cfluxin_mig(n), stat = ierr)        !MCD
      cfluxin_mig=0.0d0
      call checkerr(ierr,'cfluxin_mig',ilog)
      call memory_monitor(sizeof(cfluxin_mig),'cfluxin_mig',.true.)

      allocate (cfluxout(n), stat = ierr)
      cfluxout=0.0d0
      call checkerr(ierr,'cfluxout',ilog)
      call memory_monitor(sizeof(cfluxout),'cfluxout',.true.)

      allocate (cfluxout_diff(n), stat = ierr)         !MCD
      cfluxout_diff=0.0d0
      call checkerr(ierr,'cfluxout_diff',ilog)
      call memory_monitor(sizeof(cfluxout_diff),'cfluxout_diff',.true.)

      allocate (cfluxout_mig(n), stat = ierr)          !MCD
      cfluxout_mig=0.0d0
      call checkerr(ierr,'cfluxout_mig',ilog)
      call memory_monitor(sizeof(cfluxout_mig),'cfluxout_mig',.true.)

      !c root respiration and uptake
      allocate (totrootdiff(n), stat = ierr)
      totrootdiff=0.0d0
      call checkerr(ierr,'totrootdiff',ilog)
      call memory_monitor(sizeof(totrootdiff),'totrootdiff',.true.)


      allocate (gfluxtbdy(ng), stat = ierr)
      gfluxtbdy=0.0d0
      call checkerr(ierr,'gfluxtbdy',ilog)
      call memory_monitor(sizeof(gfluxtbdy),'gfluxtbdy',.true.)

      allocate (gfluxin(n), stat = ierr)
      gfluxin=0.0d0
      call checkerr(ierr,'gfluxin',ilog)
      call memory_monitor(sizeof(gfluxin),'gfluxin',.true.)

      allocate (gfluxout(n), stat = ierr)
      gfluxout=0.0d0
      call checkerr(ierr,'gfluxout',ilog)
      call memory_monitor(sizeof(gfluxout),'gfluxout',.true.)

      allocate (cstordiff(n+nm), stat = ierr)
      cstordiff=0.0d0
      call checkerr(ierr,'cstordiff',ilog)
      call memory_monitor(sizeof(cstordiff),'cstordiff',.true.)

      allocate (gdegas(n), stat = ierr)
      gdegas=0.0d0
      call checkerr(ierr,'gdegas',ilog)
      call memory_monitor(sizeof(gdegas),'gdegas',.true.)

      allocate (gstordiff(n), stat = ierr)
      gstordiff=0.0d0
      call checkerr(ierr,'gstordiff',ilog)
      call memory_monitor(sizeof(gstordiff),'gstordiff',.true.)
      
      allocate (ordiff(n), stat = ierr)
      ordiff=0.0d0
      call checkerr(ierr,'ordiff',ilog)
      call memory_monitor(sizeof(ordiff),'ordiff',.true.)

      allocate (intradiff(n), stat = ierr)
      intradiff=0.0d0
      call checkerr(ierr,'intradiff',ilog)
      call memory_monitor(sizeof(intradiff),'intradiff',.true.)

      allocate (dpdiff(n+nm), stat = ierr)
      dpdiff=0.0d0
      call checkerr(ierr,'dpdiff',ilog)
      call memory_monitor(sizeof(dpdiff),'dpdiff',.true.)


      allocate (gdiff(n+ng), stat = ierr)
      gdiff=0.0d0
      call checkerr(ierr,'gdiff',ilog)
      call memory_monitor(sizeof(gdiff),'gdiff',.true.)

      allocate (amass(n), stat = ierr)
      amass=0.0d0
      call checkerr(ierr,'amass',ilog)
      call memory_monitor(sizeof(amass),'amass',.true.)
      
      allocate (amass_gbl(n), stat = ierr)
      amass_gbl=0.0d0
      call checkerr(ierr,'amass_gbl',ilog)
      call memory_monitor(sizeof(amass_gbl),'amass_gbl',.true.)

      allocate (tmass(n), stat = ierr)
      tmass=0.0d0
      call checkerr(ierr,'tmass',ilog)
      call memory_monitor(sizeof(tmass),'tmass',.true.)
      
      allocate (tmass_gbl(n), stat = ierr)
      tmass_gbl=0.0d0
      call checkerr(ierr,'tmass_gbl',ilog)
      call memory_monitor(sizeof(tmass_gbl),'tmass_gbl',.true.)

      allocate (cmass(n), stat = ierr)
      cmass=0.0d0
      call checkerr(ierr,'cmass',ilog)
      call memory_monitor(sizeof(cmass),'cmass',.true.)
      
      allocate (cmass_gbl(n), stat = ierr)
      cmass_gbl=0.0d0
      call checkerr(ierr,'cmass_gbl',ilog)
      call memory_monitor(sizeof(cmass_gbl),'cmass_gbl',.true.)


      allocate (gmass(ng), stat = ierr)
      gmass=0.0d0
      call checkerr(ierr,'gmass',ilog)
      call memory_monitor(sizeof(gmass),'gmass',.true.)
      
      allocate (gmass_gbl(ng), stat = ierr)
      gmass_gbl=0.0d0
      call checkerr(ierr,'gmass_gbl',ilog)
      call memory_monitor(sizeof(gmass_gbl),'gmass_gbl',.true.)

      allocate (cmmass(nm), stat = ierr)
      cmmass=0.0d0
      call checkerr(ierr,'cmmass',ilog)
      call memory_monitor(sizeof(cmmass),'cmmass',.true.)
     
      allocate (cmmass_gbl(nm), stat = ierr)
      cmmass_gbl=0.0d0
      call checkerr(ierr,'cmmass_gbl',ilog)
      call memory_monitor(sizeof(cmmass_gbl),'cmmass_gbl',.true.)
      
      !if(nsb > 0) then
      !    allocate (csbmass(nsb), stat = ierr)
      !    csbmass=0.0d0
      !    call checkerr(ierr,'csbmass',ilog)
      !end if
      
      if(nsb_ion > 0) then
          allocate (csbmass_ion(nsb_ion), stat = ierr)
          csbmass_ion=0.0d0
          call checkerr(ierr,'csbmass_ion',ilog)
          call memory_monitor(sizeof(csbmass_ion),'csbmass_ion',.true.)
          
          allocate (csbmass_ion_gbl(nsb_ion), stat = ierr)
          csbmass_ion_gbl=0.0d0
          call checkerr(ierr,'csbmass_ion_gbl',ilog)
          call memory_monitor(sizeof(csbmass_ion_gbl),'csbmass_ion_gbl',.true.)
      end if
      
      if(nsb_surf > 0) then
          allocate (csbmass_surf(nsb_surf), stat = ierr)
          csbmass_surf=0.0d0
          call checkerr(ierr,'csbmass_surf',ilog)
          call memory_monitor(sizeof(csbmass_surf),'csbmass_surf',.true.)
          
          allocate (csbmass_surf_gbl(nsb_surf), stat = ierr)
          csbmass_surf_gbl=0.0d0
          call checkerr(ierr,'csbmass_surf_gbl',ilog)
          call memory_monitor(sizeof(csbmass_surf_gbl),'csbmass_surf_gbl',.true.)
      end if

      allocate (csbmass_c(nsites), stat = ierr)
      csbmass_c=0.0d0
      call checkerr(ierr,'csbmass_c',ilog)
      call memory_monitor(sizeof(csbmass_c),'csbmass_c',.true.)
      
      allocate (csbmass_c_gbl(nsites), stat = ierr)
      csbmass_c_gbl=0.0d0
      call checkerr(ierr,'csbmass_c_gbl',ilog)
      call memory_monitor(sizeof(csbmass_c_gbl),'csbmass_c_gbl',.true.)

      allocate (cculabsbal(n), stat = ierr)
      cculabsbal=0.0d0
      call checkerr(ierr,'cculabsbal',ilog)
      call memory_monitor(sizeof(cculabsbal),'cculabsbal',.true.)

      allocate (cculrelbal(n), stat = ierr)
      cculrelbal=0.0d0
      call checkerr(ierr,'cculrelbal',ilog)
      call memory_monitor(sizeof(cculrelbal),'cculrelbal',.true.)

      allocate (gculabsbal(ng), stat = ierr)
      gculabsbal=0.0d0
      call checkerr(ierr,'gculabsbal',ilog)
      call memory_monitor(sizeof(gculabsbal),'gculabsbal',.true.)

      allocate (gculrelbal(ng), stat = ierr)
      gculrelbal=0.0d0
      call checkerr(ierr,'gculrelbal',ilog)
      call memory_monitor(sizeof(gculrelbal),'gculrelbal',.true.)


      allocate (cmculabsbal(nm), stat = ierr)
      cmculabsbal=0.0d0
      call checkerr(ierr,'cmculabsbal',ilog)
      call memory_monitor(sizeof(cmculabsbal),'cmculabsbal',.true.)

      allocate (cmculrelbal(nm), stat = ierr)
      cmculrelbal=0.0d0
      call checkerr(ierr,'cmculrelbal',ilog)
      call memory_monitor(sizeof(cmculrelbal),'cmculrelbal',.true.)

      allocate (sbdiff(n), stat = ierr)
      sbdiff=0.0d0
      call checkerr(ierr,'sbdiff',ilog)
      call memory_monitor(sizeof(sbdiff),'sbdiff',.true.)

      allocate (rateaqtot(naq), stat = ierr)
      rateaqtot=0.0d0
      call checkerr(ierr,'rateaqtot',ilog)
      call memory_monitor(sizeof(rateaqtot),'rateaqtot',.true.)

      allocate (contaqtot(naq), stat = ierr)
      contaqtot=0.0d0
      call checkerr(ierr,'contaqtot',ilog)
      call memory_monitor(sizeof(contaqtot),'contaqtot',.true.)

      allocate (contmintot(nm), stat = ierr)
      contmintot=0.0d0
      call checkerr(ierr,'contmintot',ilog)
      call memory_monitor(sizeof(contmintot),'contmintot',.true.)
      
#ifdef PETSC
      allocate (contmintot_mpi(nm), stat = ierr)
      contmintot_mpi=0.0d0
      call checkerr(ierr,'contmintot_mpi',ilog)
      call memory_monitor(sizeof(contmintot_mpi),'contmintot_mpi',.true.)
#endif
      

      allocate (totcfluxin(nc), stat = ierr)
      totcfluxin=0.0d0
      call checkerr(ierr,'totcfluxin',ilog)
      call memory_monitor(sizeof(totcfluxin),'totcfluxin',.true.)

      allocate (totcfluxin_diff(nc), stat = ierr)     !MCD
      totcfluxin_diff=0.0d0
      call checkerr(ierr,'totcfluxin_diff',ilog)
      call memory_monitor(sizeof(totcfluxin_diff),'totcfluxin_diff',.true.)
      
      allocate (totcfluxin_mig(nc), stat = ierr)      !MCD
      totcfluxin_mig=0.0d0
      call checkerr(ierr,'totcfluxin_mig',ilog)
      call memory_monitor(sizeof(totcfluxin_mig),'totcfluxin_mig',.true.)
      
      allocate (totcfluxout(nc), stat = ierr)
      totcfluxout=0.0d0
      call checkerr(ierr,'totcfluxout',ilog)
      call memory_monitor(sizeof(totcfluxout),'totcfluxout',.true.)

      allocate (totcfluxout_diff(nc), stat = ierr)       !MCD
      totcfluxout_diff=0.0d0
      call checkerr(ierr,'totcfluxout_diff',ilog)
      call memory_monitor(sizeof(totcfluxout_diff),'totcfluxout_diff',.true.)
      
      allocate (totcfluxout_mig(nc), stat = ierr)        !MCD
      totcfluxout_mig=0.0d0
      call checkerr(ierr,'totcfluxout_mig',ilog)
      call memory_monitor(sizeof(totcfluxout_mig),'totcfluxout_mig',.true.)


      allocate (totcstordiff(nc), stat = ierr)
      totcstordiff=0.0d0
      call checkerr(ierr,'totcstordiff',ilog)
      call memory_monitor(sizeof(totcstordiff),'totcstordiff',.true.)

      allocate (totordiff(nc), stat = ierr)
      totordiff=0.0d0
      call checkerr(ierr,'totordiff',ilog)
      call memory_monitor(sizeof(totordiff),'totordiff',.true.)

      allocate (totintradiff(nc), stat = ierr)
      totintradiff=0.0d0
      call checkerr(ierr,'totintradiff',ilog)
      call memory_monitor(sizeof(totintradiff),'totintradiff',.true.)

      allocate (totdpdiff(nc), stat = ierr)
      totdpdiff=0.0d0
      call checkerr(ierr,'totdpdiff',ilog)
      call memory_monitor(sizeof(totdpdiff),'totdpdiff',.true.)

      allocate (totgdegas(nc), stat = ierr)
      totgdegas=0.0d0
      call checkerr(ierr,'totgdegas',ilog)
      call memory_monitor(sizeof(totgdegas),'totgdegas',.true.)

      allocate (totgdiff(nc), stat = ierr)
      totgdiff=0.0d0
      call checkerr(ierr,'totgdiff',ilog)
      call memory_monitor(sizeof(totgdiff),'totgdiff',.true.)

      allocate (totrootresp(nc), stat = ierr)
      totrootresp=0.0d0
      call checkerr(ierr,'totrootresp',ilog)
      call memory_monitor(sizeof(totrootresp),'totrootresp',.true.)

      allocate (totrootuptake(nc), stat = ierr)
      totrootuptake=0.0d0
      call checkerr(ierr,'totrootuptake',ilog)
      call memory_monitor(sizeof(totrootuptake),'totrootuptake',.true.)
      
!c    gas phase density, molar density, viscosity

      allocate (dens_g(nngl), stat = ierr)
      dens_g = 0.0d0
      call checkerr(ierr,'dens_g',ilog) 
      call memory_monitor(sizeof(dens_g),'dens_g',.true.)
    
      allocate (visc_g(nngl), stat = ierr)
      visc_g = 0.0d0
      call checkerr(ierr,'visc_g',ilog) 
      call memory_monitor(sizeof(visc_g),'visc_g',.true.)
      
      allocate (mdens_g(nngl), stat = ierr)
      mdens_g = 0.0d0
      call checkerr(ierr,'mdens_g',ilog) 
      call memory_monitor(sizeof(mdens_g),'mdens_g',.true.)

      allocate (dg(ng), stat = ierr)
      dg = 0.0d0
      call checkerr(ierr,'dg',ilog)
      call memory_monitor(sizeof(dg),'dg',.true.)
      
      allocate (gdens(nngl), stat = ierr)
      gdens = 0.0d0
      call checkerr(ierr,'gdens',ilog)
      call memory_monitor(sizeof(gdens),'gdens',.true.)
      
      allocate (gij(ng), stat = ierr)
      gij = 0.0d0
      call checkerr(ierr,'gij',ilog)
      call memory_monitor(sizeof(gij),'gij',.true.)
      
      allocate (gvisc(nngl), stat = ierr)
      gvisc = 0.0d0
      call checkerr(ierr,'gvisc',ilog)
      call memory_monitor(sizeof(gvisc),'gvisc',.true.)
      
      allocate (gpivol(nngl), stat = ierr)
      gpivol = 0.0d0
      call checkerr(ierr,'gpivol',ilog)
      call memory_monitor(sizeof(gpivol),'gpivol',.true.)

      allocate (gmfracij(ng), stat = ierr)
      gmfracij = 0.0d0
      call checkerr(ierr,'gmfracij',ilog)
      call memory_monitor(sizeof(gmfracij),'gmfracij',.true.)
      
      allocate (gmfrac_brt(ng), stat = ierr)
      call checkerr(ierr,'',ilog)
      call memory_monitor(sizeof(gmfrac_brt),'gmfrac_brt',.true.)
      
      allocate (gmfrac_ivol(ng), stat = ierr)
      gmfrac_ivol = 0.0d0
      call checkerr(ierr,'gmfrac_ivol',ilog)
      call memory_monitor(sizeof(gmfrac_ivol),'gmfrac_ivol',.true.)
      
      allocate (totgnew_brt(nc), stat = ierr)
      totgnew_brt = 0.0d0
      call checkerr(ierr,'totgnew_brt',ilog)
      call memory_monitor(sizeof(totgnew_brt),'totgnew_brt',.true.)
      
      allocate (totgmfrac_brt(nc), stat = ierr)
      totgmfrac_brt = 0.0d0
      call checkerr(ierr,'totgmfrac_brt',ilog)
      call memory_monitor(sizeof(totgmfrac_brt),'totgmfrac_brt',.true.)
      
      allocate (totgmfrac_ivol(nc), stat = ierr)
      totgmfrac_ivol = 0.0d0
      call checkerr(ierr,'totgmfrac_ivol',ilog)
      call memory_monitor(sizeof(totgmfrac_ivol),'totgmfrac_ivol',.true.)
      
      allocate (totgij(nc), stat = ierr)
      totgij = 0.0d0
      call checkerr(ierr,'totgij',ilog)
      call memory_monitor(sizeof(totgij),'totgij',.true.)
      

      

      allocate (totgfluxin(nc), stat = ierr)
      totgfluxin=0.0d0
      call checkerr(ierr,'totcfluxin',ilog)
      call memory_monitor(sizeof(totgfluxin),'totgfluxin',.true.)

      allocate (totgfluxout(nc), stat = ierr)
      totgfluxout=0.0d0
      call checkerr(ierr,'totgfluxout',ilog)
      call memory_monitor(sizeof(totgfluxout),'totgfluxout',.true.)
      
      allocate (totgafluxin(nc), stat = ierr)
      totgafluxin = 0.0d0
      call checkerr(ierr,'totgafluxin',ilog)
      call memory_monitor(sizeof(totgafluxin),'totgafluxin',.true.)

      allocate (totgafluxout(nc), stat = ierr)
      totgafluxout = 0.0d0
      call checkerr(ierr,'totgfluxout',ilog)
      call memory_monitor(sizeof(totgafluxout),'totgafluxout',.true.)

      allocate (totgstordiff(nc), stat = ierr)
      totgstordiff=0.0d0
      call checkerr(ierr,'totgstordiff',ilog)
      call memory_monitor(sizeof(totgstordiff),'totgstordiff',.true.)

      allocate (totsbdiff(nc), stat = ierr)
      totsbdiff=0.0d0
      call checkerr(ierr,'totsbdiff',ilog)
      call memory_monitor(sizeof(totsbdiff),'totsbdiff',.true.)


      allocate (dpdiffp(maxndr*nm), stat = ierr)
      dpdiffp=0.0d0
      call checkerr(ierr,'dpdiffp',ilog)
      call memory_monitor(sizeof(dpdiffp),'dpdiffp',.true.)

      allocate (totdpdiffp(maxndr*nm), stat = ierr)
      totdpdiffp=0.0d0
      call checkerr(ierr,'totdpdiffp',ilog)
      call memory_monitor(sizeof(totdpdiffp),'totdpdiffp',.true.)
      
!c_bubbles variables for bubble problem

      if (gas_bubbles) then

        allocate (uvsnew_b(nngl), stat = ierr)
        uvsnew_b=0.0d0
        call checkerr(ierr,'uvsnew_b',ilog)
        call memory_monitor(sizeof(uvsnew_b),'uvsnew_b',.true.)
        
        allocate (sanew_c(nngl), stat = ierr)
        sanew_c=0.0d0
        call checkerr(ierr,'sanew_c',ilog)
        call memory_monitor(sizeof(sanew_c),'sanew_c',.true.)
        
        allocate (sanew_b(nngl), stat = ierr)
        sanew_b=0.0d0
        call checkerr(ierr,'sanew_b',ilog)
        call memory_monitor(sizeof(sanew_b),'sanew_b',.true.)

        allocate (c_update(nc,nngl), stat = ierr)
        c_update=0.0d0
        call checkerr(ierr,'c_update',ilog)
        call memory_monitor(sizeof(c_update),'c_update',.true.)
        
        allocate (tot_gas(ng,nngl), stat = ierr)
        tot_gas=0.0d0
        call checkerr(ierr,'tot_gas',ilog)
        call memory_monitor(sizeof(tot_gas),'tot_gas',.true.)
                
        allocate (k_henry(ng,nngl), stat = ierr)
        k_henry=0.0d0
        call checkerr(ierr,'k_henry',ilog)
        call memory_monitor(sizeof(k_henry),'k_henry',.true.)
        
      end if

!c_bubbles 

      allocate (scalfac_aq_ivol(naq,nngl), stat = ierr)
      scalfac_aq_ivol=0.0d0
      call checkerr(ierr,'scalfac_aq_ivol',ilog)
      call memory_monitor(sizeof(scalfac_aq_ivol),'scalfac_aq_ivol',.true.)
      
#ifdef PETSC
      allocate (totdpdiffp_mpi(maxndr*nm), stat = ierr)
      totdpdiffp_mpi=0.0d0
      call checkerr(ierr,'totdpdiffp_mpi',ilog)
      call memory_monitor(sizeof(totdpdiffp_mpi),'totdpdiffp_mpi',.true.)
#endif
      
      allocate (mpireduce_n(n), stat = ierr)
      mpireduce_n=0.0d0
      call checkerr(ierr,'mpireduce_n',ilog)
      call memory_monitor(sizeof(mpireduce_n),'mpireduce_n',.true.)
      
      allocate (mpireduce_ng(ng), stat = ierr)
      mpireduce_ng=0.0d0
      call checkerr(ierr,'mpireduce_ng',ilog)
      call memory_monitor(sizeof(mpireduce_ng),'mpireduce_ng',.true.)
      
      allocate (mpireduce_nm(nm), stat = ierr)
      mpireduce_nm=0.0d0
      call checkerr(ierr,'mpireduce_nm',ilog)
      call memory_monitor(sizeof(mpireduce_nm),'mpireduce_nm',.true.)
      
      allocate (mpireduce_naq(naq), stat = ierr)
      mpireduce_naq=0.0d0
      call checkerr(ierr,'mpireduce_naq',ilog)
      call memory_monitor(sizeof(mpireduce_naq),'mpireduce_naq',.true.)

!c  noble gas ingrowth
      allocate (ngidiff(n), stat = ierr)
      ngidiff=0.0d0
      call checkerr(ierr,'ngidiff',ilog)
      call memory_monitor(sizeof(ngidiff),'ngidiff',.true.)

      allocate (totngidiff(n), stat = ierr)
      totngidiff=0.0d0
      call checkerr(ierr,'totngidiff',ilog)
      call memory_monitor(sizeof(totngidiff),'totngidiff',.true.)
     
      return
      end
