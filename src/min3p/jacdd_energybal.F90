!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 877 $
!> $Author: dsu $
!> $Date: 2024-02-08 21:51:08 -0800 (Thu, 08 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/jacdd_energybal.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine jacdd_energybal
!c ----------------
!c
!c pressure formulation
!c accounts for presence of DNAPL phase
!c 
!c
!c construct Jacobian matrix and rhs-vector (density-dependent flow)
!c
!c modified from Sergio Andres Bea Jofre 
!c
!c written by:      Sergio Andres Bea Jofre 
!c
!c last modified:   Sergio Andres Bea Jofre 
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c                  Variably saturated flow capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           avs(njavs)         = jacobian matrix                     - +
!c           bvs(nn)            = rhs vector                          - +
!c           cinfvs(njavs)      = influence coefficients              + -
!c           cvol(nn)           = nodal volumes                       + -
!c           delt               = time step                           + -
!c           dinc_vs            = increment for numerical             + -
!c                                differentiation
!c           pornew(nn)         = porosity (new time level)           + -
!c           relperm(nn)        = relative permeability               * +
!c           relpinc(nn)        = relative permeability (incremented) * *
!c           sainc(nn)          = aqueous phase saturation            * *
!c                                - incremented
!c           sanew(nn)          = aqueous phase saturation            * +
!c                                - new time level
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           uvsinc(nn)         = solution vector (incremented)       * *
!c           uvsnew(nn)         = solution vector (new time level)    * +
!c           uvsold(nn)         = solution vector (old time level)    + -
!c           vsflux(ncon-1)     = interfacial fluxes                  * *
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           idbg               = unit number, debugging file         + -
!c           iavs(nn+1)         = row pointer array for avs           + -
!c           isymvs(njavs)      = symmetry pointer array              + -
!c           javs(njavs)        = connectivity list                   + -
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c           njavs              = number of global connections        + -
!c
!c           logical:
!c           --------
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           upstream           = .true.  -> upstream weighting       + -
!c
!c           character:
!c           ----------
!c           iups(ncon-1)       = upstream pointer                    * *
!c
!c
!c dens.f:   real*8:
!c           -------
!c           del_p(ncon-1)      = difference in total                 + -       
!c                                pressure potential
!c           del_z(ncon-1)      = difference in                       + -                   
!c                                elevation potential
!c           pressure(nn)       = fluid pressure                      + - 
!c           density(nn)        = fluid density                       + -  
!c           viscosity(nn)      = fluid viscosity                     + -
!c           dcoef(ncon-1)      = coefficient including density       + -
!c                                and viscosity 
!c           rho_av             = average density between ivol        + -
!c                                and jvol
!c
!c           integer*4
!c           ---------
!c           iter_sia           = iteration counter -Picard iteration * - 
!c
!c local:    real*8:
!c           -------
!c           dqroot             = derivative of root water uptake
!c           dtotvsflux         = derivative of total flux into
!c                                current control volume
!c           dvsstor            = derivative of storage term
!c           dvsflux            = derivative of flux term
!c           hhinc              = hydraulic head (incremented)
!c           qroot              = root water uptake for current
!c                                control volume
!c           qrootinc           = root water uptake for current 
!c                                control volume (incremented)
!c           totvsflux          = total flux into current control 
!c                                volume
!c           vsstor             = storage term for current control 
!c                                volume
!c           vsstorinc          = storage term for current control
!c                                volume (incremented variables)
!c           vsfluxinc          = interfacial flux (incremented 
!c                                variables)
!c           r0                 = constant
!c           r1                 = constant
!c           rhalf              = constant
!c           gacc               = gravitational acceleration [m s^-2]
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter (row entries)
!c           ivol               = counter (control volumes)
!c           istart             = pointer (start of row)
!c           iend               = pointer (end of row)
!c           idiag              = pointer (diagonal)
!c           icon               = pointer (connections - local)
!c           isym               = symmetry pointer
!c           jvol               = row-column pointer
!c
!c external: rhsvs     = assembly of rhs vector
!c           storddfs  = storage function for fully saturated 
!c                       density dependent flow 
!c           fluxdd    = flux function for fully saturated 
!c                       density dependent flow
!c           soilparm  = soil hydraulic parameters
!c ----------------------------------------------------------------------
 
       subroutine jacdd_energybal
 
       use parm
       use gen
       use phys
       use dens
       use chem
#ifdef OPENMP
       use omp_lib
#endif 

#ifdef USG
       use math_common
       use geometry
       use usg_mesh_data, only : num_edge_dvols,cells, num_cells,      &
                                 num_nodes_per_cell,num_edge_maxcells
       use gradient_usg, only : gradient_cross_diff,                   &
                                gradient_cross_diff_inc,               &
                                gradient_cross_diff_dd,                &
                                gradient_cross_diff_dd_inc
       use diff_vapour_usg_mod, only : diff_vapour_usg
       use usg_face_utility, only : usg_face_utility_cinfvs,           &
                                    usg_face_utility_cinfevap_t,       &
                                    usg_face_utility_cinfevap_pa,      &
                                    usg_face_utility_cinfheat_c,       &
                                    usg_face_utility_cinfheat_d
       use mod_fluxdd_usg, only : fluxdd_usg
       use mod_darcy_energybal_usg, only : darcy_energybal_usg
#endif
 
       implicit none

       integer :: i1, icon, ivol, izn, idiagvspa, idiagheattemp, idiagheatpa, &
                  idiagvstemp, istart, iend, jvol, isymvspa, isymvstemp,      &
                  isymheatpa, isymheattemp,im

       real*8 :: actw, delt_loc, densoldc_ivol, densnewc_ivol,                &
                 tdsold_ivol, tdsnew_ivol, totvsflux, tortuosity, coeff,      &
                 vsstor, facpa, factemp, dinc_vs_loc,                         &
                 dtemp_ivol, tempinc_ivol, densinc_ivol, viscoinc_ivol,       &
                 porinc_ivol, densnew_ivol, densold_ivol,                     &
                 sanew_ivol, saold_ivol, relheat_iw,                          &
                 densvinc_pa_ivol, densvinc_temp_ivol, dtotvsflux_pa,         &
                 dtotvsflux_temp, del_pinc, vsfluxinc, dvsflux, tortinc,      &
                 dtemp_ivol_jvol, por_av, sa_av, heatfluxinc, dheatflux,      &
                 vapfluxinc, vsstorinc, dvsstor
       real*8, external :: relpfsat, storevap, storddfs, storheat,            &
                fluxdd, fluxheat, darcy_energybal, diff_vapour, rhonew,       &
                tortuosity_vap, visconew, porosity_flow, stordd
                

       integer :: chunk

#ifdef USG
       integer :: i2, icell, idvol, kvol, ncell, ndvol, nrelp
       real*8 :: densinc, densvinc_pa, uvsinc_loc, sanew_loc
       real*8 :: grad_weights(num_crossdifficv_max)
       real*8 :: relps_loc(num_edge_maxcells), relpsinc_loc(num_edge_maxcells)
       real*8 :: flux_ddflow_hls_corr(num_edge_dvols,num_edge_maxcells),     &
                 flux_ddflow_inc_hls_corr(num_edge_dvols,num_edge_maxcells), &
                 flux_temp_hls_corr(num_edge_dvols,num_edge_maxcells),       &
                 flux_temp_inc_hls_corr(num_edge_dvols,num_edge_maxcells),   &
                 flux_flow_hls_corr(num_edge_dvols,num_edge_maxcells),       &
                 flux_flow_inc_hls_corr(num_edge_dvols,num_edge_maxcells) 
       type(point) :: grad_locs(num_crossdifficv_max)
       type(point) :: grad_ddflow_mids(num_edge_dvols,num_edge_maxcells),    &
                      grad_ddflow_inc_mids(num_edge_dvols,num_edge_maxcells),&
                      grad_temp_mids(num_edge_dvols,num_edge_maxcells),      &
                      grad_temp_inc_mids(num_edge_dvols,num_edge_maxcells),  &
                      grad_flow_mids(num_edge_dvols,num_edge_maxcells),      &
                      grad_flow_inc_mids(num_edge_dvols,num_edge_maxcells) 
       type(grad_hls_term) :: grad_flow_hls_loc(num_edge_dvols),            &
                              grad_ddflow_hls_loc(num_edge_dvols),          &
                              grad_temp_hls_loc(num_edge_dvols)                             
       real*8 :: cinfvs_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfvs_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfevap_pa_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfevap_pa_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfevap_t_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfevap_t_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfheat_c_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfheat_c_usg_cross_loc(num_edge_dvols,num_edge_maxcells)

       real*8 :: cinfheat_d_usg_loc(num_edge_dvols,num_edge_maxcells)
       type(point) :: cinfheat_d_usg_cross_loc(num_edge_dvols,num_edge_maxcells)
#endif

       real*8, external :: relheat_freezing

       external :: rhsvs, zero_r8

       real*8, parameter  :: r0 = 0.0d0, &
                             rhalf = 0.5d0, &
                             r1 = 1.0d0, &
                             r2 = 2.0d0, &
                             r3 = 3.0d0, &
                             r4 = 4.0d0, &
                             r1d3 = 1.0d3

       integer, parameter :: i0=0


       logical :: iserror, isdebug
       integer :: info_debug, ivol_track, ivol_gbl

       real*8                 :: heatstor, &
                                 heatstorinc, &
                                 totsinksource, &
                                 totsinksourceinc, &
                                 tempivol, &
                                 totheatflux , &
                                 heatcap_av,  &
                                 dheatstor, &
                                 dtotheatflux_pa, &
                                 dtotheatflux_temp, &
                                 dtotvsfluxtemp, &
                                 del_tempinc, &
                                 dummy1, &
                                 dummy2, &
                                 dummy3, &
                                 dummy4, &
                                 latvapinc_ivol, &
                                 latvap_av,&
                                 dinc_den_loc,&
                                 aentry_loc

#ifdef OPENMP
      chunk = nngl / numofthreads_matrix_flow
      if(mod(nngl, numofthreads_matrix_flow) > 0) then
          chunk = chunk + 1                             !This is default chunk size for static scheduling.
      end if
      if (i_chunksize_factor_flow > 1) then
            if(mod(chunk, i_chunksize_factor_flow) > 0) then
                chunk = chunk/i_chunksize_factor_flow + 1
            else
                chunk = chunk/i_chunksize_factor_flow
            end if
      end if
#endif

#ifdef SCHEDULE_DYNAMIC
      if(i_chunksize_factor_flow == 0) then
        chunk = 1                                       !This is the default chunk size for dynamic scheduling.
      end if 
#endif

!c  debug toggle
      isdebug = .false.
            
      if(iter_glob.le.1) then
        info_debug = -1
        ivol_track = -1
      else
        info_debug = -1
        ivol_track = -1
      end if


#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (i_matrix_assembly_type_flow == 1)                       &
    !$omp num_threads(numofthreads_matrix_flow)                       &
    !$omp default(shared)                                             &
    !$omp private (                                                   &
#ifdef USG
    !$omp i2, icell, idvol, ncell, nrelp, relps_loc,relpsinc_loc,     &
    !$omp ivol_gbl, ndvol, uvsinc_loc, sanew_loc, grad_ddflow_mids,   &
    !$omp grad_temp_mids, grad_flow_mids, grad_ddflow_inc_mids,       &
    !$omp grad_temp_inc_mids, grad_flow_inc_mids, grad_locs,          &
    !$omp grad_weights, grad_flow_hls_loc,                           &
    !$omp grad_temp_hls_loc, grad_ddflow_hls_loc,                   &
    !$omp flux_temp_hls_corr, flux_temp_inc_hls_corr,                 &
    !$omp flux_flow_hls_corr, flux_flow_inc_hls_corr,                 &
    !$omp flux_ddflow_hls_corr, flux_ddflow_inc_hls_corr,             &
    !$omp cinfvs_usg_loc, cinfvs_usg_cross_loc,                       &
    !$omp cinfevap_t_usg_loc, cinfevap_t_usg_cross_loc,               &
    !$omp cinfevap_pa_usg_loc, cinfevap_pa_usg_cross_loc,             &
    !$omp cinfheat_c_usg_loc, cinfheat_c_usg_cross_loc,               &
    !$omp cinfheat_d_usg_loc, cinfheat_d_usg_cross_loc,               &
#endif
    !$omp i1, icon, idiagheatpa, idiagheattemp, idiagvspa,            &
    !$omp idiagvstemp, iend, istart, isymheatpa, isymheattemp,        &
    !$omp isymvspa, isymvstemp, ivol, izn, jvol,                      &
    !$omp actw, coeff, del_p, del_temp, del_z, delt_loc, del_pinc,    &
    !$omp densinc_ivol, densnewc_ivol, densoldc_ivol,                 &
    !$omp densnew_ivol, densold_ivol, sanew_ivol, saold_ivol,         &
    !$omp densvinc_temp_ivol, densvinc_pa_ivol, dheatflux,            &
    !$omp dheatstor, dinc_vs_loc, dtemp_ivol, dtemp_ivol_jvol,        &
    !$omp dtotheatflux_pa, dtotheatflux_temp, dtotvsflux_pa,          &
    !$omp dtotvsflux_temp, dummy1, dummy2, dummy3, dummy4,            &
    !$omp dvsflux, dvsstor, facpa, factemp, heatflux_a, heatflux_c,   &
    !$omp heatflux_d, heatflux_v, heatfluxinc, heatstor,              &
    !$omp heatstorinc, latvap_av, latvapinc_ivol, por_av,             &
    !$omp porinc_ivol, rho_av, sa_av, dinc_den_loc, relheat_iw,       &
    !$omp tdsnew_ivol, tempinc_ivol, tdsold_ivol, tortinc,            &
    !$omp tortuosity, totheatflux, totvsflux, vapflux, vapfluxheat,   &
    !$omp vapfluxinc, viscoinc_ivol, vsflux, vsfluxinc, vsfluxheat,   &
    !$omp vsstor, vsstorinc, totsinksource, totsinksourceinc)
#endif

!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi calculate relative permeability to account for the 
!cprovi presence of a napl phase
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------
!cprovi-------------------------------------------------------

      if (napl_permeability) then
      
#ifdef USG
        if (discretization_type > 0 .and. is_cell_based_relp) then
#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif    
#endif
          do icell = 1,num_cells             !loop over cells
            izn = mpropvs_cell(icell)
            
            sanew_loc = 0.0d0
            do i2 = 1, num_nodes_per_cell
              sanew_loc = sanew_loc + sanew(cells(i2,icell))
            end do
            sanew_loc = sanew_loc / num_nodes_per_cell
            
            if (napl_kfunction .eq. 'vangenuchten') then          
              relperm(icell) = relpfsat(sanew_loc,swr(izn),expn(izn),spgamma(izn))              
            else if (napl_kfunction .eq. 'corey') then                  
              relperm(icell) = ((sanew_loc - swr(izn))/(r1 - swr(izn)))**r4          
            end if 
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif
        else
#endif
      
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif     
          do ivol = 1,nngl             !loop over control volumes
              
#ifdef DEBUG
#ifdef PETSC
            ivol_gbl = node_idx_lg2g(ivol)
#else
            ivol_gbl = ivol
#endif
#endif
              
            izn = mpropvs(ivol)
            if (napl_kfunction .eq. 'vangenuchten') then
               
              relperm(ivol) = relpfsat(sanew(ivol),swr(izn),expn(izn),spgamma(izn))
              
            else if (napl_kfunction .eq. 'corey') then
                  
              relperm(ivol) = ((sanew(ivol) - swr(izn))/(r1 - swr(izn)))**r4
          
            end if 
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef USG
        end if
#endif
       
      end if
      
      !c calculate relative permeability increment, only for USG cell based relative permeability
      !c confusion here, why use soilprdd to calculate relative permeability 
      !c increment but not for regular relative permeability, DSU, 2017-11-15
#ifdef USG
      if (discretization_type > 0 .and. is_cell_based_relp) then  
        if (variably_saturated) then
        
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif   
          do ivol = 1,nngl             !loop over control volumes
              
#ifdef DEBUG
#ifdef PETSC
            ivol_gbl = node_idx_lg2g(ivol)
#else
            ivol_gbl = ivol
#endif
#endif
              
            izn = mpropvs(ivol)
            
            uvsinc(ivol) = uvsnew(ivol) + dinc_vs
            if (.not. b_disable_sat_updt) then
              if (soilhydrfunc_field) then
                call soilprdd(uvsinc(ivol),sainc(ivol),sginc(ivol),    &
                              dummy1,dummy2,snnew(ivol),               &
                              swr_vol(ivol),aentry_vol(ivol),          &
                              spalpha_vol(ivol),spbeta_vol(ivol),      &
                              expn_vol(ivol),spgamma_vol(ivol),        &
                              napl_permeability,                       &
                              napl_kfunction,sgr,isovendrying(izn),    &
                              beta_ovendry(izn),hm_ovendry(izn),       &
                              w0_ovendry(izn),cp0_ovendry(izn),        &
                              ref_dens,gacc)
              else
                call soilprdd(uvsinc(ivol),sainc(ivol),sginc(ivol),    &
                              dummy1,dummy2,snnew(ivol),               &
                              swr(izn),aentry(izn),spalpha(izn),       &
                              spbeta(izn),expn(izn),spgamma(izn),      &
                              napl_permeability,                       &
                              napl_kfunction,sgr,isovendrying(izn),    &
                              beta_ovendry(izn),hm_ovendry(izn),       &
                              w0_ovendry(izn),cp0_ovendry(izn),        &
                              ref_dens,gacc)
              end if
            end if
          end do
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp barrier
#endif        
        
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif   
          do icell = 1,num_cells             !loop over cells
            izn = mpropvs_cell(icell)
            
            uvsinc_loc = dinc_vs
            do i2 = 1, num_nodes_per_cell
              uvsinc_loc = uvsinc_loc + uvsnew(cells(i2,icell))
            end do
            uvsinc_loc = uvsinc_loc / num_nodes_per_cell
            
            if (.not. b_disable_sat_updt) then
              if (soilhydrfunc_field) then
                call soilprdd(uvsinc_loc,dummy1,dummy2,                  &
                              relpinc(icell),relpincg(icell),snnew(ivol),&
                              swr_vol(ivol),aentry_vol(ivol),            &
                              spalpha_vol(ivol),spbeta_vol(ivol),        &
                              expn_vol(ivol),spgamma_vol(ivol),          &
                              napl_permeability,                         &
                              napl_kfunction,sgr,isovendrying(izn),      &
                              beta_ovendry(izn),hm_ovendry(izn),         &
                              w0_ovendry(izn),cp0_ovendry(izn),          &
                              ref_dens,gacc)
              else
                call soilprdd(uvsinc_loc,dummy1,dummy2,                  &
                              relpinc(icell),relpincg(icell),snnew(ivol),&
                              swr(izn),aentry(izn),                      &
                              spalpha(izn),spbeta(izn),                  &
                              expn(izn),spgamma(izn),                    &
                              napl_permeability,                         &
                              napl_kfunction,sgr,isovendrying(izn),      &
                              beta_ovendry(izn),hm_ovendry(izn),         &
                              w0_ovendry(izn),cp0_ovendry(izn),          &
                              ref_dens,gacc)
              end if
            end if
          end do
#ifdef OPENMP
    !$omp end do
#endif  

#ifdef OPENMP
    !$omp barrier
#endif
        else
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif   
          do icell = 1,num_cells             !loop over control volumes
            relpinc(icell) = relperm(icell)
            relpincg(icell) = relpermg(icell)
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif
        end if
      else
#endif
        if (variably_saturated) then
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif   
          do ivol = 1,nngl             !loop over control volumes
              
#ifdef DEBUG
#ifdef PETSC
            ivol_gbl = node_idx_lg2g(ivol)
#else
            ivol_gbl = ivol
#endif
#endif
              
            izn = mpropvs(ivol)
            
            uvsinc(ivol) = uvsnew(ivol) + dinc_vs

            if (.not. b_disable_sat_updt) then
              if (soilhydrfunc_field) then
                call soilprdd(uvsinc(ivol),sainc(ivol),sginc(ivol),    &
                              relpinc(ivol),relpincg(ivol),snnew(ivol),&
                              swr_vol(ivol),aentry_vol(ivol),          &
                              spalpha_vol(ivol),spbeta_vol(ivol),      &
                              expn_vol(ivol),spgamma_vol(ivol),        &
                              napl_permeability,                       &
                              napl_kfunction,sgr,isovendrying(izn),    &
                              beta_ovendry(izn),hm_ovendry(izn),       &
                              w0_ovendry(izn),cp0_ovendry(izn),        &
                              ref_dens,gacc)
              else
                call soilprdd(uvsinc(ivol),sainc(ivol),sginc(ivol),    &
                              relpinc(ivol),relpincg(ivol),snnew(ivol),&
                              swr(izn),aentry(izn),                    &
                              spalpha(izn),spbeta(izn),                &
                              expn(izn),spgamma(izn),                  &
                              napl_permeability,                       &
                              napl_kfunction,sgr,isovendrying(izn),    &
                              beta_ovendry(izn),hm_ovendry(izn),       &
                              w0_ovendry(izn),cp0_ovendry(izn),        &
                              ref_dens,gacc)
              end if
            end if
          end do
#ifdef OPENMP
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif
        else
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif   
          do ivol = 1,nngl             !loop over control volumes
            relpinc(ivol) = relperm(ivol)
            relpincg(ivol) = relpermg(ivol)
          end do
#ifdef OPENMP
    !$omp end do
#endif   

#ifdef OPENMP
    !$omp barrier
#endif
        end if
#ifdef USG
      end if 
#endif
      
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi Build Jacobian matrix 
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
      if (iter_sia==1) then
        delt_loc=delt_tds
      else
        delt_loc=delt
      end if


!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------
#ifdef OPENMP
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic, chunk)
#elif SCHEDULE_STATIC
    !$omp do schedule(static, chunk)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
#endif
      do ivol = 1,nngl
          
#ifdef DEBUG
#ifdef PETSC
        ivol_gbl = node_idx_lg2g(ivol)
#else
        ivol_gbl = ivol
#endif
#endif
 
        if (reactive_transport) then
          actw=gamma(nc,ivol)
        else
          actw=r1
        end if
        
        !cdsu convergence problem if using formula below
        !cdsu need further check, DSU 2020-01-07
        !if (iter_sia==1) then
        !  densnew_ivol = densold(ivol)
        !  densold_ivol = densold2(ivol)
        !  sanew_ivol = saold(ivol)
        !  saold_ivol = saold2(ivol)
        !  tdsnew_ivol = tds_old(ivol)
        !  tdsold_ivol = tds_old2(ivol) 
        !else
        !  densnew_ivol = density(ivol)
        !  densold_ivol = densold(ivol)
        !  sanew_ivol = sanew(ivol)
        !  saold_ivol = saold(ivol)
        !  tdsnew_ivol = tds_new(ivol)
        !  tdsold_ivol = tds_old(ivol)
        !end if

        densnew_ivol = density(ivol)
        densold_ivol = densold(ivol)
        sanew_ivol = sanew(ivol)
        saold_ivol = saold(ivol)
        tdsnew_ivol = tds_new(ivol)
        tdsold_ivol = tds_old(ivol)

        if (ispitzerdens) then
          if (heat_transport) then
            densoldc_ivol = densold_pitzer(ivol)
            densnewc_ivol = density_pitzer(ivol)
          else
            !c density_pitzer is not avaialbe without heat transport
            !c use the following formula which is same as non-pitzer density
            densoldc_ivol = drho_dc*tds_old(ivol)
            densnewc_ivol = drho_dc*tds_new(ivol)
          end if
        else
          densoldc_ivol = r0
          densnewc_ivol = r0
        end if

 
        izn = mpropvs(ivol)                                        ! Zone corresponding to ivol for material properties 

        idiagvspa = iaglob(ivol)                                   ! diagonal pointer dF(Pa)/dPa
        idiagheattemp = iaglob(ivol+nngl)                            ! diagonal pointer dF(T)/dT
        idiagheatpa = iaglob(ivol+nngl) + iavs(ivol+1) - iavs(ivol)  ! diagonal pointer dF(T)/dPa        
        idiagvstemp = iaglob(ivol) + iavs(ivol+1) - iavs(ivol)     ! diagonal pointer dF(Pa)/dT
!cprovi-----------------------------------------------------------
!cprovi Pointers to connected cells
!cprovi-----------------------------------------------------------           
        istart = iavs(ivol)+1                                       
        iend = iavs(ivol+1)-1                                      
!cprovi-----------------------------------------------------------
!cprovi calculate storage and flux terms for current control 
!cprovi volume
!cprovi-----------------------------------------------------------
        vsstor = r0              ! Initialize storage for flow. (DSU 2024-02-07, )
                                 ! This might cause code crash when the variable is used but not initialized.
        totvsflux = r0           ! initialize total flux for flow
        totheatflux = r0         ! initialize total flux for heat 
        icon = 0                 ! counter (connections)

!cprovi---------------------------------------------------------------
!cprovi Loop on connected control volumes
!cprovi---------------------------------------------------------------             
        do i1=istart,iend          !loop over connected control volumes
          
          icon = icon + 1 
!cprovi---------------------------------------------------------------             
!cprovi Column pointer 
!cprovi---------------------------------------------------------------                      
          jvol = javs(i1)       
          
#ifdef USG
          if (discretization_type > 0) then
            ncell = janumcell(i1)
          end if
#endif

!cprovi---------------------------------------------------------------             
!cprovi Initialice vectors for connected cells
!cprovi---------------------------------------------------------------             
          heatflux_a(icon)=r0 
          heatflux_c(icon)=r0 
          heatflux_d(icon)=r0 
          vsflux(icon)=r0  
          if (evaporation) then                                         
            vapflux(icon)=r0  
            vapfluxheat(icon)=r0
            heatflux_v(icon)=r0                                
          end if   
!cprovi---------------------------------------------------------------            
!cprovi compute difference in total presure potential between  
!cprovi current and adjacent control volumes Pjvol - Pivol
!cprovi the distance between cells are in the influence 
!cprovi coefficients 
!cprovi---------------------------------------------------------------  
          del_p(icon) = uvsnew(jvol) - uvsnew(ivol)
          del_z(icon) = zg(jvol) - zg(ivol)

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
            !write(idbg,'(4(a,1x,e16.8,1x))')                          &
            write(idbg,*)                                              &
                   "-->jacdd_energybal->del_p-a->",del_p(icon),        &
                   "uvsivol",uvsnew(ivol),"uvsjvol",uvsnew(jvol),      &
                   "del_z",del_z(icon)
          end if
#endif

!cprovi---------------------------------------------------------------             
!cprovi     
!cprovi---------------------------------------------------------------  
          if (del_z(icon)/=r0) then
!cprovi---------------------------------------------------------------  
!cprovi Compute the average density
!cprovi------------------------------------------------------------
            rho_av = rhalf * (density(ivol) + density(jvol))
            if (av_dens_z) then
              del_p(icon)=rho_av*(uvsnew(jvol)/density(jvol)-uvsnew(ivol)/density(ivol))
            end if

!cprovi---------------------------------------------------------------  
!c  convert del_z to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential
!cprovi---------------------------------------------------------------
            del_z(icon) = del_z(icon) * rho_av * gacc
            del_p(icon) = del_p(icon) + del_z(icon)
          end if

#ifdef DEBUG
          if (info_debug > 10 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
            !write(idbg,'(6(a,1x,e16.8,1x))')                           &
            write(idbg,*)                                              &
                   "-->jacdd_energybal->del_p",del_p(icon),            &
                   "uvsivol",uvsnew(ivol),"uvsjvol",uvsnew(jvol),      &
                   "densivol",density(ivol),"densjvol",density(jvol),  &
                   "del_z",del_z(icon)
          end if
#endif

!cprovi---------------------------------------------------------------  
!c  assign coefficients for upstream weighting of density and viscosity
!c  required for mass flux calculation
!cprovi---------------------------------------------------------------  
!cprovi----------------------------------------------------------------
!cprovi Compute the advective fluxes 
!cprovi----------------------------------------------------------------

          if (b_use_fixed_flow_vel) then
                        
            if (b_use_zero_flow_vel) then
              vsflux(icon) = r0
            else
              !c TBD
            end if
          
          else

#ifdef USG
!c calculate gradient for interface, mid point of edge ivol-jvol
            if (discretization_type > 0) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
              grad_ddflow_mids = vector_zero
              flux_ddflow_hls_corr = r0
              
              if (b_use_cross_diffusion_flow) then
                call gradient_cross_diff_dd(i1,ivol,jvol,              &
                              grad_locs,grad_ddflow_mids,              &
                              grad_weights,flux_ddflow_hls_corr,       &
                              grad_ddflow_hls_loc)
              end if

!c evaporation calculation
              grad_temp_mids = vector_zero
              flux_temp_hls_corr = r0
              if (evaporation) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
                if (b_use_cross_diffusion_heat) then
                  call gradient_cross_diff(i1,ivol,jvol,tempnew,       &
                                grad_locs,grad_temp_mids,              &
                                grad_weights,flux_temp_hls_corr,       &
                                grad_temp_hls_loc)
                end if

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
                grad_flow_mids = vector_zero
                flux_flow_hls_corr = r0
              
                if (b_use_cross_diffusion_flow) then
                  if (split_divdensv) then
                    call gradient_cross_diff(i1,ivol,jvol,uvsnew,     &
                                  grad_locs,grad_flow_mids,           &
                                  grad_weights,flux_flow_hls_corr,    &
                                  grad_flow_hls_loc)
                  else
                    call gradient_cross_diff(i1,ivol,jvol,densvnew,   &
                                  grad_locs,grad_flow_mids,           &
                                  grad_weights,flux_flow_hls_corr,    &
                                  grad_flow_hls_loc)
                  end if
                end if
              
              end if

!cdsu calculate influence coefficient for variable saturated flow
              call usg_face_utility_cinfvs(ivol,jvol,i1,cinfvs_usg_loc,  &
                                           cinfvs_usg_cross_loc)

              if (evaporation) then
                if (split_divdensv) then
                  call usg_face_utility_cinfevap_t(ivol,jvol,i1,         &
                           cinfevap_t_usg_loc,cinfevap_t_usg_cross_loc)
                  call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                           cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
                else
                  call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                           cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
                end if
              end if

              if (isconductive) then
                call usg_face_utility_cinfheat_c(ivol,jvol,i1,           &
                         cinfheat_c_usg_loc,cinfheat_c_usg_cross_loc)
              end if

              if (isdispersive) then
                call usg_face_utility_cinfheat_d(ivol,jvol,i1,           &
                         cinfheat_d_usg_loc,cinfheat_d_usg_cross_loc)
              end if

              relps_loc = 0.0d0
              if (is_cell_based_relp) then
                nrelp = ncell
                do icell = 1, ncell
                  i2 = jacell(icell,i1)
                  if (i2 >0) then
                    relps_loc(icell) = relperm(i2)
                  end if
                end do
              else
                nrelp = 2
                relps_loc(1:2) = (/relperm(ivol),relperm(jvol)/)
              end if

            end if
#endif

#ifdef USG
            if (discretization_type > 0) then

              vsflux(icon) = darcy_energybal_usg(del_p(icon),del_p(icon),           &
                                   num_edge_dvols,ncell,                            &
                                   grad_ddflow_mids(1:num_edge_dvols,1:ncell),      &
                                   flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell),  &
                                   density(ivol),density(jvol),                     &
                                   viscosity(ivol),viscosity(jvol),                 &
                                   is_cell_based_relp,nrelp,relps_loc(1:nrelp),     &
                                   cinfvs_usg_loc(1:num_edge_dvols,1:ncell),        &
                                   cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                                   ups_flow,isboussinesq)

              !if (evaporation) then
              !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
              !  !cdsu this part is not included in energy_bal, 2020-01-03
              !  vsflux(icon) = vsflux(icon) +                                       &
              !                 diff_vapour_usg(tempnew(ivol),tempnew(jvol),         &
              !                      num_edge_dvols,ncell,                           &
              !                      grad_temp_mids(1:num_edge_dvols,1:ncell),       &
              !                      flux_temp_hls_corr(1:num_edge_dvols,1:ncell),   &
              !                      density(ivol),density(jvol),                    &
              !                      pornew(ivol),pornew(jvol),                      &
              !                      sanew(ivol),sanew(jvol),                        &
              !                      cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*       &
              !                                 coeff_t_usg(i1),                     &
              !                      cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)* &
              !                                 coeff_t_usg(i1),                     &
              !                      r1/viscosity(ivol),r1/viscosity(jvol),          &
              !                      r1,ups_flow,.false.)
              !end if

            else
#endif

              vsflux(icon) = darcy_energybal(del_p(icon),del_p(icon),density(ivol),       &
                                             density(jvol),viscosity(ivol),               &
                                             viscosity(jvol),relperm(ivol),relperm(jvol), &
                                             cinfvs_a(i1),ups_flow,isboussinesq)

              !if (evaporation) then
              !  !------------------------------------------------
              !  ! Thermal hydraulic conductivity
              !  ! Noborio et al. (1996)
              !  ! Sakai et al. (2009)
              !  !------------------------------------------------
              !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
              !  !cdsu this part is not included in energy_bal, 2020-01-03
              !  vsflux(icon) = vsflux(icon) +                                             &
              !                 diff_vapour(tempnew(ivol),tempnew(jvol),                   &
              !                             density(ivol),density(jvol),                   &
              !                             pornew(ivol),pornew(jvol),                     &
              !                             sanew(ivol),sanew(jvol),cinfvs_t(i1),          &
              !                             r1/viscosity(ivol),                            &
              !                             r1/viscosity(jvol),                            &
              !                             r1,ups_flow,.false.)
              !end if
#ifdef USG
            end if
#endif
          end if

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx   no fluid flux between them
!cdsu fix bug
          !if (pore_clogging) then
          !  if (pornew(ivol) <= por_thresh_min .or.                    &
          !      pornew(jvol) <= por_thresh_min)  then
          !      vsflux(icon) = r0
          !  end if        
          !end if 
                       
           
!cprovi----------------------------------------------------------------
!cprovi Compute for divergence of fluxes 
!cprovi----------------------------------------------------------------   
          totvsflux = totvsflux + vsflux(icon)

!cprovi----------------------------------------------------------------
!cprovi Compute the vapour diffusiive fluxes 
!cprovi with respect to pressure gradients 
!cprovi and temperature gradients
!cprovi----------------------------------------------------------------                                          
          if (evaporation) then

            tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol),sgnew(ivol),sgnew(jvol))
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vapflux(icon) = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),               &
                                     num_edge_dvols,ncell,                               &
                                     grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                                     flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                                     r1,r1,r1,r1,r1,r1,                                  &
                                     cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                                     cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                     r1,r1,tortuosity,ups_flow,.false.)
                vapflux(icon) = vapflux(icon) +                                          &
                                diff_vapour_usg(tempnew(ivol),tempnew(jvol),             &
                                     num_edge_dvols,ncell,                               &
                                     grad_temp_mids(1:num_edge_dvols,1:ncell),           &
                                     flux_temp_hls_corr(1:num_edge_dvols,1:ncell),       &
                                     r1,r1,r1,r1,r1,r1,                                  &
                                     cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),       &
                                     cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                                     r1,r1,tortuosity,ups_flow,.false.)
              else
                 vapflux(icon) = diff_vapour_usg(densvnew(ivol),densvnew(jvol),          &
                                     num_edge_dvols,ncell,                               &
                                     grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                                     flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                                     r1,r1,r1,r1,r1,r1,                                  &
                                     cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                                     cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                     r1,r1,tortuosity,ups_flow,.false.)
              end if
            else
#endif
              if (split_divdensv) then
                vapflux(icon) = diff_vapour(uvsnew(ivol),uvsnew(jvol),                &
                                     r1,r1,r1,r1,r1,r1,cinfevap_pa(i1),               &
                                     r1,r1,tortuosity,ups_flow,.false.)
                vapflux(icon) = vapflux(icon) +                                       &
                                diff_vapour(tempnew(ivol),tempnew(jvol),              &
                                     r1,r1,r1,r1,r1,r1,cinfevap_t(i1),                &
                                     r1,r1,tortuosity,ups_flow,.false.)
              else
                vapflux(icon) = diff_vapour(densvnew(ivol),densvnew(jvol),            &
                                     r1,r1,r1,r1,r1,r1,cinfevap_pa(i1),               &
                                     r1,r1,tortuosity,ups_flow,.false.)
              end if
#ifdef USG
            end if
#endif
              

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min   .or.                &
            !      pornew(jvol) <= por_thresh_min)  then
            !     vapflux(icon) = r0
            !  end if        
            !end if 
            
            totvsflux = totvsflux + vapflux(icon)

          end if

!c Anna Harrison added qh2o term Jan 24 2014
          if(water_removal .and. transient_flow) then
            totvsflux = totvsflux+qh2o(ivol)/delt
          end if


!cprovi--------------------------------------------------------------------------
!cprovi Energy balance equation 
!cprovi--------------------------------------------------------------------------

!cprovi--------------------------------------------------------------------------
!cprovi Advective term 
!cprovi--------------------------------------------------------------------------          
          if (isadvective) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0,       &
                                            heatcapw,heatcapi,                         &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if

            if (b_use_fixed_flow_vel) then
              
              if (b_use_zero_flow_vel) then
                vsfluxheat(icon) = r0
                heatflux_a(icon) = r0
              else
                !c TBD
              end if
            
            else
#ifdef USG
              if (discretization_type > 0) then
            
                vsfluxheat(icon) = darcy_energybal_usg(del_p(icon),del_p(icon),         &
                                         num_edge_dvols,ncell,                          &
                                         grad_ddflow_mids(1:num_edge_dvols,1:ncell),    &
                                         flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell),&
                                         density(ivol),density(jvol),                   &
                                         viscosity(ivol),viscosity(jvol),               &
                                         is_cell_based_relp,nrelp,relps_loc(1:nrelp),   &
                                         cinfvs_usg_loc(1:num_edge_dvols,1:ncell),      &
                                         cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                         ups_heat,isboussinesq)
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxheat(icon) = vsfluxheat(icon) +                                 &
                !                     diff_vapour_usg(tempnew(ivol),tempnew(jvol),       &
                !                        num_edge_dvols,ncell,                           &
                !                        grad_temp_mids(1:num_edge_dvols,1:ncell),       &
                !                        flux_temp_hls_corr(1:num_edge_dvols,1:ncell),   &
                !                        density(ivol),density(jvol),                    &
                !                        pornew(ivol),pornew(jvol),                      &
                !                        sanew(ivol),sanew(jvol),                        &
                !                        cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*       &
                !                                   coeff_t_usg(i1),                     &
                !                        cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)* &
                !                                   coeff_t_usg(i1),                     &
                !                        r1/viscosity(ivol),r1/viscosity(jvol),          &
                !                        r1,ups_heat,.false.)
                !end if

                if (isboussinesq) then
                  heatflux_a(icon)=fluxheat(tempnew(ivol),tempnew(jvol),ivol,jvol,      &
                                            vsfluxheat(icon),nngl,tempold,              &
                                            i2up,sp_weight_heat,r1,r1)
                else
                  heatflux_a(icon)=heatcapw*relheat_iw*                                 &
                                            fluxheat(tempnew(ivol),tempnew(jvol),       &
                                               ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                               i2up,sp_weight_heat,r1,r1)
                end if


#ifdef DEBUG
                if (info_debug > 11 .and. (ivol_gbl == ivol_track .or.         &
                    ivol_track == 0)) then
                   write(idbg,'(4(a,1x,i6,1x),6(a,1x,e16.8,1x))')              &
                         "-->jacdd_energybal->ivol",ivol,"jvol",jvol,          &
                         "i2upivol",i2up(ivol),"i2upjvol",i2up(jvol),          &
                         "heatflux_a", heatflux_a(icon),                       &
                         "vsfluxheat",vsfluxheat(icon),                        &
                         "tempnivol",tempnew(ivol),"tempnjvol",tempnew(jvol),  &
                         "tempoivol",tempold(ivol),"tempojvol",tempold(jvol)
                end if
#endif

              else
#endif
                vsfluxheat(icon) = darcy_energybal(del_p(icon),del_p(icon),    &
                                         density(ivol),density(jvol),          &
                                         viscosity(ivol),viscosity(jvol),      &
                                         relperm(ivol),relperm(jvol),          &
                                         cinfvs_a(i1),ups_heat,isboussinesq)
  
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxheat(icon) = vsfluxheat(icon) +                                 &
                !                     diff_vapour(tempnew(ivol),tempnew(jvol),           &
                !                          density(ivol),density(jvol),                  &
                !                          pornew(ivol),pornew(jvol),                    &
                !                          sanew(ivol),sanew(jvol),cinfvs_t(i1),         &
                !                          r1/viscosity(ivol),r1/viscosity(jvol),        &
                !                          r1,ups_heat,.false.)
                !end if

                if (isboussinesq) then
                  heatflux_a(icon)=fluxheat(tempnew(ivol),tempnew(jvol),             &
                                            ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                            i2up,sp_weight_heat,                     &
                                            distcells(i1,1),distcells(i1,2))
                else
                  heatflux_a(icon)=heatcapw*relheat_iw*                              &
                                            fluxheat(tempnew(ivol),tempnew(jvol),    &
                                            ivol,jvol,vsfluxheat(icon),nngl,tempold, &
                                            i2up,sp_weight_heat,                     &
                                            distcells(i1,1),distcells(i1,2))
                end if



#ifdef USG
              end if
#endif
            end if
          end if
           
!cprovi--------------------------------------------------------------------------
!cprovi Vapour fluxes 
!cprovi--------------------------------------------------------------------------           

          if (evaporation) then
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vapfluxheat(icon) = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),           &
                                    num_edge_dvols,ncell,                                &
                                    grad_flow_mids(1:num_edge_dvols,1:ncell),            &
                                    flux_flow_hls_corr(1:num_edge_dvols,1:ncell),        &
                                    r1,r1,r1,r1,r1,r1,                                   &
                                    cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),       &
                                    cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                                    r1,r1,tortuosity,ups_heat,.false.)


                vapfluxheat(icon) = vapfluxheat(icon) +                                  &
                                    diff_vapour_usg(tempnew(ivol),tempnew(jvol),         &
                                    num_edge_dvols,ncell,                                &
                                    grad_temp_mids(1:num_edge_dvols,1:ncell),            &
                                    flux_temp_hls_corr(1:num_edge_dvols,1:ncell),        &
                                    r1,r1,r1,r1,r1,r1,                                   &
                                    cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),        &
                                    cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                                    r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxheat(icon)  = diff_vapour_usg(densvnew(ivol),densvnew(jvol),      &
                                     num_edge_dvols,ncell,                               &
                                     grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                                     flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                                     r1,r1,r1,r1,r1,r1,                                  &
                                     cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                                     cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                     r1,r1,tortuosity,ups_heat,.false.)
              end if

              heatflux_v(icon) = heatcapv*fluxheat(tempnew(ivol),tempnew(jvol),          &
                                             ivol,jvol,vapfluxheat(icon),nngl,tempold,   &
                                             i2up,sp_weight_heat,r1,r1)
            else
#endif
              if (split_divdensv) then
                vapfluxheat(icon)  = diff_vapour(uvsnew(ivol),uvsnew(jvol),r1,        &
                                     r1,r1,r1,r1,r1,cinfevap_pa(i1),                  &
                                     r1,r1,tortuosity,ups_heat,.false.)


                vapfluxheat(icon)  = vapfluxheat(icon) + diff_vapour(tempnew(ivol),   &
                                    tempnew(jvol),r1,r1,r1,r1,r1,r1,cinfevap_t(i1),   &
                                    r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxheat(icon)  = diff_vapour(densvnew(ivol),densvnew(jvol),r1,    &
                                    r1,r1,r1,r1,r1,cinfevap_pa(i1),                   &
                                    r1,r1,tortuosity,ups_heat,.false.)
              end if

              heatflux_v(icon)   = heatcapv*fluxheat(tempnew(ivol),tempnew(jvol),     &
                                   ivol,jvol,vapfluxheat(icon),nngl,tempold,          &
                                   i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
#ifdef USG
            end if
#endif

            latvap_av = rhalf*(latvapnew(ivol)+latvapnew(jvol))
                                   
            heatflux_v(icon) = heatflux_v(icon) + latvap_av*vapfluxheat(icon)

            totheatflux = totheatflux +  heatflux_v(icon)

          end if

#ifdef DEBUG
          if (info_debug > 12 .and. (ivol_gbl == ivol_track .or.         &
              ivol_track == 0)) then
             write(idbg,'(3(a,1x,1pe15.6e3,1x))')                        &
                   "-->jacdd_energybal->totheatflux-a", totheatflux
          end if
#endif

!cprovi--------------------------------------------------------------------------
!cprovi Conductive fluxes 
!cprovi--------------------------------------------------------------------------  
          del_temp(icon) = tempnew(jvol) - tempnew(ivol)

          if (isconductive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi, &
                                            uvsnew(ivol))
            end if

            if (isboussinesq) then
               coeff = r1/(heatcapw*relheat_iw*density(ivol))
            else
               coeff = r1
            end if
#ifdef USG
            if (discretization_type > 0) then
              heatflux_c(icon) = - fluxdd_usg(del_temp(icon),                 &
                         num_edge_dvols,ncell,                                &
                         grad_temp_mids(1:num_edge_dvols,1:ncell),            &
                         flux_temp_hls_corr(1:num_edge_dvols,1:ncell),        &
                         cinfheat_c_usg_loc(1:num_edge_dvols,1:ncell),        &
                         cinfheat_c_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                         .false.,1,(/coeff/))

#ifdef DEBUG
#ifdef USG
              if (info_debug > 13 .and. (ivol_gbl == ivol_track .or.         &
                  ivol_track == 0)) then
                 write(idbg,*) "-->jacdd_energybal->heatflux_c",             &
                       heatflux_c(icon), "del_temp", del_temp(icon),         &
                       "num_edge_dvols", num_edge_dvols, "ncell", ncell,     &
                       "coeff", coeff
                 do icell = 1, ncell
                   do idvol = 1, num_edge_dvols
                     write(idbg,*) "icell",icell,"idvol",idvol,              &
                           "grad_temp",grad_temp_mids(idvol,icell)%x,        &
                           grad_temp_mids(idvol,icell)%y,                    &
                           grad_temp_mids(idvol,icell)%z,                    &
                           "flux_temp_hls_corr",                             &
                           flux_temp_hls_corr(idvol,icell),                  &
                           "cinfheat_c_usg_loc",                             &
                           cinfheat_c_usg_loc(idvol,icell),                  &
                           "cinfheat_c_usg_cross_loc",                       &
                           cinfheat_c_usg_cross_loc(idvol,icell)%x,          &
                           cinfheat_c_usg_cross_loc(idvol,icell)%y,          &
                           cinfheat_c_usg_cross_loc(idvol,icell)%z
                   end do
                 end do
              end if
#endif
#endif

            else
#endif
              heatflux_c(icon) = - fluxdd(del_temp(icon),cinfheat_c(i1),coeff)
#ifdef USG
            end if
#endif
          end if
!cprovi--------------------------------------------------------------------------
!cprovi Dispersive fluxes 
!cprovi--------------------------------------------------------------------------                
          if (isdispersive) then
            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(ivol))*0.5d0,       &
                                            heatcapw,heatcapi,                         &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if

#ifdef USG
            if (discretization_type > 0) then
              heatflux_d(icon) = diff_vapour_usg(tempnew(ivol),tempnew(jvol),          &
                                 num_edge_dvols,ncell,                                 &
                                 grad_temp_mids(1:num_edge_dvols,1:ncell),             &
                                 flux_temp_hls_corr(1:num_edge_dvols,1:ncell),         &
                                 density(ivol),density(jvol),pornew(ivol),pornew(jvol),&
                                 sanew(ivol),sanew(jvol),                              &
                                 cinfheat_d_usg_loc(1:num_edge_dvols,1:ncell),         &
                                 cinfheat_d_usg_cross_loc(1:num_edge_dvols,1:ncell),   &
                                 r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
              
            else
#endif
              heatflux_d(icon) = diff_vapour(tempnew(ivol),tempnew(jvol),             &
                                      density(ivol),density(jvol),                    &
                                      pornew(ivol),pornew(jvol),                      &
                                      sanew(ivol),sanew(jvol),                        &
                                      cinfheat_d(i1),r1,r1,heatcapw*relheat_iw,       &
                                      ups_heat,isboussinesq)
#ifdef USG
            end if
#endif
          end if
!cprovi--------------------------------------------------------------------------
!cprovi Add the total fluxes
!cprovi--------------------------------------------------------------------------     
          totheatflux = totheatflux + heatflux_a(icon) + heatflux_c(icon) + heatflux_d(icon)

#ifdef DEBUG
          if (info_debug > 14 .and. (ivol_gbl == ivol_track .or.         &
              ivol_track == 0)) then
             write(idbg,'(6(a,1x,1pe15.6e3,1x))')                        &
                   "-->jacdd_energybal->totheatflux-b", totheatflux,     &
                   "heatflux_a", heatflux_a(icon),                       &
                   "heatflux_c", heatflux_c(icon),                       &
                   "heatflux_d", heatflux_d(icon)
          end if
#endif

        end do                   !loop over connected control volumes
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------

!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
!cprovi----------------------------------------------------------------
        if (transient_flow) then
          if (isstorflow) then
            if (fully_saturated) then
              if (isboussinesq) then
                vsstor = cvol(ivol)*storddfs(delt,delt_loc,            &
                                  pornew(ivol),porold(ivol),           &
                                  sanew_ivol,saold_ivol,r1,r1,         &
                                  r0,r0,r0,r0,r0,r0,r0,r0,r0,r0,r0,    &
                                  new_stor_deri,coupled_porpress,      &
                                  .false.,.true.,.false.,              &
                                  r0,r0,r0,r0)
              else
                vsstor = cvol(ivol)*storddfs(delt,delt_loc,            &
                                  pornew(ivol),porold(ivol),           &
                                  sanew_ivol,saold_ivol,               &
                                  densnew_ivol,densold_ivol,           &
                                  densnewc_ivol,densoldc_ivol,         &
                                  tdsnew_ivol,tdsold_ivol,             &
                                  tempnew(ivol),tempold(ivol),         &
                                  drho_dc,drho_dt,                     &
                                  uvsnew(ivol),uvsold(ivol),           &
                                  stor(ivol),new_stor_deri,            &
                                  coupled_porpress,coupled_drhodt,     &
                                  ispitzerdens,nonlindens_heat,        &
                                  cdens1,cdens2,cdens3,cdens4)

                if (evaporation) then
                  vsstor = vsstor + cvol(ivol)*storevap(delt,r1,       &
                                      r1,sgnew(ivol),sgold(ivol),      &
                                      densvnew(ivol),densvold(ivol),   &
                                      pornew(ivol),porold(ivol),r1)
                end if
              end if
            else if (variably_saturated) then
              vsstor = cvol(ivol)*stordd(delt,delt_loc,                &
                                        pornew(ivol),porold(ivol),     &
                                        sanew_ivol,saold_ivol,         &
                                        densnew_ivol,densold_ivol,     & 
                                        densnewc_ivol,densoldc_ivol,   & 
                                        tdsnew_ivol,tdsold_ivol,       &
                                        tempnew(ivol),tempold(ivol),   &
                                        drho_dc,drho_dt,               &
                                        uvsnew(ivol),uvsold(ivol),     &
                                        stor(ivol),ispitzerdens,       &
                                        new_stor_deri,coupled_porpress,&
                                        coupled_drhodt)

              if (evaporation) then
                vsstor = vsstor + cvol(ivol)*storevap(delt,r1,         &
                                     r1,sgnew(ivol),sgold(ivol),       &
                                     densvnew(ivol),densvold(ivol),    &
                                     pornew(ivol),porold(ivol),r1)
              end if
            end if
          end if
        else
          vsstor = r0
        end if

!cprovi-------------------------------------------------------------
!cprovi assembly of storage and flux terms in rhs vector for 
!cprovi flow equation 
!cprovi-------------------------------------------------------------
        call rhsvs(vsstor,totvsflux,bglob(ivol))

#ifdef DEBUG
        if (info_debug > 15 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
           write(idbg,'(3(a,1x,1pe15.6e3,1x))')                        &
                 "-->jacdd_energybal->rhsvs vsstor",                   &
                 vsstor, "totvsflux",totvsflux, "bglob", bglob(ivol)
        end if
#endif

!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi------------------------------------------------------------- 
        if (b_icewater_heat) then
          relheat_iw = r1
        else
          relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi, &
                                        uvsnew(ivol))
        end if

        if (transient_flow) then
          if (isstorheat) then

            heatstor = cvol(ivol)*storheat(delt,delt_loc,tempnew(ivol),  &
                       tempold(ivol),sanew_ivol,saold_ivol, &
                       densnew_ivol,densold_ivol,densnewc_ivol, &
                       densoldc_ivol,tdsnew_ivol,tdsold_ivol, &
                       drho_dc,drho_dt,denssolid(ivol), &
                       pornew(ivol),porold(ivol),heatcapw*relheat_iw,  &
                       heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                       cdens1,cdens2,cdens3,cdens4)

            !cprovi---------------------------------------------
            !cprovi Add the terms corresponding to evaporation
            !cprovi in the storage of heat equation
            !cprovi---------------------------------------------
            if (evaporation) then
                heatstor = heatstor + cvol(ivol)*storevap(delt,tempnew(ivol),&
                                      tempold(ivol),sgnew(ivol),sgold(ivol), &
                                      densvnew(ivol),densvold(ivol),         &
                                      pornew(ivol),porold(ivol),heatcapv)
                heatstor = heatstor + cvol(ivol)*storevap(delt,latvapnew(ivol),&
                                      latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                      densvnew(ivol),densvold(ivol), &
                                      pornew(ivol),porold(ivol),r1)
            end if

            if (reaction_heat) then
              totsinksource = r0
              do im = 1, nm
                if (cmnew(im,ivol).gt.1d-10) then
                  if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
                      reaction_type(im).eq.'reversible') then
                    totsinksource = totsinksource + r1d3*cvol(ivol)*   &
                                    cal2jou*ratemdp(im,ivol)*dscm(im) 
                  end if 
                end if            
              end do
              heatstor = heatstor + totsinksource
            end if
          end if
        else
          heatstor = r0
        end if
!cprovi-------------------------------------------------------------
!cprovi Store in the residual the total fluxes and storage term  
!cprovi-------------------------------------------------------------  
       
        call rhsvs(heatstor,totheatflux,bglob(nngl+ivol))
          
#ifdef DEBUG
        if (info_debug > 16 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
           write(idbg,'(3(a,1x,1pe15.6e3,1x))')                        &
                 "-->jacdd_energybal->rhsvs heatstor", heatstor,       &
                 "totheatflux", totheatflux, "bglob", bglob(nngl+ivol)
        end if
#endif

!cprovi-------------------------------------------------------------          
!cprovi-------------------------------------------------------------          
!cprovi-------------------------------------------------------------                
                         
                   
!cprovi--------------------------------------------------------------------
!cprovi  If we consider logarithm in unknowns 
!cprovi--------------------------------------------------------------------        
        if (islogunk_energybal) then
          facpa=uvsnew(ivol)
          factemp=tempnew(ivol)
        else   
          facpa=r1
          factemp=r1
        end if

!cprovi--------------------------------------------------------------------
!cprovi increment primary unknown (fluid pressure)
!cprovi If the process is iterative, the increment is a factor of the 
!cprovi fluid pressure 
!cprovi--------------------------------------------------------------------
        dinc_vs_loc = dinc_vs        
        uvsinc(ivol) = uvsnew(ivol) + dinc_vs_loc        
!cprovi--------------------------------------------------------------------
!cprovi Compute increment in temperature 
!cprovi--------------------------------------------------------------------
        dtemp_ivol = dinc_heat           
        tempinc_ivol = tempnew(ivol) + dtemp_ivol                       
!cprovi--------------------------------------------------------------------
!cprovi Compute density and viscosity increment as a function of 
!cprovi temperature increment 
!cprovi Also compute the increment of porosity as a function of
!cprovi Pl
!cprovi 
!cprovi--------------------------------------------------------------------       
        if (ispitzerdens) then
          densinc_ivol = rhonew (ref_dens,density_pitzer(ivol),ref_dens,tempinc_ivol,tempref_dens, &
                                 r1,drho_dt,nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
        else
          densinc_ivol = rhonew (ref_dens,tds_new(ivol),ref_tds,tempinc_ivol,tempref_dens,drho_dc,drho_dt, &
                                 nonlindens_heat,cdens1,cdens2,cdens3,cdens4)
        end if

        dinc_den_loc = densinc_ivol - density(ivol)

        if (update_viscosity_temp) then
            viscoinc_ivol = visconew(densinc_ivol,tds_new(ivol),tempinc_ivol,update_viscosity, &
                            update_viscosity_temp,cvisco1,cvisco2,cvisco3,cvisco4,cvisco5, &
                            tempref_dens,iviscomodel,ref_visco,ref_tds,ref_dens)
        else
            viscoinc_ivol = viscosity(ivol)
        end if

        if (modify_por(ivol)) then
             porinc_ivol = porosity_flow(porold(ivol),uvsinc(ivol),uvsold(ivol),stor(ivol), &
                           por_stress_dt(ivol),por_init(ivol),facpormin)
        else
             porinc_ivol = pornew(ivol)
        end if
!cprovi--------------------------------------------------------------------       
!cprovi Compute the preturbed liquid saturation and relative permeability 
!cprovi as function of liquid pressure 
!cprovi--------------------------------------------------------------------

        !c confusion here, why use soilprdd to calculate relative permeability 
        !c increment but not for regular relative permeability, DSU, 2017-11-15
        if (variably_saturated) then
          izn = mpropvs(ivol)


          !cprovi-----------------------------------------------------------
          !cprovi Compute the perturbations in vapour density
          !cpprovi----------------------------------------------------------
          if (evaporation) then

            if (soilhydrfunc_field) then
              aentry_loc = aentry_vol(ivol)
            else
              aentry_loc = aentry(izn)
            end if

            ! Perturbation in the liquid pressures
            !
            call vapor_prop (densvinc_pa_ivol,dummy1,dummy2,dummy3,dummy4,     &
                             tempnew(ivol),aentry_loc,uvsinc(ivol),           &
                             actw,density(ivol),ivol)
            ! Perturbation in temperature
            !
            call vapor_prop (densvinc_temp_ivol,dummy1,dummy2,dummy3,          &
                             latvapinc_ivol,tempinc_ivol,aentry_loc,          &
                             uvsnew(ivol),actw,densinc_ivol,ivol)

          end if
        else
          sainc(ivol) = sanew(ivol)
        end if
              
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------        
!cprovi--------------------------------------------------------------------        
!c  calculate derivatives of storage and flux terms for current 
!c  control volume (assembly columnwise)
!cprovi--------------------------------------------------------------------        
        dtotvsflux_pa = r0                !initialize derivative of total influx with respect to pressure
        dtotvsflux_temp = r0              !initialize derivative of total influx with respect to temperature 
        dtotheatflux_pa = r0
        dtotheatflux_temp = r0
        icon = 0                          !counter (connections)


        do i1=istart,iend                 !loop over connected control volumes
        
          jvol = javs(i1)                 !column pointer
          
#ifdef USG
          if (discretization_type > 0) then
            ncell = janumcell(i1)
          end if
#endif

          isymvspa = isymglob1(i1)        !symmetry pointer for pa in flow equation 
          isymvstemp = isymglob2(i1)      !symmetry pointer for temp in flow equation 
          isymheatpa = isymglob4(i1)      !symmetry pointer for pa in heat equation
          isymheattemp = isymglob3(i1)    !symmetry pointer for temp in heat equation
          
          icon = icon + 1
          
!cprovi--------------------------------------------------------------------
!cprovi Compute term dF(Pa)/dPa
!cprovi--------------------------------------------------------------------

          del_pinc = uvsnew(jvol) - uvsinc(ivol)

          if (del_z(icon)/=r0.and.av_dens_z) then
            rho_av = rhalf * (density(ivol) + density(jvol))
            del_pinc = rho_av*(uvsnew(jvol)/density(jvol)-uvsinc(ivol)/density(ivol))
          end if

          del_pinc = del_pinc + del_z(icon)

          if (b_use_fixed_flow_vel) then
              
            if (b_use_zero_flow_vel) then
              vsfluxinc = r0
            else
              !c TBD
            end if
          
          else          
#ifdef USG
!c calculate gradient for interface, mid point of edge ivol-jvol
            if (discretization_type > 0) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
              grad_ddflow_inc_mids = vector_zero
              flux_ddflow_inc_hls_corr = r0              

              if (b_use_cross_diffusion_flow) then
                call gradient_cross_diff_dd_inc(i1,ivol,jvol,          &
                     dinc_vs_loc,dinc_den_loc,grad_locs,               &
                     grad_ddflow_inc_mids,grad_weights,                &
                     flux_ddflow_inc_hls_corr,grad_ddflow_hls_loc)
              end if

              grad_temp_inc_mids = vector_zero
              flux_temp_inc_hls_corr = r0
              if (evaporation) then
!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
                
                if (b_use_cross_diffusion_heat) then
                  call gradient_cross_diff_inc(i1,ivol,jvol,dinc_heat, &
                       tempnew,grad_locs,grad_temp_inc_mids,           &
                       grad_weights,flux_temp_inc_hls_corr,            &
                       grad_temp_hls_loc)                  
                end if

!c calculate gradient at the middle of edge and along the control volume face,
!c this part can be further improved for better representation for a boundary volume
                grad_flow_inc_mids = vector_zero
                flux_flow_inc_hls_corr = r0
                
                if (b_use_cross_diffusion_flow) then
                  call gradient_cross_diff_inc(i1,ivol,jvol,dinc_vs,   &
                       uvsnew,grad_locs,grad_flow_inc_mids,            &
                       grad_weights,flux_flow_inc_hls_corr,            &
                       grad_flow_hls_loc) 
                end if
              
              end if

!cdsu calculate influence coefficient for variable saturated flow
              call usg_face_utility_cinfvs(ivol,jvol,i1,cinfvs_usg_loc,  &
                                           cinfvs_usg_cross_loc)

              if (evaporation) then
                if (split_divdensv) then
                  call usg_face_utility_cinfevap_t(ivol,jvol,i1,         &
                           cinfevap_t_usg_loc,cinfevap_t_usg_cross_loc)
                  call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                           cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
                else
                  call usg_face_utility_cinfevap_pa(ivol,jvol,i1,        &
                           cinfevap_pa_usg_loc,cinfevap_pa_usg_cross_loc)
                end if
              end if

              if (isconductive) then
                call usg_face_utility_cinfheat_c(ivol,jvol,i1,           &
                         cinfheat_c_usg_loc,cinfheat_c_usg_cross_loc)
              end if

              if (isdispersive) then
                call usg_face_utility_cinfheat_d(ivol,jvol,i1,           &
                         cinfheat_d_usg_loc,cinfheat_d_usg_cross_loc)
              end if

              relps_loc = 0.0d0
              if (is_cell_based_relp) then
                nrelp = ncell
                do icell = 1, ncell
                  i2 = jacell(icell,i1)
                  if (i2 >0) then
                    relps_loc(icell) = relperm(i2)
                    relpsinc_loc(icell) = relpinc(i2)
                  end if
                end do
              else
                nrelp = 2
                relps_loc(1:2) = (/relperm(ivol),relperm(jvol)/)
                relpsinc_loc(1:2) = (/relpinc(ivol),relperm(jvol)/)
              end if

            end if
#endif
          
!cprovi--------------------------------------------------------------------
!cprovi assembly of flux terms (loop over adjacent control volumes)
!cprovi for steady state and transient conditions
!cprovi flux with incremented variables and derivative of flux
!cprovi--------------------------------------------------------------------
#ifdef USG
            if (discretization_type > 0) then
          
              !c modified in 2020-01-07, using relperm instead of relpinc 
              vsfluxinc = darcy_energybal_usg(del_p(icon),del_pinc,                &
                                num_edge_dvols,ncell,                              &
                                grad_ddflow_inc_mids(1:num_edge_dvols,1:ncell),    &
                                flux_ddflow_inc_hls_corr(1:num_edge_dvols,1:ncell),&
                                density(ivol),density(jvol),                       &
                                viscosity(ivol),viscosity(jvol),                   &
                                is_cell_based_relp,nrelp, relps_loc(1:nrelp),      &
                                cinfvs_usg_loc(1:num_edge_dvols,1:ncell),          &
                                cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),    &
                                ups_flow,isboussinesq)

            else
#endif
              vsfluxinc = darcy_energybal(del_p(icon),del_pinc,                    &
                                          density(ivol),density(jvol),             &
                                          viscosity(ivol),viscosity(jvol),         &
                                          relpinc(ivol),relperm(jvol),             &
                                          cinfvs_a(i1),ups_flow,isboussinesq)
#ifdef USG
            end if
#endif
          end if


!           if (evaporation) then
!              !------------------------------------------------
!              ! Thermal hydraulic conductivity               
!              ! Noborio et al. (1996)
!              ! Sakai et al. (2009)
!              !------------------------------------------------ 
!              !cdsu modified diff_vapour parameters to be consistent with energy_bal
!              !cdsu this part is not included in energy_bal, 2020-01-03  
! #ifdef USG
!             if (discretization_type > 0) then
!               vsfluxinc = vsfluxinc + diff_vapour_usg(                           &
!                              tempnew(ivol),tempnew(jvol),                        &
!                              num_edge_dvols,ncell,                               &
!                              grad_temp_mids(1:num_edge_dvols,1:ncell),           &
!                              flux_temp_hls_corr(1:num_edge_dvols,1:ncell),       &
!                              density(ivol),density(jvol),                        &
!                              pornew(ivol),pornew(jvol),                          &
!                              sainc(ivol),sanew(jvol),                            &
!                              cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*           &
!                                        coeff_t_usg(i1),                          &
!                              cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)*     &
!                                         coeff_t_usg(i1),                         &
!                              r1/viscosity(ivol),r1/viscosity(jvol),              &
!                              r1,ups_flow,.false.)
!             else
! #endif
!               vsfluxinc = vsfluxinc + diff_vapour(tempnew(ivol),tempnew(jvol),   &
!                                            density(ivol),density(jvol),          &
!                                            pornew(ivol),pornew(jvol),            &
!                                            sainc(ivol),sanew(jvol),cinfvs_t(i1), &
!                                            r1/viscosity(ivol),r1/viscosity(jvol),&
!                                            r1,ups_flow,.false.)
! #ifdef USG
!             end if
! #endif
!           end if

          dvsflux = (vsfluxinc - vsflux(icon)) / dinc_vs_loc     
          
!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx   no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
          !if (pore_clogging) then
          !  if (pornew(ivol) <= por_thresh_min   .or.                  &
          !      pornew(jvol) <= por_thresh_min)  then
          !    dvsflux = r0
          !    vsfluxinc = r0
          !  end if        
          !end if            
          
          dtotvsflux_pa = dtotvsflux_pa + dvsflux          
!cprovi--------------------------------------------------------------------
!cprovi assembly of flux terms in jacobian matrix (off diagonal entries)
!cprovi-------------------------------------------------------------------- 
          aglob(isymvspa) = aglob(isymvspa) - facpa * dvsflux   

#ifdef DEBUG
          if (info_debug > 17 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
             write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')        &
                   "jacddfs-A ivol",ivol,"isymvspa",isymvspa,          &
                   "facpa",facpa,"dvsflux",dvsflux,                    &
                   "aglob(isymvspa)",aglob(isymvspa)
          end if
#endif
          
          
          if (evaporation) then  
          
            tortuosity = tortuosity_vap(pornew(ivol),pornew(jvol),sgnew(ivol),sgnew(jvol))

            tortinc = tortuosity_vap(porinc_ivol,pornew(jvol),sginc(ivol),sgnew(jvol))
             
            if (split_divdensv) then
!cprovi--------------------------------------------------------------------        
!cprovi Add the vapor diffusion induced by pressure gradients
!cprovi--------------------------------------------------------------------
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = diff_vapour_usg(uvsinc(ivol),uvsnew(jvol),           &
                            num_edge_dvols,ncell,                                &
                            grad_flow_inc_mids(1:num_edge_dvols,1:ncell),        &
                            flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),    &
                            r1,r1,r1,r1,r1,r1,                                   &
                            cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),       &
                            cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                            r1,r1,tortinc,ups_flow,.false.)
              else
#endif
                vsfluxinc = diff_vapour(uvsinc(ivol),uvsnew(jvol),r1, &
                                 r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                                 r1,r1,tortinc,ups_flow,.false.)
#ifdef USG
              end if
#endif

#ifdef DEBUG
              if (info_debug > 18 .and. (ivol_gbl == ivol_track .or.   &
                ivol_track == 0)) then
                 write(idbg,'(3(a,1x,i6,1x),5(a,1x,1pe15.6e3,1x))')    &
                       "jacddfs-B1 ivol",ivol,"jvol",jvol,"i1",i1,     &
                       "uvsinc(ivol)",uvsinc(ivol),                    &
                       "uvsnew(jvol)",uvsnew(jvol),                    &
                       "cinfevap_pa(i1)",cinfevap_pa(i1),              &
                       "tortinc",tortinc,"ups_flow",ups_flow
              end if
#endif    
!cprovi--------------------------------------------------------------------        
!cprovi Add the vapor diffusion induced by temperature gradients
!cprovi--------------------------------------------------------------------
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = vsfluxinc +                                        &
                            diff_vapour_usg(tempnew(ivol),tempnew(jvol),       &
                            num_edge_dvols,ncell,                              &
                            grad_temp_mids(1:num_edge_dvols,1:ncell),          &
                            flux_temp_hls_corr(1:num_edge_dvols,1:ncell),      &
                            r1,r1,r1,r1,r1,r1,                                 &
                            cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),      &
                            cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                            r1,r1,tortinc,ups_flow,.false.)
              else
#endif
                vsfluxinc = vsfluxinc +                                        &
                            diff_vapour(tempnew(ivol),tempnew(jvol),           &
                            r1,r1,r1,r1,r1,r1,cinfevap_t(i1),r1,r1,            &
                            tortinc,ups_flow,.false.)
#ifdef USG
              end if
#endif

#ifdef DEBUG
              if (info_debug > 19 .and. (ivol_gbl == ivol_track .or.   &
                  ivol_track == 0)) then
                write(idbg,'(3(a,1x,i6,1x),5(a,1x,1pe15.6e3,1x))')     &
                      "jacddfs-B2 ivol",ivol,"jvol",jvol,"i1",i1,      &
                      "tempnew(ivol)",tempnew(ivol),                   &
                      "tempnew(jvol))",tempnew(jvol),                  &
                      "cinfevap_t(i1)",cinfevap_t(i1),                 &
                      "tortinc",tortinc,"ups_flow",ups_flow
              end if
#endif
            else
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = diff_vapour_usg(densvinc_pa_ivol,densvnew(jvol),    &
                            num_edge_dvols,ncell,                               &
                            grad_flow_inc_mids(1:num_edge_dvols,1:ncell),       &
                            flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                            r1,r1,r1,r1,r1,r1,                                  &
                            cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                            cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                            r1,r1,tortinc,ups_flow,.false.)
              else
#endif
                vsfluxinc = diff_vapour(densvinc_pa_ivol,densvnew(jvol),r1, &
                            r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                            r1,r1,tortinc,ups_flow,.false.)
#ifdef USG
              end if
#endif

#ifdef DEBUG
              if (info_debug > 20 .and. (ivol_gbl == ivol_track .or.  &
                  ivol_track == 0)) then
                    write(idbg,'(3(a,1x,i6,1x),4(a,1x,1pe15.6e3,1x))')&
                          "jacddfs-B3 ivol",ivol,"jvol",jvol,"i1",i1, &
                          "densvinc_pa_ivol",densvinc_pa_ivol,        &
                          "densvnew(jvol)",densvnew(jvol),            &
                          "tortinc",tortinc,"ups_flow",ups_flow
              end if
#endif

            end if
            dvsflux = (vsfluxinc - vapflux(icon)) / dinc_vs_loc
#ifdef DEBUG
            if (info_debug > 20 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-B0 ivol",ivol,"icon",icon,                &
                    "vsfluxinc",vsfluxinc,"dinc_vs_loc",dinc_vs_loc,   &
                    "vapflux(icon)",vapflux(icon)
            end if
#endif
             
!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min .or.                  &
            !      pornew(jvol) <= por_thresh_min)  then
            !    dvsflux = r0
            !    vsfluxinc = r0
            !  end if        
            !end if  

            aglob(isymvspa) = aglob(isymvspa) - facpa * dvsflux

#ifdef DEBUG
            if (info_debug > 21 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-B ivol",ivol,"isymvspa",isymvspa,         &
                    "facpa",facpa,"dvsflux",dvsflux,                   &
                    "aglob(isymvspa)",aglob(isymvspa)
            end if
#endif
            dtotvsflux_pa = dtotvsflux_pa + dvsflux
          
          end if

!cprovi--------------------------------------------------------------------
!cprovi End of Computing term dF(Pa)/dPa
!cprovi--------------------------------------------------------------------
          
          !c skip computing term df(Pa)/dT and df(T)/dPa if flow and heat are loosely coupled
          if (decoupled_type_vs_heat > 0) then
            goto 100
          end if
          
!cprovi--------------------------------------------------------------------
!cprovi Compute term df(Pa)/dT
!cprovi--------------------------------------------------------------------                              
          del_p(icon) = uvsnew(jvol) - uvsnew(ivol)
          del_z(icon) = zg(jvol) - zg(ivol)

          if (del_z(icon)/=r0) then
            rho_av = rhalf * (densinc_ivol + density(jvol))
            if (av_dens_z) then
              del_p(icon)=rho_av*(uvsnew(jvol)/density(jvol)-uvsnew(ivol)/densinc_ivol)
            end if

            del_z(icon) = del_z(icon) * rho_av * gacc
            del_p(icon) = del_p(icon) + del_z(icon)
          end if
          
          if (b_use_fixed_flow_vel) then
              
            if (b_use_zero_flow_vel) then
              vsfluxinc = r0
            else
              !c TBD
            end if
          
          else
#ifdef USG
            if (discretization_type > 0) then
              vsfluxinc = darcy_energybal_usg(del_p(icon),del_p(icon),         &
                                num_edge_dvols,ncell,                          &
                                grad_ddflow_mids(1:num_edge_dvols,1:ncell),    &
                                flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell),&
                                densinc_ivol,density(jvol),                    &
                                viscoinc_ivol,viscosity(jvol),                 &
                                is_cell_based_relp,nrelp,relps_loc(1:nrelp),   &
                                cinfvs_usg_loc(1:num_edge_dvols,1:ncell),      &
                                cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                                ups_flow,isboussinesq)
            else
#endif
              vsfluxinc = darcy_energybal(del_p(icon),del_p(icon),             &
                                          densinc_ivol,density(jvol),          &
                                          viscoinc_ivol,viscosity(jvol),       &
                                          relperm(ivol),relperm(jvol),         &
                                          cinfvs_a(i1),ups_flow,isboussinesq)
#ifdef USG
            end if
#endif

!           if (evaporation) then
!              !------------------------------------------------
!              ! Thermal hydraulic conductivity               
!              ! Noborio et al. (1996)
!              ! Sakai et al. (2009)
!              !------------------------------------------------  
!              !cdsu modified diff_vapour parameters to be consistent with energy_bal
!              !cdsu this part is not included in energy_bal, 2020-01-03 
! #ifdef USG
!             if (discretization_type > 0) then
!               vsfluxinc = vsfluxinc + diff_vapour_usg(                             &
!                             tempinc_ivol,tempnew(jvol),                            &
!                             num_edge_dvols,ncell,                                  &
!                             grad_temp_inc_mids(1:num_edge_dvols,1:ncell),          &
!                             flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),      &
!                             densinc_ivol,density(jvol),pornew(ivol),pornew(jvol),  &
!                             sanew(ivol),sanew(jvol),                               &
!                             cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*              &
!                                        coeff_t_usg(i1),                            &
!                             cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)*        &
!                                        coeff_t_usg(i1),                            &
!                             r1/viscoinc_ivol,r1/viscosity(jvol),r1,ups_flow,.false.)
!             else
! #endif
!               vsfluxinc = vsfluxinc + diff_vapour(tempinc_ivol,tempnew(jvol),      &
!                                       densinc_ivol,density(jvol),                  &
!                                       pornew(ivol),pornew(jvol),                   &
!                                       sanew(ivol),sanew(jvol),                     &
!                                       cinfvs_t(i1),r1/viscoinc_ivol,               &
!                                       r1/viscosity(jvol),r1,ups_flow,.false.)
! #ifdef USG
!             end if
! #endif
!           end if
          end if

          dvsflux = (vsfluxinc - vsflux(icon)) / dtemp_ivol
        
          
          
!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx   no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
          !if (pore_clogging) then
          !  if (pornew(ivol) <= por_thresh_min .or.                    &
          !      pornew(jvol) <= por_thresh_min)  then
          !    dvsflux = r0
          !    vsfluxinc = r0
          !  end if        
          !end if  
          

          aglob(isymvstemp) = aglob(isymvstemp) - factemp * dvsflux 

#ifdef DEBUG
          if (info_debug > 22 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
            write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')         &
                  "jacddfs-C ivol",ivol,"isymvstemp",isymvstemp,       &
                  "factemp",factemp,"dvsflux",dvsflux,                 &
                  "aglob(isymvstemp)",aglob(isymvstemp)
          end if
#endif
          
          dtotvsflux_temp = dtotvsflux_temp + dvsflux 
!cprovi--------------------------------------------------------------------
!cprovi Introduce terms corresponding to vapour
!cprovi Temperature perturbation  
!cprovi--------------------------------------------------------------------
          if (evaporation) then  
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vsfluxinc = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),           &
                             num_edge_dvols,ncell,                               &
                             grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                             flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             r1,r1,tortuosity,ups_flow,.false.)

                vsfluxinc = vsfluxinc +                                          &
                            diff_vapour_usg(tempinc_ivol,tempnew(jvol),          &
                            num_edge_dvols,ncell,                                &
                            grad_temp_inc_mids(1:num_edge_dvols,1:ncell),        &
                            flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),    &
                            r1,r1,r1,r1,r1,r1,                                   &
                            cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),        &
                            cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell),  &
                            r1,r1,tortuosity,ups_flow,.false.)

              else
                vsfluxinc = diff_vapour_usg(densvinc_temp_ivol,densvnew(jvol),   &
                             num_edge_dvols,ncell,                               &
                             grad_flow_inc_mids(1:num_edge_dvols,1:ncell),       &
                             flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             r1,r1,tortuosity,ups_flow,.false.)
              end if
            else
#endif
              if (split_divdensv) then
                vsfluxinc = diff_vapour(uvsnew(ivol),uvsnew(jvol),r1, &
                            r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)
                          
                vsfluxinc = vsfluxinc + diff_vapour(tempinc_ivol,tempnew(jvol), &
                            r1,r1,r1,r1,r1,r1,cinfevap_t(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)            
                          
              else
                vsfluxinc = diff_vapour(densvinc_temp_ivol,densvnew(jvol),r1, &
                            r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                            r1,r1,tortuosity,ups_flow,.false.)              
              end if
#ifdef USG
            end if
#endif

            dvsflux = (vsfluxinc - vapflux(icon)) / dtemp_ivol 
#ifdef DEBUG
            if (info_debug > 23 .and. (ivol_gbl == ivol_track .or.     &
              ivol_track == 0)) then
                   write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')  &
                         "jacddfs-D0 ivol",ivol,"icon",icon,           &
                         "vsfluxinc",vsfluxinc,"dtemp_ivol",dtemp_ivol,&
                         "vapflux(icon)",vapflux(icon)
            end if
#endif

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min   .or.                &
            !      pornew(jvol) <= por_thresh_min)  then
            !    dvsflux = r0
            !    vsfluxinc = r0
            !  end if        
            !end if  
            aglob(isymvstemp) = aglob(isymvstemp) - factemp * dvsflux
#ifdef DEBUG
            if (info_debug > 24 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-D ivol",ivol,"isymvstemp",isymvstemp,     &
                    "factemp",factemp,"dvsflux",dvsflux,               &
                    "aglob(isymvstemp)",aglob(isymvstemp)
            end if
#endif
            dtotvsflux_temp = dtotvsflux_temp + dvsflux                     
                
          end if  

100       continue

!cprovi--------------------------------------------------------------------
!cprovi End of Computing term dF(Pa)/dT
!cprovi--------------------------------------------------------------------

!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa and df(T)/dT
!cprovi--------------------------------------------------------------------        
          dtemp_ivol_jvol = tempnew(jvol) - tempinc_ivol
          por_av = rhalf * (pornew(ivol) + pornew(jvol))
          sa_av = rhalf * (sanew(ivol) + sanew(jvol))

          if (isadvective) then

            if (decoupled_type_vs_heat > 0) then
              goto 200
            end if
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa
!cprovi Perturbation in the advective term 
!cprovi--------------------------------------------------------------------   
            
            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if

            if (b_use_fixed_flow_vel) then
              
              if (b_use_zero_flow_vel) then
                vsfluxinc = r0
                heatfluxinc = r0
              else
                !c TBD
              end if
            
            else
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = darcy_energybal_usg(del_p(icon),del_pinc,             &
                               num_edge_dvols,ncell,                              &
                               grad_ddflow_inc_mids(1:num_edge_dvols,1:ncell),    &
                               flux_ddflow_inc_hls_corr(1:num_edge_dvols,1:ncell),&
                               density(ivol),density(jvol),                       &
                               viscosity(ivol),viscosity(jvol),                   &
                               !is_cell_based_relp,nrelp,relpsinc_loc(1:nrelp),    &
                               is_cell_based_relp,nrelp,relps_loc(1:nrelp),       &
                               cinfvs_usg_loc(1:num_edge_dvols,1:ncell),          &
                               cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell),    &
                               ups_heat,isboussinesq)
                             
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxinc = vsfluxinc +                                          &
                !              diff_vapour_usg(tempnew(ivol),tempnew(jvol),         &
                !                   num_edge_dvols,ncell,                           &
                !                   grad_temp_mids(1:num_edge_dvols,1:ncell),       &
                !                   flux_temp_hls_corr(1:num_edge_dvols,1:ncell),   &
                !                   density(ivol),density(jvol),                    &
                !                   pornew(ivol),pornew(jvol),                      &
                !                   sainc(ivol),sanew(jvol),                        &
                !                   cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*       &
                !                              coeff_t_usg(i1),                     &
                !                   cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)* &
                !                              coeff_t_usg(i1),                     &
                !                   r1/viscosity(ivol),r1/viscosity(jvol),          &
                !                   r1,ups_heat,.false.)
                !
                !end if
             

                if (isboussinesq) then
                  heatfluxinc=fluxheat(tempnew(ivol),tempnew(jvol),ivol,jvol,          &
                                       vsfluxinc,nngl,tempold,                         &
                                       i2up,sp_weight_heat,r1,r1)
                else
                  heatfluxinc=heatcapw*relheat_iw*                                     &
                                       fluxheat(tempnew(ivol),tempnew(jvol),ivol,jvol, &
                                                vsfluxinc,nngl,tempold,                &
                                                i2up,sp_weight_heat,r1,r1)
                end if

              else
#endif
                vsfluxinc = darcy_energybal(del_p(icon),del_pinc,                         &
                                            density(ivol),density(jvol),viscosity(ivol),  &
                                            viscosity(jvol),relpinc(ivol),relperm(jvol),  &
                                            cinfvs_a(i1),ups_heat,isboussinesq)
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxinc = vsfluxinc + diff_vapour(tempnew(ivol),tempnew(jvol),        &
                !                               density(ivol),density(jvol),               &
                !                               pornew(ivol),pornew(jvol),                 &
                !                               sainc(ivol),sanew(jvol),                   &
                !                               cinfvs_t(i1),r1/viscosity(ivol),           &
                !                               r1/viscosity(jvol),r1,ups_heat,.false.)
                !
                !end if

                if (isboussinesq) then
                  heatfluxinc=fluxheat(tempnew(ivol), &
                              tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                              i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                else
                  heatfluxinc=heatcapw*relheat_iw*fluxheat(tempnew(ivol), &
                              tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                              i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                end if
#ifdef USG
              end if
#endif
            end if

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx   no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min .or.                  &
            !      pornew(jvol) <= por_thresh_min)  then
            !    vsfluxinc = r0
            !  end if        
            !end if  

            dheatflux = (heatfluxinc - heatflux_a(icon)) / dinc_vs_loc
            aglob(isymheatpa) = aglob(isymheatpa) - facpa * dheatflux

#ifdef DEBUG
            if (info_debug > 25 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-E ivol",ivol,"isymheatpa",isymheatpa,     &
                    "facpa",facpa,"dheatflux",dheatflux,               &
                    "aglob(isymheatpa)",aglob(isymheatpa)
            end if
#endif
            dtotheatflux_pa = dtotheatflux_pa + dheatflux

200         continue

!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi Perturbation in the advective term 
!cprovi--------------------------------------------------------------------

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if

            if (b_use_fixed_flow_vel) then
                          
              if (b_use_zero_flow_vel) then
                vsfluxinc = r0
                heatfluxinc = r0
              else
                !c TBD
              end if
            
            else
#ifdef USG
              if (discretization_type > 0) then
                vsfluxinc = darcy_energybal_usg(del_p(icon),del_p(icon),          &
                                  num_edge_dvols,ncell,                           &
                                  grad_ddflow_mids(1:num_edge_dvols,1:ncell),     &
                                  flux_ddflow_hls_corr(1:num_edge_dvols,1:ncell), &
                                  densinc_ivol,density(jvol),                     &
                                  viscoinc_ivol,viscosity(jvol),                  &
                                  is_cell_based_relp,nrelp,relps_loc(1:nrelp),    &
                                  cinfvs_usg_loc(1:num_edge_dvols,1:ncell),       &
                                  cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                                  ups_heat,isboussinesq)
                
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxinc = vsfluxinc +                                         &
                !              diff_vapour_usg(tempinc_ivol,tempnew(jvol),         &
                !                 num_edge_dvols,ncell,                            &
                !                 grad_temp_inc_mids(1:num_edge_dvols,1:ncell),    &
                !                 flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),&
                !                 densinc_ivol,density(jvol),                      &
                !                 pornew(ivol),pornew(jvol),                       &
                !                 sainc(ivol),sanew(jvol),                         &
                !                 cinfvs_usg_loc(1:num_edge_dvols,1:ncell)*        &
                !                            coeff_t_usg(i1),                      &
                !                 cinfvs_usg_cross_loc(1:num_edge_dvols,1:ncell)*  &
                !                            coeff_t_usg(i1),                      &
                !                 r1/viscoinc_ivol,r1/viscosity(jvol),             &
                !                 r1,ups_heat,.false.)
                !
                !end if
  
                if (isboussinesq) then
                  heatfluxinc=fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,              &
                                       vsfluxinc,nngl,tempold,                            &
                                       i2up,sp_weight_heat,r1,r1)
                else
                  heatfluxinc=heatcapw*relheat_iw*                                        &
                                       fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,     &
                                                vsfluxinc,nngl,tempold,                   &
                                                i2up,sp_weight_heat,r1,r1)
                end if
              else
#endif
                vsfluxinc = darcy_energybal(del_p(icon),del_p(icon),                      &
                                            densinc_ivol,density(jvol),viscoinc_ivol,     &
                                            viscosity(jvol),relperm(ivol),relperm(jvol),  &
                                            cinfvs_a(i1),ups_heat,isboussinesq)
  
                !if (evaporation) then
                !  !------------------------------------------------
                !  ! Thermal hydraulic conductivity
                !  ! Noborio et al. (1996)
                !  ! Sakai et al. (2009)
                !  !------------------------------------------------
                !  !cdsu modified diff_vapour parameters to be consistent with energy_bal
                !  !cdsu this part is not included in energy_bal, 2020-01-03
                !  vsfluxinc = vsfluxinc + diff_vapour(tempinc_ivol,tempnew(jvol),         &
                !                               densinc_ivol,density(jvol),                &
                !                               pornew(ivol),pornew(jvol),                 &
                !                               sainc(ivol),sanew(jvol),cinfvs_t(i1),      &
                !                               r1/viscoinc_ivol,r1/viscosity(jvol),       &
                !                               r1,ups_heat,.false.)
                !end if
  
                if (isboussinesq) then
                      heatfluxinc=fluxheat(tempinc_ivol, &
                                  tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                  i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                else
                      heatfluxinc=heatcapw*relheat_iw*fluxheat(tempinc_ivol, &
                                  tempnew(jvol),ivol,jvol,vsfluxinc,nngl,tempold, &
                                  i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
                end if
#ifdef USG
              end if
#endif
            end if

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min .or.                  &
            !      pornew(jvol) <= por_thresh_min)  then
            !    vsfluxinc = r0
            !  end if        
            !end if  
             
            dheatflux = (heatfluxinc - heatflux_a(icon)) / dtemp_ivol
            aglob(isymheattemp) = aglob(isymheattemp) -factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 26 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-F ivol",ivol,"isymheattemp",isymheattemp, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aglob(isymheattemp)",aglob(isymheattemp)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux

          end if ! isadvective


!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi Perturbation in the conductive term 
!cprovi--------------------------------------------------------------------         
          if (isconductive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi,   &
                                            uvsnew(ivol))
            end if

            if (isboussinesq) then
              coeff = r1/(heatcapw*relheat_iw*densinc_ivol)
            else
              coeff = r1
            end if
#ifdef USG
            if (discretization_type > 0) then
              heatfluxinc = -fluxdd_usg(dtemp_ivol_jvol,num_edge_dvols,ncell,   &
                             grad_temp_inc_mids(1:num_edge_dvols,1:ncell),      &
                             flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),  &
                             cinfheat_c_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfheat_c_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             .false.,1,(/coeff/))
            else
#endif
              heatfluxinc = - fluxdd(dtemp_ivol_jvol,cinfheat_c(i1),coeff)
#ifdef USG
            end if
#endif

            dheatflux = (heatfluxinc-heatflux_c(icon)) / dtemp_ivol

#ifdef DEBUG
#ifdef USG
            if (info_debug > 27 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,*) "jacddfs-G0 ivol",ivol,                    &
                    "dheatflux",dheatflux,"heatfluxinc",heatfluxinc,   &
                    "dtemp_ivol_jvol",dtemp_ivol_jvol,"coeff",coeff
              do icell = 1, ncell
                do idvol = 1, num_edge_dvols
                  write(idbg,*) "-->jacdd_energybal-G0 icell",icell,   &
                        "idvol",idvol,"grad_temp_inc_mids",            &
                        grad_temp_inc_mids(idvol,icell)%x,             &
                        grad_temp_inc_mids(idvol,icell)%y,             &
                        grad_temp_inc_mids(idvol,icell)%z,             &
                        "flux_temp_inc_hls_corr",                      &
                        flux_temp_inc_hls_corr(idvol,icell),           &
                        "cinfheat_c_usg_loc",                          &
                        cinfheat_c_usg_loc(idvol,icell),               &
                        "cinfheat_c_usg_cross_loc",                    &
                        cinfheat_c_usg_cross_loc(idvol,icell)%x,       &
                        cinfheat_c_usg_cross_loc(idvol,icell)%y,       &
                        cinfheat_c_usg_cross_loc(idvol,icell)%z
                end do
              end do
            end if
#endif
#endif
            aglob(isymheattemp) = aglob(isymheattemp) - factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 28 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-G ivol",ivol,"isymheattemp",isymheattemp, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aglob(isymheattemp)",aglob(isymheattemp)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux

          end if  ! isconductive
          
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa and df(T)/dT
!cprovi Perturbation in the dispersive term 
!cprovi--------------------------------------------------------------------                
          if (isdispersive) then

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing((tempnew(ivol)+tempnew(jvol))*0.5d0, &
                                            heatcapw,heatcapi,                   &
                                            (uvsnew(ivol)+uvsnew(jvol))*0.5d0)
            end if
!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dT
!cprovi--------------------------------------------------------------------           
#ifdef USG
            if (discretization_type > 0) then
              heatfluxinc = diff_vapour_usg(tempinc_ivol,tempnew(jvol),         &
                            num_edge_dvols,ncell,                               &
                            grad_temp_inc_mids(1:num_edge_dvols,1:ncell),       &
                            flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                            densinc_ivol,density(jvol),                         &
                            pornew(ivol),pornew(jvol),sanew(ivol),sanew(jvol),  &
                            cinfheat_d_usg_loc(1:num_edge_dvols,1:ncell),       &
                            cinfheat_d_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                            r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
            else
#endif
              heatfluxinc = diff_vapour(tempinc_ivol,tempnew(jvol),densinc_ivol,&
                                        density(jvol),pornew(ivol),pornew(jvol),&
                                        sanew(ivol),sanew(jvol),cinfheat_d(i1), &
                                        r1,r1,heatcapw*relheat_iw,              &
                                        ups_heat,isboussinesq)
#ifdef USG
            end if
#endif

            dheatflux = (heatfluxinc-heatflux_d(icon)) / dtemp_ivol
            aglob(isymheattemp) = aglob(isymheattemp) - factemp * dheatflux

#ifdef DEBUG
            if (info_debug > 29 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-H ivol",ivol,"isymheattemp",isymheattemp, &
                    "factemp",factemp,"dheatflux",dheatflux,           &
                    "aglob(isymheattemp)",aglob(isymheattemp)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dheatflux

!cprovi--------------------------------------------------------------------
!cprovi Compute Term df(T)/dPa
!cprovi--------------------------------------------------------------------

            if (decoupled_type_vs_heat > 0) then
              goto 300
            end if
            
#ifdef USG
            if (discretization_type > 0) then
              heatfluxinc = diff_vapour_usg(tempnew(ivol),tempnew(jvol),       &
                            num_edge_dvols,ncell,                              &
                            grad_temp_mids(1:num_edge_dvols,1:ncell),          &
                            flux_temp_hls_corr(1:num_edge_dvols,1:ncell),      &
                            density(ivol),density(jvol),                       &
                            porinc_ivol,pornew(jvol),sainc(ivol),sanew(jvol),  &
                            cinfheat_d_usg_loc(1:num_edge_dvols,1:ncell),      &
                            cinfheat_d_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                            r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
            else
#endif
              heatfluxinc = diff_vapour(tempnew(ivol),tempnew(jvol),density(ivol),&
                                  density(jvol),porinc_ivol,pornew(jvol),         &
                                  sainc(ivol),sanew(jvol),cinfheat_d(i1),         &
                                  r1,r1,heatcapw*relheat_iw,ups_heat,isboussinesq)
#ifdef USG
            end if
#endif

            dheatflux = (heatfluxinc-heatflux_d(icon)) / dinc_vs_loc
            aglob(isymheatpa) = aglob(isymheatpa) - facpa * dheatflux

#ifdef DEBUG
            if (info_debug > 30 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-I ivol",ivol,"isymheatpa",isymheatpa,     &
                    "facpa",facpa,"dheatflux",dheatflux,               &
                    "aglob(isymheatpa)",aglob(isymheatpa)
            end if
#endif
            dtotheatflux_pa = dtotheatflux_pa + dheatflux

300         continue 
                       
          end if   ! isdispersive
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------
!cprovi--------------------------------------------------------------------          
!cprovi-------------------------------------------------------------------------- 
!cprovi--------------------------------------------------------------------------
          if (evaporation) then
#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                vapfluxinc = diff_vapour_usg(uvsnew(ivol),uvsnew(jvol),          &
                             num_edge_dvols,ncell,                               &
                             grad_flow_mids(1:num_edge_dvols,1:ncell),           &
                             flux_flow_hls_corr(1:num_edge_dvols,1:ncell),       &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                             r1,r1,tortuosity,ups_heat,.false.)
                vapfluxinc = vapfluxinc +                                        &
                             diff_vapour_usg(tempinc_ivol,tempnew(jvol),         &
                             num_edge_dvols,ncell,                               &
                             grad_temp_inc_mids(1:num_edge_dvols,1:ncell),       &
                             flux_temp_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                             r1,r1,r1,r1,r1,r1,                                  &
                             cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),       &
                             cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                             r1,r1,tortuosity,ups_heat,.false.)
                              
              else
                vapfluxinc = diff_vapour_usg(densvinc_temp_ivol,densvnew(jvol),   &
                             num_edge_dvols,ncell,                                &
                             grad_flow_inc_mids(1:num_edge_dvols,1:ncell),        &
                             flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),    &
                             r1,r1,r1,r1,r1,r1,                                   &
                             cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),       &
                             cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                             r1,r1,tortuosity,ups_heat,.false.)
              end if
              heatfluxinc = heatcapv*fluxheat(tempinc_ivol,tempnew(jvol),ivol,jvol,     &
                                        vapfluxinc,nngl,tempold,                        &
                                        i2up,sp_weight_heat,r1,r1)
            else
#endif
              if (split_divdensv) then
                vapfluxinc   = diff_vapour(uvsnew(ivol),uvsnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)
                vapfluxinc = vapfluxinc + diff_vapour(tempinc_ivol,tempnew(jvol),r1, &
                              r1,r1,r1,r1,r1,cinfevap_t(i1), &
                              r1,r1,tortuosity,ups_heat,.false.)
              else
                vapfluxinc   = diff_vapour(densvinc_temp_ivol,densvnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortuosity,ups_heat,.false.)
              end if
              heatfluxinc = heatcapv*fluxheat(tempinc_ivol, &
                            tempnew(jvol),ivol,jvol,vapfluxinc,nngl,tempold, &
                            i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
#ifdef USG
            end if
#endif

            latvap_av = rhalf*(latvapinc_ivol+latvapnew(jvol))

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min .or.                  &
            !      pornew(jvol) <= por_thresh_min)  then
            !    vapfluxinc = r0
            !  end if        
            !end if 
            
            heatfluxinc   = heatfluxinc + latvap_av*vapfluxinc

            dvsflux = (heatfluxinc - heatflux_v(icon)) / dtemp_ivol
            aglob(isymheattemp) = aglob(isymheattemp) - factemp * dvsflux

#ifdef DEBUG
            if (info_debug > 31 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-J ivol",ivol,"isymheattemp",isymheattemp, &
                    "factemp",factemp,"dvsflux",dvsflux,               &
                    "aglob(isymheattemp)",aglob(isymheattemp)
            end if
#endif
            dtotheatflux_temp = dtotheatflux_temp + dvsflux

           !cprovi--------------------------------------------------------------------
           !cprovi--------------------------------------------------------------------
           !cprovi--------------------------------------------------------------------
           !cprovi--------------------------------------------------------------------------
           !cprovi Compute dF(T) / d Pa
           !cprovi Porosity is function of Pa in the dispersive term
           !cprovi--------------------------------------------------------------------------

            if (decoupled_type_vs_heat > 0) then
              goto 400
            end if

#ifdef USG
            if (discretization_type > 0) then
              if (split_divdensv) then
                 vapfluxinc = diff_vapour_usg(uvsinc(ivol),uvsnew(jvol),          &
                              num_edge_dvols,ncell,                               &
                              grad_flow_inc_mids(1:num_edge_dvols,1:ncell),       &
                              flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                              r1,r1,r1,r1,r1,r1,                                  &
                              cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                              cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                              r1,r1,tortinc,ups_heat,.false.)

                 vapfluxinc = vapfluxinc +                                        &
                              diff_vapour_usg(tempnew(ivol),tempnew(jvol),        &
                              num_edge_dvols,ncell,                               &
                              grad_temp_mids(1:num_edge_dvols,1:ncell),           &
                              flux_temp_hls_corr(1:num_edge_dvols,1:ncell),       &
                              r1,r1,r1,r1,r1,r1,                                  &
                              cinfevap_t_usg_loc(1:num_edge_dvols,1:ncell),       &
                              cinfevap_t_usg_cross_loc(1:num_edge_dvols,1:ncell), &
                              r1,r1,tortinc,ups_heat,.false.)
               else
                 vapfluxinc = diff_vapour_usg(densvinc_pa_ivol,densvnew(jvol),    &
                              num_edge_dvols,ncell,                               &
                              grad_flow_inc_mids(1:num_edge_dvols,1:ncell),       &
                              flux_flow_inc_hls_corr(1:num_edge_dvols,1:ncell),   &
                              r1,r1,r1,r1,r1,r1,                                  &
                              cinfevap_pa_usg_loc(1:num_edge_dvols,1:ncell),      &
                              cinfevap_pa_usg_cross_loc(1:num_edge_dvols,1:ncell),&
                              r1,r1,tortinc,ups_heat,.false.)
               end if

               heatfluxinc=heatcapv*fluxheat(tempnew(ivol),tempnew(jvol),ivol,jvol,   &
                                             vapfluxinc,nngl,tempold,                 &
                                             i2up,sp_weight_heat,r1,r1)
            else
#endif
              if (split_divdensv) then
                 vapfluxinc  = diff_vapour(uvsinc(ivol),uvsnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortinc,ups_heat,.false.)

                 vapfluxinc = vapfluxinc + diff_vapour(tempnew(ivol),tempnew(jvol),r1, &
                              r1,r1,r1,r1,r1,cinfevap_t(i1), &
                              r1,r1,tortinc,ups_heat,.false.)
               else
                 vapfluxinc  = diff_vapour(densvinc_pa_ivol,densvnew(jvol),r1, &
                               r1,r1,r1,r1,r1,cinfevap_pa(i1), &
                               r1,r1,tortinc,ups_heat,.false.)
               end if

               heatfluxinc=heatcapv*fluxheat(tempnew(ivol), &
                           tempnew(jvol),ivol,jvol,vapfluxinc,nngl,tempold, &
                            i2up,sp_weight_heat,distcells(i1,1),distcells(i1,2))
#ifdef USG
            end if
#endif
                           
            latvap_av = rhalf*(latvapnew(ivol)+latvapnew(jvol))

!cmx  Check pore clogging condition, either ivol or jvol is clogged
!cmx  no fluid flux between them
!cdsu fix bug, comment to avoid setting matrix diag entry to zero
            !if (pore_clogging) then
            !  if (pornew(ivol) <= por_thresh_min .or.                  &
            !      pornew(jvol) <= por_thresh_min)  then
            !    vapfluxinc = r0
            !  end if        
            !end if  
            
            heatfluxinc   = heatfluxinc + latvap_av*vapfluxinc

            dvsflux = (heatfluxinc - heatflux_v(icon)) / dinc_vs_loc
            aglob(isymheatpa) = aglob(isymheatpa) - facpa * dvsflux

#ifdef DEBUG
            if (info_debug > 32 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-K ivol",ivol,"isymheatpa",isymheatpa,     &
                    "facpa",facpa,"dvsflux",dvsflux,                   &
                    "aglob(isymheatpa)",aglob(isymheatpa)
            end if
#endif
           dtotheatflux_pa = dtotheatflux_pa + dvsflux

400        continue
              
          end if    !evaporation
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
!cprovi-------------------------------------------------------------------------- 
        end do                  !loop over connected control volumes

!c  compute storage term with incremented variables (lumped) 
!c  for current control volume, only for transient conditions

       
        aglob(idiagheattemp) = aglob(idiagheattemp) + factemp * dtotheatflux_temp

#ifdef DEBUG
        if (info_debug > 33 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
          write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')           &
                "jacddfs-L ivol",ivol,"idiagheattemp",idiagheattemp,   &
                "factemp",factemp,"dvsfluxdtotheatflux_temp",          &
                dtotheatflux_temp,                                     &
                "aglob(idiagheattemp)",aglob(idiagheattemp)
        end if
#endif 
        if (isadvective.or.isdispersive.or.evaporation) then   
          if (decoupled_type_vs_heat == 0) then
            aglob(idiagheatpa) = aglob(idiagheatpa) + facpa * dtotheatflux_pa
          end if

#ifdef DEBUG
          if (info_debug > 34 .and. (ivol_gbl == ivol_track .or.       &
              ivol_track == 0)) then
            write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')         &
                  "jacddfs-M ivol",ivol,"idiagheatpa",idiagheatpa,     &
                  "facpa",facpa,"dtotheatflux_pa",dtotheatflux_pa,     &
                  "aglob(idiagheatpa)",aglob(idiagheatpa)
          end if
#endif
        end if 
          
        aglob(idiagvspa) = aglob(idiagvspa) + facpa * dtotvsflux_pa 

#ifdef DEBUG
        if (info_debug > 35 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
          write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')           &
                "jacddfs-N ivol",ivol,"idiagvspa",idiagvspa,           &
                "facpa",facpa,"dtotvsflux_pa",dtotvsflux_pa,           &
                "aglob(idiagvspa)",aglob(idiagvspa)
        end if
#endif
        
        if (decoupled_type_vs_heat == 0) then
          aglob(idiagvstemp) = aglob(idiagvstemp) + factemp * dtotvsflux_temp
        end if

#ifdef DEBUG
        if (info_debug > 36 .and. (ivol_gbl == ivol_track .or.         &
            ivol_track == 0)) then
          write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')           &
                "jacddfs-O ivol",ivol,"idiagvstemp",idiagvstemp,       &
                "factemp",factemp,"dtotvsflux_temp",dtotvsflux_temp,   &
                "aglob(idiagvstemp)",aglob(idiagvstemp)
        end if
#endif

        if (transient_flow) then
          if (isstorflow) then
            if (fully_saturated) then
              if (isboussinesq) then
                vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,        &
                                        porinc_ivol,porold(ivol),      &
                                        sainc(ivol),saold_ivol,        &
                                        r1,r1,r0,r0,r0,r0,r0,r0,       &
                                        r0,r0,r0,r0,r0,                &
                                        new_stor_deri,coupled_porpress,&
                                        .false.,ispitzerdens,.false.,  &
                                        r0,r0,r0,r0)
              else
                vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,        &
                                        porinc_ivol,porold(ivol),      &
                                        sainc(ivol),saold_ivol,        &
                                        densnew_ivol,densold_ivol,     &
                                        densnewc_ivol,densoldc_ivol,   &
                                        tdsnew_ivol,tdsold_ivol,       &                                        
                                        tempnew(ivol),tempold(ivol),   &
                                        drho_dc,drho_dt,               &
                                        uvsinc(ivol),uvsold(ivol),     &
                                        stor(ivol),new_stor_deri,      &
                                        coupled_porpress,              &
                                        coupled_drhodt,                &
                                        ispitzerdens,nonlindens_heat,  &
                                        cdens1,cdens2,cdens3,cdens4)
                if (evaporation) then
                      vsstorinc = vsstorinc + cvol(ivol)*storevap(     &
                                  delt,r1,r1,sginc(ivol),sgold(ivol),  &
                                  densvinc_pa_ivol,densvold(ivol),     &
                                  porinc_ivol,porold(ivol),r1)
                end if
              end if
            else if (variably_saturated) then
              vsstorinc = cvol(ivol)* stordd(delt,delt_loc,            &
                                      porinc_ivol,porold(ivol),        &
                                      sainc(ivol),saold_ivol,          &
                                      densnew_ivol,densold_ivol,       &
                                      densnewc_ivol,densoldc_ivol,     &
                                      tdsnew_ivol,tdsold_ivol,         &
                                      tempnew(ivol),tempold(ivol),     &
                                      drho_dc,drho_dt,                 &
                                      uvsinc(ivol),uvsold(ivol),       &
                                      stor(ivol),ispitzerdens,         &
                                      new_stor_deri,coupled_porpress,  &
                                      coupled_drhodt)
              if (evaporation) then
                    vsstorinc = vsstorinc + cvol(ivol)*storevap(delt,r1, &
                                r1,sginc(ivol),sgold(ivol),&
                                densvinc_pa_ivol,densvold(ivol), &
                                porinc_ivol,porold(ivol),r1)
              end if
            end if

            !cprovi-------------------------------------------------------------
            !cprovi-------------------------------------------------------------
            !cprovi-------------------------------------------------------------
            dvsstor = (vsstorinc - vsstor)/dinc_vs_loc
            aglob(idiagvspa) = aglob(idiagvspa) + facpa * dvsstor

#ifdef DEBUG
            if (info_debug > 37 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-P ivol",ivol,"idiagvspa",idiagvspa,       &
                    "facpa",facpa,"dvsstor",dvsstor,                   &
                    "aglob(idiagvspa)",aglob(idiagvspa)
            end if
#endif

            if (fully_saturated) then
              if (isboussinesq) then
                vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,        &
                                        pornew(ivol),porold(ivol),     &
                                        sanew_ivol,saold_ivol,         &
                                        r1,r1,r0,r0,r0,r0,             &
                                        r0,r0,r0,r0,r0,r0,r0,          &
                                        new_stor_deri,coupled_porpress,&
                                        .false.,ispitzerdens,.false.,  &
                                        r0,r0,r0,r0)
              else
                vsstorinc = cvol(ivol)* storddfs(delt,delt_loc,        &
                                        pornew(ivol),porold(ivol),     &
                                        sanew_ivol,saold_ivol,        &
                                        densinc_ivol,densold(ivol),    &
                                        densnewc_ivol,densoldc_ivol,   &
                                        tdsnew_ivol,tdsold_ivol,       &                                        
                                        tempinc_ivol,tempold(ivol),    &
                                        drho_dc,drho_dt,               &
                                        uvsinc(ivol),uvsold(ivol),     &
                                        stor(ivol),new_stor_deri,      &
                                        coupled_porpress,              &
                                        coupled_drhodt,                &
                                        ispitzerdens,nonlindens_heat,  &
                                        cdens1,cdens2,cdens3,cdens4)
                if (evaporation) then
                  vsstorinc = vsstorinc + cvol(ivol)*storevap(         &
                              delt,r1,r1,sgnew(ivol),sgold(ivol),      &
                              densvinc_temp_ivol,densvold(ivol),       &
                              pornew(ivol),porold(ivol),r1)
                end if
              end if
            else if (variably_saturated) then 
              vsstorinc = cvol(ivol)* stordd(delt,delt_loc,            &
                                      pornew(ivol),porold(ivol),       &
                                      sanew_ivol,saold_ivol,           &
                                      densinc_ivol,densold(ivol),      &  !c to be further checked: densnew_ivol,densold_ivol,       &
                                      densnewc_ivol,densoldc_ivol,     &
                                      tdsnew_ivol,tdsold_ivol,         &
                                      tempinc_ivol,tempold(ivol),      &
                                      drho_dc,drho_dt,                 &
                                      uvsinc(ivol),uvsold(ivol),       &
                                      stor(ivol),ispitzerdens,         &
                                      new_stor_deri,coupled_porpress,  &
                                      coupled_drhodt)
              if (evaporation) then
                vsstorinc = vsstorinc + cvol(ivol)*storevap(           &
                            delt,r1,r1,sgnew(ivol),sgold(ivol),        &
                            densvinc_temp_ivol,densvold(ivol),         &
                            pornew(ivol),porold(ivol),r1)
              end if
            end if
        
            dvsstor = (vsstorinc - vsstor)/dtemp_ivol

            if (decoupled_type_vs_heat == 0) then
              aglob(idiagvstemp) = aglob(idiagvstemp) + factemp * dvsstor
            end if

#ifdef DEBUG
            if (info_debug > 38 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-Q ivol",ivol,"idiagvstemp",idiagvstemp,   &
                    "factemp",factemp,"dvsstor",dvsstor,               &
                    "aglob(idiagvstemp)",aglob(idiagvstemp)
            end if
#endif
         
          end if 
!cprovi-------------------------------------------------------------          
!cprovi Compute the energy balance storage term for ivol 
!cprovi-------------------------------------------------------------          
          if (isstorheat) then 

            if (b_icewater_heat) then
              relheat_iw = r1
            else
              relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi,   &
                                            uvsnew(ivol))
            end if

            heatstorinc = cvol(ivol)*storheat(delt,delt_loc,tempinc_ivol, &
                         tempold(ivol),sanew_ivol,saold_ivol, &
                         densinc_ivol,densold(ivol),densnewc_ivol, &
                         densoldc_ivol,tdsnew_ivol,tdsold_ivol,drho_dc, &
                         drho_dt,denssolid(ivol), & 
                         pornew(ivol),porold(ivol),heatcapw*relheat_iw, &
                         heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                         cdens1,cdens2,cdens3,cdens4) 
            if (evaporation) then   
           
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,tempinc_ivol, &
                                             tempold(ivol),sgnew(ivol),sgold(ivol), &
                                             densvinc_temp_ivol,densvold(ivol), &
                                             pornew(ivol),porold(ivol), &
                                             heatcapv)
                 heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,latvapinc_ivol, &
                                             latvapold(ivol),sgnew(ivol),sgold(ivol), &
                                             densvinc_temp_ivol,densvold(ivol),pornew(ivol), &
                                             porold(ivol),r1)                                             
            end if  
            if (reaction_heat) then
              totsinksourceinc = r0
              do im = 1, nm
                if (cmnew(im,ivol).gt.1d-10) then
                  if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
                      reaction_type(im).eq.'reversible') then
                    totsinksourceinc = totsinksourceinc + r1d3*cvol(ivol)* &
                                       cal2jou*ratemdp(im,ivol)*dscm(im) 
                  end if
                end if            
              end do
              heatstorinc = heatstorinc + totsinksourceinc
            end if
            
            !cprovi-------------------------------------------------------------          
            !cprovi Compute d F(Temp) / d Temp corresponding to storage term
            !cprovi-------------------------------------------------------------                             
            dheatstor = (heatstorinc - heatstor) / dtemp_ivol
            aglob(idiagheattemp) = aglob(idiagheattemp) + factemp * dheatstor

#ifdef DEBUG
            if (info_debug > 39 .and. (ivol_gbl == ivol_track .or.       &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')         &
                    "jacddfs-R ivol",ivol,"idiagheattemp",idiagheattemp, &
                    "factemp",factemp,"dheatstor",dheatstor,             &
                    "aglob(idiagheattemp)",aglob(idiagheattemp)
            end if
#endif                              
                              
            heatstorinc = cvol(ivol)*storheat(delt,delt_loc,tempnew(ivol), & 
                          tempold(ivol),sainc(ivol),saold(ivol), &
                          density(ivol),densold(ivol),densnewc_ivol, &
                          densoldc_ivol,tdsnew_ivol,tdsold_ivol, &
                          drho_dc,drho_dt,denssolid(ivol), & 
                          porinc_ivol,porold(ivol),heatcapw*relheat_iw, &
                          heatcaps(ivol),ispitzerdens,nonlindens_heat, &
                          cdens1,cdens2,cdens3,cdens4)
                              
            if (evaporation) then   
           
              heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,tempnew(ivol), &
                                          tempold(ivol),sginc(ivol),sgold(ivol), &
                                          densvinc_pa_ivol,densvold(ivol), &
                                          porinc_ivol,porold(ivol), &
                                          heatcapv)
              heatstorinc = heatstorinc + cvol(ivol)*storevap(delt,latvapnew(ivol), &
                                          latvapold(ivol),sginc(ivol),sgold(ivol), &
                                          densvinc_pa_ivol,densvold(ivol),porinc_ivol, &
                                          porold(ivol),r1)

            end if ! evaporation

            if (reaction_heat) then
              totsinksourceinc = r0
              do im = 1, nm
                if (cmnew(im,ivol).gt.1d-10) then
                  if (reaction_type(im).eq.'dissolution_far_from_equilibrium'.or.&
                      reaction_type(im).eq.'reversible') then
                    totsinksourceinc = totsinksourceinc + r1d3*cvol(ivol)* &
                                       cal2jou*ratemdp(im,ivol)*dscm(im) 
                  end if  
                end if           
              end do
              heatstorinc = heatstorinc + totsinksourceinc
            end if
           
            !cprovi-------------------------------------------------------------          
            !cprovi Compute d F(Temp) / d Pa corresponding to storage term
            !cprovi-------------------------------------------------------------                                       
            dheatstor = (heatstorinc - heatstor) / dinc_vs_loc
            if (decoupled_type_vs_heat == 0) then
              aglob(idiagheatpa) = aglob(idiagheatpa) + facpa * dheatstor
            end if
#ifdef DEBUG
            if (info_debug > 40 .and. (ivol_gbl == ivol_track .or.     &
                ivol_track == 0)) then
              write(idbg,'(2(a,1x,i6,1x),3(a,1x,1pe15.6e3,1x))')       &
                    "jacddfs-S ivol",ivol,"idiagheatpa",idiagheatpa,   &
                    "facpa",facpa,"dheatstor",dheatstor,               &
                    "aglob(idiagheatpa)",aglob(idiagheatpa)
            end if
#endif       
          end if   ! isstorheat                    

        end if     ! transient flow

!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                            
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------                    
!cprovi------------------------------------------------------------- 
#ifdef DEBUG
        if (isdebug) then
            write(idbg,*) '---------------------------------------------------------------'
            write(idbg,*) 'Iteration:',iter_glob
            write(idbg,*) '---------------------------------------------------------------'
            write(idbg,'(a15,2i6,1pe15.6e3)') 'idiagvspa',ivol,idiagvspa,aglob(idiagvspa)
            do i1=istart,iend
              isymvspa = isymglob1(i1)
              jvol=javs(i1)
              write (idbg,'(i6,1pe15.6e3)') jvol, aglob(isymvspa)
            end do
            write(idbg,'(a15,2i6,1pe15.6e3)') 'idiagvstemp',ivol,idiagvstemp,aglob(idiagvstemp)
            do i1=istart,iend
              jvol=javs(i1)
              isymvstemp = isymglob2(i1)
             write (idbg,'(i6,1pe15.6e3)') jvol, aglob(isymvstemp)
            end do
            write(idbg,'(a15,2i6,1pe15.6e3)') 'idiagheatpa',ivol,idiagheatpa,aglob(idiagheatpa)
            do i1=istart,iend
               jvol=javs(i1)

               isymheatpa = isymglob3(i1)

             write (idbg,'(i6,1pe15.6e3)') jvol, aglob(isymheatpa)
            end do
            write(idbg,'(a15,2i6,1pe15.6e3)') 'idiagheattemp',ivol,idiagheattemp,aglob(idiagheattemp)
            do i1=istart,iend

              jvol=javs(i1)

              isymheattemp = isymglob4(i1)
             write (idbg,'(i6,1pe15.6e3)') jvol, aglob(isymheattemp)
            end do
        end if
#endif    
    
      end do
      
#ifdef OPENMP
    !$omp end do
#endif

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef OPENMP
    !$omp end parallel
#endif
      
!10 continue   

      return
      end subroutine
