!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/updtetp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtetp
!c -------------------
!c
!c update etp and canopy dependent variables 
!c
!c written by:      Frederic Gerard 
!c
!c last modified:   Celine Blitz Frayret (CBF) for Fr�d�ric G�rard (FG) - December 14, 2018
!c            updates in the comments of the variables and removed the use of phys
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c
!c gen.f:    real*8:
!c           -------
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical 
!c                                parameters internal time units      
!c           tfinal             = final solution time                 + -
!c           time_factor        = conversion factor from I/O time     + -
!c                                units to internal time units
!c           time_io            = current solution time (I/O units)   + -
!c          
!c 
!c           integer*4:
!c           ----------
!c           ilog               = unit number - logbok file           + -
!c           isoi               = unit number - soil specific         + - 
!c                                parameters
!c     
!c biol.F90: real*8:
!c           -------
!c           pet                = potential evapotranspiration        * +
!c           pe_soil            = potential soil evaporation          * +
!c           scale_tree_growth  = scale factor to account for the influence
!c                                of tree growth on transpiration
!c           canopy_int         = canopy interception                 * +
!c           time_soi           = next read time for etp specific    * +
!c                                parameters
!c           solar_ratio        = ratio between the solar energy at the forest floor
!c                                and this above tree canopy 
!c
!c         logical:
!c         --------
!c           pure_evap          = .true.  -> pure evaporation 
!c                        (when root_uptake = false) CBF
!c
!c local:    real*8:
!c           -------
!c           tiny               = small increment
!c
!c external: -
!c ----------------------------------------------------------------------
    subroutine updtetp
 
      use parm
      use gen
      use biol
    
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif   

      real*8, parameter :: r0 = 0.0d0, tiny = 1.d-10
      
!cdsu to be consistent with other update, do not use ge below.
      if (time_io.gt.time_soi) then

 !c  read file containing time dependent parameters for root water uptake
 !c  and physical evap
 
        read(isoi,*,err=998,end=997) time_soi,pet,canopy_int,    &
                                     solar_ratio,scale_tree_growth

!FG June 2021 - calculate pe_soil and potential transpiration (tpot)
!FG August 2021 - variable + conversions in m3/s (toparea)
!cdsu add legacy root uptake, which is consistent with old root water uptake


        if (root_uptake_legacy) then

          if (.not.vegetation_growth) then

            pet = pet*toparea*sec_per_days
          
            pe_soil = pet*solar_ratio

            canopy_int = canopy_int*toparea*sec_per_days

          else

            pet = pet*toparea*sec_per_days*scale_tree_growth
          
            pe_soil = pet*solar_ratio

            canopy_int = canopy_int*toparea*sec_per_days*scale_tree_growth

          end if

          tpot = pet - pe_soil - canopy_int * canopy_evap_factor 

          if (tpot .lt. r0) then
            
            tpot = r0
            
          end if

        else

          if (.not.vegetation_growth) then 

            pe_soil = pet*solar_ratio  ! get potential evaporation from potential evapotranspiration (m/s)
          
            tpot = pet-pe_soil-canopy_int*canopy_evap_factor  ! get potential transpiration (m/s) from energy balance 
            
            pe_soil = pe_soil*toparea*solar_ratio*sec_per_days  !potential evaporation scaled up according to solar ratio (surface effect) and converted in m3/s
          
            tpot = tpot*toparea*(1-solar_ratio)*sec_per_days  !potential transpiration scaled up according to solar ratio (surface effect) and converted in m3/s
            
          else !growing vegetation=>scale_tree_growth taken into account for splitting between evapo and transpiration as well as surface area variations.
            
            pe_soil = pet*(1-scale_tree_growth)  ! get potential evaporation from potential evapotranspiration (m/s)
            
            tpot = pet-pe_soil-canopy_int*canopy_evap_factor  ! get potential transpiration (m/s) from energy balance
          
            pe_soil = pe_soil*toparea*(1-scale_tree_growth)*sec_per_days  !potential evaporation scaled up according to scale_tree_growth (surface effect) and converted in m3/s*
          
            tpot = tpot*toparea*scale_tree_growth*sec_per_days  !potential transpiration scaled up according to scale_tree_growth (surface effect) and converted in m3/s
          
          endif
          
        end if
        
        
        if (rank == 0 .and. b_enable_output) then
          write (*,*) 'PET etc. UPDATE'
          write (ilog,*) 'PET etc. UPDATE'
        end if
     
        return

!c  assign next read time greater than final solution time, if no more
!c  read times left and return
!cdsu replace 1.1*tfinal since tfinal can be negative

997     time_soi = (tfinal+1.0d100)/time_factor

        return

998     continue
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED' 
          write(ilog,*) 'error reading file ', prefix(:l_prfx)//'.soi'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
        
      end if ! check for time

      return

      end

