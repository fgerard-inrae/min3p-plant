!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/surfcomp.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine surfcomp
!c -------------------
!c
!c compute surface composition based on equilibrated solution
!c composition
!c
!c written by:      Uli Mayer - March 18, 2000
!c
!c last modified:   - 
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           cnew(nc)           = concentrations of free species      + +
!c                                - new time level [moles/l water]
!c           sw                 = water saturation                    + -
!c           por                = porosity                            + -
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number - logbook               + -
!c
!c common:   
!c chem.f:   real*8:
!c           -------
!c           alc(nc-1,nc-1,nthreads) 
!c                              = Jacobian matrix                * +
!c           blc(nc-1,nthreads) = rhs-vector                          * +
!c           cec(nthreads)      = cation exchange capacity (meq/100g) + -
!c           csb(nsb)           = concentrations of sorbed species    * +
!c                                - new time level
!c           csb_ion(nsb_ion,nthreads) 
!c                              = concentrations of sorbed species    * +
!c                                - new time level (ion-exchange)
!c           csb_surf(nsb_surf,nthreads) 
!c                              = concentrations of sorbed species    * +
!c                                - new time level (surface-complex)
!c           eqsb(nsb)          = equilibrium constants for           + -
!c                                sorbed species
!c           eqsb_ion(nsb_ion,nthreads)  
!c                              = equilibrium constants for           + -
!c                                sorbed species (ion-exchange)
!c           eqsb_surf(nsb_surf,nthreads)
!c                              = equilibrium constants for           + -
!c                                sorbed species (surface-complex)
!c           gammac(nc)         = activity coefficients of components * *
!c                                as species in solution
!c           totcn(n,nthreads)  = total component concentrations      + +
!c                                - new time level [moles/l water]  
!c           xnusb(nsb*nc)      = stoichiometric coefficient matrix   + -
!c                                for formation of sorbed species
!c                                from components
!c           xnusb_ion(nsb_ion*nc)
!c                              = stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (ion-exchange)
!c           xnusb_surf(nsb_surf*nc)
!c                              = stoichiometric coefficient matrix + -
!c                                for formation of sorbed species
!c                                from components (surface-complex)
!c
!c           integer*4:
!c           ----------
!c           iaic(nsites)       = pointer array for compressed        + -
!c                                storage of surface site data
!c           iasb(nsb+1)        = row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           iasb_ion(nsb_ion+1)= row pointer array to                + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           iasb_surf(nsb_surf+1)= row pointer array to              + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           iter_lc(nthreads)  = iteration counter                   * +
!c                                (local chemistry)
!c           ittot_lc(nthreads) = total number of iterations          + +
!c                                (local chemistry)
!c           jasb(nsb*nc)       = column pointer array to             + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c           jasb_ion(nsb_ion*nc)= column pointer array to            + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (ion-exchange)
!c           jasb_surf(nsb_surf*nc)= column pointer array to          + -
!c                                stoichiometric coefficients of
!c                                components in sorbed species
!c                                (surface-complex)
!c           maxit_lc           = max. number of iterations           + -
!c                                (local chemistry)
!c           nc                 = number of components including h2o  + -
!c           nopu               = number of primary unknowns          + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c           nsites             = number of surface sites             + -
!c
!c           character:
!c           ----------
!c           sorption_group     = 'ion-exchange'                      + -
!c                                'surface-complexation'
!c                                'undefined'
!c           sorption_type      = 'gaines-thomas'                     + -
!c                                'gapon'
!c                                'surface-complex'
!c                                'constant-capacitance'
!c
!c local:    integer*4:
!c           ----------
!c           ic                 = counter (components)
!c           isb                = counter (sorbed species)
!c           isites             = counter (surface sites)
!c
!c           logical:
!c           --------
!c           not_converged      = .true.  -> continue Newtion 
!c                                           iteration
!c
!c           character:
!c           ----------
!c           zone_name          = name of zone
!c
!c external: jacsurf   = construct jacobian matrix and rhs-vector
!c                       (composition of surface sites)
!c           simq      = solves system of n linear equations
!c                       by Gaussian elimination
!c           sorbspc   = compute concentration of sorbed species
!c           updtsurf  = update solution vector
!c                       (composition of surface sites)
!c ----------------------------------------------------------------------
 
      subroutine surfcomp(cnew,gammac,sw,por,ilog,tid)
 
      use parm
      use chem
      use gen, only : rank, b_enable_output
      !use math_common, only : math_common_linear_norm

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      real*8 :: cnew, gammac, sw, por
      
      integer :: ilog, tid
      
      integer :: ic, isb, isites
      
      real*8 :: dummy
      
      external simq, sorbspc
      
      logical not_converged, over_flow_lc

      character*72 zone_name 

      dimension cnew(*),gammac(*)

      !real*8 :: alc_bk(nc-1,nc-1), blc_bk(nc-1), rnorm
      
      external jacsurf, updtsurf
      
!c  initialize local parameters

      zone_name = 'computing composition on surface sites'
    !  write(ilog,'(/a/72a/)') zone_name,('-',i=1,72)

!c  explicit solution for ion-exchange reactions

      if (implicit_surface_ion .and. nsb_ion.gt.0) then
          
        do isb = 1,nsb_ion
            call sorbspc_m(csb_ion(isb,tid),dummy,cec(tid),           &
                 cec_fraction(idx_nsites_ion(isb)),                   &
                 eqsb_ion(:,tid),eqsb_surf(:,tid),                    &
                 gammac,cnew,xnusb_ion,xnusb_surf,                    &
                 iasb_ion,iasb_surf,jasb_ion,jasb_surf,               &
                 nsb_ion,nsb_surf,isb,0,                              &
                 sorption_type_ion,sorption_type_surf,                &
                 sorption_group,isactcexch)
        end do
        
      end if  

!c  implicit solution for surface-complexation reactions

      if (implicit_surface_surf .and. nsb_surf.gt.0) then

!c  start Newton iteration
 
        iter_lc(tid) = 0
        over_flow_lc = .false.
        not_converged = .true.

        do while (not_converged) 

          if (iter_lc(tid).lt.maxit_lc) then

            iter_lc(tid) = iter_lc(tid)+1
            ittot_lc(tid) = ittot_lc(tid)+1

!c  construct Jacobian matrix and rhs-vector 

            call jacsurf(cnew,gammac,sw,por,tid)

!c  solve for update
!c  linear solver type of local chemistry, 0 - Gaussian (default), 1 - QR, 2 - SVD
            if (linear_solver_lc == 0) then
              !c check rnorm of the solver
              !alc_bk(1:nc-1,1:nc-1) = alc(1:nc-1,1:nc-1,tid)
              !blc_bk(1:nc-1) = blc(1:nc-1,tid)
              
              call simq(alc(1:nc-1,1:nc-1,tid),blc(1:nc-1,tid),nopu,nc-1)  

              !rnorm = math_common_linear_norm(nc-1,alc_bk,blc_bk,blc(:,tid))             

            else if (linear_solver_lc == 1) then
#ifdef GPL
              call qr_solve(nc-1,nc-1,alc(1:nc-1,1:nc-1,tid),blc(1:nc-1,tid),xlc(1:nc-1,tid))
              blc(1:nc-1,tid) = xlc(1:nc-1,tid)
#endif
            else if (linear_solver_lc == 2) then
#ifdef GPL
              call svd_solve(nc-1,nc-1,alc(1:nc-1,1:nc-1,tid),blc(1:nc-1,tid), xlc(1:nc-1,tid)) 
              blc(1:nc-1,tid) = xlc(1:nc-1,tid)
#endif
            end if
 
!c  update solution vector
            call updtsurf(cnew,blc(:,tid),ilog,tid,not_converged,over_flow_lc)

!c  warning information on aqueous concentration
            if (maxval(cnew(1:nc-1)) > conc_corr_max) then
              goto 997
            end if

            if (over_flow_lc) then
              goto 998
            end if

          else
            goto 999
          end if

        end do               !(not_converged)

!c  assign new total component concentrations for surface sites

        do isites = 1,nsites
          ic = iaic(isites)
          totcn(ic,tid) = cnew(ic)
        end do

      end if                 !(sorption_group)

      return

997   continue
      if (rank == 0) then 
        write(*,*)'-------------------------------------------'
        write(*,*)'   terminated in routine surfcomp          '
        write(*,*)'   maximum aqueous concentration exceeded  '
        write(*,*)'   bye now ...                             '
        write(*,*)'-------------------------------------------' 
        write(ilog,*)'-------------------------------------------'
        write(ilog,*)'   terminated in routine surfcomp          '
        write(ilog,*)'   maximum aqueous concentration exceeded  '
        write(ilog,*)'   bye now ...                             '
        write(ilog,*)'-------------------------------------------'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then  
        write(ilog,*)'-------------------------------------------'
        write(ilog,*)'   terminated in routine surfcomp          '
        write(ilog,*)'   NaN found in Newton iterations          '
        write(ilog,*)'   bye now ...                             '
        write(ilog,*)'-------------------------------------------'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then  
        write(ilog,*)'-------------------------------------------'
        write(ilog,*)'   terminated in routine surfcomp          '
        write(ilog,*)'   maximum number of iterations exceeded   '
        write(ilog,*)'   bye now ...                             '
        write(ilog,*)'-------------------------------------------'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

      end
