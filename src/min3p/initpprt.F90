!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initpprt.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initpprt
!c -------------------
!c
!c physical parameters for reactive transport
!c
!c written by:      Uli Mayer - May 13, 96
!c
!c last modified:   Uli Mayer - November 25, 96
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common: 
!c gen.f:    real*8:
!c           -------
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical
!c                                parameters to internal time units
!c
!c
!c           integer*4:
!c           ----------
!c           icnv               = unit number, type conversion and    + -
!c                                temporary storage      
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, log book               + -
!c           itmp               = unit number, temporary storage      + -
!c           l_zone_name        = length of zone name                 * +
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c 
!c           character:
!c           ----------
!c           section_header     = section header                      * +
!c           zone_name          = name of zone                        * +
!c
!c phys.f:   real*8:
!c           -------
!c           disx(nzn)          = longitudinal dispersivity           * +
!c           disy(nzn)          = transverse horizontal dispersivity  * +
!c           disz(nzn)          = transverse vertical dispersivity    * +
!c           diff_a(nzn)        = diffusion coefficient in aqueous    * +
!c                                phase (equal for all species)
!c           diff_g(nzn)        = diffusion coefficient in gaseous    * +
!c                                phase (equal for all species)
!c           diff_bin_g(ng,ng)  = binary gas diffusion coefficients   * +
!c           visc_comp_g(ng)    = viscosity of gas species            * +
!c           dens_gcnst         = density of gas mixture (constant)   * +    
!c           visc_gcnst         = viscosity of gas mixture (constant) * +
!c
!c           integer*4:
!c           ----------
!c           mprop_name(nzn)    = name of material property zone      + -
!c           nzn                = number of material property zones   + -
!c           logical:
!c           --------
!c           blanc_diff_g       = .true.  -> LeBlanc's approx to      * +
!c                                           compute diff coeff 
!c                                           (Fick's law)
!c
!c dgml.f    logical:
!c           --------
!c           dgm                = .true.  -> use DGM to compute       * +
!c                                           diffusive fluxes 
!c           maxwell            = .true.  -> use Stefan-Maxwell       * +
!c                                           to compute diff fluxes 
!c           equimolar          = .true.  -> force equimolar diffus   * +
!c                                           in Stefan-Maxwell
!c           update_dens_g      = .true.  -> compute gas density      * +
!c                                           as function of concs  
!c           variable_visc_g    = .true.  -> compute gas viscosity    * +
!c                                           as function of concs  
!c
!c
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           epsil(ng)          = lennard-jones potential epsilon
!c           sigma(ng)          = lennard-jones potential sigma
!c
!c           integer*4:
!c           ----------
!c           izn                = counter
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c
!c           character:
!c           ----------
!c           subsection         = name of subsection in input file
!c
!c external: findstrg  = find text string in file
!c           readbloc  = read section of input file and write to 
!c                       temporary file
!c ----------------------------------------------------------------------
 
      subroutine initpprt
 
      use parm
      use gen
      use phys
      use chem
      use dgml    
      use geometry  
      use multidiff, only : mdiff_ic_tensor, mdiff_ix_tensor,          &
                            type_mdiff_ic_coeff, type_mdiff_ix_coeff
      use file_utility, only : rewind_first_record
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
 
      implicit none
      
      integer :: i, ic, ig, ix, izn, jg, l_string, ierrcd

      external findstrg, readbloc, findstrginzone

      logical found_section, found_subsection
      character*72 subsection
      
      character*20 :: equi
      real*8 :: sigma(ng), epsil(ng)

      real*8, parameter :: r0 = 0.0d0, rsmall = 1.0d-20

!c  read physical parameters for reactive transport and write to 
!c  temporary file

      ierrcd = 0
   
      section_header = 'physical parameters - reactive transport'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
 
      elseif (found_section) then

!c  write section header to generic output file
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,'(/72a)')('-',i=1,72)
          write(igen,'(a)') section_header(:l_string)
          write(igen,'(72a/)')('-',i=1,72)
        end if

!c  read diffusion coefficients - identical for all material 
!c  property zones

        type_diff_coeff = -1
        diff_a_tensor = tensor_zero
        diff_g_tensor = tensor_zero

        subsection = 'diffusion coefficients'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          ierrcd = 1
          read(itmp,*,err=999,end=999) diff_a
          if (.not.fully_saturated) then
            ierrcd = 2
            read(itmp,*,err=999,end=999) diff_g
          end if
          type_diff_coeff = 0
        end if

!cdsu   diffusion coefficient tensor, principle terms
        subsection = 'principle diffusion coefficients'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          ierrcd = 3
          read(itmp,*,err=999,end=999) diff_a_tensor%xx,               &
                                       diff_a_tensor%yy,               &
                                       diff_a_tensor%zz
          if (.not.fully_saturated) then
            ierrcd = 4
            read(itmp,*,err=999,end=999) diff_g_tensor%xx,             &
                                         diff_g_tensor%yy,             &
                                         diff_g_tensor%zz
          end if
          type_diff_coeff = 1
        end if

!cdsu   diffusion coefficient tensor, full tensor
        subsection = 'diffusion coefficients tensor'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then
          ierrcd = 5
          read(itmp,*,err=999,end=999)                                 &
              diff_a_tensor%xx,diff_a_tensor%xy,diff_a_tensor%xz,      &
              diff_a_tensor%yx,diff_a_tensor%yy,diff_a_tensor%yz,      &
              diff_a_tensor%zx,diff_a_tensor%zy,diff_a_tensor%zz
          if (.not.fully_saturated) then
            ierrcd = 6
            read(itmp,*,err=999,end=999)                               &
              diff_g_tensor%xx,diff_g_tensor%xy,diff_g_tensor%xz,      &
              diff_g_tensor%yx,diff_g_tensor%yy,diff_g_tensor%yz,      &
              diff_g_tensor%zx,diff_g_tensor%zy,diff_g_tensor%zz
          end if
          type_diff_coeff = 2

          if (discretization_type == 0) then
            if (rank == 0 .and. b_enable_output) then
              write(ilog,'(2a)') 'Warning: Full diffusion tensor is ', &
                    'not supported by structured grid version.'
            end if
          end if
        end if

        if (type_diff_coeff < 0) then

          if (rank == 0) then  
            write(ilog,*) 'section "',trim(section_header),'"'
            write(ilog,*) 'subsection "',trim(subsection),'" missing'
            close(ilog)
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop
        else

!c  write diffusion coefficients to generic output file
          if (b_enable_output .and. b_enable_output_gen) then
            if (type_diff_coeff == 0) then
              write(igen,'(a,1pe15.6e3)')                              &
                'free diffusion coefficient in aqueous phase     = ',  &
                diff_a
            else if (type_diff_coeff > 0) then
              write(igen,'(a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')         &
                'free diffusion coefficient in aqueous phase     = ',  &
                'xx-, xy-, xz-term',diff_a_tensor%xx,                  &
                 diff_a_tensor%xy,diff_a_tensor%xz,                    &
                'yx-, yy-, yz-term',diff_a_tensor%yx,                  &
                 diff_a_tensor%yy,diff_a_tensor%yz,                    &
                'zx-, zy-, zz-term',diff_a_tensor%zx,                  &
                 diff_a_tensor%zy,diff_a_tensor%zz
            end if

            if (.not.fully_saturated) then
              if (type_diff_coeff == 0) then
                write(igen,'(a,1pe15.6e3)')                            &
                'free diffusion coefficient in gaseous phase     = ',  &
                diff_g
              else if (type_diff_coeff > 0) then
                write(igen,'(a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')       &
                'free diffusion coefficient in gaseous phase     = ',  &
                'xx-, xy-, xz-term',diff_g_tensor%xx,                  &
                 diff_g_tensor%xy,diff_g_tensor%xz,                    &
                'yx-, yy-, yz-term',diff_g_tensor%yx,                  &
                 diff_g_tensor%yy,diff_g_tensor%yz,                    &
                'zx-, zy-, zz-term',diff_g_tensor%zx,                  &
                 diff_g_tensor%zy,diff_g_tensor%zz
              end if
            end if
          end if
        end if

!cdsu full dispersion tensor or principle dispersion tensor, by default, 
!cdsu principle dispersion tensor is used.
!cdsu No extra input parameters are needed. 
!cdsu Full dispersion tensor form reference: Burnett and Frind 1987, WRR        
        type_disp_coeff = 1
        subsection = 'use full dispersion tensor'

        call findstrg(subsection,itmp,found_subsection) 
        if (found_subsection) then
          type_disp_coeff = 2
        end if

!c  diffusion coefficient change under freezen condition
        if (b_water_freezing) then
          subsection = 'reduction ratio of frozen diffusion coefficients'

          call findstrg(subsection,itmp,found_subsection)
  
          if (found_subsection) then  
            ierrcd = 7
            read(itmp,*,err=999,end=999) frozen_diff_a
            if (.not.fully_saturated) then
              ierrcd = 8
              read(itmp,*,err=999,end=999) frozen_diff_g
            end if  
          else   
            !c use default value, reduce aqueous phase diffusion coefficient 
            !c by 6 orders and gas phase by 1 order
            frozen_diff_a = 1.0d-6
            frozen_diff_g = 1.0d-1
          end if
  
  !c  write diffusion coefficients to generic output file
          if (b_enable_output .and. b_enable_output_gen) then
            if (type_diff_coeff == 0) then
              write(igen,'(a,1pe15.6e3)')                                    &
                'frozen free diffusion coefficient in aqueous phase     = ', &
                diff_a*frozen_diff_a
            else if (type_diff_coeff > 0) then
              write(igen,'(a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')               &
                'frozen free diffusion coefficient in aqueous phase     = ', &
                'xx-, xy-, xz-term',diff_a_tensor%xx*frozen_diff_a,        &
                 diff_a_tensor%xy*frozen_diff_a,                           &
                 diff_a_tensor%xz*frozen_diff_a,                           &
                'yx-, yy-, yz-term',diff_a_tensor%yx*frozen_diff_a,        &
                 diff_a_tensor%yy*frozen_diff_a,                           &
                 diff_a_tensor%yz*frozen_diff_a,                           &
                'zx-, zy-, zz-term',diff_a_tensor%zx*frozen_diff_a,        &
                 diff_a_tensor%zy*frozen_diff_a,                           &
                 diff_a_tensor%zz*frozen_diff_a
            end if

            if (.not.fully_saturated) then
              if (type_diff_coeff == 0) then
                write(igen,'(a,1pe15.6e3/)')                                   &
                  'frozen free diffusion coefficient in gaseous phase     = ', &
                  diff_g*frozen_diff_g
              else if (type_diff_coeff > 0) then
                write(igen,'(a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')               &
                  'frozen free diffusion coefficient in gaseous phase     = ', &
                  'xx-, xy-, xz-term',diff_g_tensor%xx*frozen_diff_g,        &
                   diff_g_tensor%xy*frozen_diff_g,                           &
                   diff_g_tensor%xz*frozen_diff_g,                           &
                  'yx-, yy-, yz-term',diff_g_tensor%yx*frozen_diff_g,        &
                   diff_g_tensor%yy*frozen_diff_g,                           &
                   diff_g_tensor%yz*frozen_diff_g,                           &
                  'zx-, zy-, zz-term',diff_g_tensor%zx*frozen_diff_g,        &
                   diff_g_tensor%zy*frozen_diff_g,                           &
                   diff_g_tensor%zz*frozen_diff_g
              end if
            end if
          end if
        else
          frozen_diff_a = 1.0d0
          frozen_diff_g = 1.0d0
        end if
 
!c  conversion of time units for computation in days

        if (type_diff_coeff == 0) then
          diff_a = diff_a * sec_per_days        
          if (.not.fully_saturated) then
            diff_g = diff_g * sec_per_days
          end if
        else if (type_diff_coeff > 0) then
          diff_a_tensor = diff_a_tensor * sec_per_days        
          if (.not.fully_saturated) then
            diff_g_tensor = diff_g_tensor * sec_per_days
          end if
        end if

!c new - sergi
        subsection = 'binary gas diffusion coefficients'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          blanc_diff_g = .true.

          do ig = 1,ng-1
            do jg = ig + 1,ng
              ierrcd = 9
              read(itmp,*,err=999,end=999) diff_bin_g(ig,jg)
                  diff_bin_g(ig,jg) = diff_bin_g(ig,jg) * sec_per_days  
            enddo
          enddo
 
          do ig = 2,ng
            do jg = 1,ig-1
              diff_bin_g(ig,jg) = diff_bin_g(jg,ig)
            enddo
          enddo 

          diff_g = 1.0d0
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(a)') 'gas diffusion coefficients updated',    &
                              ' based on binary diffusion coeff',      &
                              ' and mol fractions (Blanc s law)'
          end if

        elseif (.not.found_subsection) then

          blanc_diff_g = .false.  ! default -> same diff coeff for all gases         

        end if
        
!c-----DGM module------------------------------------------------------------
        
        subsection = 'dusty gas model'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          dgm = .true.

          do ig = 1,ng-1
            do jg = ig + 1,ng
              ierrcd = 10
              read(itmp,*,err=999,end=999) diff_bin_g(ig,jg)
              diff_bin_g(ig,jg) = diff_bin_g(ig,jg) * sec_per_days  
            enddo
          enddo
 
          do ig = 2,ng
            do jg = 1,ig-1
              diff_bin_g(ig,jg) = diff_bin_g(jg,ig)
            enddo
          enddo 

          diff_g = 1.0d0
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(2a)') 'dusty gas model used to calculate',    &
                               ' diffusive fluxes of gas components'
            write(ilog,'(/72a)')('-',i=1,72)
            if (b_enable_output_gen) then
              write(igen,'(2a)') 'dusty gas model used to calculate',  &
                                 ' diffusive fluxes of gas components' 
              write(igen,'(/72a)')('-',i=1,72)
            end if
          end if

          do ig = 1,ng
            ierrcd = 11
            read(itmp,*,err=999,end=999) visc_comp_g(ig)
          enddo

!c         assign air viscosity for calculation of knudsen diff coeff
          visc_gcnst      = 1.86d-5

!c         use diffusion coeff from blancs law for output for Fick's diffusive flux        
          blanc_diff_g = .true.

        elseif (.not.found_subsection) then

          dgm = .false.  ! default -> use fick's law for diffusion

        end if
        
!c-----Maxwell Stefan module-------------------------------------------------
        
        subsection = 'maxwell stefan'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          maxwell = .true.
          ierrcd = 12
          read(itmp,*,err=999,end=999) equi

          if (equi.eq.'non-equimolar') then
          
            equimolar = .false.

          else if (equi.eq.'equimolar') then
          
            equimolar = .true.
          
          else
            if (rank == 0 .and. b_enable_output) then
              write(ilog,'(2a)') 'maxwell stefan must be',             &
                                 ' equimolar or non-equimolar'
            end if
          endif

          do ig = 1,ng-1
            do jg = ig + 1,ng
              ierrcd = 13
              read(itmp,*,err=999,end=999) diff_bin_g(ig,jg)
              diff_bin_g(ig,jg) = diff_bin_g(ig,jg) * sec_per_days  
            enddo
          enddo
 
          do ig = 2,ng
            do jg = 1,ig-1
              diff_bin_g(ig,jg) = diff_bin_g(jg,ig)
            enddo
          enddo 

          diff_g = 1.0d0
          if (rank == 0 .and. b_enable_output) then
            write(ilog,'(2a)') 'maxwell stefan eqs used to calculate',  &
                              ' diffusive fluxes of gas components'
          end if

!c       use diffusion coeff from blancs law for derivatives for now
!c       and output for Fick's diffusive flux        
          blanc_diff_g = .true.

        elseif (.not.found_subsection) then

          maxwell = .false.  ! default -> use fick's law for diffusion

        end if
        
!c-----for DGM and S-M: correction for temperature and pressure dependence --
        
        subsection = 'pressure dependence'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          diff_press = .true.

        elseif (.not.found_subsection) then

          diff_press = .false.

        end if

        subsection = 'temperature dependence'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          diff_temp = .true.
          ierrcd = 14
          read(itmp,*,err=999,end=999) theta_diff

        elseif (.not.found_subsection) then

          diff_temp = .false.

        end if
        
!c   read gas density options
        subsection = 'update density'
        call findstrg(subsection,itmp,found_subsection)
        
        if(.not.found_subsection) then
          subsection = 'update gas density'
          call findstrg(subsection,itmp,found_subsection)
        end if

        if (found_subsection) then

          update_dens_g = .true.

        elseif (.not.found_subsection) then

          update_dens_g = .false.
          dens_gcnst      = 1.29d+0

        end if

        subsection = 'constant gas density'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          update_dens_g = .false.
          ierrcd = 15
          read(itmp,*,err=999,end=999) dens_gcnst 

        end if

!c   read gas viscosity options        
!c       default: constant 
!c       visc_gcnst will be used regardless value of variable_visc_g
        variable_visc_g = 'constant'
        visc_gcnst      = 1.86d-5
      
        subsection = 'wilke viscosity'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          variable_visc_g = 'wilke'
          
          do ig = 1,ng

            ierrcd = 16
            read(itmp,*,err=999,end=999) visc_comp_g(ig)
      
          enddo       

        end if

        subsection = 'linear viscosity'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          variable_visc_g = 'linear'
          
          do ig = 1,ng

            ierrcd = 17
            read(itmp,*,err=999,end=999) visc_comp_g(ig)
      
          enddo

        end if

        subsection = 'constant viscosity'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          variable_visc_g = 'constant'
          ierrcd = 18
          read(itmp,*,err=999,end=999) visc_gcnst

        end if

!c  write density and viscosity to generic output file 
        if (rank == 0 .and. b_enable_output) then
          if (.not.update_dens_g) then
  
            if (b_enable_output_gen) then  
              write(igen,'(a,1pe15.6e3)')                              &
                'density of the gas phase                        = ',  &
                dens_gcnst
            end if

          else
  
            write(ilog,'(2a)') 'gas density updated based on ',        &
                                'concentration values'  
            write(ilog,'(/72a)')('-',i=1,72)
            if (b_enable_output_gen) then
              write(igen,'(2a)') 'gas density updated based on ',      &
                                  'concentration values'
              write(igen,'(/72a)')('-',i=1,72)
            end if
          endif 

          if (variable_visc_g.eq.'constant') then
            if (b_enable_output_gen) then
            write(igen,'(a,1pe15.6e3)')                                &
              'viscosity of the gas phase                      = ',    &
              visc_gcnst
            end if
          
          else if (variable_visc_g.eq.'wilke') then
          
            write(ilog,'(2a)') 'gas viscosity updated based on ',      &
                                'mol fractions (Wilke s expression)'
            write(ilog,'(/72a)')('-',i=1,72)
            if (b_enable_output_gen) then
              write(igen,'(2a)') 'gas viscosity updated based on ',    &
                                  'mol fractions (Wilke s expression)'
              write(igen,'(/72a)')('-',i=1,72)
            end if
          
          else if (variable_visc_g.eq.'linear') then
          
            write(ilog,'(2a)') 'gas viscosity updated based on ',      &
                                'mol fractions (linear update)'
            write(ilog,'(/72a)')('-',i=1,72)
            if (b_enable_output_gen) then
              write(igen,'(2a)') 'gas viscosity updated based on ',    &
                                  'mol fractions (linear update)'
              write(igen,'(/72a)')('-',i=1,72)
            end if
          
          endif
          
        end if

!c       use lennard-jones potential to calculate diffusion coefficients
        subsection = 'lennard-jones'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          if (rank == 0 .and. b_enable_output) then  
            if (dgm.or.maxwell) then                 
              write(ilog,'(2a)')                                       &
                    ' The Lennard-Jones potential is used',            &
                    ' to calculate diffusion coefficients '            
            else             
              write(ilog,'(2a)')                                       &
                    ' WARNING: the Lennard-Jones potential ',          &
                    'is not used for diffusion coefficients '
              write(ilog,'(2a)')                                       &
                    ' "dusty gas model" or "maxwell stefan"',          &
                    ' keyword is missing'
            endif

            if (variable_visc_g.eq.'constant') then             
              write(ilog,'(2a)')                                       &
                    ' WARNING: the Lennard-Jones potential ',          &
                    'is not used for viscosity coefficients '
              write(ilog,'(2a)')                                       &
                    '"wilke viscosity" or "linear viscosity"',         &
                    ' keyword is missing'
            else            
              write(ilog,'(2a)')                                         &
                    ' The Lennard-Jones potential is used',            &
                    ' to calculate viscosity coefficients '
            endif
          
            write(ilog,'(/72a)')('-',i=1,72)
            
          end if

!c         read sigma and epsilon/k
          do ig = 1,ng
            ierrcd = 19
            read(itmp,*,err=999,end=999) sigma(ig), epsil(ig)
          enddo

!c         calculate Dij, visc_i
          call lennard_jones(sigma,epsil,visc_comp_g,diff_bin_g)

        elseif (.not.found_subsection) then

!         diffusion/visosity coefficients have been specified

        end if
!c     end new - sergi 
        
!cprovi--------------------------------------------------------
!cprovi Read component dependent diffusion coefficients
!cprovi--------------------------------------------------------        
        diff_coff = .false.
        type_diff_ic_coeff = -1
        diff_ic_tensor = tensor_zero

        subsection =                                                   &
            'component dependent diffusion coefficients in water'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          diff_coff = .true.
          type_diff_ic_coeff = 0

          if (b_enable_output .and. b_enable_output_gen) then
             write (igen,'(/a/)')                                      &
              'Component dependent diffusion coefficients:'
          end if
          
          do ic = 1,nc-1
            ierrcd = 20
            read(itmp,*,err=999,end=999) diff_a

            if (b_enable_output .and. b_enable_output_gen) then
              write(igen,'(3a,1pe15.6e3)')                             &
              'diffusion coefficient in aqueous phase for component ', &
              namec(ic)(:l_namec(ic)),'  = ',                          &
              diff_a
            end if

!c  conversion of time units for computation in days
            diff_ic(ic) = diff_a * sec_per_days
          end do
        
        end if

!cdsu   diffusion coefficient tensor, principle terms
        subsection =                                                   &
        'component dependent principle diffusion coefficients in water'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          diff_coff = .true.
          type_diff_ic_coeff = 1

          if (b_enable_output .and. b_enable_output_gen) then
             write (igen,'(/a/)')                                      &
              'Component dependent principle diffusion coefficients:'
          end if
          
          do ic = 1,nc-1
            ierrcd = 21
            read(itmp,*,err=999,end=999) diff_ic_tensor(ic)%xx,        &
                                         diff_ic_tensor(ic)%yy,        &
                                         diff_ic_tensor(ic)%zz

            if (b_enable_output .and. b_enable_output_gen) then
              write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')                             &
              'diffusion coefficient in aqueous phase for component ', &
              namec(ic)(:l_namec(ic)),'  = ',                          &
              'xx-, xy-, xz-term',diff_ic_tensor(ic)%xx,               &
               diff_ic_tensor(ic)%xy,diff_ic_tensor(ic)%xz,            &
              'yx-, yy-, yz-term',diff_ic_tensor(ic)%yx,               &
               diff_ic_tensor(ic)%yy,diff_ic_tensor(ic)%yz,            &
              'zx-, zy-, zz-term',diff_ic_tensor(ic)%zx,               &
               diff_ic_tensor(ic)%zy,diff_ic_tensor(ic)%zz
            end if

!c  conversion of time units for computation in days
            diff_ic_tensor(ic) = diff_ic_tensor(ic) * sec_per_days            
          end do
        
        end if

!cdsu   diffusion coefficient tensor, full tensor
        subsection =                                                   &
        'component dependent diffusion coefficients tensor in water'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          diff_coff = .true.
          type_diff_ic_coeff = 2

          if (discretization_type == 0) then
            if (rank == 0 .and. b_enable_output) then
              write(ilog,'(2a)') 'Warning: Full diffusion tensor is ', &
                    'not supported by structured grid version.'
            end if
          end if

          if (discretization_type == 0) then
            if (rank == 0 .and. b_enable_output) then
              write(ilog,'(2a)') 'Warning: Full diffusion tensor is ', &
                    'not supported by structured grid version.'
            end if
          end if

          if (b_enable_output .and. b_enable_output_gen) then
             write (igen,'(/a/)')                                      &
              'Component dependent diffusion coefficients tensor:'
          end if
          
          do ic = 1,nc-1
            ierrcd = 22
            read(itmp,*,err=999,end=999) diff_ic_tensor(ic)%xx,        &
                  diff_ic_tensor(ic)%xy,diff_ic_tensor(ic)%xz,         &
                  diff_ic_tensor(ic)%yx,diff_ic_tensor(ic)%yy,         &
                  diff_ic_tensor(ic)%yz,diff_ic_tensor(ic)%zx,         &
                  diff_ic_tensor(ic)%zy,diff_ic_tensor(ic)%zz

            if (b_enable_output .and. b_enable_output_gen) then
              write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')                             &
              'diffusion coefficient in aqueous phase for component ', &
              namec(ic)(:l_namec(ic)),'  = ',                          &
              'xx-, xy-, xz-term',diff_ic_tensor(ic)%xx,               &
               diff_ic_tensor(ic)%xy,diff_ic_tensor(ic)%xz,            &
              'yx-, yy-, yz-term',diff_ic_tensor(ic)%yx,               &
               diff_ic_tensor(ic)%yy,diff_ic_tensor(ic)%yz,            &
              'zx-, zy-, zz-term',diff_ic_tensor(ic)%zx,               &
               diff_ic_tensor(ic)%zy,diff_ic_tensor(ic)%zz
            end if

!c  conversion of time units for computation in days
            diff_ic_tensor(ic) = diff_ic_tensor(ic) * sec_per_days            
          end do
        
        end if

!cdsu Multicomponent diffusion coefficients. this part is added to 
!cdsu overwrite reading multicomponent diffusion coefficients from database 
        if (multi_diff) then
!cdsu by default, the following two variables are set to zero as the original
!cdsu parameters are read from database
          type_mdiff_ic_coeff = 0
          type_mdiff_ix_coeff = 0

!cdsu primary species
          subsection =                                                 &
          'multicomponent diffusion coefficients of primary species'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
    
            type_mdiff_ic_coeff = 0
    
            if (b_enable_output .and. b_enable_output_gen) then
               write (igen,'(/a/)')                                    &
                'Multicomponent free diffusion coefficients:'
            end if
            
            do ic = 1,nc-1
              ierrcd = 23
              read(itmp,*,err=999,end=999) mdiff_ic(ic)

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,1pe15.6e3)')                           &
                'primary specie ',namec(ic)(:l_namec(ic)),'  = ',      &
                mdiff_ic(ic)
              end if

!c  conversion of time units for computation in days
              mdiff_ic(ic) = mdiff_ic(ic) * sec_per_days
            end do
      
          end if

!cdsu   diffusion coefficient tensor, principle terms
          subsection =                                                       &
          'multicomponent principle diffusion coefficients of primary species'

          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
    
            type_mdiff_ic_coeff = 1
    
            if (b_enable_output .and. b_enable_output_gen) then
              write (igen,'(/a/)')                                           &
              'Multicomponents principle free diffusion coefficients:'
            end if
            
            do ic = 1,nc-1
              ierrcd = 24
              read(itmp,*,err=999,end=999) mdiff_ic_tensor(ic)%xx,           &
                                           mdiff_ic_tensor(ic)%yy,           &
                                           mdiff_ic_tensor(ic)%zz

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')            &
                'primary specie ', namec(ic)(:l_namec(ic)),'  = ',           &
                'xx-, xy-, xz-term',mdiff_ic_tensor(ic)%xx,                  &
                 mdiff_ic_tensor(ic)%xy,mdiff_ic_tensor(ic)%xz,              &
                'yx-, yy-, yz-term',mdiff_ic_tensor(ic)%yx,                  &
                 mdiff_ic_tensor(ic)%yy,mdiff_ic_tensor(ic)%yz,              &
                'zx-, zy-, zz-term',mdiff_ic_tensor(ic)%zx,                  &
                 mdiff_ic_tensor(ic)%zy,mdiff_ic_tensor(ic)%zz
              end if

!c  conversion of time units for computation in days
              mdiff_ic_tensor(ic) = mdiff_ic_tensor(ic) * sec_per_days            
            end do
      
          end if

!cdsu   diffusion coefficient tensor, full tensor
          subsection =                                                       &
          'multicomponent diffusion coefficients tensor of primary species'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
    
            type_mdiff_ic_coeff = 2

            if (discretization_type == 0) then
              if (rank == 0 .and. b_enable_output) then
                write(ilog,'(2a)') 'Warning: Full diffusion tensor is ', &
                      'not supported by structured grid version.'
              end if
            end if
    
            if (b_enable_output .and. b_enable_output_gen) then
               write (igen,'(/a/)')                                    &
                'Multicomponent free diffusion coefficients tensor:'
            end if
            
            do ic = 1,nc-1
              ierrcd = 25
              read(itmp,*,err=999,end=999) mdiff_ic_tensor(ic)%xx,     &
                    mdiff_ic_tensor(ic)%xy,mdiff_ic_tensor(ic)%xz,     &
                    mdiff_ic_tensor(ic)%yx,mdiff_ic_tensor(ic)%yy,     &
                    mdiff_ic_tensor(ic)%yz,mdiff_ic_tensor(ic)%zx,     &
                    mdiff_ic_tensor(ic)%zy,mdiff_ic_tensor(ic)%zz

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')        &
                'primary specie ',namec(ic)(:l_namec(ic)),'  = ',        &
                'xx-, xy-, xz-term',mdiff_ic_tensor(ic)%xx,              &
                 mdiff_ic_tensor(ic)%xy,mdiff_ic_tensor(ic)%xz,          &
                'yx-, yy-, yz-term',mdiff_ic_tensor(ic)%yx,              &
                 mdiff_ic_tensor(ic)%yy,mdiff_ic_tensor(ic)%yz,          &
                'zx-, zy-, zz-term',mdiff_ic_tensor(ic)%zx,              &
                 mdiff_ic_tensor(ic)%zy,mdiff_ic_tensor(ic)%zz
              end if

!c  conversion of time units for computation in days
              mdiff_ic_tensor(ic) = mdiff_ic_tensor(ic) * sec_per_days            
            end do      
          end if

!cdsu secondary species
          subsection =                                                 &
          'multicomponent diffusion coefficients of secondary species'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
    
            type_mdiff_ix_coeff = 0
    
            if (b_enable_output .and. b_enable_output_gen) then
               write (igen,'(/a/)')                                    &
                'Multicomponent free diffusion coefficients:'
            end if
            
            do ix = 1,nx
              ierrcd = 26
              read(itmp,*,err=999,end=999) mdiff_ix(ix)

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,1pe15.6e3)')                             &
                'secondary sepcie ',namex(ix)(:l_namex(ix)),'  = ',      &
                mdiff_ix(ix)
              end if

!c  conversion of time units for computation in days
              mdiff_ix(ix) = mdiff_ix(ix) * sec_per_days
            end do
      
          end if

!cdsu   diffusion coefficient tensor, principle terms
          subsection =                                                       &
          'multicomponent principle diffusion coefficients of secondary species'

          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
    
            type_mdiff_ix_coeff = 1
    
            if (b_enable_output .and. b_enable_output_gen) then
              write (igen,'(/a/)')                                     &
              'Multicomponents principle free diffusion coefficients:'
            end if
            
            do ix = 1,nx
              ierrcd = 27
              read(itmp,*,err=999,end=999) mdiff_ix_tensor(ix)%xx,     &
                                           mdiff_ix_tensor(ix)%yy,     &
                                           mdiff_ix_tensor(ix)%zz

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')          &
                'secondary specie ', namex(ix)(:l_namex(ix)),'  = ',       &
                'xx-, xy-, xz-term',mdiff_ix_tensor(ix)%xx,                &
                 mdiff_ix_tensor(ix)%xy,mdiff_ix_tensor(ix)%xz,            &
                'yx-, yy-, yz-term',mdiff_ix_tensor(ix)%yx,                &
                 mdiff_ix_tensor(ix)%yy,mdiff_ix_tensor(ix)%yz,            &
                'zx-, zy-, zz-term',mdiff_ix_tensor(ix)%zx,                &
                 mdiff_ix_tensor(ix)%zy,mdiff_ix_tensor(ix)%zz
              end if

!c  conversion of time units for computation in days
              mdiff_ix_tensor(ix) = mdiff_ix_tensor(ix) * sec_per_days            
            end do
      
          end if

!cdsu   diffusion coefficient tensor, full tensor
          subsection =                                                 &
          'multicomponent diffusion coefficients tensor of secondary species'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then
    
            type_mdiff_ix_coeff = 2

            if (discretization_type == 0) then
              if (rank == 0 .and. b_enable_output) then
                write(ilog,'(2a)') 'Warning: Full diffusion tensor is ', &
                      'not supported by structured grid version.'
              end if
            end if
    
            if (b_enable_output .and. b_enable_output_gen) then
               write (igen,'(/a/)')                                    &
                'Multicomponent free diffusion coefficients tensor:'
            end if
            
            do ix = 1,nx
              ierrcd = 28
              read(itmp,*,err=999,end=999) mdiff_ix_tensor(ix)%xx,     &
                    mdiff_ix_tensor(ix)%xy,mdiff_ix_tensor(ix)%xz,     &
                    mdiff_ix_tensor(ix)%yx,mdiff_ix_tensor(ix)%yy,     &
                    mdiff_ix_tensor(ix)%yz,mdiff_ix_tensor(ix)%zx,     &
                    mdiff_ix_tensor(ix)%zy,mdiff_ix_tensor(ix)%zz

              if (b_enable_output .and. b_enable_output_gen) then
                write(igen,'(3a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')        &
                'secondary specie ',namex(ix)(:l_namex(ix)),'  = ',      &
                'xx-, xy-, xz-term',mdiff_ix_tensor(ix)%xx,              &
                 mdiff_ix_tensor(ix)%xy,mdiff_ix_tensor(ix)%xz,          &
                'yx-, yy-, yz-term',mdiff_ix_tensor(ix)%yx,              &
                 mdiff_ix_tensor(ix)%yy,mdiff_ix_tensor(ix)%yz,          &
                'zx-, zy-, zz-term',mdiff_ix_tensor(ix)%zx,              &
                 mdiff_ix_tensor(ix)%zy,mdiff_ix_tensor(ix)%zz
              end if

!c  conversion of time units for computation in days
              mdiff_ix_tensor(ix) = mdiff_ix_tensor(ix) * sec_per_days            
            end do
      
          end if

        end if
        
        if (hmulti_diff) then
 
!c  read material properties for material property zones from input file
               
          do izn = 1,nzn                !loop over property zones

!c  search for entry for material property zone in input file

            zone_name = mprop_name(izn)

!c  define length of name of material property zone

            l_zone_name = index(zone_name,'  ')-1
            if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
              l_zone_name = 72
            end if

!c  search temporary data file for current material property zone
!c  and write to scratch file

            call readbloc (itmp,icnv,zone_name,found_subsection,.true.)

!c  read correction factors of porosity and tortuosity for species for hybrid MCD model

            if (found_subsection) then

!c  read correction factors of porosity for primary species

              subsection = 'porosity correction factor of primary species for hMCD diffusion'
                
!c  search temporary data file for current material property zone
!c  and write to scratch file

              call findstrginzone(subsection,icnv,found_subsection)              
             
              if (found_subsection) then
                if (b_enable_output .and. b_enable_output_gen) then  
                  write (igen,'(/a/)')                                       &
                  'porosity correction factor of primary species in zone: ', &
                  zone_name
                end if
                !read(itmp, *) subsection
                !write(*,*) subsection
                
                do ic = 1,nc-1-nna-nbio
                  ierrcd = 29
                  read(icnv,*,err=999,end=999) f_epor_ps(ic,izn)   

    !c_bubbles write component dependent coefficients to generic output file
                  if (b_enable_output .and. b_enable_output_gen) then
                    write(igen,'(3a,1pe15.6e3)')                            &
                          'porosity correction factor for primary species ',&
                          namec(ic)(:l_namec(ic)),'  = ',                   &
                          f_epor_ps(ic,izn)
                  end if         
                end do        
              end if   
                
!c  read correction factors of tortuosity for primary species

              subsection = 'tortuosity correction factor of primary species for hMCD diffusion'
                
!c  search temporary data file for current material property zone
!c  and write to scratch file

              call findstrginzone(subsection,icnv,found_subsection)              
              
              if (found_subsection) then
                if (b_enable_output .and. b_enable_output_gen) then  
                  write (igen,'(/a )')                                         &
                  'tortuosity correction factor of primary species in zone: ', &
                  zone_name
                end if
                !read(itmp, *) subsection
                !write(*,*) subsection
                  
                do ic = 1,nc-1-nna-nbio
                  ierrcd = 30
                  read(icnv,*,err=999,end=999) f_etau_ps(ic,izn)   

    !c_bubbles write component dependent coefficients to generic output file
                  if (b_enable_output .and. b_enable_output_gen) then
                    write(igen,'(3a,1pe15.6e3)')                               &
                          'tortuosity correction factor for primary specie ',  &
                          namec(ic)(:l_namec(ic)),'  = ',                      &
                          f_etau_ps(ic,izn)
                  end if         
                end do        
              end if 
              
!c  read correction factors of porosity for secondary species

              subsection = 'porosity correction factor of secondary species for hMCD diffusion'
                
!c  search temporary data file for current material property zone
!c  and write to scratch file

              call findstrginzone(subsection,icnv,found_subsection)
              
              if (found_subsection) then
                if (b_enable_output .and. b_enable_output_gen) then
                  write (igen,'(/a/)')                                         &
                  'porosity correction factor of secondary species in zone: ', &
                  zone_name
                end if
                !read(itmp, *) subsection
                !write(*,*) subsection
                  
                do ix = 1,nx
                  ierrcd = 31
                  read(icnv,*,err=999,end=999) f_epor_ss(ix,izn)   

    !c_bubbles write component dependent coefficients to generic output file
                  if (b_enable_output .and. b_enable_output_gen) then
                    write(igen,'(3a,1pe15.6e3)')                          &
                      'porosity correction factor for secondary species ',&
                      namex(ix)(:l_namex(ix)),'  = ',                     &
                      f_epor_ss(ix,izn)
                  end if         
                end do        
              end if   !porosity correction factor of secondary species

              
!c  read correction factors of tortuosity for secondary species

              subsection = 'tortuosity correction factor of secondary species for hMCD diffusion'
                
!c  search temporary data file for current material property zone
!c  and write to scratch file

              call findstrginzone(subsection,icnv,found_subsection)              
              
              if (found_subsection) then
                if (b_enable_output .and. b_enable_output_gen) then
                  write (igen,'(/a )')                                    &
                  'tortuosity correction factor of secondary species in zone: ', zone_name
                end if
                !read(itmp, *) subsection
                !write(*,*) subsection

                do ix = 1,nx
                  ierrcd = 32
                  read(icnv,*,err=999,end=999) f_etau_ss(ix,izn)   

    !c_bubbles write component dependent coefficients to generic output file
                  if (b_enable_output .and. b_enable_output_gen) then
                    write(igen,'(3a,1pe15.6e3)')                               &
                          'tortuosity correction factor for secondary specie ',&
                           namex(ix)(:l_namex(ix)),'  = ',                     &
                          f_etau_ss(ix,izn)
                  end if
                end do
              end if
             
            end if
          end do
        end if  !hmulti_diff 

!cdsu The porosity factor f_epor and tortuosity factor fetau are not used or 
!cdsu take any effect in the MCD code. This part is removed. 
       
      
!cdsu anisotropic tortuosity correction factor      
        useAnisoTauCorr = .false.
        if (useAnisoCorr) then
          subsection = 'anisotropic tortuosity correction'
          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
            useAnisoTauCorr = .true.
          end if
        end if

!cdsu anisotropic dispersivity correction      
        useAnisoDispCorr = .false.
        if (useAnisoCorr) then
          subsection = 'anisotropic dispersivity correction'
          call findstrg(subsection,itmp,found_subsection)
    
          if (found_subsection) then
            useAnisoDispCorr = .true.
          end if
        end if
        
!cprovi--------------------------------------------------------
!cprovi--------------------------------------------------------
!cprovi--------------------------------------------------------
!c  loop over property zones for 

        do izn = 1,nzn                !loop over property zones

!c  assign defaults for physical parameters for reactivs transport

          disx(izn) = r0
          disy(izn) = r0
          disz(izn) = r0

!c  search for entry for material property zone in input file

          zone_name = mprop_name(izn)

!c  define length of name of material property zone

          l_zone_name = index(zone_name,'  ')-1
          if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
            l_zone_name = 72
          end if

!c  search temporary data file for current material property zone
!c  and write to scratch file

          call readbloc (itmp,icnv,zone_name,found_subsection,.true.)

!c  read material properties

          if (found_subsection) then

!c  read physical parameters for reactive transport
   
!c  longitudinal dispersivity

            subsection = 'longitudinal dispersivity'

            call findstrg(subsection,icnv,found_subsection)

            if (found_subsection) then
              ierrcd = 33
              read(icnv,*,err=999,end=999) disx(izn)

            elseif (.not.found_subsection) then
              if (rank == 0) then
                write(ilog,*) 'section "',trim(section_header),'"'
                write(ilog,*) 'zone "', trim(zone_name),'"'
                write(ilog,*) 'subsection "',trim(subsection),'" missing'
                close(ilog)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop

            end if

!c  longitudinal tortuosity correction factor
            if (useAnisoTauCorr) then
              subsection = 'longitudinal anisotropic tortuosity factor'  
              call findstrg(subsection,icnv,found_subsection)  
              if (found_subsection) then
                ierrcd = 34
                read(icnv,*,err=999,end=999) atc_zone(izn)%x
              else
                if (rank == 0) then
                  write(ilog,*) 'section "',trim(section_header),'"'
                  write(ilog,*) 'zone "', trim(zone_name),'"'
                  write(ilog,*) 'subsection "',trim(subsection),'" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if
            end if


!c  transverse horizontal dispersivities

            if ((nvx.gt.1.and.nvy.gt.1).or.                            &
                ((node_max%x-node_min%x)>rsmall.and.                   &
                 (node_max%y-node_min%y)>rsmall)) then

              subsection = 'transverse horizontal dispersivity'

              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection) then
                ierrcd = 35
                read(icnv,*,err=999,end=999) disy(izn)

              elseif (.not.found_subsection) then
                if (rank == 0) then
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'section "',trim(section_header),'"'
                  write(ilog,*) 'zone "', trim(zone_name),'"'
                  write(ilog,*) 'subsection "',trim(subsection),'" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
   
              end if          !(found_subsection)

!c  transverse horizontal tortuosity correction factor
              if (useAnisoTauCorr) then
                subsection = 'transverse horizontal anisotropic tortuosity factor'
                call findstrg(subsection,icnv,found_subsection)
                if (found_subsection) then
                  ierrcd = 36
                  read(icnv,*,err=999,end=999) atc_zone(izn)%y
                else
                  if (rank == 0) then
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if
              end if            

            end if            !(nvx.gt.1......)

!c  transverse vertical dispersivities

            if (nvx.gt.1.and.nvz.gt.1.or.                             &
                nvy.gt.1.and.nvz.gt.1.or.                             &
                ((node_max%x-node_min%x)>rsmall.and.                  &
                 (node_max%z-node_min%z)>rsmall) .or.                 &
                ((node_max%y-node_min%y)>rsmall.and.                  &
                 (node_max%z-node_min%z)>rsmall)) then

              subsection = 'transverse vertical dispersivity'

              call findstrg(subsection,icnv,found_subsection)

              if (found_subsection) then
                ierrcd = 37
                read(icnv,*,err=999,end=999) disz(izn)

              elseif (.not.found_subsection) then
                if (rank == 0) then
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'section "',trim(section_header),'"'
                  write(ilog,*) 'zone "', trim(zone_name),'"'
                  write(ilog,*) 'subsection "',trim(subsection),'" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
  
              end if          !(found_subsection)

!c  transverse vertical tortuosity correction factor
              if (useAnisoTauCorr) then
                subsection = 'transverse vertical anisotropic tortuosity factor'
                call findstrg(subsection,icnv,found_subsection)
                if (found_subsection) then
                  ierrcd = 38
                  read(icnv,*,err=999,end=999) atc_zone(izn)%z
                else
                  if (rank == 0) then
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if
              end if

            end if            !(nvx.gt.1.....)

!c  write dispersivities for current material property zone
!c  to generic output file
   
!c  write parameters for variably saturated flow to generic output file

            if (b_enable_output .and. b_enable_output_gen) then

              write(igen,'(/a,i0,a,1x,a)') 'material property zone ',  &
                                            izn,':',                   &
                                            zone_name(:l_zone_name)

              write(igen,'(72a)')('-',i=1,72)
              write(igen,'(a,1pe15.6e3)')                              &
                'longitudinal dispersivity                       = ',  &
                disx(izn)

              if (nvx.gt.1.and.nvy.gt.1.or.                            &
                  nvx.gt.1.and.nvz.gt.1.or.                            &
                  nvy.gt.1.and.nvz.gt.1.or.                            &
                  ((node_max%x-node_min%x)>rsmall.and.                 &
                   (node_max%y-node_min%y)>rsmall).or.                 &
                  ((node_max%x-node_min%x)>rsmall.and.                 &
                   (node_max%z-node_min%z)>rsmall).or.                 &
                  ((node_max%y-node_min%y)>rsmall.and.                 &
                   (node_max%z-node_min%z)>rsmall)) then
                write(igen,'(a,1pe15.6e3)')                            &
                'transverse horizontal dispersivity              = ',  &
                 disy(izn)
              end if

              if ((nvx.gt.1.and.nvy.gt.1.and.nvz.gt.1) .or.            &
                  ((node_max%x-node_min%x)>rsmall.and.                 &
                   (node_max%y-node_min%y)>rsmall.and.                 &
                   (node_max%z-node_min%z)>rsmall)) then
                write(igen,'(a,1pe15.6e3)')                            &
                'transverse vertical dispersivity                = ',  &
                 disz(izn)
              end if
            
            end if

          elseif (.not.found_subsection) then
              
            if (rank == 0) then  

              write(ilog,*) 'error reading section "',                &
                            section_header(:l_string),                &
                           '" in input file'
              write(ilog,*) 'entry for material property zone "',     &
                            zone_name(:l_zone_name),'" missing'
              close(ilog)
            end if
            
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if         !(found_subsection)

        end do           !loop over material property zones

!cdsu  define if dispersivity are to be updated
        update_disprt = .false.

        subsection = 'transient dispersivity'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then        
          update_disprt = .true.
        else
          subsection = 'transient reactive transport dispersivity'
          call findstrg(subsection,itmp,found_subsection) 
          if (found_subsection) then        
            update_disprt = .true.
          end if               
        end if

!cdsu only update the boundary condition values, with boundary type and zone unchanged.
        update_disprt_value_only=.false.
        subsection = 'transient dispersivity: values only'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then
          update_disprt = .true.
          update_disprt_value_only = .true.
        else
          subsection = 'transient reactive transport dispersivity: values only'
          call findstrg(subsection,itmp,found_subsection)   
          if (found_subsection) then
            update_disprt = .true.
            update_disprt_value_only = .true.
          end if             
        end if

!cdsu currently the specified zones cannot be changed, so only the values can be changed.
        update_disprt_value_only = update_disprt

!cdsu linear interpolation for dispersivity, only if the 
!cdsu boundary condition type remains the same
        b_interpolation_disprt = .false.
        b_first_update_disprt = .false.

        if (update_disprt_value_only) then
          subsection = 'linear interpolation of dispersivity'
          call findstrg(subsection,itmp,found_subsection) 
          if (found_subsection) then
            b_interpolation_disprt = .true.
            b_first_update_disprt = .true.
          end if 
        end if   

!c  open file containing dispersivity values and read first time

        if (update_disprt) then
          idisprt = lun_get()
          ierrcd = 39
          open(idisprt,file=prefix(:l_prfx)//'.disprt',err=999, status='old')
          !cdsu skip comment line and rewind to the first record
          call rewind_first_record(idisprt)
          ierrcd = 40
          read(idisprt,*,err=999,end=999) time_disprt             
        end if

      end if             !(found_section)

      goto 1000

999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
