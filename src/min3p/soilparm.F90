!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/soilparm.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine soilparm
!c -------------------
!c
!c compute soil hydraulic parameters (variably saturated flow)
!c
!c written by:      Uli Mayer - May 28, 96
!c
!c last modified:   Uli Mayer - November 25, 96
!c
!c                  Danyang Su- Nov. 07, 2017
!c                              move volume loop outside so that node
!c                              based and cell based soil parameters
!c                              can be calculated using the same function
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           relperm(nn)        = relative permeability               * +
!c           sanew(nn)          = aqueous phase saturation            * +
!c                                - new time level
!c
!c           integer*4:
!c           ---------- 
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c
!c common: 
!c bbls.f:      logical
!c           --------
!c             gas_bubbles        =.true. -> gas phase saturation     + -
!c                                        is calculated
!c                                         below the water table
!c           bubble_perm        = .true. -> update permeability due 
!c                                         to change in gas 
!c                                         saturation
!c phys.f:   real*8:
!c           -------
!c           swr(nzn)           = residual saturation                 + -
!c           aentry(nzn)        = air entry pressure                  + -
!c           spalpha(nzn)       = soil hydraulic function parameter   + -
!c           spbeta(nzn)        = soil hydraulic function parameter   + -
!c           spgamma(nzn)       = soil hydraulic function parameter   + -
!c           expn(nzn)          = krw - p equation exponent           + -
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c           izn                = counter (zones)
!c
!c external: satfpres  = compute saturations from pressure
!c           relpfsat  = compute relative permeability from saturation
!c ----------------------------------------------------------------------
 
      subroutine soilparm(uvsnew,uvsold,sanew,saold,sonew,             &
                          sa_app,sa_eff,sg_eff,sa_min,aentry,swr,      &
                          spalpha,spbeta,spgamma,expn,                 &
                          relperm,relpermg,trap_bubbles,bubble_perm,   &
                          gas_bubbles,oil_saturation,unsaturated,      &
                          drainage,main_drain,big_bubble,              &
                          solvegb,sgr_imbi,sgt,sgt_old,                &
                          mip_mt_enable,mip_update_relperm,mip_g)
 
      implicit none

      real*8, intent(in) :: uvsnew,uvsold,saold,sonew,                 &
                            aentry,swr,spalpha,spbeta,spgamma,expn,    &
                            sgr_imbi,sgt_old
      logical, intent(in) :: trap_bubbles,bubble_perm,gas_bubbles,     &
                             oil_saturation,unsaturated,drainage,      &
                             main_drain,solvegb,                       &
                             mip_mt_enable,mip_update_relperm
      integer, intent(in) :: mip_g
      real*8, intent(inout) :: sa_app,sa_eff,sg_eff,sa_min,sanew,sgt,  &
                               relperm, relpermg
      logical, intent(inout) :: big_bubble



      real*8, external :: relpfsat,relpfsat_g, satfpres, satfpres_app

      real*8 :: sgr_eff, sa_eff_old, sanew_corr, par_land

      real*8, parameter :: r0 = 0.0d0,r1 = 1.0d0,relperm_min = 1.0d-03
      

!c  compute soil hydraulic parameters 

      if (uvsnew.lt.aentry) then
!c_trap    
        if (trap_bubbles) then
          if (unsaturated) then                                            !if node was previously unsaturated
            if(drainage.and.main_drain) then                               ! if on main drainage curve
              sa_app = satfpres_app(aentry,uvsnew,spalpha,spbeta,spgamma)
              sa_eff = sa_app
              sanew = sa_eff*(r1-swr)+swr
!c correct aqueous saturation when oil is present
              if (oil_saturation) then
                  sanew_corr = sanew * ( r1 - sonew )
              else
                  sanew_corr = sanew
              endif
                
              relperm = relpfsat(sanew_corr,swr,expn,spgamma)

            else                                                           ! if imbibition or on scanning drainage curve
              sa_app = satfpres_app(aentry,uvsnew,spalpha,spbeta,spgamma)
              par_land = (r1-swr)/sgr_imbi-r1
              if (sa_app.gt.sa_min) then
                sgt = (r1-sa_min)/(r1+par_land*(r1-sa_min))-         &
                      (r1-sa_app)/(r1+par_land*(r1-sa_app))
              else
                sgt=r0
              end if
              sa_eff = sa_app-sgt
              sa_eff_old = (saold-swr)/(r1-swr)

!c_trap determine sa_eff and sgt if gas saturation is greater than maximum (sgr)

              if (big_bubble) then
                if (drainage) then                                         ! if drainage on scanning curve
                  if (sa_eff.gt.sa_eff_old) then
                    sa_eff = sa_eff_old
                    sgt = sa_app-sa_eff
                  else
                    big_bubble = .false.
                  end if
                else                                                       ! if imbibition
                  if (sgt_old.gt.sgt) then
                   sgt = sgt_old
                   sa_eff = sa_app-sgt
                  end if
                end if
              end if                                                       !big_bubble
              sanew = sa_eff*(r1-swr)+swr
!c correct aqueous saturation when oil is present
              if (oil_saturation) then
                  sanew_corr = sanew * ( r1 - sonew )
              else
                  sanew_corr = sanew
              endif
                
              relperm = relpfsat(sanew_corr,swr,expn,spgamma)
            end if                                                         ! if drainage
          else if(.not.solvegb) then                                       !if node was saturated in previous timestep and gasbub has not been called during this time step
            sg_eff=(r1-saold)/(r1-swr)
            sgr_eff = sgr_imbi/(r1-swr)
            if (sg_eff.le.sgr_eff) then                                    !if bubble size is less than maximum trapped bubble size
              par_land = (r1-swr)/sgr_imbi-r1
              sa_min= (sg_eff+sg_eff*par_land-r1)/(sg_eff*par_land-r1)
              sa_app = satfpres_app(aentry,uvsold,spalpha,spbeta,spgamma)
              sgt = (r1-sa_min)/(r1+par_land*(r1-sa_min))-           &
                    (r1-sa_app)/(r1+par_land*(r1-sa_app))

              sa_eff = sa_app-sgt
              sanew = sa_eff*(r1-swr)+swr
!c correct aqueous saturation when oil is present
              if (oil_saturation) then
                sanew_corr = sanew * ( r1 - sonew )
              else
                sanew_corr = sanew
              endif
                
              relperm = relpfsat(sanew_corr,swr,expn,spgamma)
              big_bubble = .false.
            else                                                           !if bubble size is greater than maximum trapped bubble size
              sa_min= r0
              sa_app = satfpres_app(aentry,uvsnew,spalpha,spbeta,spgamma)
              par_land = (r1-swr)/sgr_imbi-r1
              sgt = (r1-sa_min)/(r1+par_land*(r1-sa_min))-           &
                    (r1-sa_app)/(r1+par_land*(r1-sa_app))

              sa_eff = sa_app-sgt
              sa_eff_old = (saold-swr)/(r1-swr)
              if (sa_eff.gt.sa_eff_old) then
                sa_eff= sa_eff_old
                sgt = sa_app-sa_eff
              end if
              sanew = sa_eff*(r1-swr)+swr
!c correct aqueous saturation when oil is present
              if (oil_saturation) then
                sanew_corr = sanew * ( r1 - sonew )
              else
                sanew_corr = sanew
              endif
                
              relperm = relpfsat(sanew_corr,swr,expn,spgamma)
              big_bubble=.true.
            end if
          end if             ! node previously saturated
        else if (mip_mt_enable .and. mip_update_relperm) then
          ! add codes here to update relative permeability, need modification
          if (mip_g > 0) then
            sanew = satfpres_app(aentry,uvsnew,spalpha,spbeta,spgamma)* &
                    (r1-swr)+swr
          else
            sanew = satfpres(swr,aentry,uvsnew,spalpha,spbeta,spgamma)
          end if
!c correct aqueous saturation when oil is present
          if (oil_saturation) then
            sanew_corr = sanew * ( r1 - sonew )
          else
            sanew_corr = sanew
          endif
          
          relperm = relpfsat(sanew_corr,swr,expn,spgamma)
        else                 ! if not trapped bubbles
            
          sanew = satfpres(swr,aentry,uvsnew,spalpha,spbeta,spgamma)
            
!c correct aqueous saturation when oil is present
          if (oil_saturation) then
            sanew_corr = sanew * ( r1 - sonew )
            else
              sanew_corr = sanew
            endif

          relperm = relpfsat(sanew_corr,swr,expn,spgamma)                     
        end if               ! if neither trapped bubbles nor mip trapped
                       
!c correct aqueous saturation when oil is present
        if (oil_saturation) then
            sanew_corr = sanew * ( r1 - sonew )
        else
            sanew_corr = sanew
          endif
        relpermg= relpfsat_g(sanew_corr,swr,expn,spgamma)
                     
      else                   ! if saturated
        if (trap_bubbles.and.unsaturated) then                        ! if this is the first time step that the node is saturated
          sa_app = r1
          par_land = (r1-swr)/sgr_imbi-r1
          sgt = (r1-sa_min)/(r1+par_land*(r1-sa_min))-               &
                (r1-sa_app)/(r1+par_land*(r1-sa_app))

          sa_eff = sa_app-sgt
          if (big_bubble) then
            if (sgt_old.gt.sgt) then
              sgt = sgt_old
              sa_eff = sa_app-sgt
            end if
          end if
          sanew = sa_eff*(r1-swr)+swr
        end if
!c_bubbles
        if (gas_bubbles.and.bubble_perm) then
!c correct aqueous saturation when oil is present
          if (oil_saturation) then
              sanew_corr = sanew * ( r1 - sonew )
          else
              sanew_corr = sanew
          endif
            
          relperm = relpfsat(sanew_corr,swr,expn,spgamma)
          relperm = dmax1(relperm,relperm_min)
            
          relpermg= relpfsat_g(sanew_corr,swr,expn,spgamma)

!cdsu for MIP_MT model, sanew is updated after calling bubble solver, 
!cdsu so just keep this
        else if (mip_mt_enable.and. .not.mip_update_relperm) then
!cdsu add codes here to update relative permeability, need modification
          relperm = r1
          relpermg = r0
        else if (gas_bubbles .and. .not.bubble_perm) then
          relperm = r1
          relpermg = r0
        else            
          sanew = r1
          relperm = r1
          relpermg = r0
        end if
          
      end if

      return
      end subroutine soilparm


!>
!> update relative permeability based on soil parameter
!>
      subroutine soilparm_perm(uvsnew,sanew,sonew,aentry,swr,          &
                          spgamma,expn,relperm,relpermg,bubble_perm,   &
                          gas_bubbles,oil_saturation,                  &
                          mip_mt_enable,mip_update_relperm)

      implicit none

      real*8, intent(in) :: uvsnew,sanew,sonew,aentry,swr,spgamma,expn
      logical, intent(in) :: bubble_perm,gas_bubbles,oil_saturation,   &
                             mip_mt_enable,mip_update_relperm

      real*8, intent(inout) :: relperm, relpermg


      real*8, external :: relpfsat,relpfsat_g, satfpres, satfpres_app

      real*8 ::   sanew_corr

      real*8, parameter :: r0 = 0.0d0,r1 = 1.0d0,relperm_min = 1.0d-03


      if (uvsnew.lt.aentry) then
!c correct aqueous saturation when oil is present
        if (oil_saturation) then
          sanew_corr = sanew * ( r1 - sonew )
        else
          sanew_corr = sanew
        endif

        relperm = relpfsat(sanew_corr,swr,expn,spgamma)
                                                 ! node previously saturated
        relpermg= relpfsat_g(sanew_corr,swr,expn,spgamma)

      else                                       ! if saturated

!c_bubbles
        if ((gas_bubbles.and.bubble_perm) .or.                         &
            (mip_mt_enable.and.mip_update_relperm)) then
!c correct aqueous saturation when oil is present
          if (oil_saturation) then
            sanew_corr = sanew * ( r1 - sonew )
          else
            sanew_corr = sanew
          endif

          relperm = relpfsat(sanew_corr,swr,expn,spgamma)
          relperm = dmax1(relperm,relperm_min)

          relpermg= relpfsat_g(sanew_corr,swr,expn,spgamma)
        else
          relperm = r1
          relpermg = r0
        end if

      end if

      return
      end subroutine soilparm_perm
