!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/clstpfls.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine clstpfls
!c -------------------
!c
!c close postprocessing files for transient data (local chemistry)
!c
!c written by:      Uli Mayer - May 14, 96
!c
!c last modified:   Uli Mayer - January 30, 98
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:  -
!c
!c common:   
!c chem.f:   integer*4:
!c           ----------
!c           ilbt               = unit number, total aqueous          + -
!c                                             component
!c                                             concentrations
!c                                             - transient data
!c                                               local system
!c           ilbb               = unit number, concentrations of      + -
!c                                             sorbed species
!c                                             - transient data
!c                                               local system
!c           ilbc               = unit number, free species and       + -
!c                                             secondary aqueous
!c                                             species concentrations
!c                                             - transient data
!c                                               local system
!c           ilbac              = unit number, activity coefficients  + -
!c                                             - transient data
!c                                               local system
!c           ilbm               = unit number, master variables       + -
!c                                             - transient data
!c                                               local system
!c           ilbg               = unit number, gas concentrations     + -
!c                                             - transient data
!c                                               local system
!c           ilbgr              = unit number, degassing rates        + -
!c                                             - transient data
!c                                               local system
!c           ilbi               = unit number, rates of intra-aqueous + -
!c                                             kinetic reactions
!c                                             - transient data
!c                                               local system
!c           ilbs               = unit number, saturation indices     + -
!c                                             - transient data
!c                                               local system
!c           ilbv               = unit number, mineral volume         + -
!c                                             fractions
!c                                             - transient data
!c                                               local system
!c           ilbd               = unit number, dissolution-           + -
!c                                             precipitation
!c                                             rates
!c                                             - transient data
!c                                               local system
!c           ilbx               = unit number, saturation indices     + -
!c                                             excluded minerals
!c                                             - transient data
!c                                               local system
!c           naq                = number of intra-aqueous kinetic     + -
!c                                reactions
!c           ng                 = number of gases                     + -
!c           nm                 = number of minerals                  + -
!c           nmx                = number of excluded minerals         + -
!c           nr                 = number of redox couples             + -
!c           nsb                = number of sorbed species            + -
!c           nsb_ion            = number of sorbed species            + -
!c                                (ion-exchange)
!c           nsb_surf           = number of sorbed species            + -
!c                                (surface-complex)
!c
!c           logical:
!c           --------
!c           gas_removal        = .true.  -> degassing of dissolved   + -
!c                                           gases, if confining
!c                                           pressure exceeded
!c           noncompetitive_sorption = logical array for activation   + -   
!c                                     of noncompetitive sorption
!c                                     reactions
!c           redox_equil        = .true.  -> equilibrium reactions    + -
!c                                           for redox couples
!c
!c local:    -
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine clstpfls

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use chem
      use nobleGasIngrowth, only : b_use_ngi, ngre_i
      use gen, only : b_output_activity, b_output_trans_binary
      use file_unit, only : lun_free
      use module_binary_mpiio, only : binary_file_close
      
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

!c  close output files for transient data (local system)

      if (b_output_trans_binary) then
          
        call binary_file_close(ilbt,.true.)                !total concentrations
        call binary_file_close(ilbc,.true.)                !species concentrations
        call binary_file_close(ilbm,.true.)                !master variables
      
        if (b_output_activity) then
          call binary_file_close(ilbac,.true.)             !activity coefficient
        end if

        if (ng.gt.0) then
          call binary_file_close(ilbg,.true.)              !partial gas pressures
          if (gas_removal) then
            call binary_file_close(ilbgr,.true.)           !degassing rates
          end if
        end if
 
        if (naq.gt.0.or.(nr.gt.0).and.(.not.redox_equil)) then
          call binary_file_close(ilbi,.true.)              !intra-aqueous kinetic reactions
        end if

        if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then
          call binary_file_close (ilbb,.true.)             !sorbed species
        end if

        if (nm.gt.0) then
          call binary_file_close(ilbd,.true.)              !dissolution-precipitation rates
          call binary_file_close(ilbs,.true.)              !mineral saturation indices
          call binary_file_close(ilbv,.true.)              !mineral volume fractions
        end if

        if (nmx.gt.0) then
          call binary_file_close(ilbx,.true.)              !saturation indices (excludes minerals)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          call binary_file_close(ilbre,.true.)             !concentration of radioelement
        end if        
          
      else    

        close(ilbt)                !total concentrations
        close(ilbc)                !species concentrations
        close(ilbm)                !master variables
        call lun_free(ilbt)
        call lun_free(ilbc)
        call lun_free(ilbm)
      
        if (b_output_activity) then
          close(ilbac)             !activity coefficient
          call lun_free(ilbac)
        end if

        if (ng.gt.0) then
          close(ilbg)              !partial gas pressures
          call lun_free(ilbg)
          if (gas_removal) then
            close(ilbgr)           !degassing rates
            call lun_free(ilbgr)
          end if
        end if
 
        if (naq.gt.0.or.(nr.gt.0).and.(.not.redox_equil)) then
          close(ilbi)              !intra-aqueous kinetic reactions
          call lun_free(ilbi)
        end if

        if (nsb_ion.gt.0.or.nsb_surf.gt.0.or.noncompetitive_sorption) then
          close(ilbb)             !sorbed species
          call lun_free(ilbb)
        end if

        if (nm.gt.0) then
          close(ilbd)              !dissolution-precipitation rates
          close(ilbs)              !mineral saturation indices
          close(ilbv)              !mineral volume fractions
          call lun_free(ilbd)
          call lun_free(ilbs)
          call lun_free(ilbv)
        end if

        if (nmx.gt.0) then
          close(ilbx)              !saturation indices (excludes minerals)
          call lun_free(ilbx)
        end if

!cdsu concentration of radioelement related to noble gas ingrowth
        if (b_use_ngi .and. ngre_i > 0) then
          close(ilbre)             !concentration of radioelement
          call lun_free(ilbre)
        end if       
      
      end if

      return
      end
