!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/file_unit.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!> module of file unit allocation
!c ----------------------------------------------------------------------
!c
!c automatic get a file unit to open the file
!c
!c written by:      Danyang Su - October 28, 2014
!c
!c last modified:
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           itmp
!c
!c           logical:
!c           ---------
!c           found_name
!c
!c           character:
!c           ----------
!c           name
!c
!c common:   -
!c
!c local:    character:
!c           ----------
!c           string
!c
!c external: -
!c ----------------------------------------------------------------------
module file_unit

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

    use gen, only : ilog, idbg, rank
    
#ifdef PETSC
    use petsc_mpi_common, only : petsc_mpi_finalize
#endif

    implicit none

#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC
      PetscErrorCode :: ierrcode
#endif
    
    public :: lun_get, lun_set, lun_free, lun_available,               &
              get_lun_min_used, get_lun_max_used, get_file_opened

    integer, parameter :: lun_success = 0             !lun: Logical Unit Number
    integer, parameter :: lun_none_free = -1
    integer, parameter :: lun_not_open = -2
   
    private
    
    integer :: max_lun_used

    integer, parameter :: min_lun = 30000             !File number 1-30000 is reserved for binary output
                                                      !as binary output automatically generate file unit
    integer, parameter :: max_lun = 65545             !Maximum file number of 65536 including input files
    
    logical, dimension(min_lun:max_lun) :: lun_open = .false.
    
    contains

    !>
    !> Get the minimum file unit used by current function
    !>
    integer function get_lun_min_used()

      implicit none

      get_lun_min_used = min_lun

    end function get_lun_min_used

    !>
    !> Get the minimum file unit used by current function
    !>
    integer function get_lun_max_used()

      implicit none

      get_lun_max_used = max_lun_used

    end function get_lun_max_used

    !>
    !> Get if the file is opened
    !>
    logical function get_file_opened(i)

      implicit none

      integer, intent(in) :: i

      get_file_opened = lun_open(i)

    end function get_file_opened
    
    !>
    !> Get file unit number
    !>
    integer function lun_get()
      
      implicit none
      
      integer :: i
      logical :: flag

      flag = .false.
    
      do i = min_lun, max_lun
        if (.not. lun_open(i)) then
          lun_get = i
          lun_open(i) = .true.
          flag = .true.
          max_lun_used = i
          exit
        end if
      end do

      if (flag) then
        return
      end if
      
      lun_get = lun_none_free
      
      if (rank == 0) then
        write(*,*) "Error: Get file unit number exceed maximum value"
        write(ilog,'(a)') "Error: Get file unit number exceed maximum value"
        write(ilog,'(a)') "       Increase the maximum value and recompile"
        close(ilog)
      end if
      
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
    
    end function lun_get
    
    !>
    !> Set file unit number
    !>
    subroutine lun_set(lun_to_set)
      
      implicit none
      
      integer :: lun_to_set
      
      integer :: i
      
      i = lun_to_set
      
      if (i>=min_lun .and. i<=max_lun) then
        lun_open(i) = .true.
        if (i > max_lun_used) then
          max_lun_used = i
        end if
        return
      end if

      if (rank == 0) then
        write(*,*) "Error: Set file unit number exceed maximum value"
        write(ilog,'(a)') "Error: Set file unit number exceed maximum value"
        write(ilog,'(a)') "       Increase the maximum value and recompile"
        write(ilog,'(a,i10)') "Error file unit value ", lun_to_set
        close(ilog)
      end if
      
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
    
    end subroutine lun_set
    
    !>
    !> Free file unit number
    !>
    subroutine lun_free(lun_to_free)
    
      implicit none
      
      integer :: lun_to_free
      integer :: i
      
      i = lun_to_free
      
      if (i>=min_lun .and. i<=max_lun) then      
        if (lun_open(i)) then
          lun_open(i) = .false.
          if (i == max_lun_used) then
            max_lun_used = max_lun_used - 1
          end if
        end if
      end if

      return

      if (rank == 0) then
        write(*,*) "Warning: Free file unit number exceed maximum value"
        write(ilog,'(a)') "Warning: Free file unit number exceed maximum value"
        write(ilog,'(a)') "         Increase the maximum value and recompile"
        write(ilog,'(a,i10)') "Warning file unit value ", lun_to_free
      end if
      
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop
    
    end subroutine lun_free
    
    !>
    !> Check if file unit number is occupied
    !> return false if occupied
    !>
    logical function lun_available(lun_to_check)
    
      implicit none
      
      integer :: lun_to_check
      
      integer :: i
      
      i = lun_to_check
      
      if (i>=min_lun .and. i<=max_lun) then      
        if (lun_open(i)) then
          lun_available = .false.
        else
          lun_available = .true.   
        end if
      else
        lun_available = .true.  
      end if

      return

    end function lun_available

end module file_unit
