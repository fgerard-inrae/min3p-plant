!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/readsit.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine readsit
!c -------------------
!c
!c read database for SIT model (sit.dbs) and assign to 
!c permanent storage
!c
!c written by:      Mingliang Xie - March 08, 2018
!c
!c last modified:   Mingliang Xie - March 08, 2018
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   integer*4:
!c           ----------
!c           isitdbs            = unit number, database for           + -
!c                                             SIT parameters
!c           ilog               = unit number, log book               + -
!c           idbg               = unit number debugging file          + -
!c
!c common:
!c chem.f:   real*8:
!c           -------
!c           coef(nc+nx,nc+nx)  = local 2D array for store the SIT    * +
!c                                coefficients
!c
!c           integer*4:
!c           ----------
!c           iax(nx+1)          = row pointer array to                * +
!c                                stoichiometric coefficients of
!c                                free species in
!c                                secondary aqueous species
!c           jax(nx*nc)         = column pointer array to             * +
!c                                stoichiometric coefficients of
!c                                free species in secondary aqueous
!c                                species
!c           nc                 = number of components including h2o  + -
!c           nx                 = number of secondary aqueous species + -
!c 
!c           logical:
!c           --------
!c           search_database    = .true.  -> search database for      + -
!c                                           all secondary species
!c                                           possible and list in
!c                                           file prefix_o.psp
!c
!c           character:
!c           ----------
!c           namec(nc)          = component names                     + -
!c           namex(nx)          = names of secondary aqueous species  + -
!c           namet(30)          = species names of (temporary)        * *
!c           namecx(500)        = name of primary plus secondary      * +
!c                                 species for SIT model
!c
!c local:    real*8:
!c           -------
!c           alkfac             = alkalinity factor (temporary)
!c           charge             = charge (temporary)
!c           dha                = debye huckel a (temporary)
!c           dhb                = debye huckel b (temporary)
!c           dhc                = enthalpy change (temporary)
!c           eqt                = log equilibrium constant 
!c                                (temporary)
!c           gfw                = gram formula weight (temporary)
!c           xnuxt(iv)          = stoichiometric coefficient of 
!c                                component in secondary aqueous 
!c                                species (temporary)
!c
!c           integer*4:
!c           ----------
!c           nv                 = number of components with 
!c                                non-zero stoichiometric 
!c                                coefficient in secondary
!c                                aqueous species (temporary)
!c           ic                 = counter (components)
!c           ix                 = counter (secondary aqueous 
!c                                species)
!c           icount             = counter (check number of species)
!c           iv                 = counter (number of components
!c                                with non-zero stoichiometric
!c                                coefficient in secondary
!c                                aqueous species
!c           icur               = counter (position in single
!c                                subscripted array)
!c           istart             = pointer
!c           iend               = pointer
!c           i                  = counter
!c           l_name             = length of name
!c
!c           logical:
!c           --------          
!c           done               = logical variable to stop search
!c           found              = logical variable to stop search
!c
!c           character:
!c           ----------
!c           name               = name of current secondary aqueous
!c                                species (temporary)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine readsit(isitdbs,ilog,idbg)
 
      use parm
      use chem
      use multidiff
      use gen, only : rank, b_enable_output, idbs_bk, use_dbs_bk,      &
                      mem_cur, mem_max, memory_monitor
      use file_utility, only : makelowercase, replacecharacter, readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif 
      implicit none
      
      integer :: isitdbs,ilog,idbg, ncx, ipsp, ixdbs,i_debug
      
      integer :: i, ic, icount, icur, istart, iend, ix, iv, l_name,    &
                 nv, info_debug, icx, jcx,ierr,nncx, jtemp
      

      character*72 name, junk
      character(len=1024) :: strbuffer
      character*1 string
      character*1, parameter :: strspace = ' '

      real (type_r8), allocatable :: coef(:,:)
      logical done,found, bexist, comment_line
      real*8 null, r0, charge,sitfac
      
      parameter (r0 = 0.0d0)
      
      allocate (coef(nc+nx,nc+nx), stat = ierr)
      coef=0.0d0
      call checkerr(ierr,'coef',ilog)
      call memory_monitor(sizeof(coef),'coef',.true.)


!c  search database for possible SIT epsilon coefficients of two species
      if (nc .gt. 0) then
        ncx = nc + nx
        do ic = 1,nc
          namecx(ic) = namec(ic)
        end do
        
        do ix = 1,nx
          namecx(nc+ix) = namex(ix)
        end do
      end if
      
      
!c read the SIT database to find the related SIT coefficients
!c  and saved in the temparary variable coef(:,:)

      if (search_database) then

        if (rank == 0 .and. b_enable_output) then  
          write(ilog,'(72a/a/72a/)')('*',i=1,72),                      &
     &          'Read SIT database for the coefficients',        &
     &          ('*',i=1,72)                                             
          write(ilog,'(a/)') '-------------------------' 
        end if
        
        done = .false.
        icount = 0        
        
        do while (.true.)    
             
 !c  skip over comment lines in database

          comment_line = .true.
          do while (comment_line)
            read (isitdbs,'(a1)',end=9998,err=9999) string
            if (string.ne.'!') comment_line = .false.
          end do

!c  backspace to start of database entry for current line

          backspace(isitdbs)
 
!c  skip over comment lines in database
          read(isitdbs,'(a)',end=9998,err=9999) strbuffer
          strbuffer = adjustl(strbuffer)
          if (len_trim(strbuffer) == 0) then
            cycle  
          end if
          
!c make lower case and replace tab with space
          call makelowercase(strbuffer)
          call replacecharacter(strbuffer, achar(9), strspace) 
          call replacecharacter(strbuffer, "'", strspace)
          call replacecharacter(strbuffer, '"', strspace)
          strbuffer = trim(adjustl(strbuffer))
          iend = index(strbuffer,strspace)
          if (iend <= 1) then
            goto 999
          end if
          namet(1) = strbuffer(1:iend-1)
          
          if (namet(1).eq.'end') goto 999
                   
          strbuffer = trim(adjustl(strbuffer(iend:))) 
          iend = index(strbuffer,strspace)
          read(strbuffer,*,end=9998,err=9999) namet(2)
          
          strbuffer = trim(adjustl(strbuffer(iend:))) 
          iend = index(strbuffer,strspace)
          read(strbuffer,*,end=9998,err=9999) sitfac
          
          if (namet(1).eq.namet(2) .or. abs(sitfac) .gt. 10.0) goto 9999
          
          do icx = 1, ncx
             
            if (namecx(icx) .eq. namet(1) .or.                          &
                namecx(icx) .eq. namet(2)) then
                                
              if (namecx(icx) .eq. namet(1)) then

                do jcx = 1, ncx
                  if (namecx(jcx) .eq. namet(2)) then
                    coef(icx,jcx) = sitfac
                    coef(jcx,icx) = sitfac
                    icount = icount + 1
                  end if
                        
                  if (icount .eq. ncx) then
                    done = .true.
                    goto 999
                  end if
                end do
              end if
  
            end if
                    
          end do
        end do
        

        if (namet(1).eq.'end' .and. icount .lt. 1) then
          goto 9998
        end if
999     continue
      end if               !search_database

!c  Print out the SIT coefficients found in the sit.dbs database
!c    in *.log file
      nncx = count(coef /= r0)
      allocate (iasit(ncx+1), stat = ierr)
      iasit=0
      call checkerr(ierr,'iasit',ilog)
      call memory_monitor(sizeof(iasit),'iasit',.true.)

      allocate (jasit(nncx), stat = ierr)
      jasit=0
      call checkerr(ierr,'jasit',ilog)
      call memory_monitor(sizeof(jasit),'jasit',.true.)

      allocate (coepsil(nncx), stat = ierr)
      coepsil=0
      call checkerr(ierr,'coepsil',ilog)
      call memory_monitor(sizeof(coepsil),'coepsil',.true.)
      
      iasit(1) = 1
      jtemp = 0
      do icx = 1, ncx
        iasit(icx+1) = iasit(icx) + count(coef(icx,:) /= r0)
        do jcx = 1, ncx
          if (coef(icx,jcx) /= r0) then
            jtemp = jtemp + 1
            jasit(jtemp) = jcx
            coepsil(jtemp) = coef(icx,jcx)
          end if
        end do
      end do
      
#ifdef DEBUG
      !write(ilog,*) "no. of non-0 values = ",nncx
      !do icx = 1, ncx
      !  do jcx = 1, ncx
      !    if (coef(icx,jcx) .ne. r0) then
      !        write(ilog,'(2a,1x,1pe15.6e3)') namecx(icx),namecx(jcx),coef(icx,jcx)
      !    end if
      !  end do
      !end do
#endif

!c  ---- activate this section for purposes of debugging -----
#ifdef DEBUG
      i_debug = 0      
      if (i_debug > 10) then
        do icx = 1, ncx
          istart = iasit(icx)
          iend = iasit(icx+1)-1
          do jtemp = istart, iend
            write(idbg,*) "icx",icx,"jcx",jasit(jtemp),                          &
                  "namecx(icx)",namecx(icx), "namecx(jcx)",namecx(jasit(jtemp)), &
                  "coefsit(icx,jcx)",coepsil(jtemp)
          end do
        end do
        write(idbg,*)
        write(idbg,*) '---------------------------------------------'
        write(idbg,*) '!!!STOP in readsit.f90'

#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
 
      end if
#endif

!c  write backup of database items to the file
      if (rank == 0) then
        if (.not.use_dbs_bk) then
          write(*,'(1x,a)') 'start of database backup: sit.dbs'
          write(idbs_bk, '(a)') '<------ sit.dbs: start of SIT epsilon coefficients ------>'      
          rewind(isitdbs)
          do while(readnextline(isitdbs,strbuffer,original=.true.))
            do icx = 1, ncx
              if (index(adjustl(strbuffer),trim(namecx(icx))) >= 1) then
                write(idbs_bk,'(a)') trim(strbuffer)
              end if
            end do
          end do
          rewind(isitdbs)
          !write(idbs_bk, '(a)') 'end'      
          write(idbs_bk, '(a/)') '<------ sit.dbs: end of SIT epsilon coefficients ------>'
          write(*,'(1x,a)') 'end of database backup: sit.dbs'
        end if
      end if

!c---------release the memory of coef(*,*)
      call memory_monitor(-sizeof(coef),'coef',.true.)
      deallocate(coef)

      return

9998  continue
      backspace(isitdbs)
      read(isitdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'end of reading in SIT database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'end of reading in SIT database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

9999  continue
      backspace(isitdbs)
      read(isitdbs,'(a)') strbuffer
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,'(2a)') 'error reading in SIT database: ',trim(strbuffer)
        write(*,*) 'SIMULATION TERMINATED'
        write(*,'(2a)') 'error reading in SIT database: ',trim(strbuffer)
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

997   continue
      if (rank == 0) then
        write(ilog,*) 'Warning in reading SIT.dbs:'
        write(ilog,*) 'The SIT coefficients of one or more primary or secondary species were not found.'
        write(*,*) 'Warning in reading SIT.dbs:'
        write(*,*) 'The SIT coefficients of one or more primary or secondary species were not found.'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop      

      end
  
