!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/tprfvs_faceflux.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tprfvs
!c -----------------
!c
!c write transient data of interface flux for variably saturated flow 
!c simulation to output file
!c
!c written by:      Danyang Su - Nov 27, 2017
!c
!c last modified:   -
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c
!c passed:   integer*4:
!c           ----------
!c           ivol               = pointer to current control volume   + -
!c           jvol               = pointer to current control volume   + -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c
!c           logical:
!c           --------
!c
!c
!c local:    real*8:
!c           ------- 
!c
!c 
!c --------------------------------------------------------------------------

      subroutine tprfvs_faceflux(ivol,jvol,igb,ngb_tstep)
 
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif
      use gen, only : fully_saturated, upstream, ngb_vol_ijface_jtemp, &                      
                      hhead, uvsnew, relperm, cinfvs_a, xg, yg, zg,    &
                      gacc, nfloatbit, realbuffer_gb, igfvel,          &
                      b_use_fixed_flow_vel, fixed_flow_vel,            &
                      offset_igfvel, ngb_vol_ijface_area,              &
                      offset_igfvel_ijk, ngb_vol_ijface_velratio,      &
                      time_io, b_output_trans_binary
      use dens, only : density_dependence, av_dens_z, density,      &
                       viscosity
      use module_binary_mpiio, only : binary_write_data

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: ivol, jvol, igb, ngb_tstep
      
      !c local variables
      integer :: i1sav, nvars
      real*8 :: vel, velx, vely, velz, dflux, del_p, del_z, rho_av,      &
                dcoef
      character*1 :: iups   
      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, rhalf = 0.5d0      
      real*8, external :: fluxfs, fluxvs, fluxdd

      if (b_use_fixed_flow_vel) then
              
        velx = fixed_flow_vel%x
        vely = fixed_flow_vel%y
        velz = fixed_flow_vel%z
      
      else
        i1sav = ngb_vol_ijface_jtemp(igb)

        if (i1sav <= 0) then
          return
        end if

!c compute flux along the control volume interface
        if (density_dependence) then

          del_p = uvsnew(jvol) - uvsnew(ivol)
          del_z = zg(jvol) - zg(ivol)

          if (del_z .ne. r0) then
            rho_av = rhalf * (density(ivol) + density(jvol))
            if (av_dens_z) then
              del_p = rho_av*(uvsnew(jvol)/density(jvol)-        &
                              uvsnew(ivol)/density(ivol))
            end if

!c  convert del_z to total elevation potential wrt fluid pressure
!c  and calculate difference in total pressure potential

            del_z = del_z * rho_av * gacc
            del_p = del_p + del_z
          end if

          if (upstream) then
            if (del_p .gt. r0) then
              iups = 'j'
              dcoef = relperm(jvol) * density(jvol)/viscosity(jvol)
            else
              iups = 'i'
              dcoef = relperm(ivol) * density(ivol)/viscosity(ivol) !upstream kr, density & visc
            end if
          else
            dcoef = (density(ivol)+density(jvol))/             &
                    (viscosity(ivol)+viscosity(jvol))
          end if

          dflux = - fluxdd(del_p,cinfvs_a(i1sav), dcoef)

        else
          if (.not.fully_saturated) then
            if (upstream) then
              iups = 'i'                            !h_i >= h_j
              if (hhead(jvol).gt.hhead(ivol)) then  !h_j > h_i
                iups = 'j'
              end if
            end if      
            dflux = - fluxvs(upstream,hhead(ivol),                     &
                             hhead(jvol),relperm(ivol),                &
                             relperm(jvol),iups,                       &
                             cinfvs_a(i1sav))                     
          else if (fully_saturated) then                                                              
            dflux = - fluxfs(uvsnew(ivol),uvsnew(jvol),cinfvs_a(i1sav))
          end if
        end if
      
      
!c  velocity is the flux (m^3/day) divided
!c  by the interfacial area between the two control volumes
!c  this is darcy velocity, not the linear groundwater velocity, for the later one,
!c  the velocity should be divided by the porosity, averaged by adjacent vols (DSU, 2017-08-02)
        vel = dflux / ngb_vol_ijface_area(igb)
        velx = vel*ngb_vol_ijface_velratio(1,igb)
        vely = vel*ngb_vol_ijface_velratio(2,igb)
        velz = vel*ngb_vol_ijface_velratio(3,igb)
      end if

!c  write data back to file
      if (b_output_trans_binary) then
        nvars = 4 
        realbuffer_gb(1:nvars)= (/time_io,velx,vely,velz/)
        
        call binary_write_data(igfvel(igb), 1, (/ngb_tstep/),          &
                    offset_igfvel_ijk(igb),.true.)
        call binary_write_data(igfvel(igb), nvars, realbuffer_gb,      &
                    offset_igfvel(igb),.true.) 

        offset_igfvel(igb) = offset_igfvel(igb) + nvars*nfloatbit
      else
        write(igfvel(igb),'(4e15.6e3)') time_io,velx,vely,velz
      end if

      return
      end subroutine tprfvs_faceflux
