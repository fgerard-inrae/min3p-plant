!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/tstepfs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tstepfs
!c ------------------
!c
!c estimate magnitude of next time step (full saturated flow)
!c
!c written by:      Danyang Su - April, 2015
!c
!c last modified:   
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           delt               = time step                           + -
!c           delt_vs            = estimated time step                 * +
!c                                (variably saturated flow)
!c           deltmax            = maximum time step                   + -
!c           deltmin            = minimum time step                   + -
!c           saold(nn)          = aqueous phase saturation            + -
!c                                - old time level
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           sw_star            = anticipated change in saturation    + -
!c                                per time step
!c           integer*4:
!c           ----------
!c           nn                 = total number of control volumes     + -
!c
!c local:    real*8:
!c           -------
!c           delta_sw           = saturation change
!c           r0                 = constant
!c           rhalf              = constant 
!c           r5                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine tstepfs

      use gen
      use dens

      implicit none

      real*8 :: delt_vs_iter

!c  calculate average newton iteration numbers in each timestep.
      if (iter_vs_ant > 0) then
        if (iter_sia <= 1) then
          iter_vs_ave = max(real(iter_vs),1.0d0)
        else
          iter_vs_ave = (iter_vs_ave*(iter_sia-1) + iter_vs)/iter_sia
        end if
!c  compute factor based on anticipated number of Newton iterations
!c  assume linear relationship for now        
        delt_vs_iter = iter_vs_ant/iter_vs_ave
!c  use more aggressive strategy to push the upper limit of
!c  iter_vs_ant, time step increase must be larger than time
!c  step decrease, if iter_vs = iter_vs_ant+1
        if (iter_vs_ave <= iter_vs_ant) then
          delt_vs_iter = real(iter_vs_ant+2)/real(iter_vs_ant)*        &
                         delt_vs_iter
        end if
!c  take square root of factor for smoother changes
        delt_vs_iter = sqrt(delt_vs_iter)                
      else
        delt_vs_iter = 2.0d0
      end if

!c  new time step estimate for variably saturated flow
      delt_vs = delt_vs*delt_vs_iter
      delt_vs = dmin1(delt_vs, deltmax)         !lower bound - min. time step

      return
      end
