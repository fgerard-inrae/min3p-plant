!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/mem_njavs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine mem_njavs
!c --------------------
!c
!c allocate memory for one-dimensional arrays of size njavs
!c
!c written by:      Uli Mayer - January 6, 2000
!c
!c last modified:   -
!c
!c last modified:   -
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cinfrt_va(njavs)   = influence coefficients              * +
!c                                (advection - aqueous phase)
!c           cinfrt_da(njavs)   = influence coefficients              * +
!c                                (dispersion - aqueous phase)
!c           cinfrt_dg(njavs)   = influence coefficients              * +
!c                                (diffusion - gaseous phase)
!c           cinfvs(njavs)      = influence coefficients              * +
!c                                (variably saturated flow)

!c Added for Multi-Diff
!c           deltaij(njavs)     = distance between i-j                * +
!c           tauij(njavs)       = aqueous tortuosity at i-j           * +
!c           porij(njavs)       = aqueous filled porosity at i-j      * +
!c           gsatij(njavs)      = gas saturation at i-j               * +
!c           satij(njavs)       = aqueous saturation at i-j           * +
!c added for gas transport:
!c 
!c           deltaij(njavs)     = distance between i-j                * +
!c           tauij(njavs)       = gas tortuosity at i-j               * +
!c           gporij(njavs)      = gas-filled porosity at i-j          * +
!c           gsatij(njavs)      = gas saturation at i-j               * +
!c 
!c           integer*4:
!c           ----------
!c           iupsg(njavs)       = upstream node for gas transport     * +
!c
!c -------------------------
!c           integer*4:
!c           ----------
!c           ilog               = unit number, logbook file           + -
!c           isymvs(njavs)      = symmetry pointer array              + +
!c           iwork(:)           = integer work array                  * *
!c           javs(njavs)        = connectivity list for 1d-scalar     + +
!c                                matrix
!c           lart(njavs+1)      = pointer array                       * +
!c           njavs              = number of global connections        + -
!c
!c           logical:
!c           --------
!c           reactive_transport = .true.  -> perform reactive         + -
!c                                           transport simulation
!c           varsat_flow        = .true.  -> perform flow simulation  + -
!c
!c local:    integer*4:
!c           ----------
!c           i1                 = pointer
!c           ierr               = 0 -> memory allocation successful
!c
!c external: checkerr  = check for error during memory allocation
!c
!c---------------------------------------------------------------------- 
!c WARNING
!c---------------------------------------------------------------------- 
!c All allocated variables are initialized to some value. This depends  
!c of its type:
!c 
!c real*8      => 0.0d0
!c integer     => 0 
!c character   => ' '    
!c logical     => .false. 
!c 
!c Sergio Andres Bea Jofre (2009)
!c
!c ----------------------------------------------------------------------
  
      subroutine mem_njavs
 
      use parm
      use gen
      use chem 
      use multidiff
      use dgml, only : dgm, maxwell
#ifdef OPENMP
      use omp_lib 
#endif

#ifdef USG
      use geometry_definition
      use usg_mesh_data, only : cvol_method, num_edge_dvols, num_edge_maxcells
#endif

      implicit none
      
      integer :: i1, ierr

      external checkerr
      
      real*8, parameter    :: r0=0.0d0
      
!c  allocate work array  
      allocate (iwork(njavs), stat = ierr)
      iwork=0
      call checkerr(ierr,'iwork',ilog)
      call memory_monitor(sizeof(iwork),'mem_njavs-iwork',.true.)
      
!c  minimize memory requirements for array javs

      do i1 = 1,njavs
        iwork(i1) = javs(i1)
      end do

      call memory_monitor(-sizeof(javs),'javs',.true.)
      deallocate (javs, stat = ierr)
      call checkerr(ierr,'javs',ilog)

      allocate (javs(njavs), stat = ierr)
      javs=0
      call checkerr(ierr,'javs',ilog)
      call memory_monitor(sizeof(javs),'javs',.true.)

      do i1 = 1,njavs
        javs(i1) = iwork(i1)
      end do
      
#ifdef PETSC
      do i1 = 1,njavs
        iwork(i1) = col_idx_l2pg_vs(i1)
      end do

      call memory_monitor(-sizeof(col_idx_l2pg_vs),'col_idx_l2pg_vs',.true.)
      deallocate (col_idx_l2pg_vs, stat = ierr)
      call checkerr(ierr,'col_idx_l2pg_vs',ilog)

      allocate (col_idx_l2pg_vs(njavs), stat = ierr)
      col_idx_l2pg_vs=0
      call checkerr(ierr,'col_idx_l2pg_vs',ilog)
      call memory_monitor(sizeof(col_idx_l2pg_vs),'col_idx_l2pg_vs',.true.)

      do i1 = 1,njavs
        col_idx_l2pg_vs(i1) = iwork(i1)
      end do
#endif

!c  minimize memory requirements for array isymvs

      do i1 = 1,njavs
        iwork(i1) = isymvs(i1)
      end do

      call memory_monitor(-sizeof(isymvs),'isymvs',.true.)
      deallocate (isymvs, stat = ierr)
      call checkerr(ierr,'isymvs',ilog)

      allocate (isymvs(njavs), stat = ierr)
      isymvs=0
      call checkerr(ierr,'isymvs',ilog)
      call memory_monitor(sizeof(isymvs),'isymvs',.true.)

      do i1 = 1,njavs
        isymvs(i1) = iwork(i1)
      end do
      
!c  deallocate work array
      call memory_monitor(-sizeof(iwork),'mem_njavs-iwork',.true.)
      deallocate (iwork, stat = ierr)
      call checkerr(ierr,'iwork',ilog)

!c  arrays for flow solution

      allocate (cinfvs(njavs), stat = ierr)
      cinfvs=r0
      call checkerr(ierr,'cinfvs',ilog)
      call memory_monitor(sizeof(cinfvs),'cinfvs',.true.)

#ifdef USG
      if (discretization_type>0) then
        call memory_monitor(-sizeof(cinfvs),'cinfvs',.true.)
        deallocate(cinfvs)
      end if
#endif


      allocate (cinfrad(njavs), stat = ierr)
      cinfrad=r0
      call checkerr(ierr,'cinfrad',ilog)
      call memory_monitor(sizeof(cinfrad),'cinfrad',.true.)
      

      allocate (cinfvs_a(njavs), stat = ierr)
      cinfvs_a=r0
      call checkerr(ierr,'cinfvs_a',ilog)
      call memory_monitor(sizeof(cinfvs_a),'cinfvs_a',.true.)
#ifdef USG
      if (discretization_type>0) then
        call memory_monitor(-sizeof(cinfvs_a),'cinfvs_a',.true.)
        deallocate(cinfvs_a)
      end if
#endif
      

      if (reactive_transport) then
        if (ng.gt.0 .or. multi_diff) then
          allocate(javsrec(njavs), stat = ierr)
          javsrec = 0
          call checkerr(ierr,'javsrec',ilog)
          call memory_monitor(sizeof(javsrec),'javsrec',.true.)
          is_javsrec_set = .false.
        end if
      end if


      if (reactive_transport .and. ng.gt.0) then
        allocate (cinfvs_g(njavs), stat = ierr)
        cinfvs_g=r0
        call checkerr(ierr,'cinfvs_g',ilog)
        call memory_monitor(sizeof(cinfvs_g),'cinfvs_g',.true.)

        allocate (permij(njavs), stat = ierr)
        permij=r0
        call checkerr(ierr,'permij',ilog)
        call memory_monitor(sizeof(permij),'permij',.true.)

#ifdef USG
        if (discretization_type > 0) then
          call memory_monitor(-sizeof(cinfvs_g),'cinfvs_g',.true.)
          deallocate(cinfvs_g)
        end if
#endif
      end if


!c  arrays for reactive transport solutione

      if (reactive_transport) then
        allocate (cinfrt_va(njavs), stat = ierr)
        cinfrt_va=r0
        call checkerr(ierr,'cinfrt_va',ilog)
        call memory_monitor(sizeof(cinfrt_va),'cinfrt_va',.true.)
#ifdef USG
        if (discretization_type > 0) then
          call memory_monitor(-sizeof(cinfrt_va),'cinfrt_va',.true.)
          deallocate(cinfrt_va)

          allocate(cinfrt_va_usg(njavs), stat = ierr)
          cinfrt_va_usg = r0
          call checkerr(ierr,'cinfrt_va_usg',ilog)
          call memory_monitor(sizeof(cinfrt_va_usg),'cinfrt_va_usg',.true.)
        end if
#endif
      end if

      if (reactive_transport) then
        allocate (cinfrt_da(njavs), stat = ierr)
        cinfrt_da=r0
        call checkerr(ierr,'cinfrt_da',ilog)
        call memory_monitor(sizeof(cinfrt_da),'cinfrt_da',.true.)
#ifdef USG
        if (discretization_type>0) then
          call memory_monitor(-sizeof(cinfrt_da),'cinfrt_da',.true.)
          deallocate(cinfrt_da)
        end if
#endif
      end if
      
  
      if (reactive_transport .and. ng > 0) then
        allocate (cinfrt_dg(njavs), stat = ierr)
        cinfrt_dg=r0
        call checkerr(ierr,'cinfrt_dg',ilog)
        call memory_monitor(sizeof(cinfrt_dg),'cinfrt_dg',.true.)
#ifdef USG
        if (discretization_type > 0) then
          call memory_monitor(-sizeof(cinfrt_dg),'cinfrt_dg',.true.)
          deallocate(cinfrt_dg)
        end if
#endif
      end if
  
      if (reactive_transport) then
        allocate (lart(njavs+1), stat = ierr)
        lart=0 
        call checkerr(ierr,'lart',ilog)
        call memory_monitor(sizeof(lart),'lart',.true.)
      end if  
      
  
      if (reactive_transport) then
        allocate (iupsg(njavs), stat = ierr)
        iupsg = ' '
        call checkerr(ierr,'iupsg',ilog)
        call memory_monitor(sizeof(iupsg),'iupsg',.true.)
      end if  
      
  
      if (reactive_transport) then
        allocate (gsatij(njavs), stat = ierr)
        gsatij = r0
        call checkerr(ierr,'gsatij',ilog)
        call memory_monitor(sizeof(gsatij),'gsatij',.true.)
      end if 
      
!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------

      if (reactive_transport) then
        allocate (cinfrt_da_ic(nc,njavs), stat = ierr)
        call checkerr(ierr,'cinfrt_da_ic',ilog)
        cinfrt_da_ic=r0
        call memory_monitor(sizeof(cinfrt_da_ic),'cinfrt_da_ic',.true.)
#ifdef USG
        if (diff_coff) then
          if (discretization_type > 0) then
            call memory_monitor(-sizeof(cinfrt_da_ic),'cinfrt_da_ic',.true.)
            deallocate(cinfrt_da_ic)
          end if
        end if
#endif
      end if

     
!CMX test        if (multi_diff) then

      if (reactive_transport .and. multi_diff) then      
        allocate (cinfrt_mcd(njavs), stat = ierr)
        cinfrt_mcd=0.0d0
        call checkerr(ierr,'cinfrt_mcd',ilog)
        call memory_monitor(sizeof(cinfrt_mcd),'cinfrt_mcd',.true.)

#ifdef USG
        if (discretization_type > 0) then
          call memory_monitor(-sizeof(cinfrt_mcd),'cinfrt_mcd',.true.)
          deallocate(cinfrt_mcd)
        end if
#endif
      end if
        
      if (reactive_transport) then
        allocate (deltaij(njavs), stat = ierr)
        deltaij=0.0d0
        call checkerr(ierr,'deltaij',ilog)
        call memory_monitor(sizeof(deltaij),'deltaij',.true.)
      end if
        
      if (reactive_transport) then
        allocate (gporij(njavs), stat = ierr)
        gporij=0.0d0
        call checkerr(ierr,'gporij',ilog)
        call memory_monitor(sizeof(gporij),'gporij',.true.)
      end if
  
      if (reactive_transport) then
        allocate (tauij(njavs), stat = ierr)
        tauij=0.0d0
        call checkerr(ierr,'tauij',ilog)
        call memory_monitor(sizeof(tauij),'tauij',.true.)
      end if

      if (reactive_transport) then
        allocate (porij(njavs), stat = ierr)
        porij=0.0d0
        call checkerr(ierr,'porij',ilog)
        call memory_monitor(sizeof(porij),'porij',.true.)
      end if

      if (reactive_transport) then
        allocate (satij(njavs), stat = ierr)
        satij=0.0d0
        call checkerr(ierr,'satij',ilog)
        call memory_monitor(sizeof(satij),'satij',.true.)
      end if
!CMX    end if   ! multi_diff
 
!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------

        if (heat_transport) then 
            allocate (cinfheat_c(njavs), stat = ierr)
            cinfheat_c=r0
            call checkerr(ierr,'cinfheat_c',ilog)
            call memory_monitor(sizeof(cinfheat_c),'cinfheat_c',.true.)
#ifdef USG
            if (discretization_type > 0) then
              call memory_monitor(-sizeof(cinfheat_c),'cinfheat_c',.true.)
              deallocate(cinfheat_c)
            end if
#endif
        end if

        if (heat_transport) then
            allocate (cinfheat_d(njavs), stat = ierr)
            cinfheat_d=r0
            call checkerr(ierr,'cinfheat_d',ilog)
            call memory_monitor(sizeof(cinfheat_d),'cinfheat_d',.true.)
#ifdef USG
           if (discretization_type > 0) then
             call memory_monitor(-sizeof(cinfheat_d),'cinfheat_d',.true.)
             deallocate(cinfheat_d)
           end if
#endif
        end if

        if (heat_transport) then
            allocate (distcells(njavs,2), stat = ierr)
            distcells=r0
            call checkerr(ierr,'distcells',ilog)
            call memory_monitor(sizeof(distcells),'distcells',.true.)
        end if

        if (heat_transport.and.evaporation.and.variably_saturated) then
           allocate (cinfevap_pa(njavs), stat = ierr)
           cinfevap_pa=r0
           call checkerr(ierr,'cinfevap_pa',ilog)
           call memory_monitor(sizeof(cinfevap_pa),'cinfevap_pa',.true.)
#ifdef USG
           if (discretization_type > 0) then
             call memory_monitor(-sizeof(cinfevap_pa),'cinfevap_pa',.true.)
             deallocate(cinfevap_pa)
           end if
#endif
        end if

        if (heat_transport.and.evaporation.and.variably_saturated) then
           allocate (cinfevap_t(njavs), stat = ierr)
           cinfevap_t=r0
           call checkerr(ierr,'cinfevap_t',ilog) 
           call memory_monitor(sizeof(cinfevap_t),'cinfevap_t',.true.)
#ifdef USG
           if (discretization_type > 0) then
             call memory_monitor(-sizeof(cinfevap_t),'cinfevap_t',.true.)
             deallocate(cinfevap_t)
           end if
#endif
        end if   

        if (heat_transport.and.evaporation.and.variably_saturated) then
           allocate (cinfvs_t(njavs), stat = ierr)
           cinfvs_t=r0
           call checkerr(ierr,'cinfvs_t',ilog)
           call memory_monitor(sizeof(cinfvs_t),'cinfvs_t',.true.)
#ifdef USG
           if (discretization_type > 0) then
             call memory_monitor(-sizeof(cinfvs_t),'cinfvs_t',.true.)
             deallocate(cinfvs_t)

             allocate (coeff_t_usg(njavs), stat = ierr)
             coeff_t_usg = r0
             call checkerr(ierr,'coeff_t_usg',ilog)
             call memory_monitor(sizeof(coeff_t_usg),'coeff_t_usg',.true.)
           end if
#endif
        end if

!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------
!cprovi-----------------------------------------------------------  
      return
      end
