!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initiice.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initiice
!c -------------------
!c
!c initial condition for ice loading/unloading
!c
!c written by:      Danyang Su - March 29, 20
!c
!c last modified:   
!c
!c ----------------------------------------------------------------------

    subroutine initiice

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif 
      use gen
      use file_unit, only : lun_get, lun_free
      use file_utility, only : findnextline, readnextline
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

#ifdef USG
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use geometry
      use usg_ice_sheet
      use usg_mesh_surface
      use usg_mesh_data, only : is_boundary_node, b_use_cell_matids,   &
                                b_use_node_matids, num_nodes_per_layer,&
                                node_to_layer_node, cell_projection
      use read_zone_usg, only : read_zone_usg_input, type_extent_zone, &
                                type_extent_zone_box
#endif

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
#endif
      integer :: i, ic, iiz, ivol, ivol_ln, ivol_sn, iunitice,         &
                 ierr, niz, nwarns, nerrs, nwarns_gbl, nerrs_gbl,      &
                 l_string, ixmf, iiice, niice, niicep, l_sufx, ierrcd

      integer, allocatable :: iaiice(:)

      real*8 :: ximin, ximax, yimin, yimax, zimin, zimax ,factiny,     &
                rdummy

      character*1   :: cdummy
      character*72  :: subsection 
      character*5   :: suffix
      character*256 :: strbuffer, strfilename, strfilename_result,     &
                       strfilename_mesh

      external :: readbloc
 
      logical :: found_section, found_subsection, initcond_file, iserror

      real*8, parameter :: r0 = 0.0d0, tiny = 1.0d-8 
#ifdef USG
#ifdef PETSC_HDF
      integer(HID_T) :: iunitice_hdf5
#endif
      type(ice_fitting_type) :: ice_fitting_parm
      logical :: initcond_file_vtk, initcond_file_hdf5, bfound, bexist
      character*72 :: subcommand
      character*2048 :: strbuffer2048
#endif

#ifdef PETSC 
      PetscErrorCode :: ierrcode
#endif  

      ierrcd = 0

!c  read numerical data and write to temporary file
!c  open file for ice sheet mesh and results output
      l_sufx = 0
      if (igstime.lt.10) then
        write(suffix,'(i1)') igstime
        if (tran_steady_flow) then
          suffix = "o_"//suffix(:1)
          l_sufx = 3
        else
          l_sufx = 1
        end if
      elseif (igstime.ge.10.and.igstime.lt.100) then
        write(suffix,'(i2)') igstime
        if (tran_steady_flow) then
          suffix = "o_"//suffix(:2)
          l_sufx = 4
        else
          l_sufx = 2
        end if
      elseif (igstime.ge.100.and.igstime.lt.1000) then
        write(suffix,'(i3)') igstime
        if (tran_steady_flow) then
          suffix = "o_"//suffix(:3)
          l_sufx = 5
        else
          l_sufx = 3
        end if
      elseif (igstime.gt.1000) then
        if (rank == 0) then
          write(ilog,'(/a)')'error in input file'
          write(ilog,'(a)')'max. number of output times exceeded'
          write(ilog,'(a)')'abnormal exit in routine outputrt'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  new ice sheet control parameter for general structured and unstructured mesh
      section_header = 'initial condition - ice sheet loading/unloading' 
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  terminate program if section header not found
      if (.not.found_section) then
        if (rank == 0) then  
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
  
!c  define length of section header                                      
                                                                        
      l_string = index(section_header,'  ')-1 
      if (l_string.eq.-1.or.l_string.gt.72) then 
         l_string=72 
      end if

!c  write section header to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/72a)')('-',i=1,72) 
        write(igen,'(a)') section_header(:l_string) 
        write(igen,'(72a/)')('-',i=1,72) 
      end if

!c  write section header to screen and log file
      if (b_enable_output .and. rank == 0) then
        write(*,*) section_header(:l_string) 
        write(*,*)('-',i=1,72) 

        write(ilog,'(a)') section_header(:l_string) 
        write(ilog,'(72a/)')('-',i=1,72) 
      end if

!c  define logical flag to determine if initial condition will be
!c  - read from file (ice sheet thickness and basal temperature)
!c  - specified in input file

      subsection = 'read initial condition from file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        initcond_file = .true.
      else
        initcond_file = .false.
      end if

#ifdef USG
      subsection = 'read initial condition from vtk file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        initcond_file_vtk = .true.
      else
        initcond_file_vtk = .false.
      end if

      subsection = 'read initial condition from hdf5 file'

      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        initcond_file_hdf5 = .true.
      else
        initcond_file_hdf5 = .false.
      end if
#endif

!c  read initial condition from file

      if (initcond_file) then
 
!c  open file containing initial condition
!c  *.gsp file format

        iunitice = lun_get()
        open(iunitice,file=prefix(:l_prfx)//'.ice',status='old',       &
             form='formatted')

        do i = 1,3
          read(iunitice,*,err=997,end=997) cdummy       !skip header
        end do

!c  read ice sheet thickness and basal temperature
!c  important note: read data from layered surface nodes
#ifdef USG
        do ivol_ln = 1, num_nodes_per_layer
          ivol_sn = node_idx_ln2sn(ivol_ln)
          if (ivol_sn > 0) then
            read(iunitice,*,err=997,end=997) rdummy,rdummy,rdummy,     &
                 ice_thickness_new(ivol_sn),ice_thickness_phw2ice_new(ivol_sn)
          else
            read(iunitice,*,err=997,end=997) rdummy
          end if
        end do
        ice_thickness_old = ice_thickness_new
        ice_thickness_phw2ice_old = ice_thickness_phw2ice_new
#endif

!c  close file
        close(iunitice)
        call lun_free(iunitice)

!c  initial condition specified in input file
#ifdef USG
!c  vtk file format
      else if (initcond_file_vtk) then
!c  open file containing initial condition

        iunitice = lun_get()
        open(iunitice,file=prefix(:l_prfx)//'.ice.vtk',status='old',   &
             form='formatted')

        subcommand = "scalars thickness double"
        bfound = findnextline(iunitice, subcommand, 0, .false.)
        if (bfound) then
          !c skip "LOOKUP_TABLE default"
          if(readnextline(iunitice, strbuffer2048, withquote=.false.)) then
            if (trim(strbuffer2048) == "lookup_table default") then
              do ivol_ln = 1, num_nodes_per_layer
                ivol_sn = node_idx_ln2sn(ivol_ln)
                if (ivol_sn > 0) then
                  read(iunitice,*,err=998,end=998) ice_thickness_new(ivol_sn)
                else
                  read(iunitice,*,err=998,end=998) rdummy
                end if
              end do
              ice_thickness_old = ice_thickness_new
            end if
          end if
        end if

        !c ice thickness due to positive water head
        subcommand = "scalars thickness_phw2ice double"
        bfound = findnextline(iunitice, subcommand, 0, .false.)
        if (bfound) then
          !c skip "LOOKUP_TABLE default"
          if(readnextline(iunitice, strbuffer2048, withquote=.false.)) then
            if (trim(strbuffer2048) == "lookup_table default") then
              do ivol_ln = 1, num_nodes_per_layer
                ivol_sn = node_idx_ln2sn(ivol_ln)
                if (ivol_sn > 0) then
                  read(iunitice,*,err=998,end=998) ice_thickness_phw2ice_new(ivol_sn)
                else
                  read(iunitice,*,err=998,end=998) rdummy
                end if
              end do
              ice_thickness_phw2ice_old = ice_thickness_phw2ice_new
            end if
          end if
        end if

!c  close file
        close(iunitice)
        call lun_free(iunitice)

!c  hdf5 file format, for parallel version only
#ifdef PETSC_HDF
      else if (initcond_file_hdf5) then

!c  open file containing initial condition
        iunitice = lun_get()
        iunitice_hdf5 = int(iunitice,kind(HID_T))
        strfilename = prefix(:l_prfx)//'.ice.h5'

        call hdf5_usg_read_layer_node_var(iunitice_hdf5,               &
                  trim(strfilename),"results", "thickness",            &
                  ice_thickness_new, bexist, hdf5_ierr)
        if (hdf5_ierr < 0) then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error in reading thickness from hdf5 file'
            write(ilog,*) 'file: ',trim(strfilename)
            close(ilog)
          end if
          call petsc_mpi_finalize
          stop
        else
          if (rank == 0) then
            write(*,'(a)') 'read thickness from hdf5 file: done'
            write(ilog,'(a)') 'read thickness from hdf5 file: done'
          end if
        end if

        ice_thickness_old = ice_thickness_new

        !c ice thickness due to positive water head
        call hdf5_usg_read_layer_node_var(iunitice_hdf5,               &
                  trim(strfilename),"results", "thickness_phw2ice",    &
                  ice_thickness_phw2ice_new, bexist, hdf5_ierr)
        if (hdf5_ierr < 0) then
          if (rank == 0) then
            write(ilog,*) 'SIMULATION TERMINATED'
            write(ilog,*) 'error in reading thickness from hdf5 file'
            write(ilog,*) 'file: ',trim(strfilename)
            close(ilog)
          end if
          call petsc_mpi_finalize
          stop
        else
          if (rank == 0) then
            write(*,'(a)') 'read thickness from hdf5 file: done'
            write(ilog,'(a)') 'read thickness from hdf5 file: done'
          end if
        end if

        ice_thickness_phw2ice_old = ice_thickness_phw2ice_new

        call lun_free(iunitice)
#endif

#endif
      else

!c  read number of zones for initial condition
 
        rewind(itmp)
        ierrcd = 1
        read(itmp,*,err=999,end=999) niz
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,'(a,i10)')                                        &
               'number of zones for initial condition           = ',niz
        end if

!c initialize array for ice initial conditions 
        allocate (iaiice(nngl), stat = ierr) 
        iaiice=0 
        call checkerr(ierr,'iaiice',ilog)
        call memory_monitor(sizeof(iaiice),'iaiice',.true.)      
  
        
        property_iflag = 0

        niice = 0
        iaiice(1) = 1

!c  read name of zone

        do iiz = 1, niz                !loop over number of zones

!c  temporary pointer for output         
          niicep = niice+1           

          subsection = 'number and name of zone'

          call findzone(subsection,itmp,found_subsection,iiz,zone_name)

          if (found_subsection) then
            call readzone(itmp,icnv,ilog,zone_name,found_subsection)
          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error in input file'
              write(ilog,*) 'section "',section_header(:l_string),'"'
              write(ilog,*) 'zone number "',iiz, '" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

!c  define length of zone name

          l_zone_name = index(zone_name,'  ')-1
          if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
            l_zone_name = 72
          end if

!c  read initial condition for current zone

          subsection = 'initial condition'

          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then
            ierrcd = 2
            read(icnv,'(a)',err=999,end=999) strbuffer
            strbuffer = adjustl(strbuffer)

            if(index(strbuffer,'gradient') == 2) then
#ifdef USG
              if(index(strbuffer,'gradient-top') == 2) then
                ice_fitting_parm%itype_grad = 2
              else if(index(strbuffer,'gradient-bottom') == 2) then
                ice_fitting_parm%itype_grad = 1
              else
                ice_fitting_parm%itype_grad = 0
              end if

              if (.not. b_use_layered_mesh) then
                ice_fitting_parm%itype_grad = 0
              end if

              ice_fitting_parm%btypezn = 'gradient'
              ice_fitting_parm%nparms = 3
              ierrcd = 3
              read(icnv,*,err=999,end=999) ice_fitting_parm%dir_grad
              read(icnv,*,err=999,end=999) ice_fitting_parm%thick_grad
              read(icnv,*,err=999,end=999) ice_fitting_parm%thick_slope_grad
              if (ice_fitting_parm%dir_grad/='x'.and.   &
                  ice_fitting_parm%dir_grad/='y'.and.   &
                  ice_fitting_parm%dir_grad/='z') then
                if (rank == 0) then
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error in input file'
                  write(ilog,*) 'section "',section_header(:l_string),'"'
                  write(ilog,*) 'Error in gradient direction'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if
#endif
            else if(index(strbuffer,'curve fitting ice sheet model') == 2) then
#ifdef USG
              ice_fitting_parm%btypezn = 'curve-fitting'
              ice_fitting_parm%nparms = 5
              ierrcd = 4
              read(icnv,*,err=999,end=999) ice_fitting_parm%sea_level
              read(icnv,*,err=999,end=999) ice_fitting_parm%sea_level_temp_coeff         
              read(icnv,*,err=999,end=999) ice_fitting_parm%ice_thick_sea_level_coeff
              read(icnv,*,err=999,end=999) ice_fitting_parm%sea_level_threshold
              read(icnv,*,err=999,end=999) ice_fitting_parm%elevation_threshold
#endif
            else if(index(strbuffer,'ellipsoid fitting ice sheet model') == 2) then
#ifdef USG             
              ice_fitting_parm%btypezn = 'ellipsoid-fitting'
              ice_fitting_parm%nparms = 7
              ierrcd = 5
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_x0
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_y0
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_z0
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_a
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_b
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_c
              read(icnv,*,err=999,end=999) ice_fitting_parm%ellip_alpha
#endif 
            else
#ifdef USG
              ice_fitting_parm%nparms = 1
              ierrcd = 6
              read(strbuffer,*,err=999,end=999) ice_fitting_parm%btypezn,      &
                                                ice_fitting_parm%ice_thickness
#endif
            end if

          else
            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',trim(section_header),'"'
              write(ilog,*) 'zone "', trim(zone_name),'"'
              write(ilog,*) 'subsection "',trim(subsection),'" missing'
              close(ilog)
            end if
            
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if
          
!c  read coordiantes delineating zone

          type_extent_zone = -1
          type_extent_zone_box = -1

          subsection = 'extent of zone'
          call findstrg(subsection,icnv,found_subsection)

          if (found_subsection) then
            type_extent_zone = 0
            ierrcd = 7
            read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax,   &
                                         zimin,zimax
          end if

#ifdef USG
          call read_zone_usg_input(icnv)
          if (type_extent_zone_box > 0) then
            ierrcd = 8
            read(icnv,*,err=999,end=999) ximin,ximax,yimin,yimax,   &
                                         zimin,zimax
          end if
#endif

          !c check if x dimension is valid
          if (.not.btest(cell_projection,0)) then
            ximin = -1.0d300
            ximax = 1.0d300
          end if
  
          !c check if y dimension is valid
          if (.not.btest(cell_projection,1)) then
            yimin = -1.0d300
            yimax = 1.0d300
          end if
  
          !c check if z dimension is valid
          if (.not.btest(cell_projection,2)) then
            zimin = -1.0d300
            zimax = 1.0d300
          end if

!c  write error information if 'extent of zone' is missing
          if (type_extent_zone < 0) then

            if (rank == 0) then
              write(ilog,*) 'SIMULATION TERMINATED'
              write(ilog,*) 'error reading input file'
              write(ilog,*) 'section "',trim(section_header),'"'
              write(ilog,*) 'zone "', trim(zone_name),'"'
              write(ilog,*) 'subsection "',trim(subsection),'" missing'
              close(ilog)
            end if
#ifdef PETSC
            call petsc_mpi_finalize
#endif
            stop

          end if

!c  increment coordinates delineating zone

          ximin = ximin-tiny
          ximax = ximax+tiny
          yimin = yimin-tiny
          yimax = yimax+tiny
          zimin = zimin-tiny
          zimax = zimax+tiny

!c  assign initial condition to global system

          do ivol = 1,nngl

!c  skip internal nodes
#ifdef USG
            ivol_sn = node_idx_lg2sn(ivol)
            if (ivol_sn < 1) then
              cycle
            end if
#endif
!c  check limits of boundary zone
            if (((type_extent_zone==0.or.type_extent_zone_box>0) .and. &
                (xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax) .and.      &
                (yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax) .and.      &
                (zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)) .or.      &
                (type_extent_zone>0 .and. node_iflags(ivol)>=0 .and.     &
                ibits(type_extent_zone,0,1)==0)) then

#ifdef USG
              if (discretization_type > 0 .and. type_extent_zone_box > 0) then
                if ((btest(type_extent_zone_box,1) .and.               &
                     .not. is_boundary_node(ivol)) .or.                &
                    (btest(type_extent_zone_box,2) .and.               &
                     is_boundary_node(ivol))) then
                  cycle
                end if
              end if
#endif

              property_iflag(ivol) = property_iflag(ivol) + 1

              niice = niice+1
              iaiice(niice) = ivol

#ifdef USG
              !c calculate ice sheet thickness 
              call usg_ice_cal_thickness(ivol_sn,ice_fitting_parm)
              ice_thickness_old(ivol_sn) = ice_thickness_new(ivol_sn)
#endif
            end if     !(zg(ivol).gt.zimin).and.(zg(ivol).lt.zimax)
                       !(yg(ivol).gt.yimin).and.(yg(ivol).lt.yimax)
                       !(xg(ivol).gt.ximin).and.(xg(ivol).lt.ximax)
          end do

!  write header for boundary zone to generic output file                
          if (b_enable_output .and. b_enable_output_gen) then
            write(igen,'(/a,i0,a,1x,a)') 'zone ',iiz,':',zone_name 
            write(igen,'(72a)')('-',i=1,72)                                          

#ifdef PETSC   
            write(igen,'(2(a,3x),a,5x,a/)') 'local volume',            &
                  'global volume', 'thickness' 
#else
            write(igen,'(2x,a,5x,a/)') 'volume', 'thickness'
#endif

            do iiice=niicep,niice
              ivol = iaiice(iiice)
#ifdef USG
              ivol_sn = node_idx_lg2sn(ivol)
#ifdef PETSC
              if(node_idx_lg2l(ivol) > 0) then
                write(igen,'(i10,5x,i10,6x,1pe15.6e3,1x)')             &
                      ivol,node_idx_lg2g(ivol),                        &
                      ice_thickness_new(ivol_sn)
              end if
#else
              write(igen,'(i8,3x,1pe15.6e3,1x)') ivol,                 &
                    ice_thickness_new(ivol_sn)
#endif
#endif
            end do
          end if

        end do              !end loop over zones

!c  check if all initial condition for ice sheet loading/unloading have been set
        nwarns = 0
        nerrs = 0
#ifdef USG
        do ivol_sn = 1, num_nodes_sn
          ivol = node_idx_sn2lg(ivol_sn)
          if (property_iflag(ivol) == 0) then
            nerrs = nerrs + 1
          else if (property_iflag(ivol) > 1) then
            nwarns = nwarns + 1
          end if
        end do
#endif

#ifdef PETSC
        call MPI_Allreduce(nerrs,nerrs_gbl,1,MPI_INTEGER4,MPI_SUM,     &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        nerrs = nerrs_gbl        

        call MPI_Allreduce(nwarns,nwarns_gbl,1,MPI_INTEGER4,MPI_SUM,   &
                           Petsc_Comm_World,ierrcode)
        CHKERRQ(ierrcode)
        nwarns = nwarns_gbl       
#endif

        if (nerrs > 0) then
          if (b_enable_output .and. rank == 0) then
            write(igen,'(a,1x,i8,1x,a)')                               &
                  "Error: initial condition is not set for ",nerrs,    &
                  "control volumes"
          end if
        end if

        if (nwarns > 0) then
          if (b_enable_output .and. rank == 0) then
            write(igen,'(a,1x,i8,1x,a)')                               &
                  "Warning: initial condition is duplicate for",nwarns,&
                  "control volumes"
          end if
        end if

      end if                !initcond_file

!c  free space for array not required any more
      call memory_monitor(-sizeof(iaiice),'iaiice',.true.)
      deallocate (iaiice, stat = ierr)
      call checkerr(ierr,'iaiice',ilog)


!c  global ice thickness, used for pore stress calculation
#ifdef USG
#ifdef PETSC
      ice_thickness_gbl_tmp = r0
      do ivol_sn = 1, num_nodes_sn 
        ivol_ln = node_to_layer_node(node_idx_sn2lg(ivol_sn))
        ice_thickness_gbl_tmp(ivol_ln) = ice_thickness_new(ivol_sn)
      end do

      call MPI_Allreduce(ice_thickness_gbl_tmp,ice_thickness_gbl_new,  &
                         num_nodes_per_layer,MPI_REAL8,MPI_MAX,        &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      ice_thickness_gbl_old = ice_thickness_gbl_new

      ice_thickness_gbl_tmp = r0
      do ivol_sn = 1, num_nodes_sn 
        ivol_ln = node_to_layer_node(node_idx_sn2lg(ivol_sn))
        ice_thickness_gbl_tmp(ivol_ln) = ice_thickness_phw2ice_new(ivol_sn)
      end do

      call MPI_Allreduce(ice_thickness_gbl_tmp,ice_thickness_phw2ice_gbl_new,  &
                         num_nodes_per_layer,MPI_REAL8,MPI_MAX,        &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      ice_thickness_phw2ice_gbl_old = ice_thickness_phw2ice_gbl_new
#endif
#endif
      
      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'error reading file ', prefix(:l_prfx)//'.ice'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop      

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'error reading file ', prefix(:l_prfx)//'.ice.vtk'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
  