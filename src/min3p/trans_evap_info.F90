!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/trans_evap_info.F90 $
!---------------------------------------------------------------------
!********************************************************************!

subroutine trans_evap_info (isinitial,ngb_tstep)
#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
use petscsys
#endif
#endif


use parm
use gen
use phys
use dens
use chem 
use writeversion
use file_utility, only : reposition_file, check_rewind_status
use m_heat_transport, only : b_icewater_heat, heatcapw, heatcapi,     &
                             offset_ievap, offset_ievap_ijk

use module_binary_mpiio, only : binary_file_open,                     &
                                tecplot_binary_write_header,          &
                                tecplot_binary_write_variable,        &
                                tecplot_binary_write_zoneinfo,        &
                                tecplot_binary_write_section,         &
                                binary_write_data

implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

logical :: isinitial
integer :: ngb_tstep

real*8 dummy1, dummy2, dummy3, dummy4, evaploc, hsloc, levaploc,       &
       pvloc, radnetloc, rainloc, rainheat, runoffloc, seepage,        &
       total, windloc, relheat_iw

real*8, external :: relheat_freezing

real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0, r1000=1.0d3, r86400=86400.0d0

integer :: nvarsievap, irecord
character*72 :: tec_variables(100)
character*2048 :: strbuffer
logical :: b_rewind_valid

nvarsievap = 14

if (isinitial) then
  if (b_output_trans_binary) then    
    call binary_file_open(PETSC_COMM_SELF,         &
                 ievap, prefix(:l_prfx)//'_o.evap', .true.)
  else
    b_rewind_valid = check_rewind_status(prefix(:l_prfx)//'_o.evap')
    if (b_rewind_valid .and. i_append_sim > 0) then
      open(ievap,file=prefix(:l_prfx)//'_o.evap',status='unknown',     &
           form='formatted',position='rewind')
    else
      open(ievap,file=prefix(:l_prfx)//'_o.evap',status='unknown',     &
           form='formatted')
    end if
  end if
!c  version information
  if (i_append_sim < 1 .or. .not.b_rewind_valid) then
    if (b_writeversion_tecplot .and. .not. b_output_trans_binary) then
      call writeversion2file(ievap, "#")
    end if
  end if
        
  if (b_output_trans_binary) then    
    tec_variables(1:nvarsievap) = [character(len=72) :: "time", & 
                                   "ev [kg s-1 m-2]", &
                                   "temp [oC] ", &
                                   "hr [-]", &
                                   "wind [m s-1]", &
                                   "rain [kg s-1 m-2]", &
                                   "runoff [kg s-1 m-2]", &
                                   "rain - runoff [kg s-1 m-2]", &
                                   "rho_v [kg m-3]", &
                                   "pv [Pa]", &
                                   "rad [J s-1 m-2]", &
                                   "lw*ev [J s-1 m-2]", &
                                   "hs [J s-1 m-2]", &
                                   "total [J s-1 m-2]"]
    strbuffer = "temporal evolution about energy "//&
                "and evaporation parameters"
    
    offset_ievap = 0  
    call tecplot_binary_write_header(PETSC_COMM_SELF,          &
                 ievap, "#!TDV102",'dataset '//                &
                 prefix(:l_prfx),offset_ievap,.true.,.true.)                                       
                                                               
    call tecplot_binary_write_variable(PETSC_COMM_SELF,        &
                 ievap, nvarsievap,tec_variables(1:nvarsievap),&
                 offset_ievap,.true.,.true.)                 
                                                               
    call tecplot_binary_write_zoneinfo(PETSC_COMM_SELF,ievap,  &
                 trim(strbuffer),offset_ievap, 1, 1, 1, .true.,&
                 .true.,b_output_multizone)                                
    offset_ievap_ijk = offset_ievap - 5*4            
                                                               
    call tecplot_binary_write_section(PETSC_COMM_SELF,ievap,   &
                 nvarsievap,0,offset_ievap, .true., .true.,    &
                 b_output_multizone) 
  else
    if (i_append_sim < 1 .or. .not.b_rewind_valid) then
      write(ievap,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
      write(ievap,'(40a)') 'variables = "time",', &
                                      ' "ev [kg s-1 m-2]",', &
                                      ' "temp [oC] ",', &
                                      ' "hr [-]",', &
                                      ' "wind [m s-1]",', &
                                      ' "rain [kg s-1 m-2]",', &
                                      ' "runoff [kg s-1 m-2]",', &
                                      ' "rain - runoff [kg s-1 m-2]",', &
                                      ' "rho_v [kg m-3]",', &
                                      ' "pv [Pa]",', &
                                      ' "rad [J s-1 m-2]",', &
                                      ' "lw*ev [J s-1 m-2]",', &
                                      ' "hs [J s-1 m-2]",', &
                                      ' "total [J s-1 m-2]"'
      write(ievap,'(2a)') 'zone t = "temporal evolution about energy ', &
                         'and evaporation parameters", f=point'
    end if
  end if
                                 

else
  !cdsu -------------------------------------------------------------
  !cdsu get sheat_atm and rh_atm based on temp_atm
  !cdsu this part is buggy. Some of the variables are control volume
  !cdsu dependent and changed in jacbevap. And some parameters such as
  !cdsu runoff_atm is never initialized. Use with cautious. 
  !cdsu The correct output should be used for specified boundary nodes only.
  !cdsu -------------------------------------------------------------
  call compute_sensible (temp_atm,r1,sheat_atm,rh_atm)

  evaploc = evap_atm/r86400
  levaploc = latvap_atm*evap_atm*r1000/r86400
  hsloc = sheat_atm*r1000/r86400
  radnetloc = radnet*r1000/r86400
  windloc = wind_atm/r86400 
  rainloc = rain_atm*ref_dens/r86400
  runoffloc = runoff_atm/r86400
  seepage = rainloc + runoffloc 
  if (b_icewater_heat) then
    relheat_iw = r1
  else
    relheat_iw = relheat_freezing(temp_atm,heatcapw,heatcapi,r0)
  end if
  rainheat = rainloc*heatcapw*relheat_iw*temp_atm
  !cprovi------------------------------------------------------------------------------------
  !cprovi Compute the total energy
  !cprovi------------------------------------------------------------------------------------
  total = radnetloc + levaploc + hsloc + rainheat  
  !cprovi------------------------------------------------------------------------------------
  !cprovi Compute the vapour pressure
  !cprovi------------------------------------------------------------------------------------
  call vapor_prop (dummy1,pvloc,dummy2,dummy3,dummy4,temp_atm,r0,r0,hr_atm,ref_dens,1) 
  
  if (b_output_trans_binary) then
    realbuffer_gb(1:nvarsievap) = (/                                   &
               time_io,evaploc,temp_atm,hr_atm,windloc,rainloc,        &
               runoffloc,seepage,densv_atm,pvloc,radnetloc,levaploc,   &
               hsloc,total/)
    call binary_write_data(ievap, 1,(/ngb_tstep/),             &
                                   offset_ievap_ijk,.true.)
    call binary_write_data(ievap, nvarsievap,realbuffer_gb,    &
                                   offset_ievap,.true.) 

    offset_ievap = offset_ievap + nvarsievap*nfloatbit
   
  else
    if (mtime == mtime_append .and. i_append_sim >= 1) then
      call reposition_file(ievap,irecord)
    end if

    if (i_append_sim < 1 .or.                                          &
       (mtime >= mtime_append .and. i_append_sim >= 1)) then
      write(ievap,ascii_fmt) time_io,evaploc,temp_atm,hr_atm,          &
            windloc,rainloc,runoffloc,seepage,densv_atm,pvloc,         &
            radnetloc,levaploc,hsloc,total
    end if
  end if     

end if

return
end subroutine 
