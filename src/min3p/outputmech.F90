!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/outputmech.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine outputmech
!c -------------------
!c
!c write contour data for mechanical variables to output
!c file for structured mesh
!c
!c written by:      Danyang Su - Jul 7, 2020
!c
!c last modified:   
!c
!c                  Danyang Su - Jul 7, 2020
!c                  HPC capabilities
!c
!c --------------------------------------------------------------------------

      subroutine outputmech

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use writeversion
      use dens, only : density_dependence, density
      use file_unit, only : lun_get, lun_free
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, ivol, l_sufx, ivol_l, ierrcode, ierr
      
      real*8 :: zout, theta_a, theta_g, phead, stor_out

      real*8, external :: zoutput

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0

      character*5 suffix      
      character*2048 strbuffer
      character*72 :: tec_variables(100)
      integer*4 :: nvars

#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset_igsmech, offset_igsmech_temp
#else
      integer*8 :: offset_igsmech, offset_igsmech_temp
#endif

      l_sufx = 0


      if (b_output_restart) then
        suffix = "r"
        l_sufx = 1
      else
        if (igstime.lt.10) then

          write(suffix,'(i1)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:1)
            l_sufx = 3
          else
            l_sufx = 1
          end if

        elseif (igstime.ge.10.and.igstime.lt.100) then

          write(suffix,'(i2)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:2)
            l_sufx = 4
          else
            l_sufx = 2
          end if

        elseif (igstime.ge.100.and.igstime.lt.1000) then

          write(suffix,'(i3)') igstime
          if (tran_steady_flow) then
            suffix = "o_"//suffix(:3)
            l_sufx = 5
          else
            l_sufx = 3
          end if

        elseif (igstime.gt.1000) then
          if (rank == 0) then
            write(ilog,'(/a)')'error in input file'
            write(ilog,'(a)')'max. number of output times exceeded'
            write(ilog,'(a)')'abnormal exit in routine outputmech'
            close(ilog)
#ifdef DEBUG
            write(idbg,'(/a)') 'error in input file'
            write(idbg,'(a)') 'max. number of output times exceeded'
            write(idbg,'(a)') 'abnormal exit in routine outputmech'
            close(idbg)
#endif
          end if
#ifdef PETSC
          call petsc_mpi_finalize
#endif
          stop

        end if
      end if

      nvars = 7

!c  ---------------------------------------------------------------------
!c  open file for nodal values
!c  --------------------------------------------------------------------- 
      if (b_output_binary) then
        
        if (b_output_mpiio_single) then
          strbuffer = prefix(:l_prfx)//'_'//suffix(:l_sufx)//'.gsmech'
        else
          strbuffer = prefix(:l_prfx)//'_'//                           &
                      suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsmech'
        end if
        call binary_file_open(Petsc_Comm_World, igsmech,        &
                     trim(strbuffer),b_output_mpiio_single)
 
      else
        open(igsmech,file=prefix(:l_prfx)//'_'//                       &
                  suffix(:l_sufx)//trim(adjustl(str_rank))//'.gsmech', &
                  status='unknown',form='formatted')
      end if
      
      if (rank == 0) then
                                                                       
        if (initial_condition) then                                                                         
          write(ifls,'(/2a/72a)')'Mechanical variables, initial ',     &
                                 'condition',('-',i=1,72)
        else                                                                        
          write(ifls,'(/a,1pe15.6e3,1x,a,/72a)')                       &
            'Mechanical variables, T = ',time_io,time_unit,('-',i=1,72)
        end if
                                                                        
        write(ifls,'(/a/)') prefix(:l_prfx)//'_'//                     &
                            suffix(:l_sufx)//'.gsmech'
                                                                        
        write(ifls,'(2a)')                                             &
              'column   entry                           ','unit'        
        write(ifls,'(2a)')                                             &
              '1        x                               ','m'           
        write(ifls,'(2a)')                                             &
              '2        y                               ','m'           
        write(ifls,'(2a)')                                             &
              '3        z                               ','m'           
        write(ifls,'(2a)')                                             &
              '4        storage coefficient             ','1/m'           
        write(ifls,'(2a)')                                             &
              '5        skempton coefficient            ','-'           
        write(ifls,'(2a)')                                             &
              '6        loading efficiency coefficient  ','-'           
        write(ifls,'(2a)')                                             &
              '7        porosity                        ','-'                    
      end if

  
!c  ---------------------------------------------------------------------
!c  file header
!c  ---------------------------------------------------------------------

!c  title and variables

      if (tec_header) then
          
!c  version information
        if (b_writeversion_tecplot .and. .not. b_output_binary) then
          call writeversion2file(igsmech, "#")
        end if
        
!c  title and variables
        if (b_output_binary) then

          strbuffer = 'dataset '//prefix(:l_prfx)//''
          !write tecplot title and header  
          offset_igsmech = 0
          call tecplot_binary_write_header(Petsc_Comm_World, igsmech,  &
                       "#!TDV102", trim(strbuffer), offset_igsmech,    &
                       b_output_mpiio_single,.false.)
        else
          write(igsmech,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'
        end if


        if (b_output_binary) then
            
          tec_variables(1:nvars) = [character(len=72) :: "x", "y", "z",&
              "storage_coefficient", "skempton_coefficient",           &
              "loading_coefficient", "porosity"]         !exclude: "por_stress"
          call tecplot_binary_write_variable(Petsc_Comm_World, igsmech,&
                       nvars, tec_variables(1:nvars), offset_igsmech,  &
                       b_output_mpiio_single,.false.)   
        else
          write(igsmech,'(20a)') 'variables = "x", "y", "z",',         & 
                                 ' "storage_coefficient",',            &
                                 ' "skempton_coefficient",',           &
                                 ' "loading_coefficient",',            &
                                 ' "porosity"'           !exclude: "por_stress"
        end if
                                                                   
      else          
!c  version information
        if (b_writeversion_tecplot ) then
            call writeversion2file(igsmech, "#")
        end if
        
!c  title and variables                                                                       
        write(igsmech,'(3a)') '# title = "dataset ',prefix(:l_prfx),'"'
                                                                       
                                                                       
        write(igsmech,'(20a)') '# variables = "x", "y", "z",',         &
                            ' "storage_coefficient",',                 &
                            ' "skempton_coefficient",',                &
                            ' "loading_coefficient",',                 &
                             ' "porosity"'               !exclude: "por_stress"  
      end if                                             !(tec_header)

!c  zone record for initial condition
 
      if (initial_condition) then

        if (tec_header) then

          if(b_output_binary) then  
              
            strbuffer = 'Mechanical variables, initial condition'
            offset_igsmech_temp = offset_igsmech
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsmech,trim(strbuffer),offset_igsmech,     &
                           itec,jtec,ktec,                             &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsmech = offset_igsmech_temp +                   &
                            (11+len_trim(strbuffer))*4*nprcs + 4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsmech,trim(strbuffer),offset_igsmech,     &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsmech = offset_igsmech_temp +                   &
                            (12+len_trim(strbuffer))*4
            end if         
          else
            write(igsmech,'(3(a,i5),a)')                               &
              'zone t = "Mechanical variables, initial condition" i =',&
              itec,', j =',jtec,', k =',ktec,',  f=point'
          end if
                                                                       
        else                                                                       
          write(igsmech,'(3(a,i5),a)')                                 &
            '# zone t = "Mechanical variables, initial condition" i =',&
            itec,', j =',jtec,', k =',ktec,',  f=point'
        end if                   !(tec_header)

!c  zone record for current time step or steady state solution
!c  for fully saturated or variably saturated  conditions

      elseif (.not.initial_condition) then
        
        if (tec_header) then
              
          if (b_output_binary) then
              
            write(strbuffer,'(a,1pe15.6e3,1x,a)')                      &
                  'Mechanical variables, solution time = ',            &
                  time_io,time_unit
            offset_igsmech_temp = offset_igsmech
            
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsmech,trim(strbuffer),offset_igsmech,     &
                           itec,jtec,ktec,                             &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsmech = offset_igsmech_temp +                   &
                            (11+len_trim(strbuffer))*4*nprcs+4 
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World,     &
                           igsmech,trim(strbuffer),offset_igsmech,     &
                           itec_gbl,jtec_gbl,ktec_gbl,                 &
                           b_output_mpiio_single,.false.,              &
                           b_output_multizone)
              offset_igsmech = offset_igsmech_temp +                   &
                            (12+len_trim(strbuffer))*4
            end if
          else                                                                       
            write(igsmech,'(a,1pe15.6e3,1x,a,3(a,i5),a)')              &
                'zone t = "Mechanical variables, solution time = ',    &
                time_io,time_unit,'" i =',itec,', j =',jtec,           &
                ', k =',ktec,',  f=point'
          end if                                                                       
                                                                       
        else                                                         
                                                                       
          write(igsmech,'(a,1pe15.6e3,1x,a,3(a,i5),a)')                &
             '# zone t = "Mechanical variables, solution time = ',     &
             time_io,time_unit,'" i =',itec,', j =',jtec,              &
             ', k =',ktec,',  f=point'
        end if                  !(tec_header)
      end if                    !(initial_condition)

!c  ---------------------------------------------------------------------
!c  output
!c  ---------------------------------------------------------------------
      if (b_output_binary) then
          
        offset_igsmech_temp = offset_igsmech
           
        call tecplot_binary_write_section(Petsc_Comm_World,igsmech,    &
                     nvars,nn_offset,offset_igsmech,                   &
                     b_output_mpiio_single,.false.,b_output_multizone)
      end if

!C----------Zone Data. Each variable is in data format asspecified above.   

      if(b_output_binary) then

        allocate(realbuffer(nn*nvars), stat = ierr)
        call checkerr(ierr,'outputmech-realbuffer',ilog)
        call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
        realbuffer = 0.0d0
      end if
      
!c  loop over control volumes
      ivol_l = 0

      do ivol = 1,nngl
          
!c  skip ghost nodes
#ifdef PETSC
        if (node_idx_lg2l(ivol) < 0) then
            cycle
        end if 
#endif

        ivol_l = ivol_l + 1
        

!c  assign depth coordinate in terms of depth or elevation

        zout = zoutput(depth_output,zg(ivol),elevmax)

        if (density_dependence) then
          stor_out = stor(ivol)*density(ivol)*gacc
        else
          stor_out = stor(ivol)
        end if
          
        if (b_output_binary) then
          realbuffer((ivol_l-1)*nvars+1:ivol_l*nvars)=(/xg(ivol),      &
                    yg(ivol),zout,stor_out,skempton(ivol),             &
                    skempton(ivol)*loading_factor(ivol),pornew(ivol)/)   !exclude: "por_stress"
          
        else        
          write(igsmech,ascii_fmt) xg(ivol),yg(ivol),zout,             &
                stor_out,skempton(ivol),                               &
                skempton(ivol)*loading_factor(ivol),pornew(ivol)         !exclude: "por_stress"
        end if
                                                                       
                                                                       
      end do
      
      if(b_output_binary) then
        if (b_output_multizone .or. .not.b_output_mpiio_single) then
          call binary_write_data(igsmech, size(realbuffer,1),                &
                      realbuffer, offset_igsmech,b_output_mpiio_single)
        else
          call binary_subarray_initialize(nvars,b_mpiarray_igsmech_init,     &
                      .false.,mpiarray_filetype_igsmech,                     &
                      mpiarray_sizes_gbl_igsmech,                            &
                      mpiarray_sizes_sub_igsmech,mpiarray_starts_sub_igsmech)
          call binary_write_data(igsmech, size(realbuffer,1),                &
                      realbuffer, offset_igsmech, mpiarray_filetype_igsmech)
        end if
        call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
        deallocate(realbuffer) 
      end if
                                                                       
!c  ---------------------------------------------------------------------
!c  close files
!c  ---------------------------------------------------------------------
      if(b_output_binary) then
        call binary_file_close(igsmech,b_output_mpiio_single) 
      else
        close(igsmech)
      end if

      return
      end
