!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 826 $
!> $Author: dsu $
!> $Date: 2022-03-24 10:10:16 -0700 (Thu, 24 Mar 2022) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/elecmigration.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c -----------------------------------------------------------------------
!c subroutine elecmigration
!c -------------------
!c
!c compute the electric potential for aqueous component electrostatic 
!c based on concentrations of free species and secondary aqueous species
!c
!c written by:      Pejman Rasouli - June 03, 2010
!c
!c last modified:   Pejman Rasouli - September 06, 2012
!c                 Electromigration term is computeted here
!c                 and the transport equation converted to
!c                 Nersnst-Planck equation
!c
!c                 Danyang Su - Sept 17, 2021
!c                 Reference: Giambalvo et al 2002, Geochimica et Cosmochimica Acta.
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                   I O
!c passed:   real*8:
!c          -------
!c          c(nc)              = concentrations of free species      + -
!c                               [moles/l water]
!c          cx(nx)             = concentrations of secondary aqueous + -
!c                               species [moles/l water]
!c
!c common:
!c chem.f:   real*8:
!c          -------
!c          xnux(nx*nc)        = stoichiometric coefficient matrix   + -
!c                               for formation of secondary aqueous
!c                               species from free species
!c
!c          integer*4:
!c          ----------
!c          n!c                = number of components including h2o  + -
!c          nx                 = number of secondary aqueous species + -
!c
!c local:    integer*4:
!c          ----------
!c          i                  = counter (stoichiometric
!c                               coefficients)
!c          ic                = counter (components)
!c          ix                 = counter (secondary aqueous species) 
!c
!c external: -
!c ----------------------------------------------------------------------

      subroutine elecmigration(ivol,jvol,cd_ivol,cdx_ivol,             &
                               cd_jvol,cdx_jvol,d_elcmig)

     
      use parm
      use chem
      use gen
      use multidiff
 
      implicit none

      integer :: ivol, jvol
      real*8 :: cd_ivol(nc),cdx_ivol(nx),cd_jvol(nc),cdx_jvol(nx),     &
                d_elcmig(nc)

!c Initialize local variables for electromigration term
      real*8 :: Dz2c_loc, Dz2c_loci, Dz2c_locj, diff_ij

      real*8 :: Dz2c_locjj(nc), Dz2c_locii(nc),                        &
                diff_cof_ic_ivol(nc),diff_cof_ix_ivol(nx),             &
                diff_cof_ic_jvol(nc),diff_cof_ix_jvol(nx),             &
                diff_cof_ic(nc), diff_cof_ix(nx)

      real*8 :: Dzdeltac_loc, Dzdeltac_locij(nc)
      
      integer :: i, ic, ix, istart, iend, info_debug
      
      real*8, parameter :: small = 1.0d-10, tiny = 5.0d-2, r0 = 0.0d0, &
                           r1 = 1.0d0, r2 = 2.0d0, rhalf = 0.5d0    

!c apply averaging method
      
      diff_cof_ic_ivol(:) = mdiff_ic_cvol(:,ivol)
      diff_cof_ic_jvol(:) = mdiff_ic_cvol(:,jvol)

      diff_cof_ix_ivol(:) = mdiff_ix_cvol(:,ivol)
      diff_cof_ix_jvol(:) = mdiff_ix_cvol(:,jvol)

!c    Scaler Parameters
      Dz2c_locii = r0
      Dz2c_locjj = r0

      Dz2c_loc = r0
      Dz2c_loci = r0
      Dz2c_locj = r0

      Dzdeltac_loc = r0
      Dzdeltac_locij = r0
      
      d_elcmig = r0

! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------
! prc Computing electromigration flux for free species using Lichtner formulation
! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------  

!c apply averaging method
      diff_cof_ic = r0
      diff_cof_ix = r0

      if (type_averaging_De.eq.'harmonic') then
        do ic=1,nc          ! loop over free species 
          diff_ij = diff_cof_ic_ivol(ic)*diff_cof_ic_jvol(ic)
          if (diff_ij > r0) then
            diff_cof_ic(ic) = r2*diff_ij/(diff_cof_ic_ivol(ic)+        &
                                          diff_cof_ic_jvol(ic))
          end if          
        end do

        do ix=1,nx            ! loop over secondary species 
          diff_ij = diff_cof_ix_ivol(ix)*diff_cof_ix_jvol(ix)
          if (diff_ij > r0) then
            diff_cof_ix(ix) = r2*diff_ij/(diff_cof_ix_ivol(ix)+        &
                                          diff_cof_ix_jvol(ix))
          end if          
        end do
      else if (type_averaging_De.eq.'arithmetic' .or.                  &
               type_averaging_De.eq.'arithmetic De') then
        do ic=1,nc          ! loop over free species 
          diff_cof_ic(ic) = rhalf*(diff_cof_ic_ivol(ic)+               &
                                   diff_cof_ic_jvol(ic))
        end do

        do ix=1,nx            ! loop over secondary species 
          diff_cof_ix(ix) = rhalf*(diff_cof_ix_ivol(ix)+               &
                                   diff_cof_ix_jvol(ix))
        end do
      else if (type_averaging_De.eq.'no averaging') then
        do ic=1,nc          ! loop over free species 
          diff_cof_ic(ic) = diff_cof_ic_ivol(ic)
        end do

        do ix=1,nx            ! loop over secondary species 
          diff_cof_ix(ix) = diff_cof_ix_ivol(ix)
        end do
      end if

!c Calculating D_z^2_c for the current cvolume

!c free species
      do ic=1,nc-1          ! loop over free species               
        Dz2c_locii(ic) = diff_cof_ic(ic) * chargec(ic)* cd_ivol(ic)
        Dz2c_locjj(ic) = diff_cof_ic(ic) * chargec(ic)* cd_jvol(ic)                                                       
      end do                ! loop over free species
            
      
!c add up aqueous complexes 
      do ix=1,nx            ! ix loop over complexes
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend  ! i loop
          ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other sps
 
          if (namec(ic).ne.'h2o') then   
            Dz2c_locii(ic) = Dz2c_locii(ic) +                          &
                             xnux(i) * diff_cof_ix(ix)*                & 
                             chargex(ix) * cdx_ivol(ix)
            Dz2c_locjj(ic) = Dz2c_locjj(ic) +                          &
                             xnux(i) * diff_cof_ix(ix)*                &
                             chargex(ix) * cdx_jvol(ix)         
          end if
        end do              ! i loop
      end do                ! ix loop over complexes 
       
!c Calculating Sigma_D_z_Delta_C for the current cvolume

!c free species
      do ic=1,nc-1          ! loop over free species                                                                 
        Dzdeltac_locij(ic) = diff_cof_ic(ic) * (cd_jvol(ic)-cd_ivol(ic))
      end do                ! loop over free species

!c add up aqueous complexes
 
      do ix=1,nx            ! ix loop over complexes
        istart = iax(ix)
        iend = iax(ix+1)-1
        do i = istart,iend  ! i loop
          ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other sps    !?MX h+1 and oh- should be considered

          if (namec(ic).ne.'h2o') then   
            Dzdeltac_locij(ic) = Dzdeltac_locij(ic)+xnux(i)*diff_cof_ix(ix)*(cdx_jvol(ix)-cdx_ivol(ix))
          end if
        end do              ! i loop
      end do                ! ix loop over complexes 

       
!c Calculating Sigma D_z^2_c

      do ic=1,nc-1          ! loop over free species               
        Dz2c_loci = Dz2c_loci + chargec(ic) * Dz2c_locii(ic)
        Dz2c_locj = Dz2c_locj + chargec(ic) * Dz2c_locjj(ic)
        Dzdeltac_loc = Dzdeltac_loc + chargec(ic)*Dzdeltac_locij(ic)
      end do    

      Dz2c_loc = rhalf * (Dz2c_loci + Dz2c_locj)

!c Calculating electromig gradient J_i for the current cvolume

!c free species
      if (Dz2c_loc .ne. 0.0d0) then

        do ic=1,nc-1          ! loop over free species 
          d_elcmig(ic) = rhalf*diff_cof_ic(ic)*chargec(ic)*            &
                        (cd_ivol(ic)+cd_jvol(ic))*Dzdeltac_loc/Dz2c_loc
        end do  

!c add up aqueous complexes
 
        do ix=1,nx            ! ix loop over complexes
          istart = iax(ix)
          iend = iax(ix+1)-1
          do i = istart,iend  ! i loop
            ic = jax(i)
 
!c skip h2o, h+1 and oh- since electromig considers other species
 
            if (namec(ic).ne.'h2o') then
              d_elcmig(ic) = d_elcmig(ic) +                            &
                             xnux(i)*rhalf*diff_cof_ix(ix)*chargex(ix)*&
                             (cdx_ivol(ix)+cdx_jvol(ix))*Dzdeltac_loc/ &
                             Dz2c_loc
            end if
          end do              ! i loop
        end do                ! ix loop over complexes
      endif

!c reverse the sign of d_elcmig to keep the format of flux calculation the same
      d_elcmig = -d_elcmig


! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------
! prc Computing electromigration flux for complexes using Lichtner formulation
! prc -----------------------------------------------------------------------------
! prc -----------------------------------------------------------------------------  
           
      return
      end
