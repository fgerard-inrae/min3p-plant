!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/tprfvs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine tprfvs
!c -----------------
!c
!c write transient data for variably saturated flow simulation to output
!c file
!c
!c written by:      Uli Mayer - July 27, 01
!c
!c last modified:   Celine Blitz Frayret (CBF) for Frederic Gerard, December 14, 2018
!c            Removed computation of qroot which is performed in jacvs.F90
!c
!c                  Danyang Su - March. 14, 2014
!c                  HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c   
!c                                                                    I O
!c
!c passed:   integer*4:
!c           ----------
!c           ivol               = pointer to current control volume   + -
!c
!c common:
!c gen.f:    real*8:
!c           -------
!c           cvol(nn)           = nodal volumes                       + -
!c           hhead(nn)          = hydraulic head                      + -
!c           pornew(nn)         = porosity (new time level)           + -
!c           sgnew(nn)          = gaseous phase saturation            + - 
!c                                - new time level
!c           sanew(nn)          = aqueous phase saturation            + - 
!c                                - new time level
!c           time_io            = current solution time (I/O units)   + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c
!c           integer*4:
!c           ----------
!c           igbp               = unit number, flow variables,        + -
!c                                transient data
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = current time step                   + -
!c           nn                 = number of control volumes           + -
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           root_uptake        = .true.  -> compute root water       + -
!c                                           uptake 
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c biol.F90:  real*8:
!c          -------
!c          qroot(nn)          = root water uptake for current
!c                   control volume CBF
!c local:    real*8:
!c           ------- 
!c           phead              = pressure head
!c           qroot              = root water uptake for current
!c                                control volume
!c           theta_a            = aqueous phase content         
!c           theta_g            = gas phase content         
!c           r1                 = constant
!c
!c --------------------------------------------------------------------------

      subroutine tprfvs(ivol,igb,ngb_tstep)

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use chem, only : temp_field, tconv
      use file_utility, only : reposition_file
      use module_binary_mpiio, only : binary_write_data
      use biol

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: ivol, igb, izn, ngb_tstep, irecord

      logical :: b_write_temperature
      
      real*8 :: theta_a, theta_g, phead, s_ice, s_water, qroot,        &
                transp, soilevapo

      real*8, external :: rootwat, evapo, pressure_melt_k      

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
      integer :: nvarsigbp
#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset
#else
      integer*8 :: offset
#endif

!c  output temperature when heat transport or temperature field is specified
      if (heat_transport .or. temp_field) then
        b_write_temperature = .true.
      else
        b_write_temperature = .false.
      end if

!c     write(*,'(/a)') 'enter routine tprfvs ...'

      theta_a = pornew(ivol)*sanew(ivol)

!c FG's code divide the rootuptake by sec_per_days
!c to convert to m3/day, which sounds not correct. 
!c The default output time unit is day.

!FG june 2021 - calculate water uptake (rootwat) and evaporation (evapo), in m3/days
      if (root_uptake) then
        transp = cvol(ivol)*rootwat(sanew,ivol,rsum_vprop)
      else ! to allow for phys. evaporation only
        transp = r0
      end if

      soilevapo = r0
      if (root_uptake .or. pure_evap) then
        if (soilhydrfunc_field) then
          if (h1dry_vol(ivol).gt.r0) then
            soilevapo = cvol(ivol)*evapo(sanew,ivol)
          endif
        else        
          izn = mpropvs(ivol)
          if (h1dry(izn).gt.r0) then
            soilevapo = cvol(ivol)*evapo(sanew,ivol)
          endif
        end if
      end if

      qroot = transp + soilevapo

!c  calculate ice and water saturation when freezing/thawing are considered
      if ((heat_transport .or. temp_field) .and. b_water_freezing) then
        if (tempnew(ivol)+tconv > pressure_melt_k(ivol,r0)) then
          s_ice = r0
          s_water = sanew(ivol)
        else
          s_ice = sanew(ivol)
          s_water = r0              
        end if
      else
        s_ice = r0
        s_water = sanew(ivol)
      end if 

      if (fully_saturated) then

!c to be further checked
!c  the following code will make the results a little difference from the 
!c  results without transient output.
!c  update on 2021-08-17 by DSU

        !hhead(ivol) = uvsnew(ivol)
        phead = uvsnew(ivol) - zg(ivol)
        
        if (b_output_trans_binary) then
          if (b_write_temperature) then
            nvarsigbp = 8 
            realbuffer_gb(1:nvarsigbp)= (/time_io,hhead(ivol),         &
                          phead,sanew(ivol),theta_a,tempnew(ivol),     &
                          s_ice,s_water/)
          else
            nvarsigbp = 5 
            realbuffer_gb(1:nvarsigbp)= (/time_io,hhead(ivol),         &
                          phead,sanew(ivol),theta_a/)
          end if
        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            call reposition_file(igbp,irecord)
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            if (b_write_temperature) then
              write(igbp,ascii_fmt) time_io,hhead(ivol),               &
                          phead,sanew(ivol),theta_a,tempnew(ivol),     &
                          s_ice,s_water
            else
              write(igbp,ascii_fmt) time_io,hhead(ivol),               &
                          phead,sanew(ivol),theta_a
            end if
          end if
        end if
                                                                       
      elseif (variably_saturated) then
                          
!c to be further checked
!c  the following code will make the results a little difference from the 
!c  results without transient output.
!c  update on 2021-08-17 by DSU

        !hhead(ivol) = uvsnew(ivol)+zg(ivol)                            
        !sgnew(ivol) = r1 - sanew(ivol)
        theta_g = pornew(ivol)*sgnew(ivol)  
        
        if (b_output_trans_binary) then
          if (b_write_temperature) then
            nvarsigbp = 13 
            realbuffer_gb(1:nvarsigbp)= (/time_io,hhead(ivol),         &
                          uvsnew(ivol),sanew(ivol),theta_a,sgnew(ivol),&
                          theta_g,qroot,transp,soilevapo,              &
                          tempnew(ivol),s_ice,s_water/)                   ! CBF qroot -> qroot(ivol)
          else
            nvarsigbp = 10 
            realbuffer_gb(1:nvarsigbp)= (/time_io,hhead(ivol),         &
                          uvsnew(ivol),sanew(ivol),theta_a,sgnew(ivol),&
                          theta_g,qroot,transp,soilevapo/)                ! CBF qroot -> qroot(ivol)
          end if
        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            call reposition_file(igbp,irecord)
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            if (b_write_temperature) then
              write(igbp,ascii_fmt) time_io,hhead(ivol),               &
                          uvsnew(ivol),sanew(ivol),theta_a,            &
                          sgnew(ivol),theta_g,                         &
                          qroot,transp,soilevapo,                      &
                          tempnew(ivol),s_ice,s_water                    ! CBF qroot -> qroot(ivol)
            else
              write(igbp,ascii_fmt) time_io,hhead(ivol),               &
                          uvsnew(ivol),sanew(ivol),theta_a,            &
                          sgnew(ivol),theta_g,                         &
                          qroot,transp,soilevapo                         ! CBF qroot -> qroot(ivol)
            end if
          end if
        end if
        
      end if
      
      if (b_output_trans_binary) then
        call binary_write_data(igbp_mpi(igb), 1, (/ngb_tstep/),&
                     offset_igbp_ijk(igb),.true.)
        call binary_write_data(igbp_mpi(igb), nvarsigbp,       &
                     realbuffer_gb,offset_igbp(igb),.true.) 

        offset_igbp(igb) = offset_igbp(igb) + nvarsigbp*nfloatbit

      end if
      
!#ifdef DEBUG
!      if(ivol == 14) then
!          write(idbg,*) "-->tprfvs hhead(ivol)", hhead(ivol)
!      end if
!#endif

      return
      end
