!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 786 $
!> $Author: dsu $
!> $Date: 2021-01-06 21:41:32 -0800 (Wed, 06 Jan 2021) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/freezing_adjacent_bd.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c function freezing_adjacent_bd
!c -------------------
!c
!c check if adjacent boundary connection is freezing
!c this function should be applied to flux boundary condition only 
!c (flow boundary type :second and point)
!c 
!c
!c written by:      Danyang Su - Feb. 1, 2020
!c
!c last modified:   Danyang Su - Feb. 1, 2020
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   
!c           integer
!c           -------
!c           ivol                   = control volume number           + -
!c           ia(nngl)               = row pointer array for avs       + -
!c           ja(njavs)              = column pointer array for avs    + -
!c           ivol2bd(nngl)          = control volume to boundary
!c                                    volume indicator                + -
!c           real*8:
!c           -------
!c           cinfvs(njavs)          = influence coefficient           + -
!c           freezing_cond          = threshold of freezing cond      + -        
!c
!c
!c           logical:
!c           --------
!c           isblocked              = if true, the connection of boundary ivol 
!c                                    is blocked
!c      
!c
!c          example
!c ----------------------------------------------------------------------

!>
!> check if adjacent boundary connection is freezing
!> this function should be applied to flux boundary condition only 
!> (flow boundary type :second and point)
!>
      function freezing_adjacent_bd(ivol) result(isblocked)

        use gen, only :                                                &
#ifdef USG
                        janumcell, jacell, type_cond_perm,             &
#endif
                        iavs, javs, ivol2bvs, cinfvs_a, uvsnew,        &
                        water_freezing_cond, b_freezing_no_pond,       &
                        tol_freezing_pond, discretization_type
#ifdef USG
        use geometry
        use geometry_definition
        use usg_mesh_data, only : num_edge_dvols, num_edge_maxcells,   &
                                  get_cell_edge_cvol_id,               &
                                  CellCvolFaceArea, CellCvolFace_cond, &
                                  CellCvolFace_cond_tensor
        use usg_face_utility, only : usg_face_utility_cinfvs
#endif
        implicit none

        integer, intent(in) :: ivol
        logical :: isblocked

        !c local variables
#ifdef USG
        integer :: icell, icell2, idvol, idvol_r,iedge_r
        real*8 :: rswitch, cvolfacearea
        type(point) :: tend 
        type(tensor) :: tenf
#endif
        integer :: istart, iend, ibvs, jtemp, jvol
        real*8, parameter :: rtiny = 1.0d-20, rsmallarea = 1.0d-8

        isblocked = .true.

        !c check if the boundary node with influx is ponding, flux-in boundary does not
        !c allow ponding. If true, do not allow flux in.

        if (b_freezing_no_pond) then
          ibvs = ivol2bvs(ivol)
          if (uvsnew(ivol) > tol_freezing_pond(ibvs)) then
            return
          end if
        end if

        !c check if the node below the boundary node node below is frezing, 
        !c if true, do not allow flux in

        istart = iavs(ivol)+1
        iend = iavs(ivol+1)-1

        do jtemp = istart, iend
          jvol = javs(jtemp)
          !c jvol is not a boundary volume
          if (ivol2bvs(jvol) == 0) then

            if (discretization_type > 0) then
#ifdef USG
              do icell = 1, janumcell(jtemp)   !c loop over all linked cells
                icell2 = jacell(icell,jtemp)
                if (icell2 <= 0) then
                  cycle
                end if
                do idvol = 1, num_edge_dvols   !c loop over all dual volumes
                  call get_cell_edge_cvol_id(idvol,ivol,jvol,icell2,       &
                                             idvol_r,iedge_r,rswitch)
                  cvolfacearea = CellCvolFaceArea(idvol_r,iedge_r,icell2)    
                  if(jacell(icell,jtemp) > 0 .and. cvolfacearea > rsmallarea) then

                    if (type_cond_perm == 1) then
                      tend = CellCvolFace_cond(idvol_r,iedge_r,icell2)
                      if (tend%x > water_freezing_cond+rtiny .or.          &
                          tend%y > water_freezing_cond+rtiny .or.          &
                          tend%z > water_freezing_cond+rtiny) then
                        isblocked = .false.
                        return
                      end if
                    else if (type_cond_perm == 2) then
                      tenf = CellCvolFace_cond_tensor(idvol_r,iedge_r,icell2)
                      if (tenf%xx > water_freezing_cond+rtiny .or.         &
                          tenf%yy > water_freezing_cond+rtiny .or.         &
                          tenf%zz > water_freezing_cond+rtiny) then
                        isblocked = .false.
                        return
                      end if
                    end if

                  end if
                end do
              end do
#endif
            else
              if (cinfvs_a(jtemp) > water_freezing_cond+rtiny) then
                isblocked = .false.
                return
              end if
            end if
          end if
        end do

        return

      end function freezing_adjacent_bd