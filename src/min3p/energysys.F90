!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/energysys.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine energysys
!c -----------------
!c
!c total system energy
!c
!c modified from Sergio Andres Bea
!c last modified:   -
!c
!c                 Danyang Su    - March 14, 2014
!c                 HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           cvol(nn)           = nodal volumes                       + -
!c           pornew(nn)         = porosity                            + -
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           relperm(nn)        = relative permeability               + -
!c           uvsnew(nn)         = solution vector (new time level)    + -
!c           time_io            = current solution time (I/O units)   + -
!c           totvsmass          = total system mass                   * +
!c
!c           integer*4:
!c           ----------
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           mtime              = curent time step                    + -
!c           nn                 = total number of control volumes     + -
!c           imvs               = unit number, mass balance -         * +
!c                                             variably saturated
!c                                             flow
!c           imvs_first         = pointer - first unit number for     + -
!c                                mass balance - variably saturated
!c                                               flow
!c
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c
!c dens.f:   real*8:
!c           -------
!c           density(nn)        = fluid density                        + -
!c local:    real*8:
!c           -------
!c           r0                 = constant
!c           r1                 = constant
!c           totv_a             = total volume (aqueous phase)
!c           totv_g             = total gas (gaseous phase)
!c           vsmass             = system mass (local)
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)
!c
!c ----------------------------------------------------------------------
      subroutine energysys 

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens
      use writeversion 
      use phys, only : compressibility
      use file_utility, only : reposition_file
#ifdef OPENMP
      use omp_lib 
#endif
      use module_binary_mpiio, only : binary_write_data

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

      integer :: ivol
      real*8 :: rpor, porosity_flow, heat_ivol
      
#ifdef PETSC
      real*8 :: totenergy_gbl, totv_a_gbl, totv_g_gbl
      PetscErrorCode :: ierrcode
#endif

      real*8 :: totv_a, totv_g, relheat_iw
      
      real*8, external :: relheat_freezing

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
      
      integer :: nvarsimheat, irecord
      
      totenergy = r0
      totv_a = r0
      totv_g = r0
      
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_energysys_1)                    &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol, heat_ivol, rpor, relheat_iw)                                          
#endif
      
!cprovi-----------------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------------
!cprovi compute total energy in the system 
!cprovi KJ
!cprovi-----------------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------------
!cprovi-----------------------------------------------------------------------------
#ifdef OPENMP 
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic) reduction(+:totenergy)
#elif SCHEDULE_STATIC
    !$omp do schedule(static) reduction(+:totenergy)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) reduction(+:totenergy)
#else
    !$omp do schedule(auto) reduction(+:totenergy)
#endif
#endif
      do ivol = 1,nngl 
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
            cycle
        end if
#endif
      
        if (modify_por(ivol)) then
             rpor=porosity_flow(porold(ivol),  &
                  uvsnew(ivol),uvsold(ivol),stor(ivol), &
                  por_stress_dt(ivol),por_init(ivol),facpormin)   
        else
             rpor=pornew(ivol)
        end if   
        
        if (b_icewater_heat) then
          relheat_iw = r1
        else
          relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi,uvsnew(ivol))
        end if

        heat_ivol = cvol(ivol)*(heatcapw*relheat_iw*density(ivol)*sanew(ivol)*rpor+ &
                               (r1-rpor)*heatcaps(ivol)*denssolid(ivol))*tempnew(ivol)
        if (evaporation) then                       
            heat_ivol = heat_ivol + cvol(ivol)* &
                        heatcapv*densvnew(ivol)*sgnew(ivol)*rpor*tempnew(ivol)
            heat_ivol = heat_ivol + cvol(ivol)*latvapnew(ivol)*rpor*sgnew(ivol)*densvnew(ivol)            
        end if
        totenergy = totenergy + heat_ivol
      end do
#ifdef OPENMP 
    !$omp end do
#endif    

#ifdef OPENMP
    !$omp barrier
#endif

!cprovi------------------------------------------------------------------------------
!cprovi compute total volumes for aqueous and gaseous phase
!cprovi------------------------------------------------------------------------------
#ifdef OPENMP 
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic) reduction(+:totv_a, totv_g)
#elif SCHEDULE_STATIC
    !$omp do schedule(static) reduction(+:totv_a, totv_g)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) reduction(+:totv_a, totv_g)
#else
    !$omp do schedule(auto) reduction(+:totv_a, totv_g)
#endif
#endif
      do ivol = 1,nngl
#ifdef PETSC
        if(node_idx_lg2l(ivol) < 0) then
            cycle
        end if
#endif
        if (modify_por(ivol)) then
              rpor=porosity_flow(porold(ivol), &
                   uvsnew(ivol),uvsold(ivol),stor(ivol), &
                   por_stress_dt(ivol),por_init(ivol),facpormin)   
        else
              rpor=pornew(ivol)
        end if 
        totv_a = totv_a + sanew(ivol)*rpor*cvol(ivol)
        totv_g = totv_g + (r1-sanew(ivol))*rpor*cvol(ivol)
      end do
#ifdef OPENMP 
    !$omp end do
#endif 

#ifdef OPENMP
    !$omp barrier
#endif

#ifdef OPENMP 
    !$omp end parallel
#endif 

#ifdef PETSC  
      call MPI_Allreduce(totenergy, totenergy_gbl,1,MPI_REAL8,      &
                         MPI_SUM,Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      totenergy = totenergy_gbl

      call MPI_Allreduce(totv_a, totv_a_gbl,1,MPI_REAL8,MPI_SUM,    &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      totv_a = totv_a_gbl
      
      call MPI_Allreduce(totv_g, totv_g_gbl,1,MPI_REAL8,MPI_SUM,    &
                         Petsc_Comm_World,ierrcode)
      CHKERRQ(ierrcode)
      totv_g = totv_g_gbl
#endif


!cprovi------------------------------------------------------------------------------
!cprovi  write total contributions to file   
!cprovi------------------------------------------------------------------------------
      imheat = imheat_first
 
      if(rank == 0 .and. b_enable_output) then
        if (b_output_trans_binary) then
          nvarsimheat = 4
          realbuffer_gb(1:nvarsimheat)=(/time_io,totenergy,totv_a,     &
                                         totv_g/)
          call binary_write_data(imheat_mpi(imheat), 1,        &
                       (/mtime/),offset_imheat_ijk(imheat),.true.)
          call binary_write_data(imheat_mpi(imheat),           &
                       nvarsimheat,realbuffer_gb,offset_imheat(imheat),&
                       .true.) 

          offset_imheat(imheat) = offset_imheat(imheat) +              &
                                  nvarsimheat*nfloatbit
 
        else
          if (mtime == mtime_append .and. i_append_sim >= 1) then
            call reposition_file(imheat,irecord)
          end if

          if (i_append_sim < 1 .or.                                    &
             (mtime >= mtime_append .and. i_append_sim >= 1)) then
            write(imheat,ascii_fmt) time_io,totenergy,totv_a,totv_g
          end if
        end if
      end if
      
      return
      end 
