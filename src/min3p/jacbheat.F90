!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/jacbheat.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine jacbheat.F90
!c -----------------
!c
!c incorporate dirichlet and neumann type boundary condition in 
!c jacobian matrix and rhs vector for decoupled heat transport 
!c
!c written by:      Danyang SU - June 2, 2020
!c
!c last modified:   Danyang SU - June 2, 2020
!c
!c                  Unstructured grid and HPC capabilities
!c
!c ----------------------------------------------------------------------
 
      subroutine jacbheat
 
      use parm
      use gen
      use dens
      use phys 
      use chem
      
#ifdef OPENMP
      use omp_lib 
#endif 

#ifdef USG
      use usg_mesh_data, only : node_cells, node_num_cells
#endif

      implicit none
      
      character(len=100) :: typebc
      logical            :: isdebug
     
      integer :: i1, ibheat, ivol, istart, iend, idiag 

      real*8 :: densloc, densinc_ivol, dheatflux, heatflux,            &
                tempinc_ivol, temploc, viscoinc_ivol, heatflux_temp,   &
                relheat_iw, rdummy1, rdummy2      
      
      real*8, external :: ddbdflux_energybal, rhonew, visconew,        &
                          relheat_freezing

      real*8, parameter :: r0 = 0.0d0, r1 = 1.0d0
  
!c  debug toggle
 
      isdebug = .false. 

!c  loop over boundary control volumes
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (i_matrix_assembly_type_flow == 1)                       &
    !$omp num_threads(numofthreads_matrix_flow)                       &
    !$omp default(shared)                                             &
    !$omp private (                                                   &
    !$omp i1, ibheat, idiag, iend, istart, ivol,                      &
    !$omp densinc_ivol, densloc, dheatflux, heatflux, heatflux_temp,  &
    !$omp tempinc_ivol, temploc, typebc, viscoinc_ivol, relheat_iw,   &
    !$omp rdummy1, rdummy2)
     
!cprovi--------------------------------------------------------------------------------------
!cprovi Boundary conditions for heat equation 
!cprovi-------------------------------------------------------------------------------------- 
#ifdef SCHEDULE_DYNAMIC
    !$omp do schedule(dynamic)
#elif SCHEDULE_STATIC
    !$omp do schedule(static)
#elif SCHEDULE_GUIDED
    !$omp do schedule(guided) 
#else
    !$omp do schedule(auto)
#endif
#endif
      do ibheat = 1,nbheat
          
        !if(.not.bvalid_iabheat(ibheat)) then
        !    cycle
        !end if

        ivol = iabheat(ibheat)
        
        if (ivol < 0) then
          cycle  
        end if

        if (b_icewater_heat) then
          relheat_iw = r1
        else
          relheat_iw = relheat_freezing(tempnew(ivol),heatcapw,heatcapi,uvsnew(ivol))
        end if

!c  modify for second type flow boundary condition and
!c  point source boundary
!c  calculate mass flux
        if (btypeheat(ibheat)=='free') then
          
          heatflux = ddbdflux_energybal(ivol,density(ivol),viscosity(ivol))

          if (heatflux<r0) then
          
            temploc = tempnew(ivol)
            tempinc_ivol = tempnew(ivol) + dinc_heat
            idiag = iaheat(ivol)
              
            if (isboussinesq) then     

              densloc = r1
              dheatflux = heatflux*(tempinc_ivol-temploc)/dinc_heat

            else !boussinesq
              
              densloc = density(ivol)

              if (ispitzerdens) then
                densinc_ivol = rhonew(ref_dens,            &
                       density_pitzer(ivol),               &
                       ref_dens,tempinc_ivol,tempref_dens, &
                       r1,drho_dt,nonlindens_heat,cdens1,  &
                       cdens2,cdens3,cdens4)
              else
                densinc_ivol = rhonew(ref_dens,            &
                       tds_new(ivol),                      &
                       ref_tds,tempinc_ivol,tempref_dens,  &
                       drho_dc,drho_dt,nonlindens_heat,    &
                       cdens1,cdens2,cdens3,cdens4)
              end if

              if (update_viscosity_temp) then
                viscoinc_ivol = visconew(densinc_ivol,     &
                                tds_new(ivol),tempinc_ivol,&
                                update_viscosity,          &
                                update_viscosity_temp,     &
                                cvisco1,cvisco2,cvisco3,   &
                                cvisco4,cvisco5,           &
                                tempref_dens,iviscomodel,  &
                                ref_visco,ref_tds,ref_dens)
              else
                viscoinc_ivol = viscosity(ivol)
              end if

              heatflux_temp=ddbdflux_energybal(ivol,       &
                            densinc_ivol,viscoinc_ivol)
              
              dheatflux = heatcapw*relheat_iw*             &
                 (heatflux_temp*densinc_ivol*tempinc_ivol- &
                  heatflux*densloc*temploc)/dinc_heat

            end if !boussinesq
            
            aheat(idiag)=aheat(idiag) - dheatflux
            
          else  !heatflux
          
            temploc=bcondheat(ibheat)
            if (isboussinesq) then
              densloc=ssdens(ivol)/density(ivol)
            else
              densloc=ssdens(ivol)
            end if
             
          end if !heatflux
          
          if (massflux_second) then
            heatflux=heatflux*heatcapw*relheat_iw*temploc
          else
            heatflux=heatflux*densloc*heatcapw*relheat_iw*temploc
          end if !massflux_second
           
          bheat(ivol) = bheat(ivol) + heatflux
          
        elseif (btypeheat(ibheat)=='fluxw+') then
          heatflux=ddbdflux_energybal(ivol,density(ivol),             & 
                                      viscosity(ivol))
          if (heatflux<r0) then
            heatflux = r0
            temploc=r0
            densloc=r0
          else
            temploc=bcondheat(ibheat)
            if (isboussinesq) then  
              densloc=ssdens(ivol)/density(ivol)
            else
              densloc=ssdens(ivol)*heatcapw*relheat_iw
            end if
          end if
          
          if (massflux_second) then  
            heatflux=heatflux*temploc
          else
            heatflux=heatflux*densloc*temploc 
          end if
       
         bheat(ivol) = bheat(ivol) + heatflux 
           
       
            
        else if ((btypeheat(ibheat)=='second') .or.                   &
                  (btypeheat(ibheat).eq.'point')) then
 
          bheat(ivol) = bheat(ivol) + bcondheat(ibheat) 
 
        elseif ((btypeheat(ibheat)=='first').or.                      &
                (btypeheat(ibheat)=='seepage'.and.                    &
                 bcondheat(ibheat)<r0)) then

          istart = iaheat(ivol)          !pointer - start of row
          iend = iaheat(ivol+1)-1        !pointer - end of row
          idiag = iaheat(ivol)           !pointer - diagonal

          do i1=istart,iend            !modify matrix and rhs
            aheat(i1) = r0
          end do          
        
          aheat(idiag) = r1

          bheat(ivol) = r0 
        
       elseif (btypeheat(ibheat)=='atmospheric') then 
    
          call jacbevap(ivol,'heat',rdummy1,rdummy2)
            
       end if 
        
      end do                          !loop - boundary control volumes      
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif  
        
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------   
#ifdef DEBUG
      if (isdebug) then
        write(idbg,*) '---------------------------------------------------'
        write(idbg,*) 'jabobian and residual'
        write(idbg,*) '---------------------------------------------------'
        write(idbg,*) aheat,bheat
      end if
#endif
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------                    
!cprovi-------------------------------------------------------------

      return
    end subroutine jacbheat
