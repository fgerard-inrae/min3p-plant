!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 879 $
!> $Author: dsu $
!> $Date: 2024-02-17 10:15:21 -0800 (Sat, 17 Feb 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/initppvs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine initppvs
!c -------------------
!c
!c physical parameters for variably saturated flow
!c
!c written by:      Uli Mayer - May 13, 96
!c
!c last modified:   Uli Mayer - July 25, 01
!c                  - added root water uptake
!c                  Uli Mayer - Nov 28, 01
!c                  - updated root water update formulation
!c                    and added soil evaporation
!c                  Sergi Molins - January 20, 2003
!c                  - all conductivity data converted 
!c                    to permeability (if necessary) (search for NEW)
!c                  Sergi Molins - June 28, 2006
!c                  - removed return when permeability_field =.true.
!c                    and modified elseif loops accordingly
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  - add unstructured grid and HPC capabilities
!c
!c            Celine Blitz Frayret (CBF) for Frederic Gerard (FG), December 14, 2018
!c            - removed read of root related parameters (done in initplant.F90)
!c            - read initial soil values and open the *.soi input file
!c            - compute water saturation at wilting point and field capacity
!c            - compute sum air dry water pressure throughout zones
!c
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common: 
!c gen.f:    real*8:
!c           ------- 
!c           xg(nn)             = spatial coordinates in x-direction  + -
!c           yg(nn)             = spatial coordinates in y-direction  + -
!c           zg(nn)             = spatial coordinates in z-direction  + -
!c           canopy_int         = canopy interception                 + -
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical
!c                                parameters to internal time units
!c           pet                = potential evapotranspiration        + -
!c           pe_soil            = potential soil evaporation          + -
!c           qroot_tot_max      = total root water uptake             + -
!c           time_soi           = next read time for soil specific    + -
!c                                parameters
!c
!c           gacc               = gravitational acceleration [m s^-2] + -
!c
!c           integer*4:
!c           ----------
!c           icnv               = unit number, type conversion and    + -
!c                                temporary storage
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           idbg               = unit number, debugging file         + -
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           ihyc               = unit number, initial hydraulic      + -
!c                                             conductivity
!c                                             distribution
!c           isoi               = unit number, soil specific          * +
!c                                parameters
!c           itmp               = unit number, temporary storage      + -
!c           itec               = i-index for tecplot                 + -
!c           jtec               = j-index for tecplot                 + -
!c           ktec               = k-index for tecplot                 + -
!c           l_prfx             = length of prefix of I/O files       + -
!c           l_zone_name        = length of zone name                 * +
!c           mpropvs(nn)        = pointer array for allocation of     + -
!c                                material properties
!c           nn                 = total number of control volumes     + -
!c           nvx                = number of control volumes in        + -
!c                                x-direction
!c           nvy                = number of control volumes in        + -
!c                                y-direction
!c           nvz                = number of control volumes in        + -
!c                                z-direction
!c
!c           logical:
!c           --------
!c           transient_flow     = .true.  -> .not.steady_flow,        + -
!c                                        -> transient flow
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c           root_uptake        = .true.  -> compute root water       * +
!c                                           uptake CBF
!c
!c           character:
!c           ----------
!c           prefix             = prefix name for all I/O files       * +
!c           section_header     = section header                      * +
!c           zone_name          = name of zone                        * +
!c
!c phys.f:   real*8:
!c           -------
!c           dens_h2o           = density of water [kg m^-3]          + -
!c           visc_h2o           = dynamic viscosity                   + -
!c                                [Pa s] = [kg m^-1 s^-1] 
!c           condxx(nzn)        = saturated hydraulic conductivity    * +
!c                                in x-direction
!c           condyy(nzn)        = saturated hydraulic conductivity    * +
!c                                in y-direction
!c           condzz(nzn)        = saturated hydraulic conductivity    * +
!c                                in z-direction
!c           permx(nn)          = saturated permeability in           * + 
!c                                x-direction
!c           permy(nn)          = saturated permeability in           * +
!c                                y-direction
!c           permz(nn)          = saturated permeability in           * +
!c                                z-direction
!c           spstor(nzn)        = specific storage coefficient        * +
!c           swr(nzn)           = residual saturation                 * +
!c           expn(nzn)          = soil hydraulic function parameter   * +
!c           spalpha(nzn)       = soil hydraulic function parameter   * +
!c           spbeta(nzn)        = soil hydraulic function parameter   * +
!c           spgamma(nzn)       = soil hydraulic function parameter   * +
!c           aentry(nzn)        = air entry pressure                  * +
!c           root_length_dens(nzn) = root length density              * +
!c           satwdry(nzn)       = air-dry water saturation            * +
!c           satwlim(nzn)       = water saturation at wilting point   * +
!c           satwfield(nzn)     = water saturation at field capacity  * +
!c
!c           integer*4:
!c           ----------
!c           mprop_name(nzn)    = name of material property zone      + -
!c           nzn                = number of material property zones   + -
!c
!c           logical:
!c           --------
!c           permeability_field = .true.  -> read permeability field  * +
!c                                .false. -> specify permeabilities
!c                                           in input file
!c biol.F90: real*8: CBF
!c         -------
!c         scale_tree_growth  = scale factor to account for the influence
!c                                of tree growth on transpiration
!c           canopy_int         = canopy interception                 + -
!c           pet                = potential evapotranspiration        + -
!c           pe_soil            = potential soil evaporation          + -
!c           time_soi           = next read time for soil specific    + -
!c                                parameters
!c           solar_ratio        = ratio between the solar energy at the forest floor
!c                                and this above tree canopy
!c
!c           integer*4:
!c           ----------
!c         cmws              = computing method for water stress    * +
!c
!c           integer*4:
!c           ----------
!c           mprop_name(nzn)    = name of material property zone      + -
!c           nzn                = number of material property zones   + -
!c
!c           logical:
!c           --------
!c           permeability_field = .true.  -> read permeability field  * +
!c                                .false. -> specify permeabilities
!c                                           in input file
!c           pure_evap          = .true.  -> pure evaporation 
!c                  (when root_uptake = false) CBF
!c
!c
!c local:    real*8:
!c           -------
!c           dens_h2o           = density of water [kg m^-3]
!c           gacc               = gravitational acceleration [m s^-2]
!c           r0                 = constant
!c           r1                 = constant
!c           rdummy             = real*8 dummy variable 
!c           visc_h2o           = dynamic viscosity 
!c                                [Pa s] = [kg m^-1 s^-1] 
!c           xpmin              = min. x-coordinate of material
!c                                property zone
!c           xpmax              = max. x-coordinate of material
!c                                property zone
!c           ypmin              = min. y-coordinate of material
!c                                property zone
!c           ypmax              = max. y-coordinate of material
!c                                property zone
!c           zpmin              = min. z-coordinate of material
!c                                property zone
!c           zpmax              = max. z-coordinate of material
!c                                property zone
!c
!c           integer*4:
!c           ----------
!c           i1                 = counter
!c           ivol               = counter
!c           izn                = counter (zones)
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c           found_subsection   = .true.  -> subsection header was
!c                                           found in input file
!c
!c           character:
!c           ----------
!c           subsection         = name of subsection in input file
!c           cdummy             = character dummy variable
!c
!c external: findstrg  = find text string in file
!c           readbloc  = read section of input file and write to
!c                       temporary file
!c           satfpres  = compute saturation from pressure    ! CBF
!c ----------------------------------------------------------------------
 
      subroutine initppvs

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use phys
      use bbls
      use writeversion
      use file_unit, only : lun_get, lun_free
      use file_utility, only : findnextline, readnextline,             &
                               read_vtk_data_from_file
      use geometry

      use biol

#ifdef OPENMP
      use omp_lib 
#endif

#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif

      use module_binary_mpiio, only :  binary_file_open,               &
                                       tecplot_binary_write_header,    &
                                       tecplot_binary_write_variable,  &
                                       tecplot_binary_write_zoneinfo,  &
                                       tecplot_binary_write_section,   &
                                       binary_write_data,              &
                                       binary_file_close,              &
                                       binary_subarray_initialize

#ifdef USG
#ifdef PETSC_HDF
      use hdf5
      use hdf5_usg
#endif
      use usg_mesh_data
#endif
      
      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif

#ifdef USG
#ifdef PETSC_HDF
      integer :: hdf5_ierr                   ! HDF5 error code
      integer(HID_T) :: file_id              ! File identifier
      integer(HID_T) :: group_id             ! Group identifier
      integer(HID_T) :: plist_id             ! Property list identifier
      integer :: ixmf                        ! XMF file id
#endif
#endif

#ifdef USG
      logical :: bfound
      character*72 :: subcommand
      character*2048 :: strbuffer2048
#endif

      external :: findstrg, readbloc, mem_mat_ext, checkerr

      logical :: found_section, found_subsection, isovendry,           &
                 storcoeff_specified, flag_cond_set
      character*72 :: subsection
      character*1 :: cdummy
      
      integer :: i, iskip, l_string, nskip, ivol, ivolgbl, ivol_l,     &
                 icell, icellgbl, izn, ierrcode, ierr, nshift, ierrcd

      real*8 :: r0, r1, rdummy, qroot_tot_max, convk, rsmall, depth ! CBF
      real*8, external :: satfpres
      parameter (r0 = 0.0d0, r1 = 1.0d0, rsmall = 1.0d-20)
      

      character*2048 strbuffer
      character*72 :: tec_variables(100)
      character*256 :: strfilename, strfilename_result, strfilename_mesh
      integer :: nvars
      
#ifdef PETSC
      integer(kind=MPI_OFFSET_KIND) :: offset_ihyc, offset_ihyc_temp
#else
      integer*8 :: offset_ihyc, offset_ihyc_temp
#endif

!c  set defaults
      ierrcd = 0
      dens_h2o = 1.0d+3
      visc_h2o = 1.0d-3
      permeability_field = .false.
      storcoeff_field = .false.
      soilhydrfunc_field = .false.

      convk = visc_h2o/(dens_h2o * gacc)  !conductivity * convk = permeability

!c  initialize relative permeability to 1.0
      relperm(:) = r1
 
!c  read parameters for variably saturated flow and write 
!c  to temporary file
 
      section_header = 'physical parameters - variably saturated flow'
      call readbloc (idat,itmp,section_header,found_section,.true.)

!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found
     
      if (.not.found_section) then
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED'
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
 
      elseif (found_section) then

!c  write section header to generic output file
        if (b_enable_output .and. b_enable_output_gen) then
          write(igen,'(/72a)')('-',i=1,72)
          write(igen,'(a)') section_header(:l_string)
          write(igen,'(72a/)')('-',i=1,72)
        end if

!cdsu anisotropic conductivity/permeability correction factor      
        useAnisoCondCorr = .false.
        if (useAnisoCorr) then
          subsection = 'anisotropic hydraulic conductivity correction'
          call findstrg(subsection,itmp,found_subsection)    
          if (found_subsection) then
            useAnisoCondCorr = .true.
          end if

          subsection = 'anisotropic permeability correction'
          call findstrg(subsection,itmp,found_subsection)    
          if (found_subsection) then
            useAnisoCondCorr = .true.
          end if
        end if 

!c  read flow parameters as nodal values from separate file

!c  read permeability field from file
        subsection = 'read permeability field from file'
        call findstrg(subsection,itmp,found_subsection)
        if (found_subsection) then

          permeability_field = .true.
          
!c  hydraulic conductivity dustribution
!c  .hyc is for input data, do not include trank number in the file path.
!c  but for the output, it is included. See initppdd.F90, initppvs.F90.

          ihyc = lun_get()

          open(ihyc,file=prefix(:l_prfx)//'.hyc',                      &
                    status='unknown', form='formatted')

!c  read permeabilities
#ifdef USG
          if (discretization_type > 0 .and. is_cell_based_perm_cond) then
            ierrcd = 1
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
            
#ifdef PETSC
            do icellgbl = 1,num_cells_gbl
              icell = cell_idx_g2lg(icellgbl)
#else
            do icell = 1,num_cells
#endif
              if (icell > 0) then
                if (type_cond_perm == 1) then
                  ierrcd = 2
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,     &
                      permx(icell), permy(icell), permz(icell)
                else if (type_cond_perm == 2) then
                  ierrcd = 3
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,     &
                      perm_tensor(icell)%xx, perm_tensor(icell)%xy,        &
                      perm_tensor(icell)%xz, perm_tensor(icell)%yx,        &
                      perm_tensor(icell)%yy, perm_tensor(icell)%yz,        &
                      perm_tensor(icell)%zx, perm_tensor(icell)%zy,        &
                      perm_tensor(icell)%zz
                end if
              else
                ierrcd = 4
                read(ihyc,*,err=998,end=998) rdummy
              end if
            end do

!c  convert permeabilities to conductivities
!c  Note: dens_h2o and visc_h2o can be made a function of the
!c        solution composition in the future
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (num_cells > numofloops_thred_initppvs_1)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (icell)
    !$omp do schedule(static)
#endif
            do icell = 1,num_cells
              if (type_cond_perm == 1) then
                permx(icell) = permx(icell)*dens_h2o*gacc/visc_h2o
                permy(icell) = permy(icell)*dens_h2o*gacc/visc_h2o
                permz(icell) = permz(icell)*dens_h2o*gacc/visc_h2o
              else if (type_cond_perm == 2) then
                perm_tensor(icell) = perm_tensor(icell)*         &
                                     (dens_h2o*gacc/visc_h2o)
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

          else
#endif
            ierrcd = 5
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
#ifdef USG
            if (discretization_type > 0) then
              do ivolgbl = 1,nngbl
#ifdef PETSC
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
                else
                  ivol = node_idx_g2lg(ivolgbl)
                end if
#else
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2g_invord(ivolgbl)
                else
                  ivol = ivolgbl
                end if
#endif
                if (ivol > 0) then
                  if (type_cond_perm == 1) then
                    ierrcd = 6
                    read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                        permx(ivol), permy(ivol), permz(ivol)
                  else if (type_cond_perm == 2) then
                    ierrcd = 7
                    read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                        perm_tensor(ivol)%xx, perm_tensor(ivol)%xy,        &
                        perm_tensor(ivol)%xz, perm_tensor(ivol)%yx,        &
                        perm_tensor(ivol)%yy, perm_tensor(ivol)%yz,        &
                        perm_tensor(ivol)%zx, perm_tensor(ivol)%zy,        &
                        perm_tensor(ivol)%zz
                  end if
                else
                  ierrcd = 8
                  read(ihyc,*,err=998,end=998) rdummy
                end if
              end do
            end if
#endif
            if (discretization_type == 0) then
              nskip = 0
              do ivol = 1,nngl
#ifdef PETSC
                do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                  ierrcd = 9
                  read(ihyc,*,end=999,err=999) rdummy
                end do
                nskip = node_idx_lg2g(ivol)
#endif
                if (type_cond_perm == 1) then
                  ierrcd = 10
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                                               permx(ivol), permy(ivol), &
                                               permz(ivol)
                else if (type_cond_perm == 2) then
                  ierrcd = 11
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                      perm_tensor(ivol)%xx, perm_tensor(ivol)%xy,        &
                      perm_tensor(ivol)%xz, perm_tensor(ivol)%yx,        &
                      perm_tensor(ivol)%yy, perm_tensor(ivol)%yz,        &
                      perm_tensor(ivol)%zx, perm_tensor(ivol)%zy,        &
                      perm_tensor(ivol)%zz
                end if
              end do
            end if

!c  convert permeabilities to conductivities
!c  Note: dens_h2o and visc_h2o can be made a function of the 
!c        solution composition in the future 
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppvs_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                  
    !$omp do schedule(static)
#endif
            do ivol = 1,nngl
              if (type_cond_perm == 1) then
                permx(ivol) = permx(ivol)*dens_h2o*gacc/visc_h2o
                permy(ivol) = permy(ivol)*dens_h2o*gacc/visc_h2o
                permz(ivol) = permz(ivol)*dens_h2o*gacc/visc_h2o
              else if (type_cond_perm == 2) then
                perm_tensor(ivol) = perm_tensor(ivol)*(dens_h2o*gacc/visc_h2o)
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif   

#ifdef USG
          end if
#endif

          close(ihyc)

          call lun_free(ihyc)
                
        end if

#ifdef USG
!c  read permeability field from vtk file
        subsection = 'read permeability field from vtk file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          permeability_field = .true.

!c  hydraulic conductivity dustribution
!c  .hyc is for input data, do not include trank number in the file path.
!c  but for the output, it is included. See initppdd.F90, initppvs.F90.

          ihyc = lun_get()
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
              .not.read_spatial_master_proc .or.                       &
              is_cell_based_perm_cond) then
            open(ihyc,file=prefix(:l_prfx)//'.hyc.vtk',                &
                 status='unknown', form='formatted')
          else
            call lun_free(ihyc)
            ihyc = 0
          end if

!c  read permeabilities
          if (discretization_type > 0 .and. is_cell_based_perm_cond) then

!c  read permeability
            if (type_cond_perm == 1) then
              subcommand = "vectors k double"
            else if (type_cond_perm == 2) then
              subcommand = "tensors k double"
            end if
            bfound = findnextline(ihyc, subcommand, 0, .false.)
            if (bfound) then
              !c note: mpi parallel version does not supported here
              !c to be modified later
              if (type_cond_perm == 1) then
                do icell = 1,num_cells
                  ierrcd = 13
                  read(ihyc,*,end=999,err=999) permx(icell), permy(icell), &
                                               permz(icell)
                end do
              else if (type_cond_perm == 2) then
                do icell = 1,num_cells
                  ierrcd = 14
                  read(ihyc,*,end=999,err=999) perm_tensor(icell)%xx,      &
                        perm_tensor(icell)%xy, perm_tensor(icell)%xz,      &
                        perm_tensor(icell)%yx, perm_tensor(icell)%yy,      &
                        perm_tensor(icell)%yz, perm_tensor(icell)%zx,      &
                        perm_tensor(icell)%zy, perm_tensor(icell)%zz
                end do
              end if

            end if

!c  convert permeabilities to conductivities
!c  Note: dens_h2o and visc_h2o can be made a function of the
!c        solution composition in the future
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (num_cells > numofloops_thred_initppvs_1)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (icell)
    !$omp do schedule(static)
#endif
            do icell = 1,num_cells
              if (type_cond_perm == 1) then
                permx(icell) = permx(icell)*dens_h2o*gacc/visc_h2o
                permy(icell) = permy(icell)*dens_h2o*gacc/visc_h2o
                permz(icell) = permz(icell)*dens_h2o*gacc/visc_h2o
              else if (type_cond_perm == 2) then
                perm_tensor(icell) = perm_tensor(icell)*(dens_h2o*gacc/visc_h2o)
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

          else if (discretization_type > 0 .and. .not. is_cell_based_perm_cond) then

            if (type_cond_perm == 1) then
              call read_vtk_data_from_file(ihyc,'k',bfound,permx,permy,permz)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read permeability field from vtk file: done'
                  write(ilog,'(a)') 'read permeability field from vtk file: done'
                end if
              end if
            else if (type_cond_perm == 2) then
              call read_vtk_data_from_file(ihyc,'k',bfound,perm_tensor)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read permeability field from vtk file: done'
                  write(ilog,'(a)') 'read permeability field from vtk file: done'
                end if
              end if
            end if

!c  convert permeabilities to conductivities
!c  Note: dens_h2o and visc_h2o can be made a function of the
!c        solution composition in the future
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppvs_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)
    !$omp do schedule(static)
#endif
            do ivol = 1,nngl
              if (type_cond_perm == 1) then
                permx(ivol) = permx(ivol)*dens_h2o*gacc/visc_h2o
                permy(ivol) = permy(ivol)*dens_h2o*gacc/visc_h2o
                permz(ivol) = permz(ivol)*dens_h2o*gacc/visc_h2o
              else if (type_cond_perm == 2) then
                perm_tensor(ivol) = perm_tensor(ivol)*(dens_h2o*gacc/visc_h2o)
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
          end if

          if (ihyc > 0) then
            close(ihyc)
            call lun_free(ihyc)
          end if

        end if
#endif

!c  read hydraulic conductivity field from file

        subsection = 'read hydraulic conductivity field from file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          ihyc = lun_get()

          open(ihyc,file=prefix(:l_prfx)//'.hyc',                      &
                    status='unknown', form='formatted')

          permeability_field = .true.

!c  read hydraulic conductivities
#ifdef USG
          if (discretization_type > 0 .and. is_cell_based_perm_cond) then
            ierrcd = 15
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy

#ifdef PETSC
            do icellgbl = 1,num_cells_gbl
              icell = cell_idx_g2lg(icellgbl)
#else
            do icell = 1,num_cells
#endif
              if (icell > 0) then
                if (type_cond_perm == 1) then
                  ierrcd = 16
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,     &
                        permx(icell), permy(icell), permz(icell)
                else if (type_cond_perm == 2) then
                  ierrcd = 17
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,     &
                        perm_tensor(icell)%xx, perm_tensor(icell)%xy,      &
                        perm_tensor(icell)%xz, perm_tensor(icell)%yx,      &
                        perm_tensor(icell)%yy, perm_tensor(icell)%yz,      &
                        perm_tensor(icell)%zx, perm_tensor(icell)%zy,      &
                        perm_tensor(icell)%zz
                end if
              else
                ierrcd = 18
                read(ihyc,*,err=998,end=998) rdummy
              end if
            end do

          else
#endif
            ierrcd = 19
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
            read(ihyc,*,err=998,end=998) cdummy
#ifdef USG
            if (discretization_type > 0) then
              do ivolgbl = 1,nngbl
#ifdef PETSC
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
                else
                  ivol = node_idx_g2lg(ivolgbl)
                end if
#else
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2g_invord(ivolgbl)
                else
                  ivol = ivolgbl
                end if
#endif
                if (ivol > 0) then
                  if (type_cond_perm == 1) then
                    ierrcd = 20
                    read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                          permx(ivol), permy(ivol), permz(ivol)
                  else if (type_cond_perm == 2) then
                    ierrcd = 21
                    read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                          perm_tensor(ivol)%xx, perm_tensor(ivol)%xy,      &
                          perm_tensor(ivol)%xz, perm_tensor(ivol)%yx,      &
                          perm_tensor(ivol)%yy, perm_tensor(ivol)%yz,      &
                          perm_tensor(ivol)%zx, perm_tensor(ivol)%zy,      &
                          perm_tensor(ivol)%zz
                  end if
                else
                  ierrcd = 22
                  read(ihyc,*,err=998,end=998) rdummy
                end if
              end do
            end if
#endif
            if (discretization_type == 0) then
              nskip = 0
              do ivol = 1,nngl
#ifdef PETSC
                do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                  ierrcd = 23
                  read(ihyc,*,end=999,err=999) rdummy
                end do
                nskip = node_idx_lg2g(ivol)
#endif
                if (type_cond_perm == 1) then
                  ierrcd = 24
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                        permx(ivol), permy(ivol), permz(ivol)
                else if (type_cond_perm == 2) then
                  ierrcd = 25
                  read(ihyc,*,err=998,end=998) rdummy, rdummy, rdummy,   &
                        perm_tensor(ivol)%xx, perm_tensor(ivol)%xy,      &
                        perm_tensor(ivol)%xz, perm_tensor(ivol)%yx,      &
                        perm_tensor(ivol)%yy, perm_tensor(ivol)%yz,      &
                        perm_tensor(ivol)%zx, perm_tensor(ivol)%zy,      &
                        perm_tensor(ivol)%zz
                end if
              end do
            end if
#ifdef USG
          end if
#endif
        
          close(ihyc)
          call lun_free(ihyc)
                
        end if

#ifdef USG
!c  read hydraulic conductivity field from file

        subsection = 'read hydraulic conductivity field from vtk file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          ihyc = lun_get()
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
              .not.read_spatial_master_proc .or.                       &
              is_cell_based_perm_cond) then
            open(ihyc,file=prefix(:l_prfx)//'.hyc.vtk',                &
                status='unknown', form='formatted')
          else
            call lun_free(ihyc)
            ihyc = 0
          end if
          permeability_field = .true.

!c  read hydraulic conductivities
          if (discretization_type > 0 .and. is_cell_based_perm_cond) then

            if (type_cond_perm == 1) then
              subcommand = "vectors k double"
            else if (type_cond_perm == 2) then
              subcommand = "tensors k double"
            end if
            bfound = findnextline(ihyc, subcommand, 0, .false.)
            if (bfound) then
              !c note: mpi parallel version does not supported here
              !c to be modified later
              if (type_cond_perm == 1) then
                do icell = 1,num_cells
                  ierrcd = 26
                  read(ihyc,*,err=998,end=998) permx(icell), permy(icell), &
                                               permz(icell)
                end do
              else if (type_cond_perm == 2) then
                do icell = 1,num_cells
                  ierrcd = 27
                  read(ihyc,*,err=998,end=998) perm_tensor(icell)%xx,      &
                        perm_tensor(icell)%xy, perm_tensor(icell)%xz,      &
                        perm_tensor(icell)%yx, perm_tensor(icell)%yy,      &
                        perm_tensor(icell)%yz, perm_tensor(icell)%zx,      &
                        perm_tensor(icell)%zy, perm_tensor(icell)%zz
                end do
              end if
            end if

          else if (.not. is_cell_based_perm_cond) then
            if (type_cond_perm == 1) then
              call read_vtk_data_from_file(ihyc,'k',bfound,permx,permy,permz)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read hydraulic conductivity field from vtk file: done'
                  write(ilog,'(a)') 'read hydraulic conductivity field from vtk file: done'
                end if
              end if
            else if (type_cond_perm == 2) then
              call read_vtk_data_from_file(ihyc,'k',bfound,perm_tensor)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read hydraulic conductivity field from vtk file: done'
                  write(ilog,'(a)') 'read hydraulic conductivity field from vtk file: done'
                end if
              end if
            end if
          end if

          if (ihyc > 0) then
            close(ihyc)
            call lun_free(ihyc)
          end if

        end if
#endif
      
!cprovi--------------------------------------------------------------
!cprovi Read Specific Storage coefficient from file
!cprovi--------------------------------------------------------------      
        subsection = 'read specific storage coefficient from file'
         
        call findstrg(subsection,itmp,found_subsection)
        
        if (found_subsection) then

          istor = lun_get()
          
          open(istor,file=prefix(:l_prfx)//'.spstor',status='unknown',&
                form='formatted')
          
          storcoeff_field = .true.
          stor=r0
          
          ierrcd = 28
          read(istor,*,err=998,end=998) cdummy
          read(istor,*,err=998,end=998) cdummy
          read(istor,*,err=998,end=998) cdummy
#ifdef USG
          if (discretization_type > 0) then
            do ivolgbl = 1,nngbl
#ifdef PETSC
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
              else
                ivol = node_idx_g2lg(ivolgbl)
              end if
#else
              if (ibits(usg_mesh_ordering,0,2) == 3) then
                ivol = node_idx_g2g_invord(ivolgbl)
              else
                ivol = ivolgbl
              end if
#endif
              if (ivol > 0) then
                ierrcd = 29
                read(istor,*,err=998,end=998) rdummy, rdummy,          &
                                              rdummy, stor(ivol)
              else
                ierrcd = 30
                read(istor,*,err=998,end=998) rdummy
              end if
            end do
          end if
#endif
          if (discretization_type == 0) then
            nskip = 0
            do ivol = 1,nngl
#ifdef PETSC
              do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                ierrcd = 31
                read(istor,*,end=999,err=999) rdummy
              end do
              nskip = node_idx_lg2g(ivol)
#endif
              ierrcd = 32
              read(istor,*,err=998,end=998) rdummy, rdummy,            &
                                           rdummy, stor(ivol)
            end do
          end if

          close(istor)
          call lun_free(istor)
                  
        end if

#ifdef USG
!cprovi--------------------------------------------------------------
!cprovi Read Specific Storage coefficient from file
!cprovi--------------------------------------------------------------
        subsection = 'read specific storage coefficient from vtk file'

        call findstrg(subsection,itmp,found_subsection)

        if (found_subsection) then

          istor = lun_get()
          if ((read_spatial_master_proc .and. rank == 0) .or.          &
              .not.read_spatial_master_proc) then
            open(istor,file=prefix(:l_prfx)//'.spstor.vtk',            &
                 status='unknown',form='formatted')
          else
            call lun_free(istor)
            istor = 0
          end if

          storcoeff_field = .true.
          stor=r0

          call read_vtk_data_from_file(istor,'stor',bfound,stor)
          if (bfound) then
            if (rank == 0 .and. b_enable_output) then
              write(*,'(a)') 'read specific storage coefficient from vtk file: done'
              write(ilog,'(a)') 'read specific storage coefficient from vtk file: done'
            end if
          end if

          if (istor > 0) then
            close(istor)
            call lun_free(istor)
          end if

        end if
#endif

!cdsu -----------------------------------------------------------------
!cdsu Read hydraulic function parameters from external file
!cdsu -----------------------------------------------------------------
        if (variably_saturated) then

!cdsu -----------------------------------------------------------------
!cdsu Read hydraulic function parameters from external file in tecplot format
!cdsu -----------------------------------------------------------------
          subsection = 'read soil hydraulic function parameters from file'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then

            soilhydrfunc_field = .true.
            isovendry = .false.

            call mem_mat_ext

            ishfp = lun_get()

            open(ishfp,file=prefix(:l_prfx)//'.shfp',status='unknown',&
                 form='formatted')

            ierrcd = 33
            read(ishfp,*,err=998,end=998) cdummy
            read(ishfp,*,err=998,end=998) cdummy
            read(ishfp,*,err=998,end=998) cdummy
#ifdef USG
            if (discretization_type > 0) then
              do ivolgbl = 1,nngbl
#ifdef PETSC
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2lg(node_idx_g2g_invord(ivolgbl))
                else
                  ivol = node_idx_g2lg(ivolgbl)
                end if
#else
                if (ibits(usg_mesh_ordering,0,2) == 3) then
                  ivol = node_idx_g2g_invord(ivolgbl)
                else
                  ivol = ivolgbl
                end if
#endif
                if (ivol > 0) then
                  if ((.not.root_uptake) .and. (.not.trap_bubbles)) then
                    ierrcd = 34
                    read(ishfp,*,err=998,end=998)                        &
                         rdummy, rdummy, rdummy,                         &
                         swr_vol(ivol), spalpha_vol(ivol),               &
                         spbeta_vol(ivol), expn_vol(ivol),               &
                         aentry_vol(ivol)
                  else if (root_uptake) then
                    ierrcd = 35
                    read(ishfp,*,err=998,end=998)                        &
                         rdummy, rdummy, rdummy,                         &
                         swr_vol(ivol), spalpha_vol(ivol),               &
                         spbeta_vol(ivol), expn_vol(ivol),               &
                         aentry_vol(ivol), h1dry_vol(ivol)
                  else if (trap_bubbles) then
                    ierrcd = 36
                    read(ishfp,*,err=998,end=998)                        &
                         rdummy, rdummy, rdummy,                         &
                         swr_vol(ivol), spalpha_vol(ivol),               &
                         spbeta_vol(ivol), expn_vol(ivol),               &
                         aentry_vol(ivol), sgr_imbi_vol(ivol)
                  end if

                  spgamma_vol(ivol) = r1-(r1/spbeta_vol(ivol))
                else
                  ierrcd = 37
                  read(ishfp,*,err=998,end=998) rdummy
                end if
              end do
            end if
#endif
            if (discretization_type == 0) then
              nskip = 0
              do ivol = 1,nngl
#ifdef PETSC
                do iskip = 1, node_idx_lg2g(ivol) - nskip -1
                  ierrcd = 38
                  read(ishfp,*,end=999,err=999) rdummy
                end do
                nskip = node_idx_lg2g(ivol)
#endif

                if ((.not.root_uptake) .and. (.not.trap_bubbles)) then
                  ierrcd = 39
                  read(ishfp,*,err=998,end=998)                          &
                       rdummy, rdummy, rdummy,                           &
                       swr_vol(ivol), spalpha_vol(ivol),                 &
                       spbeta_vol(ivol), expn_vol(ivol),                 &
                       aentry_vol(ivol)
                else if (root_uptake) then
                  ierrcd = 40
                  read(ishfp,*,err=998,end=998)                          &
                       rdummy, rdummy, rdummy,                           &
                       swr_vol(ivol), spalpha_vol(ivol),                 &
                       spbeta_vol(ivol), expn_vol(ivol),                 &
                       aentry_vol(ivol), h1dry_vol(ivol)
                else if (trap_bubbles) then
                  ierrcd = 41
                  read(ishfp,*,err=998,end=998)                          &
                       rdummy, rdummy, rdummy,                           &
                       swr_vol(ivol), spalpha_vol(ivol),                 &
                       spbeta_vol(ivol), expn_vol(ivol),                 &
                       aentry_vol(ivol), sgr_imbi_vol(ivol)
                end if

                spgamma_vol(ivol) = r1-(r1/spbeta_vol(ivol))

              end do
            end if

            close(ishfp)
            call lun_free(ishfp)

          end if

#ifdef USG
!cdsu -----------------------------------------------------------------
!cdsu Read hydraulic function parameters from external file in vtk format
!cdsu -----------------------------------------------------------------
          subsection = 'read soil hydraulic function parameters from vtk file'

          call findstrg(subsection,itmp,found_subsection)

          if (found_subsection) then

            soilhydrfunc_field = .true.
            isovendry = .false.

            call mem_mat_ext

            ishfp = lun_get()
            if ((read_spatial_master_proc .and. rank == 0) .or.        &
                .not.read_spatial_master_proc) then
              open(ishfp,file=prefix(:l_prfx)//'.shfp.vtk',            &
                   status='unknown',form='formatted')
            else
              call lun_free(ishfp)
              ishfp = 0
            end if

            call read_vtk_data_from_file(ishfp,'swr',bfound,swr_vol)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read residual saturation from vtk file: done'
                write(ilog,'(a)') 'read residual saturation from vtk file: done'
              end if
            end if     

            call read_vtk_data_from_file(ishfp,'spalpha',bfound,spalpha_vol)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read alpha from vtk file: done'
                write(ilog,'(a)') 'read alpha from vtk file: done'
              end if
            end if

            call read_vtk_data_from_file(ishfp,'spbeta',bfound,spbeta_vol)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read beta_vol from vtk file: done'
                write(ilog,'(a)') 'read beta_vol from vtk file: done'
              end if
            end if

            call read_vtk_data_from_file(ishfp,'expn',bfound,expn_vol)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read expn from vtk file: done'
                write(ilog,'(a)') 'read expn from vtk file: done'
              end if
            end if

            call read_vtk_data_from_file(ishfp,'aentry',bfound,aentry_vol)
            if (bfound) then
              if (rank == 0 .and. b_enable_output) then
                write(*,'(a)') 'read air entry from vtk file: done'
                write(ilog,'(a)') 'read air entry from vtk file: done'
              end if
            end if

            !if (root_uptake) then
              call read_vtk_data_from_file(ishfp,'h1dry',bfound,h1dry_vol)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read h1dry from vtk file: done'
                  write(ilog,'(a)') 'read h1dry from vtk file: done'
                end if
              end if
            !end if

            if (trap_bubbles) then
              call read_vtk_data_from_file(ishfp,'sgr_imbi',bfound,sgr_imbi_vol)
              if (bfound) then
                if (rank == 0 .and. b_enable_output) then
                  write(*,'(a)') 'read sgr_imbi from vtk file: done'
                  write(ilog,'(a)') 'read sgr_imbi from vtk file: done'
                end if
              end if
            end if

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppvs_1)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)
    !$omp do schedule(static)
#endif
            do ivol = 1, nngl
              spgamma_vol(ivol) = r1-(r1/spbeta_vol(ivol))
              satwdry_vol(ivol)=satfpres(swr_vol(ivol),aentry_vol(ivol), &
                      h1dry_vol(ivol),spalpha_vol(ivol),spbeta_vol(ivol),&
                      spgamma_vol(ivol))
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif
            if (ishfp > 0) then
              close(ishfp)
              call lun_free(ishfp)
            end if

          end if
#endif

        end if         !variably_saturated, read soil hydraulic parameters from file

!c  convert to internal time units

        if (permeability_field) then

#ifdef USG
          if (discretization_type > 0 .and. is_cell_based_perm_cond) then
#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (num_cells > numofloops_thred_initppvs_2)                &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (icell)
    !$omp do schedule(static)
#endif
            do icell = 1, num_cells
              if (type_cond_perm == 1) then
                permx(icell) = permx(icell)*sec_per_days
                permy(icell) = permy(icell)*sec_per_days
                permz(icell) = permz(icell)*sec_per_days
              else if (type_cond_perm == 2) then
                perm_tensor(icell) = perm_tensor(icell)*sec_per_days
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif

!c  feed-back to output file
            if (b_enable_output .and. b_enable_output_gen) then
              write(igen,'(3a)') 'read as cell properties from file ',&
                                  prefix(:l_prfx)//'.hyc'
            end if
          else
#endif

#ifdef OPENMP
    !$omp parallel                                                    &
    !$omp if (nngl > numofloops_thred_initppvs_2)                     &
    !$omp num_threads(numofthreads_global)                            &
    !$omp default(shared)                                             &
    !$omp private (ivol)                  
    !$omp do schedule(static)
#endif        
            do ivol = 1,nngl
              if (type_cond_perm == 1) then
                permx(ivol) = permx(ivol)*sec_per_days
                permy(ivol) = permy(ivol)*sec_per_days
                permz(ivol) = permz(ivol)*sec_per_days
              else if (type_cond_perm == 2) then
                perm_tensor(ivol) = perm_tensor(ivol)*sec_per_days
              end if
            end do
#ifdef OPENMP
    !$omp end do
    !$omp end parallel
#endif 

!c  feed-back to output file
            if (b_enable_output .and. b_enable_output_gen) then
              write(igen,'(3a)') 'read as nodal properties from file ',&
                                  prefix(:l_prfx)//'.hyc'
            end if

#ifdef USG
          end if
#endif

!c  return to calling routine 
!c        return
!c
!c  Bug here, for unsaturated flow, soil parameters are needed,
!c  modify zone reading accordingly. DSU 2018-05-22

        end if



!c  read material properties for material property zones from input file
               
        do izn = 1, nzn                !loop over property zones

!c  assign defaults for physical parameters for variably saturated flow
          if (.not. storcoeff_field) then
            spstor(izn) = r0
          end if

!c  search for entry for material property zone in input file

          zone_name = mprop_name(izn)

!c  define length of name of material property zone

          l_zone_name = index(zone_name,'  ')-1
          if (l_zone_name.lt.0.or.l_zone_name.gt.72) then
            l_zone_name = 72
          end if

!c  search temporary data file for current material property zone
!c  and write to scratch file

          call readbloc (itmp,icnv,zone_name,found_subsection,.true.)

!c  read material properties

          if (found_subsection) then

            if (.not. permeability_field) then

              flag_cond_set = .false.

              if (type_cond_perm == 1) then
!c  hydraulic conductivities in x-direction

                subsection = 'hydraulic conductivity in x-direction'

                call findstrg(subsection,icnv,found_subsection)

                if (found_subsection.and.(nvx.gt.1.or.                   &
                    (node_max%x-node_min%x)>rsmall)) then

                  ierrcd = 42
                  read(icnv,*,err=999,end=999) condxx(izn)
                  !condxx(izn) = condxx(izn)*convk           !convert hydraulic conductivity to permeability

                elseif (.not.found_subsection.and.(nvx.gt.1.or.          &
                        (node_max%x-node_min%x)>rsmall)) then
                  if (rank == 0) then
                    write(ilog,*) 'SIMULATION TERMINATED'
                    write(ilog,*) 'error reading input file'
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop

                end if

!c  hydraulic conductivities in y-direction

                subsection = 'hydraulic conductivity in y-direction'

                call findstrg(subsection,icnv,found_subsection)

                if (found_subsection.and.(nvy.gt.1.or.                   &
                    (node_max%y-node_min%y)>rsmall)) then

                  ierrcd = 43
                  read(icnv,*,err=999,end=999) condyy(izn)
                  !condyy(izn) = condyy(izn)*convk           !convert hydraulic conductivity to permeability

                elseif (.not.found_subsection.and.(nvy.gt.1.or.          &
                        (node_max%y-node_min%y)>rsmall)) then
                  if (rank == 0) then
                    write(ilog,*) 'SIMULATION TERMINATED'
                    write(ilog,*) 'error reading input file'
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop

                end if

!c  hydraulic conductivities in z-direction

                subsection = 'hydraulic conductivity in z-direction'

                call findstrg(subsection,icnv,found_subsection)

                if (found_subsection.and.(nvz.gt.1.or.                   &
                    (node_max%z-node_min%z)>rsmall)) then

                  ierrcd = 44
                  read(icnv,*,err=999,end=999) condzz(izn)
                  !condzz(izn) = condzz(izn)*convk           !convert hydraulic conductivity to permeability

                elseif (.not.found_subsection.and.(nvz.gt.1.or.          &
                        (node_max%z-node_min%z)>rsmall)) then
                  if (rank == 0) then
                    write(ilog,*) 'SIMULATION TERMINATED'
                    write(ilog,*) 'error reading input file'
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop

                end if

                flag_cond_set = .true.
                
              else if (type_cond_perm == 2) then
!cdsu hydraulic conductivity full tensor
                subsection = 'hydraulic conductivity tensor'
  
                call findstrg(subsection,icnv,found_subsection)
  
                if (found_subsection) then
                  ierrcd = 45
                  read(icnv,*,err=999,end=999) cond_tensor(izn)%xx,    &
                                               cond_tensor(izn)%xy,    &
                                               cond_tensor(izn)%xz,    &
                                               cond_tensor(izn)%yx,    &
                                               cond_tensor(izn)%yy,    &
                                               cond_tensor(izn)%yz,    &
                                               cond_tensor(izn)%zx,    &
                                               cond_tensor(izn)%zy,    &
                                               cond_tensor(izn)%zz
                  !cond_tensor(izn) = cond_tensor(izn) * convk    !convert hydraulic conductivity to permeability
                  flag_cond_set = .true.
                end if
              end if

              if (.not.flag_cond_set) then
                if (rank == 0) then
                  write(ilog,*) 'SIMULATION TERMINATED'
                  write(ilog,*) 'error reading input file'
                  write(ilog,*) 'section "',trim(section_header),'"'
                  write(ilog,*) 'zone "', trim(zone_name),'"'
                  write(ilog,*) 'subsection "',trim(subsection),'" missing'
                  close(ilog)
                end if
#ifdef PETSC
                call petsc_mpi_finalize
#endif
                stop
              end if

!c  hydraulic conductivity relationship over depth, compared to the K at the surface
!c  here we use a similar permeability relationship over depth reported by 
!c  Stefano Delfino Normani, 2009, Paleoevolution of Pore Fluids in Glaciated Geologic Settings,
!c  PhD thesis presented to the University of Waterloo, pp 71-72.
!c  K(depth)/K(surface) = 10**(a*exp(-b*depth)-c)
              subsection = 'hydraulic conductivity change over depth'
              call findstrg(subsection,icnv,found_subsection)
              if (.not. found_subsection) then
                subsection = 'permeability change over depth'
                call findstrg(subsection,icnv,found_subsection)
              end if

              if (found_subsection) then
                ierrcd = 46
                read(icnv,*,err=999,end=999) k_depth_parms(1:3,izn)
              end if

            end if        !.not. permeability_field

!c  specific storage coefficient

            if (.not. storcoeff_field) then
              subsection = 'specific storage coefficient'
              call findstrg(subsection,icnv,found_subsection)
              storcoeff_specified = .false.
              if (found_subsection.and.transient_flow) then
                storcoeff_specified = .true.
                ierrcd = 47
                read(icnv,*,err=999,end=999) spstor(izn)

              else if (.not.found_subsection.and.transient_flow .and.  &
                       .not. storcoeff_mech_cal(izn)) then
                if (.not. update_permeability) then
                  if (rank == 0) then
                    write(ilog,*) 'SIMULATION TERMINATED'
                    write(ilog,*) 'error reading input file'
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop
                end if

              end if
            end if         !.not. storcoeff_field


            if (.not. soilhydrfunc_field) then
              if (variably_saturated) then

!c  soil hydraulic function parameters

                subsection = 'soil hydraulic function parameters'

                call findstrg(subsection,icnv,found_subsection)

                if (found_subsection) then
                  ierrcd = 48 
                  read(icnv,*,err=999,end=999) swr(izn)
                  read(icnv,*,err=999,end=999) spalpha(izn)
                  read(icnv,*,err=999,end=999) spbeta(izn)
                  read(icnv,*,err=999,end=999) expn(izn)
                  read(icnv,*,err=999,end=999) aentry(izn)

                  !c FG's code removed root_uptake condition here
                  !c 1600.0                        ;psidry (air-dry pressure head)
                  if (root_uptake .or. pure_evap) then
                    ierrcd = 49
                    read(icnv,*,err=990,end=999) h1dry(izn)  !CBF FG read air dried aqueous pressure head, for simple evapo function + get ride of standard format file (if ERR = > continue with 0)
990                 continue
                  end if

                  !DSU - Without root_uptake check, this will cause crash when gas bubble model is used as sgr_imbi parameter is used by h1dry.
                  !DSU - It is best to add another keyword for h1dry and sgr_imbi.
                  !DSU - For currently version, read h1dry when root_uptake is used.

                  if (trap_bubbles) then
                    ierrcd = 50
                    read(icnv,*,err=999,end=999) sgr_imbi(izn)
                  end if

!c  assign remaining soil hydraulic function parameters      

                  spgamma(izn) = r1-(r1/spbeta(izn))
                  !cprovi----------------------------------------------------
                  !cprovi This parameter if for oven-dry model
                  !cprovi----------------------------------------------------
                  isovendry = .false.
                  !cprovi----------------------------------------------------

                elseif (.not.found_subsection) then
                  if (rank == 0) then
                    write(ilog,*) 'SIMULATION TERMINATED'
                    write(ilog,*) 'error reading input file'
                    write(ilog,*) 'section "',trim(section_header),'"'
                    write(ilog,*) 'zone "', trim(zone_name),'"'
                    write(ilog,*) 'subsection "',trim(subsection),'" missing'
                    close(ilog)
                  end if
#ifdef PETSC
                  call petsc_mpi_finalize
#endif
                  stop

                end if

              end if             !(variably_saturated)
            
!c  calculate water saturation at wilting point and field capacity !CBF

              satwdry(izn)=satfpres(swr(izn),aentry(izn),h1dry(izn),   &
                        spalpha(izn),spbeta(izn),spgamma(izn))


!c  write parameters for variably saturated flow to generic output file
              if (b_enable_output .and. b_enable_output_gen) then

                write(igen,'(/a,i0,a,1x,a)') 'material property zone ',&
                                              izn,':',                 &
                                              zone_name(:l_zone_name)
                write(igen,'(72a)')('-',i=1,72)

                if (type_cond_perm == 1) then
                  if (nvx.gt.1.or.(node_max%x-node_min%x)>rsmall) then
                    write(igen,'(a,1pe15.6e3)')                           &
                    'saturated hydraulic conductivity K_xx           = ', &
                     condxx(izn)
                  end if
                  if (nvy.gt.1.or.(node_max%y-node_min%y)>rsmall) then
                    write(igen,'(a,1pe15.6e3)')                           &
                    'saturated hydraulic conductivity K_yy           = ', &
                     condyy(izn)
                  end if
                  if (nvz.gt.1.or.(node_max%z-node_min%z)>rsmall) then
                    write(igen,'(a,1pe15.6e3)')                           &
                    'saturated hydraulic conductivity K_zz           = ', &
                     condzz(izn)
                  end if
                else if (type_cond_perm == 2) then
                  write(igen,'(a,/,3(4x,a,2x,3(1pe15.6e3,2x),/))')        &
                    'saturated permeability tensor                   = ', &
                    'xx-, xy-, xz-term',cond_tensor%xx,cond_tensor%xy,    &
                                        cond_tensor%xz,                   &
                    'yx-, yy-, yz-term',cond_tensor%yx,cond_tensor%yy,    &
                                        cond_tensor%yz,                   &
                    'zx-, zy-, zz-term',cond_tensor%zx,cond_tensor%zy,    &
                                        cond_tensor%zz
                end if

                if (transient_flow .and. .not.storcoeff_field) then
                  write(igen,'(a,1pe15.6e3)')                             &
                  'specific storage coefficient                    = ',   &
                   spstor(izn)
                end if
                
                if (variably_saturated) then
                  write(igen,'(/a,4(/a,41x,a,1pe15.6e3))')                &
                  'van genuchten parameters:',                            &
                  'alpha ',' = ',spalpha(izn),                            &
                  'beta  ',' = ',spbeta(izn),                             &
                  'gamma ',' = ',spgamma(izn),                            &
                  'expn  ',' = ',expn(izn)
                  write(igen,'(a,1pe15.6e3)')                             &
                  'air entry pressure                              = ',   &
                   aentry(izn)
                end if
          
              end if

            end if    !.not. soilhydrfunc_field


!c  conversion of time units for computation in days

            if (type_cond_perm == 1) then
              if (nvx.gt.1.or.(node_max%x-node_min%x)>rsmall) then
                condxx(izn) = condxx(izn) * sec_per_days
              end if
              if (nvy.gt.1.or.(node_max%y-node_min%y)>rsmall) then
                condyy(izn) = condyy(izn) * sec_per_days
              end if
              if (nvz.gt.1.or.(node_max%z-node_min%z)>rsmall) then
                condzz(izn) = condzz(izn) * sec_per_days
              end if
            else if (type_cond_perm == 2) then
              cond_tensor(izn) = cond_tensor(izn) * sec_per_days
            end if

          elseif (.not.found_subsection) then
            if (.not. permeability_field .or. variably_saturated) then
              if (rank == 0) then
                write(ilog,*) 'SIMULATION TERMINATED'
                write(ilog,*) 'error reading section "',                &
     &                         section_header(:l_string),'" ',          &
     &                        'in input file'
                write(ilog,*) 'entry for material property zone "',     &
     &                         zone_name(:l_zone_name),'" missing'
                write(ilog,*) 'error may also be caused by missing or ',&
     &                        'mispelled keyword for nodal property ',  &
     &                        'zone input'
                close(ilog)
              end if
#ifdef PETSC
              call petsc_mpi_finalize
#endif
              stop
            end if

          end if                          !(found_subsection)

        end do                            !loop over property zones


!c  set the change of hydraulic conductivity/permeability change over depth
#ifdef USG
        if (b_use_layered_mesh) then
          if (is_cell_based_perm_cond) then
            do icell = 1, num_cells
              izn = mpropvs_cell(icell)
              depth = r0
              do i = 1, num_nodes_per_cell
                depth = depth + layer_nodes_top(node_to_layer_node(    &
                                                cells(i,icell)))%z
              end do
              depth = depth / num_nodes_per_cell
              depth = depth - CellCenter(icell)%z
              k_depth_ratio(icell) = 10**(k_depth_parms(1,izn)*        &
                                     exp(-k_depth_parms(2,izn)*depth)- &
                                          k_depth_parms(3,izn))
            end do
          else
            do ivol = 1, nngl
              izn = mpropvs(ivol)
              depth = layer_nodes_top(node_to_layer_node(ivol))%z -    &
                      nodes(ivol)%z
              k_depth_ratio(ivol) = 10**(k_depth_parms(1,izn)*         &
                                    exp(-k_depth_parms(2,izn)*depth)-  &
                                         k_depth_parms(3,izn))
            end do
          end if
        else
#endif
          if (.not. is_cell_based_perm_cond) then
            do ivol = 1, nngl
              izn = mpropvs(ivol)
              depth = elevmax-zg(ivol)
              k_depth_ratio(ivol) = 10**(k_depth_parms(1,izn)*         &
                                    exp(-k_depth_parms(2,izn)*depth)-  &
                                         k_depth_parms(3,izn))
            end do
          end if
#ifdef USG
        end if
#endif

       
!c DSU initialize pure_evap logical
!c DSU originally initialized in evapo which is not a good idea
!FG August 2021 - I have cleaned and changed the code a bit to be able to use the simple evaporation function even if no root uptake
        if (pure_evap) then   !if soil evaporation activated and no root uptake => pure evap = .true.
                                                         !and pet read from soi file          
          !c When root_uptake is used, the file prefix.soi is already opened in initplant.
          !c Othereise, open soi file and read required parameters.
          isoi =  lun_get()
          ierrcd = 51
          open(isoi,file=prefix(:l_prfx)//'.soi', err=997, status='old')
          read(isoi,*,err=998,end=998) time_soi,pet,canopy_int,        &
                                       solar_ratio,scale_tree_growth
          pe_soil = pet*toparea*sec_per_days             !FG August 2021 - converted in m3/s here now, and not in evap and rootwat functions

        end if

      end if                              !(found_section)

!c  set storage cofficient
      if (storcoeff_specified) then
        do ivol=1,nngl
          izn=mpropvs(ivol)
          stor(ivol)=spstor(izn)
        end do
      end if

!c  output of nodal hydraulic conductivities           

      if (b_enable_output) then

!c  output of hydraulic conductivities in units [m/s]

#ifdef USG
        if (discretization_type > 0) then

          if (b_output_binary) then
#ifdef PETSC_HDF
            strfilename = prefix(:l_prfx)//'_o.hyc'
            if (b_output_separate_mesh_result) then
              strfilename_mesh = prefix(:l_prfx)//'_domain.h5'
              strfilename_result = trim(strfilename)//'.h5'
            else
              strfilename_mesh = trim(strfilename)//'.h5'
              strfilename_result = trim(strfilename)//'.h5'
            end if

            !c open corresponding xmf file to be loaded by paraview
            if (rank == 0) then
              ixmf = lun_get()
              open(ixmf,file=trim(strfilename)//'.xmf',                &
                   status='unknown',form='formatted')
            end if

            !c initialize fortran interface
            call h5open_f(hdf5_ierr)

            !c setup file access property list with parallel I/O access
            call h5pcreate_f(H5P_FILE_ACCESS_F, plist_id, hdf5_ierr)
            call h5pset_fapl_mpio_f(plist_id, Petsc_Comm_World,        &
                                    MPI_INFO_NULL, hdf5_ierr)
            !c create the file collectively
            call h5fcreate_f(strfilename_result, H5F_ACC_TRUNC_F,      &
                             file_id,hdf5_ierr, access_prp = plist_id)

            !c write attribute
            call hdf5_usg_write_attribute(file_id)

            if (.not. b_output_separate_mesh_result) then
              !c write mesh data
              call hdf5_usg_write_mesh_data(file_id)
            end if

            !c open corresponding xmf file for mesh and domain decomposition
            if (rank == 0) then
              call hdf5_usg_write_xmf_initialize(ixmf)
              call hdf5_usg_write_xmf_mesh(ixmf,strfilename_mesh,      &
                        cell_type,num_cells_gbl,num_nodes_gbl,         &
                        num_nodes_per_cell)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_rank",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_rank",        &
                        "Scalar","Cell",num_cells_gbl,1)

              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","vertices_lg2g",     &
                        "Scalar","Node",num_nodes_gbl,1)
              call hdf5_usg_write_xmf_attribute(ixmf,                  &
                        strfilename_mesh,"domain","cells_lg2g",        &
                        "Scalar","Cell",num_cells_gbl,1)

              if (b_use_node_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","vertices_matid",  &
                          "Scalar","Node",num_nodes_gbl,1)
              end if
              if (b_use_cell_matids) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_mesh,"domain","cells_matid",     &
                          "Scalar","Cell",num_cells_gbl,1)
              end if
            end if

            !c create a group for the mesh data set
            strbuffer = "results"
            !c create and open a group
            call h5gcreate_f(file_id,strbuffer,group_id,hdf5_ierr,     &
                             OBJECT_NAMELEN_DEFAULT_F)

            if (type_cond_perm == 1) then
              if (is_cell_based_perm_cond) then
                allocate(realbuffer(num_cells*3), stat = ierr)
                call checkerr(ierr,'initppvs-realbuffer',ilog)
                call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
  
                if (permeability_field) then
                  do icell = 1, num_cells
                    realbuffer((icell-1)*3+1) = permx(icell)/sec_per_days
                    realbuffer((icell-1)*3+2) = permy(icell)/sec_per_days
                    realbuffer((icell-1)*3+3) = permz(icell)/sec_per_days
                  end do
                else
                  do icell = 1, num_cells
                    izn = mpropvs_cell(icell)
                    realbuffer((icell-1)*3+1) = condxx(izn)/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*3+2) = condyy(izn)/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*3+3) = condzz(izn)/sec_per_days*&
                                                k_depth_ratio(icell)
                  end do
                end if
  
                call hdf5_usg_write_group_data_vec(group_id,"K",3,       &
                          num_cells_loc,num_cells_gbl,offset_cells,      &
                          realbuffer)
                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_result,"results","K","Vector",   &
                            "Cell",num_cells_gbl,3)
                end if
                call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
                deallocate(realbuffer)
              else
                allocate(realbuffer(num_nodes*3), stat = ierr)
                call checkerr(ierr,'initppvs-realbuffer',ilog)
                call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
  
                if (permeability_field) then
                  do ivol = 1, nngl
                    realbuffer((ivol-1)*3+1) = permx(ivol)/sec_per_days
                    realbuffer((ivol-1)*3+2) = permy(ivol)/sec_per_days
                    realbuffer((ivol-1)*3+3) = permz(ivol)/sec_per_days
                  end do
                else
                  do ivol = 1, nngl
                    izn = mpropvs(ivol)
                    realbuffer((ivol-1)*3+1) = condxx(izn)/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*3+2) = condyy(izn)/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*3+3) = condzz(izn)/sec_per_days*&
                                               k_depth_ratio(ivol)
                  end do
                end if
  
                call hdf5_usg_write_group_data_vec(group_id,"K",3,       &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                          realbuffer)
                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_result,"results","K","Vector",   &
                            "Node",num_nodes_gbl,3)
                end if
                call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
                deallocate(realbuffer)
              end if
            else if (type_cond_perm == 2) then
              if (is_cell_based_perm_cond) then
                allocate(realbuffer(num_cells*3), stat = ierr)
                call checkerr(ierr,'initppvs-realbuffer',ilog)
                call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
  
                if (permeability_field) then
                  do icell = 1, num_cells
                    realbuffer((icell-1)*9+1) = perm_tensor(icell)%xx/sec_per_days
                    realbuffer((icell-1)*9+2) = perm_tensor(icell)%xy/sec_per_days
                    realbuffer((icell-1)*9+3) = perm_tensor(icell)%xz/sec_per_days
                    realbuffer((icell-1)*9+4) = perm_tensor(icell)%yx/sec_per_days
                    realbuffer((icell-1)*9+5) = perm_tensor(icell)%yy/sec_per_days
                    realbuffer((icell-1)*9+6) = perm_tensor(icell)%yz/sec_per_days
                    realbuffer((icell-1)*9+7) = perm_tensor(icell)%zx/sec_per_days
                    realbuffer((icell-1)*9+8) = perm_tensor(icell)%zy/sec_per_days
                    realbuffer((icell-1)*9+9) = perm_tensor(icell)%zz/sec_per_days
                  end do
                else
                  do icell = 1, num_cells
                    izn = mpropvs_cell(icell)
                    realbuffer((icell-1)*9+1) = cond_tensor(izn)%xx/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+2) = cond_tensor(izn)%xy/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+3) = cond_tensor(izn)%xz/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+4) = cond_tensor(izn)%yx/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+5) = cond_tensor(izn)%yy/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+6) = cond_tensor(izn)%yz/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+7) = cond_tensor(izn)%zx/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+8) = cond_tensor(izn)%zy/sec_per_days*&
                                                k_depth_ratio(icell)
                    realbuffer((icell-1)*9+9) = cond_tensor(izn)%zz/sec_per_days*&
                                                k_depth_ratio(icell)
                  end do
                end if
  
                call hdf5_usg_write_group_data_vec(group_id,"K",9,       &
                          num_cells_loc,num_cells_gbl,offset_cells,      &
                          realbuffer)
                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_result,"results","K","Tensor",   &
                            "Cell",num_cells_gbl,9)
                end if
                call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
                deallocate(realbuffer)
              else
                allocate(realbuffer(num_nodes*9), stat = ierr)
                call checkerr(ierr,'initppvs-realbuffer',ilog)
                call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
  
                if (permeability_field) then
                  do ivol = 1, nngl
                    realbuffer((ivol-1)*9+1) = perm_tensor(ivol)%xx/sec_per_days
                    realbuffer((ivol-1)*9+2) = perm_tensor(ivol)%xy/sec_per_days
                    realbuffer((ivol-1)*9+3) = perm_tensor(ivol)%xz/sec_per_days
                    realbuffer((ivol-1)*9+4) = perm_tensor(ivol)%yx/sec_per_days
                    realbuffer((ivol-1)*9+5) = perm_tensor(ivol)%yy/sec_per_days
                    realbuffer((ivol-1)*9+6) = perm_tensor(ivol)%yz/sec_per_days
                    realbuffer((ivol-1)*9+7) = perm_tensor(ivol)%zx/sec_per_days
                    realbuffer((ivol-1)*9+8) = perm_tensor(ivol)%zy/sec_per_days
                    realbuffer((ivol-1)*9+9) = perm_tensor(ivol)%zz/sec_per_days
                  end do
                else
                  do ivol = 1, nngl
                    izn = mpropvs(ivol)
                    realbuffer((ivol-1)*9+1) = cond_tensor(izn)%xx/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+2) = cond_tensor(izn)%xy/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+3) = cond_tensor(izn)%xz/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+4) = cond_tensor(izn)%yx/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+5) = cond_tensor(izn)%yy/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+6) = cond_tensor(izn)%yz/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+7) = cond_tensor(izn)%zx/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+8) = cond_tensor(izn)%zy/sec_per_days*&
                                               k_depth_ratio(ivol)
                    realbuffer((ivol-1)*9+9) = cond_tensor(izn)%zz/sec_per_days*&
                                               k_depth_ratio(ivol)
                  end do
                end if
  
                call hdf5_usg_write_group_data_vec(group_id,"K",9,       &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                          realbuffer)
                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,                &
                            strfilename_result,"results","K","Tensor",   &
                            "Node",num_nodes_gbl,9)
                end if
                call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
                deallocate(realbuffer)
              end if
            end if

            !c output soil hydraulic function parameters
            if (soilhydrfunc_field) then

              !c swr
              call hdf5_usg_write_group_data_1d(group_id,"swr",        &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        swr_vol)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","swr",          &
                          "Scalar","Node",num_nodes_gbl,1)
              end if

              !c spalpha
              call hdf5_usg_write_group_data_1d(group_id,"spalpha",    &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        spalpha_vol)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","spalpha",      &
                          "Scalar","Node",num_nodes_gbl,1)
              end if

              !c spbeta
              call hdf5_usg_write_group_data_1d(group_id,"spbeta",     &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        spbeta_vol)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","spbeta",       &
                          "Scalar","Node",num_nodes_gbl,1)
              end if

              !c expn
              call hdf5_usg_write_group_data_1d(group_id,"expn",       &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        expn_vol)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","expn",         &
                          "Scalar","Node",num_nodes_gbl,1)
              end if

              !c aentry
              call hdf5_usg_write_group_data_1d(group_id,"aentry",     &
                        num_nodes_loc,num_nodes_gbl,offset_nodes,      &
                        aentry_vol)

              if (rank == 0) then
                call hdf5_usg_write_xmf_attribute(ixmf,                &
                          strfilename_result,"results","aentry",       &
                          "Scalar","Node",num_nodes_gbl,1)
              end if

              !c h1dry for root_uptake
              if (root_uptake .or. pure_evap) then
                call hdf5_usg_write_group_data_1d(group_id,"h1dry",    &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,    &
                          h1dry_vol)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_result,"results","h1dry",      &
                            "Scalar","Node",num_nodes_gbl,1)
                end if
              end if

              !c sgr_imbi for trap_bubbles
              if (trap_bubbles) then
                call hdf5_usg_write_group_data_1d(group_id,"sgr_imbi", &
                          num_nodes_loc,num_nodes_gbl,offset_nodes,    &
                          sgr_imbi_vol)

                if (rank == 0) then
                  call hdf5_usg_write_xmf_attribute(ixmf,              &
                            strfilename_result,"results","sgr_imbi",   &
                            "Scalar","Node",num_nodes_gbl,1)
                end if
              end if

            end if   !soilhydrfunc_field

            !c close group
            call h5gclose_f(group_id,hdf5_ierr)

            !c close file
            call h5pclose_f(plist_id, hdf5_ierr)
            call h5fclose_f(file_id, hdf5_ierr)

            !c close FORTRAN interface
            call h5close_f(hdf5_ierr)

            !c close xmf file
            if (rank == 0) then
              call hdf5_usg_write_xmf_finalize(ixmf)
              close(ixmf)
              call lun_free(ixmf)
            end if

#endif
          else
            ihyc = lun_get()
            open(ihyc,file=prefix(:l_prfx)//'_o'//                     &
                 trim(adjustl(str_rank))//'.hyc.vtk',status='unknown', &
                 form='formatted')

            call write_mesh_data_vtk_ascii(ihyc,                       &
                       "Hydraulic conductivity in units [m/s]")

            if (type_cond_perm == 1) then
              if (is_cell_based_perm_cond) then
                write(ihyc,'(a,1x,i12)') "CELL_DATA",num_cells
                write(ihyc,'(a)') "VECTORS K double"
  
                if (permeability_field) then
                  do icell = 1, num_cells
                    write(ihyc,'(3(1pe15.6e3,1x))')                      &
                          permx(icell)/sec_per_days,                     &
                          permy(icell)/sec_per_days,                     &
                          permz(icell)/sec_per_days
                  end do
                else
                  do icell = 1, num_cells
                    izn = mpropvs_cell(icell)
                    write(ihyc,'(3(1pe15.6e3,1x))')                      &
                          condxx(izn)/sec_per_days*k_depth_ratio(icell), &
                          condyy(izn)/sec_per_days*k_depth_ratio(icell), &
                          condzz(izn)/sec_per_days*k_depth_ratio(icell)
                  end do
                end if
  
              else
                write(ihyc,'(a,1x,i12)') "POINT_DATA",nngl
                write(ihyc,'(a)') "VECTORS K double"
  
                if (permeability_field) then
                  do ivol = 1, nngl
                    write(ihyc,'(3(1pe15.6e3,1x))')                      &
                          permx(ivol)/sec_per_days,                      &
                          permy(ivol)/sec_per_days,                      &
                          permz(ivol)/sec_per_days
                  end do
                else
                  do ivol = 1, nngl
                    izn = mpropvs(ivol)               
                    write(ihyc,'(3(1pe15.6e3,1x))')                      &
                          condxx(izn)/sec_per_days*k_depth_ratio(ivol),  &
                          condyy(izn)/sec_per_days*k_depth_ratio(ivol),  &
                          condzz(izn)/sec_per_days*k_depth_ratio(ivol)
                  end do
                end if
              end if
            else if (type_cond_perm == 2) then
              if (is_cell_based_perm_cond) then
                write(ihyc,'(a,1x,i12)') "CELL_DATA",num_cells
                write(ihyc,'(a)') "TENSORS K double"
  
                if (permeability_field) then
                  do icell = 1, num_cells
                    write(ihyc,'(9(1pe15.6e3,1x))')                      &
                          perm_tensor(icell)%xx/sec_per_days,            &
                          perm_tensor(icell)%xy/sec_per_days,            &
                          perm_tensor(icell)%xz/sec_per_days,            &
                          perm_tensor(icell)%yx/sec_per_days,            &
                          perm_tensor(icell)%yy/sec_per_days,            &
                          perm_tensor(icell)%yz/sec_per_days,            &
                          perm_tensor(icell)%zx/sec_per_days,            &
                          perm_tensor(icell)%zy/sec_per_days,            &
                          perm_tensor(icell)%zz/sec_per_days
                  end do
                else
                  do icell = 1, num_cells
                    izn = mpropvs_cell(icell)
                    write(ihyc,'(9(1pe15.6e3,1x))')                              &
                          cond_tensor(izn)%xx/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%xy/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%xz/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%yx/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%yy/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%yz/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%zx/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%zy/sec_per_days*k_depth_ratio(icell), &
                          cond_tensor(izn)%zz/sec_per_days*k_depth_ratio(icell)
                  end do
                end if
  
              else
                write(ihyc,'(a,1x,i12)') "POINT_DATA",nngl
                write(ihyc,'(a)') "TENSORS K double"
  
                if (permeability_field) then
                  do ivol = 1, nngl
                    write(ihyc,'(9(1pe15.6e3,1x))')                      &
                          perm_tensor(ivol)%xx/sec_per_days,             &
                          perm_tensor(ivol)%xy/sec_per_days,             &
                          perm_tensor(ivol)%xz/sec_per_days,             &
                          perm_tensor(ivol)%yx/sec_per_days,             &
                          perm_tensor(ivol)%yy/sec_per_days,             &
                          perm_tensor(ivol)%yz/sec_per_days,             &
                          perm_tensor(ivol)%zx/sec_per_days,             &
                          perm_tensor(ivol)%zy/sec_per_days,             &
                          perm_tensor(ivol)%zz/sec_per_days
                  end do
                else
                  do ivol = 1, nngl
                    izn = mpropvs(ivol)               
                    write(ihyc,'(9(1pe15.6e3,1x))')                              &
                          cond_tensor(izn)%xx/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%xy/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%xz/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%yx/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%yy/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%yz/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%zx/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%zy/sec_per_days*k_depth_ratio(ivol),  &
                          cond_tensor(izn)%zz/sec_per_days*k_depth_ratio(ivol)
                  end do
                end if
              end if
            end if

            !c output soil hydraulic function parameters
            if (soilhydrfunc_field) then
              !c swr
              write(ihyc,'(a)') "SCALARS swr double"
              write(ihyc,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(ihyc,ascii_fmt) swr_vol(ivol)
              end do

              !c spalpha
              write(ihyc,'(a)') "SCALARS spalpha double"
              write(ihyc,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(ihyc,ascii_fmt) spalpha_vol(ivol)
              end do

              !c spbeta
              write(ihyc,'(a)') "SCALARS spbeta double"
              write(ihyc,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(ihyc,ascii_fmt) spbeta_vol(ivol)
              end do

              !c expn
              write(ihyc,'(a)') "SCALARS expn double"
              write(ihyc,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(ihyc,ascii_fmt) expn_vol(ivol)
              end do

              !c aentry
              write(ihyc,'(a)') "SCALARS aentry double"
              write(ihyc,'(a)') "LOOKUP_TABLE default"
              do ivol = 1, nngl
                write(ihyc,ascii_fmt) aentry_vol(ivol)
              end do

              !c h1dry for root_uptake
              if (root_uptake) then
                write(ihyc,'(a)') "SCALARS h1dry double"
                write(ihyc,'(a)') "LOOKUP_TABLE default"
                do ivol = 1, nngl
                  write(ihyc,ascii_fmt) h1dry_vol(ivol)
                end do
              end if

              !c sgr_imbi for trap_bubbles
              if (trap_bubbles) then
                write(ihyc,'(a)') "SCALARS sgr_imbi double"
                write(ihyc,'(a)') "LOOKUP_TABLE default"
                do ivol = 1, nngl
                  write(ihyc,ascii_fmt) sgr_imbi_vol(ivol)
                end do
              end if

            end if   !soilhydrfunc_field


            close(ihyc)
            call lun_free(ihyc)
          end if

        else
#endif

          if (b_output_binary) then
            if (b_output_mpiio_single) then
              strbuffer = prefix(:l_prfx)//'_o.hyc'
            else
              strbuffer = prefix(:l_prfx)//'_'//                       &
                          trim(adjustl(str_rank))//'_o.hyc'
            end if

            call binary_file_open(Petsc_Comm_World, ihyc,              &
                         trim(strbuffer),b_output_mpiio_single)

          else
            ihyc = lun_get()

            open(ihyc,file=prefix(:l_prfx)//'_o'//                     &
                 trim(adjustl(str_rank))//'.hyc',status='unknown',     &
                 form='formatted')
          end if

!c  version information
          if (b_writeversion_tecplot .and. .not. b_output_binary) then
              call writeversion2file(ihyc, "#")
          end if

!c  title and variables

          if (b_output_binary) then
            strbuffer = 'dataset '//prefix(:l_prfx)//''
            offset_ihyc = 0
            call tecplot_binary_write_header(Petsc_Comm_World,         &
                       ihyc, "#!TDV102", trim(strbuffer), offset_ihyc, &
                       b_output_mpiio_single,.false.)           
          
            if (type_cond_perm == 1) then
              nvars = 6
              tec_variables(1:nvars) = [character(len=72) ::           &
                  "x", "y", "z", "k_xx", "k_yy", "k_zz"]
            else if (type_cond_perm == 2) then
              nvars = 12
              tec_variables(1:nvars) = [character(len=72) ::           &
                "x", "y", "z", "k_xx", "k_xy", "k_xz",                 &
                "k_yx", "k_yy", "k_yz", "k_zx", "k_zy", "k_zz"]
            end if

            !c output soil hydraulic function parameters
            if (soilhydrfunc_field) then
              nvars = nvars + 5
              tec_variables(nvars-4:nvars) = [character(len=72) ::     &
                "swr", "spalpha", "spbeta", "expn", "aentry"]

              if (root_uptake .or. pure_evap) then
                nvars = nvars + 1
                tec_variables(nvars) = "h1dry"
              end if

              if (trap_bubbles) then
                nvars = nvars + 1
                tec_variables(nvars) = "sgr_imbi"
              end if
            end if

            call tecplot_binary_write_variable(Petsc_Comm_World,       &
                         ihyc,nvars,tec_variables(1:nvars),            &
                         offset_ihyc,b_output_mpiio_single,.false.)

          else
            write(ihyc,'(3a)') 'title = "dataset ',prefix(:l_prfx),'"'

            !c output soil hydraulic function parameters
            if (type_cond_perm == 1) then
              if (soilhydrfunc_field) then
                if ((root_uptake .or. pure_evap) .and. trap_bubbles) then
                  nvars = 13
                  write(ihyc,'(5a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_yy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"h1dry", "sgr_imbi"'
                else if (root_uptake .or. pure_evap) then
                  nvars = 12
                  write(ihyc,'(5a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_yy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"h1dry"'
                else if (trap_bubbles) then
                  nvars = 12
                  write(ihyc,'(5a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_yy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"sgr_imbi"'
                else
                  nvars = 11
                  write(ihyc,'(4a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_yy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry"'
                end if
              else
                nvars = 6
                write(ihyc,'(2a)') 'variables = "x", "y", "z", ',        &
                                   '"k_xx", "k_yy", "k_zz"'
              end if
            else if (type_cond_perm == 2) then
              if (soilhydrfunc_field) then
                if ((root_uptake .or. pure_evap) .and. trap_bubbles) then
                  nvars = 19
                  write(ihyc,'(7a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_xy", "k_xz", ',         &
                                     '"k_yx", "k_yy", "k_yz", ',         &
                                     '"k_zx", "k_zy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"h1dry", "sgr_imbi"'
                else if (root_uptake .or. pure_evap) then
                  nvars = 18
                  write(ihyc,'(7a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_xy", "k_xz", ',         &
                                     '"k_yx", "k_yy", "k_yz", ',         &
                                     '"k_zx", "k_zy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"h1dry"'
                else if (trap_bubbles) then
                  nvars = 18
                  write(ihyc,'(7a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_xy", "k_xz", ',         &
                                     '"k_yx", "k_yy", "k_yz", ',         &
                                     '"k_zx", "k_zy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry", ',               &
                                     '"sgr_imbi"'
                else
                  nvars = 17
                  write(ihyc,'(6a)') 'variables = "x", "y", "z", ',      &
                                     '"k_xx", "k_xy", "k_xz", ',         &
                                     '"k_yx", "k_yy", "k_yz", ',         &
                                     '"k_zx", "k_zy", "k_zz", ',         &
                                     '"swr", "spalpha", "spbeta", ',     &
                                     '"expn", "aentry"'
                end if
              else
                nvars = 12
                write(ihyc,'(4a)') 'variables = "x", "y", "z", ',        &
                                   '"k_xx", "k_xy", "k_xz", ',           &
                                   '"k_yx", "k_yy", "k_yz", ',           &
                                   '"k_zx", "k_zy", "k_zz"'
              end if
            end if

          end if

!c  zone record

          if (b_output_binary) then
            strbuffer = "K - initial [m/s]"
            offset_ihyc_temp = offset_ihyc
            if (b_output_multizone) then
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World, ihyc, &
                           trim(strbuffer), offset_ihyc,                 &
                           itec, jtec, ktec,                             &
                           b_output_mpiio_single,.false.,                &
                           b_output_multizone)
              offset_ihyc = offset_ihyc_temp +                           &
                            (11+len_trim(strbuffer))*4*nprcs+4
            else
              call tecplot_binary_write_zoneinfo(Petsc_Comm_World, ihyc, &
                           trim(strbuffer), offset_ihyc,                 &
                           itec_gbl, jtec_gbl, ktec_gbl,                 &
                           b_output_mpiio_single,.false.,                &
                           b_output_multizone)
              offset_ihyc = offset_ihyc_temp +                           &
                            (12+len_trim(strbuffer))*4
            end if
          else
            write(ihyc,'(a,3(a,i5),a)')                                  &
                  'zone t = "K - initial [m/s]", ',                      &
                  'i =',itec,', j =',jtec,', k =',ktec,',  f=point'
          end if

!c  section information for binary output
          if (b_output_binary) then
            offset_ihyc_temp = offset_ihyc
            call tecplot_binary_write_section(Petsc_Comm_World,ihyc,nvars, &
                         nn_offset,offset_ihyc,b_output_mpiio_single,      &
                         .false.,b_output_multizone)
            allocate(realbuffer(nn*nvars), stat = ierr)
            realbuffer = 0.0d0
            call checkerr(ierr,'initppvs-realbuffer',ilog)
            call memory_monitor(sizeof(realbuffer),'realbuffer',.true.)
          end if

          ivol_l = 0

          if (permeability_field) then
            do ivol = 1,nngl
!c  skip ghost nodes
#ifdef PETSC
              if (node_idx_lg2l(ivol) < 0) then
                  cycle
              end if
#endif
              ivol_l = ivol_l + 1

              if (b_output_binary) then

                if (type_cond_perm == 1) then
                  nshift = 0
                  realbuffer((ivol_l-1)*nvars+1:(ivol_l-1)*nvars+6) = (/ &
                                         xg(ivol),yg(ivol),zg(ivol),     &
                                         permx(ivol)/sec_per_days,       &
                                         permy(ivol)/sec_per_days,       &
                                         permz(ivol)/sec_per_days/)
                else if (type_cond_perm == 2) then
                  nshift = 6
                  realbuffer((ivol_l-1)*nvars+1:                         &
                             (ivol_l-1)*nvars+6+nshift) = (/             &
                              xg(ivol),yg(ivol),zg(ivol),                &
                              perm_tensor(ivol)%xx/sec_per_days,         &
                              perm_tensor(ivol)%xy/sec_per_days,         &
                              perm_tensor(ivol)%xz/sec_per_days,         &
                              perm_tensor(ivol)%yx/sec_per_days,         &
                              perm_tensor(ivol)%yy/sec_per_days,         &
                              perm_tensor(ivol)%yz/sec_per_days,         &
                              perm_tensor(ivol)%zx/sec_per_days,         &
                              perm_tensor(ivol)%zy/sec_per_days,         &
                              perm_tensor(ivol)%zz/sec_per_days/)
                end if

                !c output soil hydraulic function parameters
                if (soilhydrfunc_field) then

                  realbuffer((ivol_l-1)*nvars+7+nshift:                &
                             (ivol_l-1)*nvars+11+nshift) =             &
                      (/swr_vol(ivol),spalpha_vol(ivol),               &
                        spbeta_vol(ivol),expn_vol(ivol),               &
                        aentry_vol(ivol)/)

                  if (root_uptake) then
                    realbuffer((ivol_l-1)*nvars+12+nshift) = h1dry_vol(ivol)
                  end if

                  if (trap_bubbles) then
                    realbuffer((ivol_l-1)*nvars+13+nshift) = sgr_imbi_vol(ivol)
                  end if
                end if

              else

                !c output soil hydraulic function parameters
                if (type_cond_perm == 1) then
                  if (soilhydrfunc_field) then
                    if (root_uptake .and. trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            permx(ivol)/sec_per_days,                    &
                            permy(ivol)/sec_per_days,                    &
                            permz(ivol)/sec_per_days,                    &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol),sgr_imbi_vol(ivol)
                    else if (root_uptake) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            permx(ivol)/sec_per_days,                    &
                            permy(ivol)/sec_per_days,                    &
                            permz(ivol)/sec_per_days,                    &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol)
                    else if (trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            permx(ivol)/sec_per_days,                    &
                            permy(ivol)/sec_per_days,                    &
                            permz(ivol)/sec_per_days,                    &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            sgr_imbi_vol(ivol)
                    else
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            permx(ivol)/sec_per_days,                    &
                            permy(ivol)/sec_per_days,                    &
                            permz(ivol)/sec_per_days,                    &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol)
                    end if
                  else
                    write(ihyc,ascii_fmt)                                &
                                         xg(ivol),yg(ivol),zg(ivol),     &
                                         permx(ivol)/sec_per_days,       &
                                         permy(ivol)/sec_per_days,       &
                                         permz(ivol)/sec_per_days
  
                  end if
                else if (type_cond_perm == 2) then
                  if (soilhydrfunc_field) then
                    if (root_uptake .and. trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            perm_tensor(ivol)%xx/sec_per_days,           &
                            perm_tensor(ivol)%xy/sec_per_days,           &
                            perm_tensor(ivol)%xz/sec_per_days,           &
                            perm_tensor(ivol)%yx/sec_per_days,           &
                            perm_tensor(ivol)%yy/sec_per_days,           &
                            perm_tensor(ivol)%yz/sec_per_days,           &
                            perm_tensor(ivol)%zx/sec_per_days,           &
                            perm_tensor(ivol)%zy/sec_per_days,           &
                            perm_tensor(ivol)%zz/sec_per_days,           &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol),sgr_imbi_vol(ivol)
                    else if (root_uptake) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            perm_tensor(ivol)%xx/sec_per_days,           &
                            perm_tensor(ivol)%xy/sec_per_days,           &
                            perm_tensor(ivol)%xz/sec_per_days,           &
                            perm_tensor(ivol)%yx/sec_per_days,           &
                            perm_tensor(ivol)%yy/sec_per_days,           &
                            perm_tensor(ivol)%yz/sec_per_days,           &
                            perm_tensor(ivol)%zx/sec_per_days,           &
                            perm_tensor(ivol)%zy/sec_per_days,           &
                            perm_tensor(ivol)%zz/sec_per_days,           &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol)
                    else if (trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            perm_tensor(ivol)%xx/sec_per_days,           &
                            perm_tensor(ivol)%xy/sec_per_days,           &
                            perm_tensor(ivol)%xz/sec_per_days,           &
                            perm_tensor(ivol)%yx/sec_per_days,           &
                            perm_tensor(ivol)%yy/sec_per_days,           &
                            perm_tensor(ivol)%yz/sec_per_days,           &
                            perm_tensor(ivol)%zx/sec_per_days,           &
                            perm_tensor(ivol)%zy/sec_per_days,           &
                            perm_tensor(ivol)%zz/sec_per_days,           &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            sgr_imbi_vol(ivol)
                    else
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            perm_tensor(ivol)%xx/sec_per_days,           &
                            perm_tensor(ivol)%xy/sec_per_days,           &
                            perm_tensor(ivol)%xz/sec_per_days,           &
                            perm_tensor(ivol)%yx/sec_per_days,           &
                            perm_tensor(ivol)%yy/sec_per_days,           &
                            perm_tensor(ivol)%yz/sec_per_days,           &
                            perm_tensor(ivol)%zx/sec_per_days,           &
                            perm_tensor(ivol)%zy/sec_per_days,           &
                            perm_tensor(ivol)%zz/sec_per_days,           &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol)
                    end if
                  else
                    write(ihyc,ascii_fmt)                                &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            perm_tensor(ivol)%xx/sec_per_days,           &
                            perm_tensor(ivol)%xy/sec_per_days,           &
                            perm_tensor(ivol)%xz/sec_per_days,           &
                            perm_tensor(ivol)%yx/sec_per_days,           &
                            perm_tensor(ivol)%yy/sec_per_days,           &
                            perm_tensor(ivol)%yz/sec_per_days,           &
                            perm_tensor(ivol)%zx/sec_per_days,           &
                            perm_tensor(ivol)%zy/sec_per_days,           &
                            perm_tensor(ivol)%zz/sec_per_days
  
                  end if
                end if
              end if
            end do
          else
            do ivol = 1,nngl
!c  skip ghost nodes
#ifdef PETSC
              if (node_idx_lg2l(ivol) < 0) then
                  cycle
              end if
#endif
              izn = mpropvs(ivol)
              ivol_l = ivol_l + 1

              if (b_output_binary) then

                if (type_cond_perm == 1) then
                  nshift = 0
                  realbuffer((ivol_l-1)*nvars+1:(ivol_l-1)*nvars+6) = (/   &
                            xg(ivol),yg(ivol),zg(ivol),                    &
                            condxx(izn)/sec_per_days*k_depth_ratio(ivol),  &
                            condyy(izn)/sec_per_days*k_depth_ratio(ivol),  &
                            condzz(izn)/sec_per_days*k_depth_ratio(ivol)/)
                else if (type_cond_perm == 2) then
                  nshift = 6
                  realbuffer((ivol_l-1)*nvars+1:                           &
                             (ivol_l-1)*nvars+6+nshift) = (/               &
                      xg(ivol),yg(ivol),zg(ivol),                          &
                      cond_tensor(izn)%xx/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%xy/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%xz/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%yx/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%yy/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%yz/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%zx/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%zy/sec_per_days*k_depth_ratio(ivol),&
                      cond_tensor(izn)%zz/sec_per_days*k_depth_ratio(ivol)/)
                end if

                !c output soil hydraulic function parameters
                if (soilhydrfunc_field) then

                  realbuffer((ivol_l-1)*nvars+7+nshift:                &
                             (ivol_l-1)*nvars+11+nshift) =             &
                      (/swr_vol(ivol),spalpha_vol(ivol),               &
                        spbeta_vol(ivol),expn_vol(ivol),               &
                        aentry_vol(ivol)/)

                  if (root_uptake) then
                    realbuffer((ivol_l-1)*nvars+12+nshift) =           &
                        h1dry_vol(ivol)
                  end if

                  if (trap_bubbles) then
                    realbuffer((ivol_l-1)*nvars+13+nshift) =           &
                        sgr_imbi_vol(ivol)
                  end if
                end if

              else

                !c output soil hydraulic function parameters
                if (type_cond_perm == 1) then
                  if (soilhydrfunc_field) then
                    if (root_uptake .and. trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            condxx(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condyy(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condzz(izn)/sec_per_days*k_depth_ratio(ivol),&
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol),sgr_imbi_vol(ivol)
                    else if (root_uptake) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            condxx(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condyy(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condzz(izn)/sec_per_days*k_depth_ratio(ivol),&
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol)
                    else if (trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            condxx(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condyy(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condzz(izn)/sec_per_days*k_depth_ratio(ivol),&
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            sgr_imbi_vol(ivol)
                    else
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            condxx(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condyy(izn)/sec_per_days*k_depth_ratio(ivol),&
                            condzz(izn)/sec_per_days*k_depth_ratio(ivol),&
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol)
                    end if
                  else
                    write(ihyc,ascii_fmt)                                &
                          xg(ivol),yg(ivol),zg(ivol),                    &
                          condxx(izn)/sec_per_days*k_depth_ratio(ivol),  &
                          condyy(izn)/sec_per_days*k_depth_ratio(ivol),  &
                          condzz(izn)/sec_per_days*k_depth_ratio(ivol)  
                  end if
                else
                  if (soilhydrfunc_field) then
                    if (root_uptake .and. trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            cond_tensor(izn)%xx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol),sgr_imbi_vol(ivol)
                    else if (root_uptake) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            cond_tensor(izn)%xx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            h1dry_vol(ivol)
                    else if (trap_bubbles) then
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            cond_tensor(izn)%xx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol),                            &
                            sgr_imbi_vol(ivol)
                    else
                      write(ihyc,ascii_fmt)                              &
                            xg(ivol),yg(ivol),zg(ivol),                  &
                            cond_tensor(izn)%xx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%xz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%yz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zx/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zy/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            cond_tensor(izn)%zz/sec_per_days*            &
                                                k_depth_ratio(ivol),     &
                            swr_vol(ivol),spalpha_vol(ivol),             &
                            spbeta_vol(ivol),expn_vol(ivol),             &
                            aentry_vol(ivol)
                    end if
                  else
                    write(ihyc,ascii_fmt)                                &
                          xg(ivol),yg(ivol),zg(ivol),                    &
                          cond_tensor(izn)%xx/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%xy/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%xz/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%yx/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%yy/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%yz/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%zx/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%zy/sec_per_days*              &
                                              k_depth_ratio(ivol),       &
                          cond_tensor(izn)%zz/sec_per_days*              &
                                              k_depth_ratio(ivol)
                  end if
                end if

              end if
            end do
          end if
          
          if(b_output_binary) then
            if (b_output_multizone .or. .not.b_output_mpiio_single) then
              call binary_write_data(ihyc, size(realbuffer,1),           &
                           realbuffer, offset_ihyc,b_output_mpiio_single)
            else
              call binary_subarray_initialize(nvars,b_mpiarray_ihyc_init,&
                          .false.,mpiarray_filetype_ihyc,                &
                          mpiarray_sizes_gbl_ihyc,                       &
                          mpiarray_sizes_sub_ihyc,                       &
                          mpiarray_starts_sub_ihyc)
              call binary_write_data(ihyc, size(realbuffer,1),           &
                           realbuffer, offset_ihyc,mpiarray_filetype_ihyc)
            end if

            call memory_monitor(-sizeof(realbuffer),'realbuffer',.true.)
            deallocate(realbuffer)
          end if

!c  close output file for initial hydraulic conductivity
!c  distribution
          if(b_output_binary) then
            call binary_file_close(ihyc,b_output_mpiio_single)
          else
            close(ihyc)
            call lun_free(ihyc)
          end if

#ifdef USG
        end if
#endif
      end if  
      
      goto 1000

997   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED' 
        write(ilog,*) 'file ', prefix(:l_prfx)//'.soi missing'
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

998   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading nodal material properties field ', &
     &                'from file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

999   continue
      if (rank == 0) then
        write(ilog,*) 'SIMULATION TERMINATED'
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  continue

      return
      end
