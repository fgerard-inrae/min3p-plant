!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 850 $
!> $Author: dsu $
!> $Date: 2023-01-27 08:58:23 -0800 (Fri, 27 Jan 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/relcond_freezing.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine soilparm
!c -------------------
!c
!c compute water freezing relative conductivity based on sigmodial curve
!c 
!c
!c written by:      Danyang Su - Jul 19, 2018
!c
!c last modified:   Danyang Su - Jul 19, 2018
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   real*8:
!c           -------
!c           temp                   = temperature in Celsius          + -
!c
!c
!c           relcond                = relative conductivity           * +
!c
!c gen file
!c           real*8:
!c           water_freezing_cond    = hydraulic conductivity after 
!c                                    water freezing, e.g., 1.0d-20
!c                                    DO NOT set to zero.
!c           water_freezing_curve_a = parameter a of water freezing 
!c                                    relative conductivity curve 
!c                                    r=d+(a-d)(1+((x+2)/c)^b)
!c
!c           water_freezing_curve_b = parameter b of water freezing 
!c                                    relative conductivity curve 
!c                                    r=d+(a-d)(1+((x+2)/c)^b)
!c
!c           water_freezing_curve_c = parameter c of water freezing 
!c                                    relative conductivity curve 
!c                                    r=d+(a-d)(1+((x+2)/c)^b)
!c
!c           water_freezing_curve_d = parameter d of water freezing 
!c                                    relative conductivity curve 
!c                                    r=d+(a-d)(1+((x+2)/c)^b)
!c
!c           water_freezing_curve_tempmin
!c                                  = lower limitation of temperature 
!c                                    for the curve
!c
!c           water_freezing_curve_tempmax
!c                                  = upper limitation of temperature 
!c                                    for the curve
!c
!c           water_freezing_relcond_min
!c                                  = lower limitation of water 
!c                                    freezing relative conductivity
!c
!c           water_freezing_relcond_max
!c                                  = upper limitation of water 
!c                                    freezing relative conductivity
!c           logical:
!c           --------
!c           b_water_freezing       = if true, use water freezing 
!c                                    when temperature is below 
!c                                    freezing temperature
!c
!c           b_water_freezing_cond  = if true, use adjusted hydraulic 
!c                                    conductivity when water is freezing
!c
!c           b_water_freezing_curve = if true, use water freezing relative 
!c                                    conductivity curve 
!c      
!c
!c          example
!c          curve fitting tool https://mycurvefit.com/
!c          'water freezing relative conductivity curve'
!c          0.01273  22.47  2.002  1.002  ;parameter a, b, c and d for relative conductivity curve relcond=d+(a-d)/(1.0+((temperatureC+2.0)/c)^b)
!c          -1.0     1.0    0.01   1.0    ;minimum temperature, maximum temperature, minimum relcond, maximum relcond
!c ----------------------------------------------------------------------
 
      function relcond_freezing(temp_std,pressure) result(relcond)
      
        use gen, only : water_freezing_curve_a                        ,&
                        water_freezing_curve_b                        ,&
                        water_freezing_curve_c                        ,&
                        water_freezing_curve_d                        ,&
                        water_freezing_curve_tempmin                  ,&
                        water_freezing_curve_tempmax                  ,&
                        water_freezing_relcond_min                    ,&
                        water_freezing_relcond_max                    ,&
                        b_water_freezing_func                         ,&
                        b_water_freezing_pts                          ,&
                        water_freezing_pts
      
        implicit none
        
        real*8, intent(in) :: temp_std
        real*8, intent(in) :: pressure
        real*8 :: relcond

        real*8, parameter :: r0 = 0.0d0, pi=3.14159265359d0, rkelvin=273.15d0
        integer, parameter :: i0 = 0

        integer :: itemp, ntemp
        real*8 :: temp

        real*8, external :: pressure_melt_k

        relcond = 1.0d0

        temp = temp_std

        !c apply pressure melting point correction        
        temp = temp - (pressure_melt_k(i0,pressure) - rkelvin)
       
        if (.not. (b_water_freezing_func .or. b_water_freezing_pts)) then
          if (temp < water_freezing_curve_tempmin) then
            relcond = water_freezing_relcond_min
          else if (temp > water_freezing_curve_tempmax) then
            relcond = water_freezing_relcond_max 
          else
            relcond = water_freezing_curve_d +                           &
                      (water_freezing_curve_a - water_freezing_curve_d)/ &
                      (1.0d0 + ((temp+2.0d0)/water_freezing_curve_c)**   &
                      water_freezing_curve_b)
            if (relcond < water_freezing_relcond_min) then
              relcond = water_freezing_relcond_min
            else if (relcond > water_freezing_relcond_max) then
              relcond = water_freezing_relcond_max  
            end if
          end if
        else if (b_water_freezing_func) then
          if (temp < water_freezing_curve_tempmin) then
            relcond = water_freezing_relcond_min
          else if (temp > water_freezing_curve_tempmax) then
            relcond = water_freezing_relcond_max 
          else
            relcond = 0.5*(water_freezing_relcond_min+water_freezing_relcond_max)*               &
                      (sin((pi/(water_freezing_curve_tempmax-water_freezing_curve_tempmin))*     & 
                      (temp-0.5*(water_freezing_curve_tempmax+water_freezing_curve_tempmin)))+1.0)
          end if
        else if (b_water_freezing_pts) then
          ntemp = size(water_freezing_pts,1)
          if (ntemp == 1) then
            relcond = water_freezing_pts(1,2)
          else if (ntemp >= 2) then
            if (temp <= water_freezing_pts(1,1)) then
              relcond = water_freezing_pts(1,2)
            else if (temp >= water_freezing_pts(ntemp,1)) then
              relcond = water_freezing_pts(ntemp,2) 
            else
              !c linear interpolation
              do itemp = 1, ntemp-1
                if (temp > water_freezing_pts(itemp,1) .and.           &
                    temp <= water_freezing_pts(itemp+1,1)) then
                  relcond = water_freezing_pts(itemp,2) +              &
                            (temp-water_freezing_pts(itemp,1))/        &
                            (water_freezing_pts(itemp+1,1)-            &
                             water_freezing_pts(itemp,1))*             &
                            (water_freezing_pts(itemp+1,2)-            &
                             water_freezing_pts(itemp,2))
                  return
                end if
              end do
            end if
          end if
        end if 
      
      end function relcond_freezing
