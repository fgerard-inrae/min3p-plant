!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 869 $
!> $Author: dsu $
!> $Date: 2023-08-18 09:44:21 -0700 (Fri, 18 Aug 2023) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/stedflow.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine stedflow
!c -------------------
!c
!c driver subroutine for steady state flow 
!c
!c written by:      Uli Mayer - May 8, 96
!c
!c last modified:   Uli Mayer - December 6, 96
!c                  Tom Henderson - August 14, 2002
!c
!c                  Danyang Su - Sept. 10, 2018
!c                  Unstructured grid and HPC capabilities
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           sgnew(nn)          = gaseous phase saturation            * +
!c                                - new time level
!c           sgold(nn)          = gaseous phase saturation            * +
!c                                - old time level
!c           sanew(nn)          = aqueous phase saturation            + -
!c                                - new time level
!c           saold(nn)          = aqueous phase saturation            * +
!c                                - old time level
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number, log file               + -
!c           idetail_vs         = information level                   + -
!c           nn                 = total number of control volumes     + -
!c            
!c           logical:
!c           --------
!c           fully_saturated    = .true.  -> saturated conditions     + -
!c           gs_output          = .true.  -> output of contour data   + -
!c           mass_balance_vs    = .true.  -> compute mass balance -   + -
!c                                           variably saturated flow
!c           variably_saturated = .true.  -> .not.fully_saturated,    + -
!c                                        -> variably saturated
!c                                           conditions
!c           steady_flow        = .true.  -> steady state flow        + +
!c           transient_flow     = .true.  -> .not.steady_flow,        + +
!c                                        -> transient flow
!c
!c dens.f    logical:
!c           --------
!c           density_dependence = .true.  -> density-dependant flow   + -
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c
!c           integer*4:
!c           ----------
!c           ivol               = counter (control volumes)   
!c
!c external: fsflow    = driver subroutine for fully saturated 
!c                       flow 
!c           mbalvs    = compute mass balance - varibaly saturated 
!c                       flow
!c           vsflow    = driver subroutine for variably saturated 
!c                       flow 
!c           outputvs  = write contour data for variably sturated 
!c                       flow simulation to output file
!c ----------------------------------------------------------------------

      subroutine stedflow

#ifdef PETSC
#include <petscversion.h>
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 8)
#include <petsc/finclude/petscsys.h>
      use petscsys
#endif
#endif

      use parm
      use gen
      use dens

      implicit none
#ifdef PETSC
#if (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR >= 6 && PETSC_VERSION_MINOR < 8)
#include <petsc/finclude/petscsys.h>
#elif (PETSC_VERSION_MAJOR >= 3 && PETSC_VERSION_MINOR < 6)
#include <finclude/petscsys.h>
#endif
#endif
      
      integer :: i, ivol, info_debug      
      
      external fsflow, mbalvs, vsflow, outputvs, ddvsflow, outputmech
#ifdef USG
      external outputvs_usg, outputdd_usg, outputice_usg, outputmech_usg
#endif

      real*8, parameter :: r1 = 1.0d0
     
      info_debug = 0
      
      if(b_enable_output)  then
      
      if (fully_saturated) then
        if(rank == 0) then
          write(ilog,'(a)')'steady state flow - saturated conditions'
          write(ilog,'(72a)')('-',i=1,72)
          write(*,'(/1x,a)')'steady state flow - saturated conditions'
          write(*,'(1x,72a)')('-',i=1,72)
        end if
      elseif (variably_saturated) then
        if(rank == 0) then
          write(ilog,'(2a)')'steady state flow - ',                      &
                            'variably saturated conditions'              
          write(ilog,'(72a)')('-',i=1,72)  
              write(*,'(/1x,2a)')'steady state flow - ',                 &
                              'variably saturated conditions'
          write(*,'(1x,72a)')('-',i=1,72)
        end if
      end if
      
      end if
     
!c  for saturated conditions - no density dependence
      if (.not.density_dependence) then
        if (fully_saturated) then
          call fsflow
!c  for variably saturated conditions - no density dependence

        elseif (variably_saturated) then
          call vsflow
        end if

!c for decoupled heat transport
        if (heat_transport .and. decoupled_type_vs_heat > 1) then
          call heattran
        end if 

!c  compute mass balance
        if (mass_balance_vs .and. ngb_step == ngb_step_bk) then
          call mbalvs
        end if

!c  write contour data for steady state solution to
!c  output files for postprocessing 
        if (gs_output .and. b_enable_output) then
          if(discretization_type == 0) then
            call outputvs

            if (compute_ice_sheet_loading) then
              call outputmech
            end if
#ifdef USG
          else
            call outputvs_usg
            if (compute_ice_sheet_loading) then
              call outputmech_usg
            end if
            if (compute_ice_sheet_loading .and. ice_sheet_type == 1) then
              call outputice_usg
            end if           
#endif
          end if
        end if

!c  density-dependent flow - variable and fully saturated

      else if (density_dependence) then
        if (fully_saturated) then
          call ddfsflow
        elseif (variably_saturated) then
          call ddvsflow
        end if

!c for decoupled heat transport
        if (heat_transport .and. decoupled_type_vs_heat > 1) then
          call heattran
        end if 

!c  compute mass balance - density dependent flow
        if (mass_balance_vs .and. ngb_step == ngb_step_bk) then
          call mbaldd
        end if

!c  write contour data for steady state solution to
!c  output files for postprocessing
        if (gs_output .and. b_enable_output) then
          if(discretization_type == 0) then
            call outputdd
#ifdef USG
          else
            call outputdd_usg
#endif
          end if
        end if

      end if  !.not.density_dependence

!c  assign saturations for reactive transport simulation and store variables in 
!c  the vectors corresponding to previous solution time
        do ivol = 1,nngl
          uvsold(ivol) = uvsnew(ivol)           !CMX 
          saold(ivol) = sanew(ivol)
          sgnew(ivol) = r1 - sanew(ivol)
          sgold(ivol) = sgnew(ivol)
        end do

!c  if permeabilities are updated, switch to transient flow

      if (update_permeability) then
        steady_flow = .false.
        transient_flow = .true.
      end if
      
      return
      end
