!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 875 $
!> $Author: dsu $
!> $Date: 2024-01-21 12:55:48 -0800 (Sun, 21 Jan 2024) $
!> $URL: https://min3psvn.ubc.ca/svn/min3p_thcm/branches/dsu_new_add_2024Jan/src/min3p/inittsgs.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine inittsgs
!c -------------------
!c
!c time step control parameters (global system)
!c
!c written by:      Uli Mayer - May 12, 96
!c
!c last modified:   Tom Henderson - January 21, 2003
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           ------- 
!c           delt               = time step                           * +
!c           delt_io            = time step (I/O units)               * +
!c           delt_vs            = estimated time step                 * +
!c                                (variably saturated flow)
!c           delt_rt            = estimated time step                 * +
!c                                (reactive transport)
!c           deltmax            = maximum time step                   * +
!c           deltmin            = minimum time step                   * +
!c           time               = current solution time               * +
!c           time_io            = current solution time (I/O units)   * +
!c           time_factor        = conversion factor from I/O time     * +
!c                                units to internal time units
!c           tfinal             = final solution time                 * +
!c
!c
!c           integer*4:
!c           ----------
!c           idat               = unit number, run specific input     + -
!c                                             file
!c           igen               = unit number, generic output file    + -
!c           ilog               = unit number, logbook                + -
!c           itmp               = unit number, temporary storage      + -
!c           l_time_unit        = length of time unit for output      * +
!c
!c           character:
!c           -----------
!c           section_header     = section header                      * +
!c           time_unit          = time unit for I/O -> 'years'        * +
!c                                                     'days'
!c                                                     'hours'
!c                                                     'seconds'
!c dens.f:   real*8:
!c           -------
!c           delt_tds           = lagged time step for tds storage    - + 
!c                                derivative
!c
!c local:    real*8:
!c           -------
!c           r1                 = constant
!c           r24                = constant
!c           r365               = constant
!c           r86400             = constant
!c
!c           integer*4:
!c           ----------
!c           l_string           = length of text string
!c
!c           logical:
!c           --------
!c           found_section      = .true.  -> section header was
!c                                           found in input file
!c       
!c external: readbloc  = read section of input file and write to
!c                       temporary file
!c ----------------------------------------------------------------------
 
      subroutine inittsgs 
 
      use parm
      use gen
      use dens
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif
      implicit none
      
      integer :: i, l_string, ierr, ierrcd

      external readbloc, checkerr

      logical :: found_section, found_subsection

      character*72 subsection

      real*8, parameter :: r1 = 1.0d0, r24 = 24.0d0, r365 = 365.0d0,   &
     &           r1440 = 1440.0d0, r86400 = 8.64d4

!c  read time step control parameters and write to temporary file   
      ierrcd = 0

      section_header = 'time step control - global system'
      call readbloc (idat,itmp,section_header,found_section,.true.)
 
!c  define length of section header

      l_string = index(section_header,'  ')-1
      if (l_string.eq.-1.or.l_string.gt.72) then
         l_string=72
      end if

!c  terminate program if section header not found

      if (.not.found_section) then
        if (rank == 0) then  
          write(ilog,*) 'error reading input file'
          write(ilog,*) 'section "',section_header(:l_string),'" missing'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if

!c  read time step control parameters

      ierrcd = 1
      read(itmp,*,err=999,end=999) time_unit
      l_time_unit = index(time_unit,' ')-1
      if (l_time_unit.eq.-1.or.l_time_unit.gt.12) then
        l_time_unit = 12
      end if
      if (time_unit.ne.'years'.and.           &
     &    time_unit.ne.'days'.and.            &
     &    time_unit.ne.'hours'.and.           &
     &    time_unit.ne.'minutes'.and.         &
     &    time_unit.ne.'seconds') then
        if (rank == 0 .and. b_enable_output) then  
          write(ilog,*)'-------------------------------------------'
          write(ilog,*)'   terminated in inittsgs                  '
          write(ilog,*)'   no provision for specified time unit    '
          write(ilog,*)'   bye now ...                             '
          write(ilog,*)'-------------------------------------------'
          if (b_enable_output_gen) then
            write(igen,*)'-------------------------------------------'
            write(igen,*)'   terminated in inittsgs                  '
            write(igen,*)'   no provision for specified time unit    '
            write(igen,*)'   bye now ...                             '
            write(igen,*)'-------------------------------------------'
          end if
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop
      end if
      ierrcd = 2
      read(itmp,*,err=999,end=999) time
      read(itmp,*,err=999,end=999) tfinal
      read(itmp,*,err=999,end=999) deltmax
      read(itmp,*,err=999,end=999) deltmin

!c  stop simulation when ratio of reduced timesteps is larger than the sepcified value
!c  this is used to terminate simulation when a big ratio of timesteps are failed
      subsection = 'threshold of failed timestep ratio'
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
        ierrcd = 3
        read(itmp,*,err=999,end=999) mtime_f_ratio
        if (mtime_f_ratio < 0.0d0) then
          mtime_f_ratio = 0.0d0
        end if
      else
        mtime_f_ratio = 1.0d100
      end if

!c  start with minimum timestep after boundary condition update
      b_updtbc_min_timestep = .false.
      subsection = 'minimum timestep after updating boundary condition'
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
        b_updtbc_min_timestep = .true.
      end if

!c  adjust relaxed timestep if it is around one timestep to the 
!c  boundary condition updating time
      b_relax_timestep = .false.
      subsection = 'relaxed timestep before updating boundary condition'
      call findstrg(subsection,itmp,found_subsection)
      if (found_subsection) then
        b_relax_timestep = .true.
      end if

!c  compute time factor for conversion between internal and I/O time
!c  units

      if (time_unit.eq.'years') then
        time_factor = r365
      elseif (time_unit.eq.'days') then
        time_factor = r1
      elseif (time_unit.eq.'hours') then
        time_factor = r1/r24
      elseif (time_unit.eq.'minutes') then
        time_factor = r1/r1440
      elseif (time_unit.eq.'seconds') then
        time_factor = r1/r86400
      end if

!c  write time step control parameters to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/72a)')('-',i=1,72)
        write(igen,'(a)') section_header(:l_string)
        write(igen,'(72a/)')('-',i=1,72)
        
        write(igen,'(a,1pe15.6e3,1x,a)')                        &
     &  'start time of simulation                        = ',   &
     &   time,time_unit
        write(igen,'(a,1pe15.6e3,1x,a)')                        &
     &  'initial time step                               = ',   &
     &   deltmin,time_unit
        write(igen,'(a,1pe15.6e3,1x,a)')                        &
     &  'max. time step                                  = ',   &
     &   deltmax,time_unit
        write(igen,'(a,1pe15.6e3,1x,a)')                        &
     &  'min. time step                                  = ',   &
     &  deltmin,time_unit
      end if

!c  save current time in i/o units

      time_io = time

      if (b_interpolation_bcvs) then
        time_bcvs_prev = time_io
      end if

      if (b_interpolation_bcheat) then
        time_bcheat_prev = time_io
      end if

      if (b_interpolation_bcice) then
        time_bcice_prev = time_io
      end if

!c  conversion of time units for computation in days

      time = time_factor * time
      time_start = time
      tfinal = time_factor * tfinal
      deltmax = time_factor * deltmax
      deltmin = time_factor * deltmin  

      !c diferent tiny time (e.g., 1.0d-12 and 1.0d-10) were used in different functions in the old code, 
      !c here we revised the code to use a consistent one.
      tinytime_global = max(deltmin*1.0d-2,1.0d-12)
      deltmax_global = deltmax      

!c set initial time step size to minimum time step specified
      delt = deltmin                   !set initial time step
      delt_vs = deltmin                !- variably saturated flow
      delt_rt = deltmin                !- reactive transport
      delt_tds = deltmin               !- density-dependent flow

!c set transient maximum timestep to control timestep over specified period of time
      n_transient_deltmax = 0   
      subsection = 'transient maximum time step'
      call findstrg(subsection,itmp,found_subsection)
      !c old keyword, to be deprecated
      if (.not. found_subsection) then
        subsection = 'periodic maximum time step'
        call findstrg(subsection,itmp,found_subsection)  
      end if

      if (found_subsection) then
        ierrcd = 4
        read(itmp,*,err=999,end=999) n_transient_deltmax
        if (n_transient_deltmax > 0) then
          allocate(transient_deltmax(4,n_transient_deltmax), stat = ierr)
          call checkerr(ierr,'transient_deltmax',ilog)
          call memory_monitor(sizeof(transient_deltmax),'transient_deltmax',.true.)
        end if
        do i = 1, n_transient_deltmax
          ierrcd = 5
          read(itmp,*,err=999,end=999) transient_deltmax(1:3,i)
          transient_deltmax(4,i) = transient_deltmax(3,i)
        end do
      end if

!c set transient maximum timestep to control timestep over specified period of time
!c with linear interpolation 
      subsection = 'linear transient maximum time step'
      call findstrg(subsection,itmp,found_subsection)

      if (found_subsection) then
        ierrcd = 4
        read(itmp,*,err=999,end=999) n_transient_deltmax
        if (n_transient_deltmax > 0) then
          allocate(transient_deltmax(4,n_transient_deltmax), stat = ierr)
          call checkerr(ierr,'transient_deltmax',ilog)
          call memory_monitor(sizeof(transient_deltmax),'transient_deltmax',.true.)
        end if
        do i = 1, n_transient_deltmax
          ierrcd = 5
          read(itmp,*,err=999,end=999) transient_deltmax(1:4,i)
        end do
      end if

!c  write time step control parameters to generic output file
      if (b_enable_output .and. b_enable_output_gen) then
        write(igen,'(/a,i6)')                                          &
        'number of transient maximum time step            = ',         &
        n_transient_deltmax

        if (n_transient_deltmax > 0) then
          write(igen,'(/a)')                                           &
          'period   time start       time stop        maximum time step'

          do i = 1, n_transient_deltmax
            write(igen,'(i6,2x,3(1pe15.6e3,7x))')i,transient_deltmax(1:3,i)
          end do
        end if
      end if

      if (n_transient_deltmax > 0) then
        transient_deltmax = transient_deltmax*time_factor
      end if

      goto 1000

999   continue
      if (rank == 0) then
        write(ilog,*) 'error reading input file, error code ', ierrcd
        write(ilog,*) 'section "',section_header(:l_string),'"'
        close(ilog)
      end if
#ifdef PETSC
      call petsc_mpi_finalize
#endif
      stop

1000  return
      end
